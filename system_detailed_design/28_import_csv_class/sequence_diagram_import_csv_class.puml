@startuml import_csv_class
!theme plain
hide footbox

actor "Data Operator" as DataOperator

participant "«user interaction»\n:GenericImportDialog" as UI
participant "«control»\n:ClassController" as Controller
participant "«service»\n:ClassService" as Service
participant "«database wrapper»\n:ClassRepository" as Repository
participant "«database wrapper»\n:SubjectRepository" as SubjectRepository
participant "«database wrapper»\n:SemesterRepository" as SemesterRepository
participant "«entity»\n:AcademicClass" as Entity

' === MAIN FLOW ===
DataOperator -> UI: Click "Import" button
activate UI

UI -> UI: Open import dialog

DataOperator -> UI: Select CSV file & import mode

DataOperator -> UI: Submit
UI -> Controller: POST /api/v1/classes/import\n(file, mode)
activate Controller

alt File is empty
    Controller -->> UI: 400 Bad Request
    UI -->> DataOperator: Show error message
end

Controller -> Service: importFromCsv(file, mode)
activate Service

' === PARSE CSV ===
alt CSV parsing fails
    Service -->> Controller: <<throw>> BadRequestException
    Controller -->> UI: 400 Bad Request
    UI -->> DataOperator: Show error message
end

' === BATCH PROCESSING ===
loop For each unique CSV row
    ' === LOOKUP SUBJECT BY CODE ===
    Service -> SubjectRepository: findByCode(subjectCode)
    activate SubjectRepository
    SubjectRepository -->> Service: Subject / null
    deactivate SubjectRepository

    alt Subject not found
        Service -> Service: Collect error, continue
    end

    ' === LOOKUP SEMESTER BY CODE ===
    Service -> SemesterRepository: findByCode(semesterCode)
    activate SemesterRepository
    SemesterRepository -->> Service: Semester / null
    deactivate SemesterRepository

    alt Semester not found
        Service -> Service: Collect error, continue
    end

    Service -> Repository: findByCodeAndSubjectIdAndSemesterId(code, subjectId, semesterId)
    activate Repository
    Repository -->> Service: AcademicClass / null
    deactivate Repository

    alt Row validation fails
        Service -> Service: Collect error, continue
    else Create new class
        Service -> Entity: new AcademicClass(row)
        activate Entity
        Entity -->> Service: academicClass
        deactivate Entity

        Service -> Repository: save(academicClass)
        activate Repository
        Repository -->> Service: savedClass
        deactivate Repository
    else Update existing class
        Service -> Entity: updateFromRow(row)
        activate Entity
        Entity -->> Service: academicClass
        deactivate Entity

        Service -> Repository: save(academicClass)
        activate Repository
        Repository -->> Service: savedClass
        deactivate Repository
    end
end

Service -->> Controller: ImportResultDTO
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> DataOperator: Show import result\n(success/failure counts)
deactivate UI

@enduml
