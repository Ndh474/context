@startuml Import CSV Class
!theme plain
hide footbox

actor Client
participant ":ClassController" as Controller
participant ":ClassService" as Service
participant ":CsvParserService" as CsvParser
participant ":SubjectRepository" as SubjectRepo
participant ":SemesterRepository" as SemesterRepo
participant ":ClassRepository" as ClassRepo
participant "Database" as DB

Client -> Controller: POST /api/v1/classes/import\nMultipartFile file, String mode
activate Controller

' === Validation 1: File Required ===
alt file is null or empty
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "CSV file is required",\ncode: "FILE_REQUIRED"}
end

Controller -> Service: importFromCsv(file, modeStr)
activate Service

' === CSV Parsing ===
Service -> CsvParser: parseClassCsv(file)
activate CsvParser

' === File Validation ===
alt file size > 5MB
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "File size exceeds 5MB limit",\ncode: "FILE_TOO_LARGE"}
end

alt invalid file type (not CSV)
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Invalid file type",\ncode: "INVALID_FILE_TYPE"}
end

alt invalid CSV header
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Invalid CSV format. Expected header: code,subject_code,semester_code[,status]",\ncode: "INVALID_CSV_FORMAT"}
end

CsvParser --> Service: rows:List<ClassCsvRow>
deactivate CsvParser

note right of Service
Perform in-memory deduplication
by unique key (code + subject + semester)
Keep first occurrence
end note

' === Batch Processing Loop ===
loop for each unique row
    note right of Service
    Each row processed in
    REQUIRES_NEW transaction
    (independent commit/rollback)
    end note

    Service -> Service: processOneClassRow(row, mode)
    activate Service

    ' === Row Validation ===
    alt row.getValidationError() != null
        note right of Service
        Collect error:
        INVALID_FIELD_FORMAT
        Continue to next row
        end note
        Service --> Service
        deactivate Service
    else row is valid

        ' === Lookup Subject ===
        Service -> SubjectRepo: findByCode(subjectCode)
        activate SubjectRepo

        SubjectRepo -> DB: SELECT * FROM subjects\nWHERE code = ?
        activate DB
        DB --> SubjectRepo: subjectRecord
        deactivate DB

        SubjectRepo --> Service: subject:Subject
        deactivate SubjectRepo

        alt subject == null
            note right of Service
            Collect error:
            SUBJECT_NOT_FOUND
            Continue to next row
            end note
            Service --> Service
            deactivate Service
        else subject found

            ' === Lookup Semester ===
            Service -> SemesterRepo: findByCode(semesterCode)
            activate SemesterRepo

            SemesterRepo -> DB: SELECT * FROM semesters\nWHERE code = ?
            activate DB
            DB --> SemesterRepo: semesterRecord
            deactivate DB

            SemesterRepo --> Service: semester:Semester
            deactivate SemesterRepo

            alt semester == null
                note right of Service
                Collect error:
                SEMESTER_NOT_FOUND
                Continue to next row
                end note
                Service --> Service
                deactivate Service
            else semester found

                ' === Check Existence ===
                Service -> ClassRepo: findByCodeAndSubjectIdAndSemesterId(code, subjectId, semesterId)
                activate ClassRepo

                ClassRepo -> DB: SELECT * FROM classes\nWHERE code = ? AND subject_id = ? AND semester_id = ?
                activate DB
                DB --> ClassRepo: classRecord
                deactivate DB

                ClassRepo --> Service: existing:AcademicClass
                deactivate ClassRepo

                ' === Mode Branching ===
                alt mode = ADD_ONLY
                    alt existing != null
                        note right of Service
                        Collect error:
                        CLASS_EXISTS
                        Continue to next row
                        end note
                        Service --> Service
                        deactivate Service
                    else existing == null
                        ' Create new class
                        Service -> Service: academicClass = new AcademicClass()
                        Service -> Service: academicClass.setCode(code)
                        Service -> Service: academicClass.setSubject(subject)
                        Service -> Service: academicClass.setSemester(semester)
                        Service -> Service: academicClass.setActive(isActive ?? true)

                        Service -> ClassRepo: save(academicClass)
                        activate ClassRepo
                        ClassRepo -> DB: INSERT INTO classes\n(code, subject_id, semester_id, is_active, created_at, updated_at)\nVALUES (?, ?, ?, ?, NOW(), NOW())
                        activate DB
                        DB --> ClassRepo: savedRecord
                        deactivate DB
                        ClassRepo --> Service: saved:AcademicClass
                        deactivate ClassRepo

                        note right of Service
                        Increment successCount
                        Commit transaction
                        end note
                        Service --> Service
                        deactivate Service
                    end

                else mode = ADD_AND_UPDATE
                    alt existing != null
                        ' Update existing class
                        opt row.isActive != null
                            Service -> Service: existing.setActive(row.isActive)
                            Service -> Service: existing.setUpdatedAt(NOW())

                            Service -> ClassRepo: save(existing)
                            activate ClassRepo
                            ClassRepo -> DB: UPDATE classes\nSET is_active=?, updated_at=NOW()\nWHERE id=?
                            activate DB
                            DB --> ClassRepo: updatedRecord
                            deactivate DB
                            ClassRepo --> Service: saved:AcademicClass
                            deactivate ClassRepo
                        end

                        note right of Service
                        Increment successCount
                        Commit transaction
                        end note
                        Service --> Service
                        deactivate Service

                    else existing == null
                        note right of Service
                        Same as ADD_ONLY:
                        Create new class
                        Increment successCount
                        end note
                        Service --> Service
                        deactivate Service
                    end
                end
            end
        end
    end
end

Service --> Controller: result:ImportResultDTO
deactivate Service

Controller --> Client: HTTP 200 OK\n{status: 200,\nmessage: "Import completed: X successful, Y failed",\ndata: {\n  successCount: X,\n  failureCount: Y,\n  errors: [\n    {rowNumber: N, errorCode: "...", message: "..."}\n  ]\n}}
deactivate Controller

@enduml
