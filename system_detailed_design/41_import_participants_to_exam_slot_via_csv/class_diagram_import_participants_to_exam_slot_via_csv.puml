@startuml import_participants_to_exam_slot_via_csv
!theme plain
hide circle
skinparam classAttributeIconSize 0

' --- CẤU HÌNH "ORTHO" (BẮT BUỘC) ---
skinparam linetype ortho
skinparam nodesep 60
skinparam ranksep 60

' --- CONTROLLER ---
class ExamSlotImportController {
  + importExamSlotParticipants(file, mode) : Response
}

' --- SERVICE ---
class ExamSlotImportService {
  + importParticipantsFromCsv(file, mode) : ImportResultDTO
  + processOneExamSlotParticipantRow(row, mode) : void
}

class CsvParserService {
  + parseExamSlotParticipantCsv(file) : List<ExamSlotParticipantCsvRow>
}

' --- REPOSITORY ---
interface SlotRepository <<interface>> {
  + findBySemesterCodeAndStartTimeAndRoomName(semesterCode, startTime, roomName) : Slot
}

interface SubjectRepository <<interface>> {
  + findByCode(code : String) : Subject
}

interface StudentProfileRepository <<interface>> {
  + findByRollNumberWithUserAndMajor(rollNumber : String) : StudentProfile
}

interface ExamSlotSubjectRepository <<interface>> {
  + findBySlotIdAndSubjectIdAndIsActiveTrue(slotId, subjectId) : Optional<ExamSlotSubject>
}

interface EnrollmentRepository <<interface>> {
  + existsByStudentAndSubjectAndSemesterAndEnrolled(studentId, subjectId, semesterId, enrolled) : boolean
}

interface ExamSlotParticipantRepository <<interface>> {
  + findByExamSlotSubjectIdAndStudentUserId(examSlotSubjectId, studentUserId) : Optional<ExamSlotParticipant>
  + save(participant : ExamSlotParticipant) : ExamSlotParticipant
}

' --- ENTITIES ---
class ExamSlotParticipant {
  - id : Long
  - examSlotSubject : ExamSlotSubject
  - studentUser : User
  - isEnrolled : Boolean
}

class ExamSlotSubject {
  - id : Long
  - slot : Slot
  - subject : Subject
  - isActive : Boolean
}

class Slot {
  - id : Integer
  - title : String
  - slotCategory : SlotCategory
  - startTime : LocalDateTime
  - semester : Semester
  - room : Room
}

class Subject {
  - id : Short
  - name : String
  - code : String
}

class StudentProfile {
  - userId : Integer
  - user : User
  - rollNumber : String
  - major : Major
}

class User {
  - id : Integer
  - username : String
  - active : Boolean
}

class Semester {
  - id : Short
  - code : String
}

class Room {
  - id : Short
  - name : String
}

' --- DEPENDENCY INJECTION (Association) ---
ExamSlotImportController -down-> ExamSlotImportService
ExamSlotImportService -down-> CsvParserService
ExamSlotImportService -down-> SlotRepository
ExamSlotImportService -down-> SubjectRepository
ExamSlotImportService -down-> StudentProfileRepository
ExamSlotImportService -down-> ExamSlotSubjectRepository
ExamSlotImportService -down-> EnrollmentRepository
ExamSlotImportService -down-> ExamSlotParticipantRepository

' --- REPOSITORY USAGE (Dependency) ---
SlotRepository .down.> Slot
SubjectRepository .down.> Subject
StudentProfileRepository .down.> StudentProfile
ExamSlotSubjectRepository .down.> ExamSlotSubject
ExamSlotParticipantRepository .down.> ExamSlotParticipant

' --- ENTITY RELATIONSHIPS (Aggregation) ---
ExamSlotParticipant o-right- ExamSlotSubject
ExamSlotParticipant o-right- User
ExamSlotSubject o-right- Slot
ExamSlotSubject o-right- Subject
Slot o-right- Semester
Slot o-right- Room
StudentProfile o-right- User

@enduml
