@startuml import_participants_to_exam_slot_via_csv
!theme plain
hide footbox

actor "Data Operator" as Admin

participant "«user interaction»\n:ImportParticipantsDialog" as UI
participant "«control»\n:ExamSlotImportController" as Controller
participant "«service»\n:ExamSlotImportService" as Service
participant "«service»\n:CsvParserService" as CsvParser
participant "«database wrapper»\n:ExamSlotParticipantRepository" as Repository
participant "«entity»\n:ExamSlotParticipant" as Entity

' --- MAIN FLOW ---
Admin -> UI: Click "Import" button
activate UI

UI -> UI: Open import dialog
Admin -> UI: Select CSV file & Submit

UI -> Controller: POST /api/v1/exam-slot-participants/import
activate Controller

Controller -> Service: importParticipantsFromCsv(file, mode)
activate Service

' --- PARSE CSV ---
Service -> CsvParser: parseExamSlotParticipantCsv(file)
activate CsvParser
CsvParser -->> Service: List<ExamSlotParticipantCsvRow>
deactivate CsvParser

alt CSV parsing fails
    Service -->> Controller: <<throw>> BadRequestException
    Controller -->> UI: 400 Bad Request
    UI -->> Admin: Show error message
end

' --- BATCH PROCESSING LOOP ---
loop For each unique CSV row
    ' Validation (Internal)
    Service -> Service: validateRow(row)

    alt Validation fails
        Service -> Service: Collect error, continue
    else Create new participant
        ' --- CREATE ENTITY ---
        Service -> Entity: new ExamSlotParticipant(row)
        activate Entity
        Entity -->> Service: participant
        deactivate Entity
        
        ' --- SAVE ---
        Service -> Repository: save(participant)
        activate Repository
        Repository -->> Service: savedParticipant
        deactivate Repository
    end
end

Service -->> Controller: ImportResultDTO
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> Admin: Show import result\n(success/failure counts)
deactivate UI

@enduml
