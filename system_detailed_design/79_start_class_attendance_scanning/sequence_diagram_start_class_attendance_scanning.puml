@startuml start_class_attendance_scanning
!theme plain
hide footbox

actor "Lecturer" as Lecturer

participant "«user interaction»\n:SessionControls" as UI
participant "«control»\n:SlotController" as Controller
participant "«service»\n:SlotSessionService" as Service
participant "«database wrapper»\n:SlotRepository" as SlotRepo
participant "«database wrapper»\n:EnrollmentRepository" as EnrollmentRepo
participant "«database wrapper»\n:CameraRepository" as CameraRepo
participant "«service»\n:FaceEmbeddingService" as EmbeddingService
participant "«external»\n:PythonBackendClient" as PythonClient
participant "«entity»\n:Slot" as Entity

' === MAIN FLOW ===
Lecturer -> UI: Click "Start Session"
activate UI

UI -> Controller: POST /api/v1/slots/{id}/session/start
activate Controller

Controller -> Service: startSession(slotId, currentUserId, INITIAL)
activate Service

' === FIND SLOT ===
Service -> SlotRepo: findById(slotId)
activate SlotRepo
SlotRepo -->> Service: Optional<Slot>
deactivate SlotRepo

alt Slot not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller -->> UI: 404 Not Found
    UI -->> Lecturer: Show error message
end

' === VALIDATION ===
Service -> Service: validateAuthorization(slot, currentUserId)
note right: Check staff assignment,\nactive status,\nsession conflict

alt Validation failed
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller -->> UI: 403 Forbidden
    UI -->> Lecturer: Show error message
end

' === GET STUDENTS WITH EMBEDDINGS ===
Service -> EnrollmentRepo: findAllByAcademicClassId(classId)
activate EnrollmentRepo
EnrollmentRepo -->> Service: List<Enrollment>
deactivate EnrollmentRepo

Service -> EmbeddingService: getActiveEmbedding(userId)
activate EmbeddingService
EmbeddingService -->> Service: Optional<FaceEmbedding>
deactivate EmbeddingService

alt No students with embeddings
    Service -->> Controller: <<throw>> BadRequestException
    Controller -->> UI: 400 Bad Request
    UI -->> Lecturer: Show error message
end

' === GET CAMERAS ===
Service -> CameraRepo: findByRoom_Id(roomId)
activate CameraRepo
CameraRepo -->> Service: List<Camera>
deactivate CameraRepo

alt No active cameras
    Service -->> Controller: <<throw>> BadRequestException
    Controller -->> UI: 400 Bad Request
    UI -->> Lecturer: Show error message
end

' === UPDATE SLOT STATUS ===
Service -> Entity: setSessionStatus(RUNNING)
activate Entity
Entity -->> Service: slot
deactivate Entity

Service -> SlotRepo: save(slot)
activate SlotRepo
SlotRepo -->> Service: Slot
deactivate SlotRepo

' === CALL PYTHON SERVICE ===
Service -> PythonClient: startRecognitionSession(request)
activate PythonClient
PythonClient -->> Service: PythonSessionResponse
deactivate PythonClient

Service -->> Controller: SessionStatusResponse
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> Lecturer: Show session started\nwith live status
deactivate UI

@enduml
