@startuml enroll_student_to_class
!theme plain
hide footbox

actor Client
participant ":EnrollmentController" as Controller
participant ":EnrollmentService" as Service
participant ":ClassRepository" as ClassRepo
participant ":StudentProfileRepository" as StudentRepo
participant ":EnrollmentRepository" as EnrollmentRepo
participant "Database" as DB

' --- MAIN FLOW ---
Client -> Controller: POST /api/v1/enrollments
activate Controller

' Request validation (internal)

Controller -> Service: create(request)
activate Service

' --- VALIDATE CLASS ---
Service -> ClassRepo: findById(classId)
activate ClassRepo

ClassRepo -> DB: Query Class by ID
activate DB
DB --> ClassRepo: AcademicClass / Null
deactivate DB

ClassRepo --> Service: Optional<AcademicClass>
deactivate ClassRepo

alt Class not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: 404 Not Found
end

alt Class is inactive
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: 400 Bad Request
end

' --- VALIDATE STUDENT ---
Service -> StudentRepo: findById(studentUserId)
activate StudentRepo

StudentRepo -> DB: Query Student Profile by User ID
activate DB
DB --> StudentRepo: StudentProfile / Null
deactivate DB

StudentRepo --> Service: Optional<StudentProfile>
deactivate StudentRepo

alt Student not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: 404 Not Found
end

alt Student is inactive
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: 400 Bad Request
end

' Validation logic (internal)

alt Student major not eligible for class subject
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: 400 Bad Request
end

alt Semester has ended
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: 403 Forbidden
end

' --- CHECK EXISTING ENROLLMENT ---
Service -> EnrollmentRepo: existsById(enrollmentId)
activate EnrollmentRepo

EnrollmentRepo -> DB: Check Enrollment Exists
activate DB
DB --> EnrollmentRepo: boolean
deactivate DB

EnrollmentRepo --> Service: boolean
deactivate EnrollmentRepo

alt Enrollment exists and is enrolled
    Service -->> Controller: <<throw>> ResourceExistsException
    Controller --> Client: 409 Conflict
else Enrollment exists but withdrawn
    Service -> EnrollmentRepo: findById(enrollmentId)
    activate EnrollmentRepo

    EnrollmentRepo -> DB: Query Enrollment
    activate DB
    DB --> EnrollmentRepo: Enrollment
    deactivate DB

    EnrollmentRepo --> Service: Enrollment
    deactivate EnrollmentRepo

    ' Re-enrollment logic (internal)

    Service -> EnrollmentRepo: save(enrollment)
    activate EnrollmentRepo

    EnrollmentRepo -> DB: Update Enrollment
    activate DB
    DB --> EnrollmentRepo: Updated Enrollment
    deactivate DB

    EnrollmentRepo --> Service: Enrollment
    deactivate EnrollmentRepo
else Enrollment does not exist
    ' Create new enrollment (internal)

    Service -> EnrollmentRepo: save(enrollment)
    activate EnrollmentRepo

    EnrollmentRepo -> DB: Insert Enrollment
    activate DB
    DB --> EnrollmentRepo: New Enrollment
    deactivate DB

    EnrollmentRepo --> Service: Enrollment
    deactivate EnrollmentRepo
end

Service --> Controller: Enrollment
deactivate Service

Controller --> Client: 201 Created
deactivate Controller

@enduml
