@startuml Enroll Student to Class
!theme plain
hide footbox

actor Client
participant ":EnrollmentController" as Controller
participant ":EnrollmentService" as Service
participant ":ClassRepository" as ClassRepo
participant ":StudentProfileRepository" as StudentRepo
participant ":EnrollmentRepository" as EnrollmentRepo
participant ":EnrollmentMapper" as Mapper
participant "Database" as DB

Client -> Controller: POST /api/v1/enrollments\n{classId, studentUserId}
activate Controller

Controller -> Service: create(request)
activate Service

' === Validation 1: Class Exists and Active ===
Service -> ClassRepo: findById(classId)
activate ClassRepo

ClassRepo -> DB: SELECT * FROM classes c\nJOIN subjects sub ON c.subject_id = sub.id\nJOIN semesters sem ON c.semester_id = sem.id\nWHERE c.id = ?
activate DB
DB --> ClassRepo: classRecord
deactivate DB

ClassRepo --> Service: classOpt:Optional<AcademicClass>
deactivate ClassRepo

alt classOpt.isEmpty()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Class not found: {classId}",\ncode: "CLASS_NOT_FOUND"}
end

Service -> Service: academicClass = classOpt.get()

opt !academicClass.isActive
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Cannot enroll student into inactive class",\ncode: "INACTIVE_CLASS_NOT_ALLOWED"}
end

' === Validation 2: Student Exists and Active ===
Service -> StudentRepo: findById(studentUserId)
activate StudentRepo

StudentRepo -> DB: SELECT * FROM student_profiles sp\nJOIN users u ON sp.user_id = u.id\nJOIN majors m ON sp.major_id = m.id\nWHERE sp.user_id = ?
activate DB
DB --> StudentRepo: studentRecord
deactivate DB

StudentRepo --> Service: studentOpt:Optional<StudentProfile>
deactivate StudentRepo

alt studentOpt.isEmpty()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Student profile not found: {studentUserId}",\ncode: "STUDENT_PROFILE_NOT_FOUND"}
end

Service -> Service: student = studentOpt.get()

opt !student.user.isActive
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Cannot enroll inactive student",\ncode: "INACTIVE_STUDENT_NOT_ALLOWED"}
end

' === Validation 3: Student Major Matches Subject's Majors ===
Service -> Service: subjectMajorIds = academicClass.subject.majors.stream().map(Major::getId).collect()

alt !subjectMajorIds.contains(student.major.id)
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Student's major ({majorCode}) is not eligible for this class's subject",\ncode: "STUDENT_MAJOR_NOT_MATCH"}
end

' === Validation 4: Semester Not Ended ===
Service -> Service: today = LocalDate.now()
Service -> Service: semesterEndDate = academicClass.semester.endDate

alt today.isAfter(semesterEndDate)
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: HTTP 403\n{status: 403,\nmessage: "Cannot modify enrollments after semester ends (ended: {date})",\ncode: "SEMESTER_ENDED"}
end

' === Validation 5: Check Existing Enrollment ===
Service -> Mapper: createEnrollmentId(classId, studentUserId)
activate Mapper
Mapper --> Service: enrollmentId:EnrollmentId
deactivate Mapper

Service -> EnrollmentRepo: existsById(enrollmentId)
activate EnrollmentRepo

EnrollmentRepo -> DB: SELECT COUNT(*) > 0 FROM enrollments\nWHERE class_id = ? AND student_user_id = ?
activate DB
DB --> EnrollmentRepo: exists
deactivate DB

EnrollmentRepo --> Service: exists:boolean
deactivate EnrollmentRepo

alt exists = true
    Service -> EnrollmentRepo: findById(enrollmentId)
    activate EnrollmentRepo

    EnrollmentRepo -> DB: SELECT * FROM enrollments\nWHERE class_id = ? AND student_user_id = ?
    activate DB
    DB --> EnrollmentRepo: enrollmentRecord
    deactivate DB

    EnrollmentRepo --> Service: existingOpt:Optional<Enrollment>
    deactivate EnrollmentRepo

    Service -> Service: existing = existingOpt.get()

    alt existing.isEnrolled = true
        Service -->> Controller: <<throw>> ResourceExistsException
        Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Student is already enrolled in this class",\ncode: "ALREADY_ENROLLED"}
    else existing.isEnrolled = false (Re-enrollment)
        Service -> Service: existing.setEnrolled(true)

        Service -> EnrollmentRepo: save(existing)
        activate EnrollmentRepo
        EnrollmentRepo -> DB: UPDATE enrollments\nSET is_enrolled = true, updated_at = NOW()\nWHERE class_id = ? AND student_user_id = ?
        activate DB
        DB --> EnrollmentRepo: updatedRecord
        deactivate DB
        EnrollmentRepo --> Service: updated:Enrollment
        deactivate EnrollmentRepo

        Service -> Mapper: toDTO(updated)
        activate Mapper
        Mapper --> Service: dto:EnrollmentDTO
        deactivate Mapper

        Service -> Service: dto.setStudent(createStudentDTO(student))

        Service --> Controller: EnrollmentDTO
        deactivate Service

        Controller --> Client: HTTP 201 CREATED\n{status: 201,\ndata: {...}}
        deactivate Controller
    end
end

' === Create New Enrollment ===
Service -> Mapper: toEntity(request)
activate Mapper
Mapper --> Service: enrollment:Enrollment
deactivate Mapper

Service -> Service: enrollment.setEnrolled(true)
Service -> Service: enrollment.setAcademicClass(academicClass)
Service -> Service: enrollment.setStudent(student.user)

Service -> EnrollmentRepo: save(enrollment)
activate EnrollmentRepo

EnrollmentRepo -> DB: INSERT INTO enrollments\n(class_id, student_user_id, is_enrolled, created_at, updated_at)\nVALUES (?, ?, true, NOW(), NOW())
activate DB
DB --> EnrollmentRepo: savedRecord
deactivate DB

EnrollmentRepo --> Service: saved:Enrollment
deactivate EnrollmentRepo

Service -> Mapper: toDTO(saved)
activate Mapper
Mapper --> Service: dto:EnrollmentDTO
deactivate Mapper

Service -> Service: dto.setStudent(createStudentDTO(student))

Service --> Controller: EnrollmentDTO
deactivate Service

Controller --> Client: HTTP 201 CREATED\n{status: 201,\ndata: {\n  classId: 1,\n  studentUserId: 101,\n  student: {\n    userId: 101,\n    fullName: "John Doe",\n    rollNumber: "SE12345",\n    email: "john@example.com",\n    majorName: "Software Engineering",\n    majorCode: "SE"\n  },\n  isEnrolled: true,\n  createdAt: "2024-11-19T16:00:00Z"\n}}
deactivate Controller

@enduml
