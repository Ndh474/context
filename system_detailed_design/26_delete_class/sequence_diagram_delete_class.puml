@startuml Delete Class
!theme plain
hide footbox

actor Client
participant ":ClassController" as Controller
participant ":ClassService" as Service
participant ":ClassRepository" as Repository
participant "Database" as DB

Client -> Controller: DELETE /api/v1/classes/1
activate Controller

Controller -> Service: delete(id)
activate Service

' === Validation 1: Check Existence ===
Service -> Repository: findById(id)
activate Repository

Repository -> DB: SELECT * FROM classes\nWHERE id = ?
activate DB
DB --> Repository: classRecord
deactivate DB

Repository --> Service: classOpt:Optional<AcademicClass>
deactivate Repository

alt classOpt.isEmpty()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Class not found: 1",\ncode: "CLASS_NOT_FOUND"}
end

' === Validation 2: Check Slots ===
Service -> Repository: countAllSlotsByClassId(id)
activate Repository

Repository -> DB: SELECT COUNT(id) FROM slots\nWHERE class_id = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: totalSlots:long
deactivate Repository

' === Validation 3: Check Enrollments ===
Service -> Repository: countAllStudentsByClassId(id)
activate Repository

Repository -> DB: SELECT COUNT(id) FROM enrollments\nWHERE class_id = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: totalStudents:long
deactivate Repository

alt totalSlots > 0 OR totalStudents > 0
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: HTTP 403\n{status: 403,\nmessage: "Cannot delete class. Found {totalSlots} slots and {totalStudents} enrollments",\ncode: "CLASS_HAS_DEPENDENCIES"}
end

' === Delete with Foreign Key Constraint Handling ===
Service -> Repository: deleteById(id)
activate Repository

Repository -> DB: DELETE FROM classes\nWHERE id = ?
activate DB

alt foreign key constraint violation
    DB -->> Repository: <<throw>> DataIntegrityViolationException
    Repository -->> Service: <<throw>> DataIntegrityViolationException
    deactivate Repository
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: HTTP 403\n{status: 403,\nmessage: "Cannot delete class due to existing dependencies",\ncode: "CLASS_HAS_DEPENDENCIES"}
end

DB --> Repository
deactivate DB

Repository --> Service
deactivate Repository

Service --> Controller
deactivate Service

Controller --> Client: HTTP 200 OK\n{status: 200,\nmessage: "Delete class successfully",\ncode: null,\ndata: null}
deactivate Controller

@enduml
