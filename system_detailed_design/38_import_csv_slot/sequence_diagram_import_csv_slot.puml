@startuml import_csv_slot
!theme plain
hide footbox

actor "Data Operator" as DataOperator

participant "«user interaction»\n:ImportSlotsDialog" as UI
participant "«control»\n:SlotController" as Controller
participant "«service»\n:SlotService" as Service
participant "«service»\n:CsvParserService" as CsvParser
participant "«database wrapper»\n:SlotRepository" as Repository
participant "«entity»\n:Slot" as Entity

' === MAIN FLOW ===
DataOperator -> UI: Select CSV file & Mode\n(AddOnly/AddAndUpdate)
activate UI

DataOperator -> UI: Click "Import"

UI -> Controller: POST /api/v1/slots/import
activate Controller

Controller -> Service: importFromCsv(file, mode)
activate Service

' === PARSE CSV ===
Service -> CsvParser: parse(file, SlotImportDTO.class)
activate CsvParser
CsvParser -->> Service: List<SlotImportDTO>
deactivate CsvParser

' === PROCESS LOOP ===
loop For each row
    Service -> Service: validateRow(row)
    
    ' Check existence
    Service -> Repository: findByCriteria(...)
    activate Repository
    Repository -->> Service: Optional<Slot>
    deactivate Repository
    
    alt Slot exists
        alt Mode = AddAndUpdate
             Service -> Entity: update fields
             activate Entity
             deactivate Entity
             Service -> Repository: save(slot)
             activate Repository
             deactivate Repository
        else Mode = AddOnly
             Service -> Service: skip
        end
    else New Slot
        Service -> Service: validateReferences(classCode, roomName, username)
        
        alt All references found
            Service -> Entity: new Slot(data)
            activate Entity
            Entity -->> Service: slot
            deactivate Entity
            
            Service -> Repository: save(slot)
            activate Repository
            deactivate Repository
            
            Service -> Service: createInitialAttendanceRecords(slot)
        else Missing reference
            Service -> Service: recordError("Reference not found")
        end
    end
end

Service -->> Controller: ImportResultDTO
deactivate Service

Controller -->> UI: 200 OK (Result summary)
deactivate Controller

UI -->> DataOperator: Show success/failure statistics
deactivate UI

@enduml
