@startuml View Class Details
!theme plain
hide footbox

actor Client
participant ":ClassController" as Controller
participant ":ClassService" as Service
participant ":ClassRepository" as Repository
participant ":ClassMapper" as Mapper
participant "Database" as DB

Client -> Controller: GET /api/v1/classes/1
activate Controller

Controller -> Service: findById(id)
activate Service

Service -> Repository: findById(id)
activate Repository

Repository -> DB: SELECT * FROM classes c\nJOIN subjects sub ON c.subject_id = sub.id\nJOIN semesters sem ON c.semester_id = sem.id\nWHERE c.id = ?
activate DB
DB --> Repository: classRecord
deactivate DB

Repository --> Service: classOpt:Optional<AcademicClass>
deactivate Repository

alt classOpt.isEmpty()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Class not found: 1",\ncode: "CLASS_NOT_FOUND"}
end

Service -> Service: academicClass = classOpt.get()

Service -> Mapper: toDTO(academicClass)
activate Mapper
Mapper --> Service: classDTO:ClassDTO
deactivate Mapper

Service -> Service: semester = academicClass.getSemester()
Service -> Service: semesterDTO = new SemesterDTO(...)
Service -> Service: classDTO.setSemester(semesterDTO)

Service -> Service: subject = academicClass.getSubject()
Service -> Service: subjectDTO = new SubjectDTO()
Service -> Service: subjectDTO.setId(subject.getId())
Service -> Service: subjectDTO.setName(subject.getName())
Service -> Service: subjectDTO.setCode(subject.getCode())
Service -> Service: subjectDTO.setActive(subject.getActive())
Service -> Service: classDTO.setSubject(subjectDTO)

Service -> Repository: countAllStudentsByClassId(id)
activate Repository

Repository -> DB: SELECT COUNT(id) FROM enrollments\nWHERE class_id = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: totalStudents:long
deactivate Repository

Service -> Repository: countEnrolledStudentsByClassId(id)
activate Repository

Repository -> DB: SELECT COUNT(id) FROM enrollments\nWHERE class_id = ? AND is_enrolled = true
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: enrolledStudents:long
deactivate Repository

Service -> Repository: countAllSlotsByClassId(id)
activate Repository

Repository -> DB: SELECT COUNT(id) FROM slots\nWHERE class_id = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: totalSlots:long
deactivate Repository

Service -> Repository: countActiveSlotsByClassId(id)
activate Repository

Repository -> DB: SELECT COUNT(id) FROM slots\nWHERE class_id = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: activeSlots:long
deactivate Repository

Service -> Service: classDTO.setTotalStudent(totalStudents)
Service -> Service: classDTO.setTotalEnrolledStudent(enrolledStudents)
Service -> Service: classDTO.setTotalSlot(totalSlots)
Service -> Service: classDTO.setTotalActiveSlot(activeSlots)

Service --> Controller: ClassDTO
deactivate Service

Controller --> Client: HTTP 200 OK\n{status: 200,\ndata: {\n  id: 1,\n  code: "SE01",\n  subject: {\n    id: 1,\n    name: "Software Engineering",\n    code: "SE",\n    isActive: true\n  },\n  semester: {\n    id: 1,\n    name: "Fall 2024",\n    code: "FA2024",\n    startDate: "2024-09-01",\n    endDate: "2024-12-31",\n    isActive: true\n  },\n  totalStudent: 50,\n  totalEnrolledStudent: 48,\n  totalSlot: 15,\n  totalActiveSlot: 10,\n  isActive: true,\n  createdAt: "2024-11-19T10:00:00Z"\n}}
deactivate Controller

@enduml
