@startuml rescan_candidate_for_exam
!theme plain
hide footbox

actor "Supervisor" as Supervisor

participant "«user interaction»\n:ExamSessionControls" as UI
participant "«control»\n:SlotController" as Controller
participant "«service»\n:SlotSessionService" as Service
participant "«database wrapper»\n:SlotRepository" as SlotRepo
participant "«database wrapper»\n:ExamSlotParticipantRepository" as ParticipantRepo
participant "«database wrapper»\n:CameraRepository" as CameraRepo
participant "«service»\n:FaceEmbeddingService" as EmbeddingService
participant "«external»\n:PythonBackendClient" as PythonClient
participant "«entity»\n:Slot" as Entity

' === MAIN FLOW ===
Supervisor -> UI: Click "Rescan"
activate UI

UI -> Controller: POST /api/v1/slots/{id}/exam-session/rescan
activate Controller

Controller -> Service: rescanExamSession(slotId, currentUserId)
activate Service

' === FIND SLOT ===
Service -> SlotRepo: findById(slotId)
activate SlotRepo
SlotRepo -->> Service: Optional<Slot>
deactivate SlotRepo

alt Slot not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller -->> UI: 404 Not Found
    UI -->> Supervisor: Show error message
end

' === VALIDATION ===
Service -> Service: validateExamAuthorization(slot, currentUserId)
note right: Check staff assignment,\nsession conflict

alt Validation failed
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller -->> UI: 403 Forbidden
    UI -->> Supervisor: Show error message
end

' === GET EXAM PARTICIPANTS WITH EMBEDDINGS ===
Service -> ParticipantRepo: findBySlotIdWithStudents(slotId)
activate ParticipantRepo
ParticipantRepo -->> Service: List<ExamSlotParticipant>
deactivate ParticipantRepo

Service -> EmbeddingService: getActiveEmbedding(userId)
activate EmbeddingService
EmbeddingService -->> Service: Optional<FaceEmbedding>
deactivate EmbeddingService

' === GET CAMERAS ===
Service -> CameraRepo: findByRoom_Id(roomId)
activate CameraRepo
CameraRepo -->> Service: List<Camera>
deactivate CameraRepo

' === UPDATE SLOT STATUS ===
Service -> Entity: setExamSessionStatus(RUNNING)\nincrementExamScanCount()
activate Entity
Entity -->> Service: slot
deactivate Entity

Service -> SlotRepo: save(slot)
activate SlotRepo
SlotRepo -->> Service: Slot
deactivate SlotRepo

' === CALL PYTHON SERVICE ===
Service -> PythonClient: startRecognitionSession(request)
activate PythonClient
note right: mode=RESCAN,\ncallbackType=EXAM
PythonClient -->> Service: PythonSessionResponse
deactivate PythonClient

Service -->> Controller: SessionStatusResponse
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> Supervisor: Show rescan started\nwith live status
deactivate UI

@enduml
