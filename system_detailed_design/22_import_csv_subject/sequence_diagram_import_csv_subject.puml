@startuml Import CSV Subject
!theme plain
hide footbox

actor Client
participant ":SubjectController" as Controller
participant ":SubjectService" as Service
participant ":CsvParserService" as CsvParser
participant ":SubjectRepository" as SubjectRepo
participant ":MajorRepository" as MajorRepo
participant "Database" as DB

Client -> Controller: POST /api/v1/subjects/import\nMultipartFile file, String mode
activate Controller

' === Validation 1: File Required ===
alt file is null or empty
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "CSV file is required",\ncode: "FILE_REQUIRED"}
end

Controller -> Service: importFromCsv(file, modeStr)
activate Service

' === CSV Parsing ===
Service -> CsvParser: parseSubjectCsv(file)
activate CsvParser

' === File Validation ===
alt file size > 5MB
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "File size exceeds 5MB limit",\ncode: "FILE_TOO_LARGE"}
end

alt invalid file type (not CSV)
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Invalid file type",\ncode: "INVALID_FILE_TYPE"}
end

alt invalid CSV header
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Invalid CSV format. Expected header: code,name,major_codes[,status]",\ncode: "INVALID_CSV_FORMAT"}
end

alt row count > 10,000
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Too many rows (max 10,000)",\ncode: "TOO_MANY_ROWS"}
end

CsvParser --> Service: rows:List<SubjectCsvRow>
deactivate CsvParser

note right of Service
Perform in-memory deduplication
by code (keep first occurrence)
end note

' === Batch Processing Loop ===
loop for each unique row
    note right of Service
    Each row processed in
    REQUIRES_NEW transaction
    (independent commit/rollback)
    end note

    Service -> Service: processOneSubjectRow(row, mode)
    activate Service

    ' === Row Validation ===
    alt !row.isValid()
        note right of Service
        Collect error:
        INVALID_FIELD_FORMAT
        Continue to next row
        end note
        Service --> Service
        deactivate Service
    else row is valid

        ' === Validate Major Codes ===
        alt majorCodeList.isEmpty()
            note right of Service
            Collect error:
            SUBJECT_MAJOR_IDS_EMPTY
            Continue to next row
            end note
            Service --> Service
            deactivate Service
        else has major codes

            ' === Lookup Majors ===
            loop for each majorCode
                Service -> MajorRepo: findByCode(majorCode)
                activate MajorRepo

                MajorRepo -> DB: SELECT * FROM majors\nWHERE code = ?
                activate DB
                DB --> MajorRepo: majorRecord
                deactivate DB

                MajorRepo --> Service: major:Major
                deactivate MajorRepo

                alt major is null
                    note right of Service
                    Collect error:
                    MAJOR_NOT_FOUND
                    Continue to next row
                    end note
                    Service --> Service
                    deactivate Service
                end

                alt !major.isActive
                    note right of Service
                    Collect error:
                    INACTIVE_MAJOR_NOT_ALLOWED
                    Continue to next row
                    end note
                    Service --> Service
                    deactivate Service
                end
            end

            ' === Check Existence ===
            Service -> SubjectRepo: findByCode(code)
            activate SubjectRepo

            SubjectRepo -> DB: SELECT * FROM subjects\nWHERE code = ?
            activate DB
            DB --> SubjectRepo: subjectRecord
            deactivate DB

            SubjectRepo --> Service: existing:Subject
            deactivate SubjectRepo

            ' === Mode Branching ===
            alt mode = AddOnly
                alt existing != null
                    note right of Service
                    Collect error:
                    SUBJECT_CODE_EXISTS
                    Continue to next row
                    end note
                    Service --> Service
                    deactivate Service
                else existing is null
                    ' Validate name uniqueness
                    Service -> SubjectRepo: existsByName(name)
                    activate SubjectRepo
                    SubjectRepo -> DB: SELECT COUNT(*) > 0\nFROM subjects WHERE name = ?
                    activate DB
                    DB --> SubjectRepo: count
                    deactivate DB
                    SubjectRepo --> Service: exists:boolean
                    deactivate SubjectRepo

                    alt exists = true
                        note right of Service
                        Collect error:
                        SUBJECT_NAME_EXISTS
                        Continue to next row
                        end note
                        Service --> Service
                        deactivate Service
                    else name unique
                        ' Create new subject
                        Service -> SubjectRepo: save(subject)
                        activate SubjectRepo
                        SubjectRepo -> DB: INSERT INTO subjects\n(name, code, is_active, created_at, updated_at)\nVALUES (?, ?, ?, NOW(), NOW())
                        activate DB
                        DB --> SubjectRepo: savedRecord
                        deactivate DB

                        SubjectRepo -> DB: INSERT INTO subject_majors\n(subject_id, major_id)\nVALUES (?, ?)
                        activate DB
                        DB --> SubjectRepo: insertedRows
                        deactivate DB

                        SubjectRepo --> Service: saved:Subject
                        deactivate SubjectRepo

                        note right of Service
                        Increment successCount
                        Commit transaction
                        end note
                        Service --> Service
                        deactivate Service
                    end
                end

            else mode = AddAndUpdate
                alt existing != null
                    ' Validate name uniqueness (exclude self)
                    Service -> SubjectRepo: existsByNameAndIdNot(name, id)
                    activate SubjectRepo
                    SubjectRepo -> DB: SELECT COUNT(*) > 0\nWHERE name = ? AND id != ?
                    activate DB
                    DB --> SubjectRepo: count
                    deactivate DB
                    SubjectRepo --> Service: exists:boolean
                    deactivate SubjectRepo

                    alt exists = true
                        note right of Service
                        Collect error:
                        SUBJECT_NAME_EXISTS
                        Continue to next row
                        end note
                        Service --> Service
                        deactivate Service
                    else name unique
                        ' Update existing subject
                        Service -> SubjectRepo: save(updatedSubject)
                        activate SubjectRepo
                        SubjectRepo -> DB: UPDATE subjects\nSET name=?, is_active=?, updated_at=NOW()\nWHERE id=?
                        activate DB
                        DB --> SubjectRepo: updatedRecord
                        deactivate DB

                        SubjectRepo -> DB: DELETE FROM subject_majors\nWHERE subject_id = ?
                        activate DB
                        DB --> SubjectRepo: deletedRows
                        deactivate DB

                        SubjectRepo -> DB: INSERT INTO subject_majors\n(subject_id, major_id)\nVALUES (?, ?)
                        activate DB
                        DB --> SubjectRepo: insertedRows
                        deactivate DB

                        SubjectRepo --> Service: saved:Subject
                        deactivate SubjectRepo

                        note right of Service
                        Increment successCount
                        Commit transaction
                        end note
                        Service --> Service
                        deactivate Service
                    end

                else existing is null
                    note right of Service
                    Same validation as AddOnly:
                    - Check name uniqueness
                    - Create new subject
                    - Increment successCount
                    end note
                    Service --> Service
                    deactivate Service
                end
            end
        end
    end
end

Service --> Controller: result:ImportResultDTO
deactivate Service

Controller --> Client: HTTP 200 OK\n{status: 200,\nmessage: "Import completed: X successful, Y failed",\ndata: {\n  successCount: X,\n  failureCount: Y,\n  errors: [\n    {rowNumber: N, errorCode: "...", message: "..."}\n  ]\n}}
deactivate Controller

@enduml
