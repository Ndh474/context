@startuml Delete Slot
!theme plain
hide footbox

actor Client
participant ":SlotController" as Controller
participant ":SlotService" as Service
participant ":SlotRepository" as Repository
participant ":Database" as DB

Client -> Controller: DELETE /api/v1/slots/1
activate Controller

Controller -> Service: delete(id)
activate Service

' === Validation 1: Check Existence ===
Service -> Repository: findById(id)
activate Repository

Repository -> DB: SELECT * FROM slots\nWHERE id = ?
activate DB
DB --> Repository: slotRecord
deactivate DB

Repository --> Service: slotOpt:Optional<Slot>
deactivate Repository

alt slotOpt.isEmpty()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Slot not found: 1",\ncode: "SLOT_NOT_FOUND"}
end

' === Validation 2: Check Attendance Records ===
Service -> Repository: countAttendanceRecordsBySlotId(id)
activate Repository

Repository -> DB: SELECT COUNT(*) FROM attendance_records\nWHERE slot_id = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: attendanceCount:Long
deactivate Repository

' === Validation 3: Check Exam Attendance Records ===
Service -> Repository: countExamAttendanceRecordsBySlotId(id)
activate Repository

Repository -> DB: SELECT COUNT(*) FROM exam_attendances\nWHERE slot_id = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: examAttendanceCount:Long
deactivate Repository

alt attendanceCount > 0 || examAttendanceCount > 0
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: HTTP 403\n{status: 403,\nmessage: "Cannot delete slot. Found {attendanceCount} attendance records and {examAttendanceCount} exam attendance records. Please delete them first or contact administrator",\ncode: "SLOT_HAS_DEPENDENCIES"}
end

' === Delete Slot with Foreign Key Constraint Handling ===
Service -> Repository: deleteById(id)
activate Repository

Repository -> DB: DELETE FROM slots\nWHERE id = ?
activate DB

alt foreign key constraint violation
    DB -->> Repository: <<throw>> DataIntegrityViolationException
    deactivate DB
    Repository -->> Service: <<throw>> DataIntegrityViolationException
    deactivate Repository
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: HTTP 403\n{status: 403,\nmessage: "Cannot delete slot. It is currently in use by other records.",\ncode: "SLOT_HAS_DEPENDENCIES"}
end

DB --> Repository
deactivate DB

Repository --> Service
deactivate Repository

Service --> Controller
deactivate Service

Controller --> Client: HTTP 200 OK\n{status: 200,\nmessage: "Delete slot successfully",\ncode: null,\ndata: null}
deactivate Controller

@enduml
