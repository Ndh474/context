@startuml create_camera
!theme plain
hide footbox

actor Client
participant ":CameraController" as Controller
participant ":CameraService" as Service
participant ":RoomRepository" as RoomRepo
participant ":CameraRepository" as CameraRepo
participant "Database" as DB

' --- MAIN FLOW ---
Client -> Controller: POST /api/v1/cameras
activate Controller

Controller -> Service: create(request)
activate Service

' --- VALIDATE ROOM ---
Service -> RoomRepo: findById(roomId)
activate RoomRepo

RoomRepo -> DB: Query Room by ID
activate DB
DB --> RoomRepo: Room Record / Null
deactivate DB

RoomRepo --> Service: Optional<Room>
deactivate RoomRepo

alt Room not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: 404 Not Found
end

' --- VALIDATION LOGIC ---
Service -> CameraRepo: existsByName(name)
activate CameraRepo

CameraRepo -> DB: Check Name Existence
activate DB
DB --> CameraRepo: Boolean
deactivate DB

CameraRepo --> Service: Boolean
deactivate CameraRepo

alt Name already exists
    Service -->> Controller: <<throw>> ResourceExistsException
    Controller --> Client: 409 Conflict
end

Service -> CameraRepo: existsByRtspUrl(rtspUrl)
activate CameraRepo

CameraRepo -> DB: Check RTSP URL Existence
activate DB
DB --> CameraRepo: Boolean
deactivate DB

CameraRepo --> Service: Boolean
deactivate CameraRepo

alt RTSP URL already exists
    Service -->> Controller: <<throw>> ResourceExistsException
    Controller --> Client: 409 Conflict
end

' --- SAVE TO DATABASE ---
Service -> CameraRepo: save(camera)
activate CameraRepo

CameraRepo -> DB: Insert New Camera
activate DB
DB --> CameraRepo: Saved Camera
deactivate DB

CameraRepo --> Service: Camera
deactivate CameraRepo

Service --> Controller: CameraDTO
deactivate Service

Controller --> Client: 201 Created
deactivate Controller

@enduml
