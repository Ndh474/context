@startuml Change Password
!theme plain
hide footbox

actor Client
participant ":AuthenticationController" as Controller
participant ":AuthenticationService" as Service
participant ":PasswordUpdateRequest" as Request
participant ":UserRepository" as Repository
participant ":PasswordEncoder" as Encoder
participant "Database" as DB

Client -> Controller: POST /api/v1/users/{id}/update-password\n{oldPassword, newPassword, confirmPassword}
activate Controller

Controller -> Service: updatePassword(id, request)
activate Service

Service -> Request: newPasswordsMatch()
activate Request
Request --> Service: isMatch:boolean
deactivate Request

alt !isMatch
    Service -->> Controller: <<throw>> IllegalArgumentException
    Controller --> Client: HTTP 400\n{status, message:\n"New password and confirm password do not match"}
end

Service -> Repository: findById(id)
activate Repository

Repository -> DB: SELECT * FROM users\nWHERE id = ?
activate DB
DB --> Repository: userRecord
deactivate DB

Repository --> Service: userOpt:Optional<User>
deactivate Repository

alt userOpt.isEmpty()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status, message, code:\nUSER_ID_NOT_FOUND}
end

Service -> Service: validateUserActive(user)
activate Service

opt !user.isActive
    Service -->> Controller: <<throw>> AccessDeniedException
    Controller --> Client: HTTP 403\n{status, message, code:\nFORBIDDEN}
end

deactivate Service

Service -> Encoder: matches(oldPassword, passwordHash)
activate Encoder
Encoder --> Service: isOldPasswordValid:boolean
deactivate Encoder

alt !isOldPasswordValid
    Service -->> Controller: <<throw>> BadCredentialsException
    Controller --> Client: HTTP 401\n{status, message:\n"Invalid current password"}
end

Service -> Encoder: encode(newPassword)
activate Encoder
Encoder --> Service: newPasswordHash:String
deactivate Encoder

Service -> Service: user.setPasswordHash(newPasswordHash)

Service -> Repository: save(user)
activate Repository

Repository -> DB: UPDATE users\nSET password_hash = ?, updated_at = ?\nWHERE id = ?
activate DB
DB --> Repository: updateConfirmation
deactivate DB

Repository --> Service: user:User
deactivate Repository

Service --> Controller: "Update password successfully."
deactivate Service

Controller -> Controller: Response.ok(message)
Controller --> Client: HTTP 200 OK\n{status: 200,\ndata: "Update password successfully."}
deactivate Controller

@enduml
