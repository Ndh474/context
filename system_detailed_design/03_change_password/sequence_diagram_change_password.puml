@startuml change_password
!theme plain
hide footbox

actor User

participant "«user interaction»\n:ChangePasswordDialog" as UI
participant "«control»\n:AuthenticationController" as Controller
participant "«service»\n:AuthenticationService" as Service
participant "«database wrapper»\n:UserRepository" as Repository
participant "«entity»\n:User" as Entity

' === MAIN FLOW ===
User -> UI: Open change password dialog
activate UI

User -> UI: Enter old password,\nnew password, confirm password

User -> UI: Click "Change Password"
UI -> Controller: POST /api/v1/users/{id}/update-password
activate Controller

Controller -> Service: updatePassword(id, request)
activate Service

' === INPUT VALIDATION ===
alt Passwords do not match
    Service -->> Controller: <<throw>> IllegalArgumentException
    Controller -->> UI: 400 Bad Request
    UI -->> User: Show error message
end

' === USER LOOKUP ===
Service -> Repository: findById(id)
activate Repository
Repository -->> Service: Optional<User>
deactivate Repository

alt User not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller -->> UI: 404 Not Found
    UI -->> User: Show error message
end

alt User is inactive
    Service -->> Controller: <<throw>> AccessDeniedException
    Controller -->> UI: 403 Forbidden
    UI -->> User: Show error message
end

' === OLD PASSWORD VERIFICATION ===
alt Invalid old password
    Service -->> Controller: <<throw>> BadCredentialsException
    Controller -->> UI: 401 Unauthorized
    UI -->> User: Show error message
end

' === UPDATE PASSWORD ===
Service -> Entity: setPassword(encodedPassword)
activate Entity
Entity -->> Service: user
deactivate Entity

Service -> Repository: save(user)
activate Repository
Repository -->> Service: savedUser
deactivate Repository

Service -->> Controller: Success Message
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> User: Show success message\nClose dialog
deactivate UI

@enduml
