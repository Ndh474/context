@startuml update_semester
!theme plain
hide footbox

actor Client
participant ":SemesterController" as Controller
participant ":SemesterService" as Service
participant ":SemesterRepository" as Repository
participant "Database" as DB

' --- MAIN FLOW ---
Client -> Controller: PUT /api/v1/semesters/{id}
activate Controller

Controller -> Service: update(id, request)
activate Service

' --- FIND EXISTING ---
Service -> Repository: findById(id)
activate Repository

Repository -> DB: Query Semester by ID
activate DB
DB --> Repository: Semester Record / Null
deactivate DB

Repository --> Service: Optional<Semester>
deactivate Repository

alt Semester not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: 404 Not Found
end

' --- VALIDATION LOGIC ---
' Validation logic (internal)

alt Validation failed
    Service -->> Controller: <<throw>> ValidationException
    Controller --> Client: 400 Bad Request / 409 Conflict
end

' --- DEACTIVATION CHECK ---
opt Deactivating semester
    Service -> Repository: countActiveClassesBySemesterId(id)
    activate Repository

    Repository -> DB: Count Active Classes by Semester
    activate DB
    DB --> Repository: Count
    deactivate DB

    Repository --> Service: Long
    deactivate Repository

    alt Has active classes
        Service -->> Controller: <<throw>> OperationNotAllowedException
        Controller --> Client: 403 Forbidden
    end
end

' --- UPDATE ---
Service -> Repository: save(semester)
activate Repository

Repository -> DB: Update Semester
activate DB
DB --> Repository: Updated Semester
deactivate DB

Repository --> Service: Semester
deactivate Repository

Service --> Controller: Semester
deactivate Service

Controller --> Client: 200 OK
deactivate Controller

@enduml
