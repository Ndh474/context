@startuml export_exam_slots_report
!theme plain
hide footbox

actor Admin
participant ":ExportController" as Controller
participant ":ExportService" as Service
participant ":SlotRepository" as SlotRepo
participant ":ExamSlotParticipantRepository" as ParticipantRepo
participant "Database" as DB

' --- MAIN FLOW ---
Admin -> Controller: POST /api/v1/export/slots/excel
activate Controller

Controller -> Service: exportExamSlotsToExcel(request)
activate Service

' Get exam slots to export (internal: filter by semesterId, FINAL_EXAM category)

Service -> SlotRepo: findBySemesterId(semesterId) or findAllById(ids)
activate SlotRepo

SlotRepo -> DB: Query Exam Slots
activate DB
DB --> SlotRepo: Slot List
deactivate DB

SlotRepo --> Service: List<Slot>
deactivate SlotRepo

' Filter FINAL_EXAM slots (internal)

' Generate Excel workbook (internal: create overview sheet with statistics)

' --- FOR EACH EXAM SLOT ---
loop For each exam slot
    Service -> ParticipantRepo: findStudentsWithAttendanceBySlotId(slotId)
    activate ParticipantRepo
    
    ParticipantRepo -> DB: Query Participants with Attendance
    activate DB
    DB --> ParticipantRepo: Student Attendance List
    deactivate DB
    
    ParticipantRepo --> Service: List<StudentAttendanceInfoDTO>
    deactivate ParticipantRepo
    
    ' Create detail sheet with student attendance (internal)
end

' Write workbook to output stream (internal)

Service --> Controller: ByteArrayOutputStream
deactivate Service

Controller --> Admin: 200 OK (Excel File Download)
deactivate Controller

@enduml
