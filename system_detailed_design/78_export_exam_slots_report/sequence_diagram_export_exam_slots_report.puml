@startuml export_exam_slots_report
!theme plain
hide footbox

actor "Data Operator" as Admin

participant "«user interaction»\n:AdminExportDialog" as UI
participant "«control»\n:ExportController" as Controller
participant "«service»\n:ExportService" as Service
participant "«database wrapper»\n:SlotRepository" as SlotRepo
participant "«database wrapper»\n:ExamSlotParticipantRepository" as ParticipantRepo

' === MAIN FLOW ===
Admin -> UI: Select exam slots & click Export
activate UI

UI -> Controller: POST /api/v1/export/slots/excel
activate Controller

Controller -> Service: exportExamSlotsToExcel(request)
activate Service

' === GET EXAM SLOTS ===
alt Export all exam slots in semester
    Service -> SlotRepo: findBySemesterId(semesterId)
    activate SlotRepo
    SlotRepo -->> Service: List<Slot>
    deactivate SlotRepo
else Export specific slots
    Service -> SlotRepo: findAllById(ids)
    activate SlotRepo
    SlotRepo -->> Service: List<Slot>
    deactivate SlotRepo
end

Service -> Service: filterFinalExamSlots()
note right: Keep only FINAL_EXAM category

' === BUILD ATTENDANCE DATA FOR EACH SLOT ===
loop For each exam slot
    Service -> ParticipantRepo: findStudentsWithAttendanceBySlotId(slotId)
    activate ParticipantRepo
    ParticipantRepo -->> Service: List<StudentAttendanceInfoDTO>
    deactivate ParticipantRepo
end

Service -> Service: generateExcelWorkbook()
note right: Create overview sheet\nwith statistics and\ndetail sheets per slot

Service -->> Controller: ByteArrayOutputStream
deactivate Service

Controller -->> UI: 200 OK (Excel file)
deactivate Controller

UI -->> Admin: Download Excel file
deactivate UI

@enduml
