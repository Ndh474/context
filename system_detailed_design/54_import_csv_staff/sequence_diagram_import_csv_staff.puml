@startuml import_csv_staff
!theme plain
hide footbox

actor "Data Operator" as Admin

participant "«user interaction»\n:ImportStaffDialog" as UI
participant "«control»\n:StaffProfileController" as Controller
participant "«service»\n:StaffProfileService" as Service
participant "«service»\n:CsvParserService" as CsvParser
participant "«database wrapper»\n:UserRepository" as UserRepo
participant "«database wrapper»\n:StaffProfileRepository" as ProfileRepo
participant "«entity»\n:User" as UserEntity
participant "«entity»\n:StaffProfile" as ProfileEntity

' --- MAIN FLOW ---
Admin -> UI: Click "Import CSV"
activate UI

UI -> UI: Open import dialog

Admin -> UI: Select CSV File & Mode
Admin -> UI: Submit

UI -> Controller: POST /api/v1/staff-profiles/import
activate Controller

Controller -> Service: importFromCsv(file, mode)
activate Service

' --- PARSE CSV ---
Service -> CsvParser: parseStaffProfileCsv(file)
activate CsvParser
CsvParser -->> Service: List<StaffProfileCsvRow>
deactivate CsvParser

alt CSV parsing fails
    Service -->> Controller: <<throw>> BadRequestException
    Controller -->> UI: 400 Bad Request
end

' --- BATCH PROCESSING LOOP ---
loop For each unique CSV row
    ' Validation (Internal)
    Service -> Service: validateRow(row)

    alt row invalid
        Service -> Service: Collect error, continue
    else Create New Staff
        ' --- CREATE USER ---
        Service -> UserEntity: new User(row.username, row.email, ...)
        activate UserEntity
        UserEntity -->> Service: user
        deactivate UserEntity
        
        Service -> UserRepo: save(user)
        activate UserRepo
        UserRepo -->> Service: savedUser
        deactivate UserRepo

        ' --- CREATE PROFILE ---
        Service -> ProfileEntity: new StaffProfile(savedUser, staffCode, ...)
        activate ProfileEntity
        ProfileEntity -->> Service: profile
        deactivate ProfileEntity

        Service -> ProfileRepo: save(profile)
        activate ProfileRepo
        ProfileRepo -->> Service: savedProfile
        deactivate ProfileRepo
    end
end

Service -->> Controller: ImportResultDTO
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> Admin: Show result summary
deactivate UI

@enduml
