@startuml Delete Semester
!theme plain
hide footbox

actor Client
participant ":SemesterController" as Controller
participant ":SemesterService" as Service
participant ":SemesterRepository" as Repository
participant "Database" as DB

Client -> Controller: DELETE /api/v1/semesters/1
activate Controller

Controller -> Service: delete(id)
activate Service

' === Validation 1: Check Existence ===
Service -> Repository: existsById(id)
activate Repository

Repository -> DB: SELECT COUNT(*) > 0 FROM semesters\nWHERE id = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: exists:boolean
deactivate Repository

alt !exists
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Semester not found: 1",\ncode: "SEMESTER_NOT_FOUND"}
end

' === Validation 2: Check Active Classes ===
Service -> Repository: countActiveClassesBySemesterId(id)
activate Repository

Repository -> DB: SELECT COUNT(ac.id) FROM academic_classes ac\nWHERE ac.semester_id = ? AND ac.is_active = true
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: activeCount:long
deactivate Repository

alt activeCount > 0
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: HTTP 403\n{status: 403,\nmessage: "Cannot delete semester with {count} active classes. Deactivate classes first.",\ncode: "SEMESTER_HAS_ACTIVE_CLASSES"}
end

' === Validation 3: Delete with Foreign Key Constraint Handling ===
Service -> Repository: deleteById(id)
activate Repository

Repository -> DB: DELETE FROM semesters\nWHERE id = ?
activate DB
DB --> Repository
deactivate DB

deactivate Repository

Service -> Repository: flush()
activate Repository
Repository -> DB: FLUSH
activate DB

alt foreign key constraint violation
    DB -->> Repository: <<throw>> DataIntegrityViolationException
    Repository -->> Service: <<throw>> DataIntegrityViolationException
    deactivate Repository
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: HTTP 403\n{status: 403,\nmessage: "Delete all class associate with this semester first",\ncode: "FOREIGN_KEY_CONSTRAINT_VIOLATION"}
end

DB --> Repository
deactivate DB
Repository --> Service
deactivate Repository

Service --> Controller
deactivate Service

Controller --> Client: HTTP 200 OK\n{status: 200,\nmessage: "Delete semester successfully",\ncode: null,\ndata: null}
deactivate Controller

@enduml
