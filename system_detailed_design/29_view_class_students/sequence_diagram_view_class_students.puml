@startuml View Class Students
!theme plain
hide footbox

actor Client
participant ":ClassController" as Controller
participant ":ClassService" as ClassService
participant ":EnrollmentService" as EnrollmentService
participant ":ClassRepository" as ClassRepo
participant ":EnrollmentRepository" as EnrollmentRepo
participant "Database" as DB

Client -> Controller: GET /api/v1/classes/1/enrollments?page=0&pageSize=10&isEnrolled=true&search=John
activate Controller

' === Get Class Details ===
Controller -> ClassService: getClassDetailsForRoster(id)
activate ClassService

ClassService -> ClassRepo: findById(id)
activate ClassRepo

ClassRepo -> DB: SELECT * FROM classes c\nJOIN subjects sub ON c.subject_id = sub.id\nJOIN semesters sem ON c.semester_id = sem.id\nWHERE c.id = ?
activate DB
DB --> ClassRepo: classRecord
deactivate DB

ClassRepo --> ClassService: classOpt:Optional<AcademicClass>
deactivate ClassRepo

alt classOpt.isEmpty()
    ClassService -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Class not found: 1",\ncode: "CLASS_NOT_FOUND"}
end

ClassService --> Controller: classDTO:ClassDTO
deactivate ClassService

' === Get Students List ===
Controller -> EnrollmentService: findByClassId(id, request)
activate EnrollmentService

EnrollmentService -> ClassRepo: existsById(id)
activate ClassRepo

ClassRepo -> DB: SELECT COUNT(*) > 0 FROM classes\nWHERE id = ?
activate DB
DB --> ClassRepo: exists
deactivate DB

ClassRepo --> EnrollmentService: exists:boolean
deactivate ClassRepo

alt !exists
    EnrollmentService -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Class not found: 1",\ncode: "CLASS_NOT_FOUND"}
end

EnrollmentService -> EnrollmentRepo: findByClassId(id, request)
activate EnrollmentRepo

EnrollmentRepo -> DB: SELECT u.id, u.full_name, sp.roll_number, u.email,\n    m.name, m.code, e.is_enrolled, e.created_at, e.updated_at\nFROM enrollments e\nJOIN users u ON e.student_user_id = u.id\nLEFT JOIN student_profiles sp ON sp.user_id = u.id\nLEFT JOIN majors m ON sp.major_id = m.id\nWHERE e.class_id = ?\n  AND e.is_enrolled = ?\n  AND (LOWER(u.full_name) LIKE ? OR LOWER(sp.roll_number) LIKE ? OR LOWER(u.email) LIKE ?)\nORDER BY u.full_name ASC\nLIMIT ? OFFSET ?
activate DB
DB --> EnrollmentRepo: resultList
deactivate DB

EnrollmentRepo --> EnrollmentService: students:List<StudentProfileDTO>
deactivate EnrollmentRepo

EnrollmentService --> Controller: students:List<StudentProfileDTO>
deactivate EnrollmentService

' === Get Total Count ===
Controller -> EnrollmentService: countByClassId(id, request)
activate EnrollmentService

EnrollmentService -> ClassRepo: existsById(id)
activate ClassRepo

ClassRepo -> DB: SELECT COUNT(*) > 0 FROM classes\nWHERE id = ?
activate DB
DB --> ClassRepo: exists
deactivate DB

ClassRepo --> EnrollmentService: exists:boolean
deactivate ClassRepo

EnrollmentService -> EnrollmentRepo: countByClassId(id, request)
activate EnrollmentRepo

EnrollmentRepo -> DB: SELECT COUNT(e.id) FROM enrollments e\nJOIN users u ON e.student_user_id = u.id\nLEFT JOIN student_profiles sp ON sp.user_id = u.id\nWHERE e.class_id = ?\n  AND e.is_enrolled = ?\n  AND (LOWER(u.full_name) LIKE ? OR LOWER(sp.roll_number) LIKE ? OR LOWER(u.email) LIKE ?)
activate DB
DB --> EnrollmentRepo: count
deactivate DB

EnrollmentRepo --> EnrollmentService: total:Long
deactivate EnrollmentRepo

EnrollmentService --> Controller: total:Long
deactivate EnrollmentService

' === Get Enrolled Count ===
Controller -> EnrollmentService: countEnrolledByClassId(id)
activate EnrollmentService

EnrollmentService -> ClassRepo: existsById(id)
activate ClassRepo

ClassRepo -> DB: SELECT COUNT(*) > 0 FROM classes\nWHERE id = ?
activate DB
DB --> ClassRepo: exists
deactivate DB

ClassRepo --> EnrollmentService: exists:boolean
deactivate ClassRepo

EnrollmentService -> EnrollmentRepo: countEnrolledByClassId(id)
activate EnrollmentRepo

EnrollmentRepo -> DB: SELECT COUNT(id) FROM enrollments\nWHERE class_id = ? AND is_enrolled = true
activate DB
DB --> EnrollmentRepo: count
deactivate DB

EnrollmentRepo --> EnrollmentService: totalEnrolled:Long
deactivate EnrollmentRepo

EnrollmentService --> Controller: totalEnrolled:Long
deactivate EnrollmentService

' === Get Withdrawn Count ===
Controller -> EnrollmentService: countWithdrawnByClassId(id)
activate EnrollmentService

EnrollmentService -> ClassRepo: existsById(id)
activate ClassRepo

ClassRepo -> DB: SELECT COUNT(*) > 0 FROM classes\nWHERE id = ?
activate DB
DB --> ClassRepo: exists
deactivate DB

ClassRepo --> EnrollmentService: exists:boolean
deactivate ClassRepo

EnrollmentService -> EnrollmentRepo: countWithdrawnByClassId(id)
activate EnrollmentRepo

EnrollmentRepo -> DB: SELECT COUNT(id) FROM enrollments\nWHERE class_id = ? AND is_enrolled = false
activate DB
DB --> EnrollmentRepo: count
deactivate DB

EnrollmentRepo --> EnrollmentService: totalWithdrawn:Long
deactivate EnrollmentRepo

EnrollmentService --> Controller: totalWithdrawn:Long
deactivate EnrollmentService

' === Build Response ===
Controller -> Controller: new ClassRosterDTO(request, classDTO, students, total, totalEnrolled, totalWithdrawn)

Controller --> Client: HTTP 200 OK\n{status: 200,\ndata: {\n  class: {\n    id: 1,\n    code: "SE01",\n    subject: {...},\n    semester: {...}\n  },\n  items: [\n    {\n      id: 101,\n      fullName: "John Doe",\n      rollNumber: "SE12345",\n      email: "john@example.com",\n      majorName: "Software Engineering",\n      majorCode: "SE",\n      isEnrolled: true\n    }\n  ],\n  totalEnrolled: 48,\n  totalWithdrawn: 2,\n  currentPage: 1,\n  pageSize: 10,\n  totalItems: 48,\n  totalPages: 5\n}}
deactivate Controller

@enduml
