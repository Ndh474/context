@startuml Import CSV Exam Slot Participants
!theme plain
hide footbox

actor Client
participant ":ExamSlotImportController" as Controller
participant ":ExamSlotImportService" as Service
participant ":CsvParserService" as CsvParser
participant ":SlotRepository" as SlotRepo
participant ":ExamSlotParticipantRepository" as ParticipantRepo
participant ":Database" as DB

Client -> Controller: POST /api/v1/exam-slot-participants/import\nMultipartFile file, String mode
activate Controller

alt file is null or empty
    Controller --> Client: HTTP 400\n{message: "CSV file is required"}
end

Controller -> Service: importParticipantsFromCsv(file, modeStr)
activate Service

Service -> CsvParser: parseExamSlotParticipantCsv(file)
activate CsvParser

alt invalid CSV format
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{message: "Invalid CSV format"}
end

CsvParser --> Service: rows:List<ExamSlotParticipantCsvRow>
deactivate CsvParser

note right of Service
Deduplication by business key:
(semester_code, start_time, room_name,
subject_code, roll_number)
end note

loop for each unique row
    Service -> Service: processOneExamSlotParticipantRow(row, mode)
    activate Service

    alt !row.isValid()
        note right of Service
        Collect error, continue
        end note
        Service --> Service
        deactivate Service
    else row is valid

        ' === Find Slot by Natural Keys ===
        Service -> SlotRepo: findBySemesterCodeAndStartTimeAndRoomName(...)
        activate SlotRepo
        SlotRepo -> DB: SELECT * FROM slots s\nJOIN semesters sem ON s.semester_id = sem.id\nJOIN rooms r ON s.room_id = r.id\nWHERE sem.code = ? AND s.start_time = ? AND r.name = ?
        activate DB
        DB --> SlotRepo: slotRecord
        deactivate DB
        SlotRepo --> Service: slot:Slot
        deactivate SlotRepo

        alt slot is null or invalid (not FINAL_EXAM, inactive)
            note right of Service
            Collect error, continue
            end note
            Service --> Service
            deactivate Service
        else slot valid

            note right of Service
            Validate:
            - Subject exists and assigned to slot
            - Student exists, active
            - Student enrolled in subject
            end note

            alt any validation fails
                note right of Service
                Collect error, continue
                end note
                Service --> Service
                deactivate Service
            else all validations pass

                ' === Check Existing Participant ===
                Service -> ParticipantRepo: findByExamSlotSubjectIdAndStudentUserId(...)
                activate ParticipantRepo
                ParticipantRepo -> DB: SELECT * FROM exam_slot_participants\nWHERE exam_slot_subject_id = ? AND student_user_id = ?
                activate DB
                DB --> ParticipantRepo: participantRecord
                deactivate DB
                ParticipantRepo --> Service: existingOpt:Optional<ExamSlotParticipant>
                deactivate ParticipantRepo

                alt existingOpt.isPresent() AND existing.isEnrolled = true
                    alt mode = ADD_ONLY
                        note right of Service
                        Collect error, continue
                        end note
                        Service --> Service
                        deactivate Service
                    else mode = ADD_AND_UPDATE
                        note right of Service
                        Skip (no change needed)
                        end note
                        Service --> Service
                        deactivate Service
                    end
                else existingOpt.isPresent() AND existing.isEnrolled = false
                    alt mode = ADD_ONLY
                        note right of Service
                        Collect error, continue
                        end note
                        Service --> Service
                        deactivate Service
                    else mode = ADD_AND_UPDATE
                        Service -> Service: existing.setEnrolled(true)
                        Service -> ParticipantRepo: save(existing)
                        activate ParticipantRepo
                        ParticipantRepo -> DB: UPDATE exam_slot_participants\nSET is_enrolled = true WHERE id = ?
                        activate DB
                        DB --> ParticipantRepo: updatedRecord
                        deactivate DB
                        ParticipantRepo --> Service: updated:ExamSlotParticipant
                        deactivate ParticipantRepo

                        note right of Service
                        Increment successCount
                        end note
                        Service --> Service
                        deactivate Service
                    end
                else !existingOpt.isPresent()
                    ' === Create New Participant ===
                    Service -> ParticipantRepo: save(participant)
                    activate ParticipantRepo
                    ParticipantRepo -> DB: INSERT INTO exam_slot_participants\n(exam_slot_subject_id, student_user_id, is_enrolled)\nVALUES (?, ?, true)
                    activate DB
                    DB --> ParticipantRepo: savedRecord
                    deactivate DB
                    ParticipantRepo --> Service: saved:ExamSlotParticipant
                    deactivate ParticipantRepo

                    note right of Service
                    Increment successCount
                    end note
                    Service --> Service
                    deactivate Service
                end
            end
        end
    end
end

Service --> Controller: result:ImportResultDTO
deactivate Service

Controller --> Client: HTTP 200 OK\n{message: "Import completed: X successful, Y failed",\ndata: {successCount, failureCount, errors}}
deactivate Controller

@enduml
