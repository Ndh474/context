@startuml Import CSV Enrollment
!theme plain
hide footbox

actor Client
participant ":EnrollmentController" as Controller
participant ":EnrollmentService" as Service
participant ":CsvParserService" as CsvParser
participant ":StudentProfileRepository" as StudentRepo
participant ":ClassRepository" as ClassRepo
participant ":EnrollmentRepository" as EnrollmentRepo
participant ":EnrollmentMapper" as Mapper
participant "Database" as DB

Client -> Controller: POST /api/v1/enrollments/import\nMultipartFile file, String mode
activate Controller

' === Validation 1: File Required ===
alt file is null or empty
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "CSV file is required",\ncode: "FILE_REQUIRED"}
end

Controller -> Service: importFromCsv(file, modeStr)
activate Service

' === CSV Parsing ===
Service -> CsvParser: parseEnrollmentCsv(file)
activate CsvParser

' === File Validation ===
alt file size > 5MB
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "File size exceeds 5MB limit",\ncode: "FILE_TOO_LARGE"}
end

alt invalid file type (not CSV)
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Invalid file type",\ncode: "INVALID_FILE_TYPE"}
end

alt invalid CSV header
    CsvParser -->> Service: <<throw>> BadRequestException
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Invalid CSV format. Expected header: roll_number,class_code,semester_code",\ncode: "INVALID_CSV_FORMAT"}
end

CsvParser --> Service: rows:List<EnrollmentCsvRow>
deactivate CsvParser

note right of Service
Perform in-memory deduplication
by unique key (rollNumber + classCode + semesterCode)
Keep first occurrence
end note

' === Batch Processing Loop ===
loop for each unique row
    note right of Service
    Each row processed in
    REQUIRES_NEW transaction
    (independent commit/rollback)
    end note

    Service -> Service: processOneEnrollmentRow(row, mode)
    activate Service

    ' === Row Validation ===
    alt !row.isValid()
        note right of Service
        Collect error:
        INVALID_FIELD_FORMAT
        Continue to next row
        end note
        Service --> Service
        deactivate Service
    else row is valid

        ' === Lookup Student ===
        Service -> StudentRepo: findByRollNumberWithUserAndMajor(rollNumber)
        activate StudentRepo

        StudentRepo -> DB: SELECT sp.*, u.*, m.*\nFROM student_profiles sp\nJOIN users u ON sp.user_id = u.id\nJOIN majors m ON sp.major_id = m.id\nWHERE sp.roll_number = ?
        activate DB
        DB --> StudentRepo: studentRecord
        deactivate DB

        StudentRepo --> Service: student:StudentProfile
        deactivate StudentRepo

        alt student == null
            note right of Service
            Collect error:
            STUDENT_NOT_FOUND
            Continue to next row
            end note
            Service --> Service
            deactivate Service
        else student found

            opt !student.user.isActive
                note right of Service
                Collect error:
                INACTIVE_STUDENT_NOT_ALLOWED
                Continue to next row
                end note
                Service --> Service
                deactivate Service
            end

            ' === Lookup Class ===
            Service -> ClassRepo: findByCodeAndSemesterCodeWithSubjectAndSemester(classCode, semesterCode)
            activate ClassRepo

            ClassRepo -> DB: SELECT c.*, sub.*, sem.*, m.*\nFROM classes c\nJOIN subjects sub ON c.subject_id = sub.id\nJOIN subject_majors sm ON sub.id = sm.subject_id\nJOIN majors m ON sm.major_id = m.id\nJOIN semesters sem ON c.semester_id = sem.id\nWHERE c.code = ? AND sem.code = ?
            activate DB
            DB --> ClassRepo: classRecord
            deactivate DB

            ClassRepo --> Service: academicClass:AcademicClass
            deactivate ClassRepo

            alt academicClass == null
                note right of Service
                Collect error:
                CLASS_NOT_FOUND
                Continue to next row
                end note
                Service --> Service
                deactivate Service
            else class found

                opt !academicClass.isActive
                    note right of Service
                    Collect error:
                    INACTIVE_CLASS_NOT_ALLOWED
                    Continue to next row
                    end note
                    Service --> Service
                    deactivate Service
                end

                ' === Validate Major Match ===
                Service -> Service: subjectMajorIds = academicClass.subject.majors.stream().map(Major::getId).collect()

                alt !subjectMajorIds.contains(student.major.id)
                    note right of Service
                    Collect error:
                    STUDENT_MAJOR_NOT_MATCH
                    Continue to next row
                    end note
                    Service --> Service
                    deactivate Service
                end

                ' === Validate Semester Not Ended ===
                Service -> Service: today = LocalDate.now()
                Service -> Service: semesterEndDate = academicClass.semester.endDate

                alt today.isAfter(semesterEndDate)
                    note right of Service
                    Collect error:
                    SEMESTER_ENDED
                    Continue to next row
                    end note
                    Service --> Service
                    deactivate Service
                end

                ' === Check Existing Enrollment ===
                Service -> Mapper: createEnrollmentId(academicClass.id, student.userId)
                activate Mapper
                Mapper --> Service: enrollmentId:EnrollmentId
                deactivate Mapper

                Service -> EnrollmentRepo: existsById(enrollmentId)
                activate EnrollmentRepo

                EnrollmentRepo -> DB: SELECT COUNT(*) > 0 FROM enrollments\nWHERE class_id = ? AND student_user_id = ?
                activate DB
                DB --> EnrollmentRepo: exists
                deactivate DB

                EnrollmentRepo --> Service: exists:boolean
                deactivate EnrollmentRepo

                ' === Mode Branching ===
                alt mode = ADD_ONLY
                    alt exists = true
                        Service -> EnrollmentRepo: findById(enrollmentId)
                        activate EnrollmentRepo
                        EnrollmentRepo -> DB: SELECT * FROM enrollments\nWHERE class_id = ? AND student_user_id = ?
                        activate DB
                        DB --> EnrollmentRepo: enrollmentRecord
                        deactivate DB
                        EnrollmentRepo --> Service: existingOpt:Optional<Enrollment>
                        deactivate EnrollmentRepo

                        Service -> Service: existing = existingOpt.get()

                        alt existing.isEnrolled = true
                            note right of Service
                            Collect error:
                            ALREADY_ENROLLED
                            Continue to next row
                            end note
                            Service --> Service
                            deactivate Service
                        else existing.isEnrolled = false (Re-enrollment)
                            Service -> Service: existing.setEnrolled(true)
                            Service -> EnrollmentRepo: save(existing)
                            activate EnrollmentRepo
                            EnrollmentRepo -> DB: UPDATE enrollments\nSET is_enrolled = true, updated_at = NOW()\nWHERE class_id = ? AND student_user_id = ?
                            activate DB
                            DB --> EnrollmentRepo: updatedRecord
                            deactivate DB
                            EnrollmentRepo --> Service: saved:Enrollment
                            deactivate EnrollmentRepo

                            note right of Service
                            Increment successCount
                            Commit transaction
                            end note
                            Service --> Service
                            deactivate Service
                        end
                    else exists = false
                        Service -> Service: enrollment = new Enrollment()
                        Service -> Service: enrollment.setId(enrollmentId)
                        Service -> Service: enrollment.setEnrolled(true)
                        Service -> Service: enrollment.setAcademicClass(academicClass)
                        Service -> Service: enrollment.setStudent(student.user)

                        Service -> EnrollmentRepo: save(enrollment)
                        activate EnrollmentRepo
                        EnrollmentRepo -> DB: INSERT INTO enrollments\n(class_id, student_user_id, is_enrolled, created_at, updated_at)\nVALUES (?, ?, true, NOW(), NOW())
                        activate DB
                        DB --> EnrollmentRepo: savedRecord
                        deactivate DB
                        EnrollmentRepo --> Service: saved:Enrollment
                        deactivate EnrollmentRepo

                        note right of Service
                        Increment successCount
                        Commit transaction
                        end note
                        Service --> Service
                        deactivate Service
                    end

                else mode = ADD_AND_UPDATE
                    alt exists = true
                        Service -> EnrollmentRepo: findById(enrollmentId)
                        activate EnrollmentRepo
                        EnrollmentRepo -> DB: SELECT * FROM enrollments\nWHERE class_id = ? AND student_user_id = ?
                        activate DB
                        DB --> EnrollmentRepo: enrollmentRecord
                        deactivate DB
                        EnrollmentRepo --> Service: existingOpt:Optional<Enrollment>
                        deactivate EnrollmentRepo

                        Service -> Service: existing = existingOpt.get()

                        alt existing.isEnrolled = false (Re-enrollment)
                            Service -> Service: existing.setEnrolled(true)
                            Service -> EnrollmentRepo: save(existing)
                            activate EnrollmentRepo
                            EnrollmentRepo -> DB: UPDATE enrollments\nSET is_enrolled = true, updated_at = NOW()\nWHERE class_id = ? AND student_user_id = ?
                            activate DB
                            DB --> EnrollmentRepo: updatedRecord
                            deactivate DB
                            EnrollmentRepo --> Service: saved:Enrollment
                            deactivate EnrollmentRepo

                            note right of Service
                            Increment successCount
                            Commit transaction
                            end note
                            Service --> Service
                            deactivate Service
                        else existing.isEnrolled = true
                            note right of Service
                            Already enrolled, skip
                            Increment successCount
                            end note
                            Service --> Service
                            deactivate Service
                        end

                    else exists = false
                        note right of Service
                        Same as ADD_ONLY:
                        Create new enrollment
                        Increment successCount
                        end note
                        Service --> Service
                        deactivate Service
                    end
                end
            end
        end
    end
end

Service --> Controller: result:ImportResultDTO
deactivate Service

Controller --> Client: HTTP 200 OK\n{status: 200,\nmessage: "Import completed: X successful, Y failed",\ndata: {\n  successCount: X,\n  failureCount: Y,\n  errors: [\n    {rowNumber: N, errorCode: "...", message: "..."}\n  ]\n}}
deactivate Controller

@enduml
