@startuml import_csv_enrollment
!theme plain
hide footbox

actor Admin
participant ":EnrollmentController" as Controller
participant ":EnrollmentService" as Service
participant ":CsvParserService" as CsvParser
participant ":EnrollmentRepository" as Repository
participant "Database" as DB

' --- MAIN FLOW ---
Admin -> Controller: POST /api/v1/enrollments/import
activate Controller

' File validation (internal)

alt File validation fails
    Controller --> Admin: 400 Bad Request
end

Controller -> Service: importFromCsv(file, mode)
activate Service

' Mode validation (internal)

alt Invalid import mode
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Admin: 400 Bad Request
end

' --- PARSE CSV ---
Service -> CsvParser: parseEnrollmentCsv(file)
activate CsvParser

CsvParser --> Service: List<EnrollmentCsvRow>
deactivate CsvParser

alt CSV parsing fails
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Admin: 400 Bad Request
end

' CSV deduplication (internal)

' --- BATCH PROCESSING LOOP ---
loop For each unique CSV row
    ' Row validation (internal: student/class validation, major eligibility, semester check)

    Service -> Repository: existsById(enrollmentId)
    activate Repository

    Repository -> DB: Check Enrollment Exists
    activate DB
    DB --> Repository: boolean
    deactivate DB

    Repository --> Service: boolean
    deactivate Repository

    ' Business logic: create or update based on mode and enrollment status (internal)

    alt Validation fails
        Service --> Service: Collect error, continue
    else Validation passes
        Service -> Repository: save(enrollment)
        activate Repository

        Repository -> DB: Insert or Update Enrollment
        activate DB
        DB --> Repository: Saved Enrollment
        deactivate DB

        Repository --> Service: Enrollment
        deactivate Repository
    end
end

' Build result with success/failure counts (internal)

Service --> Controller: Import Result
deactivate Service

Controller --> Admin: 200 OK
deactivate Controller

@enduml
