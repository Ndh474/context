@startuml import_csv_enrollment
!theme plain
hide footbox

actor "Data Operator" as DataOperator

participant "«user interaction»\n:GenericImportDialog" as UI
participant "«control»\n:EnrollmentController" as Controller
participant "«service»\n:EnrollmentService" as Service
participant "«service»\n:CsvParserService" as CsvParser
participant "«database wrapper»\n:EnrollmentRepository" as Repository
participant "«entity»\n:Enrollment" as Entity

' === MAIN FLOW ===
DataOperator -> UI: Click "Import CSV"
activate UI

UI -> UI: Select file and parsing mode

DataOperator -> UI: Click "Import"
UI -> Controller: POST /api/v1/enrollments/import
activate Controller

Controller -> Service: importFromCsv(file, mode)
activate Service

' === PARSE CSV ===
Service -> CsvParser: parseEnrollmentCsv(file)
activate CsvParser
alt Parsing error
    CsvParser -->> Service: <<throw>> CsvParsingException
    Service -->> Controller: <<throw>> CsvParsingException
    Controller -->> UI: 400 Bad Request
end
CsvParser -->> Service: List<EnrollmentCsvRow>
deactivate CsvParser

' === PROCESS ROWS ===
loop For each row in CSV
    Service -> Repository: findByClassCodeAndStudentCode(...)
    activate Repository
    Repository -->> Service: Optional<Enrollment>
    deactivate Repository

    alt Enrollment exists
        alt Mode = UPDATE
            Service -> Entity: update(data)
            activate Entity
            Entity -->> Service: updatedEnrollment
            deactivate Entity
            
            Service -> Repository: save(updatedEnrollment)
            activate Repository
            Repository -->> Service: savedEnrollment
            deactivate Repository
        end
    else Enrollment does not exist
        alt Mode = ADD
            Service -> Entity: new Enrollment(data)
            activate Entity
            Entity -->> Service: newEnrollment
            deactivate Entity
            
            Service -> Repository: save(newEnrollment)
            activate Repository
            Repository -->> Service: savedEnrollment
            deactivate Repository
        end
    end
end

Service -->> Controller: ImportResultDTO
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> DataOperator: Show result summary\n(Success/Fail counts)
deactivate UI

@enduml
