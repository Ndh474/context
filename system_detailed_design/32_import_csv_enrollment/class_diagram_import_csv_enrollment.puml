@startuml Import CSV Enrollment - Class Diagram
!theme plain
skinparam classAttributeIconSize 0
hide circle
skinparam circledCharacterRadius 0

class EnrollmentController {
  - enrollmentService : EnrollmentService
  + importEnrollments(file : MultipartFile, mode : String) : Response<ImportResultDTO>
}

class EnrollmentService {
  - enrollmentRepository : EnrollmentRepository
  - studentProfileRepository : StudentProfileRepository
  - classRepository : ClassRepository
  - enrollmentMapper : EnrollmentMapper
  - csvParserService : CsvParserService
  + importFromCsv(file : MultipartFile, modeStr : String) : ImportResultDTO
  # processOneEnrollmentRow(row : EnrollmentCsvRow, mode : ImportMode) : void
  - extractErrorCode(e : Exception) : String
}

class CsvParserService {
  + parseEnrollmentCsv(file : MultipartFile) : List<EnrollmentCsvRow>
}

interface EnrollmentRepository <<interface>> {
  + existsById(id : EnrollmentId) : boolean
  + findById(id : EnrollmentId) : Optional<Enrollment>
  + save(entity : Enrollment) : Enrollment
}

interface StudentProfileRepository <<interface>> {
  + findByRollNumberWithUserAndMajor(rollNumber : String) : StudentProfile
}

interface ClassRepository <<interface>> {
  + findByCodeAndSemesterCodeWithSubjectAndSemester(code : String, semesterCode : String) : AcademicClass
}

interface EnrollmentMapper <<interface>> {
  + createEnrollmentId(classId : Short, studentUserId : Integer) : EnrollmentId
}

class Enrollment {
  - id : EnrollmentId
  - academicClass : AcademicClass
  - student : User
  - isEnrolled : Boolean
}

class EnrollmentId {
  - classId : Short
  - studentUserId : Integer
}

class AcademicClass {
  - id : Short
  - code : String
  - subject : Subject
  - semester : Semester
}

class Subject {
  - id : Short
  - name : String
  - code : String
  - majors : Set<Major>
}

class Semester {
  - id : Short
  - name : String
  - code : String
  - startDate : LocalDate
  - endDate : LocalDate
}

class StudentProfile {
  - userId : Integer
  - user : User
  - rollNumber : String
  - major : Major
}

class User {
  - id : Integer
  - fullName : String
  - email : String
}

class Major {
  - id : Short
  - name : String
  - code : String
}

class BaseEntity {
  - isActive : Boolean
  - createdAt : Instant
  - updatedAt : Instant
}

class EnrollmentCsvRow {
  - rowNumber : int
  - rollNumber : String
  - classCode : String
  - semesterCode : String
  + isValid() : boolean
  + getUniqueKey() : String
}

class ImportResultDTO {
  - successCount : int
  - failureCount : int
  - errors : List<ImportErrorDTO>
}

class ImportErrorDTO {
  - rowNumber : int
  - errorCode : String
  - message : String
}

class Response<T> {
  - status : int
  - message : String
  - code : String
  - data : T
}

class ImportMode <<enumeration>> {
  ADD_ONLY
  ADD_AND_UPDATE
  + fromString(mode : String) : ImportMode
}

EnrollmentController --> EnrollmentService
EnrollmentService --> EnrollmentRepository
EnrollmentService --> StudentProfileRepository
EnrollmentService --> ClassRepository
EnrollmentService --> EnrollmentMapper
EnrollmentService --> CsvParserService

EnrollmentController ..> Response : <<use>>
EnrollmentController ..> ImportResultDTO : <<use>>
EnrollmentService ..> ImportResultDTO : <<use>>
EnrollmentService ..> EnrollmentCsvRow : <<use>>
EnrollmentService ..> ImportMode : <<use>>
EnrollmentService ..> Enrollment : <<use>>
EnrollmentService ..> AcademicClass : <<use>>
EnrollmentService ..> StudentProfile : <<use>>
EnrollmentService ..> EnrollmentId : <<use>>
CsvParserService ..> EnrollmentCsvRow : <<use>>
EnrollmentRepository ..> Enrollment : <<use>>
EnrollmentRepository ..> EnrollmentId : <<use>>
StudentProfileRepository ..> StudentProfile : <<use>>
ClassRepository ..> AcademicClass : <<use>>
EnrollmentMapper ..> EnrollmentId : <<use>>

ImportResultDTO *-- ImportErrorDTO

Enrollment --> EnrollmentId
Enrollment --> AcademicClass
Enrollment --> User
AcademicClass --> Subject
AcademicClass --> Semester
Subject --> Major
StudentProfile --> User
StudentProfile --> Major
Enrollment --|> BaseEntity
AcademicClass --|> BaseEntity
Subject --|> BaseEntity
Semester --|> BaseEntity
User --|> BaseEntity

@enduml
