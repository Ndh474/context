@startuml Create Slot
!theme plain
hide footbox

actor Client
participant ":SlotController" as Controller
participant ":SlotService" as Service
participant ":SlotRepository" as SlotRepo
participant ":SemesterRepository" as SemesterRepo
participant ":ClassRepository" as ClassRepo
participant ":RoomRepository" as RoomRepo
participant ":UserRepository" as UserRepo
participant ":SubjectRepository" as SubjectRepo
participant ":ExamSlotSubjectRepository" as ExamSlotSubjectRepo
participant ":SlotMapper" as Mapper
participant "Database" as DB

Client -> Controller: POST /api/v1/slots\n{title, startTime, endTime, slotCategory, classId, semesterId, roomId, staffUserId, subjectIds}
activate Controller

Controller -> Service: create(request)
activate Service

' === Validation 1: Time Range ===
alt endTime <= startTime
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "End time must be after start time",\ncode: "INVALID_TIME_RANGE"}
end

' === Validation 2: Slot Duration ===
Service -> Service: duration = Duration.between(startTime, endTime)
alt duration < 30min OR duration > 240min
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Slot duration must be between 30 minutes and 4 hours",\ncode: "INVALID_SLOT_DURATION"}
end

' === Validation 3: Slot Category Requirements ===
alt slotCategory = FINAL_EXAM
    alt classId != null
        Service -->> Controller: <<throw>> BadRequestException
        Controller --> Client: HTTP 400\n{status: 400,\nmessage: "FINAL_EXAM slots cannot have a classId",\ncode: "INVALID_SLOT_CATEGORY"}
    end
    alt semesterId = null
        Service -->> Controller: <<throw>> BadRequestException
        Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Semester ID is required for FINAL_EXAM slots",\ncode: "SLOT_SEMESTER_ID_REQUIRED"}
    end
else slotCategory = LECTURE or LECTURE_WITH_PT
    alt classId = null
        Service -->> Controller: <<throw>> BadRequestException
        Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Class ID is required for LECTURE and LECTURE_WITH_PT slots",\ncode: "SLOT_CLASS_ID_REQUIRED"}
    end
end

' === Validation 4: Room Time Conflict ===
Service -> SlotRepo: existsByRoomAndTimeRange(roomId, startTime, endTime, null)
activate SlotRepo
SlotRepo -> DB: SELECT COUNT(*) > 0 FROM slots\nWHERE room_id = ? AND start_time < ? AND end_time > ?
activate DB
DB --> SlotRepo: exists
deactivate DB
SlotRepo --> Service: exists:boolean
deactivate SlotRepo

alt exists = true
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Room is already booked for the specified time range",\ncode: "ROOM_TIME_CONFLICT"}
end

' === Validation 5: Staff Time Conflict ===
Service -> SlotRepo: existsByStaffAndTimeRange(staffUserId, startTime, endTime, null)
activate SlotRepo
SlotRepo -> DB: SELECT COUNT(*) > 0 FROM slots\nWHERE staff_user_id = ? AND start_time < ? AND end_time > ?
activate DB
DB --> SlotRepo: exists
deactivate DB
SlotRepo --> Service: exists:boolean
deactivate SlotRepo

alt exists = true
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Staff is already assigned to another slot",\ncode: "STAFF_TIME_CONFLICT"}
end

' === Validation 6: Semester Exists and Active ===
Service -> SemesterRepo: findById(semesterId)
activate SemesterRepo
SemesterRepo -> DB: SELECT * FROM semesters WHERE id = ?
activate DB
DB --> SemesterRepo: semesterRecord
deactivate DB
SemesterRepo --> Service: semesterOpt:Optional<Semester>
deactivate SemesterRepo

alt semesterOpt.isEmpty()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Semester not found",\ncode: "SEMESTER_NOT_FOUND"}
end

Service -> Service: semester = semesterOpt.get()

opt !semester.isActive
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Cannot create slot with inactive semester",\ncode: "INACTIVE_REFERENCE_NOT_ALLOWED"}
end

' === Validation 7: Class (if provided) ===
opt classId != null
    Service -> ClassRepo: findById(classId)
    activate ClassRepo
    ClassRepo -> DB: SELECT * FROM classes WHERE id = ?
    activate DB
    DB --> ClassRepo: classRecord
    deactivate DB
    ClassRepo --> Service: classOpt:Optional<AcademicClass>
    deactivate ClassRepo

    alt classOpt.isEmpty()
        Service -->> Controller: <<throw>> ResourceNotFoundException
        Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Class not found",\ncode: "CLASS_NOT_FOUND"}
    end

    Service -> Service: academicClass = classOpt.get()

    opt !academicClass.isActive
        Service -->> Controller: <<throw>> BadRequestException
        Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Cannot create slot with inactive class",\ncode: "INACTIVE_CLASS_NOT_ALLOWED"}
    end

    alt academicClass.semester.id != semesterId
        Service -->> Controller: <<throw>> BadRequestException
        Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Class does not belong to the specified semester",\ncode: "CLASS_SEMESTER_MISMATCH"}
    end
end

' === Validation 8: Room, Staff (similar pattern) ===
note right of Service
Validate Room and Staff exist and active
Validate Staff has LECTURER or SUPERVISOR role
(Similar to Class validation above)
end note

' === Create Slot ===
Service -> Mapper: toEntity(request)
activate Mapper
Mapper --> Service: slot:Slot
deactivate Mapper

Service -> Service: slot.setSemester(semester)
Service -> Service: slot.setAcademicClass(academicClass or null)
Service -> Service: slot.setRoom(room)
Service -> Service: slot.setStaff(staff)

Service -> SlotRepo: save(slot)
activate SlotRepo
SlotRepo -> DB: INSERT INTO slots\n(title, start_time, end_time, slot_category, class_id, semester_id, room_id, staff_user_id, is_active, created_at, updated_at)\nVALUES (?, ?, ?, ?, ?, ?, ?, ?, true, NOW(), NOW())\nRETURNING *
activate DB
DB --> SlotRepo: savedRecord
deactivate DB
SlotRepo --> Service: savedSlot:Slot
deactivate SlotRepo

' === Handle FINAL_EXAM Subjects (if provided) ===
opt slotCategory = FINAL_EXAM AND subjectIds not empty
    loop for each subjectId
        Service -> SubjectRepo: findById(subjectId)
        activate SubjectRepo
        SubjectRepo -> DB: SELECT * FROM subjects WHERE id = ?
        activate DB
        DB --> SubjectRepo: subjectRecord
        deactivate DB
        SubjectRepo --> Service: subjectOpt:Optional<Subject>
        deactivate SubjectRepo

        Service -> Service: subject = subjectOpt.get()

        Service -> Service: examSlotSubject = new ExamSlotSubject()
        Service -> Service: examSlotSubject.setSlot(savedSlot)
        Service -> Service: examSlotSubject.setSubject(subject)

        Service -> ExamSlotSubjectRepo: save(examSlotSubject)
        activate ExamSlotSubjectRepo
        ExamSlotSubjectRepo -> DB: INSERT INTO exam_slot_subjects\n(slot_id, subject_id, is_active)\nVALUES (?, ?, true)
        activate DB
        DB --> ExamSlotSubjectRepo: savedRecord
        deactivate DB
        ExamSlotSubjectRepo --> Service: saved:ExamSlotSubject
        deactivate ExamSlotSubjectRepo
    end
end

' === Map to DTO ===
Service -> Mapper: toDTO(savedSlot)
activate Mapper
Mapper --> Service: dto:SlotDTO
deactivate Mapper

Service --> Controller: SlotDTO
deactivate Service

Controller --> Client: HTTP 201 CREATED\n{status: 201,\ndata: {\n  id: 1,\n  title: "Lecture SE1",\n  startTime: "2024-12-15T14:00:00",\n  endTime: "2024-12-15T16:30:00",\n  slotCategory: "LECTURE",\n  isActive: true,\n  createdAt: "2024-11-19T16:30:00Z"\n}}
deactivate Controller

@enduml
