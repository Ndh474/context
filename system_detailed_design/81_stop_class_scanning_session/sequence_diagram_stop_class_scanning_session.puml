@startuml stop_class_scanning_session
!theme plain
hide footbox

actor "Lecturer" as Lecturer

participant "«user interaction»\n:SessionControls" as UI
participant "«control»\n:SlotController" as Controller
participant "«service»\n:SlotSessionService" as Service
participant "«database wrapper»\n:SlotRepository" as SlotRepo
participant "«database wrapper»\n:AttendanceRecordRepository" as AttendanceRepo
participant "«service»\n:AttendanceRecordService" as AttendanceService
participant "«external»\n:PythonBackendClient" as PythonClient
participant "«entity»\n:Slot" as Entity

' === MAIN FLOW ===
Lecturer -> UI: Click "Stop Session"
activate UI

UI -> Controller: POST /api/v1/slots/{id}/session/stop
activate Controller

Controller -> Service: stopSession(slotId, currentUserId)
activate Service

' === FIND SLOT ===
Service -> SlotRepo: findById(slotId)
activate SlotRepo
SlotRepo -->> Service: Optional<Slot>
deactivate SlotRepo

alt Slot not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller -->> UI: 404 Not Found
    UI -->> Lecturer: Show error message
end

' === VALIDATION ===
Service -> Service: validateAuthorization(slot, currentUserId)

alt Not authorized
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller -->> UI: 403 Forbidden
    UI -->> Lecturer: Show error message
end

' === CALL PYTHON TO STOP ===
Service -> PythonClient: stopRecognitionSession(slotId)
activate PythonClient
PythonClient -->> Service: PythonSessionResponse
deactivate PythonClient

' === UPDATE SLOT STATUS ===
Service -> Entity: setSessionStatus(STOPPED)\nsetLastSessionStoppedAt(now)
activate Entity
Entity -->> Service: slot
deactivate Entity

Service -> SlotRepo: save(slot)
activate SlotRepo
SlotRepo -->> Service: Slot
deactivate SlotRepo

' === POST-PROCESSING ===
alt INITIAL mode - Auto finalize
    Service -> AttendanceRepo: findBySlotIdAndStatus(slotId, NOT_YET)
    activate AttendanceRepo
    AttendanceRepo -->> Service: List<AttendanceRecord>
    deactivate AttendanceRepo

    Service -> AttendanceRepo: saveAll(records)
    activate AttendanceRepo
    note right: Convert NOT_YET → ABSENT
    AttendanceRepo -->> Service: List<AttendanceRecord>
    deactivate AttendanceRepo
else RESCAN mode - Apply review flags
    Service -> AttendanceService: applyRescanReviewFlags(slot, detectedStudentIds)
    activate AttendanceService
    AttendanceService -->> Service: Map
    deactivate AttendanceService
end

Service -->> Controller: SessionStatusResponse
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> Lecturer: Show session stopped\nwith final results
deactivate UI

@enduml
