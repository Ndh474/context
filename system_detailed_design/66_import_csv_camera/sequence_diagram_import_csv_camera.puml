@startuml import_csv_camera
!theme plain
hide footbox

actor Client
participant ":CameraController" as Controller
participant ":CameraService" as Service
participant ":CsvParserService" as CsvParser
participant ":RoomRepository" as RoomRepo
participant ":CameraRepository" as CameraRepo
participant "Database" as DB

' --- MAIN FLOW ---
Client -> Controller: POST /api/v1/cameras/import
activate Controller

' File validation (internal)

alt File validation fails
    Controller --> Client: 400 Bad Request
end

Controller -> Service: importFromCsv(file, mode)
activate Service

' --- PARSE CSV ---
Service -> CsvParser: parseCameraCsv(file)
activate CsvParser

CsvParser --> Service: List<CameraCsvRow>
deactivate CsvParser

alt CSV parsing fails
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: 400 Bad Request
end

' CSV deduplication (internal)

' --- BATCH PROCESSING LOOP ---
loop For each unique CSV row
    ' Row validation (internal)
    
    alt Validation fails
        Service --> Service: Collect error, continue
    end
    
    ' --- FIND ROOM ---
    Service -> RoomRepo: findByName(roomName)
    activate RoomRepo
    
    RoomRepo -> DB: Query Room by Name
    activate DB
    DB --> RoomRepo: Room / Null
    deactivate DB
    
    RoomRepo --> Service: Room
    deactivate RoomRepo
    
    alt Room not found
        Service --> Service: Collect error, continue
    end
    
    ' --- CHECK EXISTING CAMERA ---
    Service -> CameraRepo: findByName(name)
    activate CameraRepo
    
    CameraRepo -> DB: Query Camera by Name
    activate DB
    DB --> CameraRepo: Camera / Null
    deactivate DB
    
    CameraRepo --> Service: Camera
    deactivate CameraRepo
    
    alt Camera exists
        alt Mode is AddOnly
            Service --> Service: Collect error, continue
        else Mode is AddAndUpdate
            ' Check RTSP URL uniqueness if changed
            opt RTSP URL changed
                Service -> CameraRepo: existsByRtspUrlAndIdNot(rtspUrl, id)
                activate CameraRepo
                
                CameraRepo -> DB: Check RTSP URL Uniqueness
                activate DB
                DB --> CameraRepo: Boolean
                deactivate DB
                
                CameraRepo --> Service: Boolean
                deactivate CameraRepo
                
                alt RTSP URL already exists
                    Service --> Service: Collect error, continue
                end
            end
            
            ' Update existing camera
            Service -> CameraRepo: save(camera)
            activate CameraRepo
            
            CameraRepo -> DB: Update Camera
            activate DB
            DB --> CameraRepo: Updated Camera
            deactivate DB
            
            CameraRepo --> Service: Camera
            deactivate CameraRepo
        end
    else Camera does not exist
        ' Check RTSP URL uniqueness
        Service -> CameraRepo: existsByRtspUrl(rtspUrl)
        activate CameraRepo
        
        CameraRepo -> DB: Check RTSP URL Existence
        activate DB
        DB --> CameraRepo: Boolean
        deactivate DB
        
        CameraRepo --> Service: Boolean
        deactivate CameraRepo
        
        alt RTSP URL already exists
            Service --> Service: Collect error, continue
        end
        
        ' Create new camera
        Service -> CameraRepo: save(newCamera)
        activate CameraRepo
        
        CameraRepo -> DB: Insert New Camera
        activate DB
        DB --> CameraRepo: Saved Camera
        deactivate DB
        
        CameraRepo --> Service: Camera
        deactivate CameraRepo
    end
end

' Build result with success/failure counts (internal)

Service --> Controller: ImportResultDTO
deactivate Service

Controller --> Client: 200 OK
deactivate Controller

@enduml
