@startuml Add Participant to Exam Slot
!theme plain
hide footbox

actor Client
participant ":ExamSlotController" as Controller
participant ":ExamSlotService" as Service
participant ":SlotRepository" as SlotRepo
participant ":ExamSlotParticipantRepository" as ParticipantRepo
participant ":Database" as DB

Client -> Controller: POST /api/v1/exam-slots/{slotId}/participants\n{studentUserId, subjectId}
activate Controller

Controller -> Service: addParticipant(slotId, request)
activate Service

' === Validation: Slot ===
Service -> SlotRepo: findById(slotId)
activate SlotRepo
SlotRepo -> DB: SELECT * FROM slots WHERE id = ?
activate DB
DB --> SlotRepo: slotRecord
deactivate DB
SlotRepo --> Service: slotOpt:Optional<Slot>
deactivate SlotRepo

alt slot invalid (not found, not FINAL_EXAM, or inactive)
    Service -->> Controller: <<throw>> Exception
    Controller --> Client: HTTP 400/404\n{message: "Invalid slot"}
end

note right of Service
Validate:
- Student exists, active, has STUDENT role
- Subject assigned to slot
- Student enrolled in subject
- Student not already in slot
end note

alt any validation fails
    Service -->> Controller: <<throw>> Exception
    Controller --> Client: HTTP 400/404\n{message: "Validation failed"}
end

' === Check Existing Participant ===
Service -> ParticipantRepo: findByExamSlotSubjectIdAndStudentUserId(...)
activate ParticipantRepo
ParticipantRepo -> DB: SELECT * FROM exam_slot_participants\nWHERE exam_slot_subject_id = ? AND student_user_id = ?
activate DB
DB --> ParticipantRepo: participantRecord
deactivate DB
ParticipantRepo --> Service: existingOpt:Optional<ExamSlotParticipant>
deactivate ParticipantRepo

alt existingOpt.isPresent() AND existing.isEnrolled = true
    Service -->> Controller: <<throw>> ResourceExistsException
    Controller --> Client: HTTP 400\n{message: "Already enrolled"}
end

alt existingOpt.isPresent() AND existing.isEnrolled = false
    Service -> Service: existing.setEnrolled(true)
    Service -> ParticipantRepo: save(existing)
    activate ParticipantRepo
    ParticipantRepo -> DB: UPDATE exam_slot_participants\nSET is_enrolled = true WHERE id = ?
    activate DB
    DB --> ParticipantRepo: updatedRecord
    deactivate DB
    ParticipantRepo --> Service: updated:ExamSlotParticipant
    deactivate ParticipantRepo

    Service --> Controller: ExamSlotParticipantDTO
    deactivate Service
    Controller --> Client: HTTP 201 CREATED\n{data: {...}}
    deactivate Controller
end

' === Create New Participant ===
Service -> ParticipantRepo: save(participant)
activate ParticipantRepo
ParticipantRepo -> DB: INSERT INTO exam_slot_participants\n(exam_slot_subject_id, student_user_id, is_enrolled)\nVALUES (?, ?, true)
activate DB
DB --> ParticipantRepo: savedRecord
deactivate DB
ParticipantRepo --> Service: saved:ExamSlotParticipant
deactivate ParticipantRepo

note right of Service
Auto-create ExamAttendance
end note

Service --> Controller: ExamSlotParticipantDTO
deactivate Service

Controller --> Client: HTTP 201 CREATED\n{data: {id, slotId, studentUserId, subjectId, isEnrolled: true}}
deactivate Controller

@enduml
