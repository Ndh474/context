@startuml import_student_photos
!theme plain
hide footbox

actor "Data Operator" as Admin

participant "«user interaction»\n:ImportPhotosDialog" as UI
participant "«control»\n:StudentProfileController" as Controller
participant "«service»\n:BulkPhotoUploadService" as Service
participant "«database wrapper»\n:StudentProfileRepository" as Repository

' --- MAIN FLOW ---
Admin -> UI: Click "Import Photos"
activate UI

UI -> UI: Open import dialog

Admin -> UI: Select CSV & ZIP Files
Admin -> UI: Submit

UI -> Controller: POST /api/v1/student-profiles/bulk-upload-photos-embeddings
activate Controller

Controller -> Service: processBulkUpload(csvFile, zipFile, mode)
activate Service

' Internal: Extract ZIP & Parse CSV
Service -> Service: extractZipAndParseCsv()

alt CSV/ZIP parsing fails
    Service -->> Controller: <<throw>> BadRequestException
    Controller -->> UI: 400 Bad Request
end

' --- PROCESSING LOOP ---
loop For each unique CSV row
    Service -> Repository: findByRollNumber(rollNumber)
    activate Repository
    Repository -->> Service: StudentProfile?
    deactivate Repository
    
    alt Student Found
        ' Internal: Process image -> Upload -> Generate Embedding -> Save
        Service -> Service: processAndSavePhoto(student, image)
    else Not Found
         Service -> Service: Log error (Student not found)
    end
end

Service -->> Controller: ImportResultDTO
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> Admin: Show result summary
deactivate UI

@enduml
