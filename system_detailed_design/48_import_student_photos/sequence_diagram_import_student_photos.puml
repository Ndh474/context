@startuml import_student_photos
!theme plain
hide footbox

actor Admin
participant ":StudentProfileController" as Controller
participant ":BulkPhotoUploadService" as Service
participant ":StudentProfileRepository" as Repository
participant "Database" as DB

' --- MAIN FLOW ---
Admin -> Controller: POST /api/v1/student-profiles/bulk-upload-photos-embeddings
activate Controller

' File validation (internal)

alt File validation fails
    Controller --> Admin: 400 Bad Request
end

Controller -> Service: processBulkUpload(csvFile, zipFile, mode)
activate Service

' Extract ZIP and parse CSV (internal)

alt CSV parsing fails
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Admin: 400 Bad Request
end

' --- PARALLEL PROCESSING LOOP ---
loop For each unique CSV row (parallel)
    Service -> Repository: findByRollNumber(rollNumber)
    activate Repository
    
    Repository -> DB: Query Student by Roll Number
    activate DB
    DB --> Repository: Student / Null
    deactivate DB
    
    Repository --> Service: StudentProfile
    deactivate Repository
    
    ' Validation and processing (internal: image validation, mode check, save photo, generate embedding, save embedding)
    
    alt Processing fails
        Service --> Service: Collect error, continue
    end
end

' Cleanup temp directory (internal)

' Build result with success/failure counts (internal)

Service --> Controller: ImportResultDTO
deactivate Service

Controller --> Admin: 200 OK
deactivate Controller

@enduml
