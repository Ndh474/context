@startuml create_subject
!theme plain
hide footbox

actor Client
participant ":SubjectController" as Controller
participant ":SubjectService" as Service
participant ":SubjectRepository" as SubjectRepo
participant ":MajorRepository" as MajorRepo
participant "Database" as DB

' --- MAIN FLOW ---
Client -> Controller: POST /api/v1/subjects
activate Controller

Controller -> Service: create(request)
activate Service

' --- VALIDATION LOGIC ---
' Validation logic (internal)

alt Validation failed
    Service -->> Controller: <<throw>> ValidationException
    Controller --> Client: 400 Bad Request / 409 Conflict
end

' --- VALIDATE MAJORS ---
Service -> MajorRepo: findByIdIn(majorIds)
activate MajorRepo

MajorRepo -> DB: Query Majors by IDs
activate DB
DB --> MajorRepo: Major List
deactivate DB

MajorRepo --> Service: List<Major>
deactivate MajorRepo

alt Major not found or inactive
    Service -->> Controller: <<throw>> ResourceNotFoundException / OperationNotAllowedException
    Controller --> Client: 404 Not Found / 403 Forbidden
end

' --- SAVE TO DATABASE ---
Service -> SubjectRepo: save(subject)
activate SubjectRepo

SubjectRepo -> DB: Insert New Subject with Majors
activate DB
DB --> SubjectRepo: Saved Subject
deactivate DB

SubjectRepo --> Service: Subject
deactivate SubjectRepo

Service --> Controller: Subject
deactivate Service

Controller --> Client: 201 Created
deactivate Controller

@enduml
