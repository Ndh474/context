@startuml import_csv_semester
!theme plain
hide footbox

actor Client
participant ":SemesterController" as Controller
participant ":SemesterService" as Service
participant ":SemesterRepository" as Repository
participant "Database" as DB

' --- MAIN FLOW ---
Client -> Controller: POST /api/v1/semesters/import
activate Controller

' File validation (internal)

alt File validation fails
    Controller --> Client: 400 Bad Request
end

Controller -> Service: importFromCsv(file, mode)
activate Service

' CSV parsing and validation (internal)

alt CSV parsing fails
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Client: 400 Bad Request
end

' --- BATCH PROCESSING LOOP ---
loop For each unique CSV row
    note right of Service
    Each row processed in
    independent transaction
    (REQUIRES_NEW)
    end note

    ' Row validation (internal)

    alt Row validation fails
        note right of Service
        Collect error
        Continue to next row
        end note
    end

    ' --- CHECK EXISTENCE ---
    Service -> Repository: findByCode(code)
    activate Repository

    Repository -> DB: Query Semester by Code
    activate DB
    DB --> Repository: Semester / Null
    deactivate DB

    Repository --> Service: Optional<Semester>
    deactivate Repository

    ' --- MODE-SPECIFIC LOGIC ---
    alt Mode: AddOnly
        alt Semester exists
            note right of Service
            Collect error: CODE_EXISTS
            Continue to next row
            end note
        else Semester not exists
            ' Validation logic (internal)

            alt Validation fails
                note right of Service
                Collect error
                Continue to next row
                end note
            else Validation passes
                Service -> Repository: save(newSemester)
                activate Repository
                Repository -> DB: Insert New Semester
                activate DB
                DB --> Repository: Saved Semester
                deactivate DB
                Repository --> Service: Semester
                deactivate Repository

                note right of Service
                Increment successCount
                Commit transaction
                end note
            end
        end

    else Mode: AddAndUpdate
        alt Semester exists
            ' Validation logic (internal)

            alt Validation fails
                note right of Service
                Collect error
                Continue to next row
                end note
            else Validation passes
                Service -> Repository: save(updatedSemester)
                activate Repository
                Repository -> DB: Update Existing Semester
                activate DB
                DB --> Repository: Updated Semester
                deactivate DB
                Repository --> Service: Semester
                deactivate Repository

                note right of Service
                Increment successCount
                Commit transaction
                end note
            end

        else Semester not exists
            note right of Service
            Same as AddOnly:
            Create new semester
            after validation
            end note
        end
    end
end

' Build result (internal)

Service --> Controller: Import Result
deactivate Service

Controller --> Client: 200 OK
deactivate Controller

@enduml
