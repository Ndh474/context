@startuml update_class
!theme plain
hide footbox

actor Client
participant ":ClassController" as Controller
participant ":ClassService" as Service
participant ":ClassRepository" as ClassRepo
participant ":SubjectRepository" as SubjectRepo
participant ":SemesterRepository" as SemesterRepo
participant "Database" as DB

' --- MAIN FLOW ---
Client -> Controller: PUT /api/v1/classes/{id}
activate Controller

Controller -> Service: update(id, request)
activate Service

' --- FIND EXISTING ---
Service -> ClassRepo: findById(id)
activate ClassRepo

ClassRepo -> DB: Query Class by ID
activate DB
DB --> ClassRepo: Class Record / Null
deactivate DB

ClassRepo --> Service: Optional<AcademicClass>
deactivate ClassRepo

alt Class not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: 404 Not Found
end

' --- VALIDATION LOGIC ---
' Validation logic (internal)

alt Validation failed
    Service -->> Controller: <<throw>> ValidationException
    Controller --> Client: 400 Bad Request / 409 Conflict
end

' --- VALIDATE SUBJECT ---
Service -> SubjectRepo: findById(subjectId)
activate SubjectRepo

SubjectRepo -> DB: Query Subject by ID
activate DB
DB --> SubjectRepo: Subject / Null
deactivate DB

SubjectRepo --> Service: Optional<Subject>
deactivate SubjectRepo

alt Subject not found or inactive
    Service -->> Controller: <<throw>> ResourceNotFoundException / OperationNotAllowedException
    Controller --> Client: 404 Not Found / 403 Forbidden
end

' --- VALIDATE SEMESTER ---
Service -> SemesterRepo: findById(semesterId)
activate SemesterRepo

SemesterRepo -> DB: Query Semester by ID
activate DB
DB --> SemesterRepo: Semester / Null
deactivate DB

SemesterRepo --> Service: Optional<Semester>
deactivate SemesterRepo

alt Semester not found or inactive
    Service -->> Controller: <<throw>> ResourceNotFoundException / OperationNotAllowedException
    Controller --> Client: 404 Not Found / 403 Forbidden
end

' --- DEACTIVATION CHECK ---
opt Deactivating class
    Service -> ClassRepo: findLastActiveSlotEndTimeByClassId(id)
    activate ClassRepo

    ClassRepo -> DB: Query Last Active Slot End Time
    activate DB
    DB --> ClassRepo: LocalDateTime / Null
    deactivate DB

    ClassRepo --> Service: LocalDateTime
    deactivate ClassRepo

    alt Class not finished
        Service -->> Controller: <<throw>> OperationNotAllowedException
        Controller --> Client: 403 Forbidden
    end
end

' --- UPDATE ---
Service -> ClassRepo: save(class)
activate ClassRepo

ClassRepo -> DB: Update Class
activate DB
DB --> ClassRepo: Updated Class
deactivate DB

ClassRepo --> Service: AcademicClass
deactivate ClassRepo

Service --> Controller: Class
deactivate Service

Controller --> Client: 200 OK
deactivate Controller

@enduml
