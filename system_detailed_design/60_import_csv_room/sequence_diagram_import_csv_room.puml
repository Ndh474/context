@startuml import_csv_room
!theme plain
hide footbox

actor Admin
participant ":RoomController" as Controller
participant ":RoomService" as Service
participant ":CsvParserService" as CsvParser
participant ":RoomRepository" as Repository
participant "Database" as DB

' --- MAIN FLOW ---
Admin -> Controller: POST /api/v1/rooms/import
activate Controller

' File validation (internal)

alt File validation fails
    Controller --> Admin: 400 Bad Request
end

Controller -> Service: importFromCsv(file, mode)
activate Service

' --- PARSE CSV ---
Service -> CsvParser: parseRoomCsv(file)
activate CsvParser

CsvParser --> Service: List<RoomCsvRow>
deactivate CsvParser

alt CSV parsing fails
    Service -->> Controller: <<throw>> BadRequestException
    Controller --> Admin: 400 Bad Request
end

' CSV deduplication (internal)

' --- BATCH PROCESSING LOOP ---
loop For each unique CSV row
    ' Row validation (internal)
    
    alt Validation fails
        Service --> Service: Collect error, continue
    end
    
    ' --- CHECK EXISTING ROOM ---
    Service -> Repository: findByName(name)
    activate Repository
    
    Repository -> DB: Query Room by Name
    activate DB
    DB --> Repository: Room / Null
    deactivate DB
    
    Repository --> Service: Room
    deactivate Repository
    
    alt Room exists
        alt Mode is AddOnly
            Service --> Service: Collect error, continue
        else Mode is AddAndUpdate
            ' Update existing room
            Service -> Repository: save(room)
            activate Repository
            
            Repository -> DB: Update Room
            activate DB
            DB --> Repository: Updated Room
            deactivate DB
            
            Repository --> Service: Room
            deactivate Repository
        end
    else Room does not exist
        ' Create new room
        Service -> Repository: save(newRoom)
        activate Repository
        
        Repository -> DB: Insert New Room
        activate DB
        DB --> Repository: Saved Room
        deactivate DB
        
        Repository --> Service: Room
        deactivate Repository
    end
end

' Build result with success/failure counts (internal)

Service --> Controller: ImportResultDTO
deactivate Service

Controller --> Admin: 200 OK
deactivate Controller

@enduml
