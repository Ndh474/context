@startuml Create Class
!theme plain
hide footbox

actor Client
participant ":ClassController" as Controller
participant ":ClassService" as Service
participant ":ClassRepository" as ClassRepo
participant ":SubjectRepository" as SubjectRepo
participant ":SemesterRepository" as SemesterRepo
participant ":ClassMapper" as ClassMapper
participant ":SemesterMapper" as SemesterMapper
participant ":Database" as DB

Client -> Controller: POST /api/v1/classes\n{code, subjectId, semesterId}
activate Controller

Controller -> Service: create(request)
activate Service

' === Validation 1: Unique Constraint ===
Service -> ClassRepo: existsByCodeAndSubjectIdAndSemesterId(code, subjectId, semesterId)
activate ClassRepo

ClassRepo -> DB: SELECT EXISTS(SELECT 1 FROM classes\nWHERE code = ? AND subject_id = ? AND semester_id = ?)
activate DB
DB --> ClassRepo: exists
deactivate DB

ClassRepo --> Service: exists:boolean
deactivate ClassRepo

alt exists = true
    Service -->> Controller: <<throw>> ResourceExistsException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Class already exists with subject, semester, and code",\ncode: "CLASS_EXISTS"}
end

' === Validation 2: Subject Exists ===
Service -> SubjectRepo: findById(subjectId)
activate SubjectRepo

SubjectRepo -> DB: SELECT * FROM subjects\nWHERE id = ?
activate DB
DB --> SubjectRepo: subjectRecord
deactivate DB

SubjectRepo --> Service: subjectOpt:Optional<Subject>
deactivate SubjectRepo

alt subjectOpt.isEmpty()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Subject not found: {subjectId}",\ncode: "SUBJECT_NOT_FOUND"}
end

Service -> Service: subject = subjectOpt.get()

' === Validation 3: Semester Exists ===
Service -> SemesterRepo: findById(semesterId)
activate SemesterRepo

SemesterRepo -> DB: SELECT * FROM semesters\nWHERE id = ?
activate DB
DB --> SemesterRepo: semesterRecord
deactivate DB

SemesterRepo --> Service: semesterOpt:Optional<Semester>
deactivate SemesterRepo

alt semesterOpt.isEmpty()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Semester not found: {semesterId}",\ncode: "SEMESTER_NOT_FOUND"}
end

Service -> Service: semester = semesterOpt.get()

' === Validation 4: Active References ===
opt !subject.isActive || !semester.isActive
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Cannot create class with inactive subject or semester",\ncode: "INACTIVE_REFERENCE_NOT_ALLOWED"}
end

' === Map DTO to Entity ===
Service -> ClassMapper: toEntity(request)
activate ClassMapper
ClassMapper --> Service: academicClass:AcademicClass
deactivate ClassMapper

' === Set Relationships ===
Service -> Service: academicClass.setSubject(subject)
Service -> Service: academicClass.setSemester(semester)
Service -> Service: academicClass.setActive(true)

' === Save to Database ===
Service -> ClassRepo: save(academicClass)
activate ClassRepo

ClassRepo -> DB: INSERT INTO classes\n(code, subject_id, semester_id, is_active, created_at, updated_at)\nVALUES (?, ?, ?, true, NOW(), NOW())\nRETURNING *
activate DB
DB --> ClassRepo: savedRecord
deactivate DB

ClassRepo --> Service: savedClass:AcademicClass
deactivate ClassRepo

' === Map Entity to DTO ===
Service -> ClassMapper: toDTO(savedClass)
activate ClassMapper
ClassMapper --> Service: classDTO:ClassDTO
deactivate ClassMapper

' === Map Semester to DTO ===
Service -> SemesterMapper: toDTO(semester)
activate SemesterMapper
SemesterMapper --> Service: semesterDTO:SemesterDTO
deactivate SemesterMapper

Service -> Service: classDTO.setSemester(semesterDTO)

' === Create SubjectDTO ===
Service -> Service: subjectDTO = new SubjectDTO()
Service -> Service: subjectDTO.setId(subject.getId())
Service -> Service: subjectDTO.setName(subject.getName())
Service -> Service: subjectDTO.setCode(subject.getCode())
Service -> Service: subjectDTO.setActive(subject.getActive())
Service -> Service: classDTO.setSubject(subjectDTO)

Service --> Controller: ClassDTO
deactivate Service

Controller --> Client: HTTP 201 CREATED\n{status: 201,\ndata: {\n  id: 1,\n  code: "SE01",\n  subject: {\n    id: 1,\n    name: "Software Engineering",\n    code: "SE",\n    isActive: true\n  },\n  semester: {\n    id: 1,\n    name: "Fall 2024",\n    code: "FA2024",\n    startDate: "2024-09-01",\n    endDate: "2024-12-31",\n    isActive: true\n  },\n  isActive: true,\n  createdAt: "2024-11-19T15:30:00Z"\n}}
deactivate Controller

@enduml
