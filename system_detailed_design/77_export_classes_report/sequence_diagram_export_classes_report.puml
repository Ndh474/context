@startuml export_classes_report
!theme plain
hide footbox

actor "Data Operator" as Admin

participant "«user interaction»\n:AdminExportDialog" as UI
participant "«control»\n:ExportController" as Controller
participant "«service»\n:ExportService" as Service
participant "«database wrapper»\n:ClassRepository" as ClassRepo
participant "«database wrapper»\n:SlotRepository" as SlotRepo
participant "«database wrapper»\n:EnrollmentRepository" as EnrollmentRepo
participant "«database wrapper»\n:AttendanceRecordRepository" as AttendanceRepo

' === MAIN FLOW ===
Admin -> UI: Select classes & click Export
activate UI

UI -> Controller: POST /api/v1/export/classes/excel
activate Controller

Controller -> Service: exportClassesToExcel(request)
activate Service

' === GET CLASSES ===
alt Export all classes in semester
    Service -> ClassRepo: findAll()
    activate ClassRepo
    ClassRepo -->> Service: List<AcademicClass>
    deactivate ClassRepo
else Export specific classes
    Service -> ClassRepo: findAllById(ids)
    activate ClassRepo
    ClassRepo -->> Service: List<AcademicClass>
    deactivate ClassRepo
end

' === BUILD ATTENDANCE MATRIX FOR EACH CLASS ===
loop For each class
    Service -> SlotRepo: findByClassId(classId)
    activate SlotRepo
    SlotRepo -->> Service: List<Slot>
    deactivate SlotRepo

    Service -> EnrollmentRepo: findAllByAcademicClassId(classId)
    activate EnrollmentRepo
    EnrollmentRepo -->> Service: List<Enrollment>
    deactivate EnrollmentRepo

    loop For each student-slot pair
        Service -> AttendanceRepo: findBySlotIdAndStudentUserId(slotId, studentId)
        activate AttendanceRepo
        AttendanceRepo -->> Service: AttendanceRecord
        deactivate AttendanceRepo
    end
end

Service -> Service: generateExcelWorkbook()
note right: Create overview sheet\nand detail sheets per class

Service -->> Controller: ByteArrayOutputStream
deactivate Service

Controller -->> UI: 200 OK (Excel file)
deactivate Controller

UI -->> Admin: Download Excel file
deactivate UI

@enduml
