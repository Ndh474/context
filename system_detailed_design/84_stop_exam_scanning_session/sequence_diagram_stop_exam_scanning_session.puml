@startuml stop_exam_scanning_session
!theme plain
hide footbox

actor Supervisor
participant ":SlotController" as Controller
participant ":SlotSessionService" as Service
participant ":SlotRepository" as SlotRepo
participant ":ExamAttendanceRepository" as ExamAttendanceRepo
participant ":PythonBackendClient" as PythonClient
participant "Recognition Service" as RecognitionService

' --- MAIN FLOW ---
Supervisor -> Controller: POST /api/v1/slots/{id}/exam-session/stop
activate Controller

Controller -> Service: stopExamSession(slotId, currentUserId)
activate Service

Service -> SlotRepo: findById(slotId)
activate SlotRepo

SlotRepo --> Service: Optional<Slot>
deactivate SlotRepo

alt Slot not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Supervisor: 404 Not Found
end

' Validation logic (internal: authorization)

alt Not authorized
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Supervisor: 403 Forbidden
end

' Call Python to stop exam session
Service -> PythonClient: stopRecognitionSession(slotId)
activate PythonClient

PythonClient -> RecognitionService: POST /api/v1/sessions/{slotId}/stop
activate RecognitionService

RecognitionService --> PythonClient: SessionDataDTO
deactivate RecognitionService

PythonClient --> Service: PythonSessionResponse
deactivate PythonClient

' Update slot exam session status
Service -> SlotRepo: save(slot)
activate SlotRepo

SlotRepo --> Service: Slot
deactivate SlotRepo

' Post-processing based on mode (internal: INITIAL → auto-finalize NOT_YET to ABSENT, RESCAN → apply review flags)

opt INITIAL mode
    Service -> ExamAttendanceRepo: findBySlotIdAndStatus(slotId, NOT_YET)
    activate ExamAttendanceRepo
    
    ExamAttendanceRepo --> Service: List<ExamAttendance>
    deactivate ExamAttendanceRepo
    
    Service -> ExamAttendanceRepo: saveAll(records)
    activate ExamAttendanceRepo
    
    ExamAttendanceRepo --> Service: List<ExamAttendance>
    deactivate ExamAttendanceRepo
end

Service --> Controller: SessionStatusResponse
deactivate Service

Controller --> Supervisor: 200 OK
deactivate Controller

@enduml
