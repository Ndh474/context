@startuml Sign In with Google
!theme plain
hide footbox

actor Client
participant ":AuthenticationController" as Controller
participant ":AuthenticationService" as Service
participant ":GoogleIdTokenVerifier" as GoogleVerifier
participant ":UserRepository" as Repository
participant ":TokenProviderUtil" as TokenProvider
participant "Database" as DB

Client -> Controller: POST /api/v1/auth/google/login\n{token: "<Google_ID_Token>"}
activate Controller

Controller -> Service: googleLogin(request)
activate Service

Service -> Service: new GoogleIdTokenVerifier.Builder(...)\n.setAudience(googleClientId)\n.build()

Service -> GoogleVerifier: verify(request.getToken())
activate GoogleVerifier
GoogleVerifier --> Service: idToken:GoogleIdToken
deactivate GoogleVerifier

alt idToken == null
    Service -->> Controller: <<throw>> InvalidBearerTokenException
    Controller --> Client: HTTP 401\n{status, message, code}
end

Service -> Service: idToken.getPayload().getEmail()

alt email.isBlank()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status, message, code:\nEMAIL_NOT_FOUND}
end

Service -> Repository: findByEmail(email)
activate Repository

Repository -> DB: SELECT * FROM users\nWHERE email = ?
activate DB
DB --> Repository: userRecord
deactivate DB

Repository --> Service: userOpt:Optional<User>
deactivate Repository

alt userOpt.isEmpty()
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status, message, code:\nEMAIL_NOT_FOUND}
end

opt !user.isActive
    Service -->> Controller: <<throw>> AccessDeniedException
    Controller --> Client: HTTP 403\n{status, message, code}
end

Service -> Service: buildTokenResponse(user)
activate Service

Service -> Service: extract roles and permissions

Service -> TokenProvider: createAccessToken(user, permissions)
activate TokenProvider
TokenProvider --> Service: accessToken:String
deactivate TokenProvider

Service -> TokenProvider: createRefreshToken(userId)
activate TokenProvider
TokenProvider --> Service: refreshToken:String
deactivate TokenProvider

Service -> Service: new TokenResponse(...)
deactivate Service

Service --> Controller: TokenResponse
deactivate Service

Controller --> Client: HTTP 200 OK\n{accessToken, refreshToken,\ntokenType, fullName, username,\nroles, userId}
deactivate Controller

@enduml
