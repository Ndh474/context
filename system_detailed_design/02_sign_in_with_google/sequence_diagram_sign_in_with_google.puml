@startuml sign_in_with_google
!theme plain
hide footbox

actor User

participant "«user interaction»\n:LoginPage" as UI
participant "«control»\n:AuthenticationController" as Controller
participant "«service»\n:AuthenticationService" as Service
participant "«database wrapper»\n:UserRepository" as Repository

' === MAIN FLOW ===
User -> UI: Click "Sign in with Google"
activate UI

UI -> UI: Open Google OAuth popup

User -> UI: Select Google account & authorize

UI -> Controller: POST /api/v1/auth/google/login\n(idToken)
activate Controller

Controller -> Service: googleLogin(request)
activate Service

' === GOOGLE TOKEN VERIFICATION (internal) ===

alt Invalid Google token
    Service -->> Controller: <<throw>> InvalidBearerTokenException
    Controller -->> UI: 401 Unauthorized
    UI -->> User: Show error message
end

alt Email not found in token
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller -->> UI: 404 Not Found
    UI -->> User: Show error message
end

' === USER LOOKUP ===
Service -> Repository: findByEmail(email)
activate Repository
Repository -->> Service: Optional<User>
deactivate Repository

alt User not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller -->> UI: 404 Not Found
    UI -->> User: Show error message\n"Account not registered"
end

alt User is inactive
    Service -->> Controller: <<throw>> AccessDeniedException
    Controller -->> UI: 403 Forbidden
    UI -->> User: Show error message
end

' === TOKEN GENERATION (internal) ===

Service -->> Controller: TokenResponse
deactivate Service

Controller -->> UI: 200 OK (TokenResponse)
deactivate Controller

UI -->> User: Redirect to Dashboard
deactivate UI

@enduml
