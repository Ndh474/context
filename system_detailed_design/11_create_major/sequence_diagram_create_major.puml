@startuml Create Major
!theme plain
hide footbox

actor Client
participant ":MajorController" as Controller
participant ":MajorService" as Service
participant ":MajorRepository" as Repository
participant ":MajorMapper" as Mapper
participant ":Database" as DB

Client -> Controller: POST /api/v1/majors\n{name, code}
activate Controller

Controller -> Service: create(request)
activate Service

' === Validation 1: Code Uniqueness ===
Service -> Repository: existsByCode(code)
activate Repository

Repository -> DB: SELECT COUNT(*) > 0 FROM majors\nWHERE code = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: exists:boolean
deactivate Repository

alt exists = true
    Service -->> Controller: <<throw>> ResourceExistsException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Major code already exists: {code}",\ncode: "MAJOR_CODE_EXISTS"}
end

' === Validation 2: Name Uniqueness ===
Service -> Repository: existsByName(name)
activate Repository

Repository -> DB: SELECT COUNT(*) > 0 FROM majors\nWHERE name = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: exists:boolean
deactivate Repository

alt exists = true
    Service -->> Controller: <<throw>> ResourceExistsException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Major name already exists: {name}",\ncode: "MAJOR_NAME_EXISTS"}
end

' === Map DTO to Entity ===
Service -> Mapper: toEntity(request)
activate Mapper
Mapper --> Service: major:Major
deactivate Mapper

' === Save to Database ===
Service -> Repository: save(major)
activate Repository

Repository -> DB: INSERT INTO majors\n(name, code, is_active, created_at, updated_at)\nVALUES (?, ?, true, NOW(), NOW())\nRETURNING *
activate DB
DB --> Repository: savedRecord
deactivate DB

Repository --> Service: saved:Major
deactivate Repository

' === Map Entity to DTO ===
Service -> Mapper: toDTO(saved)
activate Mapper
Mapper --> Service: dto:MajorDTO
deactivate Mapper

Service --> Controller: MajorDTO
deactivate Service

Controller --> Client: HTTP 201 CREATED\n{status: 201,\ndata: {\n  id: 1,\n  name: "Computer Science",\n  code: "CS",\n  totalSubject: 0,\n  isActive: true,\n  createdAt: "2024-11-17T10:30:00Z"\n}}
deactivate Controller

@enduml
