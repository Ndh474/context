@startuml reset_password
!theme plain
hide footbox

actor User

participant "«user interaction»\n:ResetPasswordPage" as UI
participant "«control»\n:AuthenticationController" as Controller
participant "«service»\n:AuthenticationService" as Service
participant "«database wrapper»\n:PasswordResetTokenRepository" as TokenRepo
participant "«database wrapper»\n:UserRepository" as UserRepo
participant "«entity»\n:User" as Entity

' === MAIN FLOW ===
User -> UI: Click reset link from email
activate UI

UI -> UI: Extract token from URL

User -> UI: Enter new password & confirm password

User -> UI: Click "Reset Password"
UI -> Controller: POST /api/v1/auth/reset-password
activate Controller

Controller -> Service: resetPassword(request)
activate Service

' === INPUT VALIDATION ===
alt Passwords do not match
    Service -->> Controller: <<throw>> IllegalArgumentException
    Controller -->> UI: 400 Bad Request
    UI -->> User: Show error message
end

' === TOKEN VERIFICATION ===
Service -> TokenRepo: findByTokenHash(token)
activate TokenRepo
TokenRepo -->> Service: Optional<PasswordResetToken>
deactivate TokenRepo

alt Token not found or expired
    Service -->> Controller: <<throw>> IllegalArgumentException
    Controller -->> UI: 400 Bad Request
    UI -->> User: Show error message\n"Invalid or expired token"
end

' === USER LOOKUP ===
Service -> UserRepo: findByEmail(email)
activate UserRepo
UserRepo -->> Service: Optional<User>
deactivate UserRepo

alt User not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller -->> UI: 404 Not Found
    UI -->> User: Show error message
end

alt User is inactive
    Service -->> Controller: <<throw>> AccessDeniedException
    Controller -->> UI: 403 Forbidden
    UI -->> User: Show error message
end

' === UPDATE PASSWORD ===
Service -> Entity: setPassword(encodedPassword)
activate Entity
Entity -->> Service: user
deactivate Entity

Service -> UserRepo: save(user)
activate UserRepo
UserRepo -->> Service: savedUser
deactivate UserRepo

' === TOKEN CLEANUP ===
Service -> TokenRepo: delete(resetToken)
activate TokenRepo
TokenRepo -->> Service: void
deactivate TokenRepo

Service -->> Controller: Success Message
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> User: Show success message\nRedirect to Login page
deactivate UI

@enduml
