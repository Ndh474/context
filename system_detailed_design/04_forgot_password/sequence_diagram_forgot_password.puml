@startuml forgot_password
!theme plain
hide footbox

actor User

participant "«user interaction»\n:ForgotPasswordPage" as UI
participant "«control»\n:AuthenticationController" as Controller
participant "«service»\n:AuthenticationService" as Service
participant "«database wrapper»\n:UserRepository" as UserRepo
participant "«database wrapper»\n:PasswordResetTokenRepository" as TokenRepo
participant "«entity»\n:PasswordResetToken" as Entity

' === MAIN FLOW ===
User -> UI: Navigate to Forgot Password page
activate UI

User -> UI: Enter email address

User -> UI: Click "Send Reset Link"
UI -> Controller: POST /api/v1/auth/forgot-password
activate Controller

Controller -> Service: forgotPassword(request)
activate Service

' === USER LOOKUP ===
Service -> UserRepo: findByEmail(email)
activate UserRepo
UserRepo -->> Service: Optional<User>
deactivate UserRepo

alt User not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller -->> UI: 404 Not Found
    UI -->> User: Show error message
end

alt User is inactive
    Service -->> Controller: <<throw>> AccessDeniedException
    Controller -->> UI: 403 Forbidden
    UI -->> User: Show error message
end

' === TOKEN GENERATION & STORAGE ===
Service -> TokenRepo: updateToken(email, token, now, expiry)
activate TokenRepo
TokenRepo -->> Service: affectedRows
deactivate TokenRepo

alt Token does not exist (affectedRows = 0)
    Service -> Entity: new PasswordResetToken(email, token, expiry)
    activate Entity
    Entity -->> Service: resetToken
    deactivate Entity

    Service -> TokenRepo: save(resetToken)
    activate TokenRepo
    TokenRepo -->> Service: savedToken
    deactivate TokenRepo
end

' === SEND EMAIL (internal) ===

Service -->> Controller: Success Message
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> User: Show success message\n"Check your email"
deactivate UI

@enduml
