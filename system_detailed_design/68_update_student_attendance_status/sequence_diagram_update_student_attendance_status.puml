@startuml update_student_attendance_status
!theme plain
hide footbox

actor "Lecturer" as Lecturer

participant "«user interaction»\n:SessionControls" as UI
participant "«control»\n:SlotController" as Controller
participant "«service»\n:SlotService" as Service
participant "«database wrapper»\n:SlotRepository" as SlotRepo
participant "«database wrapper»\n:AttendanceRecordRepository" as AttendanceRepo
participant "«entity»\n:AttendanceRecord" as Entity

' === MAIN FLOW ===
Lecturer -> UI: Edit attendance status\n(present/absent/not_yet)
activate UI

Lecturer -> UI: Click "Submit Attendance"
UI -> Controller: POST /api/v1/slots/{id}/submit-attendance
activate Controller

Controller -> Service: submitAttendance(slotId, request, currentUserId)
activate Service

' === VALIDATE SLOT ===
Service -> SlotRepo: findById(slotId)
activate SlotRepo
SlotRepo -->> Service: Optional<Slot>
deactivate SlotRepo

alt Slot not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller -->> UI: 404 Not Found
    UI -->> Lecturer: Show error message
end

' === CHECK AUTHORIZATION ===
Service -> Service: checkAuthorization(slot, currentUserId)
note right: Verify assigned staff or data operator

alt Not authorized
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller -->> UI: 403 Forbidden
    UI -->> Lecturer: Show error message
end

' === CHECK EDIT WINDOW ===
Service -> Service: checkEditWindow(slot)
note right: Verify slot has started

alt Before slot start time
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller -->> UI: 403 Forbidden
    UI -->> Lecturer: Show error message
end

' === PROCESS SUBMISSIONS ===
loop For each submission in request
    Service -> Entity: updateStatus(status, remark)
    activate Entity
    Entity -->> Service: attendanceRecord
    deactivate Entity

    Service -> AttendanceRepo: save(attendanceRecord)
    activate AttendanceRepo
    AttendanceRepo -->> Service: savedRecord
    deactivate AttendanceRepo
end

' === HANDLE NOT_YET RESOLUTION ===
opt notYetResolution provided
    Service -> AttendanceRepo: findBySlotIdAndNeedsReview(slotId, true)
    activate AttendanceRepo
    AttendanceRepo -->> Service: List<AttendanceRecord>
    deactivate AttendanceRepo

    Service -> AttendanceRepo: saveAll(updatedRecords)
    activate AttendanceRepo
    AttendanceRepo -->> Service: List<AttendanceRecord>
    deactivate AttendanceRepo
end

Service -->> Controller: SlotAttendanceSubmissionResponse
deactivate Service

Controller -->> UI: 200 OK
deactivate Controller

UI -->> Lecturer: Show success message\nRefresh roster
deactivate UI

@enduml
