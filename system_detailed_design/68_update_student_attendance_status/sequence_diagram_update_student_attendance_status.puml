@startuml update_student_attendance_status
!theme plain
hide footbox

actor Lecturer
participant ":SlotController" as Controller
participant ":SlotService" as Service
participant ":SlotRepository" as SlotRepo
participant ":AttendanceRecordRepository" as AttendanceRepo
participant "Database" as DB

' --- MAIN FLOW ---
Lecturer -> Controller: POST /api/v1/slots/{id}/submit-attendance
activate Controller

Controller -> Service: submitAttendance(id, request, currentUserId)
activate Service

' --- VALIDATE SLOT ---
Service -> SlotRepo: findById(id)
activate SlotRepo

SlotRepo -> DB: Query Slot by ID
activate DB
DB --> SlotRepo: Slot Record / Null
deactivate DB

SlotRepo --> Service: Optional<Slot>
deactivate SlotRepo

alt Slot not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Lecturer: 404 Not Found
end

' Validation logic (internal: authorization, edit window check)

alt Validation failed
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Lecturer: 403 Forbidden
end

' Process submissions loop (internal: update attendance records, handle NOT_YET resolution, clear needs review flags)

Service -> AttendanceRepo: save(attendanceRecord)
activate AttendanceRepo

AttendanceRepo -> DB: Update Attendance Record
activate DB
DB --> AttendanceRepo: Updated Record
deactivate DB

AttendanceRepo --> Service: AttendanceRecord
deactivate AttendanceRepo

Service --> Controller: SlotAttendanceSubmissionResponse
deactivate Service

Controller --> Lecturer: 200 OK
deactivate Controller

@enduml
