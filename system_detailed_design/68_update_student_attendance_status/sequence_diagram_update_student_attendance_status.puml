@startuml update_student_attendance_status
!theme plain
hide footbox

actor Lecturer
participant ":SlotController" as Controller
participant ":SlotService" as Service
participant ":SlotRepository" as SlotRepo
participant ":UserRepository" as UserRepo
participant ":AttendanceRecordRepository" as AttendanceRepo
participant "Database" as DB

' --- MAIN FLOW ---
Lecturer -> Controller: POST /api/v1/slots/{id}/submit-attendance
activate Controller

Controller -> Service: submitAttendance(id, request, currentUserId)
activate Service

' --- VALIDATE SLOT ---
Service -> SlotRepo: findById(id)
activate SlotRepo

SlotRepo -> DB: Query Slot by ID
activate DB
DB --> SlotRepo: Slot Record / Null
deactivate DB

SlotRepo --> Service: Optional<Slot>
deactivate SlotRepo

alt Slot not found
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Lecturer: 404 Not Found
end

' --- VALIDATION LOGIC ---
' Validation logic (internal)

alt Not authorized
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Lecturer: 403 Forbidden
end

alt Edit window expired
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Lecturer: 403 Forbidden
end

' --- GET CURRENT USER ---
Service -> UserRepo: findById(currentUserId)
activate UserRepo

UserRepo -> DB: Query User by ID
activate DB
DB --> UserRepo: User Record / Null
deactivate DB

UserRepo --> Service: Optional<User>
deactivate UserRepo

' --- PROCESS SUBMISSIONS LOOP ---
loop For each submission
    ' Process single submission (internal)
    
    Service -> AttendanceRepo: save(attendanceRecord)
    activate AttendanceRepo
    
    AttendanceRepo -> DB: Update Attendance Record
    activate DB
    DB --> AttendanceRepo: Updated Record
    deactivate DB
    
    AttendanceRepo --> Service: AttendanceRecord
    deactivate AttendanceRepo
end

' --- HANDLE NOT YET RESOLUTION ---
opt notYetResolution provided
    ' Bulk convert NOT_YET students (internal)
    
    Service -> AttendanceRepo: saveAll(records)
    activate AttendanceRepo
    
    AttendanceRepo -> DB: Batch Update Records
    activate DB
    DB --> AttendanceRepo: Updated Records
    deactivate DB
    
    AttendanceRepo --> Service: List<AttendanceRecord>
    deactivate AttendanceRepo
end

' --- CLEAR NEEDS REVIEW FLAGS ---
Service -> AttendanceRepo: findBySlotIdAndNeedsReview(id, true)
activate AttendanceRepo

AttendanceRepo -> DB: Query Records with Needs Review
activate DB
DB --> AttendanceRepo: Records List
deactivate DB

AttendanceRepo --> Service: List<AttendanceRecord>
deactivate AttendanceRepo

Service -> AttendanceRepo: saveAll(records)
activate AttendanceRepo

AttendanceRepo -> DB: Clear Needs Review Flags
activate DB
DB --> AttendanceRepo: Success
deactivate DB

AttendanceRepo --> Service: void
deactivate AttendanceRepo

Service --> Controller: SlotAttendanceSubmissionResponse
deactivate Service

Controller --> Lecturer: 200 OK
deactivate Controller

@enduml
