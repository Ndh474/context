@startuml Delete Subject
!theme plain
hide footbox

actor Client
participant ":SubjectController" as Controller
participant ":SubjectService" as Service
participant ":SubjectRepository" as Repository
participant "Database" as DB

Client -> Controller: DELETE /api/v1/subjects/1
activate Controller

Controller -> Service: delete(id)
activate Service

' === Validation 1: Check Existence ===
Service -> Repository: existsById(id)
activate Repository

Repository -> DB: SELECT COUNT(*) > 0 FROM subjects\nWHERE id = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: exists:boolean
deactivate Repository

alt !exists
    Service -->> Controller: <<throw>> ResourceNotFoundException
    Controller --> Client: HTTP 404\n{status: 404,\nmessage: "Subject not found: 1",\ncode: "SUBJECT_NOT_FOUND"}
end

' === Validation 2: Check Classes ===
Service -> Repository: countAllClassesBySubjectId(id)
activate Repository

Repository -> DB: SELECT COUNT(id) FROM academic_classes\nWHERE subject_id = ?
activate DB
DB --> Repository: count
deactivate DB

Repository --> Service: totalClasses:long
deactivate Repository

alt totalClasses > 0
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Cannot delete subject. Found {count} classes. Please delete them first",\ncode: "SUBJECT_HAS_DEPENDENCIES"}
end

' === Validation 3: Delete with Foreign Key Constraint Handling ===
Service -> Repository: deleteById(id)
activate Repository

Repository -> DB: DELETE FROM subject_majors\nWHERE subject_id = ?
activate DB
DB --> Repository
deactivate DB

Repository -> DB: DELETE FROM subjects\nWHERE id = ?
activate DB

alt foreign key constraint violation
    DB -->> Repository: <<throw>> DataIntegrityViolationException
    Repository -->> Service: <<throw>> DataIntegrityViolationException
    deactivate Repository
    Service -->> Controller: <<throw>> OperationNotAllowedException
    Controller --> Client: HTTP 400\n{status: 400,\nmessage: "Cannot delete subject due to existing dependencies",\ncode: "SUBJECT_HAS_DEPENDENCIES"}
end

DB --> Repository
deactivate DB

Repository --> Service
deactivate Repository

Service --> Controller
deactivate Service

Controller --> Client: HTTP 200 OK\n{status: 200,\nmessage: "Delete subject successfully",\ncode: null,\ndata: null}
deactivate Controller

@enduml
