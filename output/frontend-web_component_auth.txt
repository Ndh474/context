{
  "metadata": {
    "codebase": "frontend-web",
    "category": "component_auth",
    "generated_at": "2025-12-03T21:12:52.239539",
    "total_files": 4,
    "total_lines": 601,
    "total_bytes": 17235
  },
  "files": [
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\components\\auth\\login-form.tsx",
      "relative_path": "components/auth/login-form.tsx",
      "filename": "login-form.tsx",
      "size_bytes": 5347,
      "lines": 177,
      "last_modified": "2025-11-28T09:21:56.241586",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport * as React from \"react\";\nimport Link from \"next/link\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useForm } from \"react-hook-form\";\nimport { useRouter } from \"next/navigation\";\nimport { z } from \"zod\";\nimport { GoogleLogin, type CredentialResponse } from \"@react-oauth/google\";\nimport { toast } from \"sonner\";\n\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useLogin, useGoogleLogin } from \"@/hooks/api/useAuth\";\nimport { getRoleBasedRedirectPath } from \"@/lib/auth\";\nimport { loginRequestSchema } from \"@/lib/zod-schemas\";\nimport type { LoginRequest } from \"@/types\";\n\nconst formSchema = loginRequestSchema;\n\ntype LoginFormValues = z.infer<typeof formSchema>;\n\ntype LoginError = {\n  status: number;\n  toastMessage: string;\n};\n\nexport function LoginForm(): React.JSX.Element {\n  const router = useRouter();\n  const loginMutation = useLogin();\n  const googleLoginMutation = useGoogleLogin();\n\n  const form = useForm<LoginFormValues>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      username: \"\",\n      password: \"\",\n    },\n  });\n\n  const onSubmit = async (values: LoginFormValues) => {\n    form.clearErrors();\n    try {\n      // Convert username to lowercase before sending\n      const response = await loginMutation.mutateAsync({\n        username: values.username.toLowerCase(),\n        password: values.password,\n      } as LoginRequest);\n      // Redirect based on user roles\n      const redirectPath = getRoleBasedRedirectPath(response.roles);\n      router.push(redirectPath);\n    } catch (error) {\n      const mapped = error as LoginError;\n      if (mapped?.status) {\n        form.setError(\"username\", { type: \"manual\" });\n        form.setError(\"password\", { type: \"manual\" });\n      }\n    }\n  };\n\n  const handleGoogleSuccess = React.useCallback(\n    (credentialResponse: CredentialResponse) => {\n      const credential = credentialResponse.credential;\n      if (!credential) {\n        toast.error(\"Google authentication failed. Please try again.\");\n        return;\n      }\n\n      googleLoginMutation.mutate(credential, {\n        onSuccess: (response) => {\n          // Redirect based on user roles\n          const redirectPath = getRoleBasedRedirectPath(response.roles);\n          router.push(redirectPath);\n        },\n      });\n    },\n    [googleLoginMutation, router]\n  );\n\n  const handleGoogleError = React.useCallback(() => {\n    toast.error(\"Google authentication was canceled or failed.\");\n  }, []);\n\n  const isSubmitting =\n    form.formState.isSubmitting ||\n    loginMutation.isPending ||\n    googleLoginMutation.isPending;\n\n  return (\n    <Form {...form}>\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n        <FormField\n          control={form.control}\n          name=\"username\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Username</FormLabel>\n              <FormControl>\n                <Input\n                  placeholder=\"Enter your username\"\n                  autoComplete=\"username\"\n                  aria-invalid={!!form.formState.errors.username}\n                  {...field}\n                />\n              </FormControl>\n            </FormItem>\n          )}\n        />\n\n        <FormField\n          control={form.control}\n          name=\"password\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Password</FormLabel>\n              <FormControl>\n                <Input\n                  type=\"password\"\n                  placeholder=\"Enter your password\"\n                  autoComplete=\"current-password\"\n                  aria-invalid={!!form.formState.errors.password}\n                  {...field}\n                />\n              </FormControl>\n            </FormItem>\n          )}\n        />\n\n        <div className=\"text-right text-sm -mt-2 mb-4\">\n          <Button\n            variant=\"link\"\n            asChild\n            className=\"h-auto p-0 text-sm font-medium\"\n          >\n            <Link href=\"/forgot-password\">Forgot password?</Link>\n          </Button>\n        </div>\n\n        <Button type=\"submit\" className=\"w-full\" disabled={isSubmitting}>\n          {isSubmitting ? \"Signing in...\" : \"Sign in\"}\n        </Button>\n\n        <div className=\"relative flex items-center gap-3 text-xs text-muted-foreground\">\n          <Separator className=\"flex-1\" />\n          <span>Or continue with</span>\n          <Separator className=\"flex-1\" />\n        </div>\n\n        <div\n          className=\"flex justify-center\"\n          style={\n            googleLoginMutation.isPending\n              ? { pointerEvents: \"none\", opacity: 0.6 }\n              : undefined\n          }\n        >\n          <GoogleLogin\n            onSuccess={handleGoogleSuccess}\n            onError={handleGoogleError}\n            text=\"continue_with\"\n            shape=\"pill\"\n            theme=\"filled_blue\"\n            width=\"100%\"\n          />\n        </div>\n      </form>\n    </Form>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\components\\auth\\permission-gate.tsx",
      "relative_path": "components/auth/permission-gate.tsx",
      "filename": "permission-gate.tsx",
      "size_bytes": 6107,
      "lines": 225,
      "last_modified": "2025-11-28T09:21:56.241586",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useTranslations } from \"next-intl\";\nimport {\n  usePermissionChecker,\n  type Permission,\n} from \"@/lib/permissions\";\n\n/**\n * PermissionGate Component\n *\n * Conditionally renders children based on user permissions.\n *\n * Features:\n * - Single permission check: permission=\"USER_CREATE\"\n * - Multiple permissions (ANY): permissions={['USER_CREATE', 'USER_UPDATE']} requireAll={false}\n * - Multiple permissions (ALL): permissions={['USER_READ_LIST', 'USER_READ_DETAIL']} requireAll={true}\n * - Custom fallback UI when permission check fails\n * - Automatic null render when no fallback provided\n *\n * @example\n * // Hide button if user lacks permission\n * <PermissionGate permission=\"USER_CREATE\">\n *   <Button>Create User</Button>\n * </PermissionGate>\n *\n * @example\n * // Show custom fallback message\n * <PermissionGate\n *   permission=\"REPORT_EXPORT_ACADEMIC_DATA\"\n *   fallback={<p className=\"text-muted-foreground\">Contact admin for export access</p>}\n * >\n *   <Button>Export Data</Button>\n * </PermissionGate>\n *\n * @example\n * // Require ANY of multiple permissions\n * <PermissionGate permissions={['USER_CREATE', 'USER_UPDATE']} requireAll={false}>\n *   <Button>Manage Users</Button>\n * </PermissionGate>\n *\n * @example\n * // Require ALL of multiple permissions\n * <PermissionGate permissions={['USER_READ_LIST', 'USER_READ_DETAIL']} requireAll={true}>\n *   <UsersTable />\n * </PermissionGate>\n */\n\ninterface PermissionGateProps {\n  /**\n   * Children to render if permission check passes\n   */\n  children: React.ReactNode;\n\n  /**\n   * Single permission to check (use this OR permissions, not both)\n   */\n  permission?: Permission;\n\n  /**\n   * Multiple permissions to check (use this OR permission, not both)\n   */\n  permissions?: Permission[];\n\n  /**\n   * When using `permissions` array:\n   * - true: User must have ALL permissions (AND logic)\n   * - false: User must have ANY permission (OR logic)\n   * Default: false (ANY)\n   */\n  requireAll?: boolean;\n\n  /**\n   * Optional custom UI to show when permission check fails\n   * If not provided, renders null (hides children completely)\n   */\n  fallback?: React.ReactNode;\n\n  /**\n   * Show default permission denied message as fallback\n   * Only used if fallback is not provided\n   * Default: false\n   */\n  showDefaultFallback?: boolean;\n}\n\nexport function PermissionGate({\n  children,\n  permission,\n  permissions,\n  requireAll = false,\n  fallback,\n  showDefaultFallback = false,\n}: PermissionGateProps) {\n  const t = useTranslations(\"permission\");\n  const { can, canAny, canAll } = usePermissionChecker();\n\n  // Validation: Must provide either permission or permissions, but not both\n  if (!permission && !permissions) {\n    if (process.env.NODE_ENV === \"development\") {\n      console.error(\n        \"PermissionGate: Must provide either 'permission' or 'permissions' prop\"\n      );\n    }\n    return null;\n  }\n\n  if (permission && permissions) {\n    if (process.env.NODE_ENV === \"development\") {\n      console.error(\n        \"PermissionGate: Cannot provide both 'permission' and 'permissions' props. Choose one.\"\n      );\n    }\n    return null;\n  }\n\n  // Determine if user has required permission(s)\n  let hasPermission = false;\n\n  if (permission) {\n    // Single permission check\n    hasPermission = can(permission);\n  } else if (permissions && permissions.length > 0) {\n    // Multiple permissions check\n    hasPermission = requireAll\n      ? canAll(permissions) // User must have ALL\n      : canAny(permissions); // User must have ANY\n  }\n\n  // User has permission - render children\n  if (hasPermission) {\n    return <>{children}</>;\n  }\n\n  // User lacks permission - render fallback or null\n  if (fallback) {\n    return <>{fallback}</>;\n  }\n\n  if (showDefaultFallback) {\n    return (\n      <div className=\"rounded-lg border border-destructive/50 bg-destructive/10 p-4 text-sm text-destructive\">\n        <p className=\"font-semibold\">{t(\"access_denied\")}</p>\n        <p className=\"mt-1 text-muted-foreground\">\n          {t(\"insufficient_permissions\")}\n        </p>\n      </div>\n    );\n  }\n\n  // No fallback - hide completely\n  return null;\n}\n\n/**\n * PermissionGateInline Component\n *\n * Inline variant that applies minimal styling when showing default fallback.\n * Useful for inline UI elements like buttons or links within a layout.\n *\n * @example\n * <PermissionGateInline permission=\"USER_CREATE\" showDefaultFallback>\n *   <Button>Create</Button>\n * </PermissionGateInline>\n */\nexport function PermissionGateInline({\n  children,\n  permission,\n  permissions,\n  requireAll = false,\n  fallback,\n  showDefaultFallback = false,\n}: PermissionGateProps) {\n  const t = useTranslations(\"permission\");\n  const { can, canAny, canAll } = usePermissionChecker();\n\n  if (!permission && !permissions) return null;\n  if (permission && permissions) return null;\n\n  let hasPermission = false;\n\n  if (permission) {\n    hasPermission = can(permission);\n  } else if (permissions && permissions.length > 0) {\n    hasPermission = requireAll ? canAll(permissions) : canAny(permissions);\n  }\n\n  if (hasPermission) {\n    return <>{children}</>;\n  }\n\n  if (fallback) {\n    return <>{fallback}</>;\n  }\n\n  if (showDefaultFallback) {\n    return (\n      <span className=\"text-xs text-muted-foreground italic\">\n        {t(\"access_denied\")}\n      </span>\n    );\n  }\n\n  return null;\n}\n\n/**\n * Hook-based alternative for conditional logic in components\n *\n * @example\n * function UserManagementPage() {\n *   const { can } = usePermissionChecker();\n *   const hasCreatePermission = can('USER_CREATE');\n *   const hasUpdatePermission = can('USER_UPDATE');\n *\n *   return (\n *     <div>\n *       {hasCreatePermission && <CreateUserButton />}\n *       {hasUpdatePermission && <EditUserButton />}\n *     </div>\n *   );\n * }\n */\n// Re-export hooks from lib/permissions for convenience\nexport { usePermissionChecker } from \"@/lib/permissions\";\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\components\\auth\\role-based-route-guard.tsx",
      "relative_path": "components/auth/role-based-route-guard.tsx",
      "filename": "role-based-route-guard.tsx",
      "size_bytes": 1929,
      "lines": 66,
      "last_modified": "2025-11-28T09:21:56.242587",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { useRouter, usePathname } from \"next/navigation\";\nimport { getAuthToken, getAuthUser } from \"@/lib/auth\";\n\ninterface RoleBasedRouteGuardProps {\n  children: React.ReactNode;\n  allowedRoles: string[];\n}\n\nexport function RoleBasedRouteGuard({\n  children,\n  allowedRoles\n}: RoleBasedRouteGuardProps) {\n  const router = useRouter();\n  const pathname = usePathname();\n  const [isAuthorized, setIsAuthorized] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    const checkAuth = () => {\n      const token = getAuthToken();\n      const user = getAuthUser();\n\n      if (!token || !user) {\n        // No auth token or user data - redirect to login\n        const loginUrl = `/login?redirect=${encodeURIComponent(pathname)}`;\n        router.replace(loginUrl);\n        return;\n      }\n\n      // Check if user has any of the allowed roles\n      const hasAllowedRole = allowedRoles.some(role => user.roles.includes(role));\n\n      if (!hasAllowedRole) {\n        // User doesn't have required role - redirect to forbidden page\n        router.replace(\"/forbidden\");\n        return;\n      }\n\n      // User is authenticated and has required role\n      setIsAuthorized(true);\n      setIsLoading(false);\n    };\n\n    checkAuth();\n  }, [router, pathname, allowedRoles]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex min-h-screen items-center justify-center\">\n        <div className=\"flex flex-col items-center gap-2\">\n          <div className=\"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent\" />\n          <p className=\"text-sm text-muted-foreground\">Verifying access...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthorized) {\n    return null; // Will redirect, so don't render anything\n  }\n\n  return <>{children}</>;\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\components\\auth\\role-switcher.tsx",
      "relative_path": "components/auth/role-switcher.tsx",
      "filename": "role-switcher.tsx",
      "size_bytes": 3852,
      "lines": 133,
      "last_modified": "2025-11-28T09:21:56.242587",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useRouter } from \"next/navigation\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  ChevronDown, \n  User, \n  GraduationCap, \n  Shield, \n  Settings,\n  BookOpen\n} from \"lucide-react\";\nimport { \n  getAccessibleRoutes, \n  hasMultipleRoles, \n  getPrimaryRole \n} from \"@/lib/role-permissions\";\n\nconst ROLE_CONFIG = {\n  LECTURER: {\n    label: \"Lecturer Portal\",\n    icon: BookOpen,\n    path: \"/lecturer/dashboard\",\n    color: \"bg-blue-100 text-blue-700\",\n  },\n  SUPERVISOR: {\n    label: \"Supervisor Portal\", \n    icon: Shield,\n    path: \"/supervisor/dashboard\",\n    color: \"bg-purple-100 text-purple-700\",\n  },\n  STUDENT: {\n    label: \"Student Portal\",\n    icon: GraduationCap,\n    path: \"/student/dashboard\", \n    color: \"bg-green-100 text-green-700\",\n  },\n  DATA_OPERATOR: {\n    label: \"Admin Portal\",\n    icon: Settings,\n    path: \"/admin/dashboard\",\n    color: \"bg-orange-100 text-orange-700\",\n  },\n} as const;\n\nexport function RoleSwitcher() {\n  const router = useRouter();\n  \n  // Don't show if user doesn't have multiple roles\n  if (!hasMultipleRoles()) {\n    return null;\n  }\n\n  const accessibleRoutes = getAccessibleRoutes();\n  const primaryRole = getPrimaryRole();\n\n  const handleRoleSwitch = (path: string) => {\n    router.push(path);\n  };\n\n  // Get unique role types from accessible routes\n  const availableRoles = accessibleRoutes.map(route => {\n    if (route === \"/admin\") return \"DATA_OPERATOR\"; // Default admin role\n    if (route === \"/lecturer\") return \"LECTURER\";\n    if (route === \"/supervisor\") return \"SUPERVISOR\";\n    if (route === \"/student\") return \"STUDENT\";\n    return null;\n  }).filter(Boolean) as string[];\n\n  if (availableRoles.length <= 1) {\n    return null;\n  }\n\n  const currentRoleConfig = primaryRole ? ROLE_CONFIG[primaryRole as keyof typeof ROLE_CONFIG] : null;\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\n          {currentRoleConfig ? (\n            <>\n              <currentRoleConfig.icon className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">{currentRoleConfig.label}</span>\n            </>\n          ) : (\n            <>\n              <User className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">Switch Role</span>\n            </>\n          )}\n          <ChevronDown className=\"h-4 w-4\" />\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\" className=\"w-56\">\n        <DropdownMenuLabel>Switch Portal</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        {availableRoles.map((role) => {\n          const config = ROLE_CONFIG[role as keyof typeof ROLE_CONFIG];\n          const isActive = role === primaryRole;\n          \n          return (\n            <DropdownMenuItem\n              key={role}\n              onClick={() => handleRoleSwitch(config.path)}\n              className=\"flex items-center gap-3 cursor-pointer\"\n            >\n              <config.icon className=\"h-4 w-4\" />\n              <div className=\"flex-1\">\n                <div className=\"flex items-center gap-2\">\n                  <span>{config.label}</span>\n                  {isActive && (\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      Current\n                    </Badge>\n                  )}\n                </div>\n              </div>\n            </DropdownMenuItem>\n          );\n        })}\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}"
    }
  ]
}