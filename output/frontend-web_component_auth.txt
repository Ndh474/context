{
  "metadata": {
    "codebase": "frontend-web",
    "category": "component_auth",
    "generated_at": "2025-11-19T20:29:55.651038",
    "total_files": 3,
    "total_lines": 384,
    "total_bytes": 11403
  },
  "files": [
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\components\\auth\\login-form.tsx",
      "relative_path": "components/auth/login-form.tsx",
      "filename": "login-form.tsx",
      "size_bytes": 5347,
      "lines": 177,
      "last_modified": "2025-11-10T23:08:19.312766",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport * as React from \"react\";\nimport Link from \"next/link\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useForm } from \"react-hook-form\";\nimport { useRouter } from \"next/navigation\";\nimport { z } from \"zod\";\nimport { GoogleLogin, type CredentialResponse } from \"@react-oauth/google\";\nimport { toast } from \"sonner\";\n\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { useLogin, useGoogleLogin } from \"@/hooks/api/useAuth\";\nimport { getRoleBasedRedirectPath } from \"@/lib/auth\";\nimport { loginRequestSchema } from \"@/lib/zod-schemas\";\nimport type { LoginRequest } from \"@/types\";\n\nconst formSchema = loginRequestSchema;\n\ntype LoginFormValues = z.infer<typeof formSchema>;\n\ntype LoginError = {\n  status: number;\n  toastMessage: string;\n};\n\nexport function LoginForm(): React.JSX.Element {\n  const router = useRouter();\n  const loginMutation = useLogin();\n  const googleLoginMutation = useGoogleLogin();\n\n  const form = useForm<LoginFormValues>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      username: \"\",\n      password: \"\",\n    },\n  });\n\n  const onSubmit = async (values: LoginFormValues) => {\n    form.clearErrors();\n    try {\n      // Convert username to lowercase before sending\n      const response = await loginMutation.mutateAsync({\n        username: values.username.toLowerCase(),\n        password: values.password,\n      } as LoginRequest);\n      // Redirect based on user roles\n      const redirectPath = getRoleBasedRedirectPath(response.roles);\n      router.push(redirectPath);\n    } catch (error) {\n      const mapped = error as LoginError;\n      if (mapped?.status) {\n        form.setError(\"username\", { type: \"manual\" });\n        form.setError(\"password\", { type: \"manual\" });\n      }\n    }\n  };\n\n  const handleGoogleSuccess = React.useCallback(\n    (credentialResponse: CredentialResponse) => {\n      const credential = credentialResponse.credential;\n      if (!credential) {\n        toast.error(\"Google authentication failed. Please try again.\");\n        return;\n      }\n\n      googleLoginMutation.mutate(credential, {\n        onSuccess: (response) => {\n          // Redirect based on user roles\n          const redirectPath = getRoleBasedRedirectPath(response.roles);\n          router.push(redirectPath);\n        },\n      });\n    },\n    [googleLoginMutation, router]\n  );\n\n  const handleGoogleError = React.useCallback(() => {\n    toast.error(\"Google authentication was canceled or failed.\");\n  }, []);\n\n  const isSubmitting =\n    form.formState.isSubmitting ||\n    loginMutation.isPending ||\n    googleLoginMutation.isPending;\n\n  return (\n    <Form {...form}>\n      <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n        <FormField\n          control={form.control}\n          name=\"username\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Username</FormLabel>\n              <FormControl>\n                <Input\n                  placeholder=\"Enter your username\"\n                  autoComplete=\"username\"\n                  aria-invalid={!!form.formState.errors.username}\n                  {...field}\n                />\n              </FormControl>\n            </FormItem>\n          )}\n        />\n\n        <FormField\n          control={form.control}\n          name=\"password\"\n          render={({ field }) => (\n            <FormItem>\n              <FormLabel>Password</FormLabel>\n              <FormControl>\n                <Input\n                  type=\"password\"\n                  placeholder=\"Enter your password\"\n                  autoComplete=\"current-password\"\n                  aria-invalid={!!form.formState.errors.password}\n                  {...field}\n                />\n              </FormControl>\n            </FormItem>\n          )}\n        />\n\n        <div className=\"text-right text-sm -mt-2 mb-4\">\n          <Button\n            variant=\"link\"\n            asChild\n            className=\"h-auto p-0 text-sm font-medium\"\n          >\n            <Link href=\"/forgot-password\">Forgot password?</Link>\n          </Button>\n        </div>\n\n        <Button type=\"submit\" className=\"w-full\" disabled={isSubmitting}>\n          {isSubmitting ? \"Signing in...\" : \"Sign in\"}\n        </Button>\n\n        <div className=\"relative flex items-center gap-3 text-xs text-muted-foreground\">\n          <Separator className=\"flex-1\" />\n          <span>Or continue with</span>\n          <Separator className=\"flex-1\" />\n        </div>\n\n        <div\n          className=\"flex justify-center\"\n          style={\n            googleLoginMutation.isPending\n              ? { pointerEvents: \"none\", opacity: 0.6 }\n              : undefined\n          }\n        >\n          <GoogleLogin\n            onSuccess={handleGoogleSuccess}\n            onError={handleGoogleError}\n            text=\"continue_with\"\n            shape=\"pill\"\n            theme=\"filled_blue\"\n            width=\"100%\"\n          />\n        </div>\n      </form>\n    </Form>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\components\\auth\\role-based-route-guard.tsx",
      "relative_path": "components/auth/role-based-route-guard.tsx",
      "filename": "role-based-route-guard.tsx",
      "size_bytes": 2204,
      "lines": 74,
      "last_modified": "2025-11-01T15:38:43.316894",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { useRouter, usePathname } from \"next/navigation\";\nimport { getAuthToken, getAuthUser, getRoleBasedRedirectPath } from \"@/lib/auth\";\n\ninterface RoleBasedRouteGuardProps {\n  children: React.ReactNode;\n  allowedRoles: string[];\n  redirectPath?: string;\n}\n\nexport function RoleBasedRouteGuard({ \n  children, \n  allowedRoles, \n  redirectPath \n}: RoleBasedRouteGuardProps) {\n  const router = useRouter();\n  const pathname = usePathname();\n  const [isAuthorized, setIsAuthorized] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    const checkAuth = () => {\n      const token = getAuthToken();\n      const user = getAuthUser();\n\n      if (!token || !user) {\n        // No auth token or user data - redirect to login\n        const loginUrl = `/login?redirect=${encodeURIComponent(pathname)}`;\n        router.replace(loginUrl);\n        return;\n      }\n\n      // Check if user has any of the allowed roles\n      const hasAllowedRole = allowedRoles.some(role => user.roles.includes(role));\n\n      if (!hasAllowedRole) {\n        // User doesn't have required role - redirect to appropriate dashboard\n        const userDashboard = getRoleBasedRedirectPath(user.roles);\n        \n        if (redirectPath) {\n          router.replace(redirectPath);\n        } else {\n          router.replace(userDashboard);\n        }\n        return;\n      }\n\n      // User is authenticated and has required role\n      setIsAuthorized(true);\n      setIsLoading(false);\n    };\n\n    checkAuth();\n  }, [router, pathname, allowedRoles, redirectPath]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex min-h-screen items-center justify-center\">\n        <div className=\"flex flex-col items-center gap-2\">\n          <div className=\"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent\" />\n          <p className=\"text-sm text-muted-foreground\">Verifying access...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!isAuthorized) {\n    return null; // Will redirect, so don't render anything\n  }\n\n  return <>{children}</>;\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\components\\auth\\role-switcher.tsx",
      "relative_path": "components/auth/role-switcher.tsx",
      "filename": "role-switcher.tsx",
      "size_bytes": 3852,
      "lines": 133,
      "last_modified": "2025-11-01T16:12:02.646739",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useRouter } from \"next/navigation\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { \n  ChevronDown, \n  User, \n  GraduationCap, \n  Shield, \n  Settings,\n  BookOpen\n} from \"lucide-react\";\nimport { \n  getAccessibleRoutes, \n  hasMultipleRoles, \n  getPrimaryRole \n} from \"@/lib/role-permissions\";\n\nconst ROLE_CONFIG = {\n  LECTURER: {\n    label: \"Lecturer Portal\",\n    icon: BookOpen,\n    path: \"/lecturer/dashboard\",\n    color: \"bg-blue-100 text-blue-700\",\n  },\n  SUPERVISOR: {\n    label: \"Supervisor Portal\", \n    icon: Shield,\n    path: \"/supervisor/dashboard\",\n    color: \"bg-purple-100 text-purple-700\",\n  },\n  STUDENT: {\n    label: \"Student Portal\",\n    icon: GraduationCap,\n    path: \"/student/dashboard\", \n    color: \"bg-green-100 text-green-700\",\n  },\n  DATA_OPERATOR: {\n    label: \"Admin Portal\",\n    icon: Settings,\n    path: \"/admin/dashboard\",\n    color: \"bg-orange-100 text-orange-700\",\n  },\n} as const;\n\nexport function RoleSwitcher() {\n  const router = useRouter();\n  \n  // Don't show if user doesn't have multiple roles\n  if (!hasMultipleRoles()) {\n    return null;\n  }\n\n  const accessibleRoutes = getAccessibleRoutes();\n  const primaryRole = getPrimaryRole();\n\n  const handleRoleSwitch = (path: string) => {\n    router.push(path);\n  };\n\n  // Get unique role types from accessible routes\n  const availableRoles = accessibleRoutes.map(route => {\n    if (route === \"/admin\") return \"DATA_OPERATOR\"; // Default admin role\n    if (route === \"/lecturer\") return \"LECTURER\";\n    if (route === \"/supervisor\") return \"SUPERVISOR\";\n    if (route === \"/student\") return \"STUDENT\";\n    return null;\n  }).filter(Boolean) as string[];\n\n  if (availableRoles.length <= 1) {\n    return null;\n  }\n\n  const currentRoleConfig = primaryRole ? ROLE_CONFIG[primaryRole as keyof typeof ROLE_CONFIG] : null;\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\n          {currentRoleConfig ? (\n            <>\n              <currentRoleConfig.icon className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">{currentRoleConfig.label}</span>\n            </>\n          ) : (\n            <>\n              <User className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">Switch Role</span>\n            </>\n          )}\n          <ChevronDown className=\"h-4 w-4\" />\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\" className=\"w-56\">\n        <DropdownMenuLabel>Switch Portal</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        {availableRoles.map((role) => {\n          const config = ROLE_CONFIG[role as keyof typeof ROLE_CONFIG];\n          const isActive = role === primaryRole;\n          \n          return (\n            <DropdownMenuItem\n              key={role}\n              onClick={() => handleRoleSwitch(config.path)}\n              className=\"flex items-center gap-3 cursor-pointer\"\n            >\n              <config.icon className=\"h-4 w-4\" />\n              <div className=\"flex-1\">\n                <div className=\"flex items-center gap-2\">\n                  <span>{config.label}</span>\n                  {isActive && (\n                    <Badge variant=\"secondary\" className=\"text-xs\">\n                      Current\n                    </Badge>\n                  )}\n                </div>\n              </div>\n            </DropdownMenuItem>\n          );\n        })}\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n}"
    }
  ]
}