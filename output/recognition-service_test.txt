{
  "metadata": {
    "codebase": "recognition-service",
    "category": "test",
    "generated_at": "2025-11-19T20:29:55.721713",
    "total_files": 5,
    "total_lines": 370,
    "total_bytes": 13095
  },
  "files": [
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\recognition-service\\tests\\__init__.py",
      "relative_path": "tests/__init__.py",
      "filename": "__init__.py",
      "size_bytes": 0,
      "lines": 0,
      "last_modified": "2025-10-05T13:04:14.658641",
      "encoding": "utf-8",
      "language": "python",
      "content": ""
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\recognition-service\\tests\\test_camera_direct.py",
      "relative_path": "tests/test_camera_direct.py",
      "filename": "test_camera_direct.py",
      "size_bytes": 830,
      "lines": 35,
      "last_modified": "2025-10-28T18:35:34.704357",
      "encoding": "utf-8",
      "language": "python",
      "content": "import cv2\nimport asyncio\nimport logging\n\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\n\nasync def test_camera():\n    rtsp_url = \"rtsp://C200C_FUACS2:12345678@192.168.1.80:554/stream1\"\n\n    logger.info(f\"Testing camera: {rtsp_url}\")\n\n    cap = cv2.VideoCapture(rtsp_url)\n\n    if not cap.isOpened():\n        logger.error(\"Cannot open camera\")\n        return\n\n    logger.info(\"Camera opened successfully\")\n\n    for i in range(5):  # Read 5 frames\n        ret, frame = cap.read()\n        if ret:\n            logger.info(f\"Frame {i+1}: {frame.shape}\")\n        else:\n            logger.error(f\"Failed to read frame {i+1}\")\n        await asyncio.sleep(0.1)\n\n    cap.release()\n    logger.info(\"Test complete\")\n\n\nif __name__ == \"__main__\":\n    asyncio.run(test_camera())\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\recognition-service\\tests\\test_cameras.py",
      "relative_path": "tests/test_cameras.py",
      "filename": "test_cameras.py",
      "size_bytes": 9391,
      "lines": 242,
      "last_modified": "2025-10-28T11:39:41.447110",
      "encoding": "utf-8",
      "language": "python",
      "content": "\"\"\"\nCamera Endpoints Tests\n\nUnit tests for camera testing and frame capture endpoints.\n\"\"\"\n\nimport pytest\nfrom fastapi.testclient import TestClient\nfrom recognition_service.main import app\n\nclient = TestClient(app)\nAPI_KEY = \"python-service-secret-key-12345\"\n\n\nclass TestCameraTestConnection:\n    \"\"\"Test /api/v1/cameras/test-connection endpoint\"\"\"\n\n    def test_requires_api_key(self):\n        \"\"\"Test endpoint requires X-API-Key authentication\"\"\"\n        response = client.get(\"/api/v1/cameras/test-connection?rtspUrl=rtsp://test\")\n        assert response.status_code == 401\n        assert \"Invalid or missing API key\" in response.json()[\"detail\"]\n\n    def test_requires_rtsp_url(self):\n        \"\"\"Test rtspUrl parameter is required\"\"\"\n        response = client.get(\"/api/v1/cameras/test-connection\", headers={\"X-API-Key\": API_KEY})\n        assert response.status_code == 422  # FastAPI validation error\n\n        # Check validation error details\n        error = response.json()[\"detail\"][0]\n        assert error[\"loc\"] == [\"query\", \"rtspUrl\"]\n        assert error[\"type\"] == \"missing\"\n\n    def test_validates_rtsp_format(self):\n        \"\"\"Test rejects non-RTSP URLs\"\"\"\n        response = client.get(\n            \"/api/v1/cameras/test-connection?rtspUrl=http://invalid\", headers={\"X-API-Key\": API_KEY}\n        )\n        assert response.status_code == 400\n        assert \"Invalid RTSP URL format\" in response.json()[\"detail\"]\n\n    def test_validates_timeout_range(self):\n        \"\"\"Test timeout parameter validation\"\"\"\n        # Too small timeout\n        response = client.get(\n            \"/api/v1/cameras/test-connection?rtspUrl=rtsp://test&timeout=0\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n        assert response.status_code == 422\n\n        # Too large timeout\n        response = client.get(\n            \"/api/v1/cameras/test-connection?rtspUrl=rtsp://test&timeout=31\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n        assert response.status_code == 422\n\n    def test_valid_rtsp_url_format_accepted(self):\n        \"\"\"Test valid RTSP URL format is accepted (will fail connection but pass validation)\"\"\"\n        response = client.get(\n            \"/api/v1/cameras/test-connection?rtspUrl=rtsp://192.168.1.999:554/stream1\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n        # Should return 200 even if connection fails (test completed)\n        assert response.status_code == 200\n\n        data = response.json()\n        assert data[\"status\"] == 200\n        assert \"data\" in data\n        assert data[\"data\"][\"connected\"] is False\n        assert \"error\" in data[\"data\"]\n\n    def test_response_structure(self):\n        \"\"\"Test response follows expected structure\"\"\"\n        response = client.get(\n            \"/api/v1/cameras/test-connection?rtspUrl=rtsp://invalid.test:554/stream\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n\n        assert response.status_code == 200\n        data = response.json()\n\n        # Check response structure\n        assert \"status\" in data\n        assert \"message\" in data\n        assert \"data\" in data\n\n        # Check data structure\n        test_data = data[\"data\"]\n        assert \"rtspUrl\" in test_data\n        assert \"connected\" in test_data\n        assert \"testedAt\" in test_data\n        assert test_data[\"rtspUrl\"] == \"rtsp://invalid.test:554/stream\"\n\n\nclass TestCameraCaptureFrame:\n    \"\"\"Test /api/v1/cameras/capture-frame endpoint\"\"\"\n\n    def test_requires_api_key(self):\n        \"\"\"Test endpoint requires X-API-Key authentication\"\"\"\n        response = client.get(\"/api/v1/cameras/capture-frame\")\n        assert response.status_code == 401\n        assert \"Invalid or missing API key\" in response.json()[\"detail\"]\n\n    def test_requires_rtsp_url_or_camera_id(self):\n        \"\"\"Test requires either rtspUrl or cameraId parameter\"\"\"\n        response = client.get(\"/api/v1/cameras/capture-frame\", headers={\"X-API-Key\": API_KEY})\n        assert response.status_code == 400\n        assert \"Either rtspUrl or cameraId is required\" in response.json()[\"detail\"]\n\n    def test_rejects_both_parameters(self):\n        \"\"\"Test cannot provide both rtspUrl and cameraId\"\"\"\n        response = client.get(\n            \"/api/v1/cameras/capture-frame?rtspUrl=rtsp://test&cameraId=1\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n        assert response.status_code == 400\n        assert \"Provide either rtspUrl or cameraId, not both\" in response.json()[\"detail\"]\n\n    def test_camera_id_not_implemented(self):\n        \"\"\"Test cameraId parameter returns 501 Not Implemented\"\"\"\n        response = client.get(\n            \"/api/v1/cameras/capture-frame?cameraId=1\", headers={\"X-API-Key\": API_KEY}\n        )\n        assert response.status_code == 501\n        assert \"CameraId lookup not implemented\" in response.json()[\"detail\"]\n\n    def test_validates_rtsp_format(self):\n        \"\"\"Test rejects non-RTSP URLs\"\"\"\n        response = client.get(\n            \"/api/v1/cameras/capture-frame?rtspUrl=http://invalid\", headers={\"X-API-Key\": API_KEY}\n        )\n        assert response.status_code == 400\n        assert \"Invalid RTSP URL format\" in response.json()[\"detail\"]\n\n    def test_validates_format_parameter(self):\n        \"\"\"Test format parameter validation\"\"\"\n        response = client.get(\n            \"/api/v1/cameras/capture-frame?rtspUrl=rtsp://test&format=invalid\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n        assert response.status_code == 422  # FastAPI validation error\n\n    def test_default_format_is_base64(self):\n        \"\"\"Test default format is base64\"\"\"\n        response = client.get(\n            \"/api/v1/cameras/capture-frame?rtspUrl=rtsp://invalid.test:554/stream\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n        # Should fail connection but we can check the error mentions base64 format\n        assert response.status_code == 500  # Connection will fail\n        # The error indicates it tried to capture but failed due to bad URL\n\n    def test_validates_timeout_range(self):\n        \"\"\"Test timeout parameter validation\"\"\"\n        # Too small timeout\n        response = client.get(\n            \"/api/v1/cameras/capture-frame?rtspUrl=rtsp://test&timeout=0\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n        assert response.status_code == 422\n\n        # Too large timeout\n        response = client.get(\n            \"/api/v1/cameras/capture-frame?rtspUrl=rtsp://test&timeout=31\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n        assert response.status_code == 422\n\n\nclass TestCameraEndpointsIntegration:\n    \"\"\"Integration tests that require real RTSP streams\"\"\"\n\n    @pytest.mark.skip(reason=\"Requires real RTSP stream for testing\")\n    def test_real_camera_connection(self):\n        \"\"\"\n        Integration test with real RTSP camera.\n\n        To run this test:\n        1. Set up a real RTSP camera or use a public demo stream\n        2. Replace rtsp_url with actual working stream\n        3. Remove @pytest.mark.skip decorator\n        \"\"\"\n        rtsp_url = \"rtsp://demo:demo@ipvmdemo.dyndns.org:5541/onvif-media/media.amp\"\n\n        response = client.get(\n            f\"/api/v1/cameras/test-connection?rtspUrl={rtsp_url}\", headers={\"X-API-Key\": API_KEY}\n        )\n\n        assert response.status_code == 200\n        data = response.json()[\"data\"]\n\n        if data[\"connected\"]:\n            assert \"frameRate\" in data\n            assert \"resolution\" in data\n            assert \"latency\" in data\n            assert \"stability\" in data\n            assert data[\"frameRate\"] > 0\n            assert data[\"resolution\"][\"width\"] > 0\n            assert data[\"resolution\"][\"height\"] > 0\n\n    @pytest.mark.skip(reason=\"Requires real RTSP stream for testing\")\n    def test_real_frame_capture_base64(self):\n        \"\"\"Integration test for base64 frame capture\"\"\"\n        rtsp_url = \"rtsp://demo:demo@ipvmdemo.dyndns.org:5541/onvif-media/media.amp\"\n\n        response = client.get(\n            f\"/api/v1/cameras/capture-frame?rtspUrl={rtsp_url}&format=base64\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n\n        assert response.status_code == 200\n        data = response.json()[\"data\"]\n\n        assert data[\"format\"] == \"base64\"\n        assert \"image\" in data\n        assert data[\"image\"].startswith(\"data:image/jpeg;base64,\")\n        assert \"resolution\" in data\n\n    @pytest.mark.skip(reason=\"Requires real RTSP stream for testing\")\n    def test_real_frame_capture_file(self):\n        \"\"\"Integration test for file frame capture\"\"\"\n        rtsp_url = \"rtsp://demo:demo@ipvmdemo.dyndns.org:5541/onvif-media/media.amp\"\n\n        response = client.get(\n            f\"/api/v1/cameras/capture-frame?rtspUrl={rtsp_url}&format=file\",\n            headers={\"X-API-Key\": API_KEY},\n        )\n\n        assert response.status_code == 200\n        data = response.json()[\"data\"]\n\n        assert data[\"format\"] == \"file\"\n        assert \"filePath\" in data\n        assert \"fileUrl\" in data\n        assert data[\"filePath\"].endswith(\".jpg\")\n        assert data[\"fileUrl\"].startswith(\"/api/v1/files/\")\n\n\nif __name__ == \"__main__\":\n    # Run tests with: python -m pytest tests/test_cameras.py -v\n    pytest.main([__file__])\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\recognition-service\\tests\\test_embeddings.py",
      "relative_path": "tests/test_embeddings.py",
      "filename": "test_embeddings.py",
      "size_bytes": 1875,
      "lines": 56,
      "last_modified": "2025-11-03T15:24:56.832139",
      "encoding": "utf-8",
      "language": "python",
      "content": "\"\"\"\nUnit Tests for Embeddings Endpoints\n\"\"\"\n\nimport pytest\nfrom fastapi.testclient import TestClient\nfrom recognition_service.main import app\n\nclient = TestClient(app)\nAPI_KEY = \"python-service-secret-key-12345\"\n\n\nclass TestEmbeddingsGenerate:\n    \"\"\"Tests for POST /api/v1/embeddings/generate\"\"\"\n\n    def test_generate_requires_auth(self):\n        \"\"\"Test endpoint requires API key\"\"\"\n        # Create dummy file\n        files = {\"photo\": (\"test.jpg\", b\"fake image content\", \"image/jpeg\")}\n        data = {\"submissionId\": 1}\n\n        response = client.post(\"/api/v1/embeddings/generate\", files=files, data=data)\n        assert response.status_code == 401\n\n    def test_generate_invalid_format(self):\n        \"\"\"Test invalid photo format rejection\"\"\"\n        headers = {\"X-API-Key\": API_KEY}\n        # Create dummy file with wrong extension\n        files = {\"photo\": (\"test.txt\", b\"fake content\", \"text/plain\")}\n        data = {\"submissionId\": 1}\n\n        response = client.post(\n            \"/api/v1/embeddings/generate\", headers=headers, files=files, data=data\n        )\n\n        assert response.status_code == 200  # Still returns 200\n        response_data = response.json()\n        assert response_data[\"status\"] == 400\n        assert response_data[\"code\"] == \"INVALID_FILE_FORMAT\"\n\n    def test_generate_missing_photo(self):\n        \"\"\"Test missing photo file\"\"\"\n        headers = {\"X-API-Key\": API_KEY}\n        data = {\"submissionId\": 1}\n\n        # No files provided\n        response = client.post(\"/api/v1/embeddings/generate\", headers=headers, data=data)\n\n        # FastAPI will return 422 for missing required field\n        assert response.status_code == 422\n\n\n# Note: Full integration tests would require:\n# - Real photo files in tests/fixtures/\n# - InsightFace model loaded\n# - More comprehensive test cases\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\recognition-service\\tests\\test_task_manager.py",
      "relative_path": "tests/test_task_manager.py",
      "filename": "test_task_manager.py",
      "size_bytes": 999,
      "lines": 37,
      "last_modified": "2025-10-28T14:54:57.633897",
      "encoding": "utf-8",
      "language": "python",
      "content": "import asyncio\nimport logging\nfrom recognition_service.services.task_manager import task_manager\n\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\n\nasync def dummy_task(task_id: int):\n    \"\"\"Simple task that logs\"\"\"\n    logger.info(f\"Task {task_id} started\")\n    for i in range(5):\n        logger.info(f\"Task {task_id}: iteration {i}\")\n        await asyncio.sleep(1)\n    logger.info(f\"Task {task_id} completed\")\n\n\nasync def test_task_manager():\n    logger.info(\"Testing task_manager\")\n\n    # Start 2 tasks\n    task1 = await task_manager.start_task(\"test_1\", dummy_task(1))\n    task2 = await task_manager.start_task(\"test_2\", dummy_task(2))\n\n    logger.info(f\"Active tasks: {task_manager.active_tasks_count}\")\n\n    # Wait a bit\n    await asyncio.sleep(3)\n\n    logger.info(\"Stopping all tasks\")\n    await task_manager.stop_all_tasks()\n\n    logger.info(\"Test complete\")\n\n\nif __name__ == \"__main__\":\n    asyncio.run(test_task_manager())\n"
    }
  ]
}