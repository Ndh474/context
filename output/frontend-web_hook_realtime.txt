{
  "metadata": {
    "codebase": "frontend-web",
    "category": "hook_realtime",
    "generated_at": "2025-12-03T21:12:52.247643",
    "total_files": 1,
    "total_lines": 129,
    "total_bytes": 4741
  },
  "files": [
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\hooks\\realtime\\useSlotRosterSSE.ts",
      "relative_path": "hooks/realtime/useSlotRosterSSE.ts",
      "filename": "useSlotRosterSSE.ts",
      "size_bytes": 4741,
      "lines": 129,
      "last_modified": "2025-11-28T09:21:56.276542",
      "encoding": "utf-8",
      "language": "typescript",
      "content": "\"use client\";\n\nimport { useEffect, useRef, useState } from \"react\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { getAuthToken } from \"@/lib/auth\";\nimport { QUERY_KEYS } from \"@/lib/constants\";\nimport type { SlotRosterResponse } from \"@/types\";\n\ntype AttendanceUpdateEvent = {\n  slotId: number;\n  studentUserId: number;\n  kind: \"regular\" | \"exam\";\n  recordId: number;\n  status: \"not_yet\" | \"present\" | \"absent\";\n  method: \"auto\" | \"manual\" | \"system_finalize\" | null;\n  recordedAt?: string | null;\n  evidenceImageUrl?: string | null;\n  needsReview?: boolean | null;\n};\n\nexport function useSlotRosterSSE(slotId: number) {\n  const queryClient = useQueryClient();\n  const esRef = useRef<EventSource | null>(null);\n  const [isConnected, setIsConnected] = useState(false);\n  const [hasError, setHasError] = useState<string | null>(null);\n\n  useEffect(() => {\n    const token = getAuthToken();\n    if (!token || !slotId) return;\n\n    // Build SSE URL\n    const base = (process.env.NEXT_PUBLIC_API_URL || \"\").replace(/\\/$/, \"\");\n    const url = `${base}/slots/${slotId}/events?token=${encodeURIComponent(\n      token\n    )}`;\n\n    const es = new EventSource(url);\n    esRef.current = es;\n\n    const onOpen = () => {\n      setIsConnected(true);\n      setHasError(null);\n    };\n\n    const onError = () => {\n      setIsConnected(false);\n      setHasError(\"connection_error\");\n    };\n\n    const onAttendanceUpdate = (ev: MessageEvent) => {\n      try {\n        const data: AttendanceUpdateEvent = JSON.parse(ev.data);\n        if (!data || data.slotId !== slotId) return;\n\n        // DEBUG: Log SSE event data\n        console.log('[SSE] Attendance update received:', {\n          studentUserId: data.studentUserId,\n          kind: data.kind,\n          status: data.status,\n          needsReview: data.needsReview,\n          evidenceImageUrl: data.evidenceImageUrl,\n        });\n\n        queryClient.setQueryData<SlotRosterResponse>(\n          QUERY_KEYS.slots.roster(slotId),\n          (prev) => {\n            if (!prev) return prev;\n            const next = prev.map((item) => {\n              if (item.student.userId !== data.studentUserId) return item;\n\n              // Determine which attendance to update based on kind\n              if (data.kind === \"regular\") {\n                const current = item.regularAttendance || ({} as any);\n                const updated = {\n                  ...item,\n                  regularAttendance: {\n                    recordId: data.recordId ?? current.recordId ?? null,\n                    status: data.status ?? current.status ?? \"not_yet\",\n                    method: (data.method as any) ?? current.method ?? null,\n                    evidenceImageUrl:\n                      data.evidenceImageUrl ?? current.evidenceImageUrl ?? null,\n                    remark: current.remark ?? null,\n                    needsReview: data.needsReview ?? current.needsReview ?? false,\n                  },\n                };\n                console.log('[SSE] Updated regular attendance:', updated.regularAttendance);\n                return updated;\n              } else {\n                const current = item.examAttendance || ({} as any);\n                const updated = {\n                  ...item,\n                  examAttendance: {\n                    recordId: data.recordId ?? current.recordId ?? null,\n                    status: data.status ?? current.status ?? \"not_yet\",\n                    method: (data.method as any) ?? current.method ?? null,\n                    evidenceImageUrl:\n                      data.evidenceImageUrl ?? current.evidenceImageUrl ?? null,\n                    remark: current.remark ?? null,\n                    needsReview: data.needsReview ?? current.needsReview ?? false,\n                  },\n                };\n                console.log('[SSE] Updated exam attendance:', updated.examAttendance);\n                return updated;\n              }\n            });\n            return next as SlotRosterResponse;\n          }\n        );\n      } catch (err) {\n        console.error('[SSE] Failed to parse attendance update:', err);\n      }\n    };\n\n    es.addEventListener(\"open\", onOpen);\n    es.addEventListener(\"error\", onError as any);\n    es.addEventListener(\"attendance.update\", onAttendanceUpdate as any);\n\n    return () => {\n      es.removeEventListener(\"open\", onOpen);\n      es.removeEventListener(\"error\", onError as any);\n      es.removeEventListener(\"attendance.update\", onAttendanceUpdate as any);\n      es.close();\n      esRef.current = null;\n    };\n  }, [slotId, queryClient]);\n\n  return { isConnected, hasError } as const;\n}\n\n"
    }
  ]
}