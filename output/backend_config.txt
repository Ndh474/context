{
  "metadata": {
    "codebase": "backend",
    "category": "config",
    "generated_at": "2025-11-20T20:18:28.636117",
    "total_files": 15,
    "total_lines": 692,
    "total_bytes": 27638
  },
  "files": [
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\AuthenticationRequestFilter.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/AuthenticationRequestFilter.java",
      "filename": "AuthenticationRequestFilter.java",
      "size_bytes": 3983,
      "lines": 88,
      "last_modified": "2025-11-14T16:45:47.335648",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport com.fuacs.backend.constant.Constant;\nimport jakarta.servlet.FilterChain;\nimport jakarta.servlet.ServletException;\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.lang.NonNull;\nimport org.springframework.security.authentication.AbstractAuthenticationToken;\nimport org.springframework.security.authentication.InternalAuthenticationServiceException;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\nimport org.springframework.security.core.context.SecurityContext;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.security.oauth2.jwt.Jwt;\nimport org.springframework.security.oauth2.server.resource.InvalidBearerTokenException;\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationToken;\nimport org.springframework.stereotype.Component;\nimport org.springframework.web.filter.OncePerRequestFilter;\n\nimport java.io.IOException;\nimport java.time.Instant;\nimport java.util.HashSet;\nimport java.util.Set;\n\n@Component\npublic class AuthenticationRequestFilter extends OncePerRequestFilter {\n    private static final Logger log = LoggerFactory.getLogger(AuthenticationRequestFilter.class);\n\n\n    @Override\n    protected void doFilterInternal(@NonNull HttpServletRequest request,\n                                    @NonNull HttpServletResponse response,\n                                    @NonNull FilterChain filterChain)\n            throws ServletException, IOException {\n        SecurityContext securityContext = SecurityContextHolder.getContext();\n        Authentication authentication = securityContext.getAuthentication();\n\n        if (!(authentication instanceof JwtAuthenticationToken jwtAuthentication)) {\n            filterChain.doFilter(request, response);\n            return;\n        }\n\n        Jwt token = jwtAuthentication.getToken();\n\n        Object username;\n        Object userIdClaim = token.getClaim(\"userId\");\n        Integer userId = null;\n        if (userIdClaim instanceof Integer i) {\n            userId = i;\n        } else if (userIdClaim instanceof Long l) {\n            userId = l.intValue();\n        } else if (userIdClaim instanceof String s) {\n            userId = Integer.parseInt(s);\n        }\n        Instant issuedAt;\n        Set<SimpleGrantedAuthority> authorities = new HashSet<>();\n        try {\n            username = token.getSubject();\n            issuedAt = token.getIssuedAt();\n            if (username == null || issuedAt == null) {\n                throw new InvalidBearerTokenException(\"Invalid token\");\n            }\n            Object authoritiesClaim = token.getClaim(Constant.AUTHORITIES);\n            if (authoritiesClaim instanceof Iterable<?> iterable) {\n                for (Object roleObj : iterable) {\n                    if (roleObj instanceof String roleName) {\n                        authorities.add(new SimpleGrantedAuthority(roleName.toUpperCase()));\n                    }\n                }\n            }\n        } catch (Exception ex) {\n            throw new InternalAuthenticationServiceException(ex.getMessage());\n        }\n        AbstractAuthenticationToken authentication1 = new UserAuthentication(username, token, authorities, userId);\n        SecurityContextHolder.getContext().setAuthentication(authentication1);\n        filterChain.doFilter(request, response);\n    }\n\n    @Override\n    protected boolean shouldNotFilter(@NonNull HttpServletRequest request) {\n        SecurityContext securityContext = SecurityContextHolder.getContext();\n        Authentication authentication = securityContext.getAuthentication();\n        return !(authentication instanceof JwtAuthenticationToken);\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\CommonBeanConfig.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/CommonBeanConfig.java",
      "filename": "CommonBeanConfig.java",
      "size_bytes": 1186,
      "lines": 35,
      "last_modified": "2025-11-09T20:27:56.516066",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.EnableAspectJAutoProxy;\nimport org.springframework.data.auditing.DateTimeProvider;\nimport org.springframework.data.jpa.repository.config.EnableJpaAuditing;\nimport org.springframework.scheduling.annotation.EnableAsync;\nimport org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\nimport org.springframework.security.crypto.password.PasswordEncoder;\n\nimport java.time.Instant;\nimport java.time.ZoneId;\nimport java.time.ZonedDateTime;\nimport java.util.Optional;\n\n@EnableJpaAuditing(dateTimeProviderRef = \"dateTimeProvider\")\n@Configuration\n@EnableAsync\n@EnableAspectJAutoProxy\npublic class CommonBeanConfig {\n\n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        return new BCryptPasswordEncoder();\n    }\n\n    @Bean\n    public DateTimeProvider dateTimeProvider() {\n        return () -> {\n            ZoneId vnZone = ZoneId.of(\"Asia/Ho_Chi_Minh\");\n            return Optional.of(ZonedDateTime.now(vnZone).toInstant());\n        };\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\converter\\StringToAttendanceMethodConverter.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/converter/StringToAttendanceMethodConverter.java",
      "filename": "StringToAttendanceMethodConverter.java",
      "size_bytes": 816,
      "lines": 19,
      "last_modified": "2025-10-29T20:56:54.536489",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config.converter;\n\nimport com.fuacs.backend.constant.enums.AttendanceMethod;\nimport org.springframework.core.convert.converter.Converter;\nimport org.springframework.lang.NonNull;\n\n/**\n * Spring MVC Converter to handle query parameter conversion from String to AttendanceMethod enum.\n * This allows the API to accept lowercase values (\"auto\", \"manual\", \"system_finalize\") in query parameters,\n * matching the API documentation and JSON body behavior.\n */\npublic class StringToAttendanceMethodConverter implements Converter<String, AttendanceMethod> {\n\n    @Override\n    public AttendanceMethod convert(@NonNull String source) {\n        // Use the existing fromValue method which handles case-insensitive matching\n        return AttendanceMethod.fromValue(source);\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\converter\\StringToAttendanceStatusConverter.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/converter/StringToAttendanceStatusConverter.java",
      "filename": "StringToAttendanceStatusConverter.java",
      "size_bytes": 811,
      "lines": 19,
      "last_modified": "2025-10-29T20:56:54.537490",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config.converter;\n\nimport com.fuacs.backend.constant.enums.AttendanceStatus;\nimport org.springframework.core.convert.converter.Converter;\nimport org.springframework.lang.NonNull;\n\n/**\n * Spring MVC Converter to handle query parameter conversion from String to AttendanceStatus enum.\n * This allows the API to accept lowercase values (\"present\", \"absent\", \"not_yet\") in query parameters,\n * matching the API documentation and JSON body behavior.\n */\npublic class StringToAttendanceStatusConverter implements Converter<String, AttendanceStatus> {\n\n    @Override\n    public AttendanceStatus convert(@NonNull String source) {\n        // Use the existing fromValue method which handles case-insensitive matching\n        return AttendanceStatus.fromValue(source);\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\CustomAuthenticationEntryPoint.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/CustomAuthenticationEntryPoint.java",
      "filename": "CustomAuthenticationEntryPoint.java",
      "size_bytes": 1367,
      "lines": 33,
      "last_modified": "2025-10-29T20:56:54.531220",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.beans.factory.annotation.Qualifier;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Lazy;\nimport org.springframework.security.core.AuthenticationException;\nimport org.springframework.security.web.AuthenticationEntryPoint;\nimport org.springframework.web.servlet.HandlerExceptionResolver;\n\n@Configuration\npublic class CustomAuthenticationEntryPoint implements AuthenticationEntryPoint {\n    Logger log = LoggerFactory.getLogger(CustomAuthenticationEntryPoint.class);\n    private final HandlerExceptionResolver resolver;\n\n    public CustomAuthenticationEntryPoint(\n            @Qualifier(\"handlerExceptionResolver\")\n            @Lazy HandlerExceptionResolver resolver) {\n        this.resolver = resolver;\n    }\n\n    @Override\n    public void commence(HttpServletRequest request,\n                         HttpServletResponse response,\n                         AuthenticationException exception\n    ) {\n        log.error(exception.getMessage(), exception);//TODO: remove in production\n        resolver.resolveException(request, response, null, exception);\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\CustomHandlerMethodConfig.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/CustomHandlerMethodConfig.java",
      "filename": "CustomHandlerMethodConfig.java",
      "size_bytes": 1314,
      "lines": 30,
      "last_modified": "2025-10-29T20:56:54.532221",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport jakarta.annotation.PostConstruct;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.web.method.support.HandlerMethodReturnValueHandler;\nimport org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter;\n\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Objects;\n\n@Configuration\npublic class CustomHandlerMethodConfig {\n    private final CustomHttpStatusSetter customHttpStatusSetter;\n    private final RequestMappingHandlerAdapter requestMappingHandlerAdapter;\n\n    public CustomHandlerMethodConfig(CustomHttpStatusSetter customHttpStatusSetter,\n                                     RequestMappingHandlerAdapter requestMappingHandlerAdapter) {\n        this.customHttpStatusSetter = customHttpStatusSetter;\n        this.requestMappingHandlerAdapter = requestMappingHandlerAdapter;\n    }\n\n    @PostConstruct\n    public void init() {\n        List<HandlerMethodReturnValueHandler> updatedValues = new ArrayList<>();\n        updatedValues.addFirst(customHttpStatusSetter);\n        updatedValues.addAll(Objects.requireNonNull(requestMappingHandlerAdapter.getReturnValueHandlers()));\n        requestMappingHandlerAdapter.setReturnValueHandlers(updatedValues);\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\CustomHttpStatusSetter.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/CustomHttpStatusSetter.java",
      "filename": "CustomHttpStatusSetter.java",
      "size_bytes": 2061,
      "lines": 54,
      "last_modified": "2025-10-29T20:56:54.534265",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport jakarta.servlet.http.HttpServletResponse;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.core.MethodParameter;\nimport org.springframework.http.MediaType;\nimport org.springframework.web.context.request.NativeWebRequest;\nimport org.springframework.web.method.support.HandlerMethodReturnValueHandler;\nimport org.springframework.web.method.support.ModelAndViewContainer;\n\nimport java.io.OutputStream;\n\n@Configuration\npublic class CustomHttpStatusSetter implements HandlerMethodReturnValueHandler {\n\n    private final ObjectMapper objectMapper;\n\n    public CustomHttpStatusSetter(ObjectMapper objectMapper) {\n        this.objectMapper = objectMapper;\n    }\n\n    @Override\n    public boolean supportsReturnType(MethodParameter returnType) {\n        return Response.class.isAssignableFrom(returnType.getParameterType())\n                || PagingResponse.class.isAssignableFrom(returnType.getParameterType());\n    }\n\n    @Override\n    public void handleReturnValue(\n            Object returnValue,\n            MethodParameter returnType,\n            ModelAndViewContainer mavContainer,\n            NativeWebRequest webRequest) throws Exception {\n\n        mavContainer.setRequestHandled(true);\n\n        Response<?> body = (Response<?>) returnValue;\n\n        HttpServletResponse servletResponse = webRequest.getNativeResponse(HttpServletResponse.class);\n        if (body == null || servletResponse == null) return;\n        servletResponse.setStatus(body.getStatus());\n        servletResponse.setContentType(MediaType.APPLICATION_JSON_VALUE);\n\n        try (OutputStream out = servletResponse.getOutputStream()) {\n            objectMapper.writeValue(out, body);\n        }\n        System.out.println(\"[CustomHttpStatusSetter] handled: \" + body.getClass().getSimpleName());\n\n    }\n}\n\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\FaceRecognitionProperties.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/FaceRecognitionProperties.java",
      "filename": "FaceRecognitionProperties.java",
      "size_bytes": 949,
      "lines": 29,
      "last_modified": "2025-11-09T20:27:56.516066",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.context.annotation.Configuration;\n\n/**\n * Configuration properties for face recognition settings.\n * Maps to face-recognition.* properties in application.yaml\n */\n@Configuration\n@ConfigurationProperties(prefix = \"face-recognition\")\npublic class FaceRecognitionProperties {\n\n    /**\n     * Cosine similarity threshold for face matching (0.0 to 1.0)\n     * Higher values = stricter matching\n     * Default: 0.60 (can be overridden via FACE_RECOGNITION_SIMILARITY_THRESHOLD env var)\n     */\n    private Float similarityThreshold = 0.60f;\n\n    // Getters and Setters\n    public Float getSimilarityThreshold() {\n        return similarityThreshold;\n    }\n\n    public void setSimilarityThreshold(Float similarityThreshold) {\n        this.similarityThreshold = similarityThreshold;\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\HttpSecurityConfig.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/HttpSecurityConfig.java",
      "filename": "HttpSecurityConfig.java",
      "size_bytes": 5233,
      "lines": 106,
      "last_modified": "2025-10-31T21:46:35.604629",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.access.PermissionEvaluator;\nimport org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler;\nimport org.springframework.security.access.expression.method.MethodSecurityExpressionHandler;\nimport org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.config.http.SessionCreationPolicy;\nimport org.springframework.security.oauth2.jwt.JwtDecoder;\nimport org.springframework.security.oauth2.jwt.NimbusJwtDecoder;\nimport org.springframework.security.oauth2.server.resource.web.authentication.BearerTokenAuthenticationFilter;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.web.cors.CorsConfiguration;\nimport org.springframework.web.cors.CorsConfigurationSource;\nimport org.springframework.web.cors.UrlBasedCorsConfigurationSource;\n\nimport javax.crypto.spec.SecretKeySpec;\nimport java.util.List;\n\n@EnableWebSecurity\n@EnableMethodSecurity\n@Configuration\npublic class HttpSecurityConfig {\n\n    private final CustomAuthenticationEntryPoint customAuthenticationEntryPoint;\n    private final AuthenticationRequestFilter authenticationRequestFilter;\n    @Value(\"${token.sign-key}\")\n    private String signKey;\n\n    public HttpSecurityConfig(CustomAuthenticationEntryPoint customAuthenticationEntryPoint,\n            AuthenticationRequestFilter authenticationRequestFilter) {\n        this.customAuthenticationEntryPoint = customAuthenticationEntryPoint;\n        this.authenticationRequestFilter = authenticationRequestFilter;\n    }\n\n    @Bean\n    public SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {\n        http\n                .cors(cors -> cors.configurationSource(corsConfigurationSource()))\n\n                .csrf(AbstractHttpConfigurer::disable)\n                .sessionManagement(session -> session\n                        .sessionCreationPolicy(SessionCreationPolicy.STATELESS))\n                .authorizeHttpRequests(authorize -> authorize\n                        .requestMatchers(\n                                \"/ws/**\",\n                                \"/i18n/**\",\n                                \"/favicon.ico\",\n                                \"/error\",\n                                \"/actuator/**\",\n                                \"/swagger-ui.html\",\n                                \"/swagger-ui/**\",\n                                \"/v3/api-docs\",\n                                \"/v3/api-docs/**\",\n                                \"/api/v1/auth/**\",\n                                \"/api/v1/evidence/**\",  // Allow public access to evidence images\n                                \"/api/v1/student-photos/**\",  // Allow public access to student photos\n                                \"/css/**\", \"/js/**\", \"/images/**\",\n                                \"/**\")\n                        .permitAll()\n                        .anyRequest().authenticated())\n                .oauth2ResourceServer(oauth2 -> oauth2\n                        .jwt(jwt -> jwt.decoder(jwtDecoder()))\n                        .authenticationEntryPoint(this.customAuthenticationEntryPoint));\n        http.addFilterAfter(authenticationRequestFilter, BearerTokenAuthenticationFilter.class);\n        return http.build();\n    }\n\n    @Bean\n    public CorsConfigurationSource corsConfigurationSource() {\n        CorsConfiguration configuration = new CorsConfiguration();\n        configuration.setAllowedOrigins(List.of(\"http://localhost:5173\", \"http://localhost:3000\",\n                \"http://localhost:3100\", \"http://localhost:3001\"));\n        configuration.setAllowedMethods(List.of(\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"));\n        configuration.setAllowedHeaders(List.of(\"*\"));\n        configuration.setAllowCredentials(true);\n\n        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();\n        source.registerCorsConfiguration(\"/**\", configuration);\n        return source;\n    }\n\n    @Bean\n    public JwtDecoder jwtDecoder() {\n        return NimbusJwtDecoder\n                .withSecretKey(new SecretKeySpec(signKey.getBytes(), \"HmacSHA256\"))\n                .build();\n    }\n\n    @Bean\n    public PermissionEvaluator permissionEvaluator() {\n        return new PermissionEvaluatorImpl();\n    }\n\n    @Bean\n    public MethodSecurityExpressionHandler expressionHandler(PermissionEvaluator permissionEvaluator) {\n        DefaultMethodSecurityExpressionHandler expressionHandler = new DefaultMethodSecurityExpressionHandler();\n        expressionHandler.setPermissionEvaluator(permissionEvaluator);\n        return expressionHandler;\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\OpenApiConfig.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/OpenApiConfig.java",
      "filename": "OpenApiConfig.java",
      "size_bytes": 1336,
      "lines": 32,
      "last_modified": "2025-10-29T20:56:54.534265",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport io.swagger.v3.oas.models.Components;\nimport io.swagger.v3.oas.models.OpenAPI;\nimport io.swagger.v3.oas.models.info.Info;\nimport io.swagger.v3.oas.models.security.SecurityRequirement;\nimport io.swagger.v3.oas.models.security.SecurityScheme;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\npublic class OpenApiConfig {\n\n    private static final String SECURITY_SCHEME_NAME = \"bearerAuth\";\n\n    @Bean\n    public OpenAPI customOpenAPI() {\n        return new OpenAPI()\n                .info(new Info()\n                        .title(\"FUACS API\")\n                        .version(\"v1.0.0\")\n                        .description(\"FUACS Backend API Documentation\"))\n                .addSecurityItem(new SecurityRequirement().addList(SECURITY_SCHEME_NAME))\n                .components(new Components()\n                        .addSecuritySchemes(SECURITY_SCHEME_NAME,\n                                new SecurityScheme()\n                                        .name(SECURITY_SCHEME_NAME)\n                                        .type(SecurityScheme.Type.HTTP)\n                                        .scheme(\"bearer\")\n                                        .bearerFormat(\"JWT\")));\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\PermissionEvaluatorImpl.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/PermissionEvaluatorImpl.java",
      "filename": "PermissionEvaluatorImpl.java",
      "size_bytes": 1260,
      "lines": 33,
      "last_modified": "2025-10-29T20:56:54.535271",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.exception.BadRequestException;\nimport org.springframework.security.access.PermissionEvaluator;\nimport org.springframework.security.core.Authentication;\n\nimport java.io.Serializable;\nimport java.util.Set;\n\npublic class PermissionEvaluatorImpl implements PermissionEvaluator {\n\n    @Override\n    public boolean hasPermission(Authentication authentication,\n                                 Object targetDomainObject,\n                                 Object permission) {\n        if (!(authentication instanceof UserAuthentication userAuthentication)) {\n            throw new BadRequestException(\"NOT_SUPPORTED_AUTHENTICATION\", ErrorCode.UN_AUTHENTICATION);\n        }\n\n        Set<String> permissions = userAuthentication.getPermissions();\n        return permissions.stream().anyMatch(permission::equals);\n    }\n\n    @Override\n    public boolean hasPermission(Authentication authentication,\n                                 Serializable targetId,\n                                 String targetType,\n                                 Object permission) {\n        return hasPermission(authentication, null, permission);\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\PythonBackendConfig.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/PythonBackendConfig.java",
      "filename": "PythonBackendConfig.java",
      "size_bytes": 1847,
      "lines": 78,
      "last_modified": "2025-10-29T20:56:54.535271",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport org.springframework.boot.context.properties.ConfigurationProperties;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\n@ConfigurationProperties(prefix = \"python.backend\")\npublic class PythonBackendConfig {\n\n    private String url;\n    private String apiKey;\n    private int connectionTimeout;\n    private int readTimeout;\n    private RetryConfig retry;\n\n    // Getters and Setters\n    public String getUrl() {\n        return url;\n    }\n\n    public void setUrl(String url) {\n        this.url = url;\n    }\n\n    public String getApiKey() {\n        return apiKey;\n    }\n\n    public void setApiKey(String apiKey) {\n        this.apiKey = apiKey;\n    }\n\n    public int getConnectionTimeout() {\n        return connectionTimeout;\n    }\n\n    public void setConnectionTimeout(int connectionTimeout) {\n        this.connectionTimeout = connectionTimeout;\n    }\n\n    public int getReadTimeout() {\n        return readTimeout;\n    }\n\n    public void setReadTimeout(int readTimeout) {\n        this.readTimeout = readTimeout;\n    }\n\n    public RetryConfig getRetry() {\n        return retry;\n    }\n\n    public void setRetry(RetryConfig retry) {\n        this.retry = retry;\n    }\n\n    // Nested class for retry config\n    public static class RetryConfig {\n        private int maxAttempts;\n        private long backoffDelay;\n\n        public int getMaxAttempts() {\n            return maxAttempts;\n        }\n\n        public void setMaxAttempts(int maxAttempts) {\n            this.maxAttempts = maxAttempts;\n        }\n\n        public long getBackoffDelay() {\n            return backoffDelay;\n        }\n\n        public void setBackoffDelay(long backoffDelay) {\n            this.backoffDelay = backoffDelay;\n        }\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\RestTemplateConfig.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/RestTemplateConfig.java",
      "filename": "RestTemplateConfig.java",
      "size_bytes": 2132,
      "lines": 49,
      "last_modified": "2025-10-29T20:56:54.535271",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport org.apache.hc.client5.http.impl.classic.CloseableHttpClient;\nimport org.apache.hc.client5.http.impl.classic.HttpClients;\nimport org.springframework.boot.web.client.RestTemplateBuilder;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.http.client.ClientHttpRequestInterceptor;\nimport org.springframework.http.client.HttpComponentsClientHttpRequestFactory;\nimport org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;\nimport org.springframework.web.client.RestTemplate;\n\nimport java.time.Duration;\n\n@Configuration\npublic class RestTemplateConfig {\n\n    private final PythonBackendConfig pythonBackendConfig;\n\n    public RestTemplateConfig(PythonBackendConfig pythonBackendConfig) {\n        this.pythonBackendConfig = pythonBackendConfig;\n    }\n\n    @Bean(name = \"pythonBackendRestTemplate\")\n    public RestTemplate pythonBackendRestTemplate(RestTemplateBuilder builder) {\n        // Create Apache HttpClient (HTTP/1.1 only, no HTTP/2 upgrade)\n        CloseableHttpClient httpClient = HttpClients.createDefault();\n        HttpComponentsClientHttpRequestFactory requestFactory =\n            new HttpComponentsClientHttpRequestFactory(httpClient);\n\n        // Set timeouts\n        requestFactory.setConnectTimeout((int) pythonBackendConfig.getConnectionTimeout());\n        requestFactory.setConnectionRequestTimeout((int) pythonBackendConfig.getReadTimeout());\n\n        return builder\n                .rootUri(pythonBackendConfig.getUrl())\n                .requestFactory(() -> requestFactory)\n                .interceptors(apiKeyInterceptor())\n                .additionalMessageConverters(new MappingJackson2HttpMessageConverter())\n                .build();\n    }\n\n    private ClientHttpRequestInterceptor apiKeyInterceptor() {\n        return (request, body, execution) -> {\n            request.getHeaders().add(\"X-API-Key\", pythonBackendConfig.getApiKey());\n            return execution.execute(request, body);\n        };\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\UserAuthentication.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/UserAuthentication.java",
      "filename": "UserAuthentication.java",
      "size_bytes": 2355,
      "lines": 64,
      "last_modified": "2025-11-11T23:19:48.942242",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.GrantedAuthority;\n\nimport java.util.Collection;\nimport java.util.Set;\nimport java.util.stream.Collectors;\n\npublic class UserAuthentication extends UsernamePasswordAuthenticationToken {\n    private Integer userId;\n\n    public Integer getUserId() {\n        return userId;\n    }\n\n    public UserAuthentication(Object principal,\n                              Object credentials,\n                              Collection<? extends GrantedAuthority> authorities,\n                              Integer userId) {\n        super(principal, credentials, authorities);\n        this.userId = userId;\n    }\n\n    /**\n     * Returns all authorities (both permission names and role names) as strings.\n     * <p>\n     * Note: This includes BOTH permissions (e.g., \"USER_CREATE\", \"SEMESTER_READ\")\n     * and roles (e.g., \"DATA_OPERATOR\", \"LECTURER\", \"STUDENT\").\n     * All values are uppercase.\n     * </p>\n     *\n     * @return Set of authority strings (permissions + roles)\n     */\n    public Set<String> getPermissions() {\n        return getAuthorities().stream()\n                .map(GrantedAuthority::getAuthority)\n                .collect(Collectors.toSet());\n    }\n\n    /**\n     * Check if the user has a specific role.\n     * Role name is case-insensitive and will be converted to uppercase.\n     *\n     * @param roleName The role name to check (e.g., \"STUDENT\", \"DATA_OPERATOR\")\n     * @return true if the user has the role, false otherwise\n     */\n    public boolean hasRole(String roleName) {\n        return getAuthorities().stream()\n                .anyMatch(a -> a.getAuthority().equals(roleName.toUpperCase()));\n    }\n\n    /**\n     * Check if the user has a specific permission.\n     * Permission name is case-insensitive and will be converted to uppercase.\n     *\n     * @param permissionName The permission name to check (e.g., \"USER_CREATE\", \"SEMESTER_READ\")\n     * @return true if the user has the permission, false otherwise\n     */\n    public boolean hasPermission(String permissionName) {\n        return getAuthorities().stream()\n                .anyMatch(a -> a.getAuthority().equals(permissionName.toUpperCase()));\n    }\n}\n"
    },
    {
      "path": "d:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\config\\WebMvcConfig.java",
      "relative_path": "src/main/java/com/fuacs/backend/config/WebMvcConfig.java",
      "filename": "WebMvcConfig.java",
      "size_bytes": 988,
      "lines": 23,
      "last_modified": "2025-10-29T20:56:54.536489",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport com.fuacs.backend.config.converter.StringToAttendanceMethodConverter;\nimport com.fuacs.backend.config.converter.StringToAttendanceStatusConverter;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.format.FormatterRegistry;\nimport org.springframework.web.servlet.config.annotation.WebMvcConfigurer;\n\n/**\n * Web MVC configuration for custom converters.\n * Registers converters for query parameter handling to match API documentation behavior.\n */\n@Configuration\npublic class WebMvcConfig implements WebMvcConfigurer {\n\n    @Override\n    public void addFormatters(FormatterRegistry registry) {\n        // Register custom converters for enum query parameters\n        // These allow lowercase values in query params to match the API docs\n        registry.addConverter(new StringToAttendanceStatusConverter());\n        registry.addConverter(new StringToAttendanceMethodConverter());\n    }\n}\n"
    }
  ]
}