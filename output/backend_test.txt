{
  "metadata": {
    "codebase": "backend",
    "category": "test",
    "generated_at": "2025-12-03T21:12:48.235049",
    "total_files": 12,
    "total_lines": 6475,
    "total_bytes": 268916
  },
  "files": [
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\BackendApplicationTests.java",
      "relative_path": "src/test/java/com/fuacs/backend/BackendApplicationTests.java",
      "filename": "BackendApplicationTests.java",
      "size_bytes": 1032,
      "lines": 28,
      "last_modified": "2025-10-05T20:41:39.868198",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend;\n\nimport org.junit.jupiter.api.Test;\nimport org.springframework.boot.test.context.SpringBootTest;\nimport org.springframework.test.context.DynamicPropertyRegistry;\nimport org.springframework.test.context.DynamicPropertySource;\nimport org.testcontainers.containers.PostgreSQLContainer;\nimport org.testcontainers.junit.jupiter.Container;\nimport org.testcontainers.junit.jupiter.Testcontainers;\n\n@SpringBootTest\n@Testcontainers\nclass BackendApplicationTests {\n\n    @Container\n    static PostgreSQLContainer<?> postgreSQLContainer = new PostgreSQLContainer<>(\"postgres:15-alpine\");\n\n    @DynamicPropertySource\n    static void configureProperties(DynamicPropertyRegistry registry) {\n        registry.add(\"spring.datasource.url\", postgreSQLContainer::getJdbcUrl);\n        registry.add(\"spring.datasource.username\", postgreSQLContainer::getUsername);\n        registry.add(\"spring.datasource.password\", postgreSQLContainer::getPassword);\n    }\n\n    @Test\n    void contextLoads() {\n    }\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\config\\SecurityTestConfig.java",
      "relative_path": "src/test/java/com/fuacs/backend/config/SecurityTestConfig.java",
      "filename": "SecurityTestConfig.java",
      "size_bytes": 1331,
      "lines": 33,
      "last_modified": "2025-11-28T08:56:33.046593",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport org.springframework.boot.test.context.TestConfiguration;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.provisioning.InMemoryUserDetailsManager;\nimport org.springframework.security.web.SecurityFilterChain;\n\n@TestConfiguration\n@EnableWebSecurity\n@EnableMethodSecurity(prePostEnabled = false)\npublic class SecurityTestConfig {\n\n    @Bean\n    public SecurityFilterChain testSecurityFilterChain(HttpSecurity http) throws Exception {\n        http\n                .csrf(AbstractHttpConfigurer::disable)\n                .authorizeHttpRequests(auth -> auth\n                        .anyRequest().permitAll()\n                );\n        return http.build();\n    }\n\n    @Bean\n    public UserDetailsService testUserDetailsService() {\n        return new InMemoryUserDetailsManager();\n    }\n}\n\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\config\\TestConfig.java",
      "relative_path": "src/test/java/com/fuacs/backend/config/TestConfig.java",
      "filename": "TestConfig.java",
      "size_bytes": 1110,
      "lines": 32,
      "last_modified": "2025-11-28T08:56:33.047592",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.SerializationFeature;\nimport com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\nimport org.springframework.boot.test.context.SpringBootTest;\nimport org.springframework.boot.test.context.TestConfiguration;\nimport org.springframework.boot.test.web.client.TestRestTemplate;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Primary;\nimport org.springframework.test.context.TestPropertySource;\n\n@TestConfiguration\n@SpringBootTest\n@TestPropertySource(locations = \"classpath:application-test.properties\")\npublic class TestConfig {\n\n    @Bean\n    @Primary\n    public ObjectMapper objectMapper() {\n        ObjectMapper mapper = new ObjectMapper();\n        mapper.registerModule(new JavaTimeModule());\n        mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);\n        return mapper;\n    }\n\n    @Bean\n    public TestRestTemplate testRestTemplate() {\n        return new TestRestTemplate();\n    }\n}\n\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\config\\TestContainerConfig.java",
      "relative_path": "src/test/java/com/fuacs/backend/config/TestContainerConfig.java",
      "filename": "TestContainerConfig.java",
      "size_bytes": 790,
      "lines": 25,
      "last_modified": "2025-11-28T08:56:33.047592",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport org.springframework.boot.test.context.TestConfiguration;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Primary;\nimport org.springframework.jdbc.datasource.embedded.EmbeddedDatabaseBuilder;\nimport org.springframework.jdbc.datasource.embedded.EmbeddedDatabaseType;\n\nimport javax.sql.DataSource;\n\n@TestConfiguration\npublic class TestContainerConfig {\n\n    @Bean\n    @Primary\n    public DataSource testDataSource() {\n        // Configuration for test database\n        return new EmbeddedDatabaseBuilder()\n                .setType(EmbeddedDatabaseType.H2)\n                .addScript(\"schema.sql\")\n                .addScript(\"test-data.sql\")\n                .build();\n    }\n}\n\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\ClassServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/ClassServiceTest.java",
      "filename": "ClassServiceTest.java",
      "size_bytes": 45792,
      "lines": 1100,
      "last_modified": "2025-11-28T08:56:33.047592",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.constant.ImportMode;\nimport com.fuacs.backend.dto.mapper.ClassMapper;\nimport com.fuacs.backend.dto.mapper.SemesterMapper;\nimport com.fuacs.backend.dto.mapper.SubjectMapper;\nimport com.fuacs.backend.dto.request.ClassCreateRequest;\nimport com.fuacs.backend.dto.request.ClassCsvRow;\nimport com.fuacs.backend.dto.request.ClassSearchRequest;\nimport com.fuacs.backend.dto.request.ClassUpdateRequest;\nimport com.fuacs.backend.dto.response.ClassDTO;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.MajorDTO;\nimport com.fuacs.backend.dto.response.SemesterDTO;\nimport com.fuacs.backend.dto.response.SubjectDTO;\nimport com.fuacs.backend.entity.AcademicClass;\nimport com.fuacs.backend.entity.Major;\nimport com.fuacs.backend.entity.Semester;\nimport com.fuacs.backend.entity.Subject;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.ClassRepository;\nimport com.fuacs.backend.repository.SemesterRepository;\nimport com.fuacs.backend.repository.StaffProfileRepository;\nimport com.fuacs.backend.repository.StudentProfileRepository;\nimport com.fuacs.backend.repository.SubjectRepository;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\nimport org.springframework.dao.DataIntegrityViolationException;\nimport org.springframework.mock.web.MockMultipartFile;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.io.IOException;\nimport java.time.Instant;\nimport java.time.LocalDate;\nimport java.time.LocalDateTime;\nimport java.util.ArrayList;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Optional;\nimport java.util.Set;\n\nimport static org.junit.jupiter.api.Assertions.*;\nimport static org.mockito.ArgumentMatchers.*;\nimport static org.mockito.Mockito.*;\n\nimport org.mockito.junit.jupiter.MockitoSettings;\nimport org.mockito.quality.Strictness;\n\n@ExtendWith(MockitoExtension.class)\n@MockitoSettings(strictness = Strictness.LENIENT)\n@DisplayName(\"ClassService Unit Tests\")\nclass ClassServiceTest {\n\n    @Mock\n    private ClassRepository classRepository;\n\n    @Mock\n    private SubjectRepository subjectRepository;\n\n    @Mock\n    private SemesterRepository semesterRepository;\n\n    @Mock\n    private StudentProfileRepository studentRepository;\n\n    @Mock\n    private StaffProfileRepository staffRepository;\n\n    @Mock\n    private ClassMapper classMapper;\n\n    @Mock\n    private SemesterMapper semesterMapper;\n\n    @Mock\n    private SubjectMapper subjectMapper;\n\n    @Mock\n    private CsvParserService csvParserService;\n\n    @InjectMocks\n    private ClassService classService;\n\n    private AcademicClass testClass;\n    private ClassDTO testClassDTO;\n    private Subject testSubject;\n    private Semester testSemester;\n    private ClassCreateRequest createRequest;\n    private ClassUpdateRequest updateRequest;\n\n    @BeforeEach\n    void setUp() {\n        // Setup test subject\n        testSubject = new Subject();\n        testSubject.setId((short) 1);\n        testSubject.setCode(\"PRJ301\");\n        testSubject.setName(\"Java Web Application Development\");\n        testSubject.setActive(true);\n        testSubject.setCreatedAt(Instant.now());\n        \n        Major major = new Major();\n        major.setId((short) 1);\n        major.setCode(\"SE\");\n        major.setName(\"Software Engineering\");\n        major.setActive(true);\n        testSubject.setMajors(Set.of(major));\n\n        // Setup test semester\n        testSemester = new Semester();\n        testSemester.setId((short) 1);\n        testSemester.setCode(\"FALL2024\");\n        testSemester.setName(\"Fall 2024\");\n        testSemester.setStartDate(LocalDate.of(2024, 9, 1));\n        testSemester.setEndDate(LocalDate.of(2024, 12, 31));\n        testSemester.setActive(true);\n        testSemester.setCreatedAt(Instant.now());\n\n        // Setup test class\n        testClass = new AcademicClass();\n        testClass.setId((short) 1);\n        testClass.setCode(\"SE1801\");\n        testClass.setSubject(testSubject);\n        testClass.setSemester(testSemester);\n        testClass.setActive(true);\n        testClass.setCreatedAt(Instant.now());\n        testClass.setEnrollments(new HashSet<>());\n        testClass.setSlots(new HashSet<>());\n\n        // Setup test DTO\n        testClassDTO = new ClassDTO();\n        testClassDTO.setId((short) 1);\n        testClassDTO.setCode(\"SE1801\");\n        testClassDTO.setActive(true);\n\n        // Setup create request\n        createRequest = createClassCreateRequest(\"SE1802\", (short) 1, (short) 1);\n\n        // Setup update request\n        updateRequest = createClassUpdateRequest(\"SE1801\", (short) 1, (short) 1, true);\n    }\n\n    // Helper method to create ClassCreateRequest using reflection\n    private ClassCreateRequest createClassCreateRequest(String code, Short subjectId, Short semesterId) {\n        try {\n            ClassCreateRequest request = new ClassCreateRequest();\n            setField(request, \"code\", code);\n            setField(request, \"subjectId\", subjectId);\n            setField(request, \"semesterId\", semesterId);\n            return request;\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    // Helper method to create ClassUpdateRequest using reflection\n    private ClassUpdateRequest createClassUpdateRequest(String code, Short subjectId, Short semesterId, Boolean isActive) {\n        try {\n            ClassUpdateRequest request = new ClassUpdateRequest();\n            setField(request, \"code\", code);\n            setField(request, \"subjectId\", subjectId);\n            setField(request, \"semesterId\", semesterId);\n            setField(request, \"isActive\", isActive);\n            return request;\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    // Helper method to set field using reflection\n    private void setField(Object obj, String fieldName, Object value) throws Exception {\n        Class<?> clazz = obj.getClass();\n        while (clazz != null) {\n            try {\n                java.lang.reflect.Field field = clazz.getDeclaredField(fieldName);\n                field.setAccessible(true);\n                field.set(obj, value);\n                return;\n            } catch (NoSuchFieldException e) {\n                clazz = clazz.getSuperclass();\n            }\n        }\n        throw new NoSuchFieldException(fieldName);\n    }\n\n    // ==================== SEARCH TESTS ====================\n\n    @Test\n    @DisplayName(\"TC01: Search classes successfully\")\n    void testSearch_Success() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        List<ClassDTO> expectedList = List.of(testClassDTO);\n        when(classRepository.search(searchRequest)).thenReturn(expectedList);\n\n        // Act\n        List<ClassDTO> result = classService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(classRepository, times(1)).search(searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC02: Search returns empty list\")\n    void testSearch_EmptyResult() {\n        // Arrange\n        ClassSearchRequest searchRequest = new ClassSearchRequest(null, null, null, null, null, null, null, null, null, null);\n        when(classRepository.search(searchRequest)).thenReturn(new ArrayList<>());\n\n        // Act\n        List<ClassDTO> result = classService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertTrue(result.isEmpty());\n        verify(classRepository, times(1)).search(searchRequest);\n    }\n\n    // Helper method to create ClassSearchRequest\n    private ClassSearchRequest createSearchRequest() {\n        return new ClassSearchRequest(null, null, null, null, null, null, null, null, null, null);\n    }\n\n    // ==================== COUNT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC03: Count classes successfully\")\n    void testCount_Success() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(classRepository.count(searchRequest)).thenReturn(5L);\n\n        // Act\n        Long result = classService.count(searchRequest);\n\n        // Assert\n        assertEquals(5L, result);\n        verify(classRepository, times(1)).count(searchRequest);\n    }\n\n    // ==================== FIND BY ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC04: Find class by ID successfully\")\n    void testFindById_Success() {\n        // Arrange\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classMapper.toDTO(testClass)).thenReturn(testClassDTO);\n        when(classRepository.countAllStudentsByClassId((short) 1)).thenReturn(10L);\n        when(classRepository.countEnrolledStudentsByClassId((short) 1)).thenReturn(8L);\n        when(classRepository.countAllSlotsByClassId((short) 1)).thenReturn(15L);\n        when(classRepository.countActiveSlotsByClassId((short) 1)).thenReturn(12L);\n\n        // Act\n        ClassDTO result = classService.findById((short) 1);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals((short) 1, result.getId());\n        assertEquals(\"SE1801\", result.getCode());\n        verify(classRepository, times(1)).findById((short) 1);\n    }\n\n    @Test\n    @DisplayName(\"TC05: Find class by ID - not found\")\n    void testFindById_NotFound() {\n        // Arrange\n        when(classRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.findById((short) 999)\n        );\n        assertEquals(ErrorCode.CLASS_NOT_FOUND, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"999\"));\n    }\n\n    // ==================== CREATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC06: Create class successfully\")\n    void testCreate_Success() {\n        // Arrange\n        AcademicClass newClass = new AcademicClass();\n        newClass.setCode(\"SE1802\");\n        newClass.setSubject(testSubject);\n        newClass.setSemester(testSemester);\n        newClass.setActive(true);\n\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterId(\n            createRequest.getCode(), createRequest.getSubjectId(), createRequest.getSemesterId())).thenReturn(false);\n        when(subjectRepository.findById(createRequest.getSubjectId())).thenReturn(Optional.of(testSubject));\n        when(semesterRepository.findById(createRequest.getSemesterId())).thenReturn(Optional.of(testSemester));\n        when(classMapper.toEntity(createRequest)).thenReturn(newClass);\n        when(classRepository.save(any(AcademicClass.class))).thenReturn(newClass);\n        when(classMapper.toDTO(newClass)).thenReturn(testClassDTO);\n        when(semesterMapper.toDTO(testSemester)).thenReturn(new SemesterDTO());\n\n        // Act\n        ClassDTO result = classService.create(createRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(classRepository, times(1)).save(any(AcademicClass.class));\n    }\n\n    @Test\n    @DisplayName(\"TC07: Create class - already exists\")\n    void testCreate_AlreadyExists() {\n        // Arrange\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterId(\n            createRequest.getCode(), createRequest.getSubjectId(), createRequest.getSemesterId())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> classService.create(createRequest)\n        );\n        assertEquals(ErrorCode.CLASS_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC08: Create class - subject not found\")\n    void testCreate_SubjectNotFound() {\n        // Arrange\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterId(\n            createRequest.getCode(), createRequest.getSubjectId(), createRequest.getSemesterId())).thenReturn(false);\n        when(subjectRepository.findById(createRequest.getSubjectId())).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.create(createRequest)\n        );\n        assertEquals(ErrorCode.SUBJECT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC09: Create class - semester not found\")\n    void testCreate_SemesterNotFound() {\n        // Arrange\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterId(\n            createRequest.getCode(), createRequest.getSubjectId(), createRequest.getSemesterId())).thenReturn(false);\n        when(subjectRepository.findById(createRequest.getSubjectId())).thenReturn(Optional.of(testSubject));\n        when(semesterRepository.findById(createRequest.getSemesterId())).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.create(createRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC10: Create class - inactive subject\")\n    void testCreate_InactiveSubject() {\n        // Arrange\n        testSubject.setActive(false);\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterId(\n            createRequest.getCode(), createRequest.getSubjectId(), createRequest.getSemesterId())).thenReturn(false);\n        when(subjectRepository.findById(createRequest.getSubjectId())).thenReturn(Optional.of(testSubject));\n        when(semesterRepository.findById(createRequest.getSemesterId())).thenReturn(Optional.of(testSemester));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> classService.create(createRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_REFERENCE_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC11: Create class - inactive semester\")\n    void testCreate_InactiveSemester() {\n        // Arrange\n        testSemester.setActive(false);\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterId(\n            createRequest.getCode(), createRequest.getSubjectId(), createRequest.getSemesterId())).thenReturn(false);\n        when(subjectRepository.findById(createRequest.getSubjectId())).thenReturn(Optional.of(testSubject));\n        when(semesterRepository.findById(createRequest.getSemesterId())).thenReturn(Optional.of(testSemester));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> classService.create(createRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_REFERENCE_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    // ==================== UPDATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC12: Update class successfully\")\n    void testUpdate_Success() {\n        // Arrange\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterIdAndIdNot(\n            updateRequest.getCode(), updateRequest.getSubjectId(), updateRequest.getSemesterId(), (short) 1)).thenReturn(false);\n        when(subjectRepository.findById(updateRequest.getSubjectId())).thenReturn(Optional.of(testSubject));\n        when(semesterRepository.findById(updateRequest.getSemesterId())).thenReturn(Optional.of(testSemester));\n        when(classRepository.save(testClass)).thenReturn(testClass);\n        when(classMapper.toDTO(testClass)).thenReturn(testClassDTO);\n        when(semesterMapper.toDTO(testSemester)).thenReturn(new SemesterDTO());\n\n        // Act\n        ClassDTO result = classService.update((short) 1, updateRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(classMapper, times(1)).updateClassFromRequest(updateRequest, testClass);\n        verify(classRepository, times(1)).save(testClass);\n    }\n\n    @Test\n    @DisplayName(\"TC13: Update class - not found\")\n    void testUpdate_NotFound() {\n        // Arrange\n        when(classRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.update((short) 999, updateRequest)\n        );\n        assertEquals(ErrorCode.CLASS_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC14: Update class - code already exists\")\n    void testUpdate_CodeExists() {\n        // Arrange\n        updateRequest.setCode(\"SE1803\");\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterIdAndIdNot(\n            updateRequest.getCode(), updateRequest.getSubjectId(), updateRequest.getSemesterId(), (short) 1)).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> classService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.CLASS_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC15: Update class - subject not found\")\n    void testUpdate_SubjectNotFound() {\n        // Arrange\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterIdAndIdNot(\n            updateRequest.getCode(), updateRequest.getSubjectId(), updateRequest.getSemesterId(), (short) 1)).thenReturn(false);\n        when(subjectRepository.findById(updateRequest.getSubjectId())).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.SUBJECT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC16: Update class - semester not found\")\n    void testUpdate_SemesterNotFound() {\n        // Arrange\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterIdAndIdNot(\n            updateRequest.getCode(), updateRequest.getSubjectId(), updateRequest.getSemesterId(), (short) 1)).thenReturn(false);\n        when(subjectRepository.findById(updateRequest.getSubjectId())).thenReturn(Optional.of(testSubject));\n        when(semesterRepository.findById(updateRequest.getSemesterId())).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC17: Update class - inactive subject\")\n    void testUpdate_InactiveSubject() {\n        // Arrange\n        testSubject.setActive(false);\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterIdAndIdNot(\n            updateRequest.getCode(), updateRequest.getSubjectId(), updateRequest.getSemesterId(), (short) 1)).thenReturn(false);\n        when(subjectRepository.findById(updateRequest.getSubjectId())).thenReturn(Optional.of(testSubject));\n        when(semesterRepository.findById(updateRequest.getSemesterId())).thenReturn(Optional.of(testSemester));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> classService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_REFERENCE_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC18: Update class - inactive semester\")\n    void testUpdate_InactiveSemester() {\n        // Arrange\n        testSemester.setActive(false);\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterIdAndIdNot(\n            updateRequest.getCode(), updateRequest.getSubjectId(), updateRequest.getSemesterId(), (short) 1)).thenReturn(false);\n        when(subjectRepository.findById(updateRequest.getSubjectId())).thenReturn(Optional.of(testSubject));\n        when(semesterRepository.findById(updateRequest.getSemesterId())).thenReturn(Optional.of(testSemester));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> classService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_REFERENCE_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC19: Update class - deactivate before last slot ends\")\n    void testUpdate_DeactivateBeforeLastSlotEnds() {\n        // Arrange\n        testClass.setActive(true);\n        updateRequest.setActive(false);\n        LocalDateTime futureTime = LocalDateTime.now().plusDays(5);\n        \n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.existsByCodeAndSubjectIdAndSemesterIdAndIdNot(\n            updateRequest.getCode(), updateRequest.getSubjectId(), updateRequest.getSemesterId(), (short) 1)).thenReturn(false);\n        when(subjectRepository.findById(updateRequest.getSubjectId())).thenReturn(Optional.of(testSubject));\n        when(semesterRepository.findById(updateRequest.getSemesterId())).thenReturn(Optional.of(testSemester));\n        when(classRepository.findLastActiveSlotEndTimeByClassId((short) 1)).thenReturn(futureTime);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> classService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.CLASS_NOT_FINISHED, exception.getErrorCode());\n    }\n\n    // ==================== DELETE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC20: Delete class successfully\")\n    void testDelete_Success() {\n        // Arrange\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.countAllSlotsByClassId((short) 1)).thenReturn(0L);\n        when(classRepository.countAllStudentsByClassId((short) 1)).thenReturn(0L);\n        doNothing().when(classRepository).deleteById((short) 1);\n\n        // Act\n        classService.delete((short) 1);\n\n        // Assert\n        verify(classRepository, times(1)).deleteById((short) 1);\n    }\n\n    @Test\n    @DisplayName(\"TC21: Delete class - not found\")\n    void testDelete_NotFound() {\n        // Arrange\n        when(classRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.delete((short) 999)\n        );\n        assertEquals(ErrorCode.CLASS_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC22: Delete class - has slots\")\n    void testDelete_HasSlots() {\n        // Arrange\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.countAllSlotsByClassId((short) 1)).thenReturn(5L);\n        when(classRepository.countAllStudentsByClassId((short) 1)).thenReturn(0L);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> classService.delete((short) 1)\n        );\n        assertEquals(ErrorCode.CLASS_HAS_DEPENDENCIES, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"5\"));\n    }\n\n    @Test\n    @DisplayName(\"TC23: Delete class - has enrollments\")\n    void testDelete_HasEnrollments() {\n        // Arrange\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.countAllSlotsByClassId((short) 1)).thenReturn(0L);\n        when(classRepository.countAllStudentsByClassId((short) 1)).thenReturn(10L);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> classService.delete((short) 1)\n        );\n        assertEquals(ErrorCode.CLASS_HAS_DEPENDENCIES, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"10\"));\n    }\n\n    @Test\n    @DisplayName(\"TC24: Delete class - foreign key constraint violation\")\n    void testDelete_ForeignKeyConstraint() {\n        // Arrange\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.countAllSlotsByClassId((short) 1)).thenReturn(0L);\n        when(classRepository.countAllStudentsByClassId((short) 1)).thenReturn(0L);\n        doThrow(new DataIntegrityViolationException(\"FK constraint\")).when(classRepository).deleteById((short) 1);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> classService.delete((short) 1)\n        );\n        assertEquals(ErrorCode.CLASS_HAS_DEPENDENCIES, exception.getErrorCode());\n    }\n\n    // ==================== SEARCH BY SEMESTER TESTS ====================\n\n    @Test\n    @DisplayName(\"TC25: Search classes by semester ID successfully\")\n    void testSearchClassBySemesterId_Success() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        List<ClassDTO> expectedList = List.of(testClassDTO);\n        when(semesterRepository.existsById((short) 1)).thenReturn(true);\n        when(classRepository.searchClassBySemesterId((short) 1, searchRequest)).thenReturn(expectedList);\n\n        // Act\n        List<ClassDTO> result = classService.searchClassBySemesterId((short) 1, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(classRepository, times(1)).searchClassBySemesterId((short) 1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC26: Search classes by semester ID - semester not found\")\n    void testSearchClassBySemesterId_SemesterNotFound() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(semesterRepository.existsById((short) 999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.searchClassBySemesterId((short) 999, searchRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC27: Count classes by semester ID successfully\")\n    void testCountBySemesterId_Success() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(classRepository.countBySemesterId((short) 1, searchRequest)).thenReturn(5L);\n\n        // Act\n        Long result = classService.countBySemesterId((short) 1, searchRequest);\n\n        // Assert\n        assertEquals(5L, result);\n        verify(classRepository, times(1)).countBySemesterId((short) 1, searchRequest);\n    }\n\n    // ==================== SEARCH BY SUBJECT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC28: Search classes by subject ID successfully\")\n    void testSearchClassBySubjectId_Success() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        List<ClassDTO> expectedList = List.of(testClassDTO);\n        when(subjectRepository.existsById((short) 1)).thenReturn(true);\n        when(classRepository.searchClassBySubjectId((short) 1, searchRequest)).thenReturn(expectedList);\n\n        // Act\n        List<ClassDTO> result = classService.searchClassBySubjectId((short) 1, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(classRepository, times(1)).searchClassBySubjectId((short) 1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC29: Search classes by subject ID - subject not found\")\n    void testSearchClassBySubjectId_SubjectNotFound() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(subjectRepository.existsById((short) 999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.searchClassBySubjectId((short) 999, searchRequest)\n        );\n        assertEquals(ErrorCode.SUBJECT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC30: Count classes by subject ID successfully\")\n    void testCountBySubjectId_Success() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(classRepository.countBySubjectId((short) 1, searchRequest)).thenReturn(3L);\n\n        // Act\n        Long result = classService.countBySubjectId((short) 1, searchRequest);\n\n        // Assert\n        assertEquals(3L, result);\n        verify(classRepository, times(1)).countBySubjectId((short) 1, searchRequest);\n    }\n\n    // ==================== SEARCH BY STUDENT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC31: Search classes by student ID successfully\")\n    void testSearchClassesByStudentId_Success() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        List<ClassDTO> expectedList = List.of(testClassDTO);\n        when(studentRepository.existsById(1)).thenReturn(true);\n        when(classRepository.searchClassesByStudentId(1, searchRequest)).thenReturn(expectedList);\n\n        // Act\n        List<ClassDTO> result = classService.searchClassesByStudentId(1, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(classRepository, times(1)).searchClassesByStudentId(1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC32: Search classes by student ID - student not found\")\n    void testSearchClassesByStudentId_StudentNotFound() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(studentRepository.existsById(999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.searchClassesByStudentId(999, searchRequest)\n        );\n        assertEquals(ErrorCode.STUDENT_PROFILE_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC33: Count classes by student ID successfully\")\n    void testCountClassesByStudentId_Success() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(studentRepository.existsById(1)).thenReturn(true);\n        when(classRepository.countClassesByStudentId(1, searchRequest)).thenReturn(4L);\n\n        // Act\n        Long result = classService.countClassesByStudentId(1, searchRequest);\n\n        // Assert\n        assertEquals(4L, result);\n        verify(classRepository, times(1)).countClassesByStudentId(1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC34: Count classes by student ID - student not found\")\n    void testCountClassesByStudentId_StudentNotFound() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(studentRepository.existsById(999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.countClassesByStudentId(999, searchRequest)\n        );\n        assertEquals(ErrorCode.STUDENT_PROFILE_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== SEARCH BY STAFF TESTS ====================\n\n    @Test\n    @DisplayName(\"TC35: Search classes by staff ID successfully\")\n    void testSearchClassesByStaffId_Success() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        List<ClassDTO> expectedList = List.of(testClassDTO);\n        when(staffRepository.existsById(1)).thenReturn(true);\n        when(classRepository.searchClassesByStaffId(1, searchRequest)).thenReturn(expectedList);\n\n        // Act\n        List<ClassDTO> result = classService.searchClassesByStaffId(1, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(classRepository, times(1)).searchClassesByStaffId(1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC36: Search classes by staff ID - staff not found\")\n    void testSearchClassesByStaffId_StaffNotFound() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(staffRepository.existsById(999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.searchClassesByStaffId(999, searchRequest)\n        );\n        assertEquals(ErrorCode.STAFF_PROFILE_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC37: Count classes by staff ID successfully\")\n    void testCountClassesByStaffId_Success() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(staffRepository.existsById(1)).thenReturn(true);\n        when(classRepository.countClassesByStaffId(1, searchRequest)).thenReturn(6L);\n\n        // Act\n        Long result = classService.countClassesByStaffId(1, searchRequest);\n\n        // Assert\n        assertEquals(6L, result);\n        verify(classRepository, times(1)).countClassesByStaffId(1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC38: Count classes by staff ID - staff not found\")\n    void testCountClassesByStaffId_StaffNotFound() {\n        // Arrange\n        ClassSearchRequest searchRequest = createSearchRequest();\n        when(staffRepository.existsById(999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.countClassesByStaffId(999, searchRequest)\n        );\n        assertEquals(ErrorCode.STAFF_PROFILE_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== GET CLASS DETAILS FOR ROSTER TESTS ====================\n\n    @Test\n    @DisplayName(\"TC39: Get class details for roster successfully\")\n    void testGetClassDetailsForRoster_Success() {\n        // Arrange\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n\n        // Act\n        ClassDTO result = classService.getClassDetailsForRoster((short) 1);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals((short) 1, result.getId());\n        assertEquals(\"SE1801\", result.getCode());\n        assertNotNull(result.getSubject());\n        assertNotNull(result.getSemester());\n        verify(classRepository, times(1)).findById((short) 1);\n    }\n\n    @Test\n    @DisplayName(\"TC40: Get class details for roster - not found\")\n    void testGetClassDetailsForRoster_NotFound() {\n        // Arrange\n        when(classRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> classService.getClassDetailsForRoster((short) 999)\n        );\n        assertEquals(ErrorCode.CLASS_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== IMPORT CSV TESTS ====================\n\n    @Test\n    @DisplayName(\"TC41: Import CSV - AddOnly mode success\")\n    void testImportFromCsv_AddOnly_Success() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<ClassCsvRow> rows = new ArrayList<>();\n        ClassCsvRow row = new ClassCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"SE1803\");\n        row.setSubjectCode(\"PRJ301\");\n        row.setSemesterCode(\"FALL2024\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseClassCsv(file)).thenReturn(rows);\n        when(subjectRepository.findByCode(\"PRJ301\")).thenReturn(testSubject);\n        when(semesterRepository.findByCode(\"FALL2024\")).thenReturn(testSemester);\n        when(classRepository.findByCodeAndSubjectIdAndSemesterId(\"SE1803\", (short) 1, (short) 1)).thenReturn(null);\n        when(classRepository.save(any(AcademicClass.class))).thenReturn(testClass);\n\n        // Act\n        ImportResultDTO result = classService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC42: Import CSV - invalid mode\")\n    void testImportFromCsv_InvalidMode() {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n\n        // Act & Assert - ImportMode.fromString throws IllegalArgumentException for invalid mode\n        IllegalArgumentException exception = assertThrows(\n            IllegalArgumentException.class,\n            () -> classService.importFromCsv(file, \"InvalidMode\")\n        );\n        assertTrue(exception.getMessage().contains(\"Invalid import mode\"));\n    }\n\n    @Test\n    @DisplayName(\"TC43: Import CSV - file processing error\")\n    void testImportFromCsv_FileProcessingError() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        when(csvParserService.parseClassCsv(file)).thenThrow(new IOException(\"File error\"));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> classService.importFromCsv(file, \"AddOnly\")\n        );\n        assertEquals(ErrorCode.FILE_PROCESSING_ERROR, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC44: Import CSV - AddAndUpdate mode updates existing\")\n    void testImportFromCsv_AddAndUpdate_UpdatesExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<ClassCsvRow> rows = new ArrayList<>();\n        ClassCsvRow row = new ClassCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"SE1801\");\n        row.setSubjectCode(\"PRJ301\");\n        row.setSemesterCode(\"FALL2024\");\n        row.setIsActive(false);\n        rows.add(row);\n\n        when(csvParserService.parseClassCsv(file)).thenReturn(rows);\n        when(subjectRepository.findByCode(\"PRJ301\")).thenReturn(testSubject);\n        when(semesterRepository.findByCode(\"FALL2024\")).thenReturn(testSemester);\n        when(classRepository.findByCodeAndSubjectIdAndSemesterId(\"SE1801\", (short) 1, (short) 1)).thenReturn(testClass);\n        when(classRepository.save(any(AcademicClass.class))).thenReturn(testClass);\n\n        // Act\n        ImportResultDTO result = classService.importFromCsv(file, \"AddAndUpdate\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC45: Import CSV - AddOnly mode fails on existing code\")\n    void testImportFromCsv_AddOnly_FailsOnExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<ClassCsvRow> rows = new ArrayList<>();\n        ClassCsvRow row = new ClassCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"SE1801\");\n        row.setSubjectCode(\"PRJ301\");\n        row.setSemesterCode(\"FALL2024\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseClassCsv(file)).thenReturn(rows);\n        when(subjectRepository.findByCode(\"PRJ301\")).thenReturn(testSubject);\n        when(semesterRepository.findByCode(\"FALL2024\")).thenReturn(testSemester);\n        when(classRepository.findByCodeAndSubjectIdAndSemesterId(\"SE1801\", (short) 1, (short) 1)).thenReturn(testClass);\n\n        // Act\n        ImportResultDTO result = classService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(1, result.getErrors().size());\n        assertEquals(ErrorCode.CLASS_EXISTS, result.getErrors().get(0).getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC46: Import CSV - subject not found\")\n    void testImportFromCsv_SubjectNotFound() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<ClassCsvRow> rows = new ArrayList<>();\n        ClassCsvRow row = new ClassCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"SE1803\");\n        row.setSubjectCode(\"INVALID\");\n        row.setSemesterCode(\"FALL2024\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseClassCsv(file)).thenReturn(rows);\n        when(subjectRepository.findByCode(\"INVALID\")).thenReturn(null);\n\n        // Act\n        ImportResultDTO result = classService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(ErrorCode.SUBJECT_NOT_FOUND, result.getErrors().get(0).getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC47: Import CSV - semester not found\")\n    void testImportFromCsv_SemesterNotFound() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<ClassCsvRow> rows = new ArrayList<>();\n        ClassCsvRow row = new ClassCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"SE1803\");\n        row.setSubjectCode(\"PRJ301\");\n        row.setSemesterCode(\"INVALID\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseClassCsv(file)).thenReturn(rows);\n        when(subjectRepository.findByCode(\"PRJ301\")).thenReturn(testSubject);\n        when(semesterRepository.findByCode(\"INVALID\")).thenReturn(null);\n\n        // Act\n        ImportResultDTO result = classService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(ErrorCode.SEMESTER_NOT_FOUND, result.getErrors().get(0).getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC48: Import CSV - validation error in row\")\n    void testImportFromCsv_ValidationError() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<ClassCsvRow> rows = new ArrayList<>();\n        ClassCsvRow row = new ClassCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"\"); // Empty code will trigger validation error\n        row.setSubjectCode(\"PRJ301\");\n        row.setSemesterCode(\"FALL2024\");\n        rows.add(row);\n\n        when(csvParserService.parseClassCsv(file)).thenReturn(rows);\n\n        // Act\n        ImportResultDTO result = classService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(ErrorCode.INVALID_FIELD_FORMAT, result.getErrors().get(0).getErrorCode());\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\ExamSlotServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/ExamSlotServiceTest.java",
      "filename": "ExamSlotServiceTest.java",
      "size_bytes": 42493,
      "lines": 967,
      "last_modified": "2025-11-28T08:56:33.047592",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.constant.enums.AttendanceMethod;\nimport com.fuacs.backend.constant.enums.AttendanceStatus;\nimport com.fuacs.backend.constant.enums.SlotCategory;\nimport com.fuacs.backend.dto.mapper.SlotMapper;\nimport com.fuacs.backend.dto.request.ExamSlotParticipantAllSearchRequest;\nimport com.fuacs.backend.dto.request.ExamSlotParticipantCreateRequest;\nimport com.fuacs.backend.dto.request.ExamSlotParticipantSearchRequest;\nimport com.fuacs.backend.dto.request.ExamSlotParticipantUpdateRequest;\nimport com.fuacs.backend.dto.request.ExamSlotSubjectAssignRequest;\nimport com.fuacs.backend.dto.request.PagedRequest;\nimport com.fuacs.backend.dto.response.ExamSlotParticipantDTO;\nimport com.fuacs.backend.dto.response.ExamSlotParticipantsAllResponse;\nimport com.fuacs.backend.dto.response.ExamSlotParticipantsResponse;\nimport com.fuacs.backend.dto.response.ExamSlotSubjectsResponse;\nimport com.fuacs.backend.dto.response.SubjectDTO;\nimport com.fuacs.backend.entity.*;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.*;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\n\nimport java.time.Instant;\nimport java.time.LocalDate;\nimport java.time.LocalDateTime;\nimport java.time.ZoneId;\nimport java.util.*;\n\nimport static org.junit.jupiter.api.Assertions.*;\nimport static org.mockito.ArgumentMatchers.*;\nimport static org.mockito.Mockito.*;\n\n@ExtendWith(MockitoExtension.class)\n@DisplayName(\"ExamSlotService Unit Tests\")\nclass ExamSlotServiceTest {\n\n    @Mock\n    private ExamSlotSubjectRepository examSlotSubjectRepository;\n    @Mock\n    private ExamSlotParticipantRepository examSlotParticipantRepository;\n    @Mock\n    private SlotRepository slotRepository;\n    @Mock\n    private SubjectRepository subjectRepository;\n    @Mock\n    private UserRepository userRepository;\n    @Mock\n    private EnrollmentRepository enrollmentRepository;\n    @Mock\n    private ExamAttendanceRepository examAttendanceRepository;\n    @Mock\n    private SlotMapper slotMapper;\n\n    @InjectMocks\n    private ExamSlotService examSlotService;\n\n    private Slot testExamSlot;\n    private Subject testSubject;\n    private User testStudent;\n    private User testAdmin;\n    private ExamSlotSubject testExamSlotSubject;\n    private ExamSlotParticipant testParticipant;\n    private Semester testSemester;\n\n    @BeforeEach\n    void setUp() {\n        // Setup test semester\n        testSemester = new Semester();\n        testSemester.setId((short) 1);\n        testSemester.setCode(\"FALL2024\");\n        testSemester.setName(\"Fall 2024\");\n        testSemester.setStartDate(LocalDate.of(2024, 9, 1));\n        testSemester.setEndDate(LocalDate.of(2024, 12, 31));\n        testSemester.setActive(true);\n\n        // Setup test exam slot (FINAL_EXAM with no class)\n        testExamSlot = new Slot();\n        testExamSlot.setId(1);\n        testExamSlot.setTitle(\"Final Exam Slot\");\n        testExamSlot.setSlotCategory(SlotCategory.FINAL_EXAM);\n        testExamSlot.setStartTime(LocalDateTime.now(ZoneId.of(\"Asia/Ho_Chi_Minh\")).plusDays(7));\n        testExamSlot.setEndTime(LocalDateTime.now(ZoneId.of(\"Asia/Ho_Chi_Minh\")).plusDays(7).plusHours(2));\n        testExamSlot.setAcademicClass(null); // FINAL_EXAM has no class\n        testExamSlot.setSemester(testSemester);\n        testExamSlot.setActive(true);\n\n        // Setup test subject\n        testSubject = new Subject();\n        testSubject.setId((short) 1);\n        testSubject.setCode(\"PRJ301\");\n        testSubject.setName(\"Java Web Application\");\n        testSubject.setActive(true);\n\n        // Setup test student\n        testStudent = new User();\n        testStudent.setId(100);\n        testStudent.setUsername(\"student1\");\n        testStudent.setActive(true);\n        com.fuacs.backend.entity.Role studentRole = new com.fuacs.backend.entity.Role();\n        studentRole.setName(\"STUDENT\");\n        testStudent.setRoles(Set.of(studentRole));\n\n        // Setup test admin\n        testAdmin = new User();\n        testAdmin.setId(1);\n        testAdmin.setUsername(\"admin1\");\n        testAdmin.setActive(true);\n\n        // Setup test ExamSlotSubject\n        testExamSlotSubject = new ExamSlotSubject();\n        testExamSlotSubject.setId(1L);\n        testExamSlotSubject.setSlot(testExamSlot);\n        testExamSlotSubject.setSubject(testSubject);\n        testExamSlotSubject.setIsActive(true);\n\n        // Setup test ExamSlotParticipant\n        testParticipant = new ExamSlotParticipant();\n        testParticipant.setId(1L);\n        testParticipant.setExamSlotSubject(testExamSlotSubject);\n        testParticipant.setStudentUser(testStudent);\n        testParticipant.setIsEnrolled(true);\n    }\n\n    // ==================== ASSIGN SUBJECTS TESTS ====================\n\n    @Test\n    @DisplayName(\"TC01: Assign subjects to exam slot successfully\")\n    void testAssignSubjectsToSlot_Success() {\n        // Arrange\n        ExamSlotSubjectAssignRequest request = new ExamSlotSubjectAssignRequest();\n        request.setSubjectIds(List.of(1));\n\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(subjectRepository.findById((short) 1)).thenReturn(Optional.of(testSubject));\n        when(examSlotSubjectRepository.existsBySlotIdAndSubjectIdAndIsActiveTrue(1, 1)).thenReturn(false);\n        when(examSlotSubjectRepository.save(any(ExamSlotSubject.class))).thenReturn(testExamSlotSubject);\n        when(examSlotSubjectRepository.findSubjectsBySlotId(1)).thenReturn(List.of(new SubjectDTO()));\n\n        // Act\n        ExamSlotSubjectsResponse result = examSlotService.assignSubjectsToSlot(1, request);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getAssignedCount());\n        verify(examSlotSubjectRepository, times(1)).save(any(ExamSlotSubject.class));\n    }\n\n    @Test\n    @DisplayName(\"TC02: Assign subjects - slot not found\")\n    void testAssignSubjectsToSlot_SlotNotFound() {\n        // Arrange\n        ExamSlotSubjectAssignRequest request = new ExamSlotSubjectAssignRequest();\n        request.setSubjectIds(List.of(1));\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.assignSubjectsToSlot(999, request)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC03: Assign subjects - invalid slot type (not FINAL_EXAM)\")\n    void testAssignSubjectsToSlot_InvalidSlotType() {\n        // Arrange\n        testExamSlot.setSlotCategory(SlotCategory.LECTURE);\n        ExamSlotSubjectAssignRequest request = new ExamSlotSubjectAssignRequest();\n        request.setSubjectIds(List.of(1));\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.assignSubjectsToSlot(1, request)\n        );\n        assertEquals(ErrorCode.INVALID_SLOT_TYPE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC04: Assign subjects - slot has class assigned\")\n    void testAssignSubjectsToSlot_SlotHasClass() {\n        // Arrange\n        AcademicClass testClass = new AcademicClass();\n        testClass.setId((short) 1);\n        testExamSlot.setAcademicClass(testClass);\n        ExamSlotSubjectAssignRequest request = new ExamSlotSubjectAssignRequest();\n        request.setSubjectIds(List.of(1));\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.assignSubjectsToSlot(1, request)\n        );\n        assertEquals(ErrorCode.INVALID_SLOT_TYPE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC05: Assign subjects - inactive slot\")\n    void testAssignSubjectsToSlot_InactiveSlot() {\n        // Arrange\n        testExamSlot.setActive(false);\n        ExamSlotSubjectAssignRequest request = new ExamSlotSubjectAssignRequest();\n        request.setSubjectIds(List.of(1));\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.assignSubjectsToSlot(1, request)\n        );\n        assertEquals(ErrorCode.INACTIVE_SLOT_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC06: Assign subjects - subject not found\")\n    void testAssignSubjectsToSlot_SubjectNotFound() {\n        // Arrange\n        ExamSlotSubjectAssignRequest request = new ExamSlotSubjectAssignRequest();\n        request.setSubjectIds(List.of(999));\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(subjectRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.assignSubjectsToSlot(1, request)\n        );\n        assertEquals(ErrorCode.SUBJECT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC07: Assign subjects - inactive subject\")\n    void testAssignSubjectsToSlot_InactiveSubject() {\n        // Arrange\n        testSubject.setActive(false);\n        ExamSlotSubjectAssignRequest request = new ExamSlotSubjectAssignRequest();\n        request.setSubjectIds(List.of(1));\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(subjectRepository.findById((short) 1)).thenReturn(Optional.of(testSubject));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.assignSubjectsToSlot(1, request)\n        );\n        assertEquals(ErrorCode.INACTIVE_REFERENCE_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC08: Assign subjects - duplicate subject\")\n    void testAssignSubjectsToSlot_DuplicateSubject() {\n        // Arrange\n        ExamSlotSubjectAssignRequest request = new ExamSlotSubjectAssignRequest();\n        request.setSubjectIds(List.of(1));\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(subjectRepository.findById((short) 1)).thenReturn(Optional.of(testSubject));\n        when(examSlotSubjectRepository.existsBySlotIdAndSubjectIdAndIsActiveTrue(1, 1)).thenReturn(true);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.assignSubjectsToSlot(1, request)\n        );\n        assertEquals(ErrorCode.DUPLICATE_SUBJECTS_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    // ==================== GET SUBJECTS TESTS ====================\n\n    @Test\n    @DisplayName(\"TC09: Get subjects by slot ID successfully\")\n    void testGetSubjectsBySlotId_Success() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotSubjectRepository.findSubjectsBySlotId(1)).thenReturn(List.of(new SubjectDTO()));\n\n        // Act\n        ExamSlotSubjectsResponse result = examSlotService.getSubjectsBySlotId(1);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getTotalSubjects());\n        verify(examSlotSubjectRepository, times(1)).findSubjectsBySlotId(1);\n    }\n\n    @Test\n    @DisplayName(\"TC10: Get subjects - slot not found\")\n    void testGetSubjectsBySlotId_SlotNotFound() {\n        // Arrange\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.getSubjectsBySlotId(999)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== ADD PARTICIPANT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC11: Add participant successfully\")\n    void testAddParticipant_Success() {\n        // Arrange\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(1);\n\n        ExamSlotParticipantDTO expectedDTO = new ExamSlotParticipantDTO();\n        expectedDTO.setId(1L);\n\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(userRepository.findById(100)).thenReturn(Optional.of(testStudent));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectId(1, 1)).thenReturn(Optional.of(testExamSlotSubject));\n        when(enrollmentRepository.existsByStudentAndSubjectAndSemesterAndEnrolled(100, 1, (short) 1, true)).thenReturn(true);\n        when(examSlotParticipantRepository.existsByExamSlotSubject_Slot_IdAndStudentUserIdAndIsEnrolled(1, 100, true)).thenReturn(false);\n        when(examSlotParticipantRepository.findByExamSlotSubjectIdAndStudentUserId(1L, 100)).thenReturn(Optional.empty());\n        when(examSlotParticipantRepository.save(any(ExamSlotParticipant.class))).thenReturn(testParticipant);\n        when(examSlotParticipantRepository.findByIdWithDetails(1L)).thenReturn(expectedDTO);\n        when(examAttendanceRepository.findBySlotIdAndStudentUserId(1, 100)).thenReturn(null);\n\n        // Act\n        ExamSlotParticipantDTO result = examSlotService.addParticipant(1, request);\n\n        // Assert\n        assertNotNull(result);\n        verify(examSlotParticipantRepository, times(1)).save(any(ExamSlotParticipant.class));\n        verify(examAttendanceRepository, times(1)).save(any(ExamAttendance.class));\n    }\n\n    @Test\n    @DisplayName(\"TC12: Add participant - slot not found\")\n    void testAddParticipant_SlotNotFound() {\n        // Arrange\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(1);\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.addParticipant(999, request)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC13: Add participant - invalid slot type\")\n    void testAddParticipant_InvalidSlotType() {\n        // Arrange\n        testExamSlot.setSlotCategory(SlotCategory.LECTURE);\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.addParticipant(1, request)\n        );\n        assertEquals(ErrorCode.INVALID_SLOT_TYPE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC14: Add participant - inactive slot\")\n    void testAddParticipant_InactiveSlot() {\n        // Arrange\n        testExamSlot.setActive(false);\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.addParticipant(1, request)\n        );\n        assertEquals(ErrorCode.INACTIVE_SLOT_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC15: Add participant - slot already started\")\n    void testAddParticipant_SlotAlreadyStarted() {\n        // Arrange\n        testExamSlot.setStartTime(LocalDateTime.now(ZoneId.of(\"Asia/Ho_Chi_Minh\")).minusHours(1));\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> examSlotService.addParticipant(1, request)\n        );\n        assertEquals(ErrorCode.SLOT_ALREADY_STARTED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC16: Add participant - student not found\")\n    void testAddParticipant_StudentNotFound() {\n        // Arrange\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(999);\n        request.setSubjectId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(userRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.addParticipant(1, request)\n        );\n        assertEquals(ErrorCode.USER_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC17: Add participant - inactive student\")\n    void testAddParticipant_InactiveStudent() {\n        // Arrange\n        testStudent.setActive(false);\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(userRepository.findById(100)).thenReturn(Optional.of(testStudent));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.addParticipant(1, request)\n        );\n        assertEquals(ErrorCode.INACTIVE_STUDENT_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC18: Add participant - invalid user role\")\n    void testAddParticipant_InvalidUserRole() {\n        // Arrange\n        com.fuacs.backend.entity.Role adminRole = new com.fuacs.backend.entity.Role();\n        adminRole.setName(\"ADMIN\");\n        testStudent.setRoles(Set.of(adminRole));\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(userRepository.findById(100)).thenReturn(Optional.of(testStudent));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.addParticipant(1, request)\n        );\n        assertEquals(ErrorCode.INVALID_USER_ROLE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC19: Add participant - subject not assigned to slot\")\n    void testAddParticipant_SubjectNotAssigned() {\n        // Arrange\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(999);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(userRepository.findById(100)).thenReturn(Optional.of(testStudent));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectId(1, 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.addParticipant(1, request)\n        );\n        assertEquals(ErrorCode.SUBJECT_NOT_ASSIGNED_TO_SLOT, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC20: Add participant - student not enrolled in subject\")\n    void testAddParticipant_StudentNotEnrolled() {\n        // Arrange\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(userRepository.findById(100)).thenReturn(Optional.of(testStudent));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectId(1, 1)).thenReturn(Optional.of(testExamSlotSubject));\n        when(enrollmentRepository.existsByStudentAndSubjectAndSemesterAndEnrolled(100, 1, (short) 1, true)).thenReturn(false);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.addParticipant(1, request)\n        );\n        assertEquals(ErrorCode.STUDENT_NOT_ENROLLED_IN_SUBJECT, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC21: Add participant - student already in slot\")\n    void testAddParticipant_StudentAlreadyInSlot() {\n        // Arrange\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(userRepository.findById(100)).thenReturn(Optional.of(testStudent));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectId(1, 1)).thenReturn(Optional.of(testExamSlotSubject));\n        when(enrollmentRepository.existsByStudentAndSubjectAndSemesterAndEnrolled(100, 1, (short) 1, true)).thenReturn(true);\n        when(examSlotParticipantRepository.existsByExamSlotSubject_Slot_IdAndStudentUserIdAndIsEnrolled(1, 100, true)).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> examSlotService.addParticipant(1, request)\n        );\n        assertEquals(ErrorCode.STUDENT_ALREADY_IN_SLOT, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC22: Add participant - already enrolled\")\n    void testAddParticipant_AlreadyEnrolled() {\n        // Arrange\n        ExamSlotParticipantCreateRequest request = new ExamSlotParticipantCreateRequest();\n        request.setStudentUserId(100);\n        request.setSubjectId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(userRepository.findById(100)).thenReturn(Optional.of(testStudent));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectId(1, 1)).thenReturn(Optional.of(testExamSlotSubject));\n        when(enrollmentRepository.existsByStudentAndSubjectAndSemesterAndEnrolled(100, 1, (short) 1, true)).thenReturn(true);\n        when(examSlotParticipantRepository.existsByExamSlotSubject_Slot_IdAndStudentUserIdAndIsEnrolled(1, 100, true)).thenReturn(false);\n        when(examSlotParticipantRepository.findByExamSlotSubjectIdAndStudentUserId(1L, 100)).thenReturn(Optional.of(testParticipant));\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> examSlotService.addParticipant(1, request)\n        );\n        assertEquals(ErrorCode.ALREADY_ENROLLED, exception.getErrorCode());\n    }\n\n    // ==================== GET PARTICIPANTS TESTS ====================\n\n    @Test\n    @DisplayName(\"TC23: Get participants successfully\")\n    void testGetParticipants_Success() {\n        // Arrange\n        ExamSlotParticipantSearchRequest request = new ExamSlotParticipantSearchRequest();\n        request.setSubjectId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectId(1, 1)).thenReturn(Optional.of(testExamSlotSubject));\n        when(examSlotParticipantRepository.search(1, request)).thenReturn(new ArrayList<>());\n        when(examSlotParticipantRepository.count(1, request)).thenReturn(0L);\n        when(examSlotParticipantRepository.countByExamSlotSubject_Slot_IdAndExamSlotSubject_Subject_IdAndIsEnrolled(1, 1, true)).thenReturn(0L);\n        when(examSlotParticipantRepository.countByExamSlotSubject_Slot_IdAndExamSlotSubject_Subject_IdAndIsEnrolled(1, 1, false)).thenReturn(0L);\n\n        // Act\n        ExamSlotParticipantsResponse result = examSlotService.getParticipants(1, request);\n\n        // Assert\n        assertNotNull(result);\n        verify(examSlotParticipantRepository, times(1)).search(1, request);\n    }\n\n    @Test\n    @DisplayName(\"TC24: Get participants - slot not found\")\n    void testGetParticipants_SlotNotFound() {\n        // Arrange\n        ExamSlotParticipantSearchRequest request = new ExamSlotParticipantSearchRequest();\n        request.setSubjectId(1);\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.getParticipants(999, request)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC25: Get participants - subject not assigned\")\n    void testGetParticipants_SubjectNotAssigned() {\n        // Arrange\n        ExamSlotParticipantSearchRequest request = new ExamSlotParticipantSearchRequest();\n        request.setSubjectId(999);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectId(1, 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.getParticipants(1, request)\n        );\n        assertEquals(ErrorCode.SUBJECT_NOT_ASSIGNED_TO_SLOT, exception.getErrorCode());\n    }\n\n    // ==================== GET ALL PARTICIPANTS TESTS ====================\n\n    @Test\n    @DisplayName(\"TC26: Get all participants successfully\")\n    void testGetAllParticipants_Success() {\n        // Arrange\n        ExamSlotParticipantAllSearchRequest request = new ExamSlotParticipantAllSearchRequest();\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotParticipantRepository.searchAllBySlotId(1, request)).thenReturn(new ArrayList<>());\n        when(examSlotParticipantRepository.countAllBySlotId(1, request)).thenReturn(0L);\n        when(examSlotParticipantRepository.countByExamSlotSubject_Slot_IdAndIsEnrolled(1, true)).thenReturn(0L);\n        when(examSlotParticipantRepository.countByExamSlotSubject_Slot_IdAndIsEnrolled(1, false)).thenReturn(0L);\n\n        // Act\n        ExamSlotParticipantsAllResponse result = examSlotService.getAllParticipants(1, request);\n\n        // Assert\n        assertNotNull(result);\n        verify(examSlotParticipantRepository, times(1)).searchAllBySlotId(1, request);\n    }\n\n    @Test\n    @DisplayName(\"TC27: Get all participants - slot not found\")\n    void testGetAllParticipants_SlotNotFound() {\n        // Arrange\n        ExamSlotParticipantAllSearchRequest request = new ExamSlotParticipantAllSearchRequest();\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.getAllParticipants(999, request)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== REMOVE PARTICIPANT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC28: Remove participant successfully\")\n    void testRemoveParticipant_Success() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotParticipantRepository.findById(1L)).thenReturn(Optional.of(testParticipant));\n        when(examAttendanceRepository.findBySlotIdAndStudentUserId(1, 100)).thenReturn(null);\n        doNothing().when(examSlotParticipantRepository).delete(testParticipant);\n\n        // Act\n        examSlotService.removeParticipant(1, 1L);\n\n        // Assert\n        verify(examSlotParticipantRepository, times(1)).delete(testParticipant);\n    }\n\n    @Test\n    @DisplayName(\"TC29: Remove participant - slot not found\")\n    void testRemoveParticipant_SlotNotFound() {\n        // Arrange\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.removeParticipant(999, 1L)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC30: Remove participant - slot already started\")\n    void testRemoveParticipant_SlotAlreadyStarted() {\n        // Arrange\n        testExamSlot.setStartTime(LocalDateTime.now(ZoneId.of(\"Asia/Ho_Chi_Minh\")).minusHours(1));\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> examSlotService.removeParticipant(1, 1L)\n        );\n        assertEquals(ErrorCode.SLOT_ALREADY_STARTED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC31: Remove participant - participant not found\")\n    void testRemoveParticipant_ParticipantNotFound() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotParticipantRepository.findById(999L)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.removeParticipant(1, 999L)\n        );\n        assertEquals(ErrorCode.EXAM_SLOT_PARTICIPANT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC32: Remove participant - participant not in slot\")\n    void testRemoveParticipant_ParticipantNotInSlot() {\n        // Arrange\n        Slot anotherSlot = new Slot();\n        anotherSlot.setId(2);\n        testExamSlotSubject.setSlot(anotherSlot);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotParticipantRepository.findById(1L)).thenReturn(Optional.of(testParticipant));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.removeParticipant(1, 1L)\n        );\n        assertEquals(ErrorCode.EXAM_SLOT_PARTICIPANT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== GET PARTICIPANT BY ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC33: Get participant by ID successfully\")\n    void testGetParticipantById_Success() {\n        // Arrange\n        ExamSlotParticipantDTO expectedDTO = new ExamSlotParticipantDTO();\n        expectedDTO.setId(1L);\n        expectedDTO.setSlotId(1);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotParticipantRepository.findByIdWithDetails(1L)).thenReturn(expectedDTO);\n\n        // Act\n        ExamSlotParticipantDTO result = examSlotService.getParticipantById(1, 1L);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1L, result.getId());\n    }\n\n    @Test\n    @DisplayName(\"TC34: Get participant by ID - slot not found\")\n    void testGetParticipantById_SlotNotFound() {\n        // Arrange\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.getParticipantById(999, 1L)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC35: Get participant by ID - participant not found\")\n    void testGetParticipantById_ParticipantNotFound() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotParticipantRepository.findByIdWithDetails(999L)).thenReturn(null);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.getParticipantById(1, 999L)\n        );\n        assertEquals(ErrorCode.EXAM_SLOT_PARTICIPANT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC36: Get participant by ID - participant not in slot\")\n    void testGetParticipantById_ParticipantNotInSlot() {\n        // Arrange\n        ExamSlotParticipantDTO dto = new ExamSlotParticipantDTO();\n        dto.setId(1L);\n        dto.setSlotId(2);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotParticipantRepository.findByIdWithDetails(1L)).thenReturn(dto);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.getParticipantById(1, 1L)\n        );\n        assertEquals(ErrorCode.EXAM_SLOT_PARTICIPANT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== UPDATE PARTICIPANT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC37: Update participant successfully\")\n    void testUpdateParticipant_Success() {\n        // Arrange\n        ExamSlotParticipantUpdateRequest request = new ExamSlotParticipantUpdateRequest();\n        request.setIsEnrolled(false);\n        ExamSlotParticipantDTO expectedDTO = new ExamSlotParticipantDTO();\n        expectedDTO.setId(1L);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotParticipantRepository.findById(1L)).thenReturn(Optional.of(testParticipant));\n        when(examSlotParticipantRepository.save(testParticipant)).thenReturn(testParticipant);\n        when(examSlotParticipantRepository.findByIdWithDetails(1L)).thenReturn(expectedDTO);\n\n        // Act\n        ExamSlotParticipantDTO result = examSlotService.updateParticipant(1, 1L, request);\n\n        // Assert\n        assertNotNull(result);\n        verify(examSlotParticipantRepository, times(1)).save(testParticipant);\n    }\n\n    @Test\n    @DisplayName(\"TC38: Update participant - slot not found\")\n    void testUpdateParticipant_SlotNotFound() {\n        // Arrange\n        ExamSlotParticipantUpdateRequest request = new ExamSlotParticipantUpdateRequest();\n        request.setIsEnrolled(false);\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.updateParticipant(999, 1L, request)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC39: Update participant - participant not found\")\n    void testUpdateParticipant_ParticipantNotFound() {\n        // Arrange\n        ExamSlotParticipantUpdateRequest request = new ExamSlotParticipantUpdateRequest();\n        request.setIsEnrolled(false);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotParticipantRepository.findById(999L)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.updateParticipant(1, 999L, request)\n        );\n        assertEquals(ErrorCode.EXAM_SLOT_PARTICIPANT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC40: Update participant - participant not in slot\")\n    void testUpdateParticipant_ParticipantNotInSlot() {\n        // Arrange\n        Slot anotherSlot = new Slot();\n        anotherSlot.setId(2);\n        testExamSlotSubject.setSlot(anotherSlot);\n        ExamSlotParticipantUpdateRequest request = new ExamSlotParticipantUpdateRequest();\n        request.setIsEnrolled(false);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotParticipantRepository.findById(1L)).thenReturn(Optional.of(testParticipant));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.updateParticipant(1, 1L, request)\n        );\n        assertEquals(ErrorCode.EXAM_SLOT_PARTICIPANT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== REMOVE SUBJECT FROM SLOT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC41: Remove subject from slot successfully\")\n    void testRemoveSubjectFromSlot_Success() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectIdAndIsActiveTrue(1, 1)).thenReturn(Optional.of(testExamSlotSubject));\n        when(examSlotSubjectRepository.hasActiveParticipants(1L)).thenReturn(false);\n        when(userRepository.findById(1)).thenReturn(Optional.of(testAdmin));\n        when(examSlotSubjectRepository.save(testExamSlotSubject)).thenReturn(testExamSlotSubject);\n\n        // Act\n        examSlotService.removeSubjectFromSlot(1, 1, 1);\n\n        // Assert\n        verify(examSlotSubjectRepository, times(1)).save(testExamSlotSubject);\n        assertFalse(testExamSlotSubject.getIsActive());\n    }\n\n    @Test\n    @DisplayName(\"TC42: Remove subject - slot not found\")\n    void testRemoveSubjectFromSlot_SlotNotFound() {\n        // Arrange\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.removeSubjectFromSlot(999, 1, 1)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC43: Remove subject - invalid slot category\")\n    void testRemoveSubjectFromSlot_InvalidSlotCategory() {\n        // Arrange\n        testExamSlot.setSlotCategory(SlotCategory.LECTURE);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.removeSubjectFromSlot(1, 1, 1)\n        );\n        assertEquals(ErrorCode.INVALID_SLOT_CATEGORY, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC44: Remove subject - subject not found\")\n    void testRemoveSubjectFromSlot_SubjectNotFound() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectIdAndIsActiveTrue(1, 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.removeSubjectFromSlot(1, 999, 1)\n        );\n        assertEquals(ErrorCode.EXAM_SLOT_SUBJECT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC45: Remove subject - has active participants\")\n    void testRemoveSubjectFromSlot_HasActiveParticipants() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectIdAndIsActiveTrue(1, 1)).thenReturn(Optional.of(testExamSlotSubject));\n        when(examSlotSubjectRepository.hasActiveParticipants(1L)).thenReturn(true);\n        when(examSlotSubjectRepository.countActiveParticipants(1L)).thenReturn(5L);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> examSlotService.removeSubjectFromSlot(1, 1, 1)\n        );\n        assertEquals(ErrorCode.EXAM_SLOT_SUBJECT_HAS_PARTICIPANTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC46: Remove subject - user not found\")\n    void testRemoveSubjectFromSlot_UserNotFound() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testExamSlot));\n        when(examSlotSubjectRepository.findBySlotIdAndSubjectIdAndIsActiveTrue(1, 1)).thenReturn(Optional.of(testExamSlotSubject));\n        when(examSlotSubjectRepository.hasActiveParticipants(1L)).thenReturn(false);\n        when(userRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> examSlotService.removeSubjectFromSlot(1, 1, 999)\n        );\n        assertEquals(ErrorCode.USER_NOT_FOUND, exception.getErrorCode());\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\MajorServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/MajorServiceTest.java",
      "filename": "MajorServiceTest.java",
      "size_bytes": 18829,
      "lines": 494,
      "last_modified": "2025-11-28T08:56:33.048594",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.constant.ImportMode;\nimport com.fuacs.backend.dto.mapper.MajorMapper;\nimport com.fuacs.backend.dto.request.MajorCreateRequest;\nimport com.fuacs.backend.dto.request.MajorCsvRow;\nimport com.fuacs.backend.dto.request.MajorSearchRequest;\nimport com.fuacs.backend.dto.request.MajorUpdateRequest;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.MajorDTO;\nimport com.fuacs.backend.entity.Major;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.MajorRepository;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\nimport org.springframework.dao.DataIntegrityViolationException;\nimport org.springframework.mock.web.MockMultipartFile;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.io.IOException;\nimport java.time.Instant;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.Optional;\n\nimport static org.junit.jupiter.api.Assertions.*;\nimport static org.mockito.ArgumentMatchers.*;\nimport static org.mockito.Mockito.*;\n\nimport org.mockito.junit.jupiter.MockitoSettings;\nimport org.mockito.quality.Strictness;\n\n@ExtendWith(MockitoExtension.class)\n@MockitoSettings(strictness = Strictness.LENIENT)\n@DisplayName(\"MajorService Unit Tests\")\nclass MajorServiceTest {\n\n    @Mock\n    private MajorRepository majorRepository;\n\n    @Mock\n    private MajorMapper majorMapper;\n\n    @Mock\n    private CsvParserService csvParserService;\n\n    @InjectMocks\n    private MajorService majorService;\n\n    private Major testMajor;\n    private MajorDTO testMajorDTO;\n    private MajorCreateRequest createRequest;\n    private MajorUpdateRequest updateRequest;\n\n    @BeforeEach\n    void setUp() {\n        testMajor = new Major();\n        testMajor.setId((short) 1);\n        testMajor.setCode(\"SE\");\n        testMajor.setName(\"Software Engineering\");\n        testMajor.setActive(true);\n        testMajor.setCreatedAt(Instant.now());\n\n        testMajorDTO = new MajorDTO();\n        testMajorDTO.setId((short) 1);\n        testMajorDTO.setCode(\"SE\");\n        testMajorDTO.setName(\"Software Engineering\");\n        testMajorDTO.setActive(true);\n\n        createRequest = new MajorCreateRequest();\n        createRequest.setCode(\"AI\");\n        createRequest.setName(\"Artificial Intelligence\");\n\n        updateRequest = new MajorUpdateRequest();\n        updateRequest.setCode(\"SE\");\n        updateRequest.setName(\"Software Engineering Updated\");\n        updateRequest.setActive(true);\n    }\n\n    // Helper method to create MajorSearchRequest\n    private MajorSearchRequest createSearchRequest() {\n        return new MajorSearchRequest(null, null, null, null, null, null);\n    }\n\n    // ==================== SEARCH TESTS ====================\n\n    @Test\n    @DisplayName(\"TC01: Search majors successfully\")\n    void testSearch_Success() {\n        // Arrange\n        MajorSearchRequest searchRequest = createSearchRequest();\n        List<MajorDTO> expectedList = List.of(testMajorDTO);\n        when(majorRepository.search(searchRequest)).thenReturn(expectedList);\n\n        // Act\n        List<MajorDTO> result = majorService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(majorRepository, times(1)).search(searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC02: Search returns empty list\")\n    void testSearch_EmptyResult() {\n        // Arrange\n        MajorSearchRequest searchRequest = createSearchRequest();\n        when(majorRepository.search(searchRequest)).thenReturn(new ArrayList<>());\n\n        // Act\n        List<MajorDTO> result = majorService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertTrue(result.isEmpty());\n        verify(majorRepository, times(1)).search(searchRequest);\n    }\n\n    // ==================== COUNT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC03: Count majors successfully\")\n    void testCount_Success() {\n        // Arrange\n        MajorSearchRequest searchRequest = createSearchRequest();\n        when(majorRepository.count(searchRequest)).thenReturn(5L);\n\n        // Act\n        Long result = majorService.count(searchRequest);\n\n        // Assert\n        assertEquals(5L, result);\n        verify(majorRepository, times(1)).count(searchRequest);\n    }\n\n    // ==================== FIND BY ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC04: Find major by ID successfully\")\n    void testFindById_Success() {\n        // Arrange\n        when(majorRepository.findMajorDTOById((short) 1)).thenReturn(Optional.of(testMajorDTO));\n\n        // Act\n        MajorDTO result = majorService.findById((short) 1);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals((short) 1, result.getId());\n        assertEquals(\"SE\", result.getCode());\n        verify(majorRepository, times(1)).findMajorDTOById((short) 1);\n    }\n\n    @Test\n    @DisplayName(\"TC05: Find major by ID - not found\")\n    void testFindById_NotFound() {\n        // Arrange\n        when(majorRepository.findMajorDTOById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> majorService.findById((short) 999)\n        );\n        assertEquals(ErrorCode.MAJOR_NOT_FOUND, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"999\"));\n    }\n\n    // ==================== CREATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC06: Create major successfully\")\n    void testCreate_Success() {\n        // Arrange\n        Major newMajor = new Major();\n        newMajor.setCode(\"AI\");\n        newMajor.setName(\"Artificial Intelligence\");\n\n        when(majorRepository.existsByCode(createRequest.getCode())).thenReturn(false);\n        when(majorRepository.existsByName(createRequest.getName())).thenReturn(false);\n        when(majorMapper.toEntity(createRequest)).thenReturn(newMajor);\n        when(majorRepository.save(newMajor)).thenReturn(newMajor);\n        when(majorMapper.toDTO(newMajor)).thenReturn(testMajorDTO);\n\n        // Act\n        MajorDTO result = majorService.create(createRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(majorRepository, times(1)).save(newMajor);\n    }\n\n    @Test\n    @DisplayName(\"TC07: Create major - code already exists\")\n    void testCreate_CodeExists() {\n        // Arrange\n        when(majorRepository.existsByCode(createRequest.getCode())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> majorService.create(createRequest)\n        );\n        assertEquals(ErrorCode.MAJOR_CODE_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC08: Create major - name already exists\")\n    void testCreate_NameExists() {\n        // Arrange\n        when(majorRepository.existsByCode(createRequest.getCode())).thenReturn(false);\n        when(majorRepository.existsByName(createRequest.getName())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> majorService.create(createRequest)\n        );\n        assertEquals(ErrorCode.MAJOR_NAME_EXISTS, exception.getErrorCode());\n    }\n\n    // ==================== UPDATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC09: Update major successfully\")\n    void testUpdate_Success() {\n        // Arrange\n        when(majorRepository.findById((short) 1)).thenReturn(Optional.of(testMajor));\n        when(majorRepository.existsByCodeAndIdNot(anyString(), anyShort())).thenReturn(false);\n        when(majorRepository.existsByNameAndIdNot(anyString(), anyShort())).thenReturn(false);\n        when(majorRepository.save(testMajor)).thenReturn(testMajor);\n        when(majorMapper.toDTO(testMajor)).thenReturn(testMajorDTO);\n\n        // Act\n        MajorDTO result = majorService.update((short) 1, updateRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(majorMapper, times(1)).updateFromRequest(updateRequest, testMajor);\n        verify(majorRepository, times(1)).save(testMajor);\n    }\n\n    @Test\n    @DisplayName(\"TC10: Update major - not found\")\n    void testUpdate_NotFound() {\n        // Arrange\n        when(majorRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> majorService.update((short) 999, updateRequest)\n        );\n        assertEquals(ErrorCode.MAJOR_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC11: Update major - code already exists\")\n    void testUpdate_CodeExists() {\n        // Arrange\n        updateRequest.setCode(\"NEWCODE\");\n        when(majorRepository.findById((short) 1)).thenReturn(Optional.of(testMajor));\n        when(majorRepository.existsByCodeAndIdNot(\"NEWCODE\", (short) 1)).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> majorService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.MAJOR_CODE_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC12: Update major - name already exists\")\n    void testUpdate_NameExists() {\n        // Arrange\n        updateRequest.setName(\"New Name\");\n        when(majorRepository.findById((short) 1)).thenReturn(Optional.of(testMajor));\n        when(majorRepository.existsByCodeAndIdNot(anyString(), anyShort())).thenReturn(false);\n        when(majorRepository.existsByNameAndIdNot(\"New Name\", (short) 1)).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> majorService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.MAJOR_NAME_EXISTS, exception.getErrorCode());\n    }\n\n    // ==================== DELETE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC13: Delete major successfully\")\n    void testDelete_Success() {\n        // Arrange\n        when(majorRepository.existsById((short) 1)).thenReturn(true);\n        when(majorRepository.countSubjectsByMajorId((short) 1)).thenReturn(0L);\n        when(majorRepository.countStudentsByMajorId((short) 1)).thenReturn(0L);\n        doNothing().when(majorRepository).deleteById((short) 1);\n\n        // Act\n        majorService.delete((short) 1);\n\n        // Assert\n        verify(majorRepository, times(1)).deleteById((short) 1);\n    }\n\n    @Test\n    @DisplayName(\"TC14: Delete major - not found\")\n    void testDelete_NotFound() {\n        // Arrange\n        when(majorRepository.existsById((short) 999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> majorService.delete((short) 999)\n        );\n        assertEquals(ErrorCode.MAJOR_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC15: Delete major - has subjects\")\n    void testDelete_HasSubjects() {\n        // Arrange\n        when(majorRepository.existsById((short) 1)).thenReturn(true);\n        when(majorRepository.countSubjectsByMajorId((short) 1)).thenReturn(5L);\n        when(majorRepository.countStudentsByMajorId((short) 1)).thenReturn(0L);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> majorService.delete((short) 1)\n        );\n        assertEquals(ErrorCode.MAJOR_HAS_DEPENDENCIES, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"5\"));\n    }\n\n    @Test\n    @DisplayName(\"TC16: Delete major - has students\")\n    void testDelete_HasStudents() {\n        // Arrange\n        when(majorRepository.existsById((short) 1)).thenReturn(true);\n        when(majorRepository.countSubjectsByMajorId((short) 1)).thenReturn(0L);\n        when(majorRepository.countStudentsByMajorId((short) 1)).thenReturn(10L);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> majorService.delete((short) 1)\n        );\n        assertEquals(ErrorCode.MAJOR_HAS_DEPENDENCIES, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"10\"));\n    }\n\n    @Test\n    @DisplayName(\"TC17: Delete major - foreign key constraint violation\")\n    void testDelete_ForeignKeyConstraint() {\n        // Arrange\n        when(majorRepository.existsById((short) 1)).thenReturn(true);\n        when(majorRepository.countSubjectsByMajorId((short) 1)).thenReturn(0L);\n        when(majorRepository.countStudentsByMajorId((short) 1)).thenReturn(0L);\n        doThrow(new DataIntegrityViolationException(\"FK constraint\")).when(majorRepository).deleteById((short) 1);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> majorService.delete((short) 1)\n        );\n        assertEquals(ErrorCode.FOREIGN_KEY_CONSTRAINT_VIOLATION, exception.getErrorCode());\n    }\n\n    // ==================== IMPORT CSV TESTS ====================\n\n    @Test\n    @DisplayName(\"TC18: Import CSV - AddOnly mode success\")\n    void testImportFromCsv_AddOnly_Success() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<MajorCsvRow> rows = new ArrayList<>();\n        MajorCsvRow row = new MajorCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"AI\");\n        row.setName(\"Artificial Intelligence\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseMajorCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"AI\")).thenReturn(null);\n        when(majorRepository.existsByName(\"Artificial Intelligence\")).thenReturn(false);\n        when(majorRepository.save(any(Major.class))).thenReturn(testMajor);\n\n        // Act\n        ImportResultDTO result = majorService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC19: Import CSV - invalid mode\")\n    void testImportFromCsv_InvalidMode() {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> majorService.importFromCsv(file, \"InvalidMode\")\n        );\n        assertEquals(ErrorCode.INVALID_IMPORT_MODE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC20: Import CSV - file processing error\")\n    void testImportFromCsv_FileProcessingError() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        when(csvParserService.parseMajorCsv(file)).thenThrow(new IOException(\"File error\"));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> majorService.importFromCsv(file, \"AddOnly\")\n        );\n        assertEquals(ErrorCode.FILE_PROCESSING_ERROR, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC21: Import CSV - AddAndUpdate mode updates existing\")\n    void testImportFromCsv_AddAndUpdate_UpdatesExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<MajorCsvRow> rows = new ArrayList<>();\n        MajorCsvRow row = new MajorCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"SE\");\n        row.setName(\"Software Engineering Updated\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseMajorCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor);\n        when(majorRepository.existsByName(\"Software Engineering Updated\")).thenReturn(false);\n        when(majorRepository.save(any(Major.class))).thenReturn(testMajor);\n\n        // Act\n        ImportResultDTO result = majorService.importFromCsv(file, \"AddAndUpdate\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC22: Import CSV - AddOnly mode fails on existing code\")\n    void testImportFromCsv_AddOnly_FailsOnExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<MajorCsvRow> rows = new ArrayList<>();\n        MajorCsvRow row = new MajorCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"SE\");\n        row.setName(\"Software Engineering\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseMajorCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor);\n\n        // Act\n        ImportResultDTO result = majorService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(1, result.getErrors().size());\n        assertEquals(ErrorCode.MAJOR_CODE_EXISTS, result.getErrors().get(0).getErrorCode());\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\SemesterServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/SemesterServiceTest.java",
      "filename": "SemesterServiceTest.java",
      "size_bytes": 24405,
      "lines": 594,
      "last_modified": "2025-11-28T08:56:33.048594",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.constant.ImportMode;\nimport com.fuacs.backend.dto.mapper.SemesterMapper;\nimport com.fuacs.backend.dto.request.SemesterCreateRequest;\nimport com.fuacs.backend.dto.request.SemesterCsvRow;\nimport com.fuacs.backend.dto.request.SemesterSearchRequest;\nimport com.fuacs.backend.dto.request.SemesterUpdateRequest;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.SemesterDTO;\nimport com.fuacs.backend.entity.Semester;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.exception.InvalidDateException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.SemesterRepository;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\nimport org.springframework.dao.DataIntegrityViolationException;\nimport org.springframework.mock.web.MockMultipartFile;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.io.IOException;\nimport java.time.Instant;\nimport java.time.LocalDate;\nimport java.util.ArrayList;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Optional;\n\nimport static org.junit.jupiter.api.Assertions.*;\nimport static org.mockito.ArgumentMatchers.*;\nimport static org.mockito.Mockito.*;\n\nimport org.mockito.junit.jupiter.MockitoSettings;\nimport org.mockito.quality.Strictness;\n\n@ExtendWith(MockitoExtension.class)\n@MockitoSettings(strictness = Strictness.LENIENT)\n@DisplayName(\"SemesterService Unit Tests\")\nclass SemesterServiceTest {\n\n    @Mock\n    private SemesterRepository semesterRepository;\n\n    @Mock\n    private SemesterMapper semesterMapper;\n\n    @Mock\n    private CsvParserService csvParserService;\n\n    @InjectMocks\n    private SemesterService semesterService;\n\n    private Semester testSemester;\n    private SemesterDTO testSemesterDTO;\n    private SemesterCreateRequest createRequest;\n    private SemesterUpdateRequest updateRequest;\n\n    @BeforeEach\n    void setUp() {\n        testSemester = new Semester();\n        testSemester.setId((short) 1);\n        testSemester.setCode(\"FALL2024\");\n        testSemester.setName(\"Fall 2024\");\n        testSemester.setStartDate(LocalDate.of(2024, 9, 1));\n        testSemester.setEndDate(LocalDate.of(2024, 12, 31));\n        testSemester.setActive(true);\n        testSemester.setCreatedAt(Instant.now());\n        testSemester.setAcademicClasses(new HashSet<>());\n\n        testSemesterDTO = new SemesterDTO();\n        testSemesterDTO.setId((short) 1);\n        testSemesterDTO.setCode(\"FALL2024\");\n        testSemesterDTO.setName(\"Fall 2024\");\n        testSemesterDTO.setStartDate(LocalDate.of(2024, 9, 1));\n        testSemesterDTO.setEndDate(LocalDate.of(2024, 12, 31));\n        testSemesterDTO.setActive(true);\n\n        createRequest = new SemesterCreateRequest();\n        createRequest.setCode(\"SPRING2025\");\n        createRequest.setName(\"Spring 2025\");\n        createRequest.setStartDate(LocalDate.of(2025, 1, 1));\n        createRequest.setEndDate(LocalDate.of(2025, 5, 31));\n\n        updateRequest = new SemesterUpdateRequest();\n        updateRequest.setCode(\"FALL2024\");\n        updateRequest.setName(\"Fall 2024 Updated\");\n        updateRequest.setStartDate(LocalDate.of(2024, 9, 1));\n        updateRequest.setEndDate(LocalDate.of(2024, 12, 31));\n        updateRequest.setActive(true);\n    }\n\n    // ==================== SEARCH TESTS ====================\n\n    // Helper method to create SemesterSearchRequest\n    private SemesterSearchRequest createSearchRequest() {\n        return new SemesterSearchRequest(null, null, null, null, null, null);\n    }\n\n    @Test\n    @DisplayName(\"TC01: Search semesters successfully\")\n    void testSearch_Success() {\n        // Arrange\n        SemesterSearchRequest searchRequest = createSearchRequest();\n        List<SemesterDTO> expectedList = List.of(testSemesterDTO);\n        when(semesterRepository.search(searchRequest)).thenReturn(expectedList);\n\n        // Act\n        List<SemesterDTO> result = semesterService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(semesterRepository, times(1)).search(searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC02: Search returns empty list\")\n    void testSearch_EmptyResult() {\n        // Arrange\n        SemesterSearchRequest searchRequest = createSearchRequest();\n        when(semesterRepository.search(searchRequest)).thenReturn(new ArrayList<>());\n\n        // Act\n        List<SemesterDTO> result = semesterService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertTrue(result.isEmpty());\n        verify(semesterRepository, times(1)).search(searchRequest);\n    }\n\n    // ==================== COUNT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC03: Count semesters successfully\")\n    void testCount_Success() {\n        // Arrange\n        SemesterSearchRequest searchRequest = createSearchRequest();\n        when(semesterRepository.count(searchRequest)).thenReturn(5L);\n\n        // Act\n        Long result = semesterService.count(searchRequest);\n\n        // Assert\n        assertEquals(5L, result);\n        verify(semesterRepository, times(1)).count(searchRequest);\n    }\n\n    // ==================== FIND BY ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC04: Find semester by ID successfully\")\n    void testFindById_Success() {\n        // Arrange\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(semesterMapper.toDTO(testSemester)).thenReturn(testSemesterDTO);\n\n        // Act\n        SemesterDTO result = semesterService.findById((short) 1);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals((short) 1, result.getId());\n        assertEquals(\"FALL2024\", result.getCode());\n        verify(semesterRepository, times(1)).findById((short) 1);\n    }\n\n    @Test\n    @DisplayName(\"TC05: Find semester by ID - not found\")\n    void testFindById_NotFound() {\n        // Arrange\n        when(semesterRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> semesterService.findById((short) 999)\n        );\n        assertEquals(ErrorCode.SEMESTER_NOT_FOUND, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"999\"));\n    }\n\n    // ==================== CREATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC06: Create semester successfully\")\n    void testCreate_Success() {\n        // Arrange\n        Semester newSemester = new Semester();\n        newSemester.setCode(\"SPRING2025\");\n        newSemester.setName(\"Spring 2025\");\n        newSemester.setStartDate(createRequest.getStartDate());\n        newSemester.setEndDate(createRequest.getEndDate());\n        newSemester.setAcademicClasses(new HashSet<>());\n\n        when(semesterRepository.existsByCode(createRequest.getCode())).thenReturn(false);\n        when(semesterRepository.existsByName(createRequest.getName())).thenReturn(false);\n        when(semesterRepository.existsByDateRangeOverlap(any(), any())).thenReturn(false);\n        when(semesterMapper.toEntity(createRequest)).thenReturn(newSemester);\n        when(semesterRepository.save(newSemester)).thenReturn(newSemester);\n        when(semesterMapper.toDTO(newSemester)).thenReturn(testSemesterDTO);\n\n        // Act\n        SemesterDTO result = semesterService.create(createRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals((short) 0, result.getTotalClass());\n        verify(semesterRepository, times(1)).save(newSemester);\n    }\n\n    @Test\n    @DisplayName(\"TC07: Create semester - invalid date range\")\n    void testCreate_InvalidDateRange() {\n        // Arrange\n        createRequest.setStartDate(LocalDate.of(2025, 5, 31));\n        createRequest.setEndDate(LocalDate.of(2025, 1, 1));\n\n        // Act & Assert\n        InvalidDateException exception = assertThrows(\n            InvalidDateException.class,\n            () -> semesterService.create(createRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_INVALID_DATE_RANGE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC08: Create semester - code already exists\")\n    void testCreate_CodeExists() {\n        // Arrange\n        when(semesterRepository.existsByCode(createRequest.getCode())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> semesterService.create(createRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_CODE_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC09: Create semester - name already exists\")\n    void testCreate_NameExists() {\n        // Arrange\n        when(semesterRepository.existsByCode(createRequest.getCode())).thenReturn(false);\n        when(semesterRepository.existsByName(createRequest.getName())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> semesterService.create(createRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_NAME_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC10: Create semester - date range overlaps\")\n    void testCreate_DateRangeOverlaps() {\n        // Arrange\n        when(semesterRepository.existsByCode(createRequest.getCode())).thenReturn(false);\n        when(semesterRepository.existsByName(createRequest.getName())).thenReturn(false);\n        when(semesterRepository.existsByDateRangeOverlap(any(), any())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> semesterService.create(createRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_DATE_RANGE_EXISTS, exception.getErrorCode());\n    }\n\n    // ==================== UPDATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC11: Update semester successfully\")\n    void testUpdate_Success() {\n        // Arrange\n        testSemester.setStartDate(LocalDate.of(2023, 9, 1));\n        testSemester.setEndDate(LocalDate.of(2023, 12, 31));\n        \n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(semesterRepository.existsByCodeAndIdNot(anyString(), anyShort())).thenReturn(false);\n        when(semesterRepository.existsByNameAndIdNot(anyString(), anyShort())).thenReturn(false);\n        when(semesterRepository.existsByDateRangeOverlapAndIdNot(any(), any(), anyShort())).thenReturn(false);\n        when(semesterRepository.save(testSemester)).thenReturn(testSemester);\n        when(semesterMapper.toDTO(testSemester)).thenReturn(testSemesterDTO);\n\n        // Act\n        SemesterDTO result = semesterService.update((short) 1, updateRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(semesterMapper, times(1)).updateSemesterFromRequest(updateRequest, testSemester);\n        verify(semesterRepository, times(1)).save(testSemester);\n    }\n\n    @Test\n    @DisplayName(\"TC12: Update semester - not found\")\n    void testUpdate_NotFound() {\n        // Arrange\n        when(semesterRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> semesterService.update((short) 999, updateRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC13: Update semester - invalid date range\")\n    void testUpdate_InvalidDateRange() {\n        // Arrange\n        updateRequest.setStartDate(LocalDate.of(2024, 12, 31));\n        updateRequest.setEndDate(LocalDate.of(2024, 9, 1));\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n\n        // Act & Assert\n        InvalidDateException exception = assertThrows(\n            InvalidDateException.class,\n            () -> semesterService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_INVALID_DATE_RANGE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC14: Update semester - code already exists\")\n    void testUpdate_CodeExists() {\n        // Arrange\n        updateRequest.setCode(\"NEWCODE\");\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(semesterRepository.existsByCodeAndIdNot(\"NEWCODE\", (short) 1)).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> semesterService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_CODE_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC15: Update semester - name already exists\")\n    void testUpdate_NameExists() {\n        // Arrange\n        updateRequest.setName(\"New Name\");\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(semesterRepository.existsByCodeAndIdNot(anyString(), anyShort())).thenReturn(false);\n        when(semesterRepository.existsByNameAndIdNot(\"New Name\", (short) 1)).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> semesterService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_NAME_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC16: Update semester - date range overlaps\")\n    void testUpdate_DateRangeOverlaps() {\n        // Arrange\n        updateRequest.setStartDate(LocalDate.of(2025, 1, 1));\n        updateRequest.setEndDate(LocalDate.of(2025, 5, 31));\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(semesterRepository.existsByCodeAndIdNot(anyString(), anyShort())).thenReturn(false);\n        when(semesterRepository.existsByNameAndIdNot(anyString(), anyShort())).thenReturn(false);\n        when(semesterRepository.existsByDateRangeOverlapAndIdNot(any(), any(), anyShort())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> semesterService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_DATE_RANGE_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC17: Update ongoing semester - cannot modify dates\")\n    void testUpdate_OngoingSemester_CannotModifyDates() {\n        // Arrange\n        LocalDate today = LocalDate.now();\n        testSemester.setStartDate(today.minusDays(10));\n        testSemester.setEndDate(today.plusDays(10));\n        updateRequest.setStartDate(today.minusDays(5));\n        updateRequest.setEndDate(today.plusDays(15));\n        \n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> semesterService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_ONGOING_CANNOT_BE_MODIFIED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC18: Update ongoing semester - cannot modify active status\")\n    void testUpdate_OngoingSemester_CannotModifyActive() {\n        // Arrange\n        LocalDate today = LocalDate.now();\n        testSemester.setStartDate(today.minusDays(10));\n        testSemester.setEndDate(today.plusDays(10));\n        testSemester.setActive(true);\n        updateRequest.setStartDate(testSemester.getStartDate());\n        updateRequest.setEndDate(testSemester.getEndDate());\n        updateRequest.setActive(false);\n        \n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> semesterService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_ONGOING_CANNOT_BE_MODIFIED, exception.getErrorCode());\n    }\n\n    // ==================== DELETE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC19: Delete semester successfully\")\n    void testDelete_Success() {\n        // Arrange\n        when(semesterRepository.existsById((short) 1)).thenReturn(true);\n        when(semesterRepository.countClassesBySemesterId((short) 1)).thenReturn(0L);\n        doNothing().when(semesterRepository).deleteById((short) 1);\n\n        // Act\n        semesterService.delete((short) 1);\n\n        // Assert\n        verify(semesterRepository, times(1)).deleteById((short) 1);\n    }\n\n    @Test\n    @DisplayName(\"TC20: Delete semester - not found\")\n    void testDelete_NotFound() {\n        // Arrange\n        when(semesterRepository.existsById((short) 999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> semesterService.delete((short) 999)\n        );\n        assertEquals(ErrorCode.SEMESTER_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC21: Delete semester - has classes\")\n    void testDelete_HasClasses() {\n        // Arrange\n        when(semesterRepository.existsById((short) 1)).thenReturn(true);\n        when(semesterRepository.countClassesBySemesterId((short) 1)).thenReturn(5L);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> semesterService.delete((short) 1)\n        );\n        assertEquals(ErrorCode.SEMESTER_HAS_CLASSES, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"5\"));\n    }\n\n    @Test\n    @DisplayName(\"TC22: Delete semester - foreign key constraint violation\")\n    void testDelete_ForeignKeyConstraint() {\n        // Arrange\n        when(semesterRepository.existsById((short) 1)).thenReturn(true);\n        when(semesterRepository.countClassesBySemesterId((short) 1)).thenReturn(0L);\n        doThrow(new DataIntegrityViolationException(\"FK constraint\")).when(semesterRepository).deleteById((short) 1);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> semesterService.delete((short) 1)\n        );\n        assertEquals(ErrorCode.FOREIGN_KEY_CONSTRAINT_VIOLATION, exception.getErrorCode());\n    }\n\n    // ==================== IMPORT CSV TESTS ====================\n\n    @Test\n    @DisplayName(\"TC23: Import CSV - AddOnly mode success\")\n    void testImportFromCsv_AddOnly_Success() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<SemesterCsvRow> rows = new ArrayList<>();\n        SemesterCsvRow row = new SemesterCsvRow(2, \"FALL2025\", \"Fall 2025\", \"2025-09-01\", \"2025-12-31\", \"true\");\n        rows.add(row);\n\n        when(csvParserService.parseSemesterCsv(file)).thenReturn(rows);\n        when(semesterRepository.findByCode(\"FALL2025\")).thenReturn(null);\n        when(semesterRepository.existsByName(\"Fall 2025\")).thenReturn(false);\n        when(semesterRepository.existsByDateRangeOverlap(any(), any())).thenReturn(false);\n        when(semesterRepository.save(any(Semester.class))).thenReturn(testSemester);\n\n        // Act\n        ImportResultDTO result = semesterService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC24: Import CSV - invalid mode\")\n    void testImportFromCsv_InvalidMode() {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> semesterService.importFromCsv(file, \"InvalidMode\")\n        );\n        assertEquals(ErrorCode.INVALID_IMPORT_MODE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC25: Import CSV - file processing error\")\n    void testImportFromCsv_FileProcessingError() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        when(csvParserService.parseSemesterCsv(file)).thenThrow(new IOException(\"File error\"));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> semesterService.importFromCsv(file, \"AddOnly\")\n        );\n        assertEquals(ErrorCode.FILE_PROCESSING_ERROR, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC26: Import CSV - AddAndUpdate mode updates existing\")\n    void testImportFromCsv_AddAndUpdate_UpdatesExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<SemesterCsvRow> rows = new ArrayList<>();\n        SemesterCsvRow row = new SemesterCsvRow(2, \"FALL2024\", \"Fall 2024 Updated\", \"2024-09-01\", \"2024-12-31\", \"true\");\n        rows.add(row);\n\n        when(csvParserService.parseSemesterCsv(file)).thenReturn(rows);\n        when(semesterRepository.findByCode(\"FALL2024\")).thenReturn(testSemester);\n        when(semesterRepository.existsByName(\"Fall 2024 Updated\")).thenReturn(false);\n        when(semesterRepository.existsByDateRangeOverlapAndIdNot(any(), any(), anyShort())).thenReturn(false);\n        when(semesterRepository.save(any(Semester.class))).thenReturn(testSemester);\n\n        // Act\n        ImportResultDTO result = semesterService.importFromCsv(file, \"AddAndUpdate\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC27: Import CSV - AddOnly mode fails on existing code\")\n    void testImportFromCsv_AddOnly_FailsOnExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<SemesterCsvRow> rows = new ArrayList<>();\n        SemesterCsvRow row = new SemesterCsvRow(2, \"FALL2024\", \"Fall 2024\", \"2024-09-01\", \"2024-12-31\", \"true\");\n        rows.add(row);\n\n        when(csvParserService.parseSemesterCsv(file)).thenReturn(rows);\n        when(semesterRepository.findByCode(\"FALL2024\")).thenReturn(testSemester);\n\n        // Act\n        ImportResultDTO result = semesterService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(1, result.getErrors().size());\n        assertEquals(ErrorCode.SEMESTER_CODE_EXISTS, result.getErrors().get(0).getErrorCode());\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\SlotServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/SlotServiceTest.java",
      "filename": "SlotServiceTest.java",
      "size_bytes": 33478,
      "lines": 817,
      "last_modified": "2025-12-03T10:11:14.014206",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.constant.enums.AttendanceMethod;\nimport com.fuacs.backend.constant.enums.AttendanceStatus;\nimport com.fuacs.backend.constant.enums.Role;\nimport com.fuacs.backend.constant.enums.SessionStatus;\nimport com.fuacs.backend.constant.enums.SlotCategory;\nimport com.fuacs.backend.dto.mapper.SlotMapper;\nimport com.fuacs.backend.dto.request.SlotCreateRequest;\nimport com.fuacs.backend.dto.request.SlotSearchRequest;\nimport com.fuacs.backend.dto.request.SlotUpdateRequest;\nimport com.fuacs.backend.dto.response.SlotDTO;\nimport com.fuacs.backend.entity.*;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.*;\nimport com.fuacs.backend.realtime.SseHub;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\n\nimport java.time.Instant;\nimport java.time.LocalDate;\nimport java.time.LocalDateTime;\nimport java.time.ZoneId;\nimport java.util.*;\n\nimport static org.junit.jupiter.api.Assertions.*;\nimport static org.mockito.ArgumentMatchers.*;\nimport static org.mockito.Mockito.*;\n\nimport org.mockito.junit.jupiter.MockitoSettings;\nimport org.mockito.quality.Strictness;\n\n@ExtendWith(MockitoExtension.class)\n@MockitoSettings(strictness = Strictness.LENIENT)\n@DisplayName(\"SlotService Unit Tests\")\nclass SlotServiceTest {\n\n    @Mock\n    private SlotRepository slotRepository;\n    @Mock\n    private ClassRepository classRepository;\n    @Mock\n    private RoomRepository roomRepository;\n    @Mock\n    private SemesterRepository semesterRepository;\n    @Mock\n    private UserRepository userRepository;\n    @Mock\n    private SlotMapper slotMapper;\n    @Mock\n    private AttendanceRecordRepository attendanceRecordRepository;\n    @Mock\n    private ExamAttendanceRepository examAttendanceRepository;\n    @Mock\n    private SlotSessionService slotSessionService;\n    @Mock\n    private SubjectRepository subjectRepository;\n    @Mock\n    private ExamSlotSubjectRepository examSlotSubjectRepository;\n    @Mock\n    private ExamSlotParticipantRepository examSlotParticipantRepository;\n    @Mock\n    private CsvParserService csvParserService;\n    @Mock\n    private EnrollmentRepository enrollmentRepository;\n    @Mock\n    private SseHub sseHub;\n\n    @InjectMocks\n    private SlotService slotService;\n\n    private Slot testSlot;\n    private SlotDTO testSlotDTO;\n    private SlotCreateRequest createRequest;\n    private SlotUpdateRequest updateRequest;\n    private AcademicClass testClass;\n    private Semester testSemester;\n    private Room testRoom;\n    private User testStaff;\n    private User testStudent;\n\n    @BeforeEach\n    void setUp() {\n        // Setup test semester - use future dates\n        testSemester = new Semester();\n        testSemester.setId((short) 1);\n        testSemester.setCode(\"SPRING2026\");\n        testSemester.setName(\"Spring 2026\");\n        testSemester.setStartDate(LocalDate.of(2026, 1, 1));\n        testSemester.setEndDate(LocalDate.of(2026, 6, 30));\n        testSemester.setActive(true);\n\n        // Setup test class\n        testClass = new AcademicClass();\n        testClass.setId((short) 1);\n        testClass.setCode(\"SE1801\");\n        testClass.setSemester(testSemester);\n        testClass.setActive(true);\n\n        // Setup test room\n        testRoom = new Room();\n        testRoom.setId((short) 1);\n        testRoom.setName(\"Room 101\");\n        testRoom.setActive(true);\n\n        // Setup test staff\n        testStaff = new User();\n        testStaff.setId(1);\n        testStaff.setUsername(\"lecturer1\");\n        testStaff.setActive(true);\n        com.fuacs.backend.entity.Role lecturerRole = new com.fuacs.backend.entity.Role();\n        lecturerRole.setName(\"LECTURER\");\n        testStaff.setRoles(Set.of(lecturerRole));\n\n        // Setup test student\n        testStudent = new User();\n        testStudent.setId(2);\n        testStudent.setUsername(\"student1\");\n        testStudent.setActive(true);\n\n        // Setup test slot - dates within semester range (Jan 1 - Jun 30, 2026)\n        testSlot = new Slot();\n        testSlot.setId(1);\n        testSlot.setTitle(\"Test Slot\");\n        testSlot.setDescription(\"Test Description\");\n        testSlot.setSlotCategory(SlotCategory.LECTURE);\n        testSlot.setStartTime(LocalDateTime.of(2026, 3, 15, 9, 0));\n        testSlot.setEndTime(LocalDateTime.of(2026, 3, 15, 11, 0));\n        testSlot.setAcademicClass(testClass);\n        testSlot.setSemester(testSemester);\n        testSlot.setRoom(testRoom);\n        testSlot.setStaff(testStaff);\n        testSlot.setActive(true);\n        testSlot.setSessionStatus(SessionStatus.NOT_STARTED);\n        testSlot.setScanCount(0);\n        testSlot.setExamSessionStatus(SessionStatus.NOT_STARTED);\n        testSlot.setExamScanCount(0);\n\n        // Setup test DTO\n        testSlotDTO = new SlotDTO();\n        testSlotDTO.setId(1);\n        testSlotDTO.setTitle(\"Test Slot\");\n        testSlotDTO.setSlotCategory(SlotCategory.LECTURE);\n        testSlotDTO.setStartTime(LocalDateTime.of(2026, 3, 15, 9, 0));\n        testSlotDTO.setEndTime(LocalDateTime.of(2026, 3, 15, 11, 0));\n\n        // Setup create request - dates within semester range (Jan 1 - Jun 30, 2026)\n        createRequest = createSlotCreateRequest(\"New Slot\", SlotCategory.LECTURE, \n            LocalDateTime.of(2026, 3, 15, 9, 0), LocalDateTime.of(2026, 3, 15, 11, 0),\n            (short) 1, (short) 1, (short) 1, 1);\n\n        // Setup update request - dates within semester range\n        updateRequest = createSlotUpdateRequest(\"Updated Slot\", SlotCategory.LECTURE,\n            LocalDateTime.of(2026, 3, 15, 9, 0), LocalDateTime.of(2026, 3, 15, 11, 0),\n            (short) 1, (short) 1, (short) 1, 1, true);\n    }\n\n    // Helper method to create SlotCreateRequest using reflection\n    private SlotCreateRequest createSlotCreateRequest(String title, SlotCategory slotCategory,\n            LocalDateTime startTime, LocalDateTime endTime, Short classId, Short semesterId, Short roomId, Integer staffUserId) {\n        try {\n            SlotCreateRequest request = new SlotCreateRequest();\n            setField(request, \"title\", title);\n            setField(request, \"slotCategory\", slotCategory);\n            setField(request, \"startTime\", startTime);\n            setField(request, \"endTime\", endTime);\n            setField(request, \"classId\", classId);\n            setField(request, \"semesterId\", semesterId);\n            setField(request, \"roomId\", roomId);\n            setField(request, \"staffUserId\", staffUserId);\n            return request;\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    // Helper method to create SlotUpdateRequest using reflection\n    private SlotUpdateRequest createSlotUpdateRequest(String title, SlotCategory slotCategory,\n            LocalDateTime startTime, LocalDateTime endTime, Short classId, Short semesterId, Short roomId, Integer staffUserId, Boolean isActive) {\n        try {\n            SlotUpdateRequest request = new SlotUpdateRequest();\n            setField(request, \"title\", title);\n            setField(request, \"slotCategory\", slotCategory);\n            setField(request, \"startTime\", startTime);\n            setField(request, \"endTime\", endTime);\n            setField(request, \"classId\", classId);\n            setField(request, \"semesterId\", semesterId);\n            setField(request, \"roomId\", roomId);\n            setField(request, \"staffUserId\", staffUserId);\n            setField(request, \"isActive\", isActive);\n            return request;\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    // Helper method to create SlotSearchRequest\n    private SlotSearchRequest createSearchRequest() {\n        return new SlotSearchRequest(null, null, null, null, null, null, null, null, null, null, null, null, null, null);\n    }\n\n    // Helper method to set field using reflection\n    private void setField(Object obj, String fieldName, Object value) throws Exception {\n        Class<?> clazz = obj.getClass();\n        while (clazz != null) {\n            try {\n                java.lang.reflect.Field field = clazz.getDeclaredField(fieldName);\n                field.setAccessible(true);\n                field.set(obj, value);\n                return;\n            } catch (NoSuchFieldException e) {\n                clazz = clazz.getSuperclass();\n            }\n        }\n        throw new NoSuchFieldException(fieldName);\n    }\n\n    // ==================== SEARCH TESTS ====================\n\n    @Test\n    @DisplayName(\"TC01: Search slots successfully\")\n    void testFindAll_Success() {\n        // Arrange\n        SlotSearchRequest searchRequest = createSearchRequest();\n        List<SlotDTO> expectedList = List.of(testSlotDTO);\n        when(slotRepository.search(searchRequest)).thenReturn(expectedList);\n\n        // Act\n        List<SlotDTO> result = slotService.findAll(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(slotRepository, times(1)).search(searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC02: Search returns empty list\")\n    void testFindAll_EmptyResult() {\n        // Arrange\n        SlotSearchRequest searchRequest = createSearchRequest();\n        when(slotRepository.search(searchRequest)).thenReturn(new ArrayList<>());\n\n        // Act\n        List<SlotDTO> result = slotService.findAll(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertTrue(result.isEmpty());\n        verify(slotRepository, times(1)).search(searchRequest);\n    }\n\n    // ==================== COUNT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC03: Count slots successfully\")\n    void testCount_Success() {\n        // Arrange\n        SlotSearchRequest searchRequest = createSearchRequest();\n        when(slotRepository.count(searchRequest)).thenReturn(5L);\n\n        // Act\n        Long result = slotService.count(searchRequest);\n\n        // Assert\n        assertEquals(5L, result);\n        verify(slotRepository, times(1)).count(searchRequest);\n    }\n\n    // ==================== FIND BY ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC04: Find slot by ID successfully\")\n    void testFindById_Success() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testSlot));\n        when(slotMapper.toDTO(testSlot)).thenReturn(testSlotDTO);\n\n        // Act\n        SlotDTO result = slotService.findById(1);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getId());\n        verify(slotRepository, times(1)).findById(1);\n    }\n\n    @Test\n    @DisplayName(\"TC05: Find slot by ID - not found\")\n    void testFindById_NotFound() {\n        // Arrange\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> slotService.findById(999)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"999\"));\n    }\n\n    // ==================== CREATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC06: Create slot successfully\")\n    void testCreate_Success() {\n        // Arrange\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(roomRepository.findById((short) 1)).thenReturn(Optional.of(testRoom));\n        when(userRepository.findById(1)).thenReturn(Optional.of(testStaff));\n        when(slotRepository.existsByRoomAndTimeRange(anyShort(), any(), any(), any())).thenReturn(false);\n        when(slotRepository.existsByStaffAndTimeRange(anyInt(), any(), any(), any())).thenReturn(false);\n        when(slotMapper.toEntity(createRequest)).thenReturn(testSlot);\n        when(slotRepository.save(any(Slot.class))).thenReturn(testSlot);\n        when(slotMapper.toDTO(testSlot)).thenReturn(testSlotDTO);\n\n        // Act\n        SlotDTO result = slotService.create(createRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(slotRepository, times(1)).save(any(Slot.class));\n    }\n\n    @Test\n    @DisplayName(\"TC07: Create slot - invalid time range\")\n    void testCreate_InvalidTimeRange() {\n        // Arrange\n        SlotCreateRequest invalidTimeRequest = createSlotCreateRequest(\"New Slot\", SlotCategory.LECTURE,\n            LocalDateTime.of(2024, 11, 26, 11, 0), LocalDateTime.of(2024, 11, 26, 9, 0),\n            (short) 1, (short) 1, (short) 1, 1);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.create(invalidTimeRequest)\n        );\n        assertEquals(ErrorCode.INVALID_TIME_RANGE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC08: Create FINAL_EXAM slot with classId - should fail\")\n    void testCreate_FinalExamWithClassId() {\n        // Arrange\n        SlotCreateRequest finalExamRequest = createSlotCreateRequest(\"New Slot\", SlotCategory.FINAL_EXAM,\n            LocalDateTime.of(2024, 11, 26, 9, 0), LocalDateTime.of(2024, 11, 26, 11, 0),\n            (short) 1, (short) 1, (short) 1, 1);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.create(finalExamRequest)\n        );\n        assertEquals(ErrorCode.INVALID_SLOT_CATEGORY, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC11: Create LECTURE slot without classId - should fail\")\n    void testCreate_LectureWithoutClassId() {\n        // Arrange\n        SlotCreateRequest noClassRequest = createSlotCreateRequest(\"New Slot\", SlotCategory.LECTURE,\n            LocalDateTime.of(2024, 11, 26, 9, 0), LocalDateTime.of(2024, 11, 26, 11, 0),\n            null, (short) 1, (short) 1, 1);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.create(noClassRequest)\n        );\n        assertEquals(ErrorCode.SLOT_CLASS_ID_REQUIRED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC12: Create slot - room time conflict\")\n    void testCreate_RoomTimeConflict() {\n        // Arrange\n        when(slotRepository.existsByRoomAndTimeRange(anyShort(), any(), any(), any())).thenReturn(true);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.ROOM_TIME_CONFLICT, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC13: Create slot - staff time conflict\")\n    void testCreate_StaffTimeConflict() {\n        // Arrange\n        when(slotRepository.existsByRoomAndTimeRange(anyShort(), any(), any(), any())).thenReturn(false);\n        when(slotRepository.existsByStaffAndTimeRange(anyInt(), any(), any(), any())).thenReturn(true);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.STAFF_TIME_CONFLICT, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC14: Create slot - semester not found\")\n    void testCreate_SemesterNotFound() {\n        // Arrange\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC15: Create slot - inactive semester\")\n    void testCreate_InactiveSemester() {\n        // Arrange\n        testSemester.setActive(false);\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_REFERENCE_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC16: Create slot - class not found\")\n    void testCreate_ClassNotFound() {\n        // Arrange\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(classRepository.findById((short) 1)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.CLASS_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC17: Create slot - inactive class\")\n    void testCreate_InactiveClass() {\n        // Arrange\n        testClass.setActive(false);\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_CLASS_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC18: Create slot - room not found\")\n    void testCreate_RoomNotFound() {\n        // Arrange\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(roomRepository.findById((short) 1)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.ROOM_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC19: Create slot - inactive room\")\n    void testCreate_InactiveRoom() {\n        // Arrange\n        testRoom.setActive(false);\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(roomRepository.findById((short) 1)).thenReturn(Optional.of(testRoom));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_ROOM_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC20: Create slot - staff not found\")\n    void testCreate_StaffNotFound() {\n        // Arrange\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(roomRepository.findById((short) 1)).thenReturn(Optional.of(testRoom));\n        when(userRepository.findById(1)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.USER_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC21: Create slot - inactive staff\")\n    void testCreate_InactiveStaff() {\n        // Arrange\n        testStaff.setActive(false);\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(roomRepository.findById((short) 1)).thenReturn(Optional.of(testRoom));\n        when(userRepository.findById(1)).thenReturn(Optional.of(testStaff));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_STAFF_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC22: Create slot - staff without valid role\")\n    void testCreate_StaffInvalidRole() {\n        // Arrange\n        com.fuacs.backend.entity.Role studentRole = new com.fuacs.backend.entity.Role();\n        studentRole.setName(\"STUDENT\");\n        testStaff.setRoles(Set.of(studentRole));\n        \n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(roomRepository.findById((short) 1)).thenReturn(Optional.of(testRoom));\n        when(userRepository.findById(1)).thenReturn(Optional.of(testStaff));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.create(createRequest)\n        );\n        assertEquals(ErrorCode.INVALID_STAFF_ROLE_FOR_SLOT, exception.getErrorCode());\n    }\n\n    // ==================== UPDATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC23: Update slot successfully\")\n    void testUpdate_Success() {\n        // Arrange - Set slot time within semester date range (Jan 1 - Jun 30, 2026)\n        LocalDateTime futureStart = LocalDateTime.of(2026, 3, 15, 9, 0);\n        LocalDateTime futureEnd = LocalDateTime.of(2026, 3, 15, 11, 0);\n        testSlot.setStartTime(futureStart);\n        testSlot.setEndTime(futureEnd);\n        \n        SlotUpdateRequest futureUpdateRequest = createSlotUpdateRequest(\"Updated Slot\", SlotCategory.LECTURE,\n            futureStart, futureEnd, (short) 1, (short) 1, (short) 1, 1, true);\n        \n        when(slotRepository.findById(1)).thenReturn(Optional.of(testSlot));\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(classRepository.existsById((short) 1)).thenReturn(true);\n        when(semesterRepository.existsById((short) 1)).thenReturn(true);\n        when(roomRepository.existsById((short) 1)).thenReturn(true);\n        when(roomRepository.findById((short) 1)).thenReturn(Optional.of(testRoom));\n        when(userRepository.existsById(1)).thenReturn(true);\n        when(userRepository.findById(1)).thenReturn(Optional.of(testStaff));\n        when(slotRepository.existsByRoomAndTimeRange(anyShort(), any(), any(), anyInt())).thenReturn(false);\n        when(slotRepository.existsByStaffAndTimeRange(anyInt(), any(), any(), anyInt())).thenReturn(false);\n        when(slotRepository.save(testSlot)).thenReturn(testSlot);\n        when(slotMapper.toDTO(testSlot)).thenReturn(testSlotDTO);\n\n        // Act\n        SlotDTO result = slotService.update(1, futureUpdateRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(slotRepository, times(1)).save(testSlot);\n    }\n\n    @Test\n    @DisplayName(\"TC24: Update slot - not found\")\n    void testUpdate_NotFound() {\n        // Arrange\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> slotService.update(999, updateRequest)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC25: Update slot - invalid time range\")\n    void testUpdate_InvalidTimeRange() {\n        // Arrange\n        SlotUpdateRequest invalidTimeUpdateRequest = createSlotUpdateRequest(\"Updated Slot\", SlotCategory.LECTURE,\n            LocalDateTime.of(2024, 11, 25, 11, 0), LocalDateTime.of(2024, 11, 25, 9, 0),\n            (short) 1, (short) 1, (short) 1, 1, true);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testSlot));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.update(1, invalidTimeUpdateRequest)\n        );\n        assertEquals(ErrorCode.INVALID_TIME_RANGE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC26: Update slot - room time conflict\")\n    void testUpdate_RoomTimeConflict() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testSlot));\n        when(slotRepository.existsByRoomAndTimeRange(anyShort(), any(), any(), anyInt())).thenReturn(true);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.update(1, updateRequest)\n        );\n        assertEquals(ErrorCode.ROOM_TIME_CONFLICT, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC27: Update slot - staff time conflict\")\n    void testUpdate_StaffTimeConflict() {\n        // Arrange\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testSlot));\n        when(slotRepository.existsByRoomAndTimeRange(anyShort(), any(), any(), anyInt())).thenReturn(false);\n        when(slotRepository.existsByStaffAndTimeRange(anyInt(), any(), any(), anyInt())).thenReturn(true);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.update(1, updateRequest)\n        );\n        assertEquals(ErrorCode.STAFF_TIME_CONFLICT, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC28: Update inactive slot - should fail\")\n    void testUpdate_InactiveSlot() {\n        // Arrange - Set slot time within semester (Jan 1 - Jun 30, 2026) and inactive\n        LocalDateTime futureStart = LocalDateTime.of(2026, 3, 15, 9, 0);\n        LocalDateTime futureEnd = LocalDateTime.of(2026, 3, 15, 11, 0);\n        testSlot.setStartTime(futureStart);\n        testSlot.setEndTime(futureEnd);\n        testSlot.setActive(false);\n        \n        SlotUpdateRequest inactiveUpdateRequest = createSlotUpdateRequest(\"Updated Slot\", SlotCategory.LECTURE,\n            futureStart, futureEnd, (short) 1, (short) 1, (short) 1, 1, false);\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testSlot));\n        when(semesterRepository.existsById((short) 1)).thenReturn(true);\n        when(semesterRepository.findById((short) 1)).thenReturn(Optional.of(testSemester));\n        when(classRepository.existsById((short) 1)).thenReturn(true);\n        when(classRepository.findById((short) 1)).thenReturn(Optional.of(testClass));\n        when(roomRepository.existsById((short) 1)).thenReturn(true);\n        when(roomRepository.findById((short) 1)).thenReturn(Optional.of(testRoom));\n        when(userRepository.existsById(1)).thenReturn(true);\n        when(userRepository.findById(1)).thenReturn(Optional.of(testStaff));\n        when(slotRepository.existsByRoomAndTimeRange(anyShort(), any(), any(), anyInt())).thenReturn(false);\n        when(slotRepository.existsByStaffAndTimeRange(anyInt(), any(), any(), anyInt())).thenReturn(false);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> slotService.update(1, inactiveUpdateRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_SLOT_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    // ==================== DELETE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC29: Delete slot successfully\")\n    void testDelete_Success() {\n        // Arrange\n        LocalDateTime futureTime = LocalDateTime.now(ZoneId.of(\"Asia/Ho_Chi_Minh\")).plusDays(1);\n        testSlot.setStartTime(futureTime);\n        testSlot.setEndTime(futureTime.plusHours(2));\n        \n        when(slotRepository.findById(1)).thenReturn(Optional.of(testSlot));\n        when(attendanceRecordRepository.findBySlotIdAndStatus(1, AttendanceStatus.NOT_YET))\n            .thenReturn(new ArrayList<>());\n        when(examAttendanceRepository.findBySlotIdAndStatus(1, AttendanceStatus.NOT_YET))\n            .thenReturn(new ArrayList<>());\n        doNothing().when(slotRepository).deleteById(1);\n\n        // Act\n        slotService.delete(1);\n\n        // Assert\n        verify(slotRepository, times(1)).deleteById(1);\n    }\n\n    @Test\n    @DisplayName(\"TC30: Delete slot - not found\")\n    void testDelete_NotFound() {\n        // Arrange\n        when(slotRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> slotService.delete(999)\n        );\n        assertEquals(ErrorCode.SLOT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC31: Delete slot - already started\")\n    void testDelete_AlreadyStarted() {\n        // Arrange\n        LocalDateTime pastTime = LocalDateTime.now(ZoneId.of(\"Asia/Ho_Chi_Minh\")).minusHours(1);\n        testSlot.setStartTime(pastTime);\n        testSlot.setEndTime(pastTime.plusHours(2));\n        when(slotRepository.findById(1)).thenReturn(Optional.of(testSlot));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> slotService.delete(1)\n        );\n        assertEquals(ErrorCode.SLOT_ALREADY_STARTED, exception.getErrorCode());\n    }\n\n    // ==================== SEARCH BY STAFF TESTS ====================\n\n    @Test\n    @DisplayName(\"TC32: Search slots by staff ID successfully\")\n    void testSearchByStaffId_Success() {\n        // Arrange\n        SlotSearchRequest searchRequest = createSearchRequest();\n        List<SlotDTO> expectedList = List.of(testSlotDTO);\n        when(slotRepository.search(any(SlotSearchRequest.class))).thenReturn(expectedList);\n\n        // Act\n        List<SlotDTO> result = slotService.searchByStaffId(1, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(slotRepository, times(1)).search(any(SlotSearchRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC33: Count slots by staff ID successfully\")\n    void testCountByStaffId_Success() {\n        // Arrange\n        SlotSearchRequest searchRequest = createSearchRequest();\n        when(slotRepository.count(any(SlotSearchRequest.class))).thenReturn(3L);\n\n        // Act\n        Long result = slotService.countByStaffId(1, searchRequest);\n\n        // Assert\n        assertEquals(3L, result);\n        verify(slotRepository, times(1)).count(any(SlotSearchRequest.class));\n    }\n\n    // ==================== SEARCH BY STUDENT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC34: Search slots by student ID successfully\")\n    void testSearchByStudentId_Success() {\n        // Arrange\n        SlotSearchRequest searchRequest = createSearchRequest();\n        List<SlotDTO> expectedList = List.of(testSlotDTO);\n        when(slotRepository.searchByStudentId(any(SlotSearchRequest.class))).thenReturn(expectedList);\n        when(attendanceRecordRepository.findStatusesBySlotIdsAndStudent(anyList(), anyInt()))\n            .thenReturn(new ArrayList<>());\n        when(examAttendanceRepository.findStatusesBySlotIdsAndStudent(anyList(), anyInt()))\n            .thenReturn(new ArrayList<>());\n\n        // Act\n        List<SlotDTO> result = slotService.searchByStudentId(2, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(slotRepository, times(1)).searchByStudentId(any(SlotSearchRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC35: Count slots by student ID successfully\")\n    void testCountByStudentId_Success() {\n        // Arrange\n        SlotSearchRequest searchRequest = createSearchRequest();\n        when(slotRepository.countByStudentId(any(SlotSearchRequest.class))).thenReturn(5L);\n\n        // Act\n        Long result = slotService.countByStudentId(2, searchRequest);\n\n        // Assert\n        assertEquals(5L, result);\n        verify(slotRepository, times(1)).countByStudentId(any(SlotSearchRequest.class));\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\StaffProfileServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/StaffProfileServiceTest.java",
      "filename": "StaffProfileServiceTest.java",
      "size_bytes": 28503,
      "lines": 661,
      "last_modified": "2025-11-28T08:56:33.049105",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.constant.ImportMode;\nimport com.fuacs.backend.dto.request.StaffProfileCreateRequest;\nimport com.fuacs.backend.dto.request.StaffProfileCsvRow;\nimport com.fuacs.backend.dto.request.StaffProfileSearchRequest;\nimport com.fuacs.backend.dto.request.StaffProfileUpdateRequest;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.StaffProfileDTO;\nimport com.fuacs.backend.entity.Role;\nimport com.fuacs.backend.entity.Slot;\nimport com.fuacs.backend.entity.StaffProfile;\nimport com.fuacs.backend.entity.User;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.RoleRepository;\nimport com.fuacs.backend.repository.SlotRepository;\nimport com.fuacs.backend.repository.StaffProfileRepository;\nimport com.fuacs.backend.repository.UserRepository;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\nimport org.springframework.mock.web.MockMultipartFile;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.io.IOException;\nimport java.time.Instant;\nimport java.util.*;\n\nimport static org.junit.jupiter.api.Assertions.*;\nimport static org.mockito.ArgumentMatchers.*;\nimport static org.mockito.Mockito.*;\n\nimport org.mockito.junit.jupiter.MockitoSettings;\nimport org.mockito.quality.Strictness;\n\n@ExtendWith(MockitoExtension.class)\n@MockitoSettings(strictness = Strictness.LENIENT)\n@DisplayName(\"StaffProfileService Unit Tests\")\nclass StaffProfileServiceTest {\n\n    @Mock\n    private StaffProfileRepository staffProfileRepository;\n\n    @Mock\n    private UserRepository userRepository;\n\n    @Mock\n    private RoleRepository roleRepository;\n\n    @Mock\n    private PasswordEncoder passwordEncoder;\n\n    @Mock\n    private EmailService emailService;\n\n    @Mock\n    private SlotRepository slotRepository;\n\n    @Mock\n    private CsvParserService csvParserService;\n\n    @InjectMocks\n    private StaffProfileService staffProfileService;\n\n    private StaffProfile testStaffProfile;\n    private User testUser;\n    private Role testRole;\n    private StaffProfileDTO testStaffProfileDTO;\n    private StaffProfileCreateRequest createRequest;\n    private StaffProfileUpdateRequest updateRequest;\n\n    @BeforeEach\n    void setUp() {\n        testRole = new Role();\n        testRole.setId((short) 1);\n        testRole.setName(\"TEACHER\");\n\n        testUser = new User();\n        testUser.setId(1);\n        testUser.setUsername(\"staff001\");\n        testUser.setEmail(\"staff001@example.com\");\n        testUser.setFullName(\"Test Staff\");\n        testUser.setPasswordHash(\"hashedPassword\");\n        testUser.setActive(true);\n        testUser.setRoles(Set.of(testRole));\n        testUser.setCreatedAt(Instant.now());\n        testUser.setUpdatedAt(Instant.now());\n\n        testStaffProfile = new StaffProfile();\n        testStaffProfile.setUserId(1);\n        testStaffProfile.setStaffCode(\"STAFF001\");\n        testStaffProfile.setUser(testUser);\n\n        testStaffProfileDTO = new StaffProfileDTO();\n        testStaffProfileDTO.setUserId(1);\n        testStaffProfileDTO.setUsername(\"staff001\");\n        testStaffProfileDTO.setEmail(\"staff001@example.com\");\n        testStaffProfileDTO.setFullName(\"Test Staff\");\n        testStaffProfileDTO.setStaffCode(\"STAFF001\");\n        testStaffProfileDTO.setRoles(List.of(\"TEACHER\"));\n        testStaffProfileDTO.setActive(true);\n\n        createRequest = new StaffProfileCreateRequest();\n        createRequest.setUsername(\"staff002\");\n        createRequest.setStaffCode(\"STAFF002\");\n        createRequest.setFullName(\"New Staff\");\n        createRequest.setEmail(\"staff002@example.com\");\n        createRequest.setRoles(Set.of(\"TEACHER\"));\n        createRequest.setPassword(\"password123\");\n\n        updateRequest = createStaffProfileUpdateRequest(\"STAFF001\", \"Updated Staff\", \"staff001@example.com\", Set.of(\"TEACHER\"), true);\n    }\n\n    // Helper method to create StaffProfileUpdateRequest using reflection\n    private StaffProfileUpdateRequest createStaffProfileUpdateRequest(String staffCode, String fullName, String email, Set<String> roles, Boolean isActive) {\n        try {\n            StaffProfileUpdateRequest request = new StaffProfileUpdateRequest();\n            setField(request, \"staffCode\", staffCode);\n            setField(request, \"fullName\", fullName);\n            setField(request, \"email\", email);\n            setField(request, \"roles\", roles);\n            setField(request, \"isActive\", isActive);\n            return request;\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    // Helper method to create StaffProfileSearchRequest\n    private StaffProfileSearchRequest createSearchRequest() {\n        return new StaffProfileSearchRequest(null, null, null, null, null, null, null, null);\n    }\n\n    // Helper method to set field using reflection\n    private void setField(Object obj, String fieldName, Object value) throws Exception {\n        Class<?> clazz = obj.getClass();\n        while (clazz != null) {\n            try {\n                java.lang.reflect.Field field = clazz.getDeclaredField(fieldName);\n                field.setAccessible(true);\n                field.set(obj, value);\n                return;\n            } catch (NoSuchFieldException e) {\n                clazz = clazz.getSuperclass();\n            }\n        }\n        throw new NoSuchFieldException(fieldName);\n    }\n\n    // ==================== SEARCH TESTS ====================\n\n    @Test\n    @DisplayName(\"TC01: Search staff profiles successfully\")\n    void testSearch_Success() {\n        // Arrange\n        StaffProfileSearchRequest searchRequest = createSearchRequest();\n        List<StaffProfileDTO> expectedList = List.of(testStaffProfileDTO);\n        when(staffProfileRepository.search(searchRequest)).thenReturn(expectedList);\n        when(staffProfileRepository.count(searchRequest)).thenReturn(1L);\n\n        // Act\n        PagingResponse<StaffProfileDTO> result = staffProfileService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        @SuppressWarnings(\"unchecked\")\n        PagingResponse<StaffProfileDTO>.PageableResponse pageableResponse = \n            (PagingResponse<StaffProfileDTO>.PageableResponse) result.getData();\n        assertEquals(1, pageableResponse.getItems().size());\n        assertEquals(1L, pageableResponse.getTotalItems());\n        verify(staffProfileRepository, times(1)).search(searchRequest);\n        verify(staffProfileRepository, times(1)).count(searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC02: Search returns empty list\")\n    void testSearch_EmptyResult() {\n        // Arrange\n        StaffProfileSearchRequest searchRequest = createSearchRequest();\n        when(staffProfileRepository.search(searchRequest)).thenReturn(new ArrayList<>());\n        when(staffProfileRepository.count(searchRequest)).thenReturn(0L);\n\n        // Act\n        PagingResponse<StaffProfileDTO> result = staffProfileService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        @SuppressWarnings(\"unchecked\")\n        PagingResponse<StaffProfileDTO>.PageableResponse pageableResponse = \n            (PagingResponse<StaffProfileDTO>.PageableResponse) result.getData();\n        assertTrue(pageableResponse.getItems().isEmpty());\n        assertEquals(0L, pageableResponse.getTotalItems());\n        verify(staffProfileRepository, times(1)).search(searchRequest);\n    }\n\n    // ==================== FIND BY ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC03: Find staff profile by ID successfully\")\n    void testFindById_Success() {\n        // Arrange\n        when(staffProfileRepository.findById(1)).thenReturn(Optional.of(testStaffProfile));\n\n        // Act\n        StaffProfileDTO result = staffProfileService.findById(1);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getUserId());\n        assertEquals(\"STAFF001\", result.getStaffCode());\n        assertEquals(\"Test Staff\", result.getFullName());\n        verify(staffProfileRepository, times(1)).findById(1);\n    }\n\n    @Test\n    @DisplayName(\"TC04: Find staff profile by ID - not found\")\n    void testFindById_NotFound() {\n        // Arrange\n        when(staffProfileRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> staffProfileService.findById(999)\n        );\n        assertEquals(ErrorCode.STAFF_PROFILE_NOT_FOUND, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"999\"));\n    }\n\n    // ==================== CREATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC05: Create staff profile successfully\")\n    void testCreate_Success() {\n        // Arrange\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(false);\n        when(staffProfileRepository.existsByStaffCode(createRequest.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(false);\n        when(roleRepository.findByNameIn(createRequest.getRoles())).thenReturn(List.of(testRole));\n        when(passwordEncoder.encode(anyString())).thenReturn(\"hashedPassword\");\n        when(userRepository.save(any(User.class))).thenReturn(testUser);\n        when(staffProfileRepository.save(any(StaffProfile.class))).thenReturn(testStaffProfile);\n\n        // Act\n        StaffProfileDTO result = staffProfileService.create(createRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(\"Test Staff\", result.getFullName());\n        verify(userRepository, times(1)).save(any(User.class));\n        verify(staffProfileRepository, times(1)).save(any(StaffProfile.class));\n        verify(emailService, never()).sendPassword(anyString(), anyString());\n    }\n\n    @Test\n    @DisplayName(\"TC06: Create staff profile - username exists\")\n    void testCreate_UsernameExists() {\n        // Arrange\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> staffProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.USERNAME_EXISTS, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(createRequest.getUsername()));\n    }\n\n    @Test\n    @DisplayName(\"TC07: Create staff profile - staff code exists\")\n    void testCreate_StaffCodeExists() {\n        // Arrange\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(false);\n        when(staffProfileRepository.existsByStaffCode(createRequest.getStaffCode())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> staffProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.STAFF_CODE_EXISTS, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(createRequest.getStaffCode()));\n    }\n\n    @Test\n    @DisplayName(\"TC08: Create staff profile - email exists\")\n    void testCreate_EmailExists() {\n        // Arrange\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(false);\n        when(staffProfileRepository.existsByStaffCode(createRequest.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> staffProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.EMAIL_EXISTS, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(createRequest.getEmail()));\n    }\n\n    @Test\n    @DisplayName(\"TC09: Create staff profile - invalid role\")\n    void testCreate_InvalidRole() {\n        // Arrange\n        createRequest.setRoles(Set.of(\"INVALID_ROLE\"));\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(false);\n        when(staffProfileRepository.existsByStaffCode(createRequest.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(false);\n        when(roleRepository.findByNameIn(createRequest.getRoles())).thenReturn(new ArrayList<>());\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> staffProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.INVALID_ROLE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC10: Create staff profile - STUDENT role not allowed\")\n    void testCreate_StudentRoleNotAllowed() {\n        // Arrange\n        Role studentRole = new Role();\n        studentRole.setId((short) 2);\n        studentRole.setName(\"STUDENT\");\n        createRequest.setRoles(Set.of(\"STUDENT\"));\n        \n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(false);\n        when(staffProfileRepository.existsByStaffCode(createRequest.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(false);\n        when(roleRepository.findByNameIn(createRequest.getRoles())).thenReturn(List.of(studentRole));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> staffProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.INVALID_ROLE, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"STUDENT\"));\n    }\n\n    @Test\n    @DisplayName(\"TC11: Create staff profile - no roles provided\")\n    void testCreate_NoRoles() {\n        // Arrange\n        createRequest.setRoles(null);\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(false);\n        when(staffProfileRepository.existsByStaffCode(createRequest.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(false);\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> staffProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.ROLES_REQUIRED, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC12: Create staff profile - auto-generate password\")\n    void testCreate_AutoGeneratePassword() {\n        // Arrange\n        createRequest.setPassword(null);\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(false);\n        when(staffProfileRepository.existsByStaffCode(createRequest.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(false);\n        when(roleRepository.findByNameIn(createRequest.getRoles())).thenReturn(List.of(testRole));\n        when(passwordEncoder.encode(anyString())).thenReturn(\"hashedPassword\");\n        when(userRepository.save(any(User.class))).thenReturn(testUser);\n        when(staffProfileRepository.save(any(StaffProfile.class))).thenReturn(testStaffProfile);\n        doNothing().when(emailService).sendPassword(anyString(), anyString());\n\n        // Act\n        StaffProfileDTO result = staffProfileService.create(createRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(emailService, times(1)).sendPassword(eq(createRequest.getEmail()), anyString());\n    }\n\n    // ==================== UPDATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC13: Update staff profile successfully\")\n    void testUpdate_Success() {\n        // Arrange\n        when(staffProfileRepository.findById(1)).thenReturn(Optional.of(testStaffProfile));\n        when(staffProfileRepository.existsByStaffCodeAndUserIdNot(anyString(), anyInt())).thenReturn(false);\n        when(userRepository.existsByEmailAndIdNot(anyString(), anyInt())).thenReturn(false);\n        when(roleRepository.findByNameIn(updateRequest.getRoles())).thenReturn(List.of(testRole));\n        when(userRepository.save(any(User.class))).thenReturn(testUser);\n        when(staffProfileRepository.save(any(StaffProfile.class))).thenReturn(testStaffProfile);\n\n        // Act\n        StaffProfileDTO result = staffProfileService.update(1, updateRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(\"Updated Staff\", result.getFullName());\n        verify(userRepository, times(1)).save(any(User.class));\n        verify(staffProfileRepository, times(1)).save(any(StaffProfile.class));\n    }\n\n    @Test\n    @DisplayName(\"TC14: Update staff profile - not found\")\n    void testUpdate_NotFound() {\n        // Arrange\n        when(staffProfileRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> staffProfileService.update(999, updateRequest)\n        );\n        assertEquals(ErrorCode.STAFF_PROFILE_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC15: Update staff profile - staff code exists\")\n    void testUpdate_StaffCodeExists() {\n        // Arrange\n        StaffProfileUpdateRequest codeUpdateRequest = createStaffProfileUpdateRequest(\"STAFF999\", \"Updated Staff\", \"staff001@example.com\", Set.of(\"TEACHER\"), true);\n        when(staffProfileRepository.findById(1)).thenReturn(Optional.of(testStaffProfile));\n        when(staffProfileRepository.existsByStaffCodeAndUserIdNot(\"STAFF999\", 1)).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> staffProfileService.update(1, codeUpdateRequest)\n        );\n        assertEquals(ErrorCode.STAFF_CODE_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC16: Update staff profile - email exists\")\n    void testUpdate_EmailExists() {\n        // Arrange\n        StaffProfileUpdateRequest emailUpdateRequest = createStaffProfileUpdateRequest(\"STAFF001\", \"Updated Staff\", \"existing@example.com\", Set.of(\"TEACHER\"), true);\n        when(staffProfileRepository.findById(1)).thenReturn(Optional.of(testStaffProfile));\n        when(staffProfileRepository.existsByStaffCodeAndUserIdNot(anyString(), anyInt())).thenReturn(false);\n        when(userRepository.existsByEmailAndIdNot(\"existing@example.com\", 1)).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> staffProfileService.update(1, emailUpdateRequest)\n        );\n        assertEquals(ErrorCode.EMAIL_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC17: Update staff profile - invalid role\")\n    void testUpdate_InvalidRole() {\n        // Arrange\n        // Use reflection to set roles since there's no setter\n        try {\n            java.lang.reflect.Field rolesField = StaffProfileUpdateRequest.class.getDeclaredField(\"roles\");\n            rolesField.setAccessible(true);\n            rolesField.set(updateRequest, Set.of(\"INVALID_ROLE\"));\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n        when(staffProfileRepository.findById(1)).thenReturn(Optional.of(testStaffProfile));\n        when(staffProfileRepository.existsByStaffCodeAndUserIdNot(anyString(), anyInt())).thenReturn(false);\n        when(userRepository.existsByEmailAndIdNot(anyString(), anyInt())).thenReturn(false);\n        when(roleRepository.findByNameIn(updateRequest.getRoles())).thenReturn(new ArrayList<>());\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> staffProfileService.update(1, updateRequest)\n        );\n        assertEquals(ErrorCode.INVALID_ROLE, exception.getErrorCode());\n    }\n\n    // ==================== DELETE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC18: Delete staff profile successfully\")\n    void testDelete_Success() {\n        // Arrange\n        when(staffProfileRepository.findById(1)).thenReturn(Optional.of(testStaffProfile));\n        when(slotRepository.findByStaffUserId(1)).thenReturn(new ArrayList<>());\n        doNothing().when(staffProfileRepository).deleteById(1);\n        doNothing().when(userRepository).deleteById(1);\n\n        // Act\n        staffProfileService.delete(1);\n\n        // Assert\n        verify(staffProfileRepository, times(1)).deleteById(1);\n        verify(userRepository, times(1)).deleteById(1);\n    }\n\n    @Test\n    @DisplayName(\"TC19: Delete staff profile - not found\")\n    void testDelete_NotFound() {\n        // Arrange\n        when(staffProfileRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> staffProfileService.delete(999)\n        );\n        assertEquals(ErrorCode.STAFF_PROFILE_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC20: Delete staff profile - has active slots\")\n    void testDelete_HasActiveSlots() {\n        // Arrange\n        Slot slot = new Slot();\n        when(staffProfileRepository.findById(1)).thenReturn(Optional.of(testStaffProfile));\n        when(slotRepository.findByStaffUserId(1)).thenReturn(List.of(slot));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> staffProfileService.delete(1)\n        );\n        assertEquals(ErrorCode.FOREIGN_KEY_CONSTRAINT_VIOLATION, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"active assignments\"));\n    }\n\n    // ==================== IMPORT CSV TESTS ====================\n\n    @Test\n    @DisplayName(\"TC21: Import CSV - AddOnly mode success\")\n    void testImportFromCsv_AddOnly_Success() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<StaffProfileCsvRow> rows = new ArrayList<>();\n        StaffProfileCsvRow row = new StaffProfileCsvRow();\n        row.setRowNumber(2);\n        row.setStaffCode(\"STAFF003\");\n        row.setFullName(\"CSV Staff\");\n        row.setEmail(\"csv@example.com\");\n        row.setRolesStr(\"TEACHER\");\n        row.setPassword(\"hashedPassword\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseStaffProfileCsv(file)).thenReturn(rows);\n        when(staffProfileRepository.findByStaffCode(\"STAFF003\")).thenReturn(null);\n        when(userRepository.existsByEmail(\"csv@example.com\")).thenReturn(false);\n        when(roleRepository.findByNameIn(any())).thenReturn(List.of(testRole));\n        when(userRepository.save(any(User.class))).thenReturn(testUser);\n        when(staffProfileRepository.save(any(StaffProfile.class))).thenReturn(testStaffProfile);\n\n        // Act\n        ImportResultDTO result = staffProfileService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC22: Import CSV - invalid mode\")\n    void testImportFromCsv_InvalidMode() {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> staffProfileService.importFromCsv(file, \"InvalidMode\")\n        );\n        assertEquals(ErrorCode.INVALID_IMPORT_MODE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC23: Import CSV - file processing error\")\n    void testImportFromCsv_FileProcessingError() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        when(csvParserService.parseStaffProfileCsv(file)).thenThrow(new IOException(\"File error\"));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> staffProfileService.importFromCsv(file, \"AddOnly\")\n        );\n        assertEquals(ErrorCode.FILE_PROCESSING_ERROR, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC24: Import CSV - AddAndUpdate mode updates existing\")\n    void testImportFromCsv_AddAndUpdate_UpdatesExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<StaffProfileCsvRow> rows = new ArrayList<>();\n        StaffProfileCsvRow row = new StaffProfileCsvRow();\n        row.setRowNumber(2);\n        row.setStaffCode(\"STAFF001\");\n        row.setFullName(\"Updated CSV Staff\");\n        row.setEmail(\"staff001@example.com\");\n        row.setRolesStr(\"TEACHER\");\n        row.setPassword(\"hashedPassword\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseStaffProfileCsv(file)).thenReturn(rows);\n        when(staffProfileRepository.findByStaffCode(\"STAFF001\")).thenReturn(testStaffProfile);\n        when(roleRepository.findByNameIn(any())).thenReturn(List.of(testRole));\n        when(userRepository.save(any(User.class))).thenReturn(testUser);\n\n        // Act\n        ImportResultDTO result = staffProfileService.importFromCsv(file, \"AddAndUpdate\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC25: Import CSV - AddOnly mode fails on existing code\")\n    void testImportFromCsv_AddOnly_FailsOnExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<StaffProfileCsvRow> rows = new ArrayList<>();\n        StaffProfileCsvRow row = new StaffProfileCsvRow();\n        row.setRowNumber(2);\n        row.setStaffCode(\"STAFF001\");\n        row.setFullName(\"Existing Staff\");\n        row.setEmail(\"staff001@example.com\");\n        row.setRolesStr(\"TEACHER\");\n        row.setPassword(\"hashedPassword\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseStaffProfileCsv(file)).thenReturn(rows);\n        when(staffProfileRepository.findByStaffCode(\"STAFF001\")).thenReturn(testStaffProfile);\n        when(roleRepository.findByNameIn(any())).thenReturn(List.of(testRole));\n\n        // Act\n        ImportResultDTO result = staffProfileService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(1, result.getErrors().size());\n        assertEquals(ErrorCode.STAFF_CODE_EXISTS, result.getErrors().get(0).getErrorCode());\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\StudentProfileServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/StudentProfileServiceTest.java",
      "filename": "StudentProfileServiceTest.java",
      "size_bytes": 38034,
      "lines": 877,
      "last_modified": "2025-11-28T08:56:33.050107",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.constant.ImportMode;\nimport com.fuacs.backend.constant.enums.Role;\nimport com.fuacs.backend.dto.mapper.StudentProfileMapper;\nimport com.fuacs.backend.dto.mapper.UserMapper;\nimport com.fuacs.backend.dto.request.StudentProfileCreateRequest;\nimport com.fuacs.backend.dto.request.StudentProfileCsvRow;\nimport com.fuacs.backend.dto.request.StudentProfileSearchRequest;\nimport com.fuacs.backend.dto.request.StudentProfileUpdateRequest;\nimport com.fuacs.backend.dto.request.StudentSemesterSearchRequest;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.MajorDTO;\nimport com.fuacs.backend.dto.response.StudentProfileDTO;\nimport com.fuacs.backend.dto.response.StudentSemesterDTO;\nimport com.fuacs.backend.entity.Major;\nimport com.fuacs.backend.entity.StudentProfile;\nimport com.fuacs.backend.entity.User;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.MajorRepository;\nimport com.fuacs.backend.repository.RoleRepository;\nimport com.fuacs.backend.repository.StudentProfileRepository;\nimport com.fuacs.backend.repository.UserRepository;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\nimport org.springframework.dao.DataIntegrityViolationException;\nimport org.springframework.mock.web.MockMultipartFile;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.io.IOException;\nimport java.time.Instant;\nimport java.util.*;\n\nimport static org.junit.jupiter.api.Assertions.*;\nimport static org.mockito.ArgumentMatchers.*;\nimport static org.mockito.Mockito.*;\n\nimport org.mockito.junit.jupiter.MockitoSettings;\nimport org.mockito.quality.Strictness;\n\n@ExtendWith(MockitoExtension.class)\n@MockitoSettings(strictness = Strictness.LENIENT)\n@DisplayName(\"StudentProfileService Unit Tests\")\nclass StudentProfileServiceTest {\n\n    @Mock\n    private StudentProfileRepository studentRepository;\n\n    @Mock\n    private MajorRepository majorRepository;\n\n    @Mock\n    private UserMapper userMapper;\n\n    @Mock\n    private StudentProfileMapper studentProfileMapper;\n\n    @Mock\n    private PasswordEncoder passwordEncoder;\n\n    @Mock\n    private EmailService emailService;\n\n    @Mock\n    private RoleRepository roleRepository;\n\n    @Mock\n    private UserRepository userRepository;\n\n    @Mock\n    private SemesterService semesterService;\n\n    @Mock\n    private MajorService majorService;\n\n    @Mock\n    private CsvParserService csvParserService;\n\n    @InjectMocks\n    private StudentProfileService studentProfileService;\n\n    private StudentProfile testStudentProfile;\n    private StudentProfileDTO testStudentProfileDTO;\n    private User testUser;\n    private Major testMajor;\n    private com.fuacs.backend.entity.Role testRole;\n    private StudentProfileCreateRequest createRequest;\n    private StudentProfileUpdateRequest updateRequest;\n\n    @BeforeEach\n    void setUp() {\n        testMajor = new Major();\n        testMajor.setId((short) 1);\n        testMajor.setCode(\"SE\");\n        testMajor.setName(\"Software Engineering\");\n        testMajor.setActive(true);\n        testMajor.setCreatedAt(Instant.now());\n\n        testRole = new com.fuacs.backend.entity.Role();\n        testRole.setId((short) 1);\n        testRole.setName(\"STUDENT\");\n\n        testUser = new User();\n        testUser.setId(1);\n        testUser.setUsername(\"student001\");\n        testUser.setEmail(\"student001@example.com\");\n        testUser.setFullName(\"Test Student\");\n        testUser.setPasswordHash(\"hashedPassword\");\n        testUser.setActive(true);\n        testUser.setRoles(Set.of(testRole));\n        testUser.setCreatedAt(Instant.now());\n\n        testStudentProfile = new StudentProfile();\n        testStudentProfile.setUserId(1);\n        testStudentProfile.setUser(testUser);\n        testStudentProfile.setMajor(testMajor);\n        testStudentProfile.setRollNumber(\"SE001\");\n\n        testStudentProfileDTO = new StudentProfileDTO();\n        testStudentProfileDTO.setUserId(1);\n        testStudentProfileDTO.setUsername(\"student001\");\n        testStudentProfileDTO.setEmail(\"student001@example.com\");\n        testStudentProfileDTO.setFullName(\"Test Student\");\n        testStudentProfileDTO.setRollNumber(\"SE001\");\n        MajorDTO majorDTO = new MajorDTO();\n        majorDTO.setId((short) 1);\n        majorDTO.setName(\"Software Engineering\");\n        testStudentProfileDTO.setMajor(majorDTO);\n        testStudentProfileDTO.setActive(true);\n        testStudentProfileDTO.setRoles(Set.of(\"STUDENT\"));\n\n        createRequest = createStudentProfileCreateRequest(\"student002\", \"student002@example.com\", \"New Student\", \"SE002\", (short) 1);\n\n        updateRequest = createStudentProfileUpdateRequest(\"student001\", \"student001@example.com\", \"Updated Student\", \"SE001\", (short) 1, true);\n    }\n\n    // Helper method to create StudentProfileCreateRequest using reflection\n    private StudentProfileCreateRequest createStudentProfileCreateRequest(String username, String email, String fullName, String rollNumber, Short majorId) {\n        try {\n            StudentProfileCreateRequest request = new StudentProfileCreateRequest();\n            setField(request, \"username\", username);\n            setField(request, \"email\", email);\n            setField(request, \"fullName\", fullName);\n            setField(request, \"rollNumber\", rollNumber);\n            setField(request, \"majorId\", majorId);\n            return request;\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    // Helper method to create StudentProfileUpdateRequest using reflection\n    private StudentProfileUpdateRequest createStudentProfileUpdateRequest(String username, String email, String fullName, String rollNumber, Short majorId, Boolean isActive) {\n        try {\n            StudentProfileUpdateRequest request = new StudentProfileUpdateRequest();\n            setField(request, \"username\", username);\n            setField(request, \"email\", email);\n            setField(request, \"fullName\", fullName);\n            setField(request, \"rollNumber\", rollNumber);\n            setField(request, \"majorId\", majorId);\n            setField(request, \"isActive\", isActive);\n            return request;\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    // Helper method to create StudentProfileSearchRequest\n    private StudentProfileSearchRequest createSearchRequest() {\n        return new StudentProfileSearchRequest(null, null, null, null, null, null);\n    }\n\n    // Helper method to set field using reflection\n    private void setField(Object obj, String fieldName, Object value) throws Exception {\n        Class<?> clazz = obj.getClass();\n        while (clazz != null) {\n            try {\n                java.lang.reflect.Field field = clazz.getDeclaredField(fieldName);\n                field.setAccessible(true);\n                field.set(obj, value);\n                return;\n            } catch (NoSuchFieldException e) {\n                clazz = clazz.getSuperclass();\n            }\n        }\n        throw new NoSuchFieldException(fieldName);\n    }\n\n    // ==================== SEARCH TESTS ====================\n\n    @Test\n    @DisplayName(\"TC01: Search student profiles successfully\")\n    void testSearch_Success() {\n        // Arrange\n        StudentProfileSearchRequest searchRequest = createSearchRequest();\n        List<StudentProfileDTO> expectedList = List.of(testStudentProfileDTO);\n        when(studentRepository.search(searchRequest)).thenReturn(expectedList);\n\n        // Act\n        List<StudentProfileDTO> result = studentProfileService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(studentRepository, times(1)).search(searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC02: Search returns empty list\")\n    void testSearch_EmptyResult() {\n        // Arrange\n        StudentProfileSearchRequest searchRequest = createSearchRequest();\n        when(studentRepository.search(searchRequest)).thenReturn(new ArrayList<>());\n\n        // Act\n        List<StudentProfileDTO> result = studentProfileService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertTrue(result.isEmpty());\n        verify(studentRepository, times(1)).search(searchRequest);\n    }\n\n    // ==================== COUNT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC03: Count student profiles successfully\")\n    void testCount_Success() {\n        // Arrange\n        StudentProfileSearchRequest searchRequest = createSearchRequest();\n        when(studentRepository.count(searchRequest)).thenReturn(10L);\n\n        // Act\n        Long result = studentProfileService.count(searchRequest);\n\n        // Assert\n        assertEquals(10L, result);\n        verify(studentRepository, times(1)).count(searchRequest);\n    }\n\n    // ==================== FIND BY ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC04: Find student profile by ID successfully\")\n    void testFindById_Success() {\n        // Arrange\n        when(studentRepository.findById(1)).thenReturn(Optional.of(testStudentProfile));\n        when(studentProfileMapper.toDTO(testStudentProfile)).thenReturn(testStudentProfileDTO);\n\n        // Act\n        StudentProfileDTO result = studentProfileService.findById(1);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getUserId());\n        assertEquals(\"SE001\", result.getRollNumber());\n        assertEquals(Set.of(\"STUDENT\"), result.getRoles());\n        assertFalse(result.getHasActiveEmbedding());\n        assertFalse(result.getCanUseFaceRecognition());\n        verify(studentRepository, times(1)).findById(1);\n    }\n\n    @Test\n    @DisplayName(\"TC05: Find student profile by ID - not found\")\n    void testFindById_NotFound() {\n        // Arrange\n        when(studentRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> studentProfileService.findById(999)\n        );\n        assertEquals(ErrorCode.STUDENT_PROFILE_NOT_FOUND, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"999\"));\n    }\n\n    // ==================== CREATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC06: Create student profile successfully\")\n    void testCreate_Success() {\n        // Arrange\n        when(studentRepository.existsByRollNumber(createRequest.getRollNumber())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(false);\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(false);\n        when(majorRepository.findById(createRequest.getMajorId())).thenReturn(Optional.of(testMajor));\n        when(roleRepository.findByName(\"STUDENT\")).thenReturn(Optional.of(testRole));\n        when(passwordEncoder.encode(anyString())).thenReturn(\"encodedPassword\");\n        when(userRepository.save(any(User.class))).thenReturn(testUser);\n        when(studentRepository.save(any(StudentProfile.class))).thenReturn(testStudentProfile);\n        when(studentProfileMapper.toDTO(testStudentProfile)).thenReturn(testStudentProfileDTO);\n        doNothing().when(emailService).sendPassword(anyString(), anyString());\n\n        // Act\n        StudentProfileDTO result = studentProfileService.create(createRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(Set.of(\"STUDENT\"), result.getRoles());\n        assertFalse(result.getHasActiveEmbedding());\n        assertFalse(result.getCanUseFaceRecognition());\n        verify(emailService, times(1)).sendPassword(eq(createRequest.getEmail()), anyString());\n        verify(userRepository, times(1)).save(any(User.class));\n        verify(studentRepository, times(1)).save(any(StudentProfile.class));\n    }\n\n    @Test\n    @DisplayName(\"TC07: Create student profile - roll number already exists\")\n    void testCreate_RollNumberExists() {\n        // Arrange\n        when(studentRepository.existsByRollNumber(createRequest.getRollNumber())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> studentProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.ROLL_NUMBER_EXISTS, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(createRequest.getRollNumber()));\n    }\n\n    @Test\n    @DisplayName(\"TC08: Create student profile - email already exists\")\n    void testCreate_EmailExists() {\n        // Arrange\n        when(studentRepository.existsByRollNumber(createRequest.getRollNumber())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> studentProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.EMAIL_EXISTS, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(createRequest.getEmail()));\n    }\n\n    @Test\n    @DisplayName(\"TC09: Create student profile - username already exists\")\n    void testCreate_UsernameExists() {\n        // Arrange\n        when(studentRepository.existsByRollNumber(createRequest.getRollNumber())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(false);\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> studentProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.USERNAME_EXISTS, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(createRequest.getUsername()));\n    }\n\n    @Test\n    @DisplayName(\"TC10: Create student profile - major not found\")\n    void testCreate_MajorNotFound() {\n        // Arrange\n        when(studentRepository.existsByRollNumber(createRequest.getRollNumber())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(false);\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(false);\n        when(majorRepository.findById(createRequest.getMajorId())).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> studentProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.MAJOR_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC11: Create student profile - student role not found\")\n    void testCreate_RoleNotFound() {\n        // Arrange\n        when(studentRepository.existsByRollNumber(createRequest.getRollNumber())).thenReturn(false);\n        when(userRepository.existsByEmail(createRequest.getEmail())).thenReturn(false);\n        when(userRepository.existsByUsername(createRequest.getUsername())).thenReturn(false);\n        when(majorRepository.findById(createRequest.getMajorId())).thenReturn(Optional.of(testMajor));\n        when(roleRepository.findByName(\"STUDENT\")).thenReturn(Optional.empty());\n        when(passwordEncoder.encode(anyString())).thenReturn(\"encodedPassword\");\n        when(userRepository.save(any(User.class))).thenReturn(testUser);\n        doNothing().when(emailService).sendPassword(anyString(), anyString());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> studentProfileService.create(createRequest)\n        );\n        assertEquals(ErrorCode.ROLE_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== UPDATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC12: Update student profile successfully\")\n    void testUpdate_Success() {\n        // Arrange\n        when(studentRepository.findById(1)).thenReturn(Optional.of(testStudentProfile));\n        when(userRepository.existsByEmail(updateRequest.getEmail())).thenReturn(false);\n        when(studentRepository.existsByRollNumber(updateRequest.getRollNumber())).thenReturn(false);\n        when(studentRepository.save(testStudentProfile)).thenReturn(testStudentProfile);\n        when(studentProfileMapper.toDTO(testStudentProfile)).thenReturn(testStudentProfileDTO);\n\n        // Act\n        StudentProfileDTO result = studentProfileService.update(1, updateRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(Set.of(\"STUDENT\"), result.getRoles());\n        assertFalse(result.getHasActiveEmbedding());\n        assertFalse(result.getCanUseFaceRecognition());\n        verify(studentRepository, times(1)).save(testStudentProfile);\n    }\n\n    @Test\n    @DisplayName(\"TC13: Update student profile - not found\")\n    void testUpdate_NotFound() {\n        // Arrange\n        when(studentRepository.findById(999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> studentProfileService.update(999, updateRequest)\n        );\n        assertEquals(ErrorCode.STUDENT_PROFILE_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC14: Update student profile - email already exists\")\n    void testUpdate_EmailExists() {\n        // Arrange\n        StudentProfileUpdateRequest emailUpdateRequest = createStudentProfileUpdateRequest(\"student001\", \"newemail@example.com\", \"Updated Student\", \"SE001\", (short) 1, true);\n        when(studentRepository.findById(1)).thenReturn(Optional.of(testStudentProfile));\n        when(userRepository.existsByEmail(\"newemail@example.com\")).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> studentProfileService.update(1, emailUpdateRequest)\n        );\n        assertEquals(ErrorCode.EMAIL_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC15: Update student profile - roll number already exists\")\n    void testUpdate_RollNumberExists() {\n        // Arrange\n        StudentProfileUpdateRequest rollUpdateRequest = createStudentProfileUpdateRequest(\"student001\", \"student001@example.com\", \"Updated Student\", \"SE999\", (short) 1, true);\n        when(studentRepository.findById(1)).thenReturn(Optional.of(testStudentProfile));\n        when(studentRepository.existsByRollNumber(\"SE999\")).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> studentProfileService.update(1, rollUpdateRequest)\n        );\n        assertEquals(ErrorCode.ROLL_NUMBER_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC16: Update student profile - username cannot be changed\")\n    void testUpdate_UsernameCannotBeChanged() {\n        // Arrange\n        StudentProfileUpdateRequest usernameUpdateRequest = createStudentProfileUpdateRequest(\"newusername\", \"student001@example.com\", \"Updated Student\", \"SE001\", (short) 1, true);\n        when(studentRepository.findById(1)).thenReturn(Optional.of(testStudentProfile));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> studentProfileService.update(1, usernameUpdateRequest)\n        );\n        assertEquals(ErrorCode.FORBIDDEN, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"Username cannot be changed\"));\n    }\n\n    @Test\n    @DisplayName(\"TC17: Update student profile - major not found\")\n    void testUpdate_MajorNotFound() {\n        // Arrange\n        StudentProfileUpdateRequest majorUpdateRequest = createStudentProfileUpdateRequest(\"student001\", \"student001@example.com\", \"Updated Student\", \"SE001\", (short) 999, true);\n        when(studentRepository.findById(1)).thenReturn(Optional.of(testStudentProfile));\n        when(majorRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> studentProfileService.update(1, majorUpdateRequest)\n        );\n        assertEquals(ErrorCode.MAJOR_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC18: Update student profile - change major successfully\")\n    void testUpdate_ChangeMajorSuccess() {\n        // Arrange\n        Major newMajor = new Major();\n        newMajor.setId((short) 2);\n        newMajor.setCode(\"AI\");\n        newMajor.setName(\"Artificial Intelligence\");\n        newMajor.setActive(true);\n\n        StudentProfileUpdateRequest majorChangeRequest = createStudentProfileUpdateRequest(\"student001\", \"student001@example.com\", \"Updated Student\", \"SE001\", (short) 2, true);\n        when(studentRepository.findById(1)).thenReturn(Optional.of(testStudentProfile));\n        when(majorRepository.findById((short) 2)).thenReturn(Optional.of(newMajor));\n        when(studentRepository.save(testStudentProfile)).thenReturn(testStudentProfile);\n        when(studentProfileMapper.toDTO(testStudentProfile)).thenReturn(testStudentProfileDTO);\n\n        // Act\n        StudentProfileDTO result = studentProfileService.update(1, majorChangeRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(studentRepository, times(1)).save(testStudentProfile);\n    }\n\n    // ==================== DELETE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC19: Delete student profile successfully\")\n    void testDelete_Success() {\n        // Arrange\n        when(studentRepository.existsById(1)).thenReturn(true);\n        doNothing().when(studentRepository).deleteById(1);\n\n        // Act\n        studentProfileService.delete(1);\n\n        // Assert\n        verify(studentRepository, times(1)).deleteById(1);\n    }\n\n    @Test\n    @DisplayName(\"TC20: Delete student profile - not found\")\n    void testDelete_NotFound() {\n        // Arrange\n        when(studentRepository.existsById(999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> studentProfileService.delete(999)\n        );\n        assertEquals(ErrorCode.STUDENT_PROFILE_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC21: Delete student profile - has enrollment history\")\n    void testDelete_HasEnrollmentHistory() {\n        // Arrange\n        when(studentRepository.existsById(1)).thenReturn(true);\n        doThrow(new DataIntegrityViolationException(\"FK constraint\")).when(studentRepository).deleteById(1);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> studentProfileService.delete(1)\n        );\n        assertEquals(ErrorCode.FOREIGN_KEY_CONSTRAINT_VIOLATION, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"enrollment history or attendance records\"));\n    }\n\n    // ==================== SEARCH BY SEMESTER ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC22: Search students by semester ID successfully\")\n    void testSearchBySemesterId_Success() {\n        // Arrange\n        StudentSemesterSearchRequest searchRequest = new StudentSemesterSearchRequest();\n        List<StudentSemesterDTO> expectedList = new ArrayList<>();\n        when(studentRepository.searchBySemesterId((short) 1, searchRequest)).thenReturn(expectedList);\n        // semesterService.findById returns void in this context (validation only)\n        lenient().when(semesterService.findById((short) 1)).thenReturn(null);\n\n        // Act\n        List<StudentSemesterDTO> result = studentProfileService.searchBySemesterId((short) 1, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(studentRepository, times(1)).searchBySemesterId((short) 1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC23: Search students by semester ID with major filter\")\n    void testSearchBySemesterId_WithMajorFilter() {\n        // Arrange\n        StudentSemesterSearchRequest searchRequest = new StudentSemesterSearchRequest();\n        searchRequest.setMajorId((short) 1);\n        List<StudentSemesterDTO> expectedList = new ArrayList<>();\n        when(studentRepository.searchBySemesterId((short) 1, searchRequest)).thenReturn(expectedList);\n        lenient().when(semesterService.findById((short) 1)).thenReturn(null);\n        lenient().when(majorService.findById((short) 1)).thenReturn(null);\n\n        // Act\n        List<StudentSemesterDTO> result = studentProfileService.searchBySemesterId((short) 1, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n    }\n\n    // ==================== COUNT BY SEMESTER ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC24: Count students by semester ID successfully\")\n    void testCountBySemesterId_Success() {\n        // Arrange\n        StudentSemesterSearchRequest searchRequest = new StudentSemesterSearchRequest();\n        when(studentRepository.countBySemesterId((short) 1, searchRequest)).thenReturn(25L);\n\n        // Act\n        Long result = studentProfileService.countBySemesterId((short) 1, searchRequest);\n\n        // Assert\n        assertEquals(25L, result);\n        verify(studentRepository, times(1)).countBySemesterId((short) 1, searchRequest);\n    }\n\n    // ==================== IMPORT CSV TESTS ====================\n\n    @Test\n    @DisplayName(\"TC25: Import CSV - AddOnly mode success\")\n    void testImportFromCsv_AddOnly_Success() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<StudentProfileCsvRow> rows = new ArrayList<>();\n        StudentProfileCsvRow row = new StudentProfileCsvRow();\n        row.setRowNumber(2);\n        row.setFullName(\"New Student\");\n        row.setEmail(\"newstudent@example.com\");\n        row.setUsername(\"newstudent\");\n        row.setRollNumber(\"SE003\");\n        row.setMajorCode(\"SE\");\n        row.setPassword(\"hashedPassword\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseStudentProfileCsv(file)).thenReturn(rows);\n        when(studentRepository.findByRollNumber(\"SE003\")).thenReturn(null);\n        when(userRepository.existsByEmail(\"newstudent@example.com\")).thenReturn(false);\n        when(userRepository.existsByUsername(\"newstudent\")).thenReturn(false);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor);\n        when(roleRepository.findByName(\"STUDENT\")).thenReturn(Optional.of(testRole));\n        when(userRepository.save(any(User.class))).thenReturn(testUser);\n        when(studentRepository.save(any(StudentProfile.class))).thenReturn(testStudentProfile);\n\n        // Act\n        ImportResultDTO result = studentProfileService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC26: Import CSV - invalid mode\")\n    void testImportFromCsv_InvalidMode() {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> studentProfileService.importFromCsv(file, \"InvalidMode\")\n        );\n        assertEquals(ErrorCode.INVALID_IMPORT_MODE, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC27: Import CSV - file processing error\")\n    void testImportFromCsv_FileProcessingError() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        when(csvParserService.parseStudentProfileCsv(file)).thenThrow(new IOException(\"File error\"));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> studentProfileService.importFromCsv(file, \"AddOnly\")\n        );\n        assertEquals(ErrorCode.FILE_PROCESSING_ERROR, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC28: Import CSV - AddAndUpdate mode updates existing\")\n    void testImportFromCsv_AddAndUpdate_UpdatesExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<StudentProfileCsvRow> rows = new ArrayList<>();\n        StudentProfileCsvRow row = new StudentProfileCsvRow();\n        row.setRowNumber(2);\n        row.setFullName(\"Updated Student\");\n        row.setEmail(\"student001@example.com\");\n        row.setUsername(\"student001\");\n        row.setRollNumber(\"SE001\");\n        row.setMajorCode(\"SE\");\n        row.setPassword(\"newHashedPassword\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseStudentProfileCsv(file)).thenReturn(rows);\n        when(studentRepository.findByRollNumber(\"SE001\")).thenReturn(testStudentProfile);\n        when(userRepository.existsByEmail(\"student001@example.com\")).thenReturn(false);\n        when(userRepository.existsByUsername(\"student001\")).thenReturn(false);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor);\n        when(userRepository.save(any(User.class))).thenReturn(testUser);\n        when(studentRepository.save(any(StudentProfile.class))).thenReturn(testStudentProfile);\n\n        // Act\n        ImportResultDTO result = studentProfileService.importFromCsv(file, \"AddAndUpdate\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC29: Import CSV - AddOnly mode fails on existing roll number\")\n    void testImportFromCsv_AddOnly_FailsOnExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<StudentProfileCsvRow> rows = new ArrayList<>();\n        StudentProfileCsvRow row = new StudentProfileCsvRow();\n        row.setRowNumber(2);\n        row.setFullName(\"Test Student\");\n        row.setEmail(\"test@example.com\");\n        row.setUsername(\"test\");\n        row.setRollNumber(\"SE001\");\n        row.setMajorCode(\"SE\");\n        rows.add(row);\n\n        when(csvParserService.parseStudentProfileCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor); // Need to mock major lookup first\n        when(studentRepository.findByRollNumber(\"SE001\")).thenReturn(testStudentProfile);\n\n        // Act\n        ImportResultDTO result = studentProfileService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(1, result.getErrors().size());\n        assertEquals(ErrorCode.ROLL_NUMBER_EXISTS, result.getErrors().get(0).getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC30: Import CSV - major not found\")\n    void testImportFromCsv_MajorNotFound() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<StudentProfileCsvRow> rows = new ArrayList<>();\n        StudentProfileCsvRow row = new StudentProfileCsvRow();\n        row.setRowNumber(2);\n        row.setFullName(\"New Student\");\n        row.setEmail(\"newstudent@example.com\");\n        row.setUsername(\"newstudent\");\n        row.setRollNumber(\"SE003\");\n        row.setMajorCode(\"INVALID\");\n        rows.add(row);\n\n        when(csvParserService.parseStudentProfileCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"INVALID\")).thenReturn(null);\n\n        // Act\n        ImportResultDTO result = studentProfileService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(ErrorCode.MAJOR_NOT_FOUND, result.getErrors().get(0).getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC31: Import CSV - inactive major not allowed\")\n    void testImportFromCsv_InactiveMajorNotAllowed() throws IOException {\n        // Arrange\n        testMajor.setActive(false);\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<StudentProfileCsvRow> rows = new ArrayList<>();\n        StudentProfileCsvRow row = new StudentProfileCsvRow();\n        row.setRowNumber(2);\n        row.setFullName(\"New Student\");\n        row.setEmail(\"newstudent@example.com\");\n        row.setUsername(\"newstudent\");\n        row.setRollNumber(\"SE003\");\n        row.setMajorCode(\"SE\");\n        rows.add(row);\n\n        when(csvParserService.parseStudentProfileCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor);\n\n        // Act\n        ImportResultDTO result = studentProfileService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(ErrorCode.INACTIVE_REFERENCE_NOT_ALLOWED, result.getErrors().get(0).getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC32: Import CSV - email already exists for new student\")\n    void testImportFromCsv_EmailExistsForNew() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<StudentProfileCsvRow> rows = new ArrayList<>();\n        StudentProfileCsvRow row = new StudentProfileCsvRow();\n        row.setRowNumber(2);\n        row.setFullName(\"New Student\");\n        row.setEmail(\"existing@example.com\");\n        row.setUsername(\"newstudent\");\n        row.setRollNumber(\"SE003\");\n        row.setMajorCode(\"SE\");\n        rows.add(row);\n\n        when(csvParserService.parseStudentProfileCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor); // Need to mock major lookup first\n        when(studentRepository.findByRollNumber(\"SE003\")).thenReturn(null);\n        when(userRepository.existsByEmail(\"existing@example.com\")).thenReturn(true);\n\n        // Act\n        ImportResultDTO result = studentProfileService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(ErrorCode.EMAIL_EXISTS, result.getErrors().get(0).getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC33: Import CSV - username already exists for new student\")\n    void testImportFromCsv_UsernameExistsForNew() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<StudentProfileCsvRow> rows = new ArrayList<>();\n        StudentProfileCsvRow row = new StudentProfileCsvRow();\n        row.setRowNumber(2);\n        row.setFullName(\"New Student\");\n        row.setEmail(\"newstudent@example.com\");\n        row.setUsername(\"existinguser\");\n        row.setRollNumber(\"SE003\");\n        row.setMajorCode(\"SE\");\n        rows.add(row);\n\n        when(csvParserService.parseStudentProfileCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor); // Need to mock major lookup first\n        when(studentRepository.findByRollNumber(\"SE003\")).thenReturn(null);\n        when(userRepository.existsByEmail(\"newstudent@example.com\")).thenReturn(false);\n        when(userRepository.existsByUsername(\"existinguser\")).thenReturn(true);\n\n        // Act\n        ImportResultDTO result = studentProfileService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(ErrorCode.USERNAME_EXISTS, result.getErrors().get(0).getErrorCode());\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\SubjectServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/SubjectServiceTest.java",
      "filename": "SubjectServiceTest.java",
      "size_bytes": 33119,
      "lines": 847,
      "last_modified": "2025-12-03T09:20:12.372854",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.constant.ImportMode;\nimport com.fuacs.backend.dto.mapper.MajorMapper;\nimport com.fuacs.backend.dto.mapper.SubjectMapper;\nimport com.fuacs.backend.dto.request.SubjectCreateRequest;\nimport com.fuacs.backend.dto.request.SubjectCsvRow;\nimport com.fuacs.backend.dto.request.SubjectSearchRequest;\nimport com.fuacs.backend.dto.request.SubjectUpdateRequest;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.SubjectDTO;\nimport com.fuacs.backend.entity.Major;\nimport com.fuacs.backend.entity.Subject;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.MajorRepository;\nimport com.fuacs.backend.repository.SubjectRepository;\nimport org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\nimport org.springframework.dao.DataIntegrityViolationException;\nimport org.springframework.mock.web.MockMultipartFile;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.io.IOException;\nimport java.time.Instant;\nimport java.util.ArrayList;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Optional;\nimport java.util.Set;\n\nimport static org.junit.jupiter.api.Assertions.*;\nimport static org.mockito.ArgumentMatchers.*;\nimport static org.mockito.Mockito.*;\n\nimport org.mockito.junit.jupiter.MockitoSettings;\nimport org.mockito.quality.Strictness;\n\n@ExtendWith(MockitoExtension.class)\n@MockitoSettings(strictness = Strictness.LENIENT)\n@DisplayName(\"SubjectService Unit Tests\")\nclass SubjectServiceTest {\n\n    @Mock\n    private SubjectRepository subjectRepository;\n\n    @Mock\n    private SubjectMapper subjectMapper;\n\n    @Mock\n    private MajorRepository majorRepository;\n\n    @Mock\n    private MajorMapper majorMapper;\n\n    @Mock\n    private SemesterService semesterService;\n\n    @Mock\n    private CsvParserService csvParserService;\n\n    @InjectMocks\n    private SubjectService subjectService;\n\n    private Subject testSubject;\n    private SubjectDTO testSubjectDTO;\n    private SubjectCreateRequest createRequest;\n    private SubjectUpdateRequest updateRequest;\n    private Major testMajor;\n\n    @BeforeEach\n    void setUp() {\n        testMajor = new Major();\n        testMajor.setId((short) 1);\n        testMajor.setCode(\"SE\");\n        testMajor.setName(\"Software Engineering\");\n        testMajor.setActive(true);\n\n        testSubject = new Subject();\n        testSubject.setId((short) 1);\n        testSubject.setCode(\"PRJ301\");\n        testSubject.setName(\"Java Web Application Development\");\n        testSubject.setActive(true);\n        testSubject.setMajors(new HashSet<>(Set.of(testMajor)));\n        testSubject.setCreatedAt(Instant.now());\n\n        testSubjectDTO = new SubjectDTO();\n        testSubjectDTO.setId((short) 1);\n        testSubjectDTO.setCode(\"PRJ301\");\n        testSubjectDTO.setName(\"Java Web Application Development\");\n        testSubjectDTO.setActive(true);\n\n        createRequest = createSubjectCreateRequest(\"PRJ302\", \"Advanced Java\", List.of((short) 1));\n\n        updateRequest = createSubjectUpdateRequest(\"PRJ301\", \"Java Web Application Development Updated\", List.of((short) 1), true);\n    }\n\n    // Helper method to create SubjectCreateRequest using reflection\n    private SubjectCreateRequest createSubjectCreateRequest(String code, String name, List<Short> majorIds) {\n        try {\n            SubjectCreateRequest request = new SubjectCreateRequest();\n            setField(request, \"code\", code);\n            setField(request, \"name\", name);\n            setField(request, \"majorIds\", majorIds);\n            return request;\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    // Helper method to create SubjectUpdateRequest using reflection\n    private SubjectUpdateRequest createSubjectUpdateRequest(String code, String name, List<Short> majorIds, Boolean isActive) {\n        try {\n            SubjectUpdateRequest request = new SubjectUpdateRequest();\n            setField(request, \"code\", code);\n            setField(request, \"name\", name);\n            setField(request, \"majorIds\", majorIds);\n            setField(request, \"isActive\", isActive);\n            return request;\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    // Helper method to create SubjectSearchRequest\n    private SubjectSearchRequest createSearchRequest() {\n        return new SubjectSearchRequest(null, null, null, null, null, null, null);\n    }\n\n    // Helper method to set field using reflection\n    private void setField(Object obj, String fieldName, Object value) throws Exception {\n        Class<?> clazz = obj.getClass();\n        while (clazz != null) {\n            try {\n                java.lang.reflect.Field field = clazz.getDeclaredField(fieldName);\n                field.setAccessible(true);\n                field.set(obj, value);\n                return;\n            } catch (NoSuchFieldException e) {\n                clazz = clazz.getSuperclass();\n            }\n        }\n        throw new NoSuchFieldException(fieldName);\n    }\n\n    // ==================== SEARCH TESTS ====================\n\n    @Test\n    @DisplayName(\"TC01: Search subjects successfully\")\n    void testSearch_Success() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        List<SubjectDTO> expectedList = List.of(testSubjectDTO);\n        when(subjectRepository.search(searchRequest)).thenReturn(expectedList);\n\n        // Act\n        List<SubjectDTO> result = subjectService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(subjectRepository, times(1)).search(searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC02: Search returns empty list\")\n    void testSearch_EmptyResult() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(subjectRepository.search(searchRequest)).thenReturn(new ArrayList<>());\n\n        // Act\n        List<SubjectDTO> result = subjectService.search(searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertTrue(result.isEmpty());\n        verify(subjectRepository, times(1)).search(searchRequest);\n    }\n\n    // ==================== COUNT TESTS ====================\n\n    @Test\n    @DisplayName(\"TC03: Count subjects successfully\")\n    void testCount_Success() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(subjectRepository.count(searchRequest)).thenReturn(5L);\n\n        // Act\n        Long result = subjectService.count(searchRequest);\n\n        // Assert\n        assertEquals(5L, result);\n        verify(subjectRepository, times(1)).count(searchRequest);\n    }\n\n    // ==================== FIND BY ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC04: Find subject by ID successfully\")\n    void testFindById_Success() {\n        // Arrange\n        when(subjectRepository.findById((short) 1)).thenReturn(Optional.of(testSubject));\n        when(subjectMapper.toDTO(testSubject)).thenReturn(testSubjectDTO);\n        when(subjectRepository.countAllClassesBySubjectId((short) 1)).thenReturn(5L);\n        when(subjectRepository.countActiveClassesBySubjectId((short) 1)).thenReturn(3L);\n\n        // Act\n        SubjectDTO result = subjectService.findById((short) 1);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals((short) 1, result.getId());\n        assertEquals(\"PRJ301\", result.getCode());\n        verify(subjectRepository, times(1)).findById((short) 1);\n    }\n\n    @Test\n    @DisplayName(\"TC05: Find subject by ID - not found\")\n    void testFindById_NotFound() {\n        // Arrange\n        when(subjectRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> subjectService.findById((short) 999)\n        );\n        assertEquals(ErrorCode.SUBJECT_NOT_FOUND, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"999\"));\n    }\n\n    // ==================== CREATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC06: Create subject successfully\")\n    void testCreate_Success() {\n        // Arrange\n        when(subjectRepository.existsByCode(createRequest.getCode())).thenReturn(false);\n        when(majorRepository.findByIdIn(anySet())).thenReturn(List.of(testMajor));\n        when(subjectMapper.toEntity(createRequest)).thenReturn(testSubject);\n        when(subjectRepository.save(testSubject)).thenReturn(testSubject);\n        when(subjectMapper.toDTO(testSubject)).thenReturn(testSubjectDTO);\n\n        // Act\n        SubjectDTO result = subjectService.create(createRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(subjectRepository, times(1)).save(testSubject);\n    }\n\n    @Test\n    @DisplayName(\"TC07: Create subject - code already exists\")\n    void testCreate_CodeExists() {\n        // Arrange\n        when(subjectRepository.existsByCode(createRequest.getCode())).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> subjectService.create(createRequest)\n        );\n        assertEquals(ErrorCode.SUBJECT_CODE_EXISTS, exception.getErrorCode());\n    }\n\n\n\n    @Test\n    @DisplayName(\"TC09: Create subject - empty major IDs\")\n    void testCreate_EmptyMajorIds() {\n        // Arrange\n        SubjectCreateRequest emptyMajorRequest = createSubjectCreateRequest(\"PRJ302\", \"Advanced Java\", new ArrayList<>());\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> subjectService.create(emptyMajorRequest)\n        );\n        assertEquals(ErrorCode.SUBJECT_MAJOR_IDS_EMPTY, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC10: Create subject - major not found\")\n    void testCreate_MajorNotFound() {\n        // Arrange\n        when(subjectRepository.existsByCode(createRequest.getCode())).thenReturn(false);\n        when(majorRepository.findByIdIn(anySet())).thenReturn(new ArrayList<>());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> subjectService.create(createRequest)\n        );\n        assertEquals(ErrorCode.MAJOR_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC11: Create subject - inactive major not allowed\")\n    void testCreate_InactiveMajorNotAllowed() {\n        // Arrange\n        testMajor.setActive(false);\n        when(subjectRepository.existsByCode(createRequest.getCode())).thenReturn(false);\n        when(majorRepository.findByIdIn(anySet())).thenReturn(List.of(testMajor));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> subjectService.create(createRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_MAJOR_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    // ==================== UPDATE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC12: Update subject successfully\")\n    void testUpdate_Success() {\n        // Arrange\n        when(subjectRepository.findById((short) 1)).thenReturn(Optional.of(testSubject));\n        when(majorRepository.findByIdIn(anySet())).thenReturn(List.of(testMajor));\n        when(subjectRepository.save(testSubject)).thenReturn(testSubject);\n        when(subjectMapper.toDTO(testSubject)).thenReturn(testSubjectDTO);\n        when(subjectRepository.countAllClassesBySubjectId((short) 1)).thenReturn(5L);\n        when(subjectRepository.countActiveClassesBySubjectId((short) 1)).thenReturn(3L);\n\n        // Act\n        SubjectDTO result = subjectService.update((short) 1, updateRequest);\n\n        // Assert\n        assertNotNull(result);\n        verify(subjectMapper, times(1)).updateSubjectFromRequest(updateRequest, testSubject);\n        verify(subjectRepository, times(1)).save(testSubject);\n    }\n\n    @Test\n    @DisplayName(\"TC13: Update subject - not found\")\n    void testUpdate_NotFound() {\n        // Arrange\n        when(subjectRepository.findById((short) 999)).thenReturn(Optional.empty());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> subjectService.update((short) 999, updateRequest)\n        );\n        assertEquals(ErrorCode.SUBJECT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC14: Update subject - code already exists\")\n    void testUpdate_CodeExists() {\n        // Arrange\n        SubjectUpdateRequest codeUpdateRequest = createSubjectUpdateRequest(\"NEWCODE\", \"Java Web Application Development Updated\", List.of((short) 1), true);\n        when(subjectRepository.findById((short) 1)).thenReturn(Optional.of(testSubject));\n        when(subjectRepository.existsByCode(\"NEWCODE\")).thenReturn(true);\n\n        // Act & Assert\n        ResourceExistsException exception = assertThrows(\n            ResourceExistsException.class,\n            () -> subjectService.update((short) 1, codeUpdateRequest)\n        );\n        assertEquals(ErrorCode.SUBJECT_CODE_EXISTS, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC15: Update subject - empty major IDs\")\n    void testUpdate_EmptyMajorIds() {\n        // Arrange\n        SubjectUpdateRequest emptyMajorRequest = createSubjectUpdateRequest(\"PRJ301\", \"Java Web Application Development Updated\", new ArrayList<>(), true);\n        when(subjectRepository.findById((short) 1)).thenReturn(Optional.of(testSubject));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> subjectService.update((short) 1, emptyMajorRequest)\n        );\n        assertEquals(ErrorCode.SUBJECT_MAJOR_IDS_EMPTY, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC17: Update subject - major not found\")\n    void testUpdate_MajorNotFound() {\n        // Arrange\n        when(subjectRepository.findById((short) 1)).thenReturn(Optional.of(testSubject));\n        when(majorRepository.findByIdIn(anySet())).thenReturn(new ArrayList<>());\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> subjectService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.MAJOR_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC18: Update subject - inactive major not allowed\")\n    void testUpdate_InactiveMajorNotAllowed() {\n        // Arrange\n        testMajor.setActive(false);\n        when(subjectRepository.findById((short) 1)).thenReturn(Optional.of(testSubject));\n        when(majorRepository.findByIdIn(anySet())).thenReturn(List.of(testMajor));\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> subjectService.update((short) 1, updateRequest)\n        );\n        assertEquals(ErrorCode.INACTIVE_MAJOR_NOT_ALLOWED, exception.getErrorCode());\n    }\n\n    // ==================== DELETE TESTS ====================\n\n    @Test\n    @DisplayName(\"TC19: Delete subject successfully\")\n    void testDelete_Success() {\n        // Arrange\n        when(subjectRepository.existsById((short) 1)).thenReturn(true);\n        when(subjectRepository.countAllClassesBySubjectId((short) 1)).thenReturn(0L);\n        doNothing().when(subjectRepository).deleteById((short) 1);\n\n        // Act\n        subjectService.delete((short) 1);\n\n        // Assert\n        verify(subjectRepository, times(1)).deleteById((short) 1);\n    }\n\n    @Test\n    @DisplayName(\"TC20: Delete subject - not found\")\n    void testDelete_NotFound() {\n        // Arrange\n        when(subjectRepository.existsById((short) 999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> subjectService.delete((short) 999)\n        );\n        assertEquals(ErrorCode.SUBJECT_NOT_FOUND, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC21: Delete subject - has classes\")\n    void testDelete_HasClasses() {\n        // Arrange\n        when(subjectRepository.existsById((short) 1)).thenReturn(true);\n        when(subjectRepository.countAllClassesBySubjectId((short) 1)).thenReturn(5L);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> subjectService.delete((short) 1)\n        );\n        assertEquals(ErrorCode.SUBJECT_HAS_DEPENDENCIES, exception.getErrorCode());\n        assertTrue(exception.getMessage().contains(\"5\"));\n    }\n\n    @Test\n    @DisplayName(\"TC22: Delete subject - foreign key constraint violation\")\n    void testDelete_ForeignKeyConstraint() {\n        // Arrange\n        when(subjectRepository.existsById((short) 1)).thenReturn(true);\n        when(subjectRepository.countAllClassesBySubjectId((short) 1)).thenReturn(0L);\n        doThrow(new DataIntegrityViolationException(\"FK constraint\")).when(subjectRepository).deleteById((short) 1);\n\n        // Act & Assert\n        OperationNotAllowedException exception = assertThrows(\n            OperationNotAllowedException.class,\n            () -> subjectService.delete((short) 1)\n        );\n        assertEquals(ErrorCode.SUBJECT_HAS_DEPENDENCIES, exception.getErrorCode());\n    }\n\n    // ==================== SEARCH BY MAJOR ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC23: Search subjects by major ID successfully\")\n    void testSearchByMajorId_Success() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(majorRepository.existsById((short) 1)).thenReturn(true);\n        when(subjectRepository.searchByMajorId((short) 1, searchRequest)).thenReturn(List.of(testSubjectDTO));\n\n        // Act\n        List<SubjectDTO> result = subjectService.searchByMajorId((short) 1, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(subjectRepository, times(1)).searchByMajorId((short) 1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC24: Search subjects by major ID - major not found\")\n    void testSearchByMajorId_MajorNotFound() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(majorRepository.existsById((short) 999)).thenReturn(false);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> subjectService.searchByMajorId((short) 999, searchRequest)\n        );\n        assertEquals(ErrorCode.MAJOR_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== IMPORT CSV TESTS ====================\n\n    @Test\n    @DisplayName(\"TC25: Import CSV - AddOnly mode success\")\n    void testImportFromCsv_AddOnly_Success() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<SubjectCsvRow> rows = new ArrayList<>();\n        SubjectCsvRow row = new SubjectCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"PRJ302\");\n        row.setName(\"Advanced Java\");\n        row.setMajorCodes(\"SE\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseSubjectCsv(file)).thenReturn(rows);\n        when(subjectRepository.findByCode(\"PRJ302\")).thenReturn(null);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor);\n        when(subjectRepository.save(any(Subject.class))).thenReturn(testSubject);\n\n        // Act\n        ImportResultDTO result = subjectService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC26: Import CSV - invalid mode\")\n    void testImportFromCsv_InvalidMode() {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n\n        // Act & Assert - ImportMode.fromString throws IllegalArgumentException for invalid mode\n        IllegalArgumentException exception = assertThrows(\n            IllegalArgumentException.class,\n            () -> subjectService.importFromCsv(file, \"InvalidMode\")\n        );\n        assertTrue(exception.getMessage().contains(\"Invalid import mode\"));\n    }\n\n    @Test\n    @DisplayName(\"TC27: Import CSV - file processing error\")\n    void testImportFromCsv_FileProcessingError() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        when(csvParserService.parseSubjectCsv(file)).thenThrow(new IOException(\"File error\"));\n\n        // Act & Assert\n        BadRequestException exception = assertThrows(\n            BadRequestException.class,\n            () -> subjectService.importFromCsv(file, \"AddOnly\")\n        );\n        assertEquals(ErrorCode.FILE_PROCESSING_ERROR, exception.getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC28: Import CSV - AddAndUpdate mode updates existing\")\n    void testImportFromCsv_AddAndUpdate_UpdatesExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<SubjectCsvRow> rows = new ArrayList<>();\n        SubjectCsvRow row = new SubjectCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"PRJ301\");\n        row.setName(\"Java Web Application Development Updated\");\n        row.setMajorCodes(\"SE\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseSubjectCsv(file)).thenReturn(rows);\n        when(subjectRepository.findByCode(\"PRJ301\")).thenReturn(testSubject);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor);\n        when(subjectRepository.save(any(Subject.class))).thenReturn(testSubject);\n\n        // Act\n        ImportResultDTO result = subjectService.importFromCsv(file, \"AddAndUpdate\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.getSuccessCount());\n        assertEquals(0, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC29: Import CSV - AddOnly mode fails on existing code\")\n    void testImportFromCsv_AddOnly_FailsOnExisting() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<SubjectCsvRow> rows = new ArrayList<>();\n        SubjectCsvRow row = new SubjectCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"PRJ301\");\n        row.setName(\"Java Web Application Development\");\n        row.setMajorCodes(\"SE\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseSubjectCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor); // Need to mock major lookup first\n        when(subjectRepository.findByCode(\"PRJ301\")).thenReturn(testSubject);\n\n        // Act\n        ImportResultDTO result = subjectService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n        assertEquals(1, result.getErrors().size());\n        assertEquals(ErrorCode.SUBJECT_CODE_EXISTS, result.getErrors().get(0).getErrorCode());\n    }\n\n    @Test\n    @DisplayName(\"TC30: Import CSV - empty major codes\")\n    void testImportFromCsv_EmptyMajorCodes() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<SubjectCsvRow> rows = new ArrayList<>();\n        SubjectCsvRow row = new SubjectCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"PRJ302\");\n        row.setName(\"Advanced Java\");\n        row.setMajorCodes(\"\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseSubjectCsv(file)).thenReturn(rows);\n\n        // Act\n        ImportResultDTO result = subjectService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC31: Import CSV - major code not found\")\n    void testImportFromCsv_MajorCodeNotFound() throws IOException {\n        // Arrange\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<SubjectCsvRow> rows = new ArrayList<>();\n        SubjectCsvRow row = new SubjectCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"PRJ302\");\n        row.setName(\"Advanced Java\");\n        row.setMajorCodes(\"INVALID\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseSubjectCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"INVALID\")).thenReturn(null);\n\n        // Act\n        ImportResultDTO result = subjectService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n    }\n\n    @Test\n    @DisplayName(\"TC32: Import CSV - inactive major not allowed\")\n    void testImportFromCsv_InactiveMajorNotAllowed() throws IOException {\n        // Arrange\n        testMajor.setActive(false);\n        MultipartFile file = new MockMultipartFile(\"file\", \"test.csv\", \"text/csv\", \"test data\".getBytes());\n        List<SubjectCsvRow> rows = new ArrayList<>();\n        SubjectCsvRow row = new SubjectCsvRow();\n        row.setRowNumber(2);\n        row.setCode(\"PRJ302\");\n        row.setName(\"Advanced Java\");\n        row.setMajorCodes(\"SE\");\n        row.setIsActive(true);\n        rows.add(row);\n\n        when(csvParserService.parseSubjectCsv(file)).thenReturn(rows);\n        when(majorRepository.findByCode(\"SE\")).thenReturn(testMajor);\n\n        // Act\n        ImportResultDTO result = subjectService.importFromCsv(file, \"AddOnly\");\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(0, result.getSuccessCount());\n        assertEquals(1, result.getFailureCount());\n    }\n\n    // ==================== COUNT BY MAJOR ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC35: Count subjects by major ID successfully\")\n    void testCountByMajorId_Success() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(subjectRepository.countByMajorId((short) 1, searchRequest)).thenReturn(10L);\n\n        // Act\n        Long result = subjectService.countByMajorId((short) 1, searchRequest);\n\n        // Assert\n        assertEquals(10L, result);\n        verify(subjectRepository, times(1)).countByMajorId((short) 1, searchRequest);\n    }\n\n    // ==================== SEARCH BY SEMESTER ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC36: Search subjects by semester ID successfully\")\n    void testSearchBySemesterId_Success() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(semesterService.findById((short) 1)).thenReturn(null); // Just need to not throw\n        when(subjectRepository.searchBySemesterId((short) 1, searchRequest)).thenReturn(List.of(testSubjectDTO));\n\n        // Act\n        List<SubjectDTO> result = subjectService.searchBySemesterId((short) 1, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(semesterService, times(1)).findById((short) 1);\n        verify(subjectRepository, times(1)).searchBySemesterId((short) 1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC37: Search subjects by semester ID - semester not found\")\n    void testSearchBySemesterId_SemesterNotFound() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        doThrow(new ResourceNotFoundException(\"Semester not found\", ErrorCode.SEMESTER_NOT_FOUND))\n            .when(semesterService).findById((short) 999);\n\n        // Act & Assert\n        ResourceNotFoundException exception = assertThrows(\n            ResourceNotFoundException.class,\n            () -> subjectService.searchBySemesterId((short) 999, searchRequest)\n        );\n        assertEquals(ErrorCode.SEMESTER_NOT_FOUND, exception.getErrorCode());\n    }\n\n    // ==================== COUNT BY SEMESTER ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC38: Count subjects by semester ID successfully\")\n    void testCountBySemesterId_Success() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(subjectRepository.countBySemesterId((short) 1, searchRequest)).thenReturn(8L);\n\n        // Act\n        Long result = subjectService.countBySemesterId((short) 1, searchRequest);\n\n        // Assert\n        assertEquals(8L, result);\n        verify(subjectRepository, times(1)).countBySemesterId((short) 1, searchRequest);\n    }\n\n    // ==================== SEARCH BY STAFF ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC39: Search subjects by staff ID successfully\")\n    void testSearchByStaffId_Success() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(subjectRepository.searchByStaffId(1, searchRequest)).thenReturn(List.of(testSubjectDTO));\n\n        // Act\n        List<SubjectDTO> result = subjectService.searchByStaffId(1, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertEquals(1, result.size());\n        verify(subjectRepository, times(1)).searchByStaffId(1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC40: Search subjects by staff ID - empty result\")\n    void testSearchByStaffId_EmptyResult() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(subjectRepository.searchByStaffId(999, searchRequest)).thenReturn(new ArrayList<>());\n\n        // Act\n        List<SubjectDTO> result = subjectService.searchByStaffId(999, searchRequest);\n\n        // Assert\n        assertNotNull(result);\n        assertTrue(result.isEmpty());\n        verify(subjectRepository, times(1)).searchByStaffId(999, searchRequest);\n    }\n\n    // ==================== COUNT BY STAFF ID TESTS ====================\n\n    @Test\n    @DisplayName(\"TC41: Count subjects by staff ID successfully\")\n    void testCountByStaffId_Success() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(subjectRepository.countByStaffId(1, searchRequest)).thenReturn(12L);\n\n        // Act\n        Long result = subjectService.countByStaffId(1, searchRequest);\n\n        // Assert\n        assertEquals(12L, result);\n        verify(subjectRepository, times(1)).countByStaffId(1, searchRequest);\n    }\n\n    @Test\n    @DisplayName(\"TC42: Count subjects by staff ID - zero result\")\n    void testCountByStaffId_ZeroResult() {\n        // Arrange\n        SubjectSearchRequest searchRequest = createSearchRequest();\n        when(subjectRepository.countByStaffId(999, searchRequest)).thenReturn(0L);\n\n        // Act\n        Long result = subjectService.countByStaffId(999, searchRequest);\n\n        // Assert\n        assertEquals(0L, result);\n        verify(subjectRepository, times(1)).countByStaffId(999, searchRequest);\n    }\n}\n"
    }
  ]
}