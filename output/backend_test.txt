{
  "metadata": {
    "codebase": "backend",
    "category": "test",
    "generated_at": "2025-11-19T20:29:52.222316",
    "total_files": 11,
    "total_lines": 5233,
    "total_bytes": 219315
  },
  "files": [
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\BackendApplicationTests.java",
      "relative_path": "src/test/java/com/fuacs/backend/BackendApplicationTests.java",
      "filename": "BackendApplicationTests.java",
      "size_bytes": 1032,
      "lines": 28,
      "last_modified": "2025-10-05T20:41:39.868198",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend;\n\nimport org.junit.jupiter.api.Test;\nimport org.springframework.boot.test.context.SpringBootTest;\nimport org.springframework.test.context.DynamicPropertyRegistry;\nimport org.springframework.test.context.DynamicPropertySource;\nimport org.testcontainers.containers.PostgreSQLContainer;\nimport org.testcontainers.junit.jupiter.Container;\nimport org.testcontainers.junit.jupiter.Testcontainers;\n\n@SpringBootTest\n@Testcontainers\nclass BackendApplicationTests {\n\n    @Container\n    static PostgreSQLContainer<?> postgreSQLContainer = new PostgreSQLContainer<>(\"postgres:15-alpine\");\n\n    @DynamicPropertySource\n    static void configureProperties(DynamicPropertyRegistry registry) {\n        registry.add(\"spring.datasource.url\", postgreSQLContainer::getJdbcUrl);\n        registry.add(\"spring.datasource.username\", postgreSQLContainer::getUsername);\n        registry.add(\"spring.datasource.password\", postgreSQLContainer::getPassword);\n    }\n\n    @Test\n    void contextLoads() {\n    }\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\config\\SecurityTestConfig.java",
      "relative_path": "src/test/java/com/fuacs/backend/config/SecurityTestConfig.java",
      "filename": "SecurityTestConfig.java",
      "size_bytes": 1331,
      "lines": 33,
      "last_modified": "2025-10-29T20:56:54.626198",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport org.springframework.boot.test.context.TestConfiguration;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.provisioning.InMemoryUserDetailsManager;\nimport org.springframework.security.web.SecurityFilterChain;\n\n@TestConfiguration\n@EnableWebSecurity\n@EnableMethodSecurity(prePostEnabled = false)\npublic class SecurityTestConfig {\n\n    @Bean\n    public SecurityFilterChain testSecurityFilterChain(HttpSecurity http) throws Exception {\n        http\n                .csrf(AbstractHttpConfigurer::disable)\n                .authorizeHttpRequests(auth -> auth\n                        .anyRequest().permitAll()\n                );\n        return http.build();\n    }\n\n    @Bean\n    public UserDetailsService testUserDetailsService() {\n        return new InMemoryUserDetailsManager();\n    }\n}\n\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\config\\TestConfig.java",
      "relative_path": "src/test/java/com/fuacs/backend/config/TestConfig.java",
      "filename": "TestConfig.java",
      "size_bytes": 1110,
      "lines": 32,
      "last_modified": "2025-10-29T20:56:54.627197",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.databind.SerializationFeature;\nimport com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\nimport org.springframework.boot.test.context.SpringBootTest;\nimport org.springframework.boot.test.context.TestConfiguration;\nimport org.springframework.boot.test.web.client.TestRestTemplate;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Primary;\nimport org.springframework.test.context.TestPropertySource;\n\n@TestConfiguration\n@SpringBootTest\n@TestPropertySource(locations = \"classpath:application-test.properties\")\npublic class TestConfig {\n\n    @Bean\n    @Primary\n    public ObjectMapper objectMapper() {\n        ObjectMapper mapper = new ObjectMapper();\n        mapper.registerModule(new JavaTimeModule());\n        mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);\n        return mapper;\n    }\n\n    @Bean\n    public TestRestTemplate testRestTemplate() {\n        return new TestRestTemplate();\n    }\n}\n\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\config\\TestContainerConfig.java",
      "relative_path": "src/test/java/com/fuacs/backend/config/TestContainerConfig.java",
      "filename": "TestContainerConfig.java",
      "size_bytes": 790,
      "lines": 25,
      "last_modified": "2025-10-29T20:56:54.627197",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.config;\n\nimport org.springframework.boot.test.context.TestConfiguration;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Primary;\nimport org.springframework.jdbc.datasource.embedded.EmbeddedDatabaseBuilder;\nimport org.springframework.jdbc.datasource.embedded.EmbeddedDatabaseType;\n\nimport javax.sql.DataSource;\n\n@TestConfiguration\npublic class TestContainerConfig {\n\n    @Bean\n    @Primary\n    public DataSource testDataSource() {\n        // Configuration for test database\n        return new EmbeddedDatabaseBuilder()\n                .setType(EmbeddedDatabaseType.H2)\n                .addScript(\"schema.sql\")\n                .addScript(\"test-data.sql\")\n                .build();\n    }\n}\n\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\controller\\MajorControllerTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/controller/MajorControllerTest.java",
      "filename": "MajorControllerTest.java",
      "size_bytes": 27747,
      "lines": 711,
      "last_modified": "2025-10-29T20:56:54.627197",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fuacs.backend.config.CustomHandlerMethodConfig;\nimport com.fuacs.backend.config.CustomHttpStatusSetter;\nimport com.fuacs.backend.config.SecurityTestConfig;\nimport com.fuacs.backend.config.TestConfig;\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.MajorCreateRequest;\nimport com.fuacs.backend.dto.request.MajorSearchRequest;\nimport com.fuacs.backend.dto.request.MajorUpdateRequest;\nimport com.fuacs.backend.dto.request.SubjectSearchRequest;\nimport com.fuacs.backend.dto.response.MajorDTO;\nimport com.fuacs.backend.dto.response.SubjectDTO;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.service.MajorService;\nimport com.fuacs.backend.service.SubjectService;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\nimport org.springframework.context.annotation.Import;\nimport org.springframework.http.MediaType;\nimport org.springframework.test.context.bean.override.mockito.MockitoBean;\nimport org.springframework.test.web.servlet.MockMvc;\n\nimport java.time.Instant;\nimport java.util.List;\n\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.eq;\nimport static org.mockito.Mockito.doNothing;\nimport static org.mockito.Mockito.doThrow;\nimport static org.mockito.Mockito.never;\nimport static org.mockito.Mockito.verify;\nimport static org.mockito.Mockito.when;\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;\nimport static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n\n@WebMvcTest(MajorController.class)\n@Import({TestConfig.class, SecurityTestConfig.class, CustomHandlerMethodConfig.class, CustomHttpStatusSetter.class})\npublic class MajorControllerTest {\n    @Autowired\n    private MockMvc mockMvc;\n\n    @Autowired\n    private ObjectMapper objectMapper;\n\n    @MockitoBean\n    private MajorService majorService;\n\n    @MockitoBean\n    private SubjectService subjectService;\n\n    private String asJsonString(Object obj) {\n        try {\n            return objectMapper.writeValueAsString(obj);\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_01: Search successfully with valid parameters\")\n    void search_Success() throws Exception {\n        // Given\n        MajorSearchRequest request = new MajorSearchRequest(0, 10, \"asc\", \"name\", true, \"Computer\");\n        List<MajorDTO> majors = List.of(new MajorDTO(\n                (short) 1, \"Computer Science\", \"CS\", true, Instant.now(), Instant.now(), 5L));\n        Long totalCount = 1L;\n\n        when(majorService.search(any(MajorSearchRequest.class))).thenReturn(majors);\n        when(majorService.count(any(MajorSearchRequest.class))).thenReturn(totalCount);\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/majors\")\n                        .param(\"page\", \"1\")\n                        .param(\"pageSize\", \"10\")\n                        .param(\"sort\", \"asc\")\n                        .param(\"sortBy\", \"name\")\n                        .param(\"isActive\", \"true\")\n                        .param(\"search\", \"Computer\"))\n                .andExpect(status().isOk());\n\n        verify(majorService).search(any(MajorSearchRequest.class));\n        verify(majorService).count(any(MajorSearchRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_02: Search with empty result\")\n    void search_EmptyResult() throws Exception {\n        // Given\n        List<MajorDTO> majors = List.of();\n        Long totalCount = 0L;\n\n        when(majorService.search(any(MajorSearchRequest.class))).thenReturn(majors);\n        when(majorService.count(any(MajorSearchRequest.class))).thenReturn(totalCount);\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/majors\")\n                        .param(\"page\", \"1\")\n                        .param(\"pageSize\", \"10\")\n                        .param(\"sort\", \"asc\")\n                        .param(\"sortBy\", \"name\")\n                        .param(\"isActive\", \"true\")\n                        .param(\"search\", \"NonExistent\"))\n                .andExpect(status().isOk());\n\n        verify(majorService).search(any(MajorSearchRequest.class));\n        verify(majorService).count(any(MajorSearchRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_03: Search with null parameters\")\n    void search_NullParameters() throws Exception {\n        // Given\n        List<MajorDTO> majors = List.of(new MajorDTO(\n                (short) 1, \"Computer Science\", \"CS\", true, Instant.now(), Instant.now(), 5L));\n        Long totalCount = 1L;\n\n        when(majorService.search(any(MajorSearchRequest.class))).thenReturn(majors);\n        when(majorService.count(any(MajorSearchRequest.class))).thenReturn(totalCount);\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/majors\"))\n                .andExpect(status().isOk());\n\n        verify(majorService).search(any(MajorSearchRequest.class));\n        verify(majorService).count(any(MajorSearchRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_04: Find by ID successfully\")\n    void findById_Success() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorDTO majorDTO = new MajorDTO(\n                (short) 1,\n                \"Computer Science\",\n                \"CS\",\n                true,\n                Instant.now(),\n                Instant.now(),\n                5L\n        );\n\n        when(majorService.findById(majorId)).thenReturn(majorDTO);\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/majors/{id}\", majorId))\n                .andExpect(status().isOk());\n\n        verify(majorService).findById(majorId);\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_05: Return 404 when ID not found\")\n    void findById_NotFound() throws Exception {\n        // Given\n        Short majorId = 999;\n        when(majorService.findById(majorId))\n                .thenThrow(new ResourceNotFoundException(\"Major not found: \" + majorId,\n                        ErrorCode.MAJOR_NOT_FOUND));\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/majors/{id}\", majorId))\n                .andExpect(status().isNotFound());\n\n        verify(majorService).findById(majorId);\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_06: Create major successfully\")\n    void create_Success() throws Exception {\n        // Given\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n\n        MajorDTO createdDTO = new MajorDTO(\n                (short) 1,\n                \"Computer Science\",\n                \"CS\",\n                true,\n                Instant.now(),\n                Instant.now(),\n                5L\n        );\n\n        when(majorService.create(any(MajorCreateRequest.class))).thenReturn(createdDTO);\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/majors\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isCreated());\n\n        verify(majorService).create(any(MajorCreateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_07: Return 400 when name is blank\")\n    void create_ValidationFailed_BlankName() throws Exception {\n        // Given\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(\"\");\n        request.setCode(\"CS\");\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/majors\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).create(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_08: Return 400 when code is blank\")\n    void create_ValidationFailed_BlankCode() throws Exception {\n        // Given\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"\");\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/majors\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).create(any());\n    }\n\n//    @Test\n//    @DisplayName(\"TC_MC_09: Return 400 when name exceeds max length\")\n//    void create_ValidationFailed_NameTooLong() throws Exception {\n//        // Given\n//        MajorCreateRequest request = new MajorCreateRequest();\n//        request.setName(\"A Very Long Major Name That Exceeds The Maximum Allowed Length Of One Hundred Fifty Characters And Should Fail Validation\");\n//        request.setCode(\"CS\");\n//\n//        // When & Then\n//        mockMvc.perform(post(\"/api/v1/majors\")\n//                        .contentType(MediaType.APPLICATION_JSON)\n//                        .content(asJsonString(request)))\n//                .andExpect(status().isBadRequest());\n//\n//        verify(majorService, never()).create(any());\n//    }\n\n    @Test\n    @DisplayName(\"TC_MC_10: Return 400 when code exceeds max length\")\n    void create_ValidationFailed_CodeTooLong() throws Exception {\n        // Given\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"VERYLONGCODEEEEEEEEEEEEEE\");\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/majors\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).create(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_11: Return 400 when name contains invalid characters\")\n    void create_ValidationFailed_InvalidNameCharacters() throws Exception {\n        // Given\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(\"Computer@Science\");\n        request.setCode(\"CS\");\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/majors\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).create(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_12: Return 400 when code contains invalid characters\")\n    void create_ValidationFailed_InvalidCodeCharacters() throws Exception {\n        // Given\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"C S\");\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/majors\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).create(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_13: Return 400 when isActive is null\")\n    void create_ValidationFailed_NullIsActive() throws Exception {\n        // Given\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n        request.setActive(null);\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/majors\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).create(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_14: Return 409 when code exists\")\n    void create_CodeExists() throws Exception {\n        // Given\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n\n        when(majorService.create(any(MajorCreateRequest.class)))\n                .thenThrow(new ResourceExistsException(\"Major code already exists: \" + request.getCode(),\n                        ErrorCode.MAJOR_CODE_EXISTS));\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/majors\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService).create(any(MajorCreateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_15: Return 409 when name exists\")\n    void create_NameExists() throws Exception {\n        // Given\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n\n        when(majorService.create(any(MajorCreateRequest.class)))\n                .thenThrow(new ResourceExistsException(\"Major name already exists: \" + request.getName(),\n                        ErrorCode.MAJOR_NAME_EXISTS));\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/majors\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService).create(any(MajorCreateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_16: Update major successfully\")\n    void update_Success() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Updated Computer Science\");\n        request.setCode(\"UCS\");\n        request.setActive(true);\n\n        MajorDTO updatedDTO = new MajorDTO(\n                (short) 1,\n                \"Updated Computer Science\",\n                \"UCS\",\n                true,\n                Instant.now(),\n                Instant.now(),\n                5L\n        );\n\n        when(majorService.update(eq(majorId), any(MajorUpdateRequest.class)))\n                .thenReturn(updatedDTO);\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isOk());\n\n        verify(majorService).update(eq(majorId), any(MajorUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_17: Return 404 when updating non-existent major\")\n    void update_NotFound() throws Exception {\n        // Given\n        Short majorId = 999;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Updated Computer Science\");\n        request.setCode(\"UCS\");\n        request.setActive(true);\n\n        when(majorService.update(eq(majorId), any(MajorUpdateRequest.class)))\n                .thenThrow(new ResourceNotFoundException(\"Major not found: \" + majorId,\n                        ErrorCode.MAJOR_NOT_FOUND));\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isNotFound());\n\n        verify(majorService).update(eq(majorId), any(MajorUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_18: Return 400 when name is blank\")\n    void update_ValidationFailed_BlankName() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"\");\n        request.setCode(\"CS\");\n        request.setActive(true);\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).update(any(), any());\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_19: Return 400 when code is blank\")\n    void update_ValidationFailed_BlankCode() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"\");\n        request.setActive(true);\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).update(any(), any());\n    }\n\n//    @Test\n//    @DisplayName(\"TC_MC_20: Return 400 when name exceeds max length\")\n//    void update_ValidationFailed_NameTooLong() throws Exception {\n//        // Given\n//        Short majorId = (short) 1;\n//        MajorUpdateRequest request = new MajorUpdateRequest();\n//        request.setName(\"A Very Long Major Name That Exceeds The Maximum Allowed Length Of One Hundred Fifty Characters And Should Fail Validation\");\n//        request.setCode(\"CS\");\n//        request.setActive(true);\n//\n//        // When & Then\n//        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n//                        .contentType(MediaType.APPLICATION_JSON)\n//                        .content(asJsonString(request)))\n//                .andExpect(status().isBadRequest());\n//\n//        verify(majorService, never()).update(any(), any());\n//    }\n\n    @Test\n    @DisplayName(\"TC_MC_21: Return 400 when code exceeds max length\")\n    void update_ValidationFailed_CodeTooLong() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"VERYLONGCODEEEEEEEEEEEE\");\n        request.setActive(true);\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).update(any(), any());\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_22: Return 400 when name contains invalid characters\")\n    void update_ValidationFailed_InvalidNameCharacters() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer@Science\");\n        request.setCode(\"CS\");\n        request.setActive(true);\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).update(any(), any());\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_23: Return 400 when code contains invalid characters\")\n    void update_ValidationFailed_InvalidCodeCharacters() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"C S\");\n        request.setActive(true);\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).update(any(), any());\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_24: Return 400 when isActive is null\")\n    void update_ValidationFailed_NullIsActive() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n        request.setActive(null);\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService, never()).update(any(), any());\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_25: Return 409 when code exists\")\n    void update_CodeExists() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n        request.setActive(true);\n\n        when(majorService.update(eq(majorId), any(MajorUpdateRequest.class)))\n                .thenThrow(new ResourceExistsException(\"Major code already exists: \" + request.getCode(),\n                        ErrorCode.MAJOR_CODE_EXISTS));\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService).update(eq(majorId), any(MajorUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_26: Return 409 when name exists\")\n    void update_NameExists() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n        request.setActive(true);\n\n        when(majorService.update(eq(majorId), any(MajorUpdateRequest.class)))\n                .thenThrow(new ResourceExistsException(\"Major name already exists: \" + request.getName(),\n                        ErrorCode.MAJOR_NAME_EXISTS));\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(majorService).update(eq(majorId), any(MajorUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_27: Return 403 when deactivating major with active dependencies\")\n    void update_DeactivateWithDependencies() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n        request.setActive(false);\n\n        when(majorService.update(eq(majorId), any(MajorUpdateRequest.class)))\n                .thenThrow(new OperationNotAllowedException(\"Cannot deactivate major. Found 5 active subjects and 10 enrolled students\",\n                        ErrorCode.MAJOR_HAS_ACTIVE_DEPENDENCIES));\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/majors/{id}\", majorId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isForbidden());\n\n        verify(majorService).update(eq(majorId), any(MajorUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_28: Delete major successfully\")\n    void delete_Success() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        doNothing().when(majorService).delete(majorId);\n\n        // When & Then\n        mockMvc.perform(delete(\"/api/v1/majors/{id}\", majorId))\n                .andExpect(status().isOk());\n\n        verify(majorService).delete(majorId);\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_29: Return 404 when deleting non-existent major\")\n    void delete_NotFound() throws Exception {\n        // Given\n        Short majorId = 999;\n        doThrow(new ResourceNotFoundException(\"Major not found: \" + majorId,\n                ErrorCode.MAJOR_NOT_FOUND))\n                .when(majorService).delete(majorId);\n\n        // When & Then\n        mockMvc.perform(delete(\"/api/v1/majors/{id}\", majorId))\n                .andExpect(status().isNotFound());\n\n        verify(majorService).delete(majorId);\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_30: Return 403 when deleting major with dependencies\")\n    void delete_WithDependencies() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        doThrow(new OperationNotAllowedException(\"Cannot delete major. Found 5 subjects and 10 students. Please reassign or delete them first\",\n                ErrorCode.MAJOR_HAS_DEPENDENCIES))\n                .when(majorService).delete(majorId);\n\n        // When & Then\n        mockMvc.perform(delete(\"/api/v1/majors/{id}\", majorId))\n                .andExpect(status().isForbidden());\n\n        verify(majorService).delete(majorId);\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_31: Get subjects by major ID successfully\")\n    void findAllByMajor_Success() throws Exception {\n        // Given\n        Short majorId = (short) 1;\n        List<SubjectDTO> subjects = List.of(new SubjectDTO());\n        Long totalCount = 1L;\n\n        when(subjectService.searchByMajorId(eq(majorId), any(SubjectSearchRequest.class)))\n                .thenReturn(subjects);\n        when(subjectService.countByMajorId(eq(majorId), any(SubjectSearchRequest.class)))\n                .thenReturn(totalCount);\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/majors/{id}/subjects\", majorId)\n                        .param(\"page\", \"1\")\n                        .param(\"pageSize\", \"10\"))\n                .andExpect(status().isOk());\n\n        verify(subjectService).searchByMajorId(eq(majorId), any(SubjectSearchRequest.class));\n        verify(subjectService).countByMajorId(eq(majorId), any(SubjectSearchRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_MC_32: Return 404 when major not found\")\n    void findAllByMajor_MajorNotFound() throws Exception {\n        // Given\n        Short majorId = 999;\n        when(subjectService.searchByMajorId(eq(majorId), any(SubjectSearchRequest.class)))\n                .thenThrow(new ResourceNotFoundException(\"Major not found: \" + majorId,\n                        ErrorCode.MAJOR_NOT_FOUND));\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/majors/{id}/subjects\", majorId)\n                        .param(\"page\", \"1\")\n                        .param(\"pageSize\", \"10\"))\n                .andExpect(status().isNotFound());\n\n        verify(subjectService).searchByMajorId(eq(majorId), any(SubjectSearchRequest.class));\n    }\n\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\controller\\SemesterControllerTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/controller/SemesterControllerTest.java",
      "filename": "SemesterControllerTest.java",
      "size_bytes": 24415,
      "lines": 587,
      "last_modified": "2025-10-29T20:56:54.628199",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fuacs.backend.config.CustomHandlerMethodConfig;\nimport com.fuacs.backend.config.CustomHttpStatusSetter;\nimport com.fuacs.backend.config.SecurityTestConfig;\nimport com.fuacs.backend.config.TestConfig;\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.ClassSearchRequest;\nimport com.fuacs.backend.dto.request.SemesterCreateRequest;\nimport com.fuacs.backend.dto.request.SemesterSearchRequest;\nimport com.fuacs.backend.dto.request.SemesterUpdateRequest;\nimport com.fuacs.backend.dto.request.StudentSemesterSearchRequest;\nimport com.fuacs.backend.dto.request.SubjectSearchRequest;\nimport com.fuacs.backend.dto.response.ClassDTO;\nimport com.fuacs.backend.dto.response.SemesterDTO;\nimport com.fuacs.backend.dto.response.StudentSemesterDTO;\nimport com.fuacs.backend.dto.response.SubjectDTO;\nimport com.fuacs.backend.exception.InvalidDateException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.service.ClassService;\nimport com.fuacs.backend.service.SemesterService;\nimport com.fuacs.backend.service.StudentProfileService;\nimport com.fuacs.backend.service.SubjectService;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\nimport org.springframework.context.annotation.Import;\nimport org.springframework.http.MediaType;\nimport org.springframework.test.context.bean.override.mockito.MockitoBean;\nimport org.springframework.test.web.servlet.MockMvc;\n\nimport java.time.Instant;\nimport java.time.LocalDate;\nimport java.util.List;\n\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.eq;\nimport static org.mockito.Mockito.doNothing;\nimport static org.mockito.Mockito.doThrow;\nimport static org.mockito.Mockito.never;\nimport static org.mockito.Mockito.verify;\nimport static org.mockito.Mockito.when;\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\nimport static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.put;\nimport static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n\n@WebMvcTest(SemesterController.class)\n@Import({TestConfig.class, SecurityTestConfig.class, CustomHandlerMethodConfig.class, CustomHttpStatusSetter.class})\nclass SemesterControllerTest {\n\n    @Autowired\n    private MockMvc mockMvc;\n\n    @Autowired\n    private ObjectMapper objectMapper;\n\n    @MockitoBean\n    private SemesterService semesterService;\n\n    @MockitoBean\n    private ClassService classService;\n\n    @MockitoBean\n    private SubjectService subjectService;\n\n    @MockitoBean\n    private StudentProfileService studentProfileService;\n\n    private String asJsonString(Object obj) {\n        try {\n            return objectMapper.writeValueAsString(obj);\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n    @Test\n    @DisplayName(\"TC_SC_01: Search successfully with valid parameters\")\n    void search_Success() throws Exception {\n        // Given\n        SemesterSearchRequest request = new SemesterSearchRequest(0, 10, \"asc\", \"name\", true, \"Fall\");\n        List<SemesterDTO> semesters = List.of(new SemesterDTO((short) 1, \"Fall 2024\", \"FA2024\", LocalDate.of(2024, 9, 1), LocalDate.of(2024, 12, 31), 5L, true, Instant.now(), Instant.now()));\n        Long totalCount = 1L;\n\n        when(semesterService.search(request)).thenReturn(semesters);\n        when(semesterService.count(request)).thenReturn(totalCount);\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/semesters\")\n                        .param(\"page\", \"1\")\n                        .param(\"pageSize\", \"10\")\n                        .param(\"sort\", \"asc\")\n                        .param(\"sortBy\", \"name\")\n                        .param(\"isActive\", \"true\")\n                        .param(\"search\", \"Fall\"))\n                .andExpect(status().isOk());\n\n        verify(semesterService).search(any(SemesterSearchRequest.class));\n        verify(semesterService).count(any(SemesterSearchRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_SC_02: Search with empty result\")\n    void search_EmptyResult() throws Exception {\n        // Given\n        List<SemesterDTO> semesters = List.of();\n        Long totalCount = 0L;\n\n        when(semesterService.search(any(SemesterSearchRequest.class))).thenReturn(semesters);\n        when(semesterService.count(any(SemesterSearchRequest.class))).thenReturn(totalCount);\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/semesters\")\n                        .param(\"page\", \"1\")\n                        .param(\"pageSize\", \"10\")\n                        .param(\"sort\", \"asc\")\n                        .param(\"sortBy\", \"name\")\n                        .param(\"isActive\", \"true\")\n                        .param(\"search\", \"NonExistent\"))\n                .andExpect(status().isOk());\n\n        verify(semesterService).search(any(SemesterSearchRequest.class));\n        verify(semesterService).count(any(SemesterSearchRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_FI_01: Find by ID successfully\")\n    void findById_Success() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        SemesterDTO semesterDTO = new SemesterDTO(\n                (short) 1,\n                \"Fall 2024\",\n                \"FA2024\",\n                LocalDate.of(2024, 9, 1),\n                LocalDate.of(2024, 12, 31),\n                5L,\n                true,\n                Instant.now(),\n                Instant.now()\n        );\n\n        when(semesterService.findById(semesterId)).thenReturn(semesterDTO);\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/semesters/{id}\", semesterId))\n                .andExpect(status().isOk());\n\n        verify(semesterService).findById(semesterId);\n    }\n\n    @Test\n    @DisplayName(\"TC_FI_02: Return 404 when ID not found\")\n    void findById_NotFound() throws Exception {\n        // Given\n        Short semesterId = 999;\n        when(semesterService.findById(semesterId))\n                .thenThrow(new ResourceNotFoundException(\"Semester not found: \" + semesterId,\n                        ErrorCode.SEMESTER_NOT_FOUND));\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/semesters/{id}\", semesterId))\n                .andExpect(status().isNotFound());\n\n        verify(semesterService).findById(semesterId);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_01: Create semester successfully\")\n    void create_Success() throws Exception {\n        // Given\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n\n        SemesterDTO createdDTO = new SemesterDTO(\n                (short) 1,\n                \"Fall 2024\",\n                \"FA2024\",\n                LocalDate.of(2024, 9, 1),\n                LocalDate.of(2024, 12, 31),\n                5L,\n                true,\n                Instant.now(),\n                Instant.now()\n        );\n\n        when(semesterService.create(any(SemesterCreateRequest.class))).thenReturn(createdDTO);\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/semesters\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isCreated());\n\n        verify(semesterService).create(any(SemesterCreateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_02: Return 400 when name is blank\")\n    void create_ValidationFailed_BlankName() throws Exception {\n        // Given\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n        request.setName(\"\");\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/semesters\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(semesterService, never()).create(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_03: Return 400 when start date >= end date\")\n    void create_InvalidDateRange() throws Exception {\n        // Given\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n        request.setStartDate(LocalDate.of(2024, 12, 31));\n        request.setEndDate(LocalDate.of(2024, 9, 1));\n\n        when(semesterService.create(any(SemesterCreateRequest.class)))\n                .thenThrow(new InvalidDateException(\"Start date must be before end date\",\n                        ErrorCode.SEMESTER_INVALID_DATE_RANGE));\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/semesters\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(semesterService).create(any(SemesterCreateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_04: Return 409 when code exists\")\n    void create_CodeExists() throws Exception {\n        // Given\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n\n        when(semesterService.create(any(SemesterCreateRequest.class)))\n                .thenThrow(new ResourceExistsException(\"Semester code exists: \" + request.getCode(),\n                        ErrorCode.SEMESTER_CODE_EXISTS));\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/semesters\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(semesterService).create(any(SemesterCreateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_05: Return 409 when name exists\")\n    void create_NameExists() throws Exception {\n        // Given\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n\n        when(semesterService.create(any(SemesterCreateRequest.class)))\n                .thenThrow(new ResourceExistsException(\"Semester name exists: \" + request.getName(),\n                        ErrorCode.SEMESTER_NAME_EXISTS));\n\n        // When & Then\n        mockMvc.perform(post(\"/api/v1/semesters\")\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(semesterService).create(any(SemesterCreateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_01: Update semester successfully\")\n    void update_Success() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        SemesterDTO updatedDTO = new SemesterDTO(\n                (short) 1,\n                \"Fall 2024\",\n                \"FA2024\",\n                LocalDate.of(2024, 9, 1),\n                LocalDate.of(2024, 12, 31),\n                5L,\n                true,\n                Instant.now(),\n                Instant.now()\n        );\n\n        when(semesterService.update(eq(semesterId), any(SemesterUpdateRequest.class)))\n                .thenReturn(updatedDTO);\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/semesters/{id}\", semesterId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isOk());\n\n        verify(semesterService).update(eq(semesterId), any(SemesterUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_02: Return 404 when updating non-existent semester\")\n    void update_NotFound() throws Exception {\n        // Given\n        Short semesterId = 999;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        when(semesterService.update(eq(semesterId), any(SemesterUpdateRequest.class)))\n                .thenThrow(new ResourceNotFoundException(\"Semester not found: \" + semesterId,\n                        ErrorCode.SEMESTER_NOT_FOUND));\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/semesters/{id}\", semesterId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isNotFound());\n\n        verify(semesterService).update(eq(semesterId), any(SemesterUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_03: Return 400 when start date >= end date\")\n    void update_InvalidDateRange() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n        request.setStartDate(LocalDate.of(2024, 12, 31));\n        request.setEndDate(LocalDate.of(2024, 9, 1));\n\n        when(semesterService.update(eq(semesterId), any(SemesterUpdateRequest.class)))\n                .thenThrow(new InvalidDateException(\"Start date must be before end date\",\n                        ErrorCode.SEMESTER_INVALID_DATE_RANGE));\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/semesters/{id}\", semesterId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(semesterService).update(eq(semesterId), any(SemesterUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_04: Return 409 when code exists\")\n    void update_CodeExists() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        when(semesterService.update(eq(semesterId), any(SemesterUpdateRequest.class)))\n                .thenThrow(new ResourceExistsException(\"Semester code exists: \" + request.getCode(),\n                        ErrorCode.SEMESTER_CODE_EXISTS));\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/semesters/{id}\", semesterId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(semesterService).update(eq(semesterId), any(SemesterUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_05: Return 409 when name exists\")\n    void update_NameExists() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        when(semesterService.update(eq(semesterId), any(SemesterUpdateRequest.class)))\n                .thenThrow(new ResourceExistsException(\"Semester name exists: \" + request.getName(),\n                        ErrorCode.SEMESTER_NAME_EXISTS));\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/semesters/{id}\", semesterId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isBadRequest());\n\n        verify(semesterService).update(eq(semesterId), any(SemesterUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_06: Return 403 when modifying ongoing semester\")\n    void update_OngoingSemester() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        when(semesterService.update(eq(semesterId), any(SemesterUpdateRequest.class)))\n                .thenThrow(new OperationNotAllowedException(\"Cannot modify dates or active status of an ongoing semester. Only name and code can be updated.\",\n                        ErrorCode.SEMESTER_ONGOING_CANNOT_BE_MODIFIED));\n\n        // When & Then\n        mockMvc.perform(put(\"/api/v1/semesters/{id}\", semesterId)\n                        .contentType(MediaType.APPLICATION_JSON)\n                        .content(asJsonString(request)))\n                .andExpect(status().isForbidden());\n\n        verify(semesterService).update(eq(semesterId), any(SemesterUpdateRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_01: Delete semester successfully\")\n    void delete_Success() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        doNothing().when(semesterService).delete(semesterId);\n\n        // When & Then\n        mockMvc.perform(delete(\"/api/v1/semesters/{id}\", semesterId))\n                .andExpect(status().isOk());\n\n        verify(semesterService).delete(semesterId);\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_02: Return 404 when deleting non-existent semester\")\n    void delete_NotFound() throws Exception {\n        // Given\n        Short semesterId = 999;\n        doThrow(new ResourceNotFoundException(\"Semester not found: \" + semesterId,\n                ErrorCode.SEMESTER_NOT_FOUND))\n                .when(semesterService).delete(semesterId);\n\n        // When & Then\n        mockMvc.perform(delete(\"/api/v1/semesters/{id}\", semesterId))\n                .andExpect(status().isNotFound());\n\n        verify(semesterService).delete(semesterId);\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_03: Return 409 when deleting semester with foreign key constraint\")\n    void delete_ForeignKeyConstraintViolation() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        doThrow(new OperationNotAllowedException(\"Delete all class associate with this semester first\",\n                ErrorCode.FOREIGN_KEY_CONSTRAINT_VIOLATION))\n                .when(semesterService).delete(semesterId);\n\n        // When & Then\n        mockMvc.perform(delete(\"/api/v1/semesters/{id}\", semesterId))\n                .andExpect(status().isForbidden());\n\n        verify(semesterService).delete(semesterId);\n    }\n\n    @Test\n    @DisplayName(\"TC_RE_01: Get classes by semester ID successfully\")\n    void searchClassBySemesterId_Success() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        List<ClassDTO> classes = List.of(new ClassDTO());\n        Long totalCount = 1L;\n\n        when(classService.searchClassBySemesterId(eq(semesterId), any(ClassSearchRequest.class)))\n                .thenReturn(classes);\n        when(classService.countBySemesterId(eq(semesterId), any(ClassSearchRequest.class)))\n                .thenReturn(totalCount);\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/semesters/{id}/classes\", semesterId)\n                        .param(\"page\", \"1\")\n                        .param(\"pageSize\", \"10\"))\n                .andExpect(status().isOk());\n\n        verify(classService).searchClassBySemesterId(eq(semesterId), any(ClassSearchRequest.class));\n        verify(classService).countBySemesterId(eq(semesterId), any(ClassSearchRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_RE_02: Get subjects by semester ID successfully\")\n    void searchSubjectsBySemesterId_Success() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        List<SubjectDTO> subjects = List.of(new SubjectDTO());\n        Long totalCount = 1L;\n\n        when(subjectService.searchBySemesterId(eq(semesterId), any(SubjectSearchRequest.class)))\n                .thenReturn(subjects);\n        when(subjectService.countBySemesterId(eq(semesterId), any(SubjectSearchRequest.class)))\n                .thenReturn(totalCount);\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/semesters/{id}/subjects\", semesterId)\n                        .param(\"page\", \"1\")\n                        .param(\"pageSize\", \"10\"))\n                .andExpect(status().isOk());\n\n        verify(subjectService).searchBySemesterId(eq(semesterId), any(SubjectSearchRequest.class));\n        verify(subjectService).countBySemesterId(eq(semesterId), any(SubjectSearchRequest.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_RE_03: Get students by semester ID successfully\")\n    void searchStudentsBySemesterId_Success() throws Exception {\n        // Given\n        Short semesterId = (short) 1;\n        SemesterDTO semester = new SemesterDTO(\n                (short) 1,\n                \"Fall 2024\",\n                \"FA2024\",\n                LocalDate.of(2024, 9, 1),\n                LocalDate.of(2024, 12, 31),\n                5L,\n                true,\n                Instant.now(),\n                Instant.now()\n        );\n        List<StudentSemesterDTO> students = List.of(new StudentSemesterDTO());\n        Long totalCount = 1L;\n\n        when(semesterService.findById(semesterId)).thenReturn(semester);\n        when(studentProfileService.searchBySemesterId(eq(semesterId), any(StudentSemesterSearchRequest.class)))\n                .thenReturn(students);\n        when(studentProfileService.countBySemesterId(eq(semesterId), any(StudentSemesterSearchRequest.class)))\n                .thenReturn(totalCount);\n\n        // When & Then\n        mockMvc.perform(get(\"/api/v1/semesters/{id}/students\", semesterId)\n                        .param(\"page\", \"1\")\n                        .param(\"pageSize\", \"10\"))\n                .andExpect(status().isOk());\n\n        verify(semesterService).findById(semesterId);\n        verify(studentProfileService).searchBySemesterId(eq(semesterId), any(StudentSemesterSearchRequest.class));\n        verify(studentProfileService).countBySemesterId(eq(semesterId), any(StudentSemesterSearchRequest.class));\n    }\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\CameraServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/CameraServiceTest.java",
      "filename": "CameraServiceTest.java",
      "size_bytes": 30942,
      "lines": 738,
      "last_modified": "2025-11-11T16:10:17.598022",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.dto.mapper.CameraMapper;\nimport com.fuacs.backend.dto.mapper.RoomMapper;\nimport com.fuacs.backend.dto.request.CameraCreateRequest;\nimport com.fuacs.backend.dto.request.CameraSearchBaseRequest;\nimport com.fuacs.backend.dto.request.CameraUpdateRequest;\nimport com.fuacs.backend.dto.response.CameraDTO;\nimport com.fuacs.backend.dto.response.RoomDTO;\nimport com.fuacs.backend.entity.Camera;\nimport com.fuacs.backend.entity.Room;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.CameraRepository;\nimport com.fuacs.backend.repository.RoomRepository;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\nimport org.springframework.dao.DataIntegrityViolationException;\n\nimport java.time.Instant;\nimport java.time.LocalDateTime;\nimport java.util.List;\nimport java.util.Optional;\n\nimport static org.assertj.core.api.Assertions.assertThat;\nimport static org.junit.jupiter.api.Assertions.assertThrows;\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.anyShort;\nimport static org.mockito.Mockito.doNothing;\nimport static org.mockito.Mockito.doThrow;\nimport static org.mockito.Mockito.never;\nimport static org.mockito.Mockito.verify;\nimport static org.mockito.Mockito.when;\n\n@ExtendWith(MockitoExtension.class)\nclass CameraServiceTest {\n\n    @Mock\n    private CameraRepository cameraRepository;\n\n    @Mock\n    private RoomRepository roomRepository;\n\n    @Mock\n    private CameraMapper cameraMapper;\n\n    @Mock\n    private RoomMapper roomMapper;\n\n    @InjectMocks\n    private CameraService cameraService;\n\n    @Test\n    @DisplayName(\"TC_CS_01: Search successfully with valid request\")\n    void search_Success() {\n        CameraSearchBaseRequest request = new CameraSearchBaseRequest(1, 10, \"asc\", \"name\", true, \"Camera\", (short) 1);\n\n        List<CameraDTO> expectedCameras = List.of(\n                new CameraDTO((short) 1, \"Camera A\", \"rtsp://example.com/stream1\", true, Instant.now(), Instant.now(), null)\n        );\n\n        when(cameraRepository.search(any(CameraSearchBaseRequest.class))).thenReturn(expectedCameras);\n\n        List<CameraDTO> result = cameraService.search(request);\n\n        assertThat(result).isEqualTo(expectedCameras);\n        verify(cameraRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CS_02: Search with empty result\")\n    void search_EmptyResult() {\n        CameraSearchBaseRequest request = new CameraSearchBaseRequest(1, 10, \"asc\", \"name\", true, \"NonExistent\", null);\n\n        List<CameraDTO> expectedCameras = List.of();\n\n        when(cameraRepository.search(any(CameraSearchBaseRequest.class))).thenReturn(expectedCameras);\n\n        List<CameraDTO> result = cameraService.search(request);\n\n        assertThat(result).isEmpty();\n        verify(cameraRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CS_03: Search with null parameters\")\n    void search_NullParameters() {\n        CameraSearchBaseRequest request = new CameraSearchBaseRequest(null, null, null, null, null, null, null);\n\n        List<CameraDTO> expectedCameras = List.of(\n                new CameraDTO((short) 1, \"Camera A\", \"rtsp://example.com/stream1\", true, null, Instant.now(), null)\n        );\n\n        when(cameraRepository.search(any(CameraSearchBaseRequest.class))).thenReturn(expectedCameras);\n\n        List<CameraDTO> result = cameraService.search(request);\n\n        assertThat(result).isEqualTo(expectedCameras);\n        verify(cameraRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CO_01: Count successfully with valid request\")\n    void count_Success() {\n        CameraSearchBaseRequest request = new CameraSearchBaseRequest(1, 10, \"asc\", \"name\", true, \"Camera\", null);\n\n        Long expectedCount = 5L;\n\n        when(cameraRepository.count(any(CameraSearchBaseRequest.class))).thenReturn(expectedCount);\n\n        Long result = cameraService.count(request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(cameraRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CO_02: Count with empty result\")\n    void count_EmptyResult() {\n        CameraSearchBaseRequest request = new CameraSearchBaseRequest(1, 10, \"asc\", \"name\", true, \"NonExistent\", null);\n\n        Long expectedCount = 0L;\n\n        when(cameraRepository.count(any(CameraSearchBaseRequest.class))).thenReturn(expectedCount);\n\n        Long result = cameraService.count(request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(cameraRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_FI_01: Find by ID successfully\")\n    void findById_Success() {\n        Short cameraId = (short) 1;\n\n        Room room = new Room();\n        room.setId((short) 1);\n        room.setName(\"Room A\");\n        room.setLocation(\"Building 1\");\n        room.setActive(true);\n\n        Camera camera = new Camera();\n        camera.setId(cameraId);\n        camera.setName(\"Camera A\");\n        camera.setRtspUrl(\"rtsp://example.com/stream1\");\n        camera.setActive(true);\n        camera.setRoom(room);\n        camera.setCreatedAt(Instant.now());\n        camera.setUpdatedAt(Instant.now());\n\n        CameraDTO expectedDTO = new CameraDTO(cameraId, \"Camera A\", \"rtsp://example.com/stream1\", true, null, Instant.now(), null);\n        RoomDTO roomDTO = new RoomDTO((short) 1, \"Room A\", \"Building 1\", 50L, Instant.now(), true, Instant.now(), Instant.now());\n\n        when(cameraRepository.findById(cameraId)).thenReturn(Optional.of(camera));\n        when(cameraMapper.toDTO(camera)).thenReturn(expectedDTO);\n        when(roomMapper.toDTO(room)).thenReturn(roomDTO);\n\n        CameraDTO result = cameraService.findById(cameraId);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getRoom()).isNotNull();\n        assertThat(result.getRoom().getName()).isEqualTo(\"Room A\");\n        verify(cameraRepository).findById(cameraId);\n        verify(cameraMapper).toDTO(camera);\n        verify(roomMapper).toDTO(room);\n    }\n\n    @Test\n    @DisplayName(\"TC_FI_02: Throw ResourceNotFoundException when ID not found\")\n    void findById_NotFound() {\n        Short cameraId = 999;\n        when(cameraRepository.findById(cameraId)).thenReturn(Optional.empty());\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> cameraService.findById(cameraId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Camera not found: \" + cameraId);\n        verify(cameraRepository).findById(cameraId);\n    }\n\n    @Test\n    @DisplayName(\"TC_FBR_01: Find by room ID successfully\")\n    void findByRoomId_Success() {\n        Short roomId = (short) 1;\n\n        Camera camera1 = new Camera();\n        camera1.setId((short) 1);\n        camera1.setName(\"Camera A\");\n        camera1.setRtspUrl(\"rtsp://example.com/stream1\");\n\n        Camera camera2 = new Camera();\n        camera2.setId((short) 2);\n        camera2.setName(\"Camera B\");\n        camera2.setRtspUrl(\"rtsp://example.com/stream2\");\n\n        List<Camera> cameras = List.of(camera1, camera2);\n        List<CameraDTO> expectedDTOs = List.of(\n                new CameraDTO((short) 1, \"Camera A\", \"rtsp://example.com/stream1\", true, null, Instant.now(), null),\n                new CameraDTO((short) 2, \"Camera B\", \"rtsp://example.com/stream2\", true, null, Instant.now(), null)\n        );\n\n        when(cameraRepository.findByRoom_Id(roomId)).thenReturn(cameras);\n        when(cameraMapper.toDTO(cameras)).thenReturn(expectedDTOs);\n\n        List<CameraDTO> result = cameraService.findByRoomId(roomId);\n\n        assertThat(result).hasSize(2);\n        verify(cameraRepository).findByRoom_Id(roomId);\n        verify(cameraMapper).toDTO(cameras);\n    }\n\n    @Test\n    @DisplayName(\"TC_FBR_02: Find by room ID with empty result\")\n    void findByRoomId_EmptyResult() {\n        Short roomId = (short) 999;\n\n        when(cameraRepository.findByRoom_Id(roomId)).thenReturn(List.of());\n        when(cameraMapper.toDTO(List.of())).thenReturn(List.of());\n\n        List<CameraDTO> result = cameraService.findByRoomId(roomId);\n\n        assertThat(result).isEmpty();\n        verify(cameraRepository).findByRoom_Id(roomId);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_01: Create camera successfully\")\n    void create_Success() {\n        CameraCreateRequest request = new CameraCreateRequest();\n        // Simulate setting values via reflection or test constructor\n        Short roomId = (short) 1;\n        request.setRoomId(roomId);\n        request.setName(\"Camera A\");\n        request.setRtspUrl(\"rtsp://example.com/stream1\");\n        Room room = new Room();\n        room.setId(roomId);\n        room.setName(\"Room A\");\n        room.setLocation(\"Building 1\");\n        room.setActive(true);\n\n        Camera camera = new Camera();\n        camera.setId((short) 1);\n        camera.setName(\"Camera A\");\n        camera.setRtspUrl(\"rtsp://example.com/stream1\");\n        camera.setActive(true);\n        camera.setRoom(room);\n\n        CameraDTO expectedDTO = new CameraDTO((short) 1, \"Camera A\", \"rtsp://example.com/stream1\", true, null, Instant.now(), null);\n        RoomDTO roomDTO = new RoomDTO(roomId, \"Room A\", \"Building 1\", 50L, Instant.now(), true, Instant.now(), Instant.now());\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(room));\n        when(cameraRepository.existsByName(\"Camera A\")).thenReturn(false);\n        when(cameraRepository.existsByRtspUrl(\"rtsp://example.com/stream1\")).thenReturn(false);\n        when(cameraMapper.toEntity(request)).thenReturn(camera);\n        when(cameraRepository.save(camera)).thenReturn(camera);\n        when(cameraMapper.toDTO(camera)).thenReturn(expectedDTO);\n        when(roomMapper.toDTO(room)).thenReturn(roomDTO);\n\n        CameraDTO result = cameraService.create(request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getName()).isEqualTo(\"Camera A\");\n        verify(roomRepository).findById(roomId);\n        verify(cameraRepository).existsByName(\"Camera A\");\n        verify(cameraRepository).existsByRtspUrl(\"rtsp://example.com/stream1\");\n        verify(cameraRepository).save(camera);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_02: Throw ResourceNotFoundException when room not found\")\n    void create_RoomNotFound() {\n        CameraCreateRequest request = new CameraCreateRequest();\n        Short roomId = 999;\n        request.setRoomId(roomId);\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.empty());\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> cameraService.create(request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Room not found: \" + roomId);\n        verify(roomRepository).findById(roomId);\n        verify(cameraRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_03: Throw ResourceExistsException when camera name exists\")\n    void create_NameExists() {\n        CameraCreateRequest request = new CameraCreateRequest();\n        Short roomId = (short) 1;\n        request.setName(\"Camera A\");\n        request.setRoomId(roomId);\n        Room room = new Room();\n        room.setId(roomId);\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(room));\n        when(cameraRepository.existsByName(\"Camera A\")).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> cameraService.create(request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Camera name exists: Camera A\");\n        verify(cameraRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_04: Throw ResourceExistsException when RTSP URL exists\")\n    void create_RtspUrlExists() {\n        CameraCreateRequest request = new CameraCreateRequest();\n        Short roomId = (short) 1;\n        request.setRoomId(roomId);\n        request.setName(\"Camera A\");\n        request.setRtspUrl(\"rtsp://example.com/stream1\");\n        Room room = new Room();\n        room.setId(roomId);\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(room));\n        when(cameraRepository.existsByName(\"Camera A\")).thenReturn(false);\n        when(cameraRepository.existsByRtspUrl(\"rtsp://example.com/stream1\")).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> cameraService.create(request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"RTSP URL exists: rtsp://example.com/stream1\");\n        verify(cameraRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_01: Update camera successfully\")\n    void update_Success() {\n        Short cameraId = (short) 1;\n        CameraUpdateRequest request = new CameraUpdateRequest();\n        Short roomId = (short) 1;\n        request.setName(\"Camera A\");\n        request.setRoomId(roomId);\n        request.setRtspUrl(\"rtsp://example.com/stream1\");\n        request.setActive(true);\n\n        Room room = new Room();\n        room.setId(roomId);\n        room.setName(\"Room A\");\n\n        Camera existingCamera = new Camera();\n        existingCamera.setId(cameraId);\n        existingCamera.setName(\"Camera A\");\n        existingCamera.setRtspUrl(\"rtsp://example.com/stream1\");\n        existingCamera.setActive(true);\n        existingCamera.setRoom(room);\n\n        Camera savedCamera = new Camera();\n        savedCamera.setId(cameraId);\n        savedCamera.setName(\"Updated Camera A\");\n        savedCamera.setRtspUrl(\"rtsp://example.com/stream1-updated\");\n        savedCamera.setActive(true);\n        savedCamera.setRoom(room);\n\n        CameraDTO expectedDTO = new CameraDTO(cameraId, \"Updated Camera A\", \"rtsp://example.com/stream1-updated\", true, null, Instant.now(), null);\n        RoomDTO roomDTO = new RoomDTO(roomId, \"Room A\", \"Building 1\", 50L, Instant.now(), true, Instant.now(), Instant.now());\n\n        when(cameraRepository.findById(cameraId)).thenReturn(Optional.of(existingCamera));\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(room));\n        when(cameraRepository.save(existingCamera)).thenReturn(savedCamera);\n        when(cameraMapper.toDTO(savedCamera)).thenReturn(expectedDTO);\n        when(roomMapper.toDTO(room)).thenReturn(roomDTO);\n\n        CameraDTO result = cameraService.update(cameraId, request);\n\n        assertThat(result).isNotNull();\n        verify(cameraRepository).findById(cameraId);\n        verify(cameraMapper).updateCameraFromRequest(request, existingCamera);\n        verify(cameraRepository).save(existingCamera);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_02: Throw ResourceNotFoundException when updating non-existent camera\")\n    void update_CameraNotFound() {\n        Short cameraId = 999;\n        CameraUpdateRequest request = new CameraUpdateRequest();\n\n        when(cameraRepository.findById(cameraId)).thenReturn(Optional.empty());\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> cameraService.update(cameraId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Camera not found: \" + cameraId);\n        verify(cameraRepository).findById(cameraId);\n        verify(cameraRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_03: Throw ResourceExistsException when camera name exists\")\n    void update_NameExists() {\n        Short cameraId = (short) 1;\n        Short roomId = (short) 1;\n\n        // This is the new name that already exists somewhere else\n        String collidingName = \"Existing Name\";\n\n        CameraUpdateRequest request = new CameraUpdateRequest();\n        // 1. Set the request to use the colliding name\n        request.setName(collidingName);\n        request.setRtspUrl(\"rtsp://example.com/stream1\");\n        request.setActive(true);\n        request.setRoomId(roomId);\n\n        Camera existingCamera = new Camera();\n        existingCamera.setId(cameraId);\n        // 2. The camera's *current* name must be DIFFERENT\n        existingCamera.setName(\"Camera A\");\n        existingCamera.setRtspUrl(\"rtsp://example.com/stream1\");\n\n        Room room = new Room();\n        room.setId(roomId);\n        room.setName(\"Room A\");\n\n        when(cameraRepository.findById(cameraId)).thenReturn(Optional.of(existingCamera));\n\n        // 3. Stub the check using the NEW colliding name\n        // The service will call: existsByNameAndIdNot(\"Existing Name\", 1)\n        when(cameraRepository.existsByNameAndIdNot(collidingName, cameraId)).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> cameraService.update(cameraId, request)\n        );\n\n        // 4. Verify the correct exception message\n        assertThat(exception.getMessage()).contains(\"Camera name already exists: \" + collidingName);\n\n        // Also, verify the check was actually called\n        verify(cameraRepository).existsByNameAndIdNot(collidingName, cameraId);\n        // Verify save was NOT called\n        verify(cameraRepository, never()).save(any(Camera.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_04: Throw ResourceExistsException when RTSP URL exists\")\n    void update_RtspUrlExists() {\n        Short cameraId = (short) 1;\n        String newName = \"Camera A\"; // Assume name is not changing, or set a new valid name\n        String collidingRtspUrl = \"rtsp://example.com/colliding-url\";\n\n        CameraUpdateRequest request = new CameraUpdateRequest();\n        // 1. Set a valid name on the request\n        request.setName(newName);\n        // 2. Set the NEW colliding URL on the request\n        request.setRtspUrl(collidingRtspUrl);\n\n        Camera existingCamera = new Camera();\n        existingCamera.setId(cameraId);\n        existingCamera.setName(\"Camera A\"); // Old name\n        // 3. The camera's *current* URL must be DIFFERENT\n        existingCamera.setRtspUrl(\"rtsp://example.com/stream1\"); // Old URL\n\n        when(cameraRepository.findById(cameraId)).thenReturn(Optional.of(existingCamera));\n\n        // 4. Stub the name check (it will pass)\n        // Because request.getName() equals existingCamera.getName(), this check might be skipped.\n        // If you use a *new* name, this stub is required:\n        // when(cameraRepository.existsByNameAndIdNot(newName, cameraId)).thenReturn(false);\n\n        // 5. Stub the RTSP check (it will fail)\n        // Service will check: existsByRtspUrlAndIdNot(\"rtsp://example.com/colliding-url\", 1)\n        when(cameraRepository.existsByRtspUrlAndIdNot(collidingRtspUrl, cameraId)).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> cameraService.update(cameraId, request)\n        );\n\n        // 6. Verify the correct exception message\n        assertThat(exception.getMessage()).contains(\"RTSP URL already exists: \" + collidingRtspUrl);\n\n        // 7. Verify the checks\n        verify(cameraRepository).findById(cameraId);\n        verify(cameraRepository).existsByRtspUrlAndIdNot(collidingRtspUrl, cameraId);\n        verify(cameraRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_05: Throw ResourceNotFoundException when room not found\")\n    void update_RoomNotFound() {\n        Short cameraId = (short) 1;\n        Short roomId = 999;\n        CameraUpdateRequest request = new CameraUpdateRequest();\n        request.setName(\"Camera A\");\n        request.setRoomId(roomId);\n        request.setRtspUrl(\"rtsp://example.com/stream1\");\n        request.setActive(true);\n\n        Camera existingCamera = new Camera();\n        existingCamera.setId(cameraId);\n        existingCamera.setName(\"Camera A\");\n        existingCamera.setRtspUrl(\"rtsp://example.com/stream1\");\n\n        when(cameraRepository.findById(cameraId)).thenReturn(Optional.of(existingCamera));\n        when(roomRepository.findById(roomId)).thenReturn(Optional.empty());\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> cameraService.update(cameraId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Room not found: \" + roomId);\n        verify(cameraRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_06: Update success - Deactivate camera\")\n    void update_Success_DeactivateCamera() {\n        Short cameraId = (short) 1;\n        Short roomId = (short) 1;\n        CameraUpdateRequest request = new CameraUpdateRequest();\n        request.setName(\"Camera A\");\n        request.setRtspUrl(\"rtsp://example.com/stream1\");\n        request.setActive(false);\n        request.setRoomId(roomId);\n\n        Room room = new Room();\n        room.setId(roomId);\n\n        Camera existingCamera = new Camera();\n        existingCamera.setId(cameraId);\n        existingCamera.setName(\"Camera A\");\n        existingCamera.setRtspUrl(\"rtsp://example.com/stream1\");\n        existingCamera.setActive(true); // Currently active\n\n        Camera savedCamera = new Camera();\n        savedCamera.setId(cameraId);\n        savedCamera.setName(\"Camera A\");\n        savedCamera.setRtspUrl(\"rtsp://example.com/stream1\");\n        savedCamera.setActive(false);\n        savedCamera.setRoom(room);\n\n        CameraDTO expectedDTO = new CameraDTO(cameraId, \"Camera A\", \"rtsp://example.com/stream1\", false, null, Instant.now(), null);\n        RoomDTO roomDTO = new RoomDTO(roomId, \"Room A\", \"Building 1\", 50L, Instant.now(), true, Instant.now(), Instant.now());\n\n        when(cameraRepository.findById(cameraId)).thenReturn(Optional.of(existingCamera));\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(room));\n        when(cameraRepository.save(existingCamera)).thenReturn(savedCamera);\n        when(cameraMapper.toDTO(savedCamera)).thenReturn(expectedDTO);\n        when(roomMapper.toDTO(room)).thenReturn(roomDTO);\n        doNothing().when(cameraMapper).updateCameraFromRequest(request, existingCamera);\n\n        CameraDTO result = cameraService.update(cameraId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getActive()).isFalse();\n        verify(cameraRepository, never()).countActiveSlotsByCameraId(anyShort(), any(LocalDateTime.class));\n        verify(cameraRepository).save(existingCamera);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_07: Update success - Activate camera\")\n    void update_Success_ActivateCamera() {\n        Short cameraId = (short) 1;\n        Short roomId = (short) 1;\n        CameraUpdateRequest request = new CameraUpdateRequest();\n        request.setActive(true);\n        request.setName(\"Camera A\");\n        request.setRtspUrl(\"rtsp://example.com/stream1\");\n        request.setRoomId(roomId);\n\n        Room room = new Room();\n        room.setId(roomId);\n\n        Camera existingCamera = new Camera();\n        existingCamera.setId(cameraId);\n        existingCamera.setName(\"Camera A\");\n        existingCamera.setRtspUrl(\"rtsp://example.com/stream1\");\n        existingCamera.setActive(false); // Currently inactive\n\n        Camera savedCamera = new Camera();\n        savedCamera.setId(cameraId);\n        savedCamera.setName(\"Camera A\");\n        savedCamera.setRtspUrl(\"rtsp://example.com/stream1\");\n        savedCamera.setActive(true);\n        savedCamera.setRoom(room);\n\n        CameraDTO expectedDTO = new CameraDTO(cameraId, \"Camera A\", \"rtsp://example.com/stream1\", true, null, Instant.now(), null);\n        RoomDTO roomDTO = new RoomDTO(roomId, \"Room A\", \"Building 1\", 50L, Instant.now(), true, Instant.now(), Instant.now());\n\n        when(cameraRepository.findById(cameraId)).thenReturn(Optional.of(existingCamera));\n       when(roomRepository.findById(roomId)).thenReturn(Optional.of(room));\n        when(cameraRepository.save(existingCamera)).thenReturn(savedCamera);\n        when(cameraMapper.toDTO(savedCamera)).thenReturn(expectedDTO);\n        when(roomMapper.toDTO(room)).thenReturn(roomDTO);\n        doNothing().when(cameraMapper).updateCameraFromRequest(request, existingCamera);\n\n        CameraDTO result = cameraService.update(cameraId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getActive()).isTrue();\n        verify(cameraRepository, never()).countActiveSlotsByCameraId(anyShort(), any(LocalDateTime.class));\n        verify(cameraRepository).save(existingCamera);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_08: Update camera with same name and RTSP URL (no change)\")\n    void update_SameNameAndRtspUrl() {\n        Short cameraId = (short) 1;\n        Short roomId = (short) 1;\n        CameraUpdateRequest request = new CameraUpdateRequest();\n        request.setActive(true);\n        request.setName(\"Camera A\");\n        request.setRtspUrl(\"rtsp://example.com/stream1\");\n        request.setRoomId(roomId);\n\n        Room room = new Room();\n        room.setId(roomId);\n\n        Camera existingCamera = new Camera();\n        existingCamera.setId(cameraId);\n        existingCamera.setName(\"Camera A\");\n        existingCamera.setRtspUrl(\"rtsp://example.com/stream1\");\n        existingCamera.setActive(true);\n        existingCamera.setRoom(room);\n\n        Camera savedCamera = new Camera();\n        savedCamera.setId(cameraId);\n        savedCamera.setName(\"Camera A\");\n        savedCamera.setRtspUrl(\"rtsp://example.com/stream1\");\n        savedCamera.setActive(true);\n        savedCamera.setRoom(room);\n\n        CameraDTO expectedDTO = new CameraDTO(cameraId, \"Camera A\", \"rtsp://example.com/stream1\", true, null, Instant.now(), null);\n        RoomDTO roomDTO = new RoomDTO(roomId, \"Room A\", \"Building 1\", 50L, Instant.now(), true, Instant.now(), Instant.now());\n\n        when(cameraRepository.findById(cameraId)).thenReturn(Optional.of(existingCamera));\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(room));\n        when(cameraRepository.save(existingCamera)).thenReturn(savedCamera);\n        when(cameraMapper.toDTO(savedCamera)).thenReturn(expectedDTO);\n        when(roomMapper.toDTO(room)).thenReturn(roomDTO);\n        doNothing().when(cameraMapper).updateCameraFromRequest(request, existingCamera);\n\n        CameraDTO result = cameraService.update(cameraId, request);\n\n        assertThat(result).isNotNull();\n        verify(cameraRepository).findById(cameraId);\n        verify(cameraRepository, never()).existsByNameAndIdNot(any(), any());\n        verify(cameraRepository, never()).existsByRtspUrlAndIdNot(any(), any());\n        verify(cameraRepository).save(existingCamera);\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_01: Delete camera successfully\")\n    void delete_Success() {\n        Short cameraId = (short) 1;\n\n        when(cameraRepository.existsById(cameraId)).thenReturn(true);\n        when(cameraRepository.countActiveSlotsByCameraId(any(Short.class), any(LocalDateTime.class))).thenReturn(0L);\n        doNothing().when(cameraRepository).deleteById(cameraId);\n\n        cameraService.delete(cameraId);\n\n        verify(cameraRepository).existsById(cameraId);\n        verify(cameraRepository).countActiveSlotsByCameraId(any(Short.class), any(LocalDateTime.class));\n        verify(cameraRepository).deleteById(cameraId);\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_02: Throw ResourceNotFoundException when ID not found\")\n    void delete_NotFound() {\n        Short cameraId = 999;\n        when(cameraRepository.existsById(cameraId)).thenReturn(false);\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> cameraService.delete(cameraId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Camera not found: \" + cameraId);\n        verify(cameraRepository).existsById(cameraId);\n        verify(cameraRepository, never()).deleteById(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_03: Throw OperationNotAllowedException when deleting camera with active slots\")\n    void delete_CameraHasActiveSlots() {\n        Short cameraId = (short) 1;\n\n        // Given\n        when(cameraRepository.existsById(cameraId)).thenReturn(true);\n        when(cameraRepository.countActiveSlotsByCameraId(any(Short.class), any(LocalDateTime.class))).thenReturn(3L);\n\n        // When\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> cameraService.delete(cameraId)\n        );\n\n        // Then\n        assertThat(exception.getMessage()).contains(\"Cannot delete camera with active slots\");\n        verify(cameraRepository).existsById(cameraId);\n        verify(cameraRepository).countActiveSlotsByCameraId(any(Short.class), any(LocalDateTime.class));\n        verify(cameraRepository, never()).deleteById(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_04: Throw OperationNotAllowedException on DataIntegrityViolation\")\n    void delete_DataIntegrityViolation() {\n        Short cameraId = (short) 1;\n\n        // Given\n        when(cameraRepository.existsById(cameraId)).thenReturn(true);\n        when(cameraRepository.countActiveSlotsByCameraId(any(Short.class), any(LocalDateTime.class))).thenReturn(0L);\n        doThrow(new DataIntegrityViolationException(\"Simulated foreign key constraint\"))\n                .when(cameraRepository).deleteById(cameraId);\n\n        // When\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> cameraService.delete(cameraId)\n        );\n\n        // Then\n        assertThat(exception.getMessage()).contains(\"Cannot delete camera. It is currently in use by other records.\");\n        verify(cameraRepository).existsById(cameraId);\n        verify(cameraRepository).countActiveSlotsByCameraId(any(Short.class), any(LocalDateTime.class));\n        verify(cameraRepository).deleteById(cameraId);\n    }\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\MajorServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/MajorServiceTest.java",
      "filename": "MajorServiceTest.java",
      "size_bytes": 28777,
      "lines": 690,
      "last_modified": "2025-10-29T20:56:54.629200",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.dto.mapper.MajorMapper;\nimport com.fuacs.backend.dto.request.MajorCreateRequest;\nimport com.fuacs.backend.dto.request.MajorSearchRequest;\nimport com.fuacs.backend.dto.request.MajorUpdateRequest;\nimport com.fuacs.backend.dto.response.MajorDTO;\nimport com.fuacs.backend.entity.Major;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.MajorRepository;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\n\nimport java.time.Instant;\nimport java.util.List;\nimport java.util.Optional;\n\nimport static org.assertj.core.api.Assertions.assertThat;\nimport static org.junit.jupiter.api.Assertions.assertThrows;\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.Mockito.doNothing;\nimport static org.mockito.Mockito.never;\nimport static org.mockito.Mockito.verify;\nimport static org.mockito.Mockito.when;\n\n@ExtendWith(MockitoExtension.class)\nclass MajorServiceTest {\n\n    @Mock\n    private MajorRepository majorRepository;\n\n    @Mock\n    private MajorMapper majorMapper;\n\n    @InjectMocks\n    private MajorService majorService;\n\n    @Test\n    @DisplayName(\"TC_SS_01: Search successfully with valid request\")\n    void search_Success() {\n        MajorSearchRequest request = new MajorSearchRequest(1, 10, \"asc\", \"name\", true, \"Computer\");\n\n        List<MajorDTO> expectedMajors = List.of(new MajorDTO(\n                (short) 1, \"Computer Science\", \"CS\",\n                true, Instant.now(), Instant.now(), 5L));\n\n        when(majorRepository.search(any(MajorSearchRequest.class))).thenReturn(expectedMajors);\n\n        List<MajorDTO> result = majorService.search(request);\n\n        assertThat(result).isEqualTo(expectedMajors);\n        verify(majorRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_SS_02: Search with empty result\")\n    void search_EmptyResult() {\n        MajorSearchRequest request = new MajorSearchRequest(1, 10, \"asc\", \"name\", true, \"NonExistent\");\n\n        List<MajorDTO> expectedMajors = List.of();\n\n        when(majorRepository.search(any(MajorSearchRequest.class))).thenReturn(expectedMajors);\n\n        List<MajorDTO> result = majorService.search(request);\n\n        assertThat(result).isEmpty();\n        verify(majorRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_SS_03: Search with null parameters\")\n    void search_NullParameters() {\n        MajorSearchRequest request = new MajorSearchRequest(null, null, null, null, null, null);\n\n        List<MajorDTO> expectedMajors = List.of(new MajorDTO(\n                (short) 1, \"Computer Science\", \"CS\",\n                true, Instant.now(), Instant.now(), 5L));\n\n        when(majorRepository.search(any(MajorSearchRequest.class))).thenReturn(expectedMajors);\n\n        List<MajorDTO> result = majorService.search(request);\n\n        assertThat(result).isEqualTo(expectedMajors);\n        verify(majorRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_SS_04: Search with different sort options\")\n    void search_DifferentSortOptions() {\n        MajorSearchRequest request = new MajorSearchRequest(1, 10, \"desc\", \"code\", false, \"Science\");\n\n        List<MajorDTO> expectedMajors = List.of(new MajorDTO(\n                (short) 2, \"Data Science\", \"DS\",\n                false, Instant.now(), Instant.now(), 3L));\n\n        when(majorRepository.search(any(MajorSearchRequest.class))).thenReturn(expectedMajors);\n\n        List<MajorDTO> result = majorService.search(request);\n\n        assertThat(result).isEqualTo(expectedMajors);\n        verify(majorRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CO_01: Count successfully with valid request\")\n    void count_Success() {\n        MajorSearchRequest request = new MajorSearchRequest(1, 10, \"asc\", \"name\", true, \"Computer\");\n\n        Long expectedCount = 5L;\n\n        when(majorRepository.count(any(MajorSearchRequest.class))).thenReturn(expectedCount);\n\n        Long result = majorService.count(request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(majorRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CO_02: Count with empty result\")\n    void count_EmptyResult() {\n        MajorSearchRequest request = new MajorSearchRequest(1, 10, \"asc\", \"name\", true, \"NonExistent\");\n\n        Long expectedCount = 0L;\n\n        when(majorRepository.count(any(MajorSearchRequest.class))).thenReturn(expectedCount);\n\n        Long result = majorService.count(request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(majorRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CO_03: Count with null request\")\n    void count_NullRequest() {\n        MajorSearchRequest request = new MajorSearchRequest(null, null, null, null, null, null);\n\n        Long expectedCount = 10L;\n\n        when(majorRepository.count(any(MajorSearchRequest.class))).thenReturn(expectedCount);\n\n        Long result = majorService.count(request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(majorRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_FI_01: Find by ID successfully\")\n    void findById_Success() {\n        Short majorId = (short) 1;\n        MajorDTO expectedDTO = new MajorDTO(\n                majorId, \"Computer Science\", \"CS\",\n                true, Instant.now(), Instant.now(), 5L);\n\n        when(majorRepository.findMajorDTOById(majorId)).thenReturn(Optional.of(expectedDTO));\n\n        MajorDTO result = majorService.findById(majorId);\n\n        assertThat(result).isNotNull();\n        assertThat(result).isEqualTo(expectedDTO);\n        verify(majorRepository).findMajorDTOById(majorId);\n    }\n\n    @Test\n    @DisplayName(\"TC_FI_02: Throw ResourceNotFoundException when ID not found\")\n    void findById_NotFound() {\n        Short majorId = 999;\n        when(majorRepository.findMajorDTOById(majorId)).thenReturn(Optional.empty());\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> majorService.findById(majorId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Major not found: \" + majorId);\n        verify(majorRepository).findMajorDTOById(majorId);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_01: Create major successfully\")\n    void create_Success() {\n        String name = \"Computer Science\";\n        String code = \"CS\";\n        Instant now = Instant.now();\n\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(name);\n        request.setCode(code);\n\n        Major savedMajor = new Major();\n        savedMajor.setId((short) 1);\n        savedMajor.setName(name);\n        savedMajor.setCode(code);\n        savedMajor.setActive(true);\n        savedMajor.setCreatedAt(now);\n        savedMajor.setUpdatedAt(now);\n\n        MajorDTO expectedDTO = new MajorDTO(\n                (short) 1, name, code,\n                true, now, now, 0L);\n\n        when(majorRepository.existsByCode(request.getCode())).thenReturn(false);\n        when(majorRepository.existsByName(request.getName())).thenReturn(false);\n        when(majorMapper.toEntity(request)).thenReturn(savedMajor);\n        when(majorRepository.save(savedMajor)).thenReturn(savedMajor);\n        when(majorMapper.toDTO(savedMajor)).thenReturn(expectedDTO);\n\n        MajorDTO actual = majorService.create(request);\n\n        assertThat(actual).isNotNull();\n        assertThat(actual).isEqualTo(expectedDTO);\n        verify(majorRepository).existsByCode(request.getCode());\n        verify(majorRepository).existsByName(request.getName());\n        verify(majorMapper).toEntity(request);\n        verify(majorRepository).save(savedMajor);\n        verify(majorMapper).toDTO(savedMajor);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_02: Throw ResourceExistsException when code exists\")\n    void create_CodeExists() {\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n\n        when(majorRepository.existsByCode(request.getCode())).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(ResourceExistsException.class, () -> majorService.create(request));\n\n        assertThat(exception.getMessage()).contains(\"Major code already exists: \" + request.getCode());\n        verify(majorRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_03: Throw ResourceExistsException when name exists\")\n    void create_NameExists() {\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n\n        when(majorRepository.existsByCode(request.getCode())).thenReturn(false);\n        when(majorRepository.existsByName(request.getName())).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(ResourceExistsException.class, () -> majorService.create(request));\n\n        assertThat(exception.getMessage()).contains(\"Major name already exists: \" + request.getName());\n        verify(majorRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_04: Create major with minimum valid data\")\n    void create_MinimumValidData() {\n        String name = \"CS\";\n        String code = \"C\";\n        Instant now = Instant.now();\n\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(name);\n        request.setCode(code);\n\n        Major savedMajor = new Major();\n        savedMajor.setId((short) 1);\n        savedMajor.setName(name);\n        savedMajor.setCode(code);\n        savedMajor.setActive(true);\n        savedMajor.setCreatedAt(now);\n        savedMajor.setUpdatedAt(now);\n\n        MajorDTO expectedDTO = new MajorDTO(\n                (short) 1, name, code,\n                true, now, now, 0L);\n\n        when(majorRepository.existsByCode(request.getCode())).thenReturn(false);\n        when(majorRepository.existsByName(request.getName())).thenReturn(false);\n        when(majorMapper.toEntity(request)).thenReturn(savedMajor);\n        when(majorRepository.save(savedMajor)).thenReturn(savedMajor);\n        when(majorMapper.toDTO(savedMajor)).thenReturn(expectedDTO);\n\n        MajorDTO actual = majorService.create(request);\n\n        assertThat(actual).isNotNull();\n        assertThat(actual.getName()).isEqualTo(name);\n        assertThat(actual.getCode()).isEqualTo(code);\n        verify(majorRepository).existsByCode(request.getCode());\n        verify(majorRepository).existsByName(request.getName());\n        verify(majorMapper).toEntity(request);\n        verify(majorRepository).save(savedMajor);\n        verify(majorMapper).toDTO(savedMajor);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_05: Create major with maximum valid data\")\n    void create_MaximumValidData() {\n        String name = \"A Very Long Major Name That Is Exactly One Hundred Fifty Characters Long And Should Be Valid According To The Validation Rules Set In The Request Class\";\n        String code = \"MAX20CHAR1234567890\";\n        Instant now = Instant.now();\n\n        MajorCreateRequest request = new MajorCreateRequest();\n        request.setName(name);\n        request.setCode(code);\n\n        Major savedMajor = new Major();\n        savedMajor.setId((short) 1);\n        savedMajor.setName(name);\n        savedMajor.setCode(code);\n        savedMajor.setActive(true);\n        savedMajor.setCreatedAt(now);\n        savedMajor.setUpdatedAt(now);\n\n        MajorDTO expectedDTO = new MajorDTO(\n                (short) 1, name, code,\n                true, now, now, 0L);\n\n        when(majorRepository.existsByCode(request.getCode())).thenReturn(false);\n        when(majorRepository.existsByName(request.getName())).thenReturn(false);\n        when(majorMapper.toEntity(request)).thenReturn(savedMajor);\n        when(majorRepository.save(savedMajor)).thenReturn(savedMajor);\n        when(majorMapper.toDTO(savedMajor)).thenReturn(expectedDTO);\n\n        MajorDTO actual = majorService.create(request);\n\n        assertThat(actual).isNotNull();\n        assertThat(actual.getName()).isEqualTo(name);\n        assertThat(actual.getCode()).isEqualTo(code);\n        verify(majorRepository).existsByCode(request.getCode());\n        verify(majorRepository).existsByName(request.getName());\n        verify(majorMapper).toEntity(request);\n        verify(majorRepository).save(savedMajor);\n        verify(majorMapper).toDTO(savedMajor);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_01: Update major successfully\")\n    void update_Success() {\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Updated Computer Science\");\n        request.setCode(\"UCS\");\n        request.setActive(true);\n\n        Major existingMajor = new Major();\n        existingMajor.setId(majorId);\n        existingMajor.setName(\"Computer Science\");\n        existingMajor.setCode(\"CS\");\n        existingMajor.setActive(true);\n        existingMajor.setCreatedAt(Instant.now());\n        existingMajor.setUpdatedAt(Instant.now());\n\n        Major savedMajor = new Major();\n        savedMajor.setId(majorId);\n        savedMajor.setName(\"Updated Computer Science\");\n        savedMajor.setCode(\"UCS\");\n        savedMajor.setActive(true);\n        savedMajor.setCreatedAt(Instant.now());\n        savedMajor.setUpdatedAt(Instant.now());\n\n        MajorDTO expectedDTO = new MajorDTO(\n                majorId, \"Updated Computer Science\", \"UCS\",\n                true, Instant.now(), Instant.now(), 5L);\n\n        when(majorRepository.findById(majorId)).thenReturn(Optional.of(existingMajor));\n        when(majorRepository.existsByCodeAndIdNot(request.getCode(), majorId)).thenReturn(false);\n        when(majorRepository.existsByNameAndIdNot(request.getName(), majorId)).thenReturn(false);\n        when(majorRepository.save(existingMajor)).thenReturn(savedMajor);\n        when(majorMapper.toDTO(savedMajor)).thenReturn(expectedDTO);\n\n        MajorDTO result = majorService.update(majorId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result).isEqualTo(expectedDTO);\n        verify(majorRepository).findById(majorId);\n        verify(majorMapper).updateFromRequest(request, existingMajor);\n        verify(majorRepository).save(existingMajor);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_02: Throw ResourceNotFoundException when updating non-existent major\")\n    void update_MajorNotFound() {\n        Short majorId = 999;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Updated Computer Science\");\n        request.setCode(\"UCS\");\n        request.setActive(true);\n\n        when(majorRepository.findById(majorId)).thenReturn(Optional.empty());\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> majorService.update(majorId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Major not found: \" + majorId);\n        verify(majorRepository).findById(majorId);\n        verify(majorRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_03: Throw ResourceExistsException when code exists\")\n    void update_CodeExists() {\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Updated Computer Science\");\n        request.setCode(\"EXISTING_CODE\");\n        request.setActive(true);\n\n        Major existingMajor = new Major();\n        existingMajor.setId(majorId);\n        existingMajor.setName(\"Computer Science\");\n        existingMajor.setCode(\"CS\");\n        existingMajor.setActive(true);\n        existingMajor.setCreatedAt(Instant.now());\n        existingMajor.setUpdatedAt(Instant.now());\n\n        when(majorRepository.findById(majorId)).thenReturn(Optional.of(existingMajor));\n        when(majorRepository.existsByCodeAndIdNot(request.getCode(), majorId)).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> majorService.update(majorId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Major code already exists: \" + request.getCode());\n        verify(majorRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_04: Throw ResourceExistsException when name exists\")\n    void update_NameExists() {\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Existing Name\");\n        request.setCode(\"UCS\");\n        request.setActive(true);\n\n        Major existingMajor = new Major();\n        existingMajor.setId(majorId);\n        existingMajor.setName(\"Computer Science\");\n        existingMajor.setCode(\"CS\");\n        existingMajor.setActive(true);\n        existingMajor.setCreatedAt(Instant.now());\n        existingMajor.setUpdatedAt(Instant.now());\n\n        when(majorRepository.findById(majorId)).thenReturn(Optional.of(existingMajor));\n        when(majorRepository.existsByCodeAndIdNot(request.getCode(), majorId)).thenReturn(false);\n        when(majorRepository.existsByNameAndIdNot(request.getName(), majorId)).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> majorService.update(majorId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Major name already exists: \" + request.getName());\n        verify(majorRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_05: Throw OperationNotAllowedException when deactivating major with active subjects\")\n    void update_DeactivateWithActiveSubjects() {\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Updated Computer Science\");\n        request.setCode(\"UCS\");\n        request.setActive(false); // Deactivating\n\n        Major existingMajor = new Major();\n        existingMajor.setId(majorId);\n        existingMajor.setName(\"Computer Science\");\n        existingMajor.setCode(\"CS\");\n        existingMajor.setActive(true); // Currently active\n        existingMajor.setCreatedAt(Instant.now());\n        existingMajor.setUpdatedAt(Instant.now());\n\n        when(majorRepository.findById(majorId)).thenReturn(Optional.of(existingMajor));\n        when(majorRepository.existsByCodeAndIdNot(request.getCode(), majorId)).thenReturn(false);\n        when(majorRepository.existsByNameAndIdNot(request.getName(), majorId)).thenReturn(false);\n        when(majorRepository.countActiveSubjectsByMajorId(majorId)).thenReturn(5L); // Has active subjects\n        when(majorRepository.countActiveStudentsByMajorId(majorId)).thenReturn(0L); // No active students\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> majorService.update(majorId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot deactivate major. Found 5 active subjects and 0 enrolled students\");\n        verify(majorRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_06: Throw OperationNotAllowedException when deactivating major with active students\")\n    void update_DeactivateWithActiveStudents() {\n        Short majorId = (short) 1;\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Updated Computer Science\");\n        request.setCode(\"UCS\");\n        request.setActive(false); // Deactivating\n\n        Major existingMajor = new Major();\n        existingMajor.setId(majorId);\n        existingMajor.setName(\"Computer Science\");\n        existingMajor.setCode(\"CS\");\n        existingMajor.setActive(true); // Currently active\n        existingMajor.setCreatedAt(Instant.now());\n        existingMajor.setUpdatedAt(Instant.now());\n\n        when(majorRepository.findById(majorId)).thenReturn(Optional.of(existingMajor));\n        when(majorRepository.existsByCodeAndIdNot(request.getCode(), majorId)).thenReturn(false);\n        when(majorRepository.existsByNameAndIdNot(request.getName(), majorId)).thenReturn(false);\n        when(majorRepository.countActiveSubjectsByMajorId(majorId)).thenReturn(0L); // No active subjects\n        when(majorRepository.countActiveStudentsByMajorId(majorId)).thenReturn(10L); // Has active students\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> majorService.update(majorId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot deactivate major. Found 0 active subjects and 10 enrolled students\");\n        verify(majorRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_07: Update success - Deactivate major with no active dependencies\")\n    void update_Success_DeactivateWithNoActiveDependencies() {\n        Short majorId = (short) 1;\n\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n        request.setActive(false); // Deactivating\n\n        Major existingMajor = new Major();\n        existingMajor.setId(majorId);\n        existingMajor.setName(\"Computer Science\");\n        existingMajor.setCode(\"CS\");\n        existingMajor.setActive(true); // Currently active\n        existingMajor.setCreatedAt(Instant.now());\n        existingMajor.setUpdatedAt(Instant.now());\n\n        Major savedMajor = new Major();\n        savedMajor.setId(majorId);\n        savedMajor.setName(\"Computer Science\");\n        savedMajor.setCode(\"CS\");\n        savedMajor.setActive(false); // Now inactive\n        savedMajor.setCreatedAt(Instant.now());\n        savedMajor.setUpdatedAt(Instant.now());\n\n        MajorDTO expectedDTO = new MajorDTO(\n                majorId, \"Computer Science\", \"CS\",\n                false, Instant.now(), Instant.now(), 0L);\n\n        when(majorRepository.findById(majorId)).thenReturn(Optional.of(existingMajor));\n        when(majorRepository.countActiveSubjectsByMajorId(majorId)).thenReturn(0L); // No active subjects\n        when(majorRepository.countActiveStudentsByMajorId(majorId)).thenReturn(0L); // No active students\n        when(majorRepository.save(existingMajor)).thenReturn(savedMajor);\n        when(majorMapper.toDTO(savedMajor)).thenReturn(expectedDTO);\n\n        MajorDTO result = majorService.update(majorId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getActive()).isFalse();\n        verify(majorRepository).findById(majorId);\n        verify(majorRepository).countActiveSubjectsByMajorId(majorId);\n        verify(majorRepository).countActiveStudentsByMajorId(majorId);\n        verify(majorMapper).updateFromRequest(request, existingMajor);\n        verify(majorRepository).save(existingMajor);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_08: Update success - Activate major\")\n    void update_Success_ActivateMajor() {\n        Short majorId = (short) 1;\n\n        MajorUpdateRequest request = new MajorUpdateRequest();\n        request.setName(\"Computer Science\");\n        request.setCode(\"CS\");\n        request.setActive(true); // Activating\n\n        Major existingMajor = new Major();\n        existingMajor.setId(majorId);\n        existingMajor.setName(\"Computer Science\");\n        existingMajor.setCode(\"CS\");\n        existingMajor.setActive(false); // Currently inactive\n        existingMajor.setCreatedAt(Instant.now());\n        existingMajor.setUpdatedAt(Instant.now());\n\n        Major savedMajor = new Major();\n        savedMajor.setId(majorId);\n        savedMajor.setName(\"Computer Science\");\n        savedMajor.setCode(\"CS\");\n        savedMajor.setActive(true); // Now active\n        savedMajor.setCreatedAt(Instant.now());\n        savedMajor.setUpdatedAt(Instant.now());\n\n        MajorDTO expectedDTO = new MajorDTO(\n                majorId, \"Computer Science\", \"CS\",\n                true, Instant.now(), Instant.now(), 0L);\n\n        when(majorRepository.findById(majorId)).thenReturn(Optional.of(existingMajor));\n        when(majorRepository.save(existingMajor)).thenReturn(savedMajor);\n        when(majorMapper.toDTO(savedMajor)).thenReturn(expectedDTO);\n\n        MajorDTO result = majorService.update(majorId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getActive()).isTrue();\n        verify(majorRepository).findById(majorId);\n        verify(majorMapper).updateFromRequest(request, existingMajor);\n        verify(majorRepository).save(existingMajor);\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_01: Delete major successfully\")\n    void delete_Success() {\n        Short majorId = (short) 1;\n        when(majorRepository.existsById(majorId)).thenReturn(true);\n        when(majorRepository.countSubjectsByMajorId(majorId)).thenReturn(0L);\n        when(majorRepository.countStudentsByMajorId(majorId)).thenReturn(0L);\n        doNothing().when(majorRepository).deleteById(majorId);\n\n        majorService.delete(majorId);\n\n        verify(majorRepository).existsById(majorId);\n        verify(majorRepository).countSubjectsByMajorId(majorId);\n        verify(majorRepository).countStudentsByMajorId(majorId);\n        verify(majorRepository).deleteById(majorId);\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_02: Throw ResourceNotFoundException when ID not found\")\n    void delete_NotFound() {\n        Short majorId = 999;\n        when(majorRepository.existsById(majorId)).thenReturn(false);\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> majorService.delete(majorId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Major not found: \" + majorId);\n        verify(majorRepository).existsById(majorId);\n        verify(majorRepository, never()).deleteById(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_03: Throw OperationNotAllowedException when deleting major with subjects\")\n    void delete_MajorHasSubjects() {\n        Short majorId = (short) 1;\n        when(majorRepository.existsById(majorId)).thenReturn(true);\n        when(majorRepository.countSubjectsByMajorId(majorId)).thenReturn(3L);\n        when(majorRepository.countStudentsByMajorId(majorId)).thenReturn(0L);\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> majorService.delete(majorId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot delete major. Found 3 subjects and 0 students. Please reassign or delete them first\");\n        verify(majorRepository).existsById(majorId);\n        verify(majorRepository).countSubjectsByMajorId(majorId);\n        verify(majorRepository).countStudentsByMajorId(majorId);\n        verify(majorRepository, never()).deleteById(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_04: Throw OperationNotAllowedException when deleting major with students\")\n    void delete_MajorHasStudents() {\n        Short majorId = (short) 1;\n        when(majorRepository.existsById(majorId)).thenReturn(true);\n        when(majorRepository.countSubjectsByMajorId(majorId)).thenReturn(0L);\n        when(majorRepository.countStudentsByMajorId(majorId)).thenReturn(10L);\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> majorService.delete(majorId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot delete major. Found 0 subjects and 10 students. Please reassign or delete them first\");\n        verify(majorRepository).existsById(majorId);\n        verify(majorRepository).countSubjectsByMajorId(majorId);\n        verify(majorRepository).countStudentsByMajorId(majorId);\n        verify(majorRepository, never()).deleteById(any());\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\RoomServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/RoomServiceTest.java",
      "filename": "RoomServiceTest.java",
      "size_bytes": 27911,
      "lines": 665,
      "last_modified": "2025-10-29T20:56:54.629200",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.dto.mapper.RoomMapper;\nimport com.fuacs.backend.dto.mapper.SlotMapper;\nimport com.fuacs.backend.dto.request.RoomCreateRequest;\nimport com.fuacs.backend.dto.request.RoomSearchRequest;\nimport com.fuacs.backend.dto.request.RoomUpdateRequest;\nimport com.fuacs.backend.dto.response.RoomDTO;\nimport com.fuacs.backend.entity.Room;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.RoomRepository;\nimport com.fuacs.backend.repository.SlotRepository;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\nimport org.springframework.dao.DataIntegrityViolationException;\nimport org.springframework.data.domain.PageRequest;\n\nimport java.time.Instant;\nimport java.time.LocalDate;\nimport java.time.LocalDateTime;\nimport java.util.List;\nimport java.util.Optional;\n\nimport static org.assertj.core.api.Assertions.assertThat;\nimport static org.junit.jupiter.api.Assertions.assertThrows;\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.Mockito.doNothing;\nimport static org.mockito.Mockito.doThrow;\nimport static org.mockito.Mockito.never;\nimport static org.mockito.Mockito.verify;\nimport static org.mockito.Mockito.when;\n\n@ExtendWith(MockitoExtension.class)\nclass RoomServiceTest {\n\n    @Mock\n    private RoomRepository roomRepository;\n\n    @Mock\n    private RoomMapper roomMapper;\n\n    @Mock\n    private SlotRepository slotRepository;\n\n    @Mock\n    private SlotMapper slotMapper;\n\n    @InjectMocks\n    private RoomService roomService;\n\n    @Test\n    @DisplayName(\"TC_RS_01: Search successfully with valid request\")\n    void search_Success() {\n        RoomSearchRequest request = new RoomSearchRequest(null, null, null, null, null, null, null, null);\n        request.setSearch(\"Room\");\n\n        List<RoomDTO> expectedRooms = List.of(\n                new RoomDTO((short) 1, \"Room A\", \"Building 1\", 0L, Instant.now(),true,Instant.now(), Instant.now())\n        );\n\n        when(roomRepository.search(any(RoomSearchRequest.class))).thenReturn(expectedRooms);\n\n        List<RoomDTO> result = roomService.search(request);\n\n        assertThat(result).isEqualTo(expectedRooms);\n        verify(roomRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_RS_02: Search with empty result\")\n    void search_EmptyResult() {\n        RoomSearchRequest request = new RoomSearchRequest(null, null, null, null, null, null, null, null);\n        request.setSearch(\"NonExistent\");\n\n        List<RoomDTO> expectedRooms = List.of();\n\n        when(roomRepository.search(any(RoomSearchRequest.class))).thenReturn(expectedRooms);\n\n        List<RoomDTO> result = roomService.search(request);\n\n        assertThat(result).isEmpty();\n        verify(roomRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CO_01: Count successfully with valid request\")\n    void count_Success() {\n        RoomSearchRequest request = new RoomSearchRequest(null, null, null, null, null, null, null, null);\n        request.setSearch(\"Room\");\n\n        Long expectedCount = 5L;\n\n        when(roomRepository.count(any(RoomSearchRequest.class))).thenReturn(expectedCount);\n\n        Long result = roomService.count(request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(roomRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CO_02: Count with empty result\")\n    void count_EmptyResult() {\n        RoomSearchRequest request = new RoomSearchRequest(null, null, null, null, null, null, null, null);\n        request.setSearch(\"NonExistent\");\n\n        Long expectedCount = 0L;\n\n        when(roomRepository.count(any(RoomSearchRequest.class))).thenReturn(expectedCount);\n\n        Long result = roomService.count(request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(roomRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_RSBS_01: Search by staff ID successfully\")\n    void searchByStaffId_Success() {\n        Integer staffId = 1;\n        RoomSearchRequest request = new RoomSearchRequest(null, null, null, null, null, null, null, null);\n\n        List<RoomDTO> expectedRooms = List.of(\n                new RoomDTO((short) 1, \"Room A\", \"Building 1\", 0L, Instant.now(),true,Instant.now(), Instant.now())\n        );\n\n        when(roomRepository.searchByStaffId(staffId, request)).thenReturn(expectedRooms);\n        when(slotRepository.findByStaff_IdAndRoom_IdAndStartTimeAfterOrderByStartTimeAsc(\n                any(Integer.class), any(Short.class), any(LocalDateTime.class), any(PageRequest.class)))\n                .thenReturn(List.of());\n\n        List<RoomDTO> result = roomService.searchByStaffId(staffId, request);\n\n        assertThat(result).isNotEmpty();\n        verify(roomRepository).searchByStaffId(staffId, request);\n    }\n\n    @Test\n    @DisplayName(\"TC_RSBS_02: Search by staff ID with date range\")\n    void searchByStaffId_WithDateRange() {\n        Integer staffId = 1;\n        RoomSearchRequest request = new RoomSearchRequest(null, null, null, null, null, null, null, null);        request.setStartDate(\"2024-09-01\");\n        request.setEndDate(\"2024-12-31\");\n\n        List<RoomDTO> expectedRooms = List.of(\n                new RoomDTO((short) 1, \"Room A\", \"Building 1\", 0L, Instant.now(),true,Instant.now(), Instant.now())\n        );\n\n        LocalDate start = LocalDate.parse(\"2024-09-01\");\n        LocalDate end = LocalDate.parse(\"2024-12-31\");\n\n        when(roomRepository.searchByStaffIdWithDateRange(staffId, request, start, end))\n                .thenReturn(expectedRooms);\n        when(slotRepository.findByStaff_IdAndRoom_IdAndStartTimeAfterOrderByStartTimeAsc(\n                any(Integer.class), any(Short.class), any(LocalDateTime.class), any(PageRequest.class)))\n                .thenReturn(List.of());\n\n        List<RoomDTO> result = roomService.searchByStaffId(staffId, request);\n\n        assertThat(result).isNotEmpty();\n        verify(roomRepository).searchByStaffIdWithDateRange(staffId, request, start, end);\n    }\n\n    @Test\n    @DisplayName(\"TC_RCBS_01: Count by staff ID successfully\")\n    void countByStaffId_Success() {\n        Integer staffId = 1;\n        RoomSearchRequest request = new RoomSearchRequest(null, null, null, null, null, null, null, null);\n        Long expectedCount = 3L;\n\n        when(roomRepository.countByStaffId(staffId, request)).thenReturn(expectedCount);\n\n        Long result = roomService.countByStaffId(staffId, request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(roomRepository).countByStaffId(staffId, request);\n    }\n\n    @Test\n    @DisplayName(\"TC_RCBS_02: Count by staff ID with date range\")\n    void countByStaffId_WithDateRange() {\n        Integer staffId = 1;\n        RoomSearchRequest request = new RoomSearchRequest(null, null, null, null, null, null, null, null);        request.setStartDate(\"2024-09-01\");\n        request.setEndDate(\"2024-12-31\");\n\n        LocalDate start = LocalDate.parse(\"2024-09-01\");\n        LocalDate end = LocalDate.parse(\"2024-12-31\");\n        Long expectedCount = 2L;\n\n        when(roomRepository.countByStaffIdWithDateRange(staffId, request, start, end))\n                .thenReturn(expectedCount);\n\n        Long result = roomService.countByStaffId(staffId, request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(roomRepository).countByStaffIdWithDateRange(staffId, request, start, end);\n    }\n\n    @Test\n    @DisplayName(\"TC_FI_01: Find by ID successfully\")\n    void findById_Success() {\n        Short roomId = (short) 1;\n        Room room = new Room();\n        room.setId(roomId);\n        room.setName(\"Room A\");\n        room.setLocation(\"Building 1\");\n        room.setActive(true);\n        room.setCreatedAt(Instant.now());\n        room.setUpdatedAt(Instant.now());\n\n        RoomDTO expectedDTO = new RoomDTO((short) 1, \"Room A\", \"Building 1\", 0L, Instant.now(),true,Instant.now(), Instant.now());\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(room));\n        when(roomMapper.toDTO(room)).thenReturn(expectedDTO);\n        when(roomRepository.countAllCamerasByRoomId(roomId)).thenReturn(10L);\n        when(roomRepository.countActiveCamerasByRoomId(roomId)).thenReturn(8L);\n\n        RoomDTO result = roomService.findById(roomId);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getTotalCameras()).isEqualTo(10);\n        assertThat(result.getActiveCameras()).isEqualTo(8);\n        verify(roomRepository).findById(roomId);\n        verify(roomMapper).toDTO(room);\n    }\n\n    @Test\n    @DisplayName(\"TC_FI_02: Throw ResourceNotFoundException when ID not found\")\n    void findById_NotFound() {\n        Short roomId = 999;\n        when(roomRepository.findById(roomId)).thenReturn(Optional.empty());\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> roomService.findById(roomId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Room not found: \" + roomId);\n        verify(roomRepository).findById(roomId);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_01: Create room successfully\")\n    void create_Success() {\n        RoomCreateRequest request = new RoomCreateRequest();\n        request.setName(\"Room A\");\n        request.setLocation(\"Building 1\");\n\n        Room room = new Room();\n        room.setId((short) 1);\n        room.setName(\"Room A\");\n        room.setLocation(\"Building 1\");\n        room.setActive(true);\n        room.setCreatedAt(Instant.now());\n        room.setUpdatedAt(Instant.now());\n\n        RoomDTO expectedDTO = new RoomDTO((short) 1, \"Room A\", \"Building 1\", 0L, Instant.now(),true,Instant.now(), Instant.now());\n\n        when(roomRepository.existsByName(request.getName())).thenReturn(false);\n        when(roomMapper.toEntity(request)).thenReturn(room);\n        when(roomRepository.save(room)).thenReturn(room);\n        when(roomMapper.toDTO(room)).thenReturn(expectedDTO);\n\n        RoomDTO actual = roomService.create(request);\n\n        assertThat(actual).isNotNull();\n        assertThat(actual.getName()).isEqualTo(\"Room A\");\n        verify(roomRepository).existsByName(request.getName());\n        verify(roomMapper).toEntity(request);\n        verify(roomRepository).save(room);\n        verify(roomMapper).toDTO(room);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_02: Throw ResourceExistsException when name exists\")\n    void create_NameExists() {\n        RoomCreateRequest request = new RoomCreateRequest();\n        request.setName(\"Room A\");\n        request.setLocation(\"Building 1\");\n\n        when(roomRepository.existsByName(request.getName())).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> roomService.create(request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Room name exists: \" + request.getName());\n        verify(roomRepository).existsByName(request.getName());\n        verify(roomRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_01: Update room successfully\")\n    void update_Success() {\n        Short roomId = (short) 1;\n        RoomUpdateRequest request = new RoomUpdateRequest();\n        request.setName(\"Updated Room A\");\n        request.setLocation(\"Building 2\");\n        request.setActive(true);\n\n        Room existingRoom = new Room();\n        existingRoom.setId(roomId);\n        existingRoom.setName(\"Room A\");\n        existingRoom.setLocation(\"Building 1\");\n        existingRoom.setActive(true);\n        existingRoom.setCreatedAt(Instant.now());\n        existingRoom.setUpdatedAt(Instant.now());\n\n        Room savedRoom = new Room();\n        savedRoom.setId(roomId);\n        savedRoom.setName(\"Updated Room A\");\n        savedRoom.setLocation(\"Building 2\");\n        savedRoom.setActive(true);\n        savedRoom.setCreatedAt(Instant.now());\n        savedRoom.setUpdatedAt(Instant.now());\n\n        RoomDTO expectedDTO = new RoomDTO(roomId, \"Updated Room A\", \"Building 2\", 60L, Instant.now(), true,Instant.now(), Instant.now());\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(existingRoom));\n        when(roomRepository.existsByNameAndIdNot(request.getName(), roomId)).thenReturn(false);\n        when(roomRepository.save(existingRoom)).thenReturn(savedRoom);\n        when(roomMapper.toDTO(savedRoom)).thenReturn(expectedDTO);\n\n        RoomDTO result = roomService.update(roomId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getName()).isEqualTo(\"Updated Room A\");\n        verify(roomRepository).findById(roomId);\n        verify(roomMapper).updateRoomFromRequest(request, existingRoom);\n        verify(roomRepository).save(existingRoom);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_02: Throw ResourceNotFoundException when updating non-existent room\")\n    void update_RoomNotFound() {\n        Short roomId = 999;\n        RoomUpdateRequest request = new RoomUpdateRequest();\n        request.setName(\"Updated Room\");\n        request.setLocation(\"Building 1\");\n        request.setActive(true);\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.empty());\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> roomService.update(roomId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Room not found: \" + roomId);\n        verify(roomRepository).findById(roomId);\n        verify(roomRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_03: Throw ResourceExistsException when name exists\")\n    void update_NameExists() {\n        Short roomId = (short) 1;\n        RoomUpdateRequest request = new RoomUpdateRequest();\n        request.setName(\"Existing Room Name\");\n        request.setLocation(\"Building 1\");\n        request.setActive(true);\n\n        Room existingRoom = new Room();\n        existingRoom.setId(roomId);\n        existingRoom.setName(\"Room A\");\n        existingRoom.setLocation(\"Building 1\");\n        existingRoom.setActive(true);\n        existingRoom.setCreatedAt(Instant.now());\n        existingRoom.setUpdatedAt(Instant.now());\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(existingRoom));\n        when(roomRepository.existsByNameAndIdNot(request.getName(), roomId)).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> roomService.update(roomId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Room name already exists: \" + request.getName());\n        verify(roomRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_04: Throw OperationNotAllowedException when deactivating room with active cameras\")\n    void update_DeactivateWithActiveCameras() {\n        Short roomId = (short) 1;\n        RoomUpdateRequest request = new RoomUpdateRequest();\n        request.setName(\"Room A\");\n        request.setLocation(\"Building 1\");\n        request.setActive(false); // Deactivating\n\n        Room existingRoom = new Room();\n        existingRoom.setId(roomId);\n        existingRoom.setName(\"Room A\");\n        existingRoom.setLocation(\"Building 1\");\n        existingRoom.setActive(true); // Currently active\n        existingRoom.setCreatedAt(Instant.now());\n        existingRoom.setUpdatedAt(Instant.now());\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(existingRoom));\n        when(roomRepository.countActiveCamerasByRoomId(roomId)).thenReturn(5L); // Has active cameras\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> roomService.update(roomId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot deactivate room with 5 active cameras\");\n        verify(roomRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_05: Throw OperationNotAllowedException when deactivating room with active slots\")\n    void update_DeactivateWithActiveSlots() {\n        Short roomId = (short) 1;\n        RoomUpdateRequest request = new RoomUpdateRequest();\n        request.setName(\"Room A\");\n        request.setLocation(\"Building 1\");\n        request.setActive(false); // Deactivating\n\n        Room existingRoom = new Room();\n        existingRoom.setId(roomId);\n        existingRoom.setName(\"Room A\");\n        existingRoom.setLocation(\"Building 1\");\n        existingRoom.setActive(true); // Currently active\n        existingRoom.setCreatedAt(Instant.now());\n        existingRoom.setUpdatedAt(Instant.now());\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(existingRoom));\n        when(roomRepository.countActiveCamerasByRoomId(roomId)).thenReturn(0L); // No active cameras\n        when(roomRepository.countActiveSlotsByRoomId(any(Short.class), any(LocalDateTime.class))).thenReturn(3L); // Has active slots\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> roomService.update(roomId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot deactivate room with ongoing or future slots\");\n        verify(roomRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_06: Update success - Deactivate room with no active cameras or slots\")\n    void update_Success_DeactivateWithNoActiveCamerasOrSlots() {\n        Short roomId = (short) 1;\n        RoomUpdateRequest request = new RoomUpdateRequest();\n        request.setName(\"Room A\");\n        request.setLocation(\"Building 1\");\n        request.setActive(false); // Deactivating\n\n        Room existingRoom = new Room();\n        existingRoom.setId(roomId);\n        existingRoom.setName(\"Room A\");\n        existingRoom.setLocation(\"Building 1\");\n        existingRoom.setActive(true); // Currently active\n        existingRoom.setCreatedAt(Instant.now());\n        existingRoom.setUpdatedAt(Instant.now());\n\n        Room savedRoom = new Room();\n        savedRoom.setId(roomId);\n        savedRoom.setName(\"Room A\");\n        savedRoom.setLocation(\"Building 1\");\n        savedRoom.setActive(false);\n        savedRoom.setCreatedAt(Instant.now());\n        savedRoom.setUpdatedAt(Instant.now());\n\n        RoomDTO expectedDTO = new RoomDTO(roomId, \"Room A\", \"Building 1\", 50L,  Instant.now(),false,Instant.now(), Instant.now());\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(existingRoom));\n        when(roomRepository.countActiveCamerasByRoomId(roomId)).thenReturn(0L); // No active cameras\n        when(roomRepository.countActiveSlotsByRoomId(any(Short.class), any(LocalDateTime.class))).thenReturn(0L); // No active slots\n        when(roomRepository.save(existingRoom)).thenReturn(savedRoom);\n        when(roomMapper.toDTO(savedRoom)).thenReturn(expectedDTO);\n        doNothing().when(roomMapper).updateRoomFromRequest(request, existingRoom);\n\n        RoomDTO result = roomService.update(roomId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getActive()).isFalse();\n        verify(roomRepository).findById(roomId);\n        verify(roomRepository).countActiveCamerasByRoomId(roomId);\n        verify(roomRepository).countActiveSlotsByRoomId(any(Short.class), any(LocalDateTime.class));\n        verify(roomRepository).save(existingRoom);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_07: Update success - Activate room\")\n    void update_Success_ActivateRoom() {\n        Short roomId = (short) 1;\n        RoomUpdateRequest request = new RoomUpdateRequest();\n        request.setName(\"Room A\");\n        request.setLocation(\"Building 1\");\n        request.setActive(true); // Activating\n\n        Room existingRoom = new Room();\n        existingRoom.setId(roomId);\n        existingRoom.setName(\"Room A\");\n        existingRoom.setLocation(\"Building 1\");\n        existingRoom.setActive(false); // Currently inactive\n        existingRoom.setCreatedAt(Instant.now());\n        existingRoom.setUpdatedAt(Instant.now());\n\n        Room savedRoom = new Room();\n        savedRoom.setId(roomId);\n        savedRoom.setName(\"Room A\");\n        savedRoom.setLocation(\"Building 1\");\n        savedRoom.setActive(true);\n        savedRoom.setCreatedAt(Instant.now());\n        savedRoom.setUpdatedAt(Instant.now());\n\n        RoomDTO expectedDTO = new RoomDTO(roomId, \"Room A\", \"Building 1\", 50L, Instant.now(), true, Instant.now(), Instant.now());\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(existingRoom));\n        when(roomRepository.save(existingRoom)).thenReturn(savedRoom);\n        when(roomMapper.toDTO(savedRoom)).thenReturn(expectedDTO);\n        doNothing().when(roomMapper).updateRoomFromRequest(request, existingRoom);\n\n        RoomDTO result = roomService.update(roomId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getActive()).isTrue();\n        verify(roomRepository).findById(roomId);\n        verify(roomRepository).save(existingRoom);\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_01: Delete room successfully\")\n    void delete_Success() {\n        Short roomId = (short) 1;\n        when(roomRepository.existsById(roomId)).thenReturn(true);\n        when(roomRepository.countAllCamerasByRoomId(roomId)).thenReturn(0L);\n        when(roomRepository.countFutureSlotsByRoomId(any(Short.class), any(LocalDateTime.class))).thenReturn(0L);\n        doNothing().when(roomRepository).deleteById(roomId);\n\n        roomService.delete(roomId);\n\n        verify(roomRepository).existsById(roomId);\n        verify(roomRepository).countAllCamerasByRoomId(roomId);\n        verify(roomRepository).countFutureSlotsByRoomId(any(Short.class), any(LocalDateTime.class));\n        verify(roomRepository).deleteById(roomId);\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_02: Throw ResourceNotFoundException when ID not found\")\n    void delete_NotFound() {\n        Short roomId = 999;\n        when(roomRepository.existsById(roomId)).thenReturn(false);\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> roomService.delete(roomId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Room not found: \" + roomId);\n        verify(roomRepository).existsById(roomId);\n        verify(roomRepository, never()).deleteById(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_03: Throw OperationNotAllowedException when deleting room with cameras\")\n    void delete_RoomHasCameras() {\n        Short roomId = (short) 1;\n        when(roomRepository.existsById(roomId)).thenReturn(true);\n        when(roomRepository.countAllCamerasByRoomId(roomId)).thenReturn(3L);\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> roomService.delete(roomId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot delete room with cameras. Remove cameras first\");\n        verify(roomRepository).existsById(roomId);\n        verify(roomRepository).countAllCamerasByRoomId(roomId);\n        verify(roomRepository, never()).deleteById(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_04: Throw OperationNotAllowedException when deleting room with scheduled slots\")\n    void delete_RoomHasScheduledSlots() {\n        Short roomId = (short) 1;\n        when(roomRepository.existsById(roomId)).thenReturn(true);\n        when(roomRepository.countAllCamerasByRoomId(roomId)).thenReturn(0L);\n        when(roomRepository.countFutureSlotsByRoomId(any(Short.class), any(LocalDateTime.class))).thenReturn(2L);\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> roomService.delete(roomId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot delete room with scheduled slots\");\n        verify(roomRepository).existsById(roomId);\n        verify(roomRepository).countAllCamerasByRoomId(roomId);\n        verify(roomRepository).countFutureSlotsByRoomId(any(Short.class), any(LocalDateTime.class));\n        verify(roomRepository, never()).deleteById(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_05: Throw OperationNotAllowedException when room has dependencies\")\n    void delete_HasDependencies() {\n        Short roomId = (short) 1;\n        when(roomRepository.existsById(roomId)).thenReturn(true);\n        when(roomRepository.countAllCamerasByRoomId(roomId)).thenReturn(0L);\n        when(roomRepository.countFutureSlotsByRoomId(any(Short.class), any(LocalDateTime.class))).thenReturn(0L);\n\n        DataIntegrityViolationException exception = new DataIntegrityViolationException(\"Foreign key constraint violation\");\n        doThrow(exception).when(roomRepository).deleteById(roomId);\n\n        OperationNotAllowedException thrownException = assertThrows(\n                OperationNotAllowedException.class,\n                () -> roomService.delete(roomId)\n        );\n\n        assertThat(thrownException.getMessage()).contains(\"Cannot delete room. It is currently in use by other records.\");\n        verify(roomRepository).existsById(roomId);\n        verify(roomRepository).deleteById(roomId);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_08: Update room with same name (no change)\")\n    void update_SameNameNoChange() {\n        Short roomId = (short) 1;\n        RoomUpdateRequest request = new RoomUpdateRequest();\n        request.setName(\"Room A\"); // Same name\n        request.setLocation(\"Building 2\");\n        request.setActive(true);\n\n        Room existingRoom = new Room();\n        existingRoom.setId(roomId);\n        existingRoom.setName(\"Room A\"); // Same name\n        existingRoom.setLocation(\"Building 1\");\n        existingRoom.setActive(true);\n        existingRoom.setCreatedAt(Instant.now());\n        existingRoom.setUpdatedAt(Instant.now());\n\n        Room savedRoom = new Room();\n        savedRoom.setId(roomId);\n        savedRoom.setName(\"Room A\");\n        savedRoom.setLocation(\"Building 2\");\n        savedRoom.setActive(true);\n        savedRoom.setCreatedAt(Instant.now());\n        savedRoom.setUpdatedAt(Instant.now());\n\n        RoomDTO expectedDTO = new RoomDTO(roomId, \"Room A\", \"Building 2\", 60L, Instant.now(), true, Instant.now(), Instant.now());\n\n        when(roomRepository.findById(roomId)).thenReturn(Optional.of(existingRoom));\n        when(roomRepository.save(existingRoom)).thenReturn(savedRoom);\n        when(roomMapper.toDTO(savedRoom)).thenReturn(expectedDTO);\n        doNothing().when(roomMapper).updateRoomFromRequest(request, existingRoom);\n\n        RoomDTO result = roomService.update(roomId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getLocation()).isEqualTo(\"Building 2\");\n        verify(roomRepository).findById(roomId);\n        verify(roomRepository, never()).existsByNameAndIdNot(any(), any());\n        verify(roomRepository).save(existingRoom);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\SemesterServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/SemesterServiceTest.java",
      "filename": "SemesterServiceTest.java",
      "size_bytes": 56034,
      "lines": 1300,
      "last_modified": "2025-10-29T20:56:54.630197",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.mapper.SemesterMapper;\nimport com.fuacs.backend.dto.request.SemesterCreateRequest;\nimport com.fuacs.backend.dto.request.SemesterSearchRequest;\nimport com.fuacs.backend.dto.request.SemesterUpdateRequest;\nimport com.fuacs.backend.dto.response.SemesterDTO;\nimport com.fuacs.backend.entity.AcademicClass;\nimport com.fuacs.backend.entity.Semester;\nimport com.fuacs.backend.exception.InvalidDateException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.SemesterRepository;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.junit.jupiter.MockitoExtension;\n\nimport java.time.Instant;\nimport java.time.LocalDate;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Optional;\nimport java.util.Set;\n\nimport static org.assertj.core.api.Assertions.assertThat;\nimport static org.junit.jupiter.api.Assertions.assertThrows;\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.anyShort;\nimport static org.mockito.ArgumentMatchers.anyString;\nimport static org.mockito.Mockito.doNothing;\nimport static org.mockito.Mockito.never;\nimport static org.mockito.Mockito.verify;\nimport static org.mockito.Mockito.when;\n\n@ExtendWith(MockitoExtension.class)\nclass SemesterServiceTest {\n\n    @Mock\n    private SemesterRepository semesterRepository;\n\n    @Mock\n    private SemesterMapper semesterMapper;\n\n    @InjectMocks\n    private SemesterService semesterService;\n\n    @Test\n    @DisplayName(\"TC_SS_01: Search successfully with valid request\")\n    void search_Success() {\n        SemesterSearchRequest request =\n                new SemesterSearchRequest(1, 10, \"asc\", \"name\", true, \"Fall\");\n\n        List<SemesterDTO> expectedSemesters = List.of(new SemesterDTO(\n                (short) 1, \"Fall 2024\", \"FA2024\",\n                LocalDate.of(2024, 9, 1),\n                LocalDate.of(2024, 12, 31),\n                5L, true, Instant.now(), Instant.now()));\n\n        when(semesterRepository.search(any(SemesterSearchRequest.class))).thenReturn(expectedSemesters);\n\n        List<SemesterDTO> result = semesterService.search(request);\n\n        assertThat(result).isEqualTo(expectedSemesters);\n        verify(semesterRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_SS_02: Search with empty result\")\n    void search_EmptyResult() {\n        SemesterSearchRequest request =\n                new SemesterSearchRequest(1, 10, \"asc\", \"name\", true, \"NonExistent\");\n\n        List<SemesterDTO> expectedSemesters = List.of();\n\n        when(semesterRepository.search(any(SemesterSearchRequest.class))).thenReturn(expectedSemesters);\n\n        List<SemesterDTO> result = semesterService.search(request);\n\n        assertThat(result).isEmpty();\n        verify(semesterRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_FI_01: Find by ID successfully\")\n    void findById_Success() {\n        Short semesterId = (short) 1;\n        Semester semester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)),\n                (LocalDate.of(2024, 12, 31)),\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        SemesterDTO expectedDTO = new SemesterDTO(\n                (short) 1,\n                \"Fall 2024\",\n                \"FA2024\",\n                LocalDate.of(2024, 9, 1),\n                LocalDate.of(2024, 12, 31),\n                5L,\n                true,\n                Instant.now(),\n                Instant.now()\n        );\n        Set<AcademicClass> classes = new HashSet<>();\n        for (int i = 1; i <= 3; i++) {\n            AcademicClass academicClass = new AcademicClass();\n            academicClass.setActive(true);\n            academicClass.setCreatedAt(Instant.now());\n            academicClass.setUpdatedAt(Instant.now());\n            academicClass.setId((short) i);\n            academicClass.setCode(\"CLASS\" + i);\n            classes.add(academicClass);\n        }\n        semester.setAcademicClasses(classes);\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(semester));\n        when(semesterMapper.toDTO(semester)).thenReturn(expectedDTO);\n\n        SemesterDTO result = semesterService.findById(semesterId);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getTotalClass()).isEqualTo((short) 3);\n        verify(semesterRepository).findById(semesterId);\n        verify(semesterMapper).toDTO(semester);\n    }\n\n    @Test\n    @DisplayName(\"TC_FI_02: Throw ResourceNotFoundException when ID not found\")\n    void findById_NotFound() {\n        Short semesterId = 999;\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.empty());\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> semesterService.findById(semesterId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Semester not found: \" + semesterId);\n        verify(semesterRepository).findById(semesterId);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_01: Create semester successfully\")\n    void create_Success() {\n        short id = 1;\n        String name = \"Fall 2024\";\n        String code = \"FA24\";\n        LocalDate startDate = LocalDate.of(2024, 9, 1);\n        LocalDate endDate = LocalDate.of(2024, 12, 31);\n        boolean isActive = true;\n        Instant now = Instant.now();\n\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(name);\n        request.setCode(code);\n        request.setStartDate(startDate);\n        request.setEndDate(endDate);\n\n        Semester savedSemester = new Semester(id, name, code, startDate, endDate, now, now, isActive);\n        SemesterDTO expectedDTO = new SemesterDTO(id, name, code, startDate, endDate, 0L, isActive, now, now);\n\n        when(semesterRepository.existsByCode(request.getCode())).thenReturn(false);\n        when(semesterRepository.existsByName(request.getName())).thenReturn(false);\n        when(semesterRepository.existsByStartDateAndEndDate(request.getStartDate(), request.getEndDate())).thenReturn(false);\n        when(semesterMapper.toEntity(request)).thenReturn(savedSemester);\n        when(semesterRepository.save(savedSemester)).thenReturn(savedSemester);\n        when(semesterMapper.toDTO(savedSemester)).thenReturn(expectedDTO);\n\n        SemesterDTO actual = semesterService.create(request);\n\n        assertThat(actual).isNotNull();\n        assertThat(actual).isEqualTo(expectedDTO);\n        assertThat(actual.getTotalClass()).isEqualTo((short) 0);\n        verify(semesterRepository).existsByCode(request.getCode());\n        verify(semesterRepository).existsByName(request.getName());\n        verify(semesterRepository).existsByStartDateAndEndDate(request.getStartDate(), request.getEndDate());\n        verify(semesterMapper).toEntity(request);\n        verify(semesterRepository).save(savedSemester);\n        verify(semesterMapper).toDTO(savedSemester);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_02: Throw InvalidDateException when start date >= end date\")\n    void create_InvalidDateRange() {\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n        request.setStartDate(LocalDate.of(2024, 12, 31));\n        request.setEndDate(LocalDate.of(2024, 9, 1));\n\n        InvalidDateException exception = assertThrows(InvalidDateException.class, () -> semesterService.create(request));\n\n        assertThat(exception.getMessage()).isEqualTo(\"Start date must be before end date\");\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_03: Throw ResourceExistsException when code exists\")\n    void create_CodeExists() {\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n\n        when(semesterRepository.existsByCode(request.getCode())).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(ResourceExistsException.class, () -> semesterService.create(request));\n\n        assertThat(exception.getMessage()).contains(\"Semester code exists: \" + request.getCode());\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_04: Create fail - Semester name already exists\")\n    void create_Fail_NameExists() {\n        // 1. Setup Request (hp l)\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n\n        // 2. Mocking Repository\n        // Gi lp check 'code' pass (false) v check 'name' fail (true)\n        when(semesterRepository.existsByCode(request.getCode())).thenReturn(false);\n        when(semesterRepository.existsByName(request.getName())).thenReturn(true);\n\n        // 3. Call Service & Assert Throws\n        ResourceExistsException exception = assertThrows(ResourceExistsException.class, () -> {\n            semesterService.create(request);\n        });\n\n        // 4. (Optional) Kim tra ni dung exception\n        assertThat(exception.getMessage()).isEqualTo(\"Semester name exists: \" + request.getName());\n        assertThat(exception.getErrorCode()).isEqualTo(ErrorCode.SEMESTER_NAME_EXISTS);\n\n        // 5. Verify\n        verify(semesterRepository).existsByCode(request.getCode()); //  gi\n        verify(semesterRepository).existsByName(request.getName()); //  gi\n        // m bo check sau v lnh save KHNG c gi\n        verify(semesterRepository, never()).existsByStartDateAndEndDate(any(LocalDate.class), any(LocalDate.class));\n        verify(semesterRepository, never()).save(any(Semester.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_05: Create fail - Date range already exists\")\n    void create_Fail_DateRangeExists() {\n        // 1. Setup Request (hp l)\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n\n        // 2. Mocking Repository\n        // Gi lp check 'code' v 'name' pass (false), 'date range' fail (true)\n        when(semesterRepository.existsByCode(request.getCode())).thenReturn(false);\n        when(semesterRepository.existsByName(request.getName())).thenReturn(false);\n        when(semesterRepository.existsByStartDateAndEndDate(request.getStartDate(), request.getEndDate())).thenReturn(true);\n\n        // 3. Call Service & Assert Throws\n        ResourceExistsException exception = assertThrows(ResourceExistsException.class, () -> {\n            semesterService.create(request);\n        });\n\n        // 4. (Optional) Kim tra ni dung exception\n        assertThat(exception.getMessage()).isEqualTo(\"A semester with this start and end date already exists\");\n        assertThat(exception.getErrorCode()).isEqualTo(ErrorCode.SEMESTER_DATE_RANGE_EXISTS);\n\n        // 5. Verify\n        verify(semesterRepository).existsByCode(request.getCode()); //  gi\n        verify(semesterRepository).existsByName(request.getName()); //  gi\n        verify(semesterRepository).existsByStartDateAndEndDate(request.getStartDate(), request.getEndDate()); //  gi\n        // m bo lnh save KHNG c gi\n        verify(semesterRepository, never()).save(any(Semester.class));\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_01: Update semester successfully\")\n    void update_Success() {\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        Semester existingSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)),\n                (LocalDate.of(2024, 12, 31)),\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        Semester savedSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)),\n                (LocalDate.of(2024, 12, 31)),\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n        SemesterDTO expectedDTO = new SemesterDTO(\n                (short) 1,\n                \"Fall 2024\",\n                \"FA2024\",\n                LocalDate.of(2024, 9, 1),\n                LocalDate.of(2024, 12, 31),\n                5L,\n                true,\n                Instant.now(),\n                Instant.now()\n        );\n        Set<AcademicClass> classes = new HashSet<>();\n        for (int i = 1; i <= 2; i++) {\n            AcademicClass academicClass = new AcademicClass();\n            academicClass.setActive(true);\n            academicClass.setCreatedAt(Instant.now());\n            academicClass.setUpdatedAt(Instant.now());\n            academicClass.setId((short) i);\n            academicClass.setCode(\"CLASS\" + i);\n            classes.add(academicClass);\n        }\n        savedSemester.setAcademicClasses(classes);\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n        when(semesterRepository.existsByCodeAndIdNot(request.getCode(), semesterId)).thenReturn(false);\n        when(semesterRepository.existsByNameAndIdNot(request.getName(), semesterId)).thenReturn(false);\n        when(semesterRepository.existsByStartDateAndEndDateAndIdNot(request.getStartDate(), request.getEndDate(), semesterId))\n                .thenReturn(false);\n        when(semesterRepository.save(existingSemester)).thenReturn(savedSemester);\n        when(semesterMapper.toDTO(savedSemester)).thenReturn(expectedDTO);\n\n        SemesterDTO result = semesterService.update(semesterId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getTotalClass()).isEqualTo((short) 5);\n        verify(semesterRepository).findById(semesterId);\n        verify(semesterMapper).updateSemesterFromRequest(request, existingSemester);\n        verify(semesterRepository).save(existingSemester);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_02: Throw ResourceNotFoundException when updating non-existent semester\")\n    void update_SemesterNotFound() {\n        Short semesterId = 999;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.empty());\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> semesterService.update(semesterId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Semester not found: \" + semesterId);\n        verify(semesterRepository).findById(semesterId);\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_03: Throw InvalidDateException when start date >= end date\")\n    void update_InvalidDateRange() {\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 12, 31));\n        request.setEndDate(LocalDate.of(2024, 9, 1));\n        request.setActive(true);\n\n        Semester existingSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)),\n                (LocalDate.of(2024, 12, 31)),\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n\n        InvalidDateException exception = assertThrows(\n                InvalidDateException.class,\n                () -> semesterService.update(semesterId, request)\n        );\n\n        assertThat(exception.getMessage()).isEqualTo(\"Start date must be before end date\");\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_04: Throw ResourceExistsException when code exists\")\n    void update_CodeExists() {\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"EXISTING_CODE\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        Semester existingSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)),\n                (LocalDate.of(2024, 12, 31)),\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n        when(semesterRepository.existsByCodeAndIdNot(request.getCode(), semesterId)).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> semesterService.update(semesterId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Semester code exists: \" + request.getCode());\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_05: Throw ResourceExistsException when name exists\")\n    void update_NameExists() {\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Existing Name\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        Semester existingSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)),\n                (LocalDate.of(2024, 12, 31)),\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n        when(semesterRepository.existsByCodeAndIdNot(request.getCode(), semesterId)).thenReturn(false);\n        when(semesterRepository.existsByNameAndIdNot(request.getName(), semesterId)).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> semesterService.update(semesterId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Semester name already exists: \" + request.getName());\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_06: Throw ResourceExistsException when date range exists\")\n    void update_DateRangeExists() {\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 10, 1));\n        request.setEndDate(LocalDate.of(2024, 11, 30));\n        request.setActive(true);\n\n        Semester existingSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)),\n                (LocalDate.of(2024, 12, 31)),\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n        when(semesterRepository.existsByCodeAndIdNot(request.getCode(), semesterId)).thenReturn(false);\n        when(semesterRepository.existsByNameAndIdNot(request.getName(), semesterId)).thenReturn(false);\n        when(semesterRepository.existsByStartDateAndEndDateAndIdNot(request.getStartDate(), request.getEndDate(), semesterId))\n                .thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> semesterService.update(semesterId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"A semester with this start and end date already exists\");\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_08: Update ongoing semester name and code only\")\n    void update_OngoingSemesterNameCodeOnly() {\n        Short semesterId = (short) 1;\n\n        // 1. To ngy thng cho k hc ang din ra\n        LocalDate today = LocalDate.now();\n        LocalDate existingStartDate = today.minusMonths(1);\n        LocalDate existingEndDate = today.plusMonths(2);\n        boolean existingActive = true;\n\n        // 2. Setup Entity (k hc ang tn ti trong DB)\n        Semester ongoingSemester = new Semester(\n                ((short) 1),\n                (\"Current Semester\"),\n                (\"CUR2024\"),\n                (existingStartDate),\n                (existingEndDate),\n                (existingActive),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        // 3. Setup Request (y l phn sa)\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Name\"); // <-- Thay i tn\n        request.setCode(\"UPD2024\");    // <-- Thay i code\n\n        // Gi nguyn ngy thng v trng thi active\n        request.setStartDate(existingStartDate); // <-- PHI GING HT\n        request.setEndDate(existingEndDate);     // <-- PHI GING HT\n        request.setActive(existingActive);       // <-- PHI GING HT\n\n        // 4. Setup cc i tng mock\n        Semester savedSemester = new Semester(\n                ((short) 1),\n                (\"Updated Name\"),\n                (\"UPD2024\"),\n                (existingStartDate),\n                (existingEndDate),\n                (existingActive),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        SemesterDTO expectedDTO = new SemesterDTO(\n                (short) 1,\n                \"Updated Name\",\n                \"UPD2024\",\n                existingStartDate,\n                existingEndDate,\n                0L,\n                existingActive,\n                Instant.now(),\n                Instant.now()\n        );\n\n        // 5. Mocking\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(ongoingSemester));\n        // (V tn v code thay i, chng ta cn mock cc check 'exists')\n        when(semesterRepository.existsByCodeAndIdNot(request.getCode(), semesterId)).thenReturn(false);\n        when(semesterRepository.existsByNameAndIdNot(request.getName(), semesterId)).thenReturn(false);\n\n        // (V ngy thng khng i, logic service s KHNG check 'existsByStartDate...')\n\n        when(semesterRepository.save(ongoingSemester)).thenReturn(savedSemester);\n        when(semesterMapper.toDTO(savedSemester)).thenReturn(expectedDTO);\n        doNothing().when(semesterMapper).updateSemesterFromRequest(request, ongoingSemester); // Mock hm update void\n\n        // 6. Call\n        SemesterDTO result = semesterService.update(semesterId, request);\n\n        // 7. Assertions\n        assertThat(result).isNotNull();\n        assertThat(result.getName()).isEqualTo(\"Updated Name\");\n        assertThat(result.getCode()).isEqualTo(\"UPD2024\");\n\n        // Verify\n        verify(semesterRepository).findById(semesterId);\n        verify(semesterRepository).existsByCodeAndIdNot(request.getCode(), semesterId);\n        verify(semesterRepository).existsByNameAndIdNot(request.getName(), semesterId);\n        // m bo service KHNG check date range\n        verify(semesterRepository, never()).existsByStartDateAndEndDateAndIdNot(any(), any(), any());\n        verify(semesterMapper).updateSemesterFromRequest(request, ongoingSemester);\n        verify(semesterRepository).save(ongoingSemester);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_09: Throw OperationNotAllowedException when deactivating semester with active classes\")\n    void update_DeactivateWithActiveClasses() {\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n        request.setActive(false); // Deactivating\n\n        Semester existingSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)),\n                (LocalDate.of(2024, 12, 31)),\n                (true), // Currently active\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n        when(semesterRepository.existsByCodeAndIdNot(request.getCode(), semesterId)).thenReturn(false);\n        when(semesterRepository.existsByNameAndIdNot(request.getName(), semesterId)).thenReturn(false);\n        when(semesterRepository.countActiveClassesBySemesterId(semesterId)).thenReturn(5L); // Has active classes\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> semesterService.update(semesterId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot deactivate semester with 5 active classes\");\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_10: Update semester with no academic classes\")\n    void update_NoAcademicClasses() {\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        Semester existingSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)),\n                (LocalDate.of(2024, 12, 31)),\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>()) // No academic classes\n        );\n\n        Semester savedSemester = new Semester(\n                ((short) 1),\n                (\"Updated Fall 2024\"),\n                (\"UPD2024\"),\n                (LocalDate.of(2024, 9, 15)),\n                (LocalDate.of(2024, 12, 15)),\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        SemesterDTO expectedDTO = new SemesterDTO(\n                (short) 1,\n                \"Updated Fall 2024\",\n                \"UPD2024\",\n                LocalDate.of(2024, 9, 15),\n                LocalDate.of(2024, 12, 15),\n                0L, // No classes\n                true,\n                Instant.now(),\n                Instant.now()\n        );\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n        when(semesterRepository.existsByCodeAndIdNot(request.getCode(), semesterId)).thenReturn(false);\n        when(semesterRepository.existsByNameAndIdNot(request.getName(), semesterId)).thenReturn(false);\n        when(semesterRepository.existsByStartDateAndEndDateAndIdNot(request.getStartDate(), request.getEndDate(), semesterId))\n                .thenReturn(false);\n        when(semesterRepository.save(existingSemester)).thenReturn(savedSemester);\n        when(semesterMapper.toDTO(savedSemester)).thenReturn(expectedDTO);\n\n        SemesterDTO result = semesterService.update(semesterId, request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getTotalClass()).isEqualTo((short) 0);\n        verify(semesterRepository).findById(semesterId);\n        verify(semesterMapper).updateSemesterFromRequest(request, existingSemester);\n        verify(semesterRepository).save(existingSemester);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_07: Throw OperationNotAllowedException when modifying ongoing semester dates\")\n    void update_OngoingSemesterDateModification() {\n        Short semesterId = (short) 1;\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Updated Fall 2024\");\n        request.setCode(\"UPD2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 15));\n        request.setEndDate(LocalDate.of(2024, 12, 15));\n        request.setActive(true);\n\n        LocalDate today = LocalDate.now();\n        Semester ongoingSemester = new Semester(\n                ((short) 2),\n                (\"Current Semester\"),\n                (\"CUR2024\"),\n                (today.minusMonths(1)),\n                (today.plusMonths(2)),\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(ongoingSemester));\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> semesterService.update(semesterId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot modify dates or active status of an ongoing semester\");\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_11: Update success - Deactivate semester with no active classes\")\n    void update_Success_DeactivateWithNoActiveClasses() {\n        Short semesterId = (short) 1;\n\n        // 1. Setup Request (Ch thay i 'active' thnh false)\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Fall 2024\");     // <-- Gi nguyn\n        request.setCode(\"FA2024\");        // <-- Gi nguyn\n        request.setStartDate(LocalDate.of(2024, 9, 1)); // <-- Gi nguyn\n        request.setEndDate(LocalDate.of(2024, 12, 31)); // <-- Gi nguyn\n        request.setActive(false);         // <-- Thay i (true -> false)\n\n        // 2. Setup Entity ( ht hn, active = true)\n        Semester existingSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)), // Ngy trong qu kh\n                (LocalDate.of(2024, 12, 31)),// Ngy trong qu kh\n                (true), // ang active\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        // 3. Setup Mock\n        // (savedSemester v expectedDTO tng t, nhng vi active=false)\n        Semester savedSemester = new Semester(\n                ((short) 1), (\"Fall 2024\"), (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)), (LocalDate.of(2024, 12, 31)),\n                (false), (Instant.now()), (Instant.now()), (new HashSet<>())\n        );\n        SemesterDTO expectedDTO = new SemesterDTO(\n                (short) 1, \"Fall 2024\", \"FA2024\",\n                LocalDate.of(2024, 9, 1), LocalDate.of(2024, 12, 31),\n                0L, false, Instant.now(), Instant.now()\n        );\n\n        // 4. Mocking\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n\n        // Check deactivation: 'if (existing.getActive() && !request.getActive())' -> true\n        // Mock check active classes\n        when(semesterRepository.countActiveClassesBySemesterId(semesterId)).thenReturn(0L); // <-- Khng c lp active\n\n        when(semesterRepository.save(existingSemester)).thenReturn(savedSemester);\n        when(semesterMapper.toDTO(savedSemester)).thenReturn(expectedDTO);\n        doNothing().when(semesterMapper).updateSemesterFromRequest(request, existingSemester);\n\n        // 5. Call\n        SemesterDTO result = semesterService.update(semesterId, request);\n\n        // 6. Assert & Verify\n        assertThat(result).isNotNull();\n        assertThat(result.getActive()).isFalse();\n\n        // Verify cc hm check KHNG c gi (v code, name, date ging nhau)\n        verify(semesterRepository, never()).existsByCodeAndIdNot(anyString(), anyShort());\n        verify(semesterRepository, never()).existsByNameAndIdNot(anyString(), anyShort());\n        verify(semesterRepository, never()).existsByStartDateAndEndDateAndIdNot(any(), any(), anyShort());\n\n        // Verify check deactivation C gi\n        verify(semesterRepository).countActiveClassesBySemesterId(semesterId);\n        verify(semesterRepository).save(existingSemester);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_12: Update success - Activate semester\")\n    void update_Success_ActivateSemester() {\n        Short semesterId = (short) 1;\n\n        // 1. Setup Request (Ch thay i 'active' thnh true)\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1));\n        request.setEndDate(LocalDate.of(2024, 12, 31));\n        request.setActive(true); // <-- Thay i (false -> true)\n\n        // 2. Setup Entity ( ht hn, active = false)\n        Semester existingSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)),\n                (LocalDate.of(2024, 12, 31)),\n                (false), // ang inactive\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        // ... (Setup savedSemester v expectedDTO vi active=true) ...\n        Semester savedSemester = new Semester(\n                ((short) 1), (\"Fall 2024\"), (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)), (LocalDate.of(2024, 12, 31)),\n                (true), (Instant.now()), (Instant.now()), (new HashSet<>())\n        );\n        SemesterDTO expectedDTO = new SemesterDTO(\n                (short) 1, \"Fall 2024\", \"FA2024\",\n                LocalDate.of(2024, 9, 1), LocalDate.of(2024, 12, 31),\n                0L, true, Instant.now(), Instant.now()\n        );\n\n        // 4. Mocking\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n        when(semesterRepository.save(existingSemester)).thenReturn(savedSemester);\n        when(semesterMapper.toDTO(savedSemester)).thenReturn(expectedDTO);\n        doNothing().when(semesterMapper).updateSemesterFromRequest(request, existingSemester);\n\n        // 5. Call\n        SemesterDTO result = semesterService.update(semesterId, request);\n\n        // 6. Assert & Verify\n        assertThat(result).isNotNull();\n        assertThat(result.getActive()).isTrue();\n\n        // Verify cc hm check KHNG c gi\n        verify(semesterRepository, never()).existsByCodeAndIdNot(anyString(), anyShort());\n        verify(semesterRepository, never()).existsByNameAndIdNot(anyString(), anyShort());\n        verify(semesterRepository, never()).existsByStartDateAndEndDateAndIdNot(any(), any(), anyShort());\n\n        // Verify check deactivation (count) KHNG c gi (v y l A-ctivate)\n        verify(semesterRepository, never()).countActiveClassesBySemesterId(anyShort());\n        verify(semesterRepository).save(existingSemester);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_13: Throw... when modifying ongoing semester END DATE only\")\n    void update_OngoingSemesterEndDateModification() {\n        Short semesterId = (short) 1;\n        LocalDate today = LocalDate.now();\n        LocalDate existingStartDate = today.minusMonths(1);\n\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Current Semester\");\n        request.setCode(\"CUR2024\");\n        request.setStartDate(existingStartDate); // <-- START DATE GING HT\n        request.setEndDate(today.plusMonths(3));  // <-- END DATE KHC\n        request.setActive(true);\n\n        Semester ongoingSemester = new Semester(\n                ((short) 1),\n                (\"Current Semester\"),\n                (\"CUR2024\"),\n                (existingStartDate),\n                (today.plusMonths(2)), // End date c\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(ongoingSemester));\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> semesterService.update(semesterId, request)\n        );\n\n        // Test ny s p JaCoCo chy !existing.getEndDate().equals(request.getEndDate())\n        assertThat(exception.getMessage()).contains(\"Cannot modify dates or active status of an ongoing semester\");\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_14: Update success - Modify future semester\")\n    void update_Success_FutureSemester() {\n        Short semesterId = (short) 1;\n        LocalDate today = LocalDate.now();\n        Instant now = Instant.now();\n\n        // D liu cho k hc\n        String oldName = \"Future Semester\";\n        String newName = \"Updated Future Semester\";\n        String code = \"FUT2025\";\n        LocalDate startDate = today.plusMonths(2);\n        LocalDate endDate = today.plusMonths(6);\n        boolean isActive = true;\n\n        // 1. Setup Request (thay i tn)\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(newName); // <-- Thay i\n        request.setCode(code);    // <-- Gi nguyn\n        request.setStartDate(startDate); // <-- Gi nguyn\n        request.setEndDate(endDate);     // <-- Gi nguyn\n        request.setActive(isActive);     // <-- Gi nguyn\n\n        // 2. Setup Entity (k hc trong tng lai)\n        Semester existingSemester = new Semester(\n                (short) 1,\n                (oldName), // <-- Tn c\n                (code),\n                (startDate),\n                (endDate),\n                (isActive),\n                (now),\n                (now),\n                (new HashSet<>())\n        );\n\n        // 3. Setup i tng tr v (sau khi save)\n        Semester savedSemester = new Semester(\n                (short) 1,\n                (newName), // <-- Tn mi\n                (code),\n                (startDate),\n                (endDate),\n                (isActive),\n                (now),\n                (now),\n                (new HashSet<>())\n        );\n\n        // 4. Setup DTO k vng (kt qu cui cng)\n        SemesterDTO expectedDTO = new SemesterDTO(\n                (short) 1,\n                newName,\n                code,\n                startDate,\n                endDate,\n                0L, // Gi s khng c lp no\n                isActive,\n                now,\n                now\n        );\n\n\n        // 5. Mocking\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n\n        // Logic 'isOngoing' s l 'false', nn b qua block if 'isOngoing'\n\n        // Check 'exists' (v tn thay i, code/date khng i)\n        when(semesterRepository.existsByNameAndIdNot(request.getName(), semesterId)).thenReturn(false);\n\n        // Mock cc hm mapper v save\n        doNothing().when(semesterMapper).updateSemesterFromRequest(request, existingSemester);\n        when(semesterRepository.save(existingSemester)).thenReturn(savedSemester);\n        when(semesterMapper.toDTO(savedSemester)).thenReturn(expectedDTO);\n\n        // 6. Call Service\n        SemesterDTO result = semesterService.update(semesterId, request);\n\n        // 7. Assertions\n        assertThat(result).isNotNull();\n        assertThat(result.getName()).isEqualTo(newName);\n        assertThat(result).isEqualTo(expectedDTO); // So snh ton b DTO\n\n        // 8. Verify\n        verify(semesterRepository).findById(semesterId);\n        // Verify check name C gi (v tn thay i)\n        verify(semesterRepository).existsByNameAndIdNot(request.getName(), semesterId);\n\n        // Verify cc check khc KHNG c gi\n        verify(semesterRepository, never()).existsByCodeAndIdNot(anyString(), anyShort());\n        verify(semesterRepository, never()).existsByStartDateAndEndDateAndIdNot(any(), any(), anyShort());\n        verify(semesterRepository, never()).countActiveClassesBySemesterId(anyShort()); // Khng phi 'deactivate'\n\n        // Verify lung thnh cng\n        verify(semesterMapper).updateSemesterFromRequest(request, existingSemester);\n        verify(semesterRepository).save(existingSemester);\n        verify(semesterMapper).toDTO(savedSemester);\n    }\n\n    @Test\n    @DisplayName(\"TC_UP_15: Throw... Date range exists (End date change only)\")\n    void update_DateRangeExists_EndDateOnly() {\n        Short semesterId = (short) 1;\n\n        // Request thay i MI end date\n        SemesterUpdateRequest request = new SemesterUpdateRequest();\n        request.setName(\"Fall 2024\");\n        request.setCode(\"FA2024\");\n        request.setStartDate(LocalDate.of(2024, 9, 1)); // <-- GING\n        request.setEndDate(LocalDate.of(2024, 12, 15)); // <-- KHC\n        request.setActive(true);\n\n        Semester existingSemester = new Semester(\n                ((short) 1),\n                (\"Fall 2024\"),\n                (\"FA2024\"),\n                (LocalDate.of(2024, 9, 1)), // <-- GING\n                (LocalDate.of(2024, 12, 31)),// <-- KHC\n                (true),\n                (Instant.now()),\n                (Instant.now()),\n                (new HashSet<>())\n        );\n\n        when(semesterRepository.findById(semesterId)).thenReturn(Optional.of(existingSemester));\n\n        // Cc check code/name s c b qua (v A=false)\n\n        // Check date range (A=false, B=true -> if = true)\n        // Mock 'exists' cho date range mi ny\n        when(semesterRepository.existsByStartDateAndEndDateAndIdNot(\n                request.getStartDate(), request.getEndDate(), semesterId))\n                .thenReturn(true); // <-- Trng lp\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> semesterService.update(semesterId, request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"A semester with this start and end date already exists\");\n        verify(semesterRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_01: Delete semester successfully\")\n    void delete_Success() {\n        Short semesterId = (short) 1;\n        when(semesterRepository.existsById(semesterId)).thenReturn(true);\n        doNothing().when(semesterRepository).deleteById(semesterId);\n\n        semesterService.delete(semesterId);\n\n        verify(semesterRepository).existsById(semesterId);\n        verify(semesterRepository).deleteById(semesterId);\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_02: Throw ResourceNotFoundException when ID not found\")\n    void delete_NotFound() {\n        Short semesterId = 999;\n        when(semesterRepository.existsById(semesterId)).thenReturn(false);\n\n        ResourceNotFoundException exception = assertThrows(\n                ResourceNotFoundException.class,\n                () -> semesterService.delete(semesterId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Semester not found: \" + semesterId);\n        verify(semesterRepository).existsById(semesterId);\n        verify(semesterRepository, never()).deleteById(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_SS_03: Search with null parameters\")\n    void search_NullParameters() {\n        SemesterSearchRequest request =\n                new SemesterSearchRequest(null, null, null, null, null, null);\n\n        List<SemesterDTO> expectedSemesters = List.of(new SemesterDTO(\n                (short) 1, \"Fall 2024\", \"FA2024\",\n                LocalDate.of(2024, 9, 1),\n                LocalDate.of(2024, 12, 31),\n                5L, true, Instant.now(), Instant.now()));\n\n        when(semesterRepository.search(any(SemesterSearchRequest.class))).thenReturn(expectedSemesters);\n\n        List<SemesterDTO> result = semesterService.search(request);\n\n        assertThat(result).isEqualTo(expectedSemesters);\n        verify(semesterRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_SS_04: Search with different sort options\")\n    void search_DifferentSortOptions() {\n        SemesterSearchRequest request =\n                new SemesterSearchRequest(1, 10, \"desc\", \"code\", false, \"Spring\");\n\n        List<SemesterDTO> expectedSemesters = List.of(new SemesterDTO(\n                (short) 2, \"Spring 2024\", \"SP2024\",\n                LocalDate.of(2024, 1, 1),\n                LocalDate.of(2024, 4, 30),\n                3L, true, Instant.now(), Instant.now()));\n\n        when(semesterRepository.search(any(SemesterSearchRequest.class))).thenReturn(expectedSemesters);\n\n        List<SemesterDTO> result = semesterService.search(request);\n\n        assertThat(result).isEqualTo(expectedSemesters);\n        verify(semesterRepository).search(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CO_01: Count successfully with valid request\")\n    void count_Success() {\n        SemesterSearchRequest request =\n                new SemesterSearchRequest(1, 10, \"asc\", \"name\", true, \"Fall\");\n\n        Long expectedCount = 5L;\n\n        when(semesterRepository.count(any(SemesterSearchRequest.class))).thenReturn(expectedCount);\n\n        Long result = semesterService.count(request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(semesterRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CO_02: Count with empty result\")\n    void count_EmptyResult() {\n        SemesterSearchRequest request =\n                new SemesterSearchRequest(1, 10, \"asc\", \"name\", true, \"NonExistent\");\n\n        Long expectedCount = 0L;\n\n        when(semesterRepository.count(any(SemesterSearchRequest.class))).thenReturn(expectedCount);\n\n        Long result = semesterService.count(request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(semesterRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_CO_03: Count with null request\")\n    void count_NullRequest() {\n        SemesterSearchRequest request =\n                new SemesterSearchRequest(null, null, null, null, null, null);\n\n        Long expectedCount = 10L;\n\n        when(semesterRepository.count(any(SemesterSearchRequest.class))).thenReturn(expectedCount);\n\n        Long result = semesterService.count(request);\n\n        assertThat(result).isEqualTo(expectedCount);\n        verify(semesterRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_03: Throw OperationNotAllowedException when deleting semester with active classes\")\n    void delete_SemesterHasActiveClass() {\n        Short semesterId = (short) 1;\n        when(semesterRepository.existsById(semesterId)).thenReturn(true);\n        when(semesterRepository.countActiveClassesBySemesterId(semesterId)).thenReturn(3L);\n\n        OperationNotAllowedException exception = assertThrows(\n                OperationNotAllowedException.class,\n                () -> semesterService.delete(semesterId)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot delete semester with 3 active classes. Deactivate classes first.\");\n        verify(semesterRepository).existsById(semesterId);\n        verify(semesterRepository, never()).deleteById(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_DE_04: Throw DataIntegrityViolationException when semester has dependencies\")\n    void delete_HasDependencies() {\n        Short semesterId = (short) 1;\n        when(semesterRepository.existsById(semesterId)).thenReturn(true);\n\n        // Mock deleteById to throw DataIntegrityViolationException\n        org.springframework.dao.DataIntegrityViolationException exception =\n                new org.springframework.dao.DataIntegrityViolationException(\"Foreign key constraint violation\");\n\n        org.mockito.Mockito.doThrow(exception).when(semesterRepository).deleteById(semesterId);\n\n        OperationNotAllowedException thrownException = assertThrows(\n                OperationNotAllowedException.class,\n                () -> semesterService.delete(semesterId)\n        );\n\n        assertThat(thrownException.getMessage()).contains(\"Delete all class associate with this semester first\");\n        verify(semesterRepository).existsById(semesterId);\n        verify(semesterRepository).deleteById(semesterId);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_06: Create semester with minimum valid data\")\n    void create_MinimumValidData() {\n        String name = \"S\";\n        String code = \"C\";\n        LocalDate startDate = LocalDate.of(2024, 1, 1);\n        LocalDate endDate = LocalDate.of(2024, 12, 31);\n        Instant now = Instant.now();\n\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(name);\n        request.setCode(code);\n        request.setStartDate(startDate);\n        request.setEndDate(endDate);\n\n        Semester savedSemester = new Semester((short) 1, name, code, startDate, endDate, now, now, true);\n        SemesterDTO expectedDTO = new SemesterDTO((short) 1, name, code, startDate, endDate, 0L, true, now, now);\n\n        when(semesterRepository.existsByCode(request.getCode())).thenReturn(false);\n        when(semesterRepository.existsByName(request.getName())).thenReturn(false);\n        when(semesterRepository.existsByStartDateAndEndDate(request.getStartDate(), request.getEndDate())).thenReturn(false);\n        when(semesterMapper.toEntity(request)).thenReturn(savedSemester);\n        when(semesterRepository.save(savedSemester)).thenReturn(savedSemester);\n        when(semesterMapper.toDTO(savedSemester)).thenReturn(expectedDTO);\n\n        SemesterDTO actual = semesterService.create(request);\n\n        assertThat(actual).isNotNull();\n        assertThat(actual.getName()).isEqualTo(name);\n        assertThat(actual.getCode()).isEqualTo(code);\n        assertThat(actual.getTotalClass()).isEqualTo((short) 0);\n        verify(semesterRepository).existsByCode(request.getCode());\n        verify(semesterRepository).existsByName(request.getName());\n        verify(semesterRepository).existsByStartDateAndEndDate(request.getStartDate(), request.getEndDate());\n        verify(semesterMapper).toEntity(request);\n        verify(semesterRepository).save(savedSemester);\n        verify(semesterMapper).toDTO(savedSemester);\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_07: Create semester with maximum valid data\")\n    void create_MaximumValidData() {\n        String name = \"A Very Long Semester Name That Is Exactly Twenty Chars\";\n        String code = \"MAX10CHAR\";\n        LocalDate startDate = LocalDate.of(2024, 1, 1);\n        LocalDate endDate = LocalDate.of(2024, 12, 31);\n        Instant now = Instant.now();\n\n        SemesterCreateRequest request = new SemesterCreateRequest();\n        request.setName(name);\n        request.setCode(code);\n        request.setStartDate(startDate);\n        request.setEndDate(endDate);\n\n        Semester savedSemester = new Semester((short) 1, name, code, startDate, endDate, now, now, true);\n        SemesterDTO expectedDTO = new SemesterDTO((short) 1, name, code, startDate, endDate, 0L, true, now, now);\n\n        when(semesterRepository.existsByCode(request.getCode())).thenReturn(false);\n        when(semesterRepository.existsByName(request.getName())).thenReturn(false);\n        when(semesterRepository.existsByStartDateAndEndDate(request.getStartDate(), request.getEndDate())).thenReturn(false);\n        when(semesterMapper.toEntity(request)).thenReturn(savedSemester);\n        when(semesterRepository.save(savedSemester)).thenReturn(savedSemester);\n        when(semesterMapper.toDTO(savedSemester)).thenReturn(expectedDTO);\n\n        SemesterDTO actual = semesterService.create(request);\n\n        assertThat(actual).isNotNull();\n        assertThat(actual.getName()).isEqualTo(name);\n        assertThat(actual.getCode()).isEqualTo(code);\n        assertThat(actual.getTotalClass()).isEqualTo((short) 0);\n        verify(semesterRepository).existsByCode(request.getCode());\n        verify(semesterRepository).existsByName(request.getName());\n        verify(semesterRepository).existsByStartDateAndEndDate(request.getStartDate(), request.getEndDate());\n        verify(semesterMapper).toEntity(request);\n        verify(semesterRepository).save(savedSemester);\n        verify(semesterMapper).toDTO(savedSemester);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\test\\java\\com\\fuacs\\backend\\service\\StaffProfileServiceTest.java",
      "relative_path": "src/test/java/com/fuacs/backend/service/StaffProfileServiceTest.java",
      "filename": "StaffProfileServiceTest.java",
      "size_bytes": 19226,
      "lines": 424,
      "last_modified": "2025-11-13T23:14:29.960034",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.service;\n\nimport com.fuacs.backend.config.UserAuthentication;\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.StaffProfileCreateRequest;\nimport com.fuacs.backend.dto.request.StaffProfileSearchRequest;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.StaffProfileDTO;\nimport com.fuacs.backend.entity.Role;\nimport com.fuacs.backend.entity.StaffProfile;\nimport com.fuacs.backend.entity.User;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceExistsException;\nimport com.fuacs.backend.repository.RoleRepository;\nimport com.fuacs.backend.repository.SlotRepository;\nimport com.fuacs.backend.repository.StaffProfileRepository;\nimport com.fuacs.backend.repository.UserRepository;\nimport com.fuacs.backend.util.SecurityUtil;\nimport org.junit.jupiter.api.DisplayName;\nimport org.junit.jupiter.api.Test;\nimport org.junit.jupiter.api.extension.ExtendWith;\nimport org.mockito.InjectMocks;\nimport org.mockito.Mock;\nimport org.mockito.MockedStatic;\nimport org.mockito.junit.jupiter.MockitoExtension;\nimport org.springframework.security.core.authority.SimpleGrantedAuthority;\nimport org.springframework.security.crypto.password.PasswordEncoder;\n\nimport java.time.Instant;\nimport java.util.HashSet;\nimport java.util.List;\nimport java.util.Optional;\nimport java.util.Set;\n\nimport static org.assertj.core.api.Assertions.assertThat;\nimport static org.junit.jupiter.api.Assertions.assertThrows;\nimport static org.mockito.ArgumentMatchers.any;\nimport static org.mockito.ArgumentMatchers.anyString;\nimport static org.mockito.ArgumentMatchers.eq;\nimport static org.mockito.Mockito.mockStatic;\nimport static org.mockito.Mockito.never;\nimport static org.mockito.Mockito.verify;\nimport static org.mockito.Mockito.when;\n@ExtendWith(MockitoExtension.class)\nclass StaffProfileServiceTest {\n\n    @Mock\n    private StaffProfileRepository staffProfileRepository;\n\n    @Mock\n    private UserRepository userRepository;\n\n    @Mock\n    private RoleRepository roleRepository;\n\n    @Mock\n    private PasswordEncoder passwordEncoder;\n\n    @Mock\n    private EmailService emailService;\n\n    @Mock\n    private SlotRepository slotRepository;\n\n    @InjectMocks\n    private StaffProfileService staffProfileService;\n\n    @Test\n    @DisplayName(\"TC_SS_01: Search successfully with valid request\")\n    void search_Success() {\n        StaffProfileSearchRequest request = new StaffProfileSearchRequest(\n                1, 10, \"asc\", \"fullName\", true, \"John\",\n                Set.of((short) 1, (short) 2), Set.of(\"STUDENT\"));\n\n        List<StaffProfileDTO> expectedStaff = List.of(new StaffProfileDTO(\n                1, \"John Doe\", \"john@example.com\", \"johndoe\", \"ST001\",\n                true, Instant.now(), Instant.now(), List.of(\"LECTURER\")));\n\n        when(staffProfileRepository.search(any(StaffProfileSearchRequest.class))).thenReturn(expectedStaff);\n        when(staffProfileRepository.count(any(StaffProfileSearchRequest.class))).thenReturn(5L);\n\n        PagingResponse<StaffProfileDTO> result = staffProfileService.search(request);\n\n        assertThat(result.getData()).isNotNull();\n        assertThat(result.getStatus()).isEqualTo(200);\n        verify(staffProfileRepository).search(request);\n        verify(staffProfileRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_SS_02: Search with empty result\")\n    void search_EmptyResult() {\n        StaffProfileSearchRequest request = new StaffProfileSearchRequest(\n                1, 10, \"asc\", \"fullName\", true, \"NonExistent\",\n                null, null);\n\n        List<StaffProfileDTO> expectedStaff = List.of();\n\n        when(staffProfileRepository.search(any(StaffProfileSearchRequest.class))).thenReturn(expectedStaff);\n        when(staffProfileRepository.count(any(StaffProfileSearchRequest.class))).thenReturn(0L);\n\n        PagingResponse<StaffProfileDTO> result = staffProfileService.search(request);\n\n        assertThat(result.getData()).isNotNull();\n        assertThat(result.getStatus()).isEqualTo(200);\n        verify(staffProfileRepository).search(request);\n        verify(staffProfileRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_SS_03: Search with null parameters\")\n    void search_NullParameters() {\n        StaffProfileSearchRequest request = new StaffProfileSearchRequest(\n                null, null, null, null, null, null, null, null);\n\n        List<StaffProfileDTO> expectedStaff = List.of(new StaffProfileDTO(\n                1, \"John Doe\", \"john@example.com\", \"johndoe\", \"ST001\",\n                true, Instant.now(), Instant.now(), List.of(\"LECTURER\")));\n\n        when(staffProfileRepository.search(any(StaffProfileSearchRequest.class))).thenReturn(expectedStaff);\n        when(staffProfileRepository.count(any(StaffProfileSearchRequest.class))).thenReturn(5L);\n\n        PagingResponse<StaffProfileDTO> result = staffProfileService.search(request);\n\n        assertThat(result.getData()).isNotNull();\n        assertThat(result.getStatus()).isEqualTo(200);\n        verify(staffProfileRepository).search(request);\n        verify(staffProfileRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_SS_04: Search with different sort options\")\n    void search_DifferentSortOptions() {\n        StaffProfileSearchRequest request = new StaffProfileSearchRequest(\n                1, 10, \"desc\", \"email\", false, \"example\",\n                null, null);\n\n        List<StaffProfileDTO> expectedStaff = List.of(new StaffProfileDTO(\n                2, \"Jane Smith\", \"jane@example.com\", \"janesmith\", \"ST002\",\n                false, Instant.now(), Instant.now(), List.of(\"SUPERVISOR\")));\n\n        when(staffProfileRepository.search(any(StaffProfileSearchRequest.class))).thenReturn(expectedStaff);\n        when(staffProfileRepository.count(any(StaffProfileSearchRequest.class))).thenReturn(3L);\n\n        PagingResponse<StaffProfileDTO> result = staffProfileService.search(request);\n\n        assertThat(result.getData()).isNotNull();\n        assertThat(result.getStatus()).isEqualTo(200);\n        verify(staffProfileRepository).search(request);\n        verify(staffProfileRepository).count(request);\n    }\n\n    @Test\n    @DisplayName(\"TC_SS_05: Search with roleIds and excludeRoles\")\n    void search_WithRoleFilters() {\n        StaffProfileSearchRequest request = new StaffProfileSearchRequest(\n                1, 10, \"asc\", \"fullName\", true, \"John\",\n                Set.of((short) 1), Set.of(\"STUDENT\"));\n\n        List<StaffProfileDTO> expectedStaff = List.of(new StaffProfileDTO(\n                1, \"John Doe\", \"john@example.com\", \"johndoe\", \"ST001\",\n                true, Instant.now(), Instant.now(), List.of(\"LECTURER\")));\n\n        when(staffProfileRepository.search(any(StaffProfileSearchRequest.class))).thenReturn(expectedStaff);\n        when(staffProfileRepository.count(any(StaffProfileSearchRequest.class))).thenReturn(5L);\n\n        PagingResponse<StaffProfileDTO> result = staffProfileService.search(request);\n\n        assertThat(result.getData()).isNotNull();\n        assertThat(result.getStatus()).isEqualTo(200);\n        verify(staffProfileRepository).search(request);\n        verify(staffProfileRepository).count(request);\n    }\n    @Test\n    @DisplayName(\"TC_CR_01: Create staff successfully\")\n    void create_Success() {\n        StaffProfileCreateRequest request = new StaffProfileCreateRequest();\n        request.setFullName(\"John Doe\");\n        request.setEmail(\"john@example.com\");\n        request.setStaffCode(\"ST001\");\n        request.setPassword(\"password123\");\n        request.setRoles(Set.of(\"LECTURER\"));\n\n        Role lecturerRole = new Role();\n        lecturerRole.setId((short) 1);\n        lecturerRole.setName(\"LECTURER\");\n\n        User savedUser = new User();\n        savedUser.setId(1);\n        savedUser.setFullName(\"John Doe\");\n        savedUser.setEmail(\"john@example.com\");\n        savedUser.setUsername(\"ST001\");\n        savedUser.setPasswordHash(\"encodedPassword\");\n        savedUser.setActive(true);\n        savedUser.setRoles(Set.of(lecturerRole));\n        savedUser.setCreatedAt(Instant.now());\n        savedUser.setUpdatedAt(Instant.now());\n\n        StaffProfile savedProfile = new StaffProfile();\n        savedProfile.setUserId(1);\n        savedProfile.setStaffCode(\"ST001\");\n        savedProfile.setUser(savedUser);\n\n        when(staffProfileRepository.existsByStaffCode(request.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(request.getEmail())).thenReturn(false);\n        when(roleRepository.findByNameIn(request.getRoles())).thenReturn(List.of(lecturerRole));\n        when(passwordEncoder.encode(anyString())).thenReturn(\"encodedPassword\");\n        when(userRepository.save(any(User.class))).thenReturn(savedUser);\n        when(staffProfileRepository.save(any(StaffProfile.class))).thenReturn(savedProfile);\n\n        StaffProfileDTO result = staffProfileService.create(request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getFullName()).isEqualTo(\"John Doe\");\n        assertThat(result.getEmail()).isEqualTo(\"john@example.com\");\n        assertThat(result.getUsername()).isEqualTo(\"ST001\");\n        assertThat(result.getStaffCode()).isEqualTo(\"ST001\");\n        assertThat(result.getRoles()).containsExactly(\"LECTURER\");\n        verify(staffProfileRepository).existsByStaffCode(request.getStaffCode());\n        verify(userRepository).existsByEmail(request.getEmail());\n        verify(roleRepository).findByNameIn(request.getRoles());\n        verify(passwordEncoder).encode(anyString());\n        verify(userRepository).save(any(User.class));\n        verify(staffProfileRepository).save(any(StaffProfile.class));\n        verify(emailService, never()).sendPassword(anyString(), anyString());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_02: Create staff successfully with auto-generated password\")\n    void create_SuccessWithAutoPassword() {\n        StaffProfileCreateRequest request = new StaffProfileCreateRequest();\n        request.setFullName(\"John Doe\");\n        request.setEmail(\"john@example.com\");\n        request.setStaffCode(\"ST001\");\n        request.setPassword(null); // No password provided\n        request.setRoles(Set.of(\"LECTURER\"));\n\n        Role lecturerRole = new Role();\n        lecturerRole.setId((short) 1);\n        lecturerRole.setName(\"LECTURER\");\n\n        User savedUser = new User();\n        savedUser.setId(1);\n        savedUser.setFullName(\"John Doe\");\n        savedUser.setEmail(\"john@example.com\");\n        savedUser.setUsername(\"ST001\");\n        savedUser.setPasswordHash(\"encodedPassword\");\n        savedUser.setActive(true);\n        savedUser.setRoles(Set.of(lecturerRole));\n        savedUser.setCreatedAt(Instant.now());\n        savedUser.setUpdatedAt(Instant.now());\n\n        StaffProfile savedProfile = new StaffProfile();\n        savedProfile.setUserId(1);\n        savedProfile.setStaffCode(\"ST001\");\n        savedProfile.setUser(savedUser);\n\n        when(staffProfileRepository.existsByStaffCode(request.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(request.getEmail())).thenReturn(false);\n        when(roleRepository.findByNameIn(request.getRoles())).thenReturn(List.of(lecturerRole));\n        when(passwordEncoder.encode(anyString())).thenReturn(\"encodedPassword\");\n        when(userRepository.save(any(User.class))).thenReturn(savedUser);\n        when(staffProfileRepository.save(any(StaffProfile.class))).thenReturn(savedProfile);\n\n        StaffProfileDTO result = staffProfileService.create(request);\n\n        assertThat(result).isNotNull();\n        assertThat(result.getFullName()).isEqualTo(\"John Doe\");\n        assertThat(result.getEmail()).isEqualTo(\"john@example.com\");\n        verify(staffProfileRepository).existsByStaffCode(request.getStaffCode());\n        verify(userRepository).existsByEmail(request.getEmail());\n        verify(roleRepository).findByNameIn(request.getRoles());\n        verify(passwordEncoder).encode(anyString());\n        verify(userRepository).save(any(User.class));\n        verify(staffProfileRepository).save(any(StaffProfile.class));\n        verify(emailService).sendPassword(eq(\"john@example.com\"), anyString());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_04: Throw OperationNotAllowedException when non-system admin assigns DATA_OPERATOR role\")\n    void create_DataOperatorRoleByNonSystemAdmin() {\n        StaffProfileCreateRequest request = new StaffProfileCreateRequest();\n        request.setFullName(\"John Doe\");\n        request.setEmail(\"john@example.com\");\n        request.setStaffCode(\"ST001\");\n        request.setPassword(\"password123\");\n        request.setRoles(Set.of(\"DATA_OPERATOR\"));\n\n        Set<SimpleGrantedAuthority> authorities = new HashSet<>();\n        authorities.add(new SimpleGrantedAuthority(\"LECTURER\"));\n        UserAuthentication auth = new UserAuthentication(\"JohnDoe\", null, authorities, 1);\n\n        try (MockedStatic<SecurityUtil> securityUtilMock = mockStatic(SecurityUtil.class)) {\n            securityUtilMock.when(SecurityUtil::getUserAuthentication).thenReturn(Optional.of(auth));\n\n            OperationNotAllowedException exception = assertThrows(\n                    OperationNotAllowedException.class,\n                    () -> staffProfileService.create(request)\n            );\n\n            assertThat(exception.getMessage()).contains(\"You cannot assign your account or others account role Data Operator\");\n            assertThat(exception.getErrorCode()).isEqualTo(ErrorCode.FORBIDDEN);\n            verify(staffProfileRepository, never()).save(any());\n        }\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_05: Throw ResourceExistsException when staff code exists\")\n    void create_StaffCodeExists() {\n        StaffProfileCreateRequest request = new StaffProfileCreateRequest();\n        request.setFullName(\"John Doe\");\n        request.setEmail(\"john@example.com\");\n        request.setStaffCode(\"ST001\");\n        request.setPassword(\"password123\");\n        request.setRoles(Set.of(\"LECTURER\"));\n\n        when(staffProfileRepository.existsByStaffCode(request.getStaffCode())).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> staffProfileService.create(request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Staff code exists: \" + request.getStaffCode());\n        assertThat(exception.getErrorCode()).isEqualTo(ErrorCode.STAFF_CODE_EXISTS);\n        verify(staffProfileRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_06: Throw ResourceExistsException when email exists\")\n    void create_EmailExists() {\n        StaffProfileCreateRequest request = new StaffProfileCreateRequest();\n        request.setFullName(\"John Doe\");\n        request.setEmail(\"john@example.com\");\n        request.setStaffCode(\"ST001\");\n        request.setPassword(\"password123\");\n        request.setRoles(Set.of(\"LECTURER\"));\n\n        when(staffProfileRepository.existsByStaffCode(request.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(request.getEmail())).thenReturn(true);\n\n        ResourceExistsException exception = assertThrows(\n                ResourceExistsException.class,\n                () -> staffProfileService.create(request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Email exists: \" + request.getEmail());\n        assertThat(exception.getErrorCode()).isEqualTo(ErrorCode.EMAIL_EXISTS);\n        verify(staffProfileRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_07: Throw BadRequestException when roles are empty\")\n    void create_EmptyRoles() {\n        StaffProfileCreateRequest request = new StaffProfileCreateRequest();\n        request.setFullName(\"John Doe\");\n        request.setEmail(\"john@example.com\");\n        request.setStaffCode(\"ST001\");\n        request.setPassword(\"password123\");\n        request.setRoles(Set.of()); // Empty roles\n\n        BadRequestException exception = assertThrows(\n                BadRequestException.class,\n                () -> staffProfileService.create(request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"At least one role is required\");\n        assertThat(exception.getErrorCode()).isEqualTo(ErrorCode.ROLES_REQUIRED);\n        verify(staffProfileRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_08: Throw BadRequestException when roles are invalid\")\n    void create_InvalidRoles() {\n        StaffProfileCreateRequest request = new StaffProfileCreateRequest();\n        request.setFullName(\"John Doe\");\n        request.setEmail(\"john@example.com\");\n        request.setStaffCode(\"ST001\");\n        request.setPassword(\"password123\");\n        request.setRoles(Set.of(\"INVALID_ROLE\"));\n\n        when(staffProfileRepository.existsByStaffCode(request.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(request.getEmail())).thenReturn(false);\n        when(roleRepository.findByNameIn(request.getRoles())).thenReturn(List.of()); // No roles found\n\n        BadRequestException exception = assertThrows(\n                BadRequestException.class,\n                () -> staffProfileService.create(request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Invalid roles: INVALID_ROLE\");\n        assertThat(exception.getErrorCode()).isEqualTo(ErrorCode.INVALID_ROLE);\n        verify(staffProfileRepository, never()).save(any());\n    }\n\n    @Test\n    @DisplayName(\"TC_CR_09: Throw BadRequestException when assigning STUDENT role to staff\")\n    void create_StudentRoleForStaff() {\n        StaffProfileCreateRequest request = new StaffProfileCreateRequest();\n        request.setFullName(\"John Doe\");\n        request.setEmail(\"john@example.com\");\n        request.setStaffCode(\"ST001\");\n        request.setPassword(\"password123\");\n        request.setRoles(Set.of(\"STUDENT\"));\n\n        Role studentRole = new Role();\n        studentRole.setId((short) 4);\n        studentRole.setName(\"STUDENT\");\n\n        when(staffProfileRepository.existsByStaffCode(request.getStaffCode())).thenReturn(false);\n        when(userRepository.existsByEmail(request.getEmail())).thenReturn(false);\n        when(roleRepository.findByNameIn(request.getRoles())).thenReturn(List.of(studentRole));\n\n        BadRequestException exception = assertThrows(\n                BadRequestException.class,\n                () -> staffProfileService.create(request)\n        );\n\n        assertThat(exception.getMessage()).contains(\"Cannot assign STUDENT role to staff\");\n        assertThat(exception.getErrorCode()).isEqualTo(ErrorCode.INVALID_ROLE);\n        verify(staffProfileRepository, never()).save(any());\n    }\n}\n"
    }
  ]
}