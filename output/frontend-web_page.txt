{
  "metadata": {
    "codebase": "frontend-web",
    "category": "page",
    "generated_at": "2025-11-19T20:29:55.661802",
    "total_files": 47,
    "total_lines": 15123,
    "total_bytes": 539560
  },
  "files": [
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\cameras\\page.tsx",
      "relative_path": "app/admin/cameras/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 18583,
      "lines": 548,
      "last_modified": "2025-11-14T17:40:59.015907",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useState } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { Plus, FileSpreadsheet } from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from 'next-intl';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { CameraTable } from \"@/components/admin/cameras/camera-table\";\nimport { createCameraColumns } from \"@/components/admin/cameras/camera-columns\";\nimport {\n  CameraFormDialog,\n  CameraFormData,\n} from \"@/components/admin/cameras/camera-form-dialog\";\nimport { DeleteCameraDialog } from \"@/components/admin/cameras/delete-camera-dialog\";\nimport GenericImportDialog from \"@/components/admin/shared/generic-import-dialog\";\nimport { Camera } from \"@/types\";\nimport {\n  useGetCameras,\n  useGetCameraById,\n  useCreateCamera,\n  useUpdateCamera,\n  useDeleteCamera,\n  useImportCameras,\n} from \"@/hooks/api/useCameras\";\nimport { useGetRooms } from \"@/hooks/api/useRooms\";\nimport { DEFAULT_PAGE_SIZE, FILTER_PAGE_SIZE } from \"@/lib/constants\";\n\nfunction CamerasContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const t = useTranslations('camera');\n  const tImport = useTranslations('import');\n\n  // Extract and validate URL parameters\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const searchQuery = searchParams.get(\"search\") || \"\";\n  const sortBy = (\n    [\"name\"].includes(searchParams.get(\"sortBy\") || \"\")\n      ? searchParams.get(\"sortBy\")\n      : \"name\"\n  ) as \"name\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n  const isActiveParam = searchParams.get(\"isActive\");\n  const isActiveFilter =\n    isActiveParam === \"false\"\n      ? false\n      : isActiveParam === \"true\"\n      ? true\n      : undefined; // Default to all\n  const roomIdParam = searchParams.get(\"roomId\");\n  const roomIdFilter = roomIdParam ? Number(roomIdParam) : undefined;\n\n  // Local state for debounced search\n  const [localSearchValue, setLocalSearchValue] = useState(searchQuery);\n  const [roomFilterOpen, setRoomFilterOpen] = useState(false);\n  const [roomFilterQuery, setRoomFilterQuery] = useState(\"\");\n\n  // Dialog states\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n  const [selectedCameraId, setSelectedCameraId] = useState<number | null>(null);\n  const [deleteTargetCamera, setDeleteTargetCamera] = useState<Camera | null>(\n    null\n  );\n\n  // Update URL with new parameters\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key); // Clean URL for page 1\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    // Always ensure sortBy and sort are in URL\n    if (!newParams.has(\"sortBy\")) {\n      newParams.set(\"sortBy\", sortBy);\n    }\n    if (!newParams.has(\"sort\")) {\n      newParams.set(\"sort\", sortOrder);\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  // Debounced search effect\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (localSearchValue !== searchQuery) {\n        updateURL({\n          search: localSearchValue || undefined,\n          page: 1,\n        });\n      }\n    }, 500);\n\n    return () => clearTimeout(timer);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [localSearchValue, searchQuery]);\n\n  // Sync local search with URL\n  useEffect(() => {\n    setLocalSearchValue(searchQuery);\n  }, [searchQuery]);\n\n  // Initialize URL params on mount\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n    const needsUpdate =\n      !currentParams.has(\"sortBy\") ||\n      !currentParams.has(\"sort\") ||\n      (page !== 1 && !currentParams.has(\"page\"));\n\n    if (needsUpdate) {\n      const newParams = new URLSearchParams();\n\n      newParams.set(\"sortBy\", sortBy);\n      newParams.set(\"sort\", sortOrder);\n\n      if (page !== 1) {\n        newParams.set(\"page\", String(page));\n      }\n\n      if (searchQuery) {\n        newParams.set(\"search\", searchQuery);\n      }\n\n      if (isActiveParam) {\n        newParams.set(\"isActive\", isActiveParam);\n      }\n\n      if (roomIdParam) {\n        newParams.set(\"roomId\", roomIdParam);\n      }\n\n      const newURL = `${pathname}?${newParams.toString()}`;\n      router.replace(newURL, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Fetch cameras data\n  const { data, isLoading } = useGetCameras({\n    page,\n    pageSize: DEFAULT_PAGE_SIZE,\n    search: searchQuery,\n    sort: sortOrder,\n    sortBy: sortBy,\n    isActive: isActiveFilter,\n    roomId: roomIdFilter,\n  });\n\n  // Fetch all active rooms for form dialog\n  const { data: roomsData } = useGetRooms({\n    pageSize: FILTER_PAGE_SIZE,\n    isActive: true,\n    sort: \"asc\",\n    sortBy: \"name\",\n  });\n\n  // Fetch all rooms for filter dropdown (including inactive)\n  const { data: allRoomsData } = useGetRooms({\n    pageSize: FILTER_PAGE_SIZE,\n    sort: \"asc\",\n    sortBy: \"name\",\n    search: roomFilterQuery || undefined,\n  });\n\n  // Fetch selected camera for editing\n  const { data: selectedCamera, isLoading: isLoadingCamera } =\n    useGetCameraById(selectedCameraId || 0);\n\n  // Mutations\n  const createMutation = useCreateCamera();\n  const updateMutation = useUpdateCamera();\n  const deleteMutation = useDeleteCamera();\n  const importMutation = useImportCameras();\n\n  // Extract data\n  const cameras = data?.items || [];\n  const totalPages = data?.totalPages || 1;\n  const totalItems = data?.totalItems || 0;\n  const currentPage = data?.currentPage || 1;\n  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;\n  const availableRooms = roomsData?.items || [];\n  const allRooms = allRoomsData?.items || [];\n\n  // Handler functions\n  const handleSearchChange = (value: string) => {\n    setLocalSearchValue(value);\n  };\n\n  const handleSortByChange = (value: \"name\") => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleIsActiveFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ isActive: undefined, page: 1 });\n    } else {\n      updateURL({ isActive: value, page: 1 });\n    }\n  };\n\n  const handleRoomFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ roomId: undefined, page: 1 });\n    } else {\n      updateURL({ roomId: value, page: 1 });\n    }\n  };\n\n  const handleRoomClick = (roomName: string) => {\n    router.push(`/admin/rooms?search=${encodeURIComponent(roomName)}`);\n  };\n\n  const handlePageChange = (newPage: number) => {\n    updateURL({ page: newPage });\n  };\n\n  // CRUD handlers\n  const handleCreate = async (data: CameraFormData) => {\n    await createMutation.mutateAsync({\n      name: data.name,\n      rtspUrl: data.rtspUrl,\n      roomId: data.roomId,\n    });\n    setIsCreateDialogOpen(false);\n    updateURL({ page: 1 });\n  };\n\n  const handleEdit = (camera: Camera) => {\n    setSelectedCameraId(camera.id);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = async (data: CameraFormData) => {\n    if (!selectedCamera) return;\n\n    await updateMutation.mutateAsync({\n      id: selectedCamera.id,\n      payload: {\n        name: data.name,\n        rtspUrl: data.rtspUrl,\n        roomId: data.roomId,\n        isActive: data.isActive!,\n      },\n    });\n    setIsEditDialogOpen(false);\n    setSelectedCameraId(null);\n  };\n\n  const handleDeleteFromDialog = (camera: Camera) => {\n    setDeleteTargetCamera(camera);\n    setIsDeleteDialogOpen(true);\n  };\n\n  const handleConfirmDelete = () => {\n    if (!deleteTargetCamera) return;\n\n    deleteMutation.mutate(deleteTargetCamera.id, {\n      onSuccess: () => {\n        setIsDeleteDialogOpen(false);\n        setIsEditDialogOpen(false);\n        setSelectedCameraId(null);\n        setDeleteTargetCamera(null);\n        // Adjust pagination if current page becomes empty\n        if (cameras.length === 1 && currentPage > 1) {\n          updateURL({ page: currentPage - 1 });\n        }\n      },\n    });\n  };\n\n  // Create columns with handlers\n  const columns = createCameraColumns(handleEdit, handleRoomClick);\n\n  // Set page header\n  useEffect(() => {\n    setPageHeader({\n      title: t('page_title'),\n      subtitle: t('page_subtitle'),\n      breadcrumbs: [\n        { label: t('breadcrumb_dashboard'), href: \"/admin/dashboard\" },\n        { label: t('breadcrumb_cameras') },\n      ],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader, t]);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row - Mobile: Stack vertically, Desktop: Horizontal */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        {/* Search and Filters - Stack on mobile, row on tablet+ */}\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Search Input */}\n          <Input\n            placeholder={t('search_placeholder')}\n            value={localSearchValue}\n            onChange={(e) => handleSearchChange(e.target.value)}\n            className=\"w-full sm:max-w-[240px] md:max-w-sm\"\n            autoComplete=\"off\"\n          />\n\n          {/* Status Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('status_label')}\n            </span>\n            <Select\n              value={\n                isActiveFilter === undefined\n                  ? \"all\"\n                  : isActiveFilter\n                  ? \"true\"\n                  : \"false\"\n              }\n              onValueChange={handleIsActiveFilterChange}\n            >\n              <SelectTrigger className=\"w-full sm:w-[140px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('status_label')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">{t('status_all')}</SelectItem>\n                <SelectItem value=\"true\">{t('status_active')}</SelectItem>\n                <SelectItem value=\"false\">{t('status_inactive')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Sort Controls - Compact on mobile */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('sort_label')}\n            </span>\n            <Select value={sortBy} onValueChange={handleSortByChange}>\n              <SelectTrigger className=\"w-full sm:w-[130px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('sort_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"name\">{t('sort_name')}</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"h-6 w-px bg-border\" />\n            <Select value={sortOrder} onValueChange={handleSortOrderChange}>\n              <SelectTrigger className=\"w-full sm:w-[120px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('order_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"asc\">{t('order_asc')}</SelectItem>\n                <SelectItem value=\"desc\">{t('order_desc')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Room Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('room_label')}\n            </span>\n            <Popover open={roomFilterOpen} onOpenChange={setRoomFilterOpen}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  className=\"w-full sm:w-[220px] h-full justify-start border-0 shadow-none hover:bg-transparent px-0 font-normal\"\n                >\n                  {roomIdFilter\n                    ? allRooms.find((r) => r.id === roomIdFilter)\n                      ? allRooms.find((r) => r.id === roomIdFilter)!.name\n                      : t('all_rooms')\n                    : t('all_rooms')}\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent align=\"start\" className=\"w-[300px] p-0\">\n                <Command>\n                  <CommandInput\n                    placeholder={t('type_to_search_room')}\n                    value={roomFilterQuery}\n                    onValueChange={setRoomFilterQuery}\n                  />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>{t('no_room_found')}</CommandEmpty>\n                    <CommandGroup>\n                      <CommandItem\n                        onSelect={() => {\n                          handleRoomFilterChange(\"all\");\n                          setRoomFilterOpen(false);\n                        }}\n                      >\n                        {t('all_rooms')}\n                      </CommandItem>\n                      {allRooms.map((room) => (\n                        <CommandItem\n                          key={room.id}\n                          value={`${room.name} ${room.location || \"\"}`}\n                          onSelect={() => {\n                            handleRoomFilterChange(String(room.id));\n                            setRoomFilterOpen(false);\n                          }}\n                        >\n                          <div className=\"flex flex-col\">\n                            <span>{room.name}</span>\n                            {room.location && (\n                              <span className=\"text-xs text-muted-foreground\">\n                                {room.location}\n                              </span>\n                            )}\n                          </div>\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n        </div>\n\n        {/* Action Buttons - Full width on mobile, side by side on tablet+ */}\n        <div className=\"flex flex-col sm:flex-row gap-2 w-full sm:w-auto\">\n          <Button\n            onClick={() => setIsImportDialogOpen(true)}\n            className=\"w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white\"\n          >\n            <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n            {t('import_button')}\n          </Button>\n          <Button\n            onClick={() => setIsCreateDialogOpen(true)}\n            className=\"w-full sm:w-auto\"\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            {t('create_button')}\n          </Button>\n        </div>\n      </div>\n\n      {/* Camera Table */}\n      <CameraTable\n        columns={columns}\n        data={cameras}\n        isLoading={isLoading}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={pageSize}\n        onPageChange={handlePageChange}\n      />\n\n      {/* Create Dialog */}\n      <CameraFormDialog\n        open={isCreateDialogOpen}\n        onOpenChange={setIsCreateDialogOpen}\n        onSubmit={handleCreate}\n        isSubmitting={createMutation.isPending}\n        availableRooms={availableRooms}\n      />\n\n      {/* Edit Dialog */}\n      <CameraFormDialog\n        open={isEditDialogOpen}\n        onOpenChange={setIsEditDialogOpen}\n        camera={selectedCamera}\n        isLoadingCamera={isLoadingCamera}\n        onSubmit={handleUpdate}\n        onDelete={handleDeleteFromDialog}\n        isSubmitting={updateMutation.isPending}\n        isDeleting={deleteMutation.isPending}\n        availableRooms={availableRooms}\n      />\n\n      {/* Delete Confirmation Dialog */}\n      <DeleteCameraDialog\n        open={isDeleteDialogOpen}\n        onOpenChange={setIsDeleteDialogOpen}\n        camera={deleteTargetCamera}\n        onConfirm={handleConfirmDelete}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      <GenericImportDialog\n        open={isImportDialogOpen}\n        onOpenChange={setIsImportDialogOpen}\n        title={tImport('title')}\n        csvColumns={[\"name\", \"rtspUrl\", \"room_name\", \"status\"]}\n        importMutation={importMutation}\n        successMessage={tImport('success_message')}\n        entityName=\"cameras\"\n      />\n    </div>\n  );\n}\n\nexport default function CamerasPage() {\n  const t = useTranslations('camera');\n\n  return (\n    <Suspense fallback={<div>{t('loading')}</div>}>\n      <CamerasContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\classes\\[id]\\students\\page.tsx",
      "relative_path": "app/admin/classes/[id]/students/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 19561,
      "lines": 541,
      "last_modified": "2025-11-13T21:14:04.077528",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useState, useEffect, useMemo } from \"react\";\nimport { useParams, useRouter, useSearchParams } from \"next/navigation\";\nimport { Plus, Search as SearchIcon } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n} from \"@/components/ui/pagination\";\nimport { ClassStudentsTable } from \"@/components/admin/classes/class-students-table\";\nimport { AddStudentDialog } from \"@/components/admin/classes/add-student-dialog\";\nimport { WithdrawStudentDialog } from \"@/components/admin/classes/withdraw-student-dialog\";\nimport { ReEnrollStudentDialog } from \"@/components/admin/classes/re-enroll-student-dialog\";\nimport { ViewStudentDialog } from \"@/components/admin/classes/view-student-dialog\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useGetClassById } from \"@/hooks/api/useClasses\";\nimport {\n  useGetClassEnrollments,\n  useCreateEnrollment,\n  useUpdateEnrollment,\n} from \"@/hooks/api/useEnrollments\";\nimport { ClassEnrollment } from \"@/types\";\nimport { DEFAULT_PAGE_SIZE } from \"@/lib/constants\";\nimport { canModifyEnrollments } from \"@/lib/utils\";\n\nexport default function ClassStudentsPage() {\n  const params = useParams();\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const classId = Number(params.id);\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // URL params\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const searchQuery = searchParams.get(\"search\") || \"\";\n  const sortBy = (\n    [\"fullName\", \"rollNumber\", \"createdAt\"].includes(\n      searchParams.get(\"sortBy\") || \"\"\n    )\n      ? searchParams.get(\"sortBy\")\n      : \"fullName\"\n  ) as \"fullName\" | \"rollNumber\" | \"createdAt\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n  const isEnrolledFilter =\n    searchParams.get(\"isEnrolled\") === \"false\"\n      ? false\n      : searchParams.get(\"isEnrolled\") === \"true\"\n      ? true\n      : undefined;\n\n  // Local state\n  const [localSearchValue, setLocalSearchValue] = useState(searchQuery);\n  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false);\n  const [isWithdrawDialogOpen, setIsWithdrawDialogOpen] = useState(false);\n  const [isReEnrollDialogOpen, setIsReEnrollDialogOpen] = useState(false);\n  const [isViewDialogOpen, setIsViewDialogOpen] = useState(false);\n  const [selectedEnrollment, setSelectedEnrollment] =\n    useState<ClassEnrollment | null>(null);\n\n  // Fetch data\n  const { data: classData, isLoading: isLoadingClass } =\n    useGetClassById(classId);\n  const { data: enrollmentsData, isLoading: isLoadingEnrollments } =\n    useGetClassEnrollments(classId, {\n      page,\n      pageSize: DEFAULT_PAGE_SIZE,\n      sort: sortOrder,\n      sortBy,\n      isEnrolled: isEnrolledFilter,\n      search: searchQuery,\n    });\n\n  const createEnrollmentMutation = useCreateEnrollment();\n  const updateEnrollmentMutation = useUpdateEnrollment();\n\n  // Check if class is active\n  const isClassActive = classData?.isActive ?? false;\n\n  // Check if enrollments can be modified based on semester dates\n  const canModify = useMemo(() => {\n    if (!classData) return false;\n    return isClassActive && canModifyEnrollments(classData.semester);\n  }, [classData, isClassActive]);\n\n  // Update URL\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        newParams.delete(key);\n      }\n    });\n\n    router.push(`?${newParams.toString()}`, { scroll: false });\n  };\n\n  // Debounced search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (localSearchValue !== searchQuery) {\n        updateURL({ search: localSearchValue, page: 1 });\n      }\n    }, 500);\n\n    return () => clearTimeout(timer);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [localSearchValue]);\n\n  // Set page header\n  useEffect(() => {\n    if (classData) {\n      setPageHeader({\n        title: `${classData.code} - Student Roster`,\n        subtitle: `${classData.subject.name} (${classData.subject.code}) â€¢ ${classData.semester.name}`,\n        breadcrumbs: [\n          { label: \"Dashboard\", href: \"/admin/dashboard\" },\n          { label: \"Classes\", href: \"/admin/classes\" },\n          { label: classData.code },\n        ],\n      });\n    }\n  }, [classData, setPageHeader]);\n\n  // Clear header on unmount\n  useEffect(() => {\n    return () => {\n      clearPageHeader();\n    };\n  }, [clearPageHeader]);\n\n  // Handlers\n  const handleAddStudent = async (studentUserId: number) => {\n    await createEnrollmentMutation.mutateAsync({\n      classId,\n      studentUserId,\n    });\n    setIsAddDialogOpen(false);\n  };\n\n  const handleViewClick = (enrollment: ClassEnrollment) => {\n    setSelectedEnrollment(enrollment);\n    setIsViewDialogOpen(true);\n  };\n\n  const handleWithdrawClick = (enrollment: ClassEnrollment) => {\n    setSelectedEnrollment(enrollment);\n    setIsWithdrawDialogOpen(true);\n  };\n\n  const handleWithdrawConfirm = async () => {\n    if (!selectedEnrollment) return;\n\n    await updateEnrollmentMutation.mutateAsync({\n      classId,\n      studentUserId: selectedEnrollment.studentUserId,\n      isEnrolled: false,\n    });\n\n    setIsWithdrawDialogOpen(false);\n    setSelectedEnrollment(null);\n  };\n\n  const handleReEnrollClick = (enrollment: ClassEnrollment) => {\n    setSelectedEnrollment(enrollment);\n    setIsReEnrollDialogOpen(true);\n  };\n\n  const handleReEnrollConfirm = async () => {\n    if (!selectedEnrollment) return;\n\n    await updateEnrollmentMutation.mutateAsync({\n      classId,\n      studentUserId: selectedEnrollment.studentUserId,\n      isEnrolled: true,\n    });\n\n    setIsReEnrollDialogOpen(false);\n    setSelectedEnrollment(null);\n  };\n\n  const handlePageChange = (newPage: number) => {\n    updateURL({ page: newPage });\n  };\n\n  const getPageNumbers = (\n    currentPage: number,\n    totalPages: number\n  ): (number | \"ellipsis\")[] => {\n    const pages: (number | \"ellipsis\")[] = [];\n    if (totalPages <= 7) {\n      for (let i = 1; i <= totalPages; i++) pages.push(i);\n    } else if (currentPage <= 4) {\n      for (let i = 1; i <= 5; i++) pages.push(i);\n      pages.push(\"ellipsis\", totalPages);\n    } else if (currentPage >= totalPages - 3) {\n      pages.push(1, \"ellipsis\");\n      for (let i = totalPages - 4; i <= totalPages; i++) pages.push(i);\n    } else {\n      pages.push(\n        1,\n        \"ellipsis\",\n        currentPage - 1,\n        currentPage,\n        currentPage + 1,\n        \"ellipsis\",\n        totalPages\n      );\n    }\n    return pages;\n  };\n\n  const handleSortByChange = (\n    value: \"fullName\" | \"rollNumber\" | \"createdAt\"\n  ) => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleIsEnrolledChange = (value: string) => {\n    const filterValue = value === \"all\" ? undefined : value;\n    updateURL({ isEnrolled: filterValue, page: 1 });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  // Loading state\n  if (isLoadingClass) {\n    return (\n      <div className=\"space-y-6\">\n        <Skeleton className=\"h-10 w-full\" />\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          <Skeleton className=\"h-32 w-full\" />\n          <Skeleton className=\"h-32 w-full\" />\n          <Skeleton className=\"h-32 w-full\" />\n        </div>\n        <Skeleton className=\"h-96 w-full\" />\n      </div>\n    );\n  }\n\n  if (!classData) {\n    return (\n      <div className=\"flex flex-col items-center justify-center min-h-[400px] gap-4\">\n        <p className=\"text-muted-foreground\">Class not found</p>\n        <Button onClick={() => router.push(\"/admin/classes\")}>\n          Back to Classes\n        </Button>\n      </div>\n    );\n  }\n\n  const enrolledStudentIds =\n    enrollmentsData?.items.map((e) => e.studentUserId) || [];\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Search */}\n          <div className=\"relative w-full sm:max-w-[280px]\">\n            <SearchIcon className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search students...\"\n              value={localSearchValue}\n              onChange={(e) => setLocalSearchValue(e.target.value)}\n              className=\"pl-9\"\n            />\n          </div>\n\n          {/* Status Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Status:\n            </span>\n            <Select\n              value={\n                isEnrolledFilter === undefined\n                  ? \"all\"\n                  : isEnrolledFilter\n                  ? \"true\"\n                  : \"false\"\n              }\n              onValueChange={handleIsEnrolledChange}\n            >\n              <SelectTrigger className=\"w-full sm:w-[140px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder=\"Status...\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Status</SelectItem>\n                <SelectItem value=\"true\">Active</SelectItem>\n                <SelectItem value=\"false\">Withdrawn</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Sort Controls - Combined */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Sort:\n            </span>\n            <Select value={sortBy} onValueChange={handleSortByChange}>\n              <SelectTrigger className=\"w-full sm:w-[140px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder=\"Sort by...\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"fullName\">Name</SelectItem>\n                <SelectItem value=\"rollNumber\">Roll Number</SelectItem>\n                <SelectItem value=\"createdAt\">Enrolled Date</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"h-6 w-px bg-border\" />\n            <Select value={sortOrder} onValueChange={handleSortOrderChange}>\n              <SelectTrigger className=\"w-full sm:w-[120px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder=\"Order...\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"asc\">Ascending</SelectItem>\n                <SelectItem value=\"desc\">Descending</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n\n        {/* Add Student Button */}\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <span className=\"w-full sm:w-auto\">\n                <Button\n                  className=\"w-full sm:w-auto\"\n                  onClick={() => setIsAddDialogOpen(true)}\n                  disabled={!canModify}\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Add Student\n                </Button>\n              </span>\n            </TooltipTrigger>\n            {!canModify && (\n              <TooltipContent>\n                <p>\n                  {!isClassActive\n                    ? \"Cannot add students to an inactive class\"\n                    : \"Cannot modify enrollments after semester ends\"}\n                </p>\n              </TooltipContent>\n            )}\n          </Tooltip>\n        </TooltipProvider>\n      </div>\n\n      {/* Students Table */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n            <CardTitle>Class Students</CardTitle>\n            <div className=\"flex items-center gap-4 text-sm\">\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-muted-foreground\">Total Enrolled:</span>\n                <span className=\"font-semibold\">\n                  {enrollmentsData?.totalEnrolled || 0}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-muted-foreground\">Withdrawn:</span>\n                <span className=\"font-semibold text-destructive\">\n                  {enrollmentsData?.totalWithdrawn || 0}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-muted-foreground\">Active Slots:</span>\n                <span className=\"font-semibold\">\n                  {classData.totalActiveSlot || 0}\n                </span>\n              </div>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent className=\"pt-0\">\n          {isLoadingEnrollments ? (\n            <div className=\"space-y-3\">\n              {[...Array(5)].map((_, i) => (\n                <Skeleton key={i} className=\"h-16 w-full\" />\n              ))}\n            </div>\n          ) : (\n            <>\n              <ClassStudentsTable\n                data={enrollmentsData?.items || []}\n                currentPage={page}\n                pageSize={DEFAULT_PAGE_SIZE}\n                onEdit={handleViewClick}\n                onWithdraw={handleWithdrawClick}\n                onReEnroll={handleReEnrollClick}\n                isWithdrawing={updateEnrollmentMutation.isPending}\n                isReEnrolling={updateEnrollmentMutation.isPending}\n                canModifyEnrollments={canModify}\n              />\n\n              {/* Pagination */}\n              {enrollmentsData && enrollmentsData.totalItems > 0 && (\n                <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n                  <div className=\"text-sm text-muted-foreground text-center sm:text-left min-w-[200px]\">\n                    {enrollmentsData.totalItems > 0 ? (\n                      <>\n                        Showing {(page - 1) * DEFAULT_PAGE_SIZE + 1} -{\" \"}\n                        {Math.min(\n                          page * DEFAULT_PAGE_SIZE,\n                          enrollmentsData.totalItems\n                        )}{\" \"}\n                        of {enrollmentsData.totalItems} items\n                      </>\n                    ) : (\n                      \"No items\"\n                    )}\n                  </div>\n                  {enrollmentsData.totalItems > DEFAULT_PAGE_SIZE && (\n                    <div className=\"flex justify-center sm:justify-end\">\n                      <Pagination>\n                        <PaginationContent>\n                          <PaginationItem>\n                            <PaginationPrevious\n                              onClick={() =>\n                                page > 1 && handlePageChange(page - 1)\n                              }\n                              className={\n                                page === 1\n                                  ? \"pointer-events-none opacity-50\"\n                                  : \"cursor-pointer\"\n                              }\n                            />\n                          </PaginationItem>\n                          {getPageNumbers(page, enrollmentsData.totalPages).map(\n                            (p, idx) => (\n                              <PaginationItem key={idx}>\n                                {p === \"ellipsis\" ? (\n                                  <PaginationEllipsis />\n                                ) : (\n                                  <PaginationLink\n                                    onClick={() =>\n                                      handlePageChange(p as number)\n                                    }\n                                    isActive={page === p}\n                                  >\n                                    {p}\n                                  </PaginationLink>\n                                )}\n                              </PaginationItem>\n                            )\n                          )}\n                          <PaginationItem>\n                            <PaginationNext\n                              onClick={() =>\n                                page < enrollmentsData.totalPages &&\n                                handlePageChange(page + 1)\n                              }\n                              className={\n                                page >= enrollmentsData.totalPages\n                                  ? \"pointer-events-none opacity-50\"\n                                  : \"cursor-pointer\"\n                              }\n                            />\n                          </PaginationItem>\n                        </PaginationContent>\n                      </Pagination>\n                    </div>\n                  )}\n                </div>\n              )}\n            </>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Dialogs */}\n      <AddStudentDialog\n        open={isAddDialogOpen}\n        onOpenChange={setIsAddDialogOpen}\n        onAddStudent={handleAddStudent}\n        isAdding={createEnrollmentMutation.isPending}\n        enrolledStudentIds={enrolledStudentIds}\n        classCode={classData.code}\n        classData={classData}\n      />\n\n      <ViewStudentDialog\n        open={isViewDialogOpen}\n        onOpenChange={setIsViewDialogOpen}\n        enrollment={selectedEnrollment}\n      />\n\n      <WithdrawStudentDialog\n        open={isWithdrawDialogOpen}\n        onOpenChange={setIsWithdrawDialogOpen}\n        enrollment={selectedEnrollment}\n        onConfirm={handleWithdrawConfirm}\n        isWithdrawing={updateEnrollmentMutation.isPending}\n      />\n\n      <ReEnrollStudentDialog\n        open={isReEnrollDialogOpen}\n        onOpenChange={setIsReEnrollDialogOpen}\n        enrollment={selectedEnrollment}\n        onConfirm={handleReEnrollConfirm}\n        isReEnrolling={updateEnrollmentMutation.isPending}\n      />\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\classes\\page.tsx",
      "relative_path": "app/admin/classes/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 23992,
      "lines": 677,
      "last_modified": "2025-11-14T17:41:00.184821",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useState } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { Plus, FileSpreadsheet } from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from 'next-intl';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { ClassTable } from \"@/components/admin/classes/class-table\";\nimport { createClassColumns } from \"@/components/admin/classes/class-columns\";\nimport {\n  ClassFormDialog,\n  ClassFormData,\n} from \"@/components/admin/classes/class-form-dialog\";\nimport { DeleteClassDialog } from \"@/components/admin/classes/delete-class-dialog\";\nimport GenericImportDialog from \"@/components/admin/shared/generic-import-dialog\";\nimport { Class } from \"@/types\";\nimport {\n  useGetClasses,\n  useGetClassById,\n  useCreateClass,\n  useUpdateClass,\n  useDeleteClass,\n  useImportClasses,\n} from \"@/hooks/api/useClasses\";\nimport { useImportEnrollments } from \"@/hooks/api/useEnrollments\";\nimport { useGetSemesters } from \"@/hooks/api/useSemesters\";\nimport { useGetSubjects } from \"@/hooks/api/useSubjects\";\nimport { DEFAULT_PAGE_SIZE, FILTER_PAGE_SIZE } from \"@/lib/constants\";\n\nfunction ClassesContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const t = useTranslations('class');\n  const tImport = useTranslations('import');\n\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const searchQuery = searchParams.get(\"search\") || \"\";\n  const sortBy = (\n    [\"code\"].includes(searchParams.get(\"sortBy\") || \"\")\n      ? searchParams.get(\"sortBy\")\n      : \"code\"\n  ) as \"code\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n  const isActiveParam = searchParams.get(\"isActive\");\n  const isActiveFilter =\n    isActiveParam === \"false\"\n      ? false\n      : isActiveParam === \"true\"\n      ? true\n      : undefined; // Default to all\n  const semesterIdParam = searchParams.get(\"semesterId\");\n  const semesterIdFilter = semesterIdParam\n    ? Number(semesterIdParam)\n    : undefined;\n  const subjectIdParam = searchParams.get(\"subjectId\");\n  const subjectIdFilter = subjectIdParam ? Number(subjectIdParam) : undefined;\n\n  const [localSearchValue, setLocalSearchValue] = useState(searchQuery);\n  const [semesterFilterOpen, setSemesterFilterOpen] = useState(false);\n  const [subjectFilterOpen, setSubjectFilterOpen] = useState(false);\n  const [semesterFilterQuery, setSemesterFilterQuery] = useState(\"\");\n  const [subjectFilterQuery, setSubjectFilterQuery] = useState(\"\");\n\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [isImportPopoverOpen, setIsImportPopoverOpen] = useState(false);\n  const [isImportClassesDialogOpen, setIsImportClassesDialogOpen] = useState(false);\n  const [isImportEnrollmentsDialogOpen, setIsImportEnrollmentsDialogOpen] = useState(false);\n  const [selectedClassId, setSelectedClassId] = useState<number | null>(null);\n  const [deleteTargetClass, setDeleteTargetClass] = useState<Class | null>(\n    null\n  );\n\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    if (!newParams.has(\"sortBy\")) {\n      newParams.set(\"sortBy\", sortBy);\n    }\n    if (!newParams.has(\"sort\")) {\n      newParams.set(\"sort\", sortOrder);\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (localSearchValue !== searchQuery) {\n        updateURL({\n          search: localSearchValue || undefined,\n          page: 1,\n        });\n      }\n    }, 500);\n\n    return () => clearTimeout(timer);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [localSearchValue, searchQuery]);\n\n  useEffect(() => {\n    setLocalSearchValue(searchQuery);\n  }, [searchQuery]);\n\n  useEffect(() => {\n    setPageHeader({\n      breadcrumbs: [\n        { label: t('breadcrumb_dashboard'), href: \"/admin/dashboard\" },\n        { label: t('breadcrumb_classes') },\n      ],\n      title: t('page_title'),\n      subtitle: t('page_subtitle'),\n    });\n\n    return () => clearPageHeader();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [t]);\n\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n    const needsUpdate =\n      !currentParams.has(\"sortBy\") ||\n      !currentParams.has(\"sort\") ||\n      (page !== 1 && !currentParams.has(\"page\"));\n\n    if (needsUpdate) {\n      const newParams = new URLSearchParams();\n\n      newParams.set(\"sortBy\", sortBy);\n      newParams.set(\"sort\", sortOrder);\n\n      if (page !== 1) {\n        newParams.set(\"page\", String(page));\n      }\n\n      if (searchQuery) {\n        newParams.set(\"search\", searchQuery);\n      }\n\n      if (isActiveParam) {\n        newParams.set(\"isActive\", isActiveParam);\n      }\n\n      if (semesterIdParam) {\n        newParams.set(\"semesterId\", semesterIdParam);\n      }\n\n      if (subjectIdParam) {\n        newParams.set(\"subjectId\", subjectIdParam);\n      }\n\n      const newURL = `${pathname}?${newParams.toString()}`;\n      router.replace(newURL, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const { data, isLoading } = useGetClasses({\n    page,\n    pageSize: DEFAULT_PAGE_SIZE,\n    search: searchQuery,\n    sort: sortOrder,\n    sortBy: sortBy,\n    isActive: isActiveFilter,\n    semesterId: semesterIdFilter,\n    subjectId: subjectIdFilter,\n  });\n\n  // Fetch all active semesters for the form dialog\n  const { data: semestersData } = useGetSemesters({\n    pageSize: FILTER_PAGE_SIZE,\n    isActive: true,\n    sortBy: \"name\",\n  });\n\n  // Fetch all semesters for filter dropdown (including inactive)\n  const { data: allSemestersData } = useGetSemesters({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"name\",\n    search: semesterFilterQuery || undefined,\n  });\n\n  // Fetch all active subjects for the form dialog\n  const { data: subjectsData } = useGetSubjects({\n    pageSize: FILTER_PAGE_SIZE,\n    isActive: true,\n    sortBy: \"code\",\n  });\n\n  // Fetch all subjects for filter dropdown (including inactive)\n  const { data: allSubjectsData } = useGetSubjects({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"code\",\n    search: subjectFilterQuery || undefined,\n  });\n\n  // Fetch selected class for editing\n  const { data: selectedClass, isLoading: isLoadingClass } = useGetClassById(\n    selectedClassId || 0\n  );\n\n  const createMutation = useCreateClass();\n  const updateMutation = useUpdateClass();\n  const deleteMutation = useDeleteClass();\n  const importClassesMutation = useImportClasses();\n  const importEnrollmentsMutation = useImportEnrollments();\n\n  const classes = data?.items || [];\n  const totalPages = data?.totalPages || 1;\n  const totalItems = data?.totalItems || 0;\n  const currentPage = data?.currentPage || 1;\n  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;\n  const availableSemesters = semestersData?.items || [];\n  const allSemesters = allSemestersData?.items || [];\n  const availableSubjects = subjectsData?.items || [];\n  const allSubjects = allSubjectsData?.items || [];\n\n  const handleCreate = async (data: ClassFormData) => {\n    await createMutation.mutateAsync({\n      code: data.code,\n      semesterId: data.semesterId,\n      subjectId: data.subjectId,\n    });\n    setIsCreateDialogOpen(false);\n    updateURL({ page: 1 });\n  };\n\n  const handleEdit = (classItem: Class) => {\n    setSelectedClassId(classItem.id);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = async (data: ClassFormData) => {\n    if (!selectedClass) return;\n\n    await updateMutation.mutateAsync({\n      id: selectedClass.id,\n      payload: {\n        code: data.code,\n        semesterId: data.semesterId,\n        subjectId: data.subjectId,\n        isActive: data.isActive!,\n      },\n    });\n    setIsEditDialogOpen(false);\n    setSelectedClassId(null);\n  };\n\n  const handleDeleteFromDialog = (classItem: Class) => {\n    setDeleteTargetClass(classItem);\n    setIsDeleteDialogOpen(true);\n  };\n\n  const handleConfirmDelete = () => {\n    if (!deleteTargetClass) return;\n\n    deleteMutation.mutate(deleteTargetClass.id, {\n      onSuccess: () => {\n        setIsDeleteDialogOpen(false);\n        setIsEditDialogOpen(false);\n        setSelectedClassId(null);\n        setDeleteTargetClass(null);\n        if (classes.length === 1 && currentPage > 1) {\n          updateURL({ page: currentPage - 1 });\n        }\n      },\n    });\n  };\n\n  const handlePageChange = (newPage: number) => {\n    updateURL({ page: newPage });\n  };\n\n  const handleSearchChange = (value: string) => {\n    setLocalSearchValue(value);\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleIsActiveFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ isActive: undefined, page: 1 });\n    } else {\n      updateURL({ isActive: value, page: 1 });\n    }\n  };\n\n  const handleSemesterFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ semesterId: undefined, page: 1 });\n    } else {\n      updateURL({ semesterId: value, page: 1 });\n    }\n  };\n\n  const handleSubjectFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ subjectId: undefined, page: 1 });\n    } else {\n      updateURL({ subjectId: value, page: 1 });\n    }\n  };\n\n  const handleSemesterClick = (semesterCode: string) => {\n    router.push(`/admin/semesters?search=${encodeURIComponent(semesterCode)}`);\n  };\n\n  const handleSubjectClick = (subjectCode: string) => {\n    router.push(`/admin/subjects?search=${encodeURIComponent(subjectCode)}`);\n  };\n\n  const handleViewSlots = (classItem: Class) => {\n    // Navigate to slots page with semester and class filters pre-applied\n    const params = new URLSearchParams();\n    params.set(\"semesterId\", String(classItem.semester.id));\n    params.set(\"classId\", String(classItem.id));\n    router.push(`/admin/slots?${params.toString()}`);\n  };\n\n  const handleViewStudents = (classItem: Class) => {\n    router.push(`/admin/classes/${classItem.id}/students`);\n  };\n\n  const columns = createClassColumns(\n    handleEdit,\n    handleSemesterClick,\n    handleSubjectClick,\n    handleViewSlots,\n    handleViewStudents\n  );\n\n  const selectedSemester = allSemesters.find((s) => s.id === semesterIdFilter);\n  const selectedSubject = allSubjects.find((s) => s.id === subjectIdFilter);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row - Mobile: Stack vertically, Desktop: Horizontal */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        {/* Search and Filters - Stack on mobile, row on tablet+ */}\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Search Input */}\n          <Input\n            placeholder={t('search_placeholder')}\n            value={localSearchValue}\n            onChange={(e) => handleSearchChange(e.target.value)}\n            className=\"w-full sm:w-[300px]\"\n            autoComplete=\"off\"\n          />\n\n          {/* Status Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-[180px]\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('status_label')}\n            </span>\n            <Select\n              value={\n                isActiveFilter === undefined\n                  ? \"all\"\n                  : isActiveFilter\n                  ? \"true\"\n                  : \"false\"\n              }\n              onValueChange={handleIsActiveFilterChange}\n            >\n              <SelectTrigger className=\"w-full sm:w-[110px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('status_label')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">{t('status_all')}</SelectItem>\n                <SelectItem value=\"true\">{t('status_active')}</SelectItem>\n                <SelectItem value=\"false\">{t('status_inactive')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Sort Control - Compact on mobile */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-[220px]\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('sort_label')}\n            </span>\n            <Select value={sortOrder} onValueChange={handleSortOrderChange}>\n              <SelectTrigger className=\"w-full sm:w-[110px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('order_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"asc\">{t('order_asc')}</SelectItem>\n                <SelectItem value=\"desc\">{t('order_desc')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Semester Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('semester_label')}\n            </span>\n            <Popover\n              open={semesterFilterOpen}\n              onOpenChange={setSemesterFilterOpen}\n            >\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  role=\"combobox\"\n                  aria-expanded={semesterFilterOpen}\n                  className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[180px]\"\n                >\n                  <span className=\"truncate\">\n                    {selectedSemester\n                      ? `${selectedSemester.code} - ${selectedSemester.name}`\n                      : t('all_semesters')}\n                  </span>\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-[350px] p-0\">\n                <Command>\n                  <CommandInput\n                    placeholder={t('type_to_search_semester')}\n                    value={semesterFilterQuery}\n                    onValueChange={setSemesterFilterQuery}\n                  />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>{t('no_semester_found')}</CommandEmpty>\n                    <CommandGroup>\n                      <CommandItem\n                        value=\"all-semesters\"\n                        onSelect={() => {\n                          handleSemesterFilterChange(\"all\");\n                          setSemesterFilterOpen(false);\n                        }}\n                      >\n                        {t('all_semesters')}\n                      </CommandItem>\n                      {allSemesters.map((semester) => (\n                        <CommandItem\n                          key={semester.id}\n                          value={`${semester.code}-${semester.name}`}\n                          onSelect={() => {\n                            handleSemesterFilterChange(String(semester.id));\n                            setSemesterFilterOpen(false);\n                          }}\n                        >\n                          {semester.code} - {semester.name}\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Subject Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('subject_label')}\n            </span>\n            <Popover\n              open={subjectFilterOpen}\n              onOpenChange={setSubjectFilterOpen}\n            >\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  role=\"combobox\"\n                  aria-expanded={subjectFilterOpen}\n                  className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[180px]\"\n                >\n                  <span className=\"truncate\">\n                    {selectedSubject\n                      ? `${selectedSubject.code} - ${selectedSubject.name}`\n                      : t('all_subjects')}\n                  </span>\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-[350px] p-0\">\n                <Command>\n                  <CommandInput\n                    placeholder={t('type_to_search_subject')}\n                    value={subjectFilterQuery}\n                    onValueChange={setSubjectFilterQuery}\n                  />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>{t('no_subject_found')}</CommandEmpty>\n                    <CommandGroup>\n                      <CommandItem\n                        value=\"all-subjects\"\n                        onSelect={() => {\n                          handleSubjectFilterChange(\"all\");\n                          setSubjectFilterOpen(false);\n                        }}\n                      >\n                        {t('all_subjects')}\n                      </CommandItem>\n                      {allSubjects.map((subject) => (\n                        <CommandItem\n                          key={subject.id}\n                          value={`${subject.code}-${subject.name}`}\n                          onSelect={() => {\n                            handleSubjectFilterChange(String(subject.id));\n                            setSubjectFilterOpen(false);\n                          }}\n                        >\n                          {subject.code} - {subject.name}\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n        </div>\n\n        {/* Action Buttons - Full width on mobile, side by side on tablet+ */}\n        <div className=\"flex flex-col sm:flex-row gap-2 w-full sm:w-auto\">\n          <Popover open={isImportPopoverOpen} onOpenChange={setIsImportPopoverOpen}>\n            <PopoverTrigger asChild>\n              <Button className=\"w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white\">\n                <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n                {t('import_button')}\n              </Button>\n            </PopoverTrigger>\n            <PopoverContent className=\"w-56 p-2\" align=\"start\">\n              <div className=\"flex flex-col gap-1\">\n                <Button\n                  variant=\"ghost\"\n                  className=\"justify-start\"\n                  onClick={() => {\n                    setIsImportPopoverOpen(false);\n                    setIsImportClassesDialogOpen(true);\n                  }}\n                >\n                  {tImport('title')} Classes\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  className=\"justify-start\"\n                  onClick={() => {\n                    setIsImportPopoverOpen(false);\n                    setIsImportEnrollmentsDialogOpen(true);\n                  }}\n                >\n                  {tImport('title')} Enrollments\n                </Button>\n              </div>\n            </PopoverContent>\n          </Popover>\n          <Button\n            onClick={() => setIsCreateDialogOpen(true)}\n            className=\"w-full sm:w-auto\"\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            {t('create_button')}\n          </Button>\n        </div>\n      </div>\n\n      {/* Table */}\n      <ClassTable\n        columns={columns}\n        data={classes}\n        isLoading={isLoading}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={pageSize}\n        onPageChange={handlePageChange}\n      />\n\n      {/* Dialogs */}\n      <ClassFormDialog\n        open={isCreateDialogOpen}\n        onOpenChange={setIsCreateDialogOpen}\n        onSubmit={handleCreate}\n        isSubmitting={createMutation.isPending}\n        availableSemesters={availableSemesters}\n        availableSubjects={availableSubjects}\n      />\n\n      <ClassFormDialog\n        open={isEditDialogOpen}\n        onOpenChange={setIsEditDialogOpen}\n        classItem={selectedClass}\n        isLoadingClass={isLoadingClass}\n        onSubmit={handleUpdate}\n        onDelete={handleDeleteFromDialog}\n        isSubmitting={updateMutation.isPending}\n        isDeleting={deleteMutation.isPending}\n        availableSemesters={availableSemesters}\n        availableSubjects={availableSubjects}\n      />\n\n      <DeleteClassDialog\n        open={isDeleteDialogOpen}\n        onOpenChange={setIsDeleteDialogOpen}\n        classItem={deleteTargetClass}\n        onConfirm={handleConfirmDelete}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      <GenericImportDialog\n        open={isImportClassesDialogOpen}\n        onOpenChange={setIsImportClassesDialogOpen}\n        title={`${tImport('title')} Classes`}\n        csvColumns={[\"code\", \"subject_code\", \"semester_code\", \"status\"]}\n        importMutation={importClassesMutation}\n        successMessage={tImport('success_message')}\n        entityName=\"classes\"\n      />\n\n      <GenericImportDialog\n        open={isImportEnrollmentsDialogOpen}\n        onOpenChange={setIsImportEnrollmentsDialogOpen}\n        title={`${tImport('title')} Enrollments`}\n        csvColumns={[\"roll_number\", \"class_code\", \"semester_code\"]}\n        importMutation={importEnrollmentsMutation}\n        successMessage={tImport('success_message')}\n        entityName=\"enrollments\"\n      />\n    </div>\n  );\n}\n\nexport default function ClassesPage() {\n  const t = useTranslations('class');\n\n  return (\n    <Suspense fallback={<div>{t('loading')}</div>}>\n      <ClassesContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\dashboard\\page.tsx",
      "relative_path": "app/admin/dashboard/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 8972,
      "lines": 243,
      "last_modified": "2025-11-19T16:57:13.670719",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useMemo, useRef } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { useTranslations } from 'next-intl';\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Users,\n  BookOpen,\n  Calendar,\n  GraduationCap,\n  TrendingUp,\n  Loader2,\n  CheckCircle2,\n  UserCheck,\n} from \"lucide-react\";\nimport { useDataOperatorDashboard } from \"@/hooks/api/useDataOperatorDashboard\";\n\nexport default function DashboardPage() {\n  const t = useTranslations('dashboard');\n  const tCommon = useTranslations('common');\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n\n  // Get semester from URL\n  const semesterIdParam = searchParams.get(\"semesterId\");\n\n  // Fetch dashboard data (initially without semester filter to get all semesters)\n  const { data, isLoading } = useDataOperatorDashboard(\n    semesterIdParam ? Number(semesterIdParam) : undefined\n  );\n\n  const stats = (data as any)?.stats;\n\n  // Memoize semesters to prevent unnecessary re-renders\n  const semesters = useMemo(() => (data as any)?.semesters || [], [data]);\n\n  // Track if auto-select has been done to prevent re-triggering when user clears filter\n  const hasAutoSelected = useRef(false);\n\n  // Calculate current semester (start_date <= now <= end_date)\n  const currentSemester = useMemo(() => {\n    if (!semesters || semesters.length === 0) return null;\n\n    const now = new Date();\n    return semesters.find((s: any) => {\n      const start = new Date(s.startDate);\n      const end = new Date(s.endDate);\n      return now >= start && now <= end;\n    });\n  }, [semesters]);\n\n  // Get selected semester from URL\n  const selectedSemesterId = semesterIdParam\n    ? Number(semesterIdParam)\n    : undefined;\n\n  // Update URL when semester changes\n  const updateSemester = (semesterId: string) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n    if (semesterId === \"all\") {\n      newParams.delete(\"semesterId\");\n    } else {\n      newParams.set(\"semesterId\", semesterId);\n    }\n    router.push(`${pathname}?${newParams.toString()}`, { scroll: false });\n  };\n\n  // Auto-select current semester ONLY ONCE on initial load if no semester filter is set\n  useEffect(() => {\n    if (!semesterIdParam && currentSemester && !isLoading && !hasAutoSelected.current) {\n      hasAutoSelected.current = true;\n      updateSemester(currentSemester.id.toString());\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [currentSemester, semesterIdParam, isLoading]);\n\n  // Reset hasAutoSelected on unmount to allow auto-selection on next mount\n  useEffect(() => {\n    return () => {\n      hasAutoSelected.current = false;\n    };\n  }, []);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n        <span className=\"ml-2\">{tCommon('loading')}</span>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Page Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold tracking-tight\">{t('title')}</h2>\n          <p className=\"text-muted-foreground\">\n            {t('welcome')}\n          </p>\n        </div>\n        <Select\n          value={selectedSemesterId?.toString() || \"all\"}\n          onValueChange={updateSemester}\n          disabled={isLoading}\n        >\n          <SelectTrigger className=\"w-[200px]\">\n            <SelectValue placeholder={t('select_semester')} />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">{t('all_semesters')}</SelectItem>\n            {semesters.map((semester: any) => (\n              <SelectItem key={semester.id} value={semester.id.toString()}>\n                {semester.code} - {semester.name}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Stats Grid */}\n      {stats && (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n          {/* Total Classes */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">\n                {t('total_classes')}\n              </CardTitle>\n              <BookOpen className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.totalClasses}</div>\n              <p className=\"text-xs text-muted-foreground\">\n                {stats.activeClasses} {tCommon('active').toLowerCase()}\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* Total Students */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">\n                {t('total_students')}\n              </CardTitle>\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.totalStudents}</div>\n              <p className=\"text-xs text-muted-foreground\">\n                {stats.activeStudents} {tCommon('active').toLowerCase()}\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* Total Subjects */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">\n                {t('total_subjects')}\n              </CardTitle>\n              <GraduationCap className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.totalSubjects}</div>\n              <p className=\"text-xs text-muted-foreground\">{t('across_all_majors')}</p>\n            </CardContent>\n          </Card>\n\n          {/* Total Lecturers */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">\n                {t('total_lecturers')}\n              </CardTitle>\n              <UserCheck className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.totalLecturers}</div>\n              <p className=\"text-xs text-muted-foreground\">{t('teaching_staff')}</p>\n            </CardContent>\n          </Card>\n\n          {/* Total Slots */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">{t('total_slots')}</CardTitle>\n              <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.totalSlots}</div>\n              <p className=\"text-xs text-muted-foreground\">\n                {t('scheduled_sessions')}\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* Completion Rate */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">\n                {t('completion_rate')}\n              </CardTitle>\n              <CheckCircle2 className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">\n                {Math.round(stats.slotsCompletionRate)}%\n              </div>\n              <p className=\"text-xs text-muted-foreground\">{t('slots_completed')}</p>\n            </CardContent>\n          </Card>\n\n          {/* Avg Students Per Class */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">\n                {t('avg_students')}\n              </CardTitle>\n              <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">\n                {Math.round(stats.averageStudentsPerClass)}\n              </div>\n              <p className=\"text-xs text-muted-foreground\">{t('per_class')}</p>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\exams\\[id]\\participants\\page.tsx",
      "relative_path": "app/admin/exams/[id]/participants/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 16897,
      "lines": 474,
      "last_modified": "2025-11-11T12:20:05.558182",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useState, useEffect, useMemo } from \"react\";\nimport { useParams } from \"next/navigation\";\nimport {\n  Search,\n  Filter,\n  UserPlus,\n  // TODO: Uncomment when CSV bulk import is implemented\n  // Upload,\n  // FileSpreadsheet,\n} from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuCheckboxItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { ExamParticipantsTable } from \"@/components/admin/exams/exam-participants-table\";\nimport { BulkAddParticipantsDialog } from \"@/components/admin/exams/bulk-add-participants-dialog\";\nimport { ExamParticipant } from \"@/types\";\nimport {\n  useGetAllExamParticipants,\n  useUpdateExamParticipant,\n  useDeleteExamParticipant,\n  useBulkAddExamParticipants,\n  // TODO: CSV bulk import hooks - lines 802-976, 981-1006 in API docs\n  // useDownloadExamParticipantTemplate,\n} from \"@/hooks/api/useExamParticipants\";\nimport {\n  useGetExamSlotSubjects,\n} from \"@/hooks/api/useExamSlotSubjects\";\nimport { useGetSlot } from \"@/hooks/api/useSlots\";\nimport {\n  useGetSemesterStudents,\n} from \"@/hooks/api/useSemesters\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { buildExamsPageUrl } from \"@/lib/navigation-state\";\nimport { format } from \"date-fns\";\n\nfunction ParticipantsContent() {\n  const params = useParams();\n  const slotId = Number(params.id);\n  // TODO: Uncomment when CSV bulk import is implemented\n  // const fileInputRef = useRef<HTMLInputElement>(null);\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // Dialog states\n  const [isBulkAddDialogOpen, setIsBulkAddDialogOpen] = useState(false);\n  const [isConfirmDialogOpen, setIsConfirmDialogOpen] = useState(false);\n\n  // Selected items\n  const [selectedParticipant, setSelectedParticipant] =\n    useState<ExamParticipant | null>(null);\n  const [confirmAction, setConfirmAction] = useState<\n    \"withdraw\" | \"reenroll\" | \"remove\"\n  >(\"withdraw\");\n\n  // Add participant form state\n\n  // Bulk add form state\n  const [bulkAddSubjectId, setBulkAddSubjectId] = useState<string>(\"\");\n\n  // Search & Filters\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState<string[]>([\n    \"enrolled\",\n    \"withdrawn\",\n  ]);\n\n  // Fetch data\n  const { data: slotData } = useGetSlot(slotId);\n  const { data: participantsData, isLoading } = useGetAllExamParticipants(slotId);\n  const { data: subjectsData } = useGetExamSlotSubjects(slotId);\n\n  // Fetch semester subjects and students for smart add functionality\n  const semesterId =\n    slotData?.semester?.id ?? slotData?.class?.semester?.id ?? 0;\n  // For bulk add dialog - fetch all students (no pagination limit)\n  const {\n    data: bulkAddStudentsData,\n    isLoading: isBulkStudentsLoading,\n  } = useGetSemesterStudents(\n    semesterId,\n    {\n      subjectId: bulkAddSubjectId ? parseInt(bulkAddSubjectId) : undefined,\n      isActive: true,\n      pageSize: 1000, // Fetch up to 1000 students (no practical limit)\n    },\n    !!semesterId && !!bulkAddSubjectId\n  );\n\n  // Mutations\n  const updateMutation = useUpdateExamParticipant(\n    slotId,\n    selectedParticipant?.id || 0 // âœ… Changed: studentUserId -> participantId\n  );\n  const deleteMutation = useDeleteExamParticipant(\n    slotId,\n    selectedParticipant?.id || 0 // âœ… Changed: studentUserId -> participantId\n  );\n  const bulkAddMutation = useBulkAddExamParticipants(slotId);\n\n  // TODO: CSV Bulk Import features (API docs lines 802-976, 981-1006)\n  // const downloadTemplateMutation = useDownloadExamParticipantTemplate(slotId);\n\n  const participants: ExamParticipant[] = participantsData?.items || [];\n  const totalEnrolled = participantsData?.totalEnrolled || 0;\n  const totalWithdrawn = participantsData?.totalWithdrawn || 0;\n  const bulkAddStudents = bulkAddStudentsData?.items || [];\n\n  const assignedSubjects = useMemo(() => {\n    if (!subjectsData?.subjects) return [];\n\n    // âœ… Map subjects array to ExamSlotSubject format for compatibility with BulkAddParticipantsDialog\n    // API returns: { slotId, subjects: Subject[], totalSubjects }\n    // Component expects: ExamSlotSubject[] = { id, slotId, subject: Subject, createdAt }[]\n    return subjectsData.subjects.map((subject, index) => ({\n      id: index, // Temporary ID (not used by component)\n      slotId: subjectsData.slotId,\n      subject: {\n        ...subject,\n        isActive: true,\n      },\n      createdAt: new Date().toISOString(),\n    }));\n  }, [subjectsData]);\n\n  // Update page header when slot data is loaded\n  useEffect(() => {\n    if (slotData) {\n      setPageHeader({\n        title: \"Exam Participants\",\n        subtitle: `${slotData.title || \"Untitled Exam\"} â€¢ ${format(\n          new Date(slotData.startTime),\n          \"PPP 'at' p\"\n        )} - ${format(new Date(slotData.endTime), \"p\")} â€¢ Room: ${\n          slotData.room.name\n        }${slotData.room.location ? ` (${slotData.room.location})` : \"\"}`,\n        breadcrumbs: [\n          { label: \"Dashboard\", href: \"/admin/dashboard\" },\n          { label: \"Exams\", href: buildExamsPageUrl() }, // âœ… Use saved state if available\n          { label: slotData.title || \"Untitled Exam\" },\n        ],\n      });\n    }\n\n    return () => {\n      clearPageHeader();\n      // Note: Don't clear exams page state here to preserve query params when navigating back\n      // The state will be cleared when navigating away from the exams flow entirely\n    };\n  }, [slotData, setPageHeader, clearPageHeader]);\n\n  // Filter participants based on search and status\n  const filteredParticipants = participants.filter((p) => {\n    const matchesSearch =\n      !searchQuery ||\n      p.fullName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n      (p.rollNumber?.toLowerCase().includes(searchQuery.toLowerCase()) ?? false) ||\n      p.email.toLowerCase().includes(searchQuery.toLowerCase());\n\n    const matchesStatus =\n      (statusFilter.includes(\"enrolled\") && p.isEnrolled) ||\n      (statusFilter.includes(\"withdrawn\") && !p.isEnrolled);\n\n    return matchesSearch && matchesStatus;\n  });\n\n  const handleWithdraw = (participant: ExamParticipant) => {\n    setSelectedParticipant(participant);\n    setConfirmAction(\"withdraw\");\n    setIsConfirmDialogOpen(true);\n  };\n\n  const handleReEnroll = (participant: ExamParticipant) => {\n    setSelectedParticipant(participant);\n    setConfirmAction(\"reenroll\");\n    setIsConfirmDialogOpen(true);\n  };\n\n  const handleRemove = (participant: ExamParticipant) => {\n    setSelectedParticipant(participant);\n    setConfirmAction(\"remove\");\n    setIsConfirmDialogOpen(true);\n  };\n\n  const handleConfirm = async () => {\n    if (!selectedParticipant) return;\n\n    if (confirmAction === \"remove\") {\n      await deleteMutation.mutateAsync();\n    } else {\n      await updateMutation.mutateAsync({\n        isEnrolled: confirmAction === \"reenroll\",\n      });\n    }\n\n    setIsConfirmDialogOpen(false);\n    setSelectedParticipant(null);\n  };\n\n  // TODO: CSV Bulk Import - Uncomment when hooks are implemented\n  // const handleFileUpload = async (\n  //   event: React.ChangeEvent<HTMLInputElement>\n  // ) => {\n  //   const file = event.target.files?.[0];\n  //   if (!file) return;\n  //\n  //   await bulkAddMutation.mutateAsync(file);\n  //\n  //   // Reset file input\n  //   if (fileInputRef.current) {\n  //     fileInputRef.current.value = \"\";\n  //   }\n  // };\n\n  // const handleDownloadTemplate = () => {\n  //   downloadTemplateMutation.mutate();\n  // };\n\n  const handleBulkAddConfirm = async (studentUserIds: number[]) => {\n    if (!bulkAddSubjectId || studentUserIds.length === 0) return;\n\n    // Create student map for better error reporting\n    const studentMap = new Map(\n      bulkAddStudents.map((s) => [\n        s.userId,\n        { rollNumber: s.rollNumber, fullName: s.fullName },\n      ])\n    );\n\n    try {\n      await bulkAddMutation.mutateAsync({\n        subjectId: parseInt(bulkAddSubjectId),\n        studentUserIds,\n        studentMap,\n      });\n\n      // Close dialog and reset state on success\n      setIsBulkAddDialogOpen(false);\n      setBulkAddSubjectId(\"\");\n    } catch (error) {\n      // Error already handled by mutation's onError callback\n      console.error(\"Bulk add error:\", error);\n    }\n  };\n\n  const handleBulkAddSubjectChange = (subjectId: string) => {\n    setBulkAddSubjectId(subjectId);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Stats */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        <div className=\"rounded-lg border p-4\">\n          <div className=\"text-2xl font-bold\">{totalEnrolled}</div>\n          <p className=\"text-sm text-muted-foreground\">Enrolled</p>\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <div className=\"text-2xl font-bold\">{totalWithdrawn}</div>\n          <p className=\"text-sm text-muted-foreground\">Withdrawn</p>\n        </div>\n        <div className=\"rounded-lg border p-4\">\n          <div className=\"text-2xl font-bold\">\n            {totalEnrolled + totalWithdrawn}\n          </div>\n          <p className=\"text-sm text-muted-foreground\">Total</p>\n        </div>\n      </div>\n\n      {/* Search & Actions Bar */}\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\n        <div className=\"flex flex-1 items-center gap-2\">\n          <div className=\"relative flex-1 max-w-md\">\n            <Search className=\"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground\" />\n            <Input\n              placeholder=\"Search by name, roll number, or email...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"pl-9\"\n              autoComplete=\"off\"\n            />\n          </div>\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" size=\"icon\">\n                <Filter className=\"h-4 w-4\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"start\" className=\"w-48\">\n              <DropdownMenuLabel>Filter by Status</DropdownMenuLabel>\n              <DropdownMenuSeparator />\n              <DropdownMenuCheckboxItem\n                checked={statusFilter.includes(\"enrolled\")}\n                onCheckedChange={(checked) => {\n                  setStatusFilter((prev) =>\n                    checked\n                      ? [...prev, \"enrolled\"]\n                      : prev.filter((s) => s !== \"enrolled\")\n                  );\n                }}\n              >\n                Enrolled\n              </DropdownMenuCheckboxItem>\n              <DropdownMenuCheckboxItem\n                checked={statusFilter.includes(\"withdrawn\")}\n                onCheckedChange={(checked) => {\n                  setStatusFilter((prev) =>\n                    checked\n                      ? [...prev, \"withdrawn\"]\n                      : prev.filter((s) => s !== \"withdrawn\")\n                  );\n                }}\n              >\n                Withdrawn\n              </DropdownMenuCheckboxItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n        <div className=\"flex flex-wrap gap-2\">\n          <Button\n            variant=\"default\"\n            onClick={() => setIsBulkAddDialogOpen(true)}\n          >\n            <UserPlus className=\"mr-2 h-4 w-4\" />\n            Add Participants\n          </Button>\n          {/* TODO: CSV Bulk Import - Uncomment when hooks are implemented */}\n          {/* <Button\n            className=\"bg-green-600 hover:bg-green-700 text-white\"\n            onClick={handleDownloadTemplate}\n          >\n            <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n            Download Template\n          </Button>\n          <Button\n            className=\"bg-green-600 hover:bg-green-700 text-white\"\n            onClick={() => fileInputRef.current?.click()}\n            disabled={bulkAddMutation.isPending}\n          >\n            <Upload className=\"mr-2 h-4 w-4\" />\n            {bulkAddMutation.isPending ? \"Uploading...\" : \"Import from Excel\"}\n          </Button>\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept=\".csv\"\n            onChange={handleFileUpload}\n            className=\"hidden\"\n          /> */}\n        </div>\n      </div>\n\n      {/* Participants Table */}\n      <ExamParticipantsTable\n        participants={filteredParticipants}\n        isLoading={isLoading}\n        onWithdraw={handleWithdraw}\n        onReEnroll={handleReEnroll}\n        onRemove={handleRemove}\n      />\n\n      {/* Confirm Action Dialog */}\n      <AlertDialog\n        open={isConfirmDialogOpen}\n        onOpenChange={setIsConfirmDialogOpen}\n      >\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>\n              {confirmAction === \"remove\"\n                ? \"Remove Participant\"\n                : confirmAction === \"withdraw\"\n                ? \"Withdraw Participant\"\n                : \"Re-enroll Participant\"}\n            </AlertDialogTitle>\n            <AlertDialogDescription asChild>\n              <div className=\"space-y-3\">\n                {selectedParticipant && (\n                  <div className=\"rounded-lg border p-3 space-y-1 bg-muted/50\">\n                    <div>\n                      <span className=\"font-semibold\">Name:</span>{\" \"}\n                      {selectedParticipant.fullName}\n                    </div>\n                    <div>\n                      <span className=\"font-semibold\">Roll Number:</span>{\" \"}\n                      {selectedParticipant.rollNumber || \"N/A\"}\n                    </div>\n                    <div>\n                      <span className=\"font-semibold\">Email:</span>{\" \"}\n                      {selectedParticipant.email}\n                    </div>\n                  </div>\n                )}\n                {confirmAction === \"remove\" ? (\n                  <p className=\"text-sm text-destructive\">\n                    This will permanently remove the participant and all their\n                    attendance records. This action cannot be undone. Consider\n                    using withdraw instead.\n                  </p>\n                ) : confirmAction === \"withdraw\" ? (\n                  <p className=\"text-sm\">\n                    The participant will be marked as withdrawn and will not\n                    appear in future rosters. Attendance history will be\n                    preserved.\n                  </p>\n                ) : (\n                  <p className=\"text-sm\">\n                    The participant will be re-enrolled and will appear in\n                    future rosters.\n                  </p>\n                )}\n              </div>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancel</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={handleConfirm}\n              className={\n                confirmAction === \"remove\"\n                  ? \"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                  : \"\"\n              }\n            >\n              {confirmAction === \"remove\"\n                ? \"Remove\"\n                : confirmAction === \"withdraw\"\n                ? \"Withdraw\"\n                : \"Re-enroll\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Bulk Add Participants Dialog */}\n      <BulkAddParticipantsDialog\n        open={isBulkAddDialogOpen}\n        onOpenChange={setIsBulkAddDialogOpen}\n        assignedSubjects={assignedSubjects}\n        semesterStudents={bulkAddStudents}\n        existingParticipants={participants}\n        isLoadingStudents={isBulkStudentsLoading}\n        onSubjectChange={handleBulkAddSubjectChange}\n        onConfirm={handleBulkAddConfirm}\n        isPending={bulkAddMutation.isPending}\n      />\n    </div>\n  );\n}\n\nexport default function ExamParticipantsPage() {\n  return (\n    <Suspense fallback={<div>Loading...</div>}>\n      <ParticipantsContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\exams\\[id]\\roster\\page.tsx",
      "relative_path": "app/admin/exams/[id]/roster/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 5551,
      "lines": 169,
      "last_modified": "2025-11-13T21:14:04.078534",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useParams } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport {\n  SlotRosterTable,\n  type PendingChange,\n} from \"@/components/admin/slots/slot-roster-table\";\nimport { SessionControls } from \"@/components/admin/slots/session-controls\";\nimport { EvidenceViewerDialog } from \"@/components/admin/slots/evidence-viewer-dialog\";\nimport { useGetSlot } from \"@/hooks/api/useSlots\";\nimport { useGetSlotRoster } from \"@/hooks/api/useSlotRoster\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { buildExamsPageUrl } from \"@/lib/navigation-state\";\nimport { getPrimaryRole } from \"@/lib/role-permissions\";\n\nexport default function ExamSlotRosterPage() {\n  const params = useParams();\n  const slotId = Number(params.id);\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const userRole = getPrimaryRole();\n\n  const { data: slot, isLoading: isLoadingSlot } = useGetSlot(slotId);\n  const { data: roster, isLoading: isLoadingRoster } = useGetSlotRoster(slotId);\n\n  // Pending changes state for inline editing\n  const [pendingChanges, setPendingChanges] = useState<\n    Map<string, PendingChange>\n  >(new Map());\n\n  const [evidenceDialogOpen, setEvidenceDialogOpen] = useState(false);\n  const [avatarImageUrl, setAvatarImageUrl] = useState<string>(\"\");\n  const [evidenceImageUrl, setEvidenceImageUrl] = useState<string | null>(null);\n  const [studentName, setStudentName] = useState<string>(\"\");\n\n  const handleViewEvidence = (\n    avatarUrl: string,\n    evidenceUrl: string | null,\n    name: string\n  ) => {\n    setAvatarImageUrl(avatarUrl);\n    setEvidenceImageUrl(evidenceUrl);\n    setStudentName(name);\n    setEvidenceDialogOpen(true);\n  };\n\n  const handlePendingChange = (\n    recordId: number,\n    attendanceType: \"REGULAR\" | \"EXAM\",\n    status: \"present\" | \"absent\" | \"not_yet\",\n    remark?: string\n  ) => {\n    const newPendingChanges = new Map(pendingChanges);\n    const pendingChangeKey = `${attendanceType}-${recordId}`;\n    newPendingChanges.set(pendingChangeKey, { status, remark });\n    setPendingChanges(newPendingChanges);\n  };\n\n  const clearPendingChanges = () => {\n    setPendingChanges(new Map());\n  };\n\n  // Set page header (placeholder on mount, detailed after load)\n  useEffect(() => {\n    const parentLabel = \"Exams\";\n    const parentHref = buildExamsPageUrl();\n\n    if (!slot) {\n      setPageHeader({\n        title: \"Exam Roster\",\n        subtitle: \"Loading exam details...\",\n        breadcrumbs: [\n          { label: \"Dashboard\", href: \"/admin/dashboard\" },\n          { label: parentLabel, href: parentHref },\n          { label: \"Exam Roster\" },\n        ],\n      });\n      return;\n    }\n\n    const getCategoryLabel = (category: string) => {\n      const labels = {\n        LECTURE: \"Lecture\",\n        LECTURE_WITH_PT: \"Lecture with PT\",\n        FINAL_EXAM: \"Final Exam\",\n      };\n      return labels[category as keyof typeof labels] || category;\n    };\n\n    setPageHeader({\n      title: slot.title || \"Untitled Slot\",\n      subtitle: `${slot.class?.code || \"\"} â€¢ ${getCategoryLabel(\n        slot.slotCategory\n      )} â€¢ ${format(new Date(slot.startTime), \"MMM d, yyyy\")} â€¢ ${format(\n        new Date(slot.startTime),\n        \"h:mm a\"\n      )} - ${format(new Date(slot.endTime), \"h:mm a\")} â€¢ ${slot.room.name}`,\n      breadcrumbs: [\n        { label: \"Dashboard\", href: \"/admin/dashboard\" },\n        { label: parentLabel, href: parentHref },\n        { label: slot.title || \"Untitled Slot\" },\n      ],\n    });\n  }, [slot, setPageHeader]);\n\n  // Clear header on unmount\n  useEffect(() => {\n    return () => {\n      clearPageHeader();\n    };\n  }, [clearPageHeader]);\n\n  if (isLoadingSlot || isLoadingRoster) {\n    return (\n      <div className=\"space-y-6\">\n        <Skeleton className=\"h-10 w-full\" />\n        <Skeleton className=\"h-32 w-full\" />\n        <Skeleton className=\"h-96 w-full\" />\n      </div>\n    );\n  }\n\n  if (!slot || !roster) {\n    return (\n      <div className=\"flex flex-col items-center justify-center min-h-[400px] gap-4\">\n        <p className=\"text-muted-foreground\">Exam slot not found</p>\n      </div>\n    );\n  }\n\n  // Check if session is running (to disable editing)\n  // Note: This page uses SessionControls (regular) but shows EXAM attendance\n  const isRegularRunning = slot.sessionStatus === \"RUNNING\";\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Session Controls + Roster Table - Merged into one Card */}\n      <SessionControls\n        slot={slot}\n        roster={roster}\n        pendingChanges={pendingChanges}\n        onSubmitSuccess={clearPendingChanges}\n        userRole={userRole ?? undefined}\n      >\n        <SlotRosterTable\n          data={roster}\n          slot={slot}\n          attendanceType=\"EXAM\"\n          pendingChanges={pendingChanges}\n          onPendingChange={handlePendingChange}\n          onViewEvidence={handleViewEvidence}\n          userRole={userRole ?? undefined}\n          isSessionRunning={isRegularRunning}\n        />\n      </SessionControls>\n\n      {/* Evidence Viewer Dialog */}\n      <EvidenceViewerDialog\n        open={evidenceDialogOpen}\n        onOpenChange={setEvidenceDialogOpen}\n        avatarUrl={avatarImageUrl}\n        evidenceUrl={evidenceImageUrl}\n        studentName={studentName}\n      />\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\exams\\page.tsx",
      "relative_path": "app/admin/exams/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 44570,
      "lines": 1194,
      "last_modified": "2025-11-14T19:02:17.580115",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useState, useMemo } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport {\n  Plus,\n  CalendarIcon,\n  SlidersHorizontal,\n  FileSpreadsheet,\n  Users,\n} from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { Button } from \"@/components/ui/button\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { ExamTable } from \"@/components/admin/exams/exam-table\";\nimport { createExamColumns } from \"@/components/admin/exams/exam-columns\";\nimport {\n  ExamFormDialog,\n  ExamFormData,\n} from \"@/components/admin/exams/exam-form-dialog\";\nimport { DeleteSlotDialog } from \"@/components/admin/slots/delete-slot-dialog\";\nimport GenericImportDialog from \"@/components/admin/shared/generic-import-dialog\";\nimport { Slot } from \"@/types\";\nimport {\n  useGetSlots,\n  useCreateSlot,\n  useUpdateSlot,\n  useDeleteSlot,\n  useImportExamSlots,\n} from \"@/hooks/api/useSlots\";\nimport { useImportExamSlotParticipants } from \"@/hooks/api/useExamSlotParticipants\";\nimport { useGetSemesters } from \"@/hooks/api/useSemesters\";\nimport { useGetSubjects } from \"@/hooks/api/useSubjects\";\nimport { useGetRooms } from \"@/hooks/api/useRooms\";\nimport { useGetStaffProfiles } from \"@/hooks/api/useStaffProfiles\";\nimport { DEFAULT_PAGE_SIZE, FILTER_PAGE_SIZE } from \"@/lib/constants\";\nimport {\n  saveExamsPageState,\n  getExamsPageState,\n  clearExamsPageState,\n  saveNavigationContext,\n  clearNavigationContext,\n  getNavigationContext,\n  shouldRestoreExamsPageState,\n} from \"@/lib/navigation-state\";\nimport { format } from \"date-fns\";\nimport { cn } from \"@/lib/utils\";\n\nfunction ExamsContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // URL params\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const sortBy = (\n    [\"startTime\", \"endTime\", \"slotCategory\"].includes(\n      searchParams.get(\"sortBy\") || \"\"\n    )\n      ? searchParams.get(\"sortBy\")\n      : \"startTime\"\n  ) as \"startTime\" | \"endTime\" | \"slotCategory\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n\n  // Filters - Semester is REQUIRED\n  const semesterIdParam = searchParams.get(\"semesterId\");\n\n  const subjectIdParam = searchParams.get(\"subjectId\");\n  const subjectIdFilter = subjectIdParam ? Number(subjectIdParam) : undefined;\n\n  const roomIdParam = searchParams.get(\"roomId\");\n  const roomIdFilter = roomIdParam ? Number(roomIdParam) : undefined;\n\n  const staffUserIdParam = searchParams.get(\"staffUserId\");\n  const staffUserIdFilter = staffUserIdParam\n    ? Number(staffUserIdParam)\n    : undefined;\n\n  const isActiveParam = searchParams.get(\"isActive\");\n  const isActiveFilter =\n    isActiveParam === \"false\"\n      ? false\n      : isActiveParam === \"true\"\n      ? true\n      : undefined; // Default to all\n\n  // Date range filters\n  const startTimeFromParam = searchParams.get(\"startTimeFrom\");\n  const startTimeToParam = searchParams.get(\"startTimeTo\");\n\n  // Combobox open states\n  const [semesterFilterOpen, setSemesterFilterOpen] = useState(false);\n  const [subjectFilterOpen, setSubjectFilterOpen] = useState(false);\n  const [roomFilterOpen, setRoomFilterOpen] = useState(false);\n  const [semesterFilterQuery, setSemesterFilterQuery] = useState(\"\");\n  const [subjectFilterQuery, setSubjectFilterQuery] = useState(\"\");\n  const [roomFilterQuery, setRoomFilterQuery] = useState(\"\");\n  const [staffFilterOpen, setStaffFilterOpen] = useState(false);\n  const [staffFilterQuery, setStaffFilterQuery] = useState(\"\");\n\n  // Advanced filters popover state\n  const [advancedFiltersOpen, setAdvancedFiltersOpen] = useState(false);\n\n  // Date picker states\n  const [startDateOpen, setStartDateOpen] = useState(false);\n  const [endDateOpen, setEndDateOpen] = useState(false);\n\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [selectedExam, setSelectedExam] = useState<Slot | null>(null);\n\n  // Import popover and dialog states\n  const [importPopoverOpen, setImportPopoverOpen] = useState(false);\n  const [isImportExamSlotsDialogOpen, setIsImportExamSlotsDialogOpen] =\n    useState(false);\n  const [isImportParticipantsDialogOpen, setIsImportParticipantsDialogOpen] =\n    useState(false);\n  useEffect(() => {\n    if (!semesterFilterOpen) setSemesterFilterQuery(\"\");\n  }, [semesterFilterOpen]);\n  useEffect(() => {\n    if (!subjectFilterOpen) setSubjectFilterQuery(\"\");\n  }, [subjectFilterOpen]);\n  useEffect(() => {\n    if (!roomFilterOpen) setRoomFilterQuery(\"\");\n  }, [roomFilterOpen]);\n\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    // Only add sortBy and sort if semester is selected\n    const hasSemester = newParams.has(\"semesterId\");\n    if (hasSemester) {\n      if (!newParams.has(\"sortBy\")) {\n        newParams.set(\"sortBy\", sortBy);\n      }\n      if (!newParams.has(\"sort\")) {\n        newParams.set(\"sort\", sortOrder);\n      }\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  // Function to handle state restoration logic\n  const handleStateRestoration = (\n    currentParams: URLSearchParams,\n    pathname: string,\n    router: ReturnType<typeof useRouter>\n  ) => {\n    // Use the helper function to check if we should restore state\n    // This ensures we ONLY restore when coming from temporary navigation (participants/roster)\n    // and NOT when navigating from other screens (subjects, dashboard, etc.)\n    if (shouldRestoreExamsPageState(currentParams, pathname)) {\n      const savedState = getExamsPageState();\n      if (savedState?.searchParams) {\n        // Check if the saved state has meaningful filters (semesterId is required)\n        const savedParams = new URLSearchParams(savedState.searchParams);\n        const hasMeaningfulFilters = savedParams.has(\"semesterId\");\n\n        if (hasMeaningfulFilters) {\n          router.replace(`${pathname}?${savedState.searchParams}`, {\n            scroll: false,\n          });\n          // Clear navigation context after restoring state\n          clearNavigationContext();\n          return true; // Indicate restoration happened\n        } else {\n          // If saved state doesn't have meaningful filters but we're from temp nav,\n          // still clear context to avoid issues\n          clearNavigationContext();\n        }\n      } else {\n        // No saved state but we have context - clear it\n        clearNavigationContext();\n      }\n    } else {\n      // IMPORTANT: If we're NOT restoring state (e.g., coming from menu/other screens),\n      // clear the navigation context immediately to prevent it from being used again\n      clearNavigationContext();\n    }\n    return false; // No restoration happened\n  };\n\n  // Handle state restoration when navigating back from participants/roster or breadcrumbs\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n    handleStateRestoration(currentParams, pathname, router);\n  }, [searchParams, pathname, router]);\n\n  // Legacy useEffect for initial mount - keeping for backwards compatibility\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n    handleStateRestoration(currentParams, pathname, router);\n\n    // Only add sortBy and sort if semester is selected\n    if (!semesterIdParam) {\n      return; // Don't add any params if no semester selected\n    }\n\n    const needsUpdate =\n      !currentParams.has(\"sortBy\") ||\n      !currentParams.has(\"sort\") ||\n      (page !== 1 && !currentParams.has(\"page\"));\n\n    if (needsUpdate) {\n      const newParams = new URLSearchParams();\n\n      // Add sortBy and sort only when semester is selected\n      newParams.set(\"sortBy\", sortBy);\n      newParams.set(\"sort\", sortOrder);\n\n      if (page !== 1) {\n        newParams.set(\"page\", String(page));\n      }\n\n      if (semesterIdParam) {\n        newParams.set(\"semesterId\", semesterIdParam);\n      }\n\n      if (subjectIdParam) {\n        newParams.set(\"subjectId\", subjectIdParam);\n      }\n\n      if (roomIdParam) {\n        newParams.set(\"roomId\", roomIdParam);\n      }\n\n      if (staffUserIdParam) {\n        newParams.set(\"staffUserId\", staffUserIdParam);\n      }\n\n      if (isActiveParam) {\n        newParams.set(\"isActive\", isActiveParam);\n      }\n\n      if (startTimeFromParam) {\n        newParams.set(\"startTimeFrom\", startTimeFromParam);\n      }\n\n      if (startTimeToParam) {\n        newParams.set(\"startTimeTo\", startTimeToParam);\n      }\n\n      const newURL = `${pathname}?${newParams.toString()}`;\n      router.replace(newURL, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Fetch filter options first\n  const { data: semestersData } = useGetSemesters({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"name\",\n    search: semesterFilterQuery || undefined,\n  });\n  const { data: subjectsData } = useGetSubjects({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"code\",\n    search: subjectFilterQuery || undefined,\n  });\n  const { data: roomsData } = useGetRooms({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"name\",\n    search: roomFilterQuery || undefined,\n  });\n  // Fetch staff with search filter (for advanced filter dropdown)\n  const { data: staffData } = useGetStaffProfiles({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"fullName\",\n    search: staffFilterQuery || undefined,\n    isActive: true,\n  });\n\n  // Fetch ALL staff without search filter (for form dropdown)\n  const { data: staffDataForForm } = useGetStaffProfiles({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"fullName\",\n    isActive: true,\n  });\n\n  // Extract semesters early to calculate current semester\n  const semesters = useMemo(() => semestersData?.items || [], [semestersData]);\n\n  // Calculate current semester (start_date <= now <= end_date)\n  const currentSemester = useMemo(() => {\n    if (!semesters || semesters.length === 0) return null;\n\n    const now = new Date();\n    return semesters.find((s) => {\n      const start = new Date(s.startDate);\n      const end = new Date(s.endDate);\n      return now >= start && now <= end;\n    });\n  }, [semesters]);\n\n  // Set semesterIdFilter - auto-select current semester if no param\n  const semesterIdFilter = semesterIdParam\n    ? Number(semesterIdParam)\n    : currentSemester?.id;\n\n  // Only fetch exams if semester is selected\n  const shouldFetchExams = !!semesterIdFilter;\n\n  const { data, isLoading } = useGetSlots(\n    {\n      page,\n      pageSize: DEFAULT_PAGE_SIZE,\n      sort: sortOrder,\n      sortBy: sortBy,\n      slotCategory: \"FINAL_EXAM\", // Always FINAL_EXAM\n      semesterId: semesterIdFilter,\n      subjectId: subjectIdFilter,\n      roomId: roomIdFilter,\n      staffUserId: staffUserIdFilter,\n      isActive: isActiveFilter,\n      startTimeFrom: startTimeFromParam || undefined,\n      startTimeTo: startTimeToParam || undefined,\n    },\n    {\n      enabled: shouldFetchExams, // Only fetch when semester is selected\n    }\n  );\n\n  const createMutation = useCreateSlot();\n  const updateMutation = useUpdateSlot();\n  const deleteMutation = useDeleteSlot();\n  const importExamSlotsMutation = useImportExamSlots();\n  const importParticipantsMutation = useImportExamSlotParticipants();\n\n  const exams = data?.items || [];\n  const totalPages = data?.totalPages || 1;\n  const totalItems = data?.totalItems || 0;\n  const currentPage = data?.currentPage || 1;\n  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;\n\n  const subjects = subjectsData?.items || [];\n  const rooms = roomsData?.items || [];\n  const staffForForm = (staffDataForForm?.items || [])\n    .filter((s) => s.roles.includes(\"SUPERVISOR\"))\n    .map((s) => ({ id: s.userId, fullName: s.fullName, username: s.username }));\n\n  // Auto-redirect to current semester if no param but current semester exists\n  useEffect(() => {\n    if (!semesterIdParam && currentSemester && semesters.length > 0) {\n      updateURL({\n        semesterId: currentSemester.id,\n        sortBy: sortBy,\n        sort: sortOrder,\n      });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [semesterIdParam, currentSemester, semesters]);\n\n  // Find selected items for display\n  const selectedSemester = semesters.find((s) => s.id === semesterIdFilter);\n  const selectedSubject = subjects.find((s) => s.id === subjectIdFilter);\n  const selectedRoom = rooms.find((r) => r.id === roomIdFilter);\n  const staffProfilesAll = staffData?.items || [];\n  const teachingStaff = staffProfilesAll.filter((s) =>\n    s.roles.some((r) => /LECTURER|SUPERVISOR/i.test(r))\n  );\n  const staffProfiles =\n    teachingStaff.length > 0 ? teachingStaff : staffProfilesAll;\n  const selectedStaff = staffProfiles.find(\n    (s) => s.userId === staffUserIdFilter\n  );\n\n  const handleCreate = async (data: ExamFormData) => {\n    await createMutation.mutateAsync({\n      title: data.title,\n      description: data.description,\n      startTime: data.startTime,\n      endTime: data.endTime,\n      slotCategory: \"FINAL_EXAM\", // Always FINAL_EXAM\n      semesterId: data.semesterId,\n      classId: null, // Always null for independent exams\n      roomId: data.roomId,\n      staffUserId: data.staffUserId,\n      subjectIds: data.subjectIds,\n    });\n    setIsCreateDialogOpen(false);\n    updateURL({ page: 1 });\n  };\n\n  const handleEdit = (exam: Slot) => {\n    setSelectedExam(exam);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = async (data: ExamFormData) => {\n    if (!selectedExam) return;\n\n    await updateMutation.mutateAsync({\n      id: selectedExam.id,\n      payload: {\n        title: data.title,\n        description: data.description,\n        startTime: data.startTime,\n        endTime: data.endTime,\n        slotCategory: \"FINAL_EXAM\",\n        semesterId: data.semesterId,\n        classId: null,\n        roomId: data.roomId,\n        staffUserId: data.staffUserId,\n        isActive: data.isActive!,\n        subjectIds: data.subjectIds, // Send subjects for update\n      },\n    });\n    setIsEditDialogOpen(false);\n    setSelectedExam(null);\n  };\n\n  const handleManageParticipants = (exam: Slot) => {\n    // Save current state before navigating\n    saveExamsPageState(searchParams);\n    // Mark this as temporary navigation\n    saveNavigationContext(`/admin/exams/${exam.id}/participants`, true);\n    router.push(`/admin/exams/${exam.id}/participants`);\n  };\n\n  const handleViewRoster = (exam: Slot) => {\n    // Save current state before navigating\n    saveExamsPageState(searchParams);\n    // Mark this as temporary navigation\n    saveNavigationContext(`/admin/exams/${exam.id}/roster`, true);\n    router.push(`/admin/exams/${exam.id}/roster`);\n  };\n\n  const handleSubjectClick = (subjectCode: string) => {\n    router.push(`/admin/subjects?search=${encodeURIComponent(subjectCode)}`);\n  };\n\n  const handleDeleteClick = (exam: Slot) => {\n    setSelectedExam(exam);\n    setIsDeleteDialogOpen(true);\n  };\n\n  const handleConfirmDelete = () => {\n    if (!selectedExam) return;\n\n    deleteMutation.mutate(selectedExam.id, {\n      onSuccess: () => {\n        setIsDeleteDialogOpen(false);\n        setIsEditDialogOpen(false);\n        setSelectedExam(null);\n        if (exams.length === 1 && currentPage > 1) {\n          updateURL({ page: currentPage - 1 });\n        }\n      },\n    });\n  };\n\n  const handlePageChange = (newPage: number) => {\n    updateURL({ page: newPage });\n  };\n\n  const handleSortByChange = (\n    value: \"startTime\" | \"endTime\" | \"slotCategory\"\n  ) => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  // Semester is REQUIRED - clear other filters when changed\n  const handleSemesterFilterChange = (value: string) => {\n    updateURL({\n      semesterId: value,\n      subjectId: undefined,\n      roomId: undefined,\n      staffUserId: undefined,\n      startTimeFrom: undefined,\n      startTimeTo: undefined,\n      page: 1,\n      sortBy: sortBy,\n      sort: sortOrder,\n    });\n  };\n\n  const handleSubjectFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ subjectId: undefined, page: 1 });\n    } else {\n      updateURL({ subjectId: value, page: 1 });\n    }\n  };\n\n  const handleRoomFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ roomId: undefined, page: 1 });\n    } else {\n      updateURL({ roomId: value, page: 1 });\n    }\n  };\n\n  const handleStaffFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ staffUserId: undefined, page: 1 });\n    } else {\n      updateURL({ staffUserId: value, page: 1 });\n    }\n  };\n\n  const handleIsActiveFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ isActive: undefined, page: 1 });\n    } else {\n      updateURL({ isActive: value, page: 1 });\n    }\n  };\n\n  // Date range handlers\n  const handleStartDateChange = (date: Date | undefined) => {\n    if (date) {\n      updateURL({ startTimeFrom: format(date, \"yyyy-MM-dd\"), page: 1 });\n    } else {\n      updateURL({ startTimeFrom: undefined, page: 1 });\n    }\n    setStartDateOpen(false);\n  };\n\n  const handleEndDateChange = (date: Date | undefined) => {\n    if (date) {\n      updateURL({ startTimeTo: format(date, \"yyyy-MM-dd\"), page: 1 });\n    } else {\n      updateURL({ startTimeTo: undefined, page: 1 });\n    }\n    setEndDateOpen(false);\n  };\n\n  const handleClearDateRange = () => {\n    updateURL({\n      startTimeFrom: undefined,\n      startTimeTo: undefined,\n      page: 1,\n    });\n  };\n\n  // Clear advanced filters\n  const handleClearAdvancedFilters = () => {\n    updateURL({\n      roomId: undefined,\n      staffUserId: undefined,\n      isActive: undefined,\n      page: 1,\n    });\n    setAdvancedFiltersOpen(false);\n  };\n\n  const columns = createExamColumns(\n    handleEdit,\n    handleManageParticipants,\n    handleViewRoster,\n    handleDeleteClick,\n    handleSubjectClick\n  );\n\n  // Prepare data for form dialog\n  const roomsForForm = rooms.map((r) => ({\n    id: r.id,\n    name: r.name,\n    location: r.location,\n  }));\n\n  // Set page header and handle navigation context\n  useEffect(() => {\n    setPageHeader({\n      title: \"Final Exam Management\",\n      subtitle: \"Create and manage independent final examinations.\",\n      breadcrumbs: [\n        { label: \"Dashboard\", href: \"/admin/dashboard\" },\n        { label: \"Exams\" },\n      ],\n    });\n\n    return () => {\n      clearPageHeader();\n\n      // Cleanup navigation context and state based on where we're going\n      // We need to check this in the cleanup to decide what to clear\n      const context = getNavigationContext();\n\n      // If we're leaving to participants/roster, keep the context (already handled by saveNavigationContext)\n      // Otherwise, clear everything\n      if (!context?.isTemporaryNavigation) {\n        clearNavigationContext();\n        clearExamsPageState();\n      }\n    };\n  }, [setPageHeader, clearPageHeader]);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n        {/* Main Filters */}\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Semester Filter (REQUIRED) */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Semester: <span className=\"text-destructive\">*</span>\n            </span>\n            <Popover\n              open={semesterFilterOpen}\n              onOpenChange={setSemesterFilterOpen}\n            >\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  role=\"combobox\"\n                  aria-expanded={semesterFilterOpen}\n                  className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[150px]\"\n                >\n                  <span className=\"truncate\">\n                    {selectedSemester\n                      ? `${selectedSemester.code} - ${selectedSemester.name}`\n                      : \"Select semester...\"}\n                  </span>\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent align=\"start\" className=\"w-[350px] p-0\">\n                <Command>\n                  <CommandInput\n                    placeholder=\"Type to search semester...\"\n                    value={semesterFilterQuery}\n                    onValueChange={setSemesterFilterQuery}\n                  />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>No semester found.</CommandEmpty>\n                    <CommandGroup>\n                      {semesters.map((semester) => (\n                        <CommandItem\n                          key={semester.id}\n                          value={`${semester.code}-${semester.name}`}\n                          onSelect={() => {\n                            handleSemesterFilterChange(String(semester.id));\n                            setSemesterFilterOpen(false);\n                          }}\n                        >\n                          {semester.code} - {semester.name}\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Only show other filters when semester selected */}\n          {semesterIdFilter && (\n            <>\n              {/* Date Range Filters */}\n              <div className=\"flex items-center gap-2 rounded-md border h-10 px-2 bg-background w-full sm:w-auto\">\n                {/* Start Date */}\n                <Popover open={startDateOpen} onOpenChange={setStartDateOpen}>\n                  <PopoverTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      className={cn(\n                        \"h-8 justify-start text-left font-normal px-2 w-[100px]\",\n                        !startTimeFromParam && \"text-muted-foreground\"\n                      )}\n                    >\n                      <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                      {startTimeFromParam\n                        ? format(new Date(startTimeFromParam), \"MMM d\")\n                        : \"Start\"}\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                    <Calendar\n                      mode=\"single\"\n                      selected={\n                        startTimeFromParam\n                          ? new Date(startTimeFromParam)\n                          : undefined\n                      }\n                      onSelect={handleStartDateChange}\n                      autoFocus\n                    />\n                  </PopoverContent>\n                </Popover>\n\n                <div className=\"h-6 w-px bg-border\" />\n\n                {/* End Date */}\n                <Popover open={endDateOpen} onOpenChange={setEndDateOpen}>\n                  <PopoverTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      className={cn(\n                        \"h-8 justify-start text-left font-normal px-2 w-[100px]\",\n                        !startTimeToParam && \"text-muted-foreground\"\n                      )}\n                    >\n                      <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                      {startTimeToParam\n                        ? format(new Date(startTimeToParam), \"MMM d\")\n                        : \"End\"}\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                    <Calendar\n                      mode=\"single\"\n                      selected={\n                        startTimeToParam\n                          ? new Date(startTimeToParam)\n                          : undefined\n                      }\n                      onSelect={handleEndDateChange}\n                      autoFocus\n                    />\n                  </PopoverContent>\n                </Popover>\n\n                {/* Clear Date Range Button */}\n                <>\n                  <div className=\"h-6 w-px bg-border\" />\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleClearDateRange}\n                    className=\"h-8 px-2 text-xs\"\n                  >\n                    Clear\n                  </Button>\n                </>\n              </div>\n\n              {/* Subject Filter */}\n              <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n                <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n                  Subject:\n                </span>\n                <Popover\n                  open={subjectFilterOpen}\n                  onOpenChange={setSubjectFilterOpen}\n                >\n                  <PopoverTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      role=\"combobox\"\n                      aria-expanded={subjectFilterOpen}\n                      className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[150px]\"\n                    >\n                      <span className=\"truncate\">\n                        {selectedSubject\n                          ? `${selectedSubject.code} - ${selectedSubject.name}`\n                          : \"All Subjects\"}\n                      </span>\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent align=\"start\" className=\"w-[350px] p-0\">\n                    <Command>\n                      <CommandInput\n                        placeholder=\"Type to search subject...\"\n                        value={subjectFilterQuery}\n                        onValueChange={setSubjectFilterQuery}\n                      />\n                      <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                        <CommandEmpty>No subject found.</CommandEmpty>\n                        <CommandGroup>\n                          <CommandItem\n                            value=\"all-subjects\"\n                            onSelect={() => {\n                              handleSubjectFilterChange(\"all\");\n                              setSubjectFilterOpen(false);\n                            }}\n                          >\n                            All Subjects\n                          </CommandItem>\n                          {subjects.map((subject) => (\n                            <CommandItem\n                              key={subject.id}\n                              value={`${subject.code}-${subject.name}`}\n                              onSelect={() => {\n                                handleSubjectFilterChange(String(subject.id));\n                                setSubjectFilterOpen(false);\n                              }}\n                            >\n                              {subject.code} - {subject.name}\n                            </CommandItem>\n                          ))}\n                        </CommandGroup>\n                      </CommandList>\n                    </Command>\n                  </PopoverContent>\n                </Popover>\n              </div>\n\n              {/* Advanced Filters Button */}\n              <Popover\n                open={advancedFiltersOpen}\n                onOpenChange={setAdvancedFiltersOpen}\n              >\n                <PopoverTrigger asChild>\n                  <Button variant=\"outline\" className=\"w-full sm:w-auto\">\n                    <SlidersHorizontal className=\"mr-2 h-4 w-4\" />\n                    Advanced Filters\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent align=\"end\" className=\"w-[350px]\">\n                  <div className=\"space-y-4\">\n                    <h4 className=\"font-medium text-sm\">Advanced Filters</h4>\n\n                    {/* Room Filter */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm text-muted-foreground\">\n                        Room\n                      </label>\n                      <Popover\n                        open={roomFilterOpen}\n                        onOpenChange={setRoomFilterOpen}\n                      >\n                        <PopoverTrigger asChild>\n                          <Button\n                            variant=\"outline\"\n                            role=\"combobox\"\n                            className=\"w-full justify-between\"\n                          >\n                            {selectedRoom ? selectedRoom.name : \"All Rooms\"}\n                          </Button>\n                        </PopoverTrigger>\n                        <PopoverContent className=\"w-[350px] p-0\" align=\"start\">\n                          <Command>\n                            <CommandInput\n                              placeholder=\"Search room...\"\n                              value={roomFilterQuery}\n                              onValueChange={setRoomFilterQuery}\n                            />\n                            <CommandList className=\"max-h-[200px] overflow-y-auto\">\n                              <CommandEmpty>No room found.</CommandEmpty>\n                              <CommandGroup>\n                                <CommandItem\n                                  value=\"all-rooms\"\n                                  onSelect={() => {\n                                    handleRoomFilterChange(\"all\");\n                                    setRoomFilterOpen(false);\n                                  }}\n                                >\n                                  All Rooms\n                                </CommandItem>\n                                {rooms.map((room) => (\n                                  <CommandItem\n                                    key={room.id}\n                                    value={`${room.name} ${room.location}`}\n                                    onSelect={() => {\n                                      handleRoomFilterChange(String(room.id));\n                                      setRoomFilterOpen(false);\n                                    }}\n                                  >\n                                    {room.name} - {room.location}\n                                  </CommandItem>\n                                ))}\n                              </CommandGroup>\n                            </CommandList>\n                          </Command>\n                        </PopoverContent>\n                      </Popover>\n                    </div>\n\n                    {/* Staff Filter */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm text-muted-foreground\">\n                        Staff\n                      </label>\n                      <Popover\n                        open={staffFilterOpen}\n                        onOpenChange={(open) => {\n                          if (open) setStaffFilterQuery(\"\"); // Clear when opening\n                          setStaffFilterOpen(open);\n                        }}\n                      >\n                        <PopoverTrigger asChild>\n                          <Button\n                            variant=\"outline\"\n                            role=\"combobox\"\n                            className=\"w-full justify-between\"\n                          >\n                            {selectedStaff\n                              ? selectedStaff.fullName\n                              : \"All Staff\"}\n                          </Button>\n                        </PopoverTrigger>\n                        <PopoverContent className=\"w-[350px] p-0\" align=\"start\">\n                          <Command>\n                            <CommandInput\n                              placeholder=\"Search staff...\"\n                              value={staffFilterQuery}\n                              onValueChange={setStaffFilterQuery}\n                            />\n                            <CommandList className=\"max-h-[200px] overflow-y-auto\">\n                              <CommandEmpty>No staff found.</CommandEmpty>\n                              <CommandGroup>\n                                <CommandItem\n                                  value=\"all-staff\"\n                                  onSelect={() => {\n                                    handleStaffFilterChange(\"all\");\n                                    setStaffFilterOpen(false);\n                                  }}\n                                >\n                                  All Staff\n                                </CommandItem>\n                                {staffProfiles.map((staff) => (\n                                  <CommandItem\n                                    key={staff.userId}\n                                    value={`${staff.fullName} ${staff.username}`}\n                                    onSelect={() => {\n                                      handleStaffFilterChange(\n                                        String(staff.userId)\n                                      );\n                                      setStaffFilterOpen(false);\n                                    }}\n                                  >\n                                    {staff.fullName}\n                                  </CommandItem>\n                                ))}\n                              </CommandGroup>\n                            </CommandList>\n                          </Command>\n                        </PopoverContent>\n                      </Popover>\n                    </div>\n\n                    {/* Status Filter */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm text-muted-foreground\">\n                        Status\n                      </label>\n                      <Select\n                        value={\n                          isActiveFilter === undefined\n                            ? \"all\"\n                            : isActiveFilter\n                            ? \"true\"\n                            : \"false\"\n                        }\n                        onValueChange={handleIsActiveFilterChange}\n                      >\n                        <SelectTrigger className=\"w-full\">\n                          <SelectValue placeholder=\"Status...\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"all\">All Status</SelectItem>\n                          <SelectItem value=\"true\">Active</SelectItem>\n                          <SelectItem value=\"false\">Inactive</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    {/* Sort Controls */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm text-muted-foreground\">\n                        Sort\n                      </label>\n                      <div className=\"flex gap-2\">\n                        <Select\n                          value={sortBy}\n                          onValueChange={handleSortByChange}\n                        >\n                          <SelectTrigger className=\"flex-1\">\n                            <SelectValue placeholder=\"Sort by...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"startTime\">\n                              Start Time\n                            </SelectItem>\n                            <SelectItem value=\"endTime\">End Time</SelectItem>\n                            <SelectItem value=\"slotCategory\">\n                              Category\n                            </SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <Select\n                          value={sortOrder}\n                          onValueChange={handleSortOrderChange}\n                        >\n                          <SelectTrigger className=\"flex-1\">\n                            <SelectValue placeholder=\"Order...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"asc\">Ascending</SelectItem>\n                            <SelectItem value=\"desc\">Descending</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n\n                    {/* Clear Button */}\n                    <div className=\"pt-2 border-t\">\n                      <Button\n                        variant=\"outline\"\n                        onClick={handleClearAdvancedFilters}\n                        className=\"w-full\"\n                      >\n                        Clear All Advanced Filters\n                      </Button>\n                    </div>\n                  </div>\n                </PopoverContent>\n              </Popover>\n            </>\n          )}\n        </div>\n\n        {/* Action Buttons */}\n        <div className=\"flex gap-2 w-full sm:w-auto lg:ml-4\">\n          {/* Import Popover with 2 options */}\n          <Popover open={importPopoverOpen} onOpenChange={setImportPopoverOpen}>\n            <PopoverTrigger asChild>\n              <Button className=\"flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white\">\n                <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n                Import\n              </Button>\n            </PopoverTrigger>\n            <PopoverContent align=\"end\" className=\"w-[300px] p-0\">\n              <Command>\n                <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                  <CommandGroup>\n                    <CommandItem\n                      onSelect={() => {\n                        setIsImportExamSlotsDialogOpen(true);\n                        setImportPopoverOpen(false);\n                      }}\n                    >\n                      <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                      <div>\n                        <p className=\"font-medium\">Import Exam Slots</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          Create FINAL_EXAM slots with subjects from CSV\n                        </p>\n                      </div>\n                    </CommandItem>\n                    <CommandItem\n                      onSelect={() => {\n                        setIsImportParticipantsDialogOpen(true);\n                        setImportPopoverOpen(false);\n                      }}\n                    >\n                      <Users className=\"mr-2 h-4 w-4\" />\n                      <div>\n                        <p className=\"font-medium\">Import Exam Participants</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          Add students to exam slots via CSV\n                        </p>\n                      </div>\n                    </CommandItem>\n                  </CommandGroup>\n                </CommandList>\n              </Command>\n            </PopoverContent>\n          </Popover>\n          <Button\n            onClick={() => setIsCreateDialogOpen(true)}\n            className=\"flex-1 sm:flex-none\"\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            Create Exam\n          </Button>\n        </div>\n      </div>\n\n      <ExamTable\n        columns={columns}\n        data={exams}\n        isLoading={isLoading}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={pageSize}\n        onPageChange={handlePageChange}\n      />\n\n      <ExamFormDialog\n        open={isCreateDialogOpen}\n        onOpenChange={setIsCreateDialogOpen}\n        onSubmit={handleCreate}\n        isSubmitting={createMutation.isPending}\n        semesters={semesters}\n        rooms={roomsForForm}\n        staff={staffForForm}\n      />\n\n      <ExamFormDialog\n        open={isEditDialogOpen}\n        onOpenChange={setIsEditDialogOpen}\n        exam={selectedExam || undefined}\n        onSubmit={handleUpdate}\n        isSubmitting={updateMutation.isPending}\n        semesters={semesters}\n        rooms={roomsForForm}\n        staff={staffForForm}\n      />\n\n      <DeleteSlotDialog\n        open={isDeleteDialogOpen}\n        onOpenChange={setIsDeleteDialogOpen}\n        slot={selectedExam}\n        onConfirm={handleConfirmDelete}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      {/* Import Exam Slots Dialog */}\n      <GenericImportDialog\n        open={isImportExamSlotsDialogOpen}\n        onOpenChange={setIsImportExamSlotsDialogOpen}\n        title=\"Import Exam Slots\"\n        description=\"Upload CSV file to create FINAL_EXAM slots with subjects. Format: title,start_time,end_time,slot_category,semester_code,room_name,staff_username,subject_codes (comma-separated in quotes if multiple)\"\n        csvColumns={[\n          \"title\",\n          \"start_time\",\n          \"end_time\",\n          \"slot_category\",\n          \"semester_code\",\n          \"room_name\",\n          \"staff_username\",\n          \"subject_codes\",\n        ]}\n        importMutation={importExamSlotsMutation}\n        successMessage=\"All exam slots imported successfully!\"\n        entityName=\"exam slots\"\n      />\n\n      {/* Import Participants Dialog */}\n      <GenericImportDialog\n        open={isImportParticipantsDialogOpen}\n        onOpenChange={setIsImportParticipantsDialogOpen}\n        title=\"Import Exam Participants\"\n        description=\"Upload CSV file to bulk add students to exam slots\"\n        csvColumns={[\n          \"semester_code\",\n          \"start_time\",\n          \"room_name\",\n          \"subject_code\",\n          \"roll_number\",\n        ]}\n        importMutation={importParticipantsMutation}\n        successMessage=\"All exam participants imported successfully!\"\n        entityName=\"exam participants\"\n      />\n    </div>\n  );\n}\n\nexport default function ExamsPage() {\n  return (\n    <Suspense fallback={<div>Loading...</div>}>\n      <ExamsContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\layout.tsx",
      "relative_path": "app/admin/layout.tsx",
      "filename": "layout.tsx",
      "size_bytes": 2039,
      "lines": 55,
      "last_modified": "2025-11-01T16:06:48.514735",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { AppSidebar } from \"@/components/shared/app-sidebar\";\nimport { MobileSidebar } from \"@/components/shared/mobile-sidebar\";\nimport { AppHeader } from \"@/components/shared/app-header\";\nimport { SidebarProvider } from \"@/components/shared/sidebar-context\";\nimport { PageHeaderProvider } from \"@/components/shared/page-header-context\";\nimport { RoleBasedRouteGuard } from \"@/components/auth/role-based-route-guard\";\nimport { dataOperatorMenu } from \"@/lib/menu-configs/data-operator-menu\";\n\n/**\n * Admin Portal Layout\n *\n * Shared layout for all admin pages (DATA_OPERATOR).\n * Uses the dataOperatorMenu configuration for navigation.\n * Protected by RoleBasedRouteGuard to ensure only admin roles can access.\n *\n * Pages under /admin/* will use this layout automatically.\n */\nexport default function AdminLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  // TODO: In a real app, you would determine which menu to show based on the user's role\n  // For now, we're using the Data Operator menu as default\n  const menuConfig = dataOperatorMenu;\n\n  return (\n    <RoleBasedRouteGuard allowedRoles={[\"DATA_OPERATOR\"]}>\n      <SidebarProvider>\n        <PageHeaderProvider>\n          <div className=\"flex h-screen overflow-hidden\">\n            {/* Desktop Sidebar (hidden on mobile) */}\n            <AppSidebar menuConfig={menuConfig} className=\"hidden lg:flex\" />\n\n            {/* Mobile Sidebar (Sheet overlay) */}\n            <MobileSidebar menuConfig={menuConfig} />\n\n            {/* Main Content Area */}\n            <div className=\"flex flex-1 flex-col overflow-hidden\">\n              {/* Header */}\n              <AppHeader />\n\n              {/* Page Content - Responsive padding */}\n              <main className=\"flex-1 overflow-y-auto overflow-x-hidden bg-muted/10 p-4 md:p-6\">\n                {children}\n              </main>\n            </div>\n          </div>\n        </PageHeaderProvider>\n      </SidebarProvider>\n    </RoleBasedRouteGuard>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\majors\\page.tsx",
      "relative_path": "app/admin/majors/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 13122,
      "lines": 405,
      "last_modified": "2025-11-16T19:45:43.080107",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useState } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { Plus, FileSpreadsheet } from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from 'next-intl';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { MajorTable } from \"@/components/admin/majors/major-table\";\nimport { createMajorColumns } from \"@/components/admin/majors/major-columns\";\nimport {\n  MajorFormDialog,\n  MajorFormData,\n} from \"@/components/admin/majors/major-form-dialog\";\nimport { DeleteMajorDialog } from \"@/components/admin/majors/delete-major-dialog\";\nimport GenericImportDialog from \"@/components/admin/shared/generic-import-dialog\";\nimport { Major } from \"@/types\";\nimport {\n  useGetMajors,\n  useGetMajorById,\n  useCreateMajor,\n  useUpdateMajor,\n  useDeleteMajor,\n  useImportMajors,\n} from \"@/hooks/api/useMajors\";\nimport { DEFAULT_PAGE_SIZE } from \"@/lib/constants\";\n\nfunction MajorsContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const t = useTranslations('major');\n  const tImport = useTranslations('import');\n\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const searchQuery = searchParams.get(\"search\") || \"\";\n  const sortBy = (\n    [\"name\", \"code\"].includes(searchParams.get(\"sortBy\") || \"\")\n      ? searchParams.get(\"sortBy\")\n      : \"name\"\n  ) as \"name\" | \"code\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n  const isActiveParam = searchParams.get(\"isActive\");\n  const isActiveFilter =\n    isActiveParam === \"false\"\n      ? false\n      : isActiveParam === \"true\"\n      ? true\n      : undefined; // Default to all\n\n  const [localSearchValue, setLocalSearchValue] = useState(searchQuery);\n\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n  const [selectedMajorId, setSelectedMajorId] = useState<number | null>(null);\n\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    if (!newParams.has(\"sortBy\")) {\n      newParams.set(\"sortBy\", sortBy);\n    }\n    if (!newParams.has(\"sort\")) {\n      newParams.set(\"sort\", sortOrder);\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (localSearchValue !== searchQuery) {\n        updateURL({\n          search: localSearchValue || undefined,\n          page: 1,\n        });\n      }\n    }, 500);\n\n    return () => clearTimeout(timer);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [localSearchValue, searchQuery]);\n\n  useEffect(() => {\n    setLocalSearchValue(searchQuery);\n  }, [searchQuery]);\n\n  useEffect(() => {\n    setPageHeader({\n      breadcrumbs: [\n        { label: t('breadcrumb_dashboard'), href: \"/admin/dashboard\" },\n        { label: t('breadcrumb_majors') },\n      ],\n      title: t('page_title'),\n      subtitle: t('page_subtitle'),\n    });\n\n    return () => clearPageHeader();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [t]);\n\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n    const needsUpdate =\n      !currentParams.has(\"sortBy\") ||\n      !currentParams.has(\"sort\") ||\n      (page !== 1 && !currentParams.has(\"page\"));\n\n    if (needsUpdate) {\n      const newParams = new URLSearchParams();\n\n      newParams.set(\"sortBy\", sortBy);\n      newParams.set(\"sort\", sortOrder);\n\n      if (page !== 1) {\n        newParams.set(\"page\", String(page));\n      }\n\n      if (searchQuery) {\n        newParams.set(\"search\", searchQuery);\n      }\n\n      if (isActiveParam) {\n        newParams.set(\"isActive\", isActiveParam);\n      }\n\n      const newURL = `${pathname}?${newParams.toString()}`;\n      router.replace(newURL, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const { data, isLoading } = useGetMajors({\n    page,\n    pageSize: DEFAULT_PAGE_SIZE,\n    search: searchQuery,\n    sort: sortOrder,\n    sortBy: sortBy,\n    isActive: isActiveFilter,\n  });\n\n  // Fetch selected major for editing\n  const { data: selectedMajor, isLoading: isLoadingMajor } = useGetMajorById(\n    selectedMajorId || 0\n  );\n\n  const createMutation = useCreateMajor();\n  const updateMutation = useUpdateMajor();\n  const deleteMutation = useDeleteMajor();\n  const importMutation = useImportMajors();\n\n  const majors = data?.items || [];\n  const totalPages = data?.totalPages || 1;\n  const totalItems = data?.totalItems || 0;\n  const currentPage = data?.currentPage || 1;\n  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;\n\n  const handleCreate = async (data: MajorFormData) => {\n    await createMutation.mutateAsync({\n      name: data.name,\n      code: data.code,\n    });\n    setIsCreateDialogOpen(false);\n    updateURL({ page: 1 });\n  };\n\n  const handleEdit = (major: Major) => {\n    setSelectedMajorId(major.id);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = async (data: MajorFormData) => {\n    if (!selectedMajorId) return;\n\n    await updateMutation.mutateAsync({\n      id: selectedMajorId,\n      payload: {\n        name: data.name,\n        code: data.code,\n        isActive: data.isActive!,\n      },\n    });\n    setIsEditDialogOpen(false);\n    setSelectedMajorId(null);\n  };\n\n  const handleViewSubjects = (major: Major) => {\n    router.push(`/admin/subjects?majorId=${major.id}`);\n  };\n\n  const handleDeleteFromDialog = (major: Major) => {\n    setSelectedMajorId(major.id);\n    setIsDeleteDialogOpen(true);\n  };\n\n  const handleConfirmDelete = () => {\n    if (!selectedMajorId) return;\n\n    deleteMutation.mutate(selectedMajorId, {\n      onSuccess: () => {\n        setIsDeleteDialogOpen(false);\n        setIsEditDialogOpen(false);\n        setSelectedMajorId(null);\n        if (majors.length === 1 && currentPage > 1) {\n          updateURL({ page: currentPage - 1 });\n        }\n      },\n    });\n  };\n\n  const handlePageChange = (newPage: number) => {\n    updateURL({ page: newPage });\n  };\n\n  const handleSearchChange = (value: string) => {\n    setLocalSearchValue(value);\n  };\n\n  const handleSortByChange = (value: \"id\" | \"name\" | \"code\") => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleIsActiveFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ isActive: undefined, page: 1 });\n    } else {\n      updateURL({ isActive: value, page: 1 });\n    }\n  };\n\n  const columns = createMajorColumns(handleEdit, handleViewSubjects);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row - Mobile: Stack vertically, Desktop: Horizontal */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        {/* Search and Filters - Stack on mobile, row on tablet+ */}\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Search Input */}\n          <Input\n            placeholder={t('search_placeholder')}\n            value={localSearchValue}\n            onChange={(e) => handleSearchChange(e.target.value)}\n            className=\"w-full sm:max-w-[240px] md:max-w-sm\"\n            autoComplete=\"off\"\n          />\n\n          {/* Status Filter */}\n          <Select\n            value={\n              isActiveFilter === undefined\n                ? \"all\"\n                : isActiveFilter\n                ? \"true\"\n                : \"false\"\n            }\n            onValueChange={handleIsActiveFilterChange}\n          >\n            <SelectTrigger className=\"w-full sm:w-[140px]\">\n              <SelectValue placeholder={t('status_label')} />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">{t('status_all')}</SelectItem>\n              <SelectItem value=\"true\">{t('status_active')}</SelectItem>\n              <SelectItem value=\"false\">{t('status_inactive')}</SelectItem>\n            </SelectContent>\n          </Select>\n\n          {/* Sort Controls - Compact on mobile */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('sort_label')}\n            </span>\n            <Select value={sortBy} onValueChange={handleSortByChange}>\n              <SelectTrigger className=\"w-full sm:w-[130px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('sort_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"name\">{t('sort_name')}</SelectItem>\n                <SelectItem value=\"code\">{t('sort_code')}</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"h-6 w-px bg-border\" />\n            <Select value={sortOrder} onValueChange={handleSortOrderChange}>\n              <SelectTrigger className=\"w-full sm:w-[120px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('order_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"asc\">{t('order_asc')}</SelectItem>\n                <SelectItem value=\"desc\">{t('order_desc')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n\n        {/* Action Buttons - Full width on mobile, side by side on tablet+ */}\n        <div className=\"flex flex-col sm:flex-row gap-2 w-full sm:w-auto\">\n          <Button\n            onClick={() => setIsImportDialogOpen(true)}\n            className=\"w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white\"\n          >\n            <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n            {t('import_button')}\n          </Button>\n          <Button\n            onClick={() => setIsCreateDialogOpen(true)}\n            className=\"w-full sm:w-auto\"\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            {t('create_button')}\n          </Button>\n        </div>\n      </div>\n\n      <MajorTable\n        columns={columns}\n        data={majors}\n        isLoading={isLoading}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={pageSize}\n        onPageChange={handlePageChange}\n      />\n\n      <MajorFormDialog\n        open={isCreateDialogOpen}\n        onOpenChange={setIsCreateDialogOpen}\n        onSubmit={handleCreate}\n        isSubmitting={createMutation.isPending}\n      />\n\n      <MajorFormDialog\n        open={isEditDialogOpen}\n        onOpenChange={setIsEditDialogOpen}\n        major={selectedMajor}\n        isLoadingMajor={isLoadingMajor}\n        onSubmit={handleUpdate}\n        onDelete={handleDeleteFromDialog}\n        isSubmitting={updateMutation.isPending}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      <DeleteMajorDialog\n        open={isDeleteDialogOpen}\n        onOpenChange={setIsDeleteDialogOpen}\n        major={selectedMajor || null}\n        onConfirm={handleConfirmDelete}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      <GenericImportDialog\n        open={isImportDialogOpen}\n        onOpenChange={setIsImportDialogOpen}\n        title={tImport('title')}\n        csvColumns={[\"code\", \"name\", \"status\"]}\n        importMutation={importMutation}\n        successMessage={tImport('success_message')}\n        entityName={tImport('entity_name')}\n      />\n    </div>\n  );\n}\n\nexport default function MajorsPage() {\n  const t = useTranslations('major');\n\n  return (\n    <Suspense fallback={<div>{t('loading')}</div>}>\n      <MajorsContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\rooms\\page.tsx",
      "relative_path": "app/admin/rooms/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 15742,
      "lines": 478,
      "last_modified": "2025-11-14T17:40:37.447259",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useState } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { Plus, FileSpreadsheet } from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from 'next-intl';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { RoomTable } from \"@/components/admin/rooms/room-table\";\nimport { createRoomColumns } from \"@/components/admin/rooms/room-columns\";\nimport {\n  RoomFormDialog,\n  RoomFormData,\n} from \"@/components/admin/rooms/room-form-dialog\";\nimport { DeleteRoomDialog } from \"@/components/admin/rooms/delete-room-dialog\";\nimport GenericImportDialog from \"@/components/admin/shared/generic-import-dialog\";\nimport { Room } from \"@/types\";\nimport {\n  useGetRooms,\n  useGetRoomById,\n  useCreateRoom,\n  useUpdateRoom,\n  useDeleteRoom,\n  useImportRooms,\n} from \"@/hooks/api/useRooms\";\nimport { DEFAULT_PAGE_SIZE } from \"@/lib/constants\";\n\nfunction RoomsContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const t = useTranslations('room');\n  const tImport = useTranslations('import');\n\n  // Extract and validate URL parameters\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const searchQuery = searchParams.get(\"search\") || \"\";\n  const sortBy = (\n    [\"name\", \"location\"].includes(searchParams.get(\"sortBy\") || \"\")\n      ? searchParams.get(\"sortBy\")\n      : \"name\"\n  ) as \"name\" | \"location\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n  const isActiveParam = searchParams.get(\"isActive\");\n  const isActiveFilter =\n    isActiveParam === \"false\"\n      ? false\n      : isActiveParam === \"true\"\n      ? true\n      : undefined; // Default to all\n  const hasCameraParam = searchParams.get(\"hasCamera\");\n  const hasCameraFilter =\n    hasCameraParam === \"true\"\n      ? true\n      : hasCameraParam === \"false\"\n      ? false\n      : undefined;\n\n  // Local state for debounced search\n  const [localSearchValue, setLocalSearchValue] = useState(searchQuery);\n\n  // Dialog states\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n  const [selectedRoomId, setSelectedRoomId] = useState<number | null>(null);\n  const [deleteTargetRoom, setDeleteTargetRoom] = useState<Room | null>(null);\n\n  // Update URL with new parameters\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key); // Clean URL for page 1\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    // Always ensure sortBy and sort are in URL\n    if (!newParams.has(\"sortBy\")) {\n      newParams.set(\"sortBy\", sortBy);\n    }\n    if (!newParams.has(\"sort\")) {\n      newParams.set(\"sort\", sortOrder);\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  // Debounced search effect\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (localSearchValue !== searchQuery) {\n        updateURL({\n          search: localSearchValue || undefined,\n          page: 1,\n        });\n      }\n    }, 500);\n\n    return () => clearTimeout(timer);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [localSearchValue, searchQuery]);\n\n  // Sync local search with URL\n  useEffect(() => {\n    setLocalSearchValue(searchQuery);\n  }, [searchQuery]);\n\n  // Initialize URL params on mount\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n    const needsUpdate =\n      !currentParams.has(\"sortBy\") ||\n      !currentParams.has(\"sort\") ||\n      (page !== 1 && !currentParams.has(\"page\"));\n\n    if (needsUpdate) {\n      const newParams = new URLSearchParams();\n\n      newParams.set(\"sortBy\", sortBy);\n      newParams.set(\"sort\", sortOrder);\n\n      if (page !== 1) {\n        newParams.set(\"page\", String(page));\n      }\n\n      if (searchQuery) {\n        newParams.set(\"search\", searchQuery);\n      }\n\n      if (isActiveParam) {\n        newParams.set(\"isActive\", isActiveParam);\n      }\n\n      if (hasCameraParam) {\n        newParams.set(\"hasCamera\", hasCameraParam);\n      }\n\n      const newURL = `${pathname}?${newParams.toString()}`;\n      router.replace(newURL, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Fetch rooms data\n  const { data, isLoading } = useGetRooms({\n    page,\n    pageSize: DEFAULT_PAGE_SIZE,\n    search: searchQuery,\n    sort: sortOrder,\n    sortBy: sortBy,\n    isActive: isActiveFilter,\n    hasCamera: hasCameraFilter,\n  });\n\n  // Fetch selected room for editing\n  const { data: selectedRoom, isLoading: isLoadingRoom } = useGetRoomById(\n    selectedRoomId || 0\n  );\n\n  // Mutations\n  const createMutation = useCreateRoom();\n  const updateMutation = useUpdateRoom();\n  const deleteMutation = useDeleteRoom();\n  const importMutation = useImportRooms();\n\n  // Extract data\n  const rooms = data?.items || [];\n  const totalPages = data?.totalPages || 1;\n  const totalItems = data?.totalItems || 0;\n  const currentPage = data?.currentPage || 1;\n  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;\n\n  // Handler functions\n  const handleSearchChange = (value: string) => {\n    setLocalSearchValue(value);\n  };\n\n  const handleSortByChange = (value: \"name\" | \"location\") => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleIsActiveFilterChange = (value: string) => {\n    updateURL({ isActive: value, page: 1 });\n  };\n\n  const handleHasCameraFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ hasCamera: undefined, page: 1 });\n    } else {\n      updateURL({ hasCamera: value, page: 1 });\n    }\n  };\n\n  const handlePageChange = (newPage: number) => {\n    updateURL({ page: newPage });\n  };\n\n  // CRUD handlers\n  const handleCreate = async (data: RoomFormData) => {\n    await createMutation.mutateAsync({\n      name: data.name,\n      location: data.location,\n    });\n    setIsCreateDialogOpen(false);\n    updateURL({ page: 1 });\n  };\n\n  const handleEdit = (room: Room) => {\n    setSelectedRoomId(room.id);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = async (data: RoomFormData) => {\n    if (!selectedRoom) return;\n\n    await updateMutation.mutateAsync({\n      id: selectedRoom.id,\n      payload: {\n        name: data.name,\n        location: data.location,\n        isActive: data.isActive!,\n      },\n    });\n    setIsEditDialogOpen(false);\n    setSelectedRoomId(null);\n  };\n\n  const handleDeleteFromDialog = (room: Room) => {\n    setDeleteTargetRoom(room);\n    setIsDeleteDialogOpen(true);\n  };\n\n  const handleConfirmDelete = () => {\n    if (!deleteTargetRoom) return;\n\n    deleteMutation.mutate(deleteTargetRoom.id, {\n      onSuccess: () => {\n        setIsDeleteDialogOpen(false);\n        setIsEditDialogOpen(false);\n        setSelectedRoomId(null);\n        setDeleteTargetRoom(null);\n        // Adjust pagination if current page becomes empty\n        if (rooms.length === 1 && currentPage > 1) {\n          updateURL({ page: currentPage - 1 });\n        }\n      },\n    });\n  };\n\n  const handleViewCameras = (room: Room) => {\n    router.push(`/admin/cameras?roomId=${room.id}`);\n  };\n\n  // Create columns with handlers\n  const columns = createRoomColumns(\n    handleEdit,\n    handleViewCameras\n  );\n\n  // Set page header\n  useEffect(() => {\n    setPageHeader({\n      title: t('page_title'),\n      subtitle: t('page_subtitle'),\n      breadcrumbs: [\n        { label: t('breadcrumb_dashboard'), href: \"/admin/dashboard\" },\n        { label: t('breadcrumb_rooms') },\n      ],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader, t]);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row - Mobile: Stack vertically, Desktop: Horizontal */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        {/* Search and Filters - Stack on mobile, row on tablet+ */}\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Search Input */}\n          <Input\n            placeholder={t('search_placeholder')}\n            value={localSearchValue}\n            onChange={(e) => handleSearchChange(e.target.value)}\n            className=\"w-full sm:max-w-[240px] md:max-w-sm\"\n            autoComplete=\"off\"\n          />\n\n          {/* Status Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('status_label')}\n            </span>\n            <Select\n              value={\n                isActiveFilter === undefined\n                  ? \"all\"\n                  : isActiveFilter\n                  ? \"true\"\n                  : \"false\"\n              }\n              onValueChange={handleIsActiveFilterChange}\n            >\n              <SelectTrigger className=\"w-full sm:w-[140px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('status_label')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">{t('status_all')}</SelectItem>\n                <SelectItem value=\"true\">{t('status_active')}</SelectItem>\n                <SelectItem value=\"false\">{t('status_inactive')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Camera Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('camera_label')}\n            </span>\n            <Select\n              value={\n                hasCameraFilter === undefined\n                  ? \"all\"\n                  : hasCameraFilter\n                  ? \"true\"\n                  : \"false\"\n              }\n              onValueChange={handleHasCameraFilterChange}\n            >\n              <SelectTrigger className=\"w-full sm:w-[160px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('camera_label')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">{t('camera_all')}</SelectItem>\n                <SelectItem value=\"true\">{t('camera_has')}</SelectItem>\n                <SelectItem value=\"false\">{t('camera_no')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Sort Controls - Compact on mobile */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('sort_label')}\n            </span>\n            <Select value={sortBy} onValueChange={handleSortByChange}>\n              <SelectTrigger className=\"w-full sm:w-[130px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('sort_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"name\">{t('sort_name')}</SelectItem>\n                <SelectItem value=\"location\">{t('sort_location')}</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"h-6 w-px bg-border\" />\n            <Select value={sortOrder} onValueChange={handleSortOrderChange}>\n              <SelectTrigger className=\"w-full sm:w-[120px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('order_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"asc\">{t('order_asc')}</SelectItem>\n                <SelectItem value=\"desc\">{t('order_desc')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n\n        {/* Action Buttons - Full width on mobile, side by side on tablet+ */}\n        <div className=\"flex flex-col sm:flex-row gap-2 w-full sm:w-auto\">\n          <Button\n            onClick={() => setIsImportDialogOpen(true)}\n            className=\"w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white\"\n          >\n            <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n            {t('import_button')}\n          </Button>\n          <Button\n            onClick={() => setIsCreateDialogOpen(true)}\n            className=\"w-full sm:w-auto\"\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            {t('create_button')}\n          </Button>\n        </div>\n      </div>\n\n      {/* Room Table */}\n      <RoomTable\n        columns={columns}\n        data={rooms}\n        isLoading={isLoading}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={pageSize}\n        onPageChange={handlePageChange}\n      />\n\n      {/* Create Dialog */}\n      <RoomFormDialog\n        open={isCreateDialogOpen}\n        onOpenChange={setIsCreateDialogOpen}\n        onSubmit={handleCreate}\n        isSubmitting={createMutation.isPending}\n      />\n\n      {/* Edit Dialog */}\n      <RoomFormDialog\n        open={isEditDialogOpen}\n        onOpenChange={setIsEditDialogOpen}\n        room={selectedRoom}\n        isLoadingRoom={isLoadingRoom}\n        onSubmit={handleUpdate}\n        onDelete={handleDeleteFromDialog}\n        isSubmitting={updateMutation.isPending}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      {/* Delete Confirmation Dialog */}\n      <DeleteRoomDialog\n        open={isDeleteDialogOpen}\n        onOpenChange={setIsDeleteDialogOpen}\n        room={deleteTargetRoom}\n        onConfirm={handleConfirmDelete}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      <GenericImportDialog\n        open={isImportDialogOpen}\n        onOpenChange={setIsImportDialogOpen}\n        title={tImport('title')}\n        csvColumns={[\"name\", \"location\", \"status\"]}\n        importMutation={importMutation}\n        successMessage={tImport('success_message')}\n        entityName=\"rooms\"\n      />\n    </div>\n  );\n}\n\nexport default function RoomsPage() {\n  const t = useTranslations('room');\n\n  return (\n    <Suspense fallback={<div>{t('loading')}</div>}>\n      <RoomsContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\semesters\\page.tsx",
      "relative_path": "app/admin/semesters/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 13858,
      "lines": 419,
      "last_modified": "2025-11-14T17:40:33.843805",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useState } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { Plus, FileSpreadsheet } from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from 'next-intl';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { SemesterTable } from \"@/components/admin/semesters/semester-table\";\nimport { createSemesterColumns } from \"@/components/admin/semesters/semester-columns\";\nimport {\n  SemesterFormDialog,\n  SemesterFormData,\n} from \"@/components/admin/semesters/semester-form-dialog\";\nimport { DeleteSemesterDialog } from \"@/components/admin/semesters/delete-semester-dialog\";\nimport GenericImportDialog from \"@/components/admin/shared/generic-import-dialog\";\nimport { Semester } from \"@/types\";\nimport {\n  useGetSemesters,\n  useGetSemesterById,\n  useCreateSemester,\n  useUpdateSemester,\n  useDeleteSemester,\n  useImportSemesters,\n} from \"@/hooks/api/useSemesters\";\nimport { DEFAULT_PAGE_SIZE } from \"@/lib/constants\";\n\nfunction SemestersContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const t = useTranslations('semester');\n  const tImport = useTranslations('import');\n\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const searchQuery = searchParams.get(\"search\") || \"\";\n  const sortBy = (\n    [\"name\", \"code\", \"startDate\", \"endDate\"].includes(\n      searchParams.get(\"sortBy\") || \"\"\n    )\n      ? searchParams.get(\"sortBy\")\n      : \"name\"\n  ) as \"name\" | \"code\" | \"startDate\" | \"endDate\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n  const isActiveParam = searchParams.get(\"isActive\");\n  const isActiveFilter =\n    isActiveParam === \"false\"\n      ? false\n      : isActiveParam === \"true\"\n      ? true\n      : undefined; // Default to all\n\n  const [localSearchValue, setLocalSearchValue] = useState(searchQuery);\n\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n  const [selectedSemesterId, setSelectedSemesterId] = useState<number | null>(\n    null\n  );\n  const [deleteTargetSemester, setDeleteTargetSemester] =\n    useState<Semester | null>(null);\n\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    if (!newParams.has(\"sortBy\")) {\n      newParams.set(\"sortBy\", sortBy);\n    }\n    if (!newParams.has(\"sort\")) {\n      newParams.set(\"sort\", sortOrder);\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (localSearchValue !== searchQuery) {\n        updateURL({\n          search: localSearchValue || undefined,\n          page: 1,\n        });\n      }\n    }, 500);\n\n    return () => clearTimeout(timer);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [localSearchValue, searchQuery]);\n\n  useEffect(() => {\n    setLocalSearchValue(searchQuery);\n  }, [searchQuery]);\n\n  useEffect(() => {\n    setPageHeader({\n      breadcrumbs: [\n        { label: t('breadcrumb_dashboard'), href: \"/admin/dashboard\" },\n        { label: t('breadcrumb_semesters') },\n      ],\n      title: t('page_title'),\n      subtitle: t('page_subtitle'),\n    });\n\n    return () => clearPageHeader();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [t]);\n\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n    const needsUpdate =\n      !currentParams.has(\"sortBy\") ||\n      !currentParams.has(\"sort\") ||\n      (page !== 1 && !currentParams.has(\"page\"));\n\n    if (needsUpdate) {\n      const newParams = new URLSearchParams();\n\n      newParams.set(\"sortBy\", sortBy);\n      newParams.set(\"sort\", sortOrder);\n\n      if (page !== 1) {\n        newParams.set(\"page\", String(page));\n      }\n\n      if (searchQuery) {\n        newParams.set(\"search\", searchQuery);\n      }\n\n      if (isActiveParam) {\n        newParams.set(\"isActive\", isActiveParam);\n      }\n\n      const newURL = `${pathname}?${newParams.toString()}`;\n      router.replace(newURL, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const { data, isLoading } = useGetSemesters({\n    page,\n    pageSize: DEFAULT_PAGE_SIZE,\n    search: searchQuery,\n    sort: sortOrder,\n    sortBy: sortBy,\n    isActive: isActiveFilter,\n  });\n\n  // Fetch selected semester for editing\n  const { data: selectedSemester, isLoading: isLoadingSemester } =\n    useGetSemesterById(selectedSemesterId || 0);\n\n  const createMutation = useCreateSemester();\n  const updateMutation = useUpdateSemester();\n  const deleteMutation = useDeleteSemester();\n  const importMutation = useImportSemesters();\n\n  const semesters = data?.items || [];\n  const totalPages = data?.totalPages || 1;\n  const totalItems = data?.totalItems || 0;\n  const currentPage = data?.currentPage || 1;\n  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;\n\n  const handleCreate = async (data: SemesterFormData) => {\n    await createMutation.mutateAsync({\n      name: data.name,\n      code: data.code,\n      startDate: data.startDate,\n      endDate: data.endDate,\n    });\n    setIsCreateDialogOpen(false);\n    updateURL({ page: 1 });\n  };\n\n  const handleEdit = (semester: Semester) => {\n    setSelectedSemesterId(semester.id);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = async (data: SemesterFormData) => {\n    if (!selectedSemester) return;\n\n    await updateMutation.mutateAsync({\n      id: selectedSemester.id,\n      payload: {\n        name: data.name,\n        code: data.code,\n        startDate: data.startDate,\n        endDate: data.endDate,\n        isActive: data.isActive!,\n      },\n    });\n    setIsEditDialogOpen(false);\n    setSelectedSemesterId(null);\n  };\n\n  const handleViewClasses = (semester: Semester) => {\n    router.push(`/admin/classes?semesterId=${semester.id}`);\n  };\n\n  const handleDeleteFromDialog = (semester: Semester) => {\n    setDeleteTargetSemester(semester);\n    setIsDeleteDialogOpen(true);\n  };\n\n  const handleConfirmDelete = () => {\n    if (!deleteTargetSemester) return;\n\n    deleteMutation.mutate(deleteTargetSemester.id, {\n      onSuccess: () => {\n        setIsDeleteDialogOpen(false);\n        setIsEditDialogOpen(false);\n        setSelectedSemesterId(null);\n        setDeleteTargetSemester(null);\n        if (semesters.length === 1 && currentPage > 1) {\n          updateURL({ page: currentPage - 1 });\n        }\n      },\n    });\n  };\n\n  const handlePageChange = (newPage: number) => {\n    updateURL({ page: newPage });\n  };\n\n  const handleSearchChange = (value: string) => {\n    setLocalSearchValue(value);\n  };\n\n  const handleSortByChange = (\n    value: \"id\" | \"name\" | \"code\" | \"startDate\" | \"endDate\"\n  ) => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleIsActiveFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ isActive: undefined, page: 1 });\n    } else {\n      updateURL({ isActive: value, page: 1 });\n    }\n  };\n\n  const columns = createSemesterColumns(handleEdit, handleViewClasses);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row - Mobile: Stack vertically, Desktop: Horizontal */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        {/* Search and Filters - Stack on mobile, row on tablet+ */}\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Search Input */}\n          <Input\n            placeholder={t('search_placeholder')}\n            value={localSearchValue}\n            onChange={(e) => handleSearchChange(e.target.value)}\n            className=\"w-full sm:max-w-[240px] md:max-w-sm\"\n            autoComplete=\"off\"\n          />\n\n          {/* Status Filter */}\n          <Select\n            value={\n              isActiveFilter === undefined\n                ? \"all\"\n                : isActiveFilter\n                ? \"true\"\n                : \"false\"\n            }\n            onValueChange={handleIsActiveFilterChange}\n          >\n            <SelectTrigger className=\"w-full sm:w-[140px]\">\n              <SelectValue placeholder=\"Status...\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Status</SelectItem>\n              <SelectItem value=\"true\">Active</SelectItem>\n              <SelectItem value=\"false\">Inactive</SelectItem>\n            </SelectContent>\n          </Select>\n\n          {/* Sort Controls - Compact on mobile */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('sort_label')}\n            </span>\n            <Select value={sortBy} onValueChange={handleSortByChange}>\n              <SelectTrigger className=\"w-full sm:w-[130px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('sort_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"name\">{t('sort_name')}</SelectItem>\n                <SelectItem value=\"code\">{t('sort_code')}</SelectItem>\n                <SelectItem value=\"startDate\">{t('sort_start_date')}</SelectItem>\n                <SelectItem value=\"endDate\">{t('sort_end_date')}</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"h-6 w-px bg-border\" />\n            <Select value={sortOrder} onValueChange={handleSortOrderChange}>\n              <SelectTrigger className=\"w-full sm:w-[120px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('order_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"asc\">{t('order_asc')}</SelectItem>\n                <SelectItem value=\"desc\">{t('order_desc')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n\n        {/* Action Buttons - Full width on mobile, side by side on tablet+ */}\n        <div className=\"flex flex-col sm:flex-row gap-2 w-full sm:w-auto\">\n          <Button\n            onClick={() => setIsImportDialogOpen(true)}\n            className=\"w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white\"\n          >\n            <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n            {t('import_button')}\n          </Button>\n          <Button\n            onClick={() => setIsCreateDialogOpen(true)}\n            className=\"w-full sm:w-auto\"\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            {t('create_button')}\n          </Button>\n        </div>\n      </div>\n\n      <SemesterTable\n        columns={columns}\n        data={semesters}\n        isLoading={isLoading}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={pageSize}\n        onPageChange={handlePageChange}\n      />\n\n      <SemesterFormDialog\n        open={isCreateDialogOpen}\n        onOpenChange={setIsCreateDialogOpen}\n        onSubmit={handleCreate}\n        isSubmitting={createMutation.isPending}\n      />\n\n      <SemesterFormDialog\n        open={isEditDialogOpen}\n        onOpenChange={setIsEditDialogOpen}\n        semester={selectedSemester}\n        isLoadingSemester={isLoadingSemester}\n        onSubmit={handleUpdate}\n        onDelete={handleDeleteFromDialog}\n        isSubmitting={updateMutation.isPending}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      <DeleteSemesterDialog\n        open={isDeleteDialogOpen}\n        onOpenChange={setIsDeleteDialogOpen}\n        semester={deleteTargetSemester}\n        onConfirm={handleConfirmDelete}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      <GenericImportDialog\n        open={isImportDialogOpen}\n        onOpenChange={setIsImportDialogOpen}\n        title={tImport('title')}\n        csvColumns={[\"code\", \"name\", \"start_date\", \"end_date\", \"status\"]}\n        importMutation={importMutation}\n        successMessage={tImport('success_message')}\n        entityName={tImport('entity_name')}\n      />\n    </div>\n  );\n}\n\nexport default function SemestersPage() {\n  const t = useTranslations('semester');\n\n  return (\n    <Suspense fallback={<div>{t('loading')}</div>}>\n      <SemestersContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\slots\\[id]\\roster\\page.tsx",
      "relative_path": "app/admin/slots/[id]/roster/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 10009,
      "lines": 281,
      "last_modified": "2025-11-16T11:53:25.152951",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useParams } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  SlotRosterTable,\n  type PendingChange,\n} from \"@/components/admin/slots/slot-roster-table\";\nimport { SessionControls } from \"@/components/admin/slots/session-controls\";\nimport { ExamSessionControls } from \"@/components/admin/slots/exam-session-controls\";\nimport { type StatusFilter } from \"@/components/admin/slots/roster-filters\";\nimport { EvidenceViewerDialog } from \"@/components/admin/slots/evidence-viewer-dialog\";\nimport { useGetSlot } from \"@/hooks/api/useSlots\";\nimport { useGetSlotRoster } from \"@/hooks/api/useSlotRoster\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { buildSlotsPageUrl, buildExamsPageUrl } from \"@/lib/navigation-state\";\nimport { getPrimaryRole } from \"@/lib/role-permissions\";\nimport type { AttendanceType } from \"@/types\";\n\nexport default function SlotRosterPage() {\n  const params = useParams();\n  const slotId = Number(params.id);\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const userRole = getPrimaryRole();\n\n  const { data: slot, isLoading: isLoadingSlot } = useGetSlot(slotId);\n  const { data: roster, isLoading: isLoadingRoster } = useGetSlotRoster(slotId);\n\n  // Pending changes state for inline editing\n  // Use composite key (attendanceType-recordId) to ensure Regular and Exam are independent\n  const [pendingChanges, setPendingChanges] = useState<\n    Map<string, PendingChange>\n  >(new Map());\n\n  // Active tab state for LECTURE_WITH_PT and FINAL_EXAM slots\n  const [activeTab, setActiveTab] = useState<AttendanceType>(\"REGULAR\");\n\n  // Filter state for Regular attendance\n  const [regularStatusFilter, setRegularStatusFilter] =\n    useState<StatusFilter>(\"all\");\n  const [regularSearchQuery, setRegularSearchQuery] = useState(\"\");\n\n  // Filter state for Exam attendance\n  const [examStatusFilter, setExamStatusFilter] = useState<StatusFilter>(\"all\");\n  const [examSearchQuery, setExamSearchQuery] = useState(\"\");\n\n  const [evidenceDialogOpen, setEvidenceDialogOpen] = useState(false);\n  const [avatarImageUrl, setAvatarImageUrl] = useState<string>(\"\");\n  const [evidenceImageUrl, setEvidenceImageUrl] = useState<string | null>(null);\n  const [studentName, setStudentName] = useState<string>(\"\");\n\n  const handleViewEvidence = (\n    avatarUrl: string,\n    evidenceUrl: string | null,\n    name: string\n  ) => {\n    setAvatarImageUrl(avatarUrl);\n    setEvidenceImageUrl(evidenceUrl);\n    setStudentName(name);\n    setEvidenceDialogOpen(true);\n  };\n\n  const handlePendingChange = (\n    recordId: number,\n    attendanceType: AttendanceType,\n    status: \"present\" | \"absent\" | \"not_yet\",\n    remark?: string\n  ) => {\n    const newPendingChanges = new Map(pendingChanges);\n    const key = `${attendanceType}-${recordId}`;\n    newPendingChanges.set(key, { status, remark });\n    setPendingChanges(newPendingChanges);\n  };\n\n  const clearPendingChanges = () => {\n    setPendingChanges(new Map());\n  };\n\n  // Set page header (placeholder on mount, detailed after load)\n  useEffect(() => {\n    if (!slot) {\n      setPageHeader({\n        title: \"Slot Roster\",\n        subtitle: \"Loading slot details...\",\n        breadcrumbs: [\n          { label: \"Dashboard\", href: \"/admin/dashboard\" },\n          { label: \"Slots\", href: buildSlotsPageUrl() },\n          { label: \"Slot Roster\" },\n        ],\n      });\n      return;\n    }\n\n    // Determine parent label and href based on slot category\n    const isExamSlot = slot.slotCategory === \"FINAL_EXAM\";\n    const parentLabel = isExamSlot ? \"Exams\" : \"Slots\";\n    const parentHref = isExamSlot ? buildExamsPageUrl() : buildSlotsPageUrl();\n\n    const getCategoryLabel = (category: string) => {\n      const labels = {\n        LECTURE: \"Lecture\",\n        LECTURE_WITH_PT: \"Lecture with PT\",\n        FINAL_EXAM: \"Final Exam\",\n      };\n      return labels[category as keyof typeof labels] || category;\n    };\n\n    setPageHeader({\n      title: slot.title || \"Untitled Slot\",\n      subtitle: `${slot.class?.code || \"\"} â€¢ ${getCategoryLabel(\n        slot.slotCategory\n      )} â€¢ ${format(new Date(slot.startTime), \"MMM d, yyyy\")} â€¢ ${format(\n        new Date(slot.startTime),\n        \"h:mm a\"\n      )} - ${format(new Date(slot.endTime), \"h:mm a\")} â€¢ ${slot.room.name}`,\n      breadcrumbs: [\n        { label: \"Dashboard\", href: \"/admin/dashboard\" },\n        { label: parentLabel, href: parentHref },\n        { label: slot.title || \"Untitled Slot\" },\n      ],\n    });\n  }, [slot, setPageHeader]);\n\n  // Clear header on unmount\n  useEffect(() => {\n    return () => {\n      clearPageHeader();\n    };\n  }, [clearPageHeader]);\n\n  if (isLoadingSlot || isLoadingRoster) {\n    return (\n      <div className=\"space-y-6\">\n        <Skeleton className=\"h-10 w-full\" />\n        <Skeleton className=\"h-32 w-full\" />\n        <Skeleton className=\"h-96 w-full\" />\n      </div>\n    );\n  }\n\n  if (!slot || !roster) {\n    return (\n      <div className=\"flex flex-col items-center justify-center min-h-[400px] gap-4\">\n        <p className=\"text-muted-foreground\">Slot not found</p>\n      </div>\n    );\n  }\n\n  // Determine if this slot supports exam attendance\n  const hasExamAttendance =\n    slot.slotCategory === \"LECTURE_WITH_PT\" ||\n    slot.slotCategory === \"FINAL_EXAM\";\n\n  // Check mutual exclusion for tab disabling\n  const isRegularRunning = slot.sessionStatus === \"RUNNING\";\n  const isExamRunning = slot.examSessionStatus === \"RUNNING\";\n\n  // Regular LECTURE slots - single view (no tabs)\n  if (!hasExamAttendance) {\n    return (\n      <div className=\"space-y-6\">\n        {/* Session Controls + Roster Table - Merged into one Card */}\n        <SessionControls\n          slot={slot}\n          roster={roster}\n          pendingChanges={pendingChanges}\n          onSubmitSuccess={clearPendingChanges}\n          userRole={userRole ?? undefined}\n          statusFilter={regularStatusFilter}\n          onStatusFilterChange={setRegularStatusFilter}\n          searchQuery={regularSearchQuery}\n          onSearchQueryChange={setRegularSearchQuery}\n        >\n          <SlotRosterTable\n            data={roster}\n            slot={slot}\n            attendanceType=\"REGULAR\"\n            pendingChanges={pendingChanges}\n            onPendingChange={handlePendingChange}\n            onViewEvidence={handleViewEvidence}\n            userRole={userRole ?? undefined}\n            isSessionRunning={isRegularRunning}\n          />\n        </SessionControls>\n\n        {/* Evidence Viewer Dialog */}\n        <EvidenceViewerDialog\n          open={evidenceDialogOpen}\n          onOpenChange={setEvidenceDialogOpen}\n          avatarUrl={avatarImageUrl}\n          evidenceUrl={evidenceImageUrl}\n          studentName={studentName}\n        />\n      </div>\n    );\n  }\n\n  // LECTURE_WITH_PT and FINAL_EXAM slots - tabbed view\n  return (\n    <div className=\"space-y-6\">\n      <Tabs\n        value={activeTab}\n        onValueChange={(value) => setActiveTab(value as AttendanceType)}\n        className=\"space-y-4\"\n      >\n        <TabsList className=\"grid w-full max-w-md grid-cols-2\">\n          <TabsTrigger value=\"REGULAR\" disabled={isExamRunning}>\n            Regular Attendance\n          </TabsTrigger>\n          <TabsTrigger value=\"EXAM\" disabled={isRegularRunning}>\n            Exam Attendance\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Regular Attendance Tab */}\n        <TabsContent value=\"REGULAR\" className=\"space-y-6\">\n          <SessionControls\n            slot={slot}\n            roster={roster}\n            pendingChanges={pendingChanges}\n            onSubmitSuccess={clearPendingChanges}\n            userRole={userRole ?? undefined}\n            statusFilter={regularStatusFilter}\n            onStatusFilterChange={setRegularStatusFilter}\n            searchQuery={regularSearchQuery}\n            onSearchQueryChange={setRegularSearchQuery}\n          >\n            <SlotRosterTable\n              data={roster}\n              slot={slot}\n              attendanceType=\"REGULAR\"\n              pendingChanges={pendingChanges}\n              onPendingChange={handlePendingChange}\n              onViewEvidence={handleViewEvidence}\n              userRole={userRole ?? undefined}\n              isSessionRunning={isRegularRunning}\n            />\n          </SessionControls>\n        </TabsContent>\n\n        {/* Exam Attendance Tab */}\n        <TabsContent value=\"EXAM\" className=\"space-y-6\">\n          <ExamSessionControls\n            slot={slot}\n            roster={roster}\n            pendingChanges={pendingChanges}\n            onSubmitSuccess={clearPendingChanges}\n            userRole={userRole ?? undefined}\n            statusFilter={examStatusFilter}\n            onStatusFilterChange={setExamStatusFilter}\n            searchQuery={examSearchQuery}\n            onSearchQueryChange={setExamSearchQuery}\n          >\n            <SlotRosterTable\n              data={roster}\n              slot={slot}\n              attendanceType=\"EXAM\"\n              pendingChanges={pendingChanges}\n              onPendingChange={handlePendingChange}\n              onViewEvidence={handleViewEvidence}\n              userRole={userRole ?? undefined}\n              isSessionRunning={isExamRunning}\n            />\n          </ExamSessionControls>\n        </TabsContent>\n      </Tabs>\n\n      {/* Evidence Viewer Dialog */}\n      <EvidenceViewerDialog\n        open={evidenceDialogOpen}\n        onOpenChange={setEvidenceDialogOpen}\n        avatarUrl={avatarImageUrl}\n        evidenceUrl={evidenceImageUrl}\n        studentName={studentName}\n      />\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\slots\\page.tsx",
      "relative_path": "app/admin/slots/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 44325,
      "lines": 1202,
      "last_modified": "2025-11-14T19:01:37.103074",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useState, useMemo } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport {\n  Plus,\n  CalendarIcon,\n  SlidersHorizontal,\n  FileSpreadsheet,\n} from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { Button } from \"@/components/ui/button\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { SlotTable } from \"@/components/admin/slots/slot-table\";\nimport { createSlotColumns } from \"@/components/admin/slots/slot-columns\";\nimport {\n  SlotFormDialog,\n  SlotFormData,\n} from \"@/components/admin/slots/slot-form-dialog\";\nimport { DeleteSlotDialog } from \"@/components/admin/slots/delete-slot-dialog\";\nimport GenericImportDialog from \"@/components/admin/shared/generic-import-dialog\";\nimport { Slot } from \"@/types\";\nimport {\n  useGetSlots,\n  useCreateSlot,\n  useUpdateSlot,\n  useDeleteSlot,\n  useImportSlots,\n} from \"@/hooks/api/useSlots\";\nimport { useGetSemesters } from \"@/hooks/api/useSemesters\";\nimport { useGetSubjects } from \"@/hooks/api/useSubjects\";\nimport { useGetClasses } from \"@/hooks/api/useClasses\";\nimport { useGetRooms } from \"@/hooks/api/useRooms\";\nimport { useGetStaffProfiles } from \"@/hooks/api/useStaffProfiles\";\nimport { format } from \"date-fns\";\nimport { cn } from \"@/lib/utils\";\nimport { saveSlotsPageState } from \"@/lib/navigation-state\";\nimport { DEFAULT_PAGE_SIZE, FILTER_PAGE_SIZE } from \"@/lib/constants\";\n\n// Helper function to get current week (Monday to Sunday)\nconst getCurrentWeek = () => {\n  const now = new Date();\n  const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ...\n  const monday = new Date(now);\n  monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));\n  monday.setHours(0, 0, 0, 0);\n\n  const sunday = new Date(monday);\n  sunday.setDate(monday.getDate() + 6);\n  sunday.setHours(23, 59, 59, 999);\n\n  return {\n    startDate: format(monday, \"yyyy-MM-dd\"),\n    endDate: format(sunday, \"yyyy-MM-dd\"),\n  };\n};\n\nfunction SlotsContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // URL params\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const sortBy = (\n    [\"startTime\", \"endTime\", \"slotCategory\"].includes(\n      searchParams.get(\"sortBy\") || \"\"\n    )\n      ? searchParams.get(\"sortBy\")\n      : \"startTime\"\n  ) as \"startTime\" | \"endTime\" | \"slotCategory\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n\n  // Filters - Semester is REQUIRED\n  const semesterIdParam = searchParams.get(\"semesterId\");\n\n  const classIdParam = searchParams.get(\"classId\");\n  const classIdFilter = classIdParam ? Number(classIdParam) : undefined;\n\n  const subjectIdParam = searchParams.get(\"subjectId\");\n  const subjectIdFilter = subjectIdParam ? Number(subjectIdParam) : undefined;\n\n  const roomIdParam = searchParams.get(\"roomId\");\n  const roomIdFilter = roomIdParam ? Number(roomIdParam) : undefined;\n\n  const staffUserIdParam = searchParams.get(\"staffUserId\");\n  const staffUserIdFilter = staffUserIdParam\n    ? Number(staffUserIdParam)\n    : undefined;\n\n  const isActiveParam = searchParams.get(\"isActive\");\n  const isActiveFilter =\n    isActiveParam === \"false\"\n      ? false\n      : isActiveParam === \"true\"\n      ? true\n      : undefined; // Default to all\n\n  // Date range filters\n  const startTimeFromParam = searchParams.get(\"startTimeFrom\");\n  const startTimeToParam = searchParams.get(\"startTimeTo\");\n\n  // Combobox open states\n  const [semesterFilterOpen, setSemesterFilterOpen] = useState(false);\n  const [semesterFilterQuery, setSemesterFilterQuery] = useState(\"\");\n  const [subjectFilterOpen, setSubjectFilterOpen] = useState(false);\n  const [subjectFilterQuery, setSubjectFilterQuery] = useState(\"\");\n  const [classFilterOpen, setClassFilterOpen] = useState(false);\n  const [classFilterQuery, setClassFilterQuery] = useState(\"\");\n  const [roomFilterOpen, setRoomFilterOpen] = useState(false);\n  const [roomFilterQuery, setRoomFilterQuery] = useState(\"\");\n  const [staffFilterOpen, setStaffFilterOpen] = useState(false);\n  const [staffFilterQuery, setStaffFilterQuery] = useState(\"\");\n\n  // Advanced filters popover state\n  const [advancedFiltersOpen, setAdvancedFiltersOpen] = useState(false);\n\n  // Date picker states\n  const [startDateOpen, setStartDateOpen] = useState(false);\n  const [endDateOpen, setEndDateOpen] = useState(false);\n\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [selectedSlot, setSelectedSlot] = useState<Slot | null>(null);\n\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    // Only add sortBy and sort if semester is selected\n    const hasSemester = newParams.has(\"semesterId\");\n    if (hasSemester) {\n      if (!newParams.has(\"sortBy\")) {\n        newParams.set(\"sortBy\", sortBy);\n      }\n      if (!newParams.has(\"sort\")) {\n        newParams.set(\"sort\", sortOrder);\n      }\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n\n    // Only add sortBy and sort if semester is selected\n    if (!semesterIdParam) {\n      return; // Don't add any params if no semester selected\n    }\n\n    const needsUpdate =\n      !currentParams.has(\"sortBy\") ||\n      !currentParams.has(\"sort\") ||\n      (page !== 1 && !currentParams.has(\"page\"));\n\n    if (needsUpdate) {\n      const newParams = new URLSearchParams();\n\n      // Add sortBy and sort only when semester is selected\n      newParams.set(\"sortBy\", sortBy);\n      newParams.set(\"sort\", sortOrder);\n\n      if (page !== 1) {\n        newParams.set(\"page\", String(page));\n      }\n\n      if (semesterIdParam) {\n        newParams.set(\"semesterId\", semesterIdParam);\n      }\n\n      if (classIdParam) {\n        newParams.set(\"classId\", classIdParam);\n      }\n\n      if (subjectIdParam) {\n        newParams.set(\"subjectId\", subjectIdParam);\n      }\n\n      if (roomIdParam) {\n        newParams.set(\"roomId\", roomIdParam);\n      }\n\n      if (staffUserIdParam) {\n        newParams.set(\"staffUserId\", staffUserIdParam);\n      }\n\n      if (isActiveParam) {\n        newParams.set(\"isActive\", isActiveParam);\n      }\n\n      const newURL = `${pathname}?${newParams.toString()}`;\n      router.replace(newURL, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Fetch semesters first\n  const { data: semestersData } = useGetSemesters({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"name\",\n    search: semesterFilterQuery || undefined,\n  });\n\n  // Extract semesters and calculate semesterIdFilter early (before other hooks that need it)\n  const semesters = useMemo(() => semestersData?.items || [], [semestersData]);\n\n  const currentSemester = useMemo(() => {\n    if (!semesters || semesters.length === 0) return null;\n\n    const now = new Date();\n    return semesters.find((s) => {\n      const start = new Date(s.startDate);\n      const end = new Date(s.endDate);\n      return now >= start && now <= end;\n    });\n  }, [semesters]);\n\n  const semesterIdFilter = useMemo(() => {\n    return semesterIdParam && !isNaN(Number(semesterIdParam))\n      ? Number(semesterIdParam)\n      : currentSemester?.id;\n  }, [semesterIdParam, currentSemester]);\n\n  // Fetch other filter options (now semesterIdFilter is available)\n  const { data: subjectsData } = useGetSubjects({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"code\",\n    search: subjectFilterQuery || undefined,\n  });\n  // Fetch classes for the combobox with server-side search and larger page size\n  const { data: classesData } = useGetClasses({\n    pageSize: FILTER_PAGE_SIZE, // maximize per docs (1-50)\n    sortBy: \"code\",\n    search: classFilterQuery || undefined, // server-side search by code\n    semesterId: semesterIdFilter, // Filter classes by selected semester\n  });\n  const { data: roomsData } = useGetRooms({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"name\",\n    search: roomFilterQuery || undefined,\n  });\n  // Fetch staff with search filter (for advanced filter dropdown)\n  const { data: staffData } = useGetStaffProfiles({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"fullName\",\n    search: staffFilterQuery || undefined,\n    isActive: true,\n  });\n\n  // Fetch ALL staff without search filter (for form dropdown)\n  const { data: staffDataForForm } = useGetStaffProfiles({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"fullName\",\n    isActive: true,\n  });\n\n  // Only fetch slots if semester is selected\n  const shouldFetchSlots = !!semesterIdFilter;\n\n  // Fetch slots excluding FINAL_EXAM category (server-side filtering)\n  const { data, isLoading } = useGetSlots(\n    {\n      page,\n      pageSize: DEFAULT_PAGE_SIZE,\n      sort: sortOrder,\n      sortBy: sortBy,\n      slotCategories: [\"LECTURE\", \"LECTURE_WITH_PT\"], // Only include LECTURE and LECTURE_WITH_PT (exclude FINAL_EXAM)\n      classId: classIdFilter,\n      subjectId: subjectIdFilter,\n      semesterId: semesterIdFilter,\n      roomId: roomIdFilter,\n      staffUserId: staffUserIdFilter,\n      isActive: isActiveFilter,\n      startTimeFrom: startTimeFromParam || undefined,\n      startTimeTo: startTimeToParam || undefined,\n    },\n    {\n      enabled: shouldFetchSlots, // Only fetch when semester is selected\n    }\n  );\n\n  const createMutation = useCreateSlot();\n  const updateMutation = useUpdateSlot();\n  const deleteMutation = useDeleteSlot();\n  const importSlotsMutation = useImportSlots();\n\n  // All server-side filtering - no need for client-side filtering anymore\n  const slots = data?.items || [];\n  const totalPages = data?.totalPages ?? 1;\n  const totalItems = data?.totalItems ?? 0;\n  const currentPage = data?.currentPage ?? page;\n\n  // Auto-navigate to last page if current page exceeds total pages\n  useEffect(() => {\n    if (\n      !isLoading &&\n      shouldFetchSlots &&\n      page > totalPages &&\n      totalPages >= 1\n    ) {\n      updateURL({ page: totalPages });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isLoading, shouldFetchSlots, page, totalPages]);\n\n  const subjects = subjectsData?.items || [];\n  const classes = classesData?.items || [];\n  const rooms = roomsData?.items || [];\n\n  // Auto-redirect to current semester if no param but current semester exists\n  useEffect(() => {\n    if (!semesterIdParam && currentSemester && semesters.length > 0) {\n      const { startDate, endDate } = getCurrentWeek();\n      updateURL({\n        semesterId: currentSemester.id,\n        startTimeFrom: startDate,\n        startTimeTo: endDate,\n        sortBy: sortBy,\n        sort: sortOrder,\n      });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [semesterIdParam, currentSemester, semesters]);\n\n  // Find selected items for display\n  const selectedSemester = semesters.find((s) => s.id === semesterIdFilter);\n  const selectedSubject = subjects.find((s) => s.id === subjectIdFilter);\n  const selectedClass = classes.find((c) => c.id === classIdFilter);\n  const selectedRoom = rooms.find((r) => r.id === roomIdFilter);\n  // Staff for filter (with search query)\n  const staffProfilesAll = staffData?.items || [];\n  const teachingStaff = staffProfilesAll.filter((s) =>\n    s.roles.some((r) => /LECTURER|SUPERVISOR/i.test(r))\n  );\n  const staffList = teachingStaff.length > 0 ? teachingStaff : staffProfilesAll;\n  const selectedStaff = staffList.find((s) => s.userId === staffUserIdFilter);\n\n  // Staff for form (without search query - full list)\n  const staffProfilesAllForForm = staffDataForForm?.items || [];\n  const teachingStaffForForm = staffProfilesAllForForm.filter((s) =>\n    s.roles.some((r) => /LECTURER|SUPERVISOR/i.test(r))\n  );\n  const staffListForForm = teachingStaffForForm.length > 0 ? teachingStaffForForm : staffProfilesAllForForm;\n\n  // Reset class search when semester changes or popover closes\n  useEffect(() => {\n    setClassFilterQuery(\"\");\n  }, [semesterIdFilter, classFilterOpen]);\n\n  useEffect(() => {\n    if (!semesterFilterOpen) setSemesterFilterQuery(\"\");\n  }, [semesterFilterOpen]);\n\n  useEffect(() => {\n    if (!subjectFilterOpen) setSubjectFilterQuery(\"\");\n  }, [subjectFilterOpen]);\n\n  useEffect(() => {\n    if (!roomFilterOpen) setRoomFilterQuery(\"\");\n  }, [roomFilterOpen]);\n\n  const handleCreate = async (data: SlotFormData) => {\n    const payload = {\n      title: data.title,\n      description: data.description,\n      startTime: data.startTime,\n      endTime: data.endTime,\n      slotCategory: data.slotCategory,\n      semesterId: data.semesterId,\n      classId: data.classId,\n      roomId: data.roomId,\n      staffUserId: data.staffUserId,\n    };\n\n    await createMutation.mutateAsync(payload);\n    setIsCreateDialogOpen(false);\n    updateURL({ page: 1 });\n  };\n\n  const handleEdit = (slot: Slot) => {\n    setSelectedSlot(slot);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = async (data: SlotFormData) => {\n    if (!selectedSlot) return;\n\n    await updateMutation.mutateAsync({\n      id: selectedSlot.id,\n      payload: {\n        title: data.title,\n        description: data.description,\n        startTime: data.startTime,\n        endTime: data.endTime,\n        slotCategory: data.slotCategory,\n        semesterId: data.semesterId,\n        classId: data.classId,\n        roomId: data.roomId,\n        staffUserId: data.staffUserId,\n        isActive: data.isActive!,\n      },\n    });\n    setIsEditDialogOpen(false);\n    setSelectedSlot(null);\n  };\n\n  const handleViewRoster = (slot: Slot) => {\n    // Save current filters to sessionStorage for back navigation\n    saveSlotsPageState(searchParams);\n    // Navigate without query params for cleaner URL\n    router.push(`/admin/slots/${slot.id}/roster`);\n  };\n\n  const handleViewClass = (classCode: string) => {\n    router.push(`/admin/classes?search=${classCode}`);\n  };\n\n  const handleRoomClick = (roomName: string) => {\n    router.push(`/admin/rooms?search=${encodeURIComponent(roomName)}`);\n  };\n\n  const handleSubjectClick = (subjectCode: string) => {\n    router.push(`/admin/subjects?search=${encodeURIComponent(subjectCode)}`);\n  };\n\n  const handleDeleteClick = (slot: Slot) => {\n    setSelectedSlot(slot);\n    setIsDeleteDialogOpen(true);\n  };\n\n  const handleConfirmDelete = () => {\n    if (!selectedSlot) return;\n\n    deleteMutation.mutate(selectedSlot.id, {\n      onSuccess: () => {\n        setIsDeleteDialogOpen(false);\n        setIsEditDialogOpen(false);\n        setSelectedSlot(null);\n        if (slots.length === 1 && currentPage > 1) {\n          updateURL({ page: currentPage - 1 });\n        }\n      },\n    });\n  };\n\n  const handlePageChange = (newPage: number) => {\n    const targetPage = Math.min(Math.max(newPage, 1), totalPages);\n    if (targetPage === page) return;\n    updateURL({ page: targetPage });\n  };\n\n  const handleSortByChange = (\n    value: \"startTime\" | \"endTime\" | \"slotCategory\"\n  ) => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleSemesterFilterChange = (value: string) => {\n    // Clear other filters when semester changes\n    // Set default date range to current week\n    const { startDate, endDate } = getCurrentWeek();\n\n    updateURL({\n      semesterId: value,\n      classId: undefined,\n      roomId: undefined,\n      staffUserId: undefined,\n      startTimeFrom: startDate,\n      startTimeTo: endDate,\n      page: 1,\n      sortBy: sortBy, // Explicitly add sortBy\n      sort: sortOrder, // Explicitly add sort\n    });\n  };\n\n  const handleClassFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ classId: undefined, page: 1 });\n    } else {\n      updateURL({ classId: value, page: 1 });\n    }\n  };\n\n  const handleSubjectFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ subjectId: undefined, page: 1 });\n    } else {\n      updateURL({ subjectId: value, page: 1 });\n    }\n  };\n\n  const handleRoomFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ roomId: undefined, page: 1 });\n    } else {\n      updateURL({ roomId: value, page: 1 });\n    }\n  };\n\n  const handleStaffFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ staffUserId: undefined, page: 1 });\n    } else {\n      updateURL({ staffUserId: value, page: 1 });\n    }\n  };\n\n  const handleIsActiveFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ isActive: undefined, page: 1 });\n    } else {\n      updateURL({ isActive: value, page: 1 });\n    }\n  };\n\n  const handleStartDateChange = (date: Date | undefined) => {\n    if (date) {\n      updateURL({ startTimeFrom: format(date, \"yyyy-MM-dd\"), page: 1 });\n    } else {\n      updateURL({ startTimeFrom: undefined, page: 1 });\n    }\n    setStartDateOpen(false);\n  };\n\n  const handleEndDateChange = (date: Date | undefined) => {\n    if (date) {\n      updateURL({ startTimeTo: format(date, \"yyyy-MM-dd\"), page: 1 });\n    } else {\n      updateURL({ startTimeTo: undefined, page: 1 });\n    }\n    setEndDateOpen(false);\n  };\n\n  const handleClearDateRange = () => {\n    updateURL({\n      startTimeFrom: undefined,\n      startTimeTo: undefined,\n      page: 1,\n    });\n  };\n\n  const handleClearAdvancedFilters = () => {\n    updateURL({\n      roomId: undefined,\n      staffUserId: undefined,\n      isActive: undefined,\n      page: 1,\n    });\n    setAdvancedFiltersOpen(false);\n  };\n\n  const columns = createSlotColumns(\n    handleEdit,\n    handleViewRoster,\n    handleViewClass,\n    handleDeleteClick,\n    handleRoomClick,\n    handleSubjectClick\n  );\n\n  // Prepare data for form dialog\n  const classesForForm = classes.map((c) => ({\n    id: c.id,\n    code: c.code,\n    name: `${c.subject.name} (${c.semester.name})`,\n  }));\n\n  const roomsForForm = rooms.map((r) => ({\n    id: r.id,\n    name: r.name,\n    location: r.location,\n  }));\n  const staffForForm = staffListForForm.map((s) => ({\n    id: s.userId,\n    fullName: s.fullName,\n    username: s.username,\n  }));\n\n  // Set page header\n  useEffect(() => {\n    setPageHeader({\n      title: \"Slot Management\",\n      subtitle: \"Manage lecture slots and progress tests\",\n      breadcrumbs: [\n        { label: \"Dashboard\", href: \"/admin/dashboard\" },\n        { label: \"Slots\" },\n      ],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader]);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n        {/* Main Filters */}\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Semester Filter (REQUIRED) */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Semester: <span className=\"text-destructive\">*</span>\n            </span>\n            <Popover\n              open={semesterFilterOpen}\n              onOpenChange={setSemesterFilterOpen}\n            >\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  role=\"combobox\"\n                  aria-expanded={semesterFilterOpen}\n                  className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[150px]\"\n                >\n                  <span className=\"truncate\">\n                    {selectedSemester\n                      ? `${selectedSemester.code} - ${selectedSemester.name}`\n                      : \"Select semester...\"}\n                  </span>\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent align=\"start\" className=\"w-[350px] p-0\">\n                <Command>\n                  <CommandInput\n                    placeholder=\"Type to search semester...\"\n                    value={semesterFilterQuery}\n                    onValueChange={setSemesterFilterQuery}\n                  />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>No semester found.</CommandEmpty>\n                    <CommandGroup>\n                      {semesters.map((semester) => (\n                        <CommandItem\n                          key={semester.id}\n                          value={`${semester.code}-${semester.name}`}\n                          onSelect={() => {\n                            handleSemesterFilterChange(String(semester.id));\n                            setSemesterFilterOpen(false);\n                          }}\n                        >\n                          {semester.code} - {semester.name}\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Only show other filters when semester selected */}\n          {semesterIdFilter && (\n            <>\n              {/* Date Range Filters - Grouped */}\n              <div className=\"flex items-center gap-2 rounded-md border h-10 px-2 bg-background w-full sm:w-auto\">\n                {/* Start Date */}\n                <Popover open={startDateOpen} onOpenChange={setStartDateOpen}>\n                  <PopoverTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      className={cn(\n                        \"h-8 justify-start text-left font-normal px-2 w-[100px]\",\n                        !startTimeFromParam && \"text-muted-foreground\"\n                      )}\n                    >\n                      <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                      {startTimeFromParam\n                        ? format(new Date(startTimeFromParam), \"MMM d\")\n                        : \"Start\"}\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                    <Calendar\n                      mode=\"single\"\n                      selected={\n                        startTimeFromParam\n                          ? new Date(startTimeFromParam)\n                          : undefined\n                      }\n                      onSelect={handleStartDateChange}\n                      autoFocus\n                    />\n                  </PopoverContent>\n                </Popover>\n\n                <div className=\"h-6 w-px bg-border\" />\n\n                {/* End Date */}\n                <Popover open={endDateOpen} onOpenChange={setEndDateOpen}>\n                  <PopoverTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      className={cn(\n                        \"h-8 justify-start text-left font-normal px-2 w-[100px]\",\n                        !startTimeToParam && \"text-muted-foreground\"\n                      )}\n                    >\n                      <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                      {startTimeToParam\n                        ? format(new Date(startTimeToParam), \"MMM d\")\n                        : \"End\"}\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                    <Calendar\n                      mode=\"single\"\n                      selected={\n                        startTimeToParam\n                          ? new Date(startTimeToParam)\n                          : undefined\n                      }\n                      onSelect={handleEndDateChange}\n                      autoFocus\n                    />\n                  </PopoverContent>\n                </Popover>\n\n                {/* Clear Date Range Button */}\n                <>\n                  <div className=\"h-6 w-px bg-border\" />\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleClearDateRange}\n                    className=\"h-8 px-2 text-xs\"\n                  >\n                    Clear\n                  </Button>\n                </>\n              </div>\n\n              {/* Class Filter */}\n              <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n                <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n                  Class:\n                </span>\n                <Popover\n                  open={classFilterOpen}\n                  onOpenChange={setClassFilterOpen}\n                >\n                  <PopoverTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      role=\"combobox\"\n                      aria-expanded={classFilterOpen}\n                      className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[80px]\"\n                    >\n                      <span className=\"truncate\">\n                        {selectedClass ? selectedClass.code : \"All Classes\"}\n                      </span>\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent align=\"start\" className=\"w-[300px] p-0\">\n                    <Command>\n                      <CommandInput\n                        placeholder=\"Type to search class...\"\n                        value={classFilterQuery}\n                        onValueChange={setClassFilterQuery}\n                      />\n                      <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                        <CommandEmpty>No class found.</CommandEmpty>\n                        <CommandGroup>\n                          <CommandItem\n                            value=\"all-classes\"\n                            onSelect={() => {\n                              handleClassFilterChange(\"all\");\n                              setClassFilterOpen(false);\n                            }}\n                          >\n                            All Classes\n                          </CommandItem>\n                          {classes.map((cls) => (\n                            <CommandItem\n                              key={cls.id}\n                              value={`${cls.code}`}\n                              onSelect={() => {\n                                handleClassFilterChange(String(cls.id));\n                                setClassFilterOpen(false);\n                              }}\n                            >\n                              {cls.code}\n                            </CommandItem>\n                          ))}\n                        </CommandGroup>\n                      </CommandList>\n                    </Command>\n                  </PopoverContent>\n                </Popover>\n              </div>\n\n              {/* Subject Filter */}\n              <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n                <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n                  Subject:\n                </span>\n                <Popover\n                  open={subjectFilterOpen}\n                  onOpenChange={setSubjectFilterOpen}\n                >\n                  <PopoverTrigger asChild>\n                    <Button\n                      variant=\"ghost\"\n                      role=\"combobox\"\n                      aria-expanded={subjectFilterOpen}\n                      className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[150px]\"\n                    >\n                      <span className=\"truncate\">\n                        {selectedSubject\n                          ? `${selectedSubject.code} - ${selectedSubject.name}`\n                          : \"All Subjects\"}\n                      </span>\n                    </Button>\n                  </PopoverTrigger>\n                  <PopoverContent align=\"start\" className=\"w-[350px] p-0\">\n                    <Command>\n                      <CommandInput\n                        placeholder=\"Type to search subject...\"\n                        value={subjectFilterQuery}\n                        onValueChange={setSubjectFilterQuery}\n                      />\n                      <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                        <CommandEmpty>No subject found.</CommandEmpty>\n                        <CommandGroup>\n                          <CommandItem\n                            value=\"all-subjects\"\n                            onSelect={() => {\n                              handleSubjectFilterChange(\"all\");\n                              setSubjectFilterOpen(false);\n                            }}\n                          >\n                            All Subjects\n                          </CommandItem>\n                          {subjects.map((subject) => (\n                            <CommandItem\n                              key={subject.id}\n                              value={`${subject.code}-${subject.name}`}\n                              onSelect={() => {\n                                handleSubjectFilterChange(String(subject.id));\n                                setSubjectFilterOpen(false);\n                              }}\n                            >\n                              {subject.code} - {subject.name}\n                            </CommandItem>\n                          ))}\n                        </CommandGroup>\n                      </CommandList>\n                    </Command>\n                  </PopoverContent>\n                </Popover>\n              </div>\n\n              {/* Advanced Filters Button */}\n              <Popover\n                open={advancedFiltersOpen}\n                onOpenChange={setAdvancedFiltersOpen}\n              >\n                <PopoverTrigger asChild>\n                  <Button variant=\"outline\" className=\"h-10 w-full sm:w-auto\">\n                    <SlidersHorizontal className=\"mr-2 h-4 w-4\" />\n                    Advanced Filters\n                  </Button>\n                </PopoverTrigger>\n                <PopoverContent align=\"start\" className=\"w-[400px] p-4\">\n                  <div className=\"space-y-4\">\n                    <h4 className=\"font-medium text-sm\">Advanced Filters</h4>\n\n                    {/* Room Filter */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm text-muted-foreground\">\n                        Room\n                      </label>\n                      <Popover\n                        open={roomFilterOpen}\n                        onOpenChange={setRoomFilterOpen}\n                      >\n                        <PopoverTrigger asChild>\n                          <Button\n                            variant=\"outline\"\n                            role=\"combobox\"\n                            className=\"w-full justify-between\"\n                          >\n                            {selectedRoom ? selectedRoom.name : \"All Rooms\"}\n                          </Button>\n                        </PopoverTrigger>\n                        <PopoverContent className=\"w-[350px] p-0\" align=\"start\">\n                          <Command>\n                            <CommandInput\n                              placeholder=\"Search room...\"\n                              value={roomFilterQuery}\n                              onValueChange={setRoomFilterQuery}\n                            />\n                            <CommandList className=\"max-h-[200px] overflow-y-auto\">\n                              <CommandEmpty>No room found.</CommandEmpty>\n                              <CommandGroup>\n                                <CommandItem\n                                  value=\"all-rooms\"\n                                  onSelect={() => {\n                                    handleRoomFilterChange(\"all\");\n                                    setRoomFilterOpen(false);\n                                  }}\n                                >\n                                  All Rooms\n                                </CommandItem>\n                                {rooms.map((room) => (\n                                  <CommandItem\n                                    key={room.id}\n                                    value={`${room.name} ${room.location}`}\n                                    onSelect={() => {\n                                      handleRoomFilterChange(String(room.id));\n                                      setRoomFilterOpen(false);\n                                    }}\n                                  >\n                                    {room.name} - {room.location}\n                                  </CommandItem>\n                                ))}\n                              </CommandGroup>\n                            </CommandList>\n                          </Command>\n                        </PopoverContent>\n                      </Popover>\n                    </div>\n\n                    {/* Staff Filter */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm text-muted-foreground\">\n                        Staff\n                      </label>\n                      <Popover\n                        open={staffFilterOpen}\n                        onOpenChange={(open) => {\n                          if (open) setStaffFilterQuery(\"\");  // Clear when opening\n                          setStaffFilterOpen(open);\n                        }}\n                      >\n                        <PopoverTrigger asChild>\n                          <Button\n                            variant=\"outline\"\n                            role=\"combobox\"\n                            className=\"w-full justify-between\"\n                          >\n                            {selectedStaff\n                              ? selectedStaff.fullName\n                              : \"All Staff\"}\n                          </Button>\n                        </PopoverTrigger>\n                        <PopoverContent className=\"w-[350px] p-0\" align=\"start\">\n                          <Command>\n                            <CommandInput\n                              placeholder=\"Search staff...\"\n                              value={staffFilterQuery}\n                              onValueChange={setStaffFilterQuery}\n                            />\n                            <CommandList className=\"max-h-[200px] overflow-y-auto\">\n                              <CommandEmpty>No staff found.</CommandEmpty>\n                              <CommandGroup>\n                                <CommandItem\n                                  value=\"all-staff\"\n                                  onSelect={() => {\n                                    handleStaffFilterChange(\"all\");\n                                    setStaffFilterOpen(false);\n                                  }}\n                                >\n                                  All Staff\n                                </CommandItem>\n                                {staffList.map((staff) => (\n                                  <CommandItem\n                                    key={staff.userId}\n                                    value={`${staff.fullName} ${staff.username}`}\n                                    onSelect={() => {\n                                      handleStaffFilterChange(\n                                        String(staff.userId)\n                                      );\n                                      setStaffFilterOpen(false);\n                                    }}\n                                  >\n                                    {staff.fullName}\n                                  </CommandItem>\n                                ))}\n                              </CommandGroup>\n                            </CommandList>\n                          </Command>\n                        </PopoverContent>\n                      </Popover>\n                    </div>\n\n                    {/* Status Filter */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm text-muted-foreground\">\n                        Status\n                      </label>\n                      <Select\n                        value={\n                          isActiveFilter === undefined\n                            ? \"all\"\n                            : isActiveFilter\n                            ? \"true\"\n                            : \"false\"\n                        }\n                        onValueChange={handleIsActiveFilterChange}\n                      >\n                        <SelectTrigger className=\"w-full\">\n                          <SelectValue placeholder=\"Status...\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"all\">All Status</SelectItem>\n                          <SelectItem value=\"true\">Active</SelectItem>\n                          <SelectItem value=\"false\">Inactive</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n\n                    {/* Sort Controls */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-sm text-muted-foreground\">\n                        Sort\n                      </label>\n                      <div className=\"flex gap-2\">\n                        <Select\n                          value={sortBy}\n                          onValueChange={handleSortByChange}\n                        >\n                          <SelectTrigger className=\"flex-1\">\n                            <SelectValue placeholder=\"Sort by...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"startTime\">\n                              Start Time\n                            </SelectItem>\n                            <SelectItem value=\"endTime\">End Time</SelectItem>\n                            <SelectItem value=\"slotCategory\">\n                              Category\n                            </SelectItem>\n                          </SelectContent>\n                        </Select>\n                        <Select\n                          value={sortOrder}\n                          onValueChange={handleSortOrderChange}\n                        >\n                          <SelectTrigger className=\"flex-1\">\n                            <SelectValue placeholder=\"Order...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"asc\">Ascending</SelectItem>\n                            <SelectItem value=\"desc\">Descending</SelectItem>\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </div>\n\n                    {/* Clear Advanced Filters Button */}\n                    <div className=\"pt-2 border-t\">\n                      <Button\n                        variant=\"outline\"\n                        onClick={handleClearAdvancedFilters}\n                        className=\"w-full\"\n                      >\n                        Clear All Advanced Filters\n                      </Button>\n                    </div>\n                  </div>\n                </PopoverContent>\n              </Popover>\n            </>\n          )}\n        </div>\n\n        {/* Action Buttons */}\n        <div className=\"flex gap-2 w-full sm:w-auto lg:ml-4\">\n          <Button\n            onClick={() => setIsImportDialogOpen(true)}\n            className=\"flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white\"\n          >\n            <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n            Import\n          </Button>\n          <Button\n            onClick={() => setIsCreateDialogOpen(true)}\n            className=\"flex-1 sm:flex-none\"\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            Create Slot\n          </Button>\n        </div>\n      </div>\n\n      <SlotTable\n        columns={columns}\n        data={slots}\n        isLoading={isLoading}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={data?.pageSize ?? DEFAULT_PAGE_SIZE}\n        onPageChange={handlePageChange}\n      />\n\n      <SlotFormDialog\n        open={isCreateDialogOpen}\n        onOpenChange={setIsCreateDialogOpen}\n        onSubmit={handleCreate}\n        isSubmitting={createMutation.isPending}\n        semesterId={semesterIdFilter}\n        classes={classesForForm}\n        rooms={roomsForForm}\n        staff={staffForForm}\n      />\n\n      <SlotFormDialog\n        open={isEditDialogOpen}\n        onOpenChange={setIsEditDialogOpen}\n        slot={selectedSlot || undefined}\n        onSubmit={handleUpdate}\n        isSubmitting={updateMutation.isPending}\n        semesterId={semesterIdFilter}\n        classes={classesForForm}\n        rooms={roomsForForm}\n        staff={staffForForm}\n      />\n\n      <DeleteSlotDialog\n        open={isDeleteDialogOpen}\n        onOpenChange={setIsDeleteDialogOpen}\n        slot={selectedSlot}\n        onConfirm={handleConfirmDelete}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      <GenericImportDialog\n        open={isImportDialogOpen}\n        onOpenChange={setIsImportDialogOpen}\n        title=\"Import Slots from CSV\"\n        csvColumns={[\n          \"title\",\n          \"start_time\",\n          \"end_time\",\n          \"slot_category\",\n          \"class_code\",\n          \"semester_code\",\n          \"room_name\",\n          \"staff_username\",\n        ]}\n        importMutation={importSlotsMutation}\n        successMessage=\"All slots imported successfully!\"\n        entityName=\"slots\"\n      />\n    </div>\n  );\n}\n\nexport default function SlotsPage() {\n  return (\n    <Suspense fallback={<div>Loading...</div>}>\n      <SlotsContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\subjects\\page.tsx",
      "relative_path": "app/admin/subjects/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 17954,
      "lines": 523,
      "last_modified": "2025-11-14T17:40:36.294864",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useState } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { Plus, FileSpreadsheet } from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from 'next-intl';\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { SubjectTable } from \"@/components/admin/subjects/subject-table\";\nimport { createSubjectColumns } from \"@/components/admin/subjects/subject-columns\";\nimport {\n  SubjectFormDialog,\n  SubjectFormData,\n} from \"@/components/admin/subjects/subject-form-dialog\";\nimport { DeleteSubjectDialog } from \"@/components/admin/subjects/delete-subject-dialog\";\nimport GenericImportDialog from \"@/components/admin/shared/generic-import-dialog\";\nimport { Subject } from \"@/types\";\nimport {\n  useGetSubjects,\n  useGetSubjectById,\n  useCreateSubject,\n  useUpdateSubject,\n  useDeleteSubject,\n  useImportSubjects,\n} from \"@/hooks/api/useSubjects\";\nimport { useGetMajors } from \"@/hooks/api/useMajors\";\nimport { DEFAULT_PAGE_SIZE, FILTER_PAGE_SIZE } from \"@/lib/constants\";\n\nfunction SubjectsContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const t = useTranslations('subject');\n  const tImport = useTranslations('import');\n\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const searchQuery = searchParams.get(\"search\") || \"\";\n  const sortBy = (\n    [\"name\", \"code\"].includes(searchParams.get(\"sortBy\") || \"\")\n      ? searchParams.get(\"sortBy\")\n      : \"name\"\n  ) as \"name\" | \"code\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n  const isActiveParam = searchParams.get(\"isActive\");\n  const isActiveFilter =\n    isActiveParam === \"false\"\n      ? false\n      : isActiveParam === \"true\"\n      ? true\n      : undefined; // Default to all\n  const majorIdParam = searchParams.get(\"majorId\");\n  const majorIdFilter = majorIdParam ? Number(majorIdParam) : undefined;\n\n  const [localSearchValue, setLocalSearchValue] = useState(searchQuery);\n  const [majorFilterOpen, setMajorFilterOpen] = useState(false);\n  const [majorFilterQuery, setMajorFilterQuery] = useState(\"\");\n\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n  const [selectedSubjectId, setSelectedSubjectId] = useState<number | null>(\n    null\n  );\n  const [deleteTargetSubject, setDeleteTargetSubject] =\n    useState<Subject | null>(null);\n\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    if (!newParams.has(\"sortBy\")) {\n      newParams.set(\"sortBy\", sortBy);\n    }\n    if (!newParams.has(\"sort\")) {\n      newParams.set(\"sort\", sortOrder);\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (localSearchValue !== searchQuery) {\n        updateURL({\n          search: localSearchValue || undefined,\n          page: 1,\n        });\n      }\n    }, 500);\n\n    return () => clearTimeout(timer);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [localSearchValue, searchQuery]);\n\n  useEffect(() => {\n    setLocalSearchValue(searchQuery);\n  }, [searchQuery]);\n\n  useEffect(() => {\n    setPageHeader({\n      breadcrumbs: [\n        { label: t('breadcrumb_dashboard'), href: \"/admin/dashboard\" },\n        { label: t('breadcrumb_subjects') },\n      ],\n      title: t('page_title'),\n      subtitle: t('page_subtitle'),\n    });\n\n    return () => clearPageHeader();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [t]);\n\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n    const needsUpdate =\n      !currentParams.has(\"sortBy\") ||\n      !currentParams.has(\"sort\") ||\n      (page !== 1 && !currentParams.has(\"page\"));\n\n    if (needsUpdate) {\n      const newParams = new URLSearchParams();\n\n      newParams.set(\"sortBy\", sortBy);\n      newParams.set(\"sort\", sortOrder);\n\n      if (page !== 1) {\n        newParams.set(\"page\", String(page));\n      }\n\n      if (searchQuery) {\n        newParams.set(\"search\", searchQuery);\n      }\n\n      if (isActiveParam) {\n        newParams.set(\"isActive\", isActiveParam);\n      }\n\n      if (majorIdParam) {\n        newParams.set(\"majorId\", majorIdParam);\n      }\n\n      const newURL = `${pathname}?${newParams.toString()}`;\n      router.replace(newURL, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const { data, isLoading } = useGetSubjects({\n    page,\n    pageSize: DEFAULT_PAGE_SIZE,\n    search: searchQuery,\n    sort: sortOrder,\n    sortBy: sortBy,\n    isActive: isActiveFilter,\n    majorId: majorIdFilter,\n  });\n\n  // Fetch selected subject for editing\n  const { data: selectedSubject, isLoading: isLoadingSubject } =\n    useGetSubjectById(selectedSubjectId || 0);\n\n  // Fetch all active majors for the form dialog\n  const { data: majorsData } = useGetMajors({\n    pageSize: FILTER_PAGE_SIZE,\n    isActive: true,\n  });\n\n  // Fetch all majors for filter dropdown (including inactive)\n  const { data: allMajorsData } = useGetMajors({\n    pageSize: FILTER_PAGE_SIZE,\n    sortBy: \"code\",\n    search: majorFilterQuery || undefined,\n  });\n\n  const createMutation = useCreateSubject();\n  const updateMutation = useUpdateSubject();\n  const deleteMutation = useDeleteSubject();\n  const importMutation = useImportSubjects();\n\n  const subjects = data?.items || [];\n  const totalPages = data?.totalPages || 1;\n  const totalItems = data?.totalItems || 0;\n  const currentPage = data?.currentPage || 1;\n  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;\n  const availableMajors = majorsData?.items || [];\n  const allMajors = allMajorsData?.items || [];\n\n  const handleCreate = async (data: SubjectFormData) => {\n    await createMutation.mutateAsync({\n      name: data.name,\n      code: data.code,\n      majorIds: data.majorIds,\n    });\n    setIsCreateDialogOpen(false);\n    updateURL({ page: 1 });\n  };\n\n  const handleEdit = (subject: Subject) => {\n    setSelectedSubjectId(subject.id);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = async (data: SubjectFormData) => {\n    if (!selectedSubject) return;\n\n    await updateMutation.mutateAsync({\n      id: selectedSubject.id,\n      payload: {\n        name: data.name,\n        code: data.code,\n        majorIds: data.majorIds,\n        isActive: data.isActive!,\n      },\n    });\n    setIsEditDialogOpen(false);\n    setSelectedSubjectId(null);\n  };\n\n  const handleDeleteFromDialog = (subject: Subject) => {\n    setDeleteTargetSubject(subject);\n    setIsDeleteDialogOpen(true);\n  };\n\n  const handleConfirmDelete = () => {\n    if (!deleteTargetSubject) return;\n\n    deleteMutation.mutate(deleteTargetSubject.id, {\n      onSuccess: () => {\n        setIsDeleteDialogOpen(false);\n        setIsEditDialogOpen(false);\n        setSelectedSubjectId(null);\n        setDeleteTargetSubject(null);\n        if (subjects.length === 1 && currentPage > 1) {\n          updateURL({ page: currentPage - 1 });\n        }\n      },\n    });\n  };\n\n  const handlePageChange = (newPage: number) => {\n    updateURL({ page: newPage });\n  };\n\n  const handleSearchChange = (value: string) => {\n    setLocalSearchValue(value);\n  };\n\n  const handleSortByChange = (value: \"name\" | \"code\") => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleIsActiveFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ isActive: undefined, page: 1 });\n    } else {\n      updateURL({ isActive: value, page: 1 });\n    }\n  };\n\n  const handleMajorFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ majorId: undefined, page: 1 });\n    } else {\n      updateURL({ majorId: value, page: 1 });\n    }\n  };\n\n  const handleMajorClick = (majorName: string) => {\n    router.push(`/admin/majors?search=${encodeURIComponent(majorName)}`);\n  };\n\n  const columns = createSubjectColumns(handleEdit, handleMajorClick);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row - Mobile: Stack vertically, Desktop: Horizontal */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        {/* Search and Filters - Stack on mobile, row on tablet+ */}\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Search Input */}\n          <Input\n            placeholder={t('search_placeholder')}\n            value={localSearchValue}\n            onChange={(e) => handleSearchChange(e.target.value)}\n            className=\"w-full sm:max-w-[240px] md:max-w-sm\"\n            autoComplete=\"off\"\n          />\n\n          {/* Status Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('status_label')}\n            </span>\n            <Select\n              value={\n                isActiveFilter === undefined\n                  ? \"all\"\n                  : isActiveFilter\n                  ? \"true\"\n                  : \"false\"\n              }\n              onValueChange={handleIsActiveFilterChange}\n            >\n              <SelectTrigger className=\"w-full sm:w-[140px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('status_label')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">{t('status_all')}</SelectItem>\n                <SelectItem value=\"true\">{t('status_active')}</SelectItem>\n                <SelectItem value=\"false\">{t('status_inactive')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Sort Controls - Compact on mobile */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('sort_label')}\n            </span>\n            <Select value={sortBy} onValueChange={handleSortByChange}>\n              <SelectTrigger className=\"w-full sm:w-[130px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('sort_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"name\">{t('sort_name')}</SelectItem>\n                <SelectItem value=\"code\">{t('sort_code')}</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"h-6 w-px bg-border\" />\n            <Select value={sortOrder} onValueChange={handleSortOrderChange}>\n              <SelectTrigger className=\"w-full sm:w-[120px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder={t('order_placeholder')} />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"asc\">{t('order_asc')}</SelectItem>\n                <SelectItem value=\"desc\">{t('order_desc')}</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Major Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('major_label')}\n            </span>\n            <Popover open={majorFilterOpen} onOpenChange={setMajorFilterOpen}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  className=\"w-full sm:w-[220px] h-full justify-start border-0 shadow-none hover:bg-transparent px-0 font-normal\"\n                >\n                  {majorIdFilter\n                    ? allMajors.find((m) => m.id === majorIdFilter)\n                      ? `${\n                          allMajors.find((m) => m.id === majorIdFilter)!.code\n                        } - ${\n                          allMajors.find((m) => m.id === majorIdFilter)!.name\n                        }`\n                      : t('all_majors')\n                    : t('all_majors')}\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent align=\"start\" className=\"w-[300px] p-0\">\n                <Command>\n                  <CommandInput\n                    placeholder={t('type_to_search_major')}\n                    value={majorFilterQuery}\n                    onValueChange={setMajorFilterQuery}\n                  />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>{t('no_major_found')}</CommandEmpty>\n                    <CommandGroup>\n                      <CommandItem\n                        onSelect={() => {\n                          handleMajorFilterChange(\"all\");\n                          setMajorFilterOpen(false);\n                        }}\n                      >\n                        {t('all_majors')}\n                      </CommandItem>\n                      {allMajors.map((major) => (\n                        <CommandItem\n                          key={major.id}\n                          value={`${major.code} ${major.name}`}\n                          onSelect={() => {\n                            handleMajorFilterChange(String(major.id));\n                            setMajorFilterOpen(false);\n                          }}\n                        >\n                          {major.code} - {major.name}\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n        </div>\n\n        {/* Action Buttons - Full width on mobile, side by side on tablet+ */}\n        <div className=\"flex flex-col sm:flex-row gap-2 w-full sm:w-auto\">\n          <Button\n            onClick={() => setIsImportDialogOpen(true)}\n            className=\"w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white\"\n          >\n            <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n            {t('import_button')}\n          </Button>\n          <Button\n            onClick={() => setIsCreateDialogOpen(true)}\n            className=\"w-full sm:w-auto\"\n          >\n            <Plus className=\"mr-2 h-4 w-4\" />\n            {t('create_button')}\n          </Button>\n        </div>\n      </div>\n\n      <SubjectTable\n        columns={columns}\n        data={subjects}\n        isLoading={isLoading}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={pageSize}\n        onPageChange={handlePageChange}\n      />\n\n      <SubjectFormDialog\n        open={isCreateDialogOpen}\n        onOpenChange={setIsCreateDialogOpen}\n        onSubmit={handleCreate}\n        isSubmitting={createMutation.isPending}\n        availableMajors={availableMajors}\n      />\n\n      <SubjectFormDialog\n        open={isEditDialogOpen}\n        onOpenChange={setIsEditDialogOpen}\n        subject={selectedSubject}\n        isLoadingSubject={isLoadingSubject}\n        onSubmit={handleUpdate}\n        onDelete={handleDeleteFromDialog}\n        isSubmitting={updateMutation.isPending}\n        isDeleting={deleteMutation.isPending}\n        availableMajors={availableMajors}\n      />\n\n      <DeleteSubjectDialog\n        open={isDeleteDialogOpen}\n        onOpenChange={setIsDeleteDialogOpen}\n        subject={deleteTargetSubject}\n        onConfirm={handleConfirmDelete}\n        isDeleting={deleteMutation.isPending}\n      />\n\n      <GenericImportDialog\n        open={isImportDialogOpen}\n        onOpenChange={setIsImportDialogOpen}\n        title={tImport('title')}\n        csvColumns={[\"code\", \"name\", \"major_codes\", \"status\"]}\n        importMutation={importMutation}\n        successMessage={tImport('success_message')}\n        entityName={tImport('entity_name')}\n      />\n    </div>\n  );\n}\n\nexport default function SubjectsPage() {\n  const t = useTranslations('subject');\n\n  return (\n    <Suspense fallback={<div>{t('loading')}</div>}>\n      <SubjectsContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\admin\\users-roles\\page.tsx",
      "relative_path": "app/admin/users-roles/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 33026,
      "lines": 946,
      "last_modified": "2025-11-13T21:14:04.080536",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useMemo, useState } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { FileSpreadsheet, FileArchive } from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { ColumnDef } from \"@tanstack/react-table\";\nimport { useGetMajors } from \"@/hooks/api/useMajors\";\nimport {\n  useGetStudentProfiles,\n  useImportStudentProfiles,\n} from \"@/hooks/api/useStudentProfiles\";\nimport {\n  useGetStaffProfiles,\n  useImportStaffProfiles,\n} from \"@/hooks/api/useStaffProfiles\";\nimport { useGetRoles } from \"@/hooks/api/useRoles\";\nimport { staffProfileToRow } from \"@/lib/adapters/staff-profile-adapter\";\nimport { FILTER_PAGE_SIZE } from \"@/lib/constants\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  createStudentColumns,\n  type StudentUserRow,\n} from \"@/components/admin/users-roles/student-columns\";\nimport {\n  createStaffColumns,\n  type StaffUserRow,\n} from \"@/components/admin/users-roles/staff-columns\";\nimport { StudentTable } from \"@/components/admin/users-roles/student-table\";\nimport { StaffTable } from \"@/components/admin/users-roles/staff-table\";\nimport {\n  EditStudentDialog,\n  CreateStudentDialog,\n} from \"@/components/admin/users-roles/student-dialogs\";\nimport { StudentAttendanceHistoryDialog } from \"@/components/admin/users-roles/student-attendance-history-dialog\";\nimport {\n  EditStaffDialog,\n  CreateStaffDialog,\n} from \"@/components/admin/users-roles/staff-form-dialogs\";\nimport { MultiSelectRoleFilter } from \"@/components/admin/users-roles/multi-select-role-filter\";\nimport GenericImportDialog from \"@/components/admin/shared/generic-import-dialog\";\nimport ImportPhotosEmbeddingsDialog from \"@/components/admin/users-roles/import-photos-embeddings-dialog\";\n\nconst PAGE_SIZE = 10;\n\nfunction StudentsTab() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n\n  // Read state from URL\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const searchQuery = searchParams.get(\"search\") || \"\";\n  const sortBy = (\n    [\"fullName\", \"rollNumber\", \"email\", \"majorName\"].includes(\n      searchParams.get(\"sortBy\") || \"\"\n    )\n      ? searchParams.get(\"sortBy\")\n      : \"fullName\"\n  ) as \"fullName\" | \"rollNumber\" | \"email\" | \"majorName\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n  const statusParam = searchParams.get(\"status\");\n  const status =\n    statusParam === \"true\" ? true : statusParam === \"false\" ? false : undefined;\n  const majorIdParam = searchParams.get(\"majorId\");\n  const majorId = majorIdParam ? Number(majorIdParam) : undefined;\n\n  // Local state for debounced search and UI controls\n  const [localSearchValue, setLocalSearchValue] = useState(searchQuery);\n  const [majorFilterOpen, setMajorFilterOpen] = useState(false);\n  const [editTarget, setEditTarget] = useState<StudentUserRow | null>(null);\n  const [createOpen, setCreateOpen] = useState(false);\n  const [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n  const [\n    isImportPhotosEmbeddingsDialogOpen,\n    setIsImportPhotosEmbeddingsDialogOpen,\n  ] = useState(false);\n  const [importPopoverOpen, setImportPopoverOpen] = useState(false);\n  const [attendanceHistoryStudent, setAttendanceHistoryStudent] =\n    useState<StudentUserRow | null>(null);\n\n  // Update URL helper\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    // Always keep tab param\n    if (!newParams.has(\"tab\")) {\n      newParams.set(\"tab\", \"students\");\n    }\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        // Don't add page=1 to URL (it's default)\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        // Remove param if value is undefined or empty\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    // Ensure sort params always exist\n    if (!newParams.has(\"sortBy\")) {\n      newParams.set(\"sortBy\", sortBy);\n    }\n    if (!newParams.has(\"sort\")) {\n      newParams.set(\"sort\", sortOrder);\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  // Debounce search input\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (localSearchValue !== searchQuery) {\n        updateURL({\n          search: localSearchValue || undefined,\n          page: 1,\n        });\n      }\n    }, 500);\n\n    return () => clearTimeout(timer);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [localSearchValue, searchQuery]);\n\n  // Sync local search with URL\n  useEffect(() => {\n    setLocalSearchValue(searchQuery);\n  }, [searchQuery]);\n\n  // Initialize URL with default params on first load\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n    const needsUpdate =\n      !currentParams.has(\"tab\") ||\n      !currentParams.has(\"sortBy\") ||\n      !currentParams.has(\"sort\");\n\n    if (needsUpdate) {\n      const newParams = new URLSearchParams();\n\n      // Set defaults\n      newParams.set(\"tab\", \"students\");\n      newParams.set(\"sortBy\", sortBy);\n      newParams.set(\"sort\", sortOrder);\n\n      // Keep existing params\n      if (page !== 1) {\n        newParams.set(\"page\", String(page));\n      }\n      if (searchQuery) {\n        newParams.set(\"search\", searchQuery);\n      }\n      if (statusParam) {\n        newParams.set(\"status\", statusParam);\n      }\n      if (majorIdParam) {\n        newParams.set(\"majorId\", majorIdParam);\n      }\n\n      const newURL = `${pathname}?${newParams.toString()}`;\n      router.replace(newURL, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Fetch majors for filter dropdown\n  const { data: allMajorsData } = useGetMajors({ pageSize: FILTER_PAGE_SIZE });\n  const allMajors = useMemo(() => allMajorsData?.items || [], [allMajorsData]);\n\n  // Fetch student profiles from API with URL params\n  const { data: studentProfilesData, isLoading: loadingStudents } =\n    useGetStudentProfiles({\n      page,\n      pageSize: PAGE_SIZE,\n      search: searchQuery,\n      isActive: status,\n      majorId,\n      sort: sortOrder,\n      sortBy,\n    });\n\n  const importStudentProfilesMutation = useImportStudentProfiles();\n\n  // Convert API data to UI format (inline mapping)\n  const data = useMemo(() => {\n    return (\n      studentProfilesData?.items?.map((profile) => ({\n        id: profile.userId,\n        rollNumber: profile.rollNumber,\n        fullName: profile.fullName,\n        email: profile.email,\n        major: profile.major.code,\n        majorId: profile.major.id,\n        isActive: profile.isActive,\n        createdAt: profile.createdAt,\n        lastActiveAt: profile.updatedAt,\n      })) || []\n    );\n  }, [studentProfilesData]);\n\n  // Use server-side pagination data\n  const totalItems = studentProfilesData?.totalItems || 0;\n  const totalPages = studentProfilesData?.totalPages || 1;\n  const currentPage = studentProfilesData?.currentPage || 1;\n  const pageSize = studentProfilesData?.pageSize ?? PAGE_SIZE;\n  const pagedData = data; // Already paginated from API\n\n  // Event handlers\n  const handleSearchChange = (value: string) => {\n    setLocalSearchValue(value);\n  };\n\n  const handlePageChange = (newPage: number) => {\n    updateURL({ page: newPage });\n  };\n\n  const handleStatusChange = (value: string) => {\n    updateURL({\n      status: value === \"all\" ? undefined : value,\n      page: 1,\n    });\n  };\n\n  const handleMajorChange = (value: number | undefined) => {\n    updateURL({\n      majorId: value,\n      page: 1,\n    });\n  };\n\n  const handleSortByChange = (\n    value: \"fullName\" | \"rollNumber\" | \"email\" | \"majorName\"\n  ) => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleMajorClick = (majorCode: string) => {\n    router.push(`/admin/majors?search=${encodeURIComponent(majorCode)}`);\n  };\n\n  const columns: ColumnDef<StudentUserRow>[] = createStudentColumns(\n    (row) => {\n      setEditTarget(row);\n    },\n    (row) => {\n      setAttendanceHistoryStudent(row);\n    },\n    handleMajorClick,\n    allMajors\n  );\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Search */}\n          <Input\n            placeholder=\"Search name/email/roll number...\"\n            value={localSearchValue}\n            onChange={(e) => handleSearchChange(e.target.value)}\n            className=\"w-full sm:max-w-[240px] md:max-w-sm\"\n            autoComplete=\"off\"\n          />\n\n          {/* Status Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Status:\n            </span>\n            <Select\n              value={status === undefined ? \"all\" : status ? \"true\" : \"false\"}\n              onValueChange={handleStatusChange}\n            >\n              <SelectTrigger className=\"w-full sm:w-[140px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder=\"Status...\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Status</SelectItem>\n                <SelectItem value=\"true\">Active</SelectItem>\n                <SelectItem value=\"false\">Inactive</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Major Filter (searchable popover) */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Major:\n            </span>\n            <Popover open={majorFilterOpen} onOpenChange={setMajorFilterOpen}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  className=\"w-full sm:w-[220px] h-full justify-start border-0 shadow-none hover:bg-transparent px-0 font-normal\"\n                >\n                  {majorId\n                    ? (() => {\n                        const m = allMajors.find((x) => x.id === majorId);\n                        return m ? `${m.code} - ${m.name}` : \"All Majors\";\n                      })()\n                    : \"All Majors\"}\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent align=\"start\" className=\"w-[300px] p-0\">\n                <Command>\n                  <CommandInput placeholder=\"Type to search major...\" />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>No results found.</CommandEmpty>\n                    <CommandGroup>\n                      <CommandItem\n                        onSelect={() => {\n                          handleMajorChange(undefined);\n                          setMajorFilterOpen(false);\n                        }}\n                      >\n                        All Majors\n                      </CommandItem>\n                      {allMajors.map((major) => (\n                        <CommandItem\n                          key={major.id}\n                          value={`${major.code} ${major.name}`}\n                          onSelect={() => {\n                            handleMajorChange(major.id);\n                            setMajorFilterOpen(false);\n                          }}\n                        >\n                          {major.code} - {major.name}\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Sort Controls - Like Semester */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Sort:\n            </span>\n            <Select value={sortBy} onValueChange={handleSortByChange}>\n              <SelectTrigger className=\"w-full sm:w-[130px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder=\"Sort by...\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"fullName\">Full Name</SelectItem>\n                <SelectItem value=\"rollNumber\">Roll Number</SelectItem>\n                <SelectItem value=\"email\">Email</SelectItem>\n                <SelectItem value=\"majorName\">Major</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"h-6 w-px bg-border\" />\n            <Select value={sortOrder} onValueChange={handleSortOrderChange}>\n              <SelectTrigger className=\"w-full sm:w-[120px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder=\"Order...\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"asc\">Ascending</SelectItem>\n                <SelectItem value=\"desc\">Descending</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n\n        {/* Action Buttons */}\n        <div className=\"flex gap-2 w-full sm:w-auto\">\n          {/* Import Popover with 2 options */}\n          <Popover open={importPopoverOpen} onOpenChange={setImportPopoverOpen}>\n            <PopoverTrigger asChild>\n              <Button className=\"flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white\">\n                <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n                Import\n              </Button>\n            </PopoverTrigger>\n            <PopoverContent align=\"end\" className=\"w-[280px] p-0\">\n              <Command>\n                <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                  <CommandGroup>\n                    <CommandItem\n                      onSelect={() => {\n                        setIsImportDialogOpen(true);\n                        setImportPopoverOpen(false);\n                      }}\n                      className=\"cursor-pointer\"\n                    >\n                      <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n                      <div className=\"flex-1\">\n                        <p className=\"font-medium\">Import Student Profiles</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          CSV file with student data\n                        </p>\n                      </div>\n                    </CommandItem>\n                    <CommandItem\n                      onSelect={() => {\n                        setIsImportPhotosEmbeddingsDialogOpen(true);\n                        setImportPopoverOpen(false);\n                      }}\n                      className=\"cursor-pointer\"\n                    >\n                      <FileArchive className=\"mr-2 h-4 w-4\" />\n                      <div className=\"flex-1\">\n                        <p className=\"font-medium\">\n                          Import Photos & Embeddings\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          CSV + ZIP with student photos\n                        </p>\n                      </div>\n                    </CommandItem>\n                  </CommandGroup>\n                </CommandList>\n              </Command>\n            </PopoverContent>\n          </Popover>\n\n          <Button\n            className=\"flex-1 sm:flex-none\"\n            onClick={() => setCreateOpen(true)}\n          >\n            Create Student\n          </Button>\n        </div>\n      </div>\n\n      <StudentTable\n        columns={columns}\n        data={pagedData}\n        isLoading={loadingStudents}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={pageSize}\n        onPageChange={handlePageChange}\n      />\n\n      <EditStudentDialog\n        open={!!editTarget}\n        student={editTarget}\n        onOpenChange={(open) => !open && setEditTarget(null)}\n        onSave={() => setEditTarget(null)}\n        availableMajors={allMajors}\n      />\n      <CreateStudentDialog\n        open={createOpen}\n        onOpenChange={setCreateOpen}\n        onCreate={() => setCreateOpen(false)}\n        availableMajors={allMajors}\n      />\n      {attendanceHistoryStudent && (\n        <StudentAttendanceHistoryDialog\n          open={!!attendanceHistoryStudent}\n          onOpenChange={(open) => !open && setAttendanceHistoryStudent(null)}\n          studentId={attendanceHistoryStudent.id}\n          studentName={attendanceHistoryStudent.fullName}\n          studentRollNumber={attendanceHistoryStudent.rollNumber}\n        />\n      )}\n      <GenericImportDialog\n        open={isImportDialogOpen}\n        onOpenChange={setIsImportDialogOpen}\n        title=\"Import Student Profiles from CSV\"\n        csvColumns={[\n          \"full_name\",\n          \"email\",\n          \"username\",\n          \"roll_number\",\n          \"major_code\",\n          \"status (optional)\",\n          \"password (optional)\",\n        ]}\n        importMutation={importStudentProfilesMutation}\n        successMessage=\"All student profiles imported successfully!\"\n        entityName=\"student profiles\"\n      />\n      <ImportPhotosEmbeddingsDialog\n        open={isImportPhotosEmbeddingsDialogOpen}\n        onOpenChange={setIsImportPhotosEmbeddingsDialogOpen}\n      />\n    </div>\n  );\n}\n\nfunction StaffsTab() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n\n  // Read state from URL\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const searchQuery = searchParams.get(\"search\") || \"\";\n  const sortBy = (\n    [\"fullName\", \"staffCode\", \"email\"].includes(\n      searchParams.get(\"sortBy\") || \"\"\n    )\n      ? searchParams.get(\"sortBy\")\n      : \"fullName\"\n  ) as \"fullName\" | \"staffCode\" | \"email\";\n  const sortOrder = (searchParams.get(\"sort\") === \"desc\" ? \"desc\" : \"asc\") as\n    | \"asc\"\n    | \"desc\";\n  const statusParam = searchParams.get(\"status\");\n  const status =\n    statusParam === \"true\" ? true : statusParam === \"false\" ? false : undefined;\n\n  // Parse roleIds from URL - can be comma-separated (e.g., \"1,2,3\")\n  const roleIdsParam = searchParams.get(\"roleIds\");\n  const roleIds: number[] = roleIdsParam\n    ? roleIdsParam\n        .split(\",\")\n        .map((id) => Number(id.trim()))\n        .filter((id) => !isNaN(id) && id >= 1 && id <= 4)\n    : [];\n\n  // Local state for debounced search and UI controls\n  const [localSearchValue, setLocalSearchValue] = useState(searchQuery);\n  const [editTarget, setEditTarget] = useState<StaffUserRow | null>(null);\n  const [createOpen, setCreateOpen] = useState(false);\n  const [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n\n  // Update URL helper\n  const updateURL = (\n    updates: Record<string, string | number | number[] | undefined>\n  ) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    // Always keep tab param\n    if (!newParams.has(\"tab\")) {\n      newParams.set(\"tab\", \"staffs\");\n    }\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        // Don't add page=1 to URL (it's default)\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else if (Array.isArray(value)) {\n          // Handle array values (e.g., roleIds) - convert to comma-separated string\n          if (value.length > 0) {\n            newParams.set(key, value.join(\",\"));\n          } else {\n            newParams.delete(key);\n          }\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        // Remove param if value is undefined or empty\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    // Ensure sort params always exist\n    if (!newParams.has(\"sortBy\")) {\n      newParams.set(\"sortBy\", sortBy);\n    }\n    if (!newParams.has(\"sort\")) {\n      newParams.set(\"sort\", sortOrder);\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  // Debounce search input\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      if (localSearchValue !== searchQuery) {\n        updateURL({\n          search: localSearchValue || undefined,\n          page: 1,\n        });\n      }\n    }, 500);\n\n    return () => clearTimeout(timer);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [localSearchValue, searchQuery]);\n\n  // Sync local search with URL\n  useEffect(() => {\n    setLocalSearchValue(searchQuery);\n  }, [searchQuery]);\n\n  // Initialize URL with default params on first load\n  useEffect(() => {\n    const currentParams = new URLSearchParams(searchParams.toString());\n    const needsUpdate =\n      !currentParams.has(\"tab\") ||\n      !currentParams.has(\"sortBy\") ||\n      !currentParams.has(\"sort\");\n\n    if (needsUpdate) {\n      const newParams = new URLSearchParams();\n\n      // Set defaults\n      newParams.set(\"tab\", \"staffs\");\n      newParams.set(\"sortBy\", sortBy);\n      newParams.set(\"sort\", sortOrder);\n\n      // Keep existing params\n      if (page !== 1) {\n        newParams.set(\"page\", String(page));\n      }\n      if (searchQuery) {\n        newParams.set(\"search\", searchQuery);\n      }\n      if (statusParam) {\n        newParams.set(\"status\", statusParam);\n      }\n      if (roleIdsParam) {\n        newParams.set(\"roleIds\", roleIdsParam);\n      }\n\n      const newURL = `${pathname}?${newParams.toString()}`;\n      router.replace(newURL, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Fetch roles for filter dropdown (Staff tab: exclude STUDENT, DATA_OPERATOR)\n  const { data: allRolesData, isLoading: loadingRoles } = useGetRoles({\n    pageSize: FILTER_PAGE_SIZE,\n    isActive: true,\n    exclude: [\"STUDENT\", \"DATA_OPERATOR\"],\n  });\n  const allRoles = useMemo(() => allRolesData?.items || [], [allRolesData]);\n\n  // Fetch staff profiles from API with URL params\n  const { data: staffProfilesData, isLoading: loadingStaffs } =\n    useGetStaffProfiles({\n      page,\n      pageSize: PAGE_SIZE,\n      search: searchQuery,\n      isActive: status,\n      roleIds: roleIds.length > 0 ? roleIds : undefined,\n      excludeRoles: [\"STUDENT\", \"DATA_OPERATOR\"],\n      sort: sortOrder,\n      sortBy,\n    });\n\n  const importStaffProfilesMutation = useImportStaffProfiles();\n\n  // Convert API data to UI format using adapter\n  const data = useMemo(() => {\n    return staffProfilesData?.items?.map(staffProfileToRow) || [];\n  }, [staffProfilesData]);\n\n  // Use server-side pagination data\n  const totalItems = staffProfilesData?.totalItems || 0;\n  const totalPages = staffProfilesData?.totalPages || 1;\n  const currentPage = staffProfilesData?.currentPage || 1;\n  const pageSize = staffProfilesData?.pageSize ?? PAGE_SIZE;\n  const pagedData = data; // Already paginated from API\n\n  // Event handlers\n  const handleSearchChange = (value: string) => {\n    setLocalSearchValue(value);\n  };\n\n  const handlePageChange = (newPage: number) => {\n    updateURL({ page: newPage });\n  };\n\n  const handleStatusChange = (value: string) => {\n    updateURL({\n      status: value === \"all\" ? undefined : value,\n      page: 1,\n    });\n  };\n\n  const handleRoleIdsChange = (newRoleIds: number[]) => {\n    updateURL({\n      roleIds: newRoleIds.length > 0 ? newRoleIds : undefined,\n      page: 1,\n    });\n  };\n\n  const handleSortByChange = (value: \"fullName\" | \"staffCode\" | \"email\") => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleToggleStatus = (row: StaffUserRow) => {\n    // TODO: Implement toggle status API call\n    // For now, just open edit dialog\n    setEditTarget(row);\n  };\n\n  const columns: ColumnDef<StaffUserRow>[] = createStaffColumns({\n    onEdit: (row) => {\n      setEditTarget(row);\n    },\n    onToggleStatus: handleToggleStatus,\n  });\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between\">\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Search */}\n          <Input\n            placeholder=\"Search name/email/staff code...\"\n            value={localSearchValue}\n            onChange={(e) => handleSearchChange(e.target.value)}\n            className=\"w-full sm:max-w-[240px] md:max-w-sm\"\n            autoComplete=\"off\"\n          />\n\n          {/* Status Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Status:\n            </span>\n            <Select\n              value={status === undefined ? \"all\" : status ? \"true\" : \"false\"}\n              onValueChange={handleStatusChange}\n            >\n              <SelectTrigger className=\"w-full sm:w-[140px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder=\"Status...\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Status</SelectItem>\n                <SelectItem value=\"true\">Active</SelectItem>\n                <SelectItem value=\"false\">Inactive</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n\n          {/* Role Filter - Multi-select */}\n          <div className=\"w-full sm:w-[300px]\">\n            <MultiSelectRoleFilter\n              value={roleIds}\n              onChange={handleRoleIdsChange}\n              disabled={loadingStaffs}\n              roles={allRoles}\n              isLoading={loadingRoles}\n            />\n          </div>\n\n          {/* Sort Controls */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Sort:\n            </span>\n            <Select value={sortBy} onValueChange={handleSortByChange}>\n              <SelectTrigger className=\"w-full sm:w-[130px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder=\"Sort by...\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"fullName\">Full Name</SelectItem>\n                <SelectItem value=\"staffCode\">Staff Code</SelectItem>\n                <SelectItem value=\"email\">Email</SelectItem>\n              </SelectContent>\n            </Select>\n            <div className=\"h-6 w-px bg-border\" />\n            <Select value={sortOrder} onValueChange={handleSortOrderChange}>\n              <SelectTrigger className=\"w-full sm:w-[120px] h-full border-0 shadow-none focus:ring-0 px-0\">\n                <SelectValue placeholder=\"Order...\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"asc\">Ascending</SelectItem>\n                <SelectItem value=\"desc\">Descending</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n        </div>\n\n        {/* Action Buttons */}\n        <div className=\"flex gap-2 w-full sm:w-auto\">\n          <Button\n            onClick={() => setIsImportDialogOpen(true)}\n            className=\"flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white\"\n          >\n            <FileSpreadsheet className=\"mr-2 h-4 w-4\" />\n            Import\n          </Button>\n          <Button\n            className=\"flex-1 sm:flex-none\"\n            onClick={() => setCreateOpen(true)}\n          >\n            Create Staff\n          </Button>\n        </div>\n      </div>\n\n      <StaffTable\n        columns={columns}\n        data={pagedData}\n        isLoading={loadingStaffs}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={pageSize}\n        onPageChange={handlePageChange}\n      />\n\n      <EditStaffDialog\n        open={!!editTarget}\n        staff={editTarget}\n        onOpenChange={(open) => !open && setEditTarget(null)}\n        onSave={() => setEditTarget(null)}\n      />\n      <CreateStaffDialog\n        open={createOpen}\n        onOpenChange={setCreateOpen}\n        onCreate={() => setCreateOpen(false)}\n      />\n      <GenericImportDialog\n        open={isImportDialogOpen}\n        onOpenChange={setIsImportDialogOpen}\n        title=\"Import Staff Profiles from CSV\"\n        csvColumns={[\n          \"full_name\",\n          \"email\",\n          \"staff_code\",\n          \"roles\",\n          \"status (optional)\",\n          \"password (optional)\",\n        ]}\n        importMutation={importStaffProfilesMutation}\n        successMessage=\"All staff profiles imported successfully!\"\n        entityName=\"staff profiles\"\n      />\n    </div>\n  );\n}\n\nfunction UsersRolesContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // Read active tab from URL\n  const activeTab = searchParams.get(\"tab\") || \"students\";\n\n  useEffect(() => {\n    setPageHeader({\n      breadcrumbs: [\n        { label: \"Dashboard\", href: \"/admin/dashboard\" },\n        { label: \"Users & Roles\" },\n      ],\n      title: \"Users & Roles\",\n      subtitle: \"Manage students and staff roles\",\n    });\n\n    return () => clearPageHeader();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // Initialize URL with default tab if needed\n  useEffect(() => {\n    if (!searchParams.has(\"tab\")) {\n      const newParams = new URLSearchParams(searchParams.toString());\n      newParams.set(\"tab\", \"students\");\n      newParams.set(\"sortBy\", \"fullName\");\n      newParams.set(\"sort\", \"asc\");\n      router.replace(`${pathname}?${newParams.toString()}`, { scroll: false });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const handleTabChange = (tab: string) => {\n    // Clear all filters when switching tabs, keep only tab and sort params\n    const newParams = new URLSearchParams();\n    newParams.set(\"tab\", tab);\n    newParams.set(\"sortBy\", \"fullName\");\n    newParams.set(\"sort\", \"asc\");\n    router.push(`${pathname}?${newParams.toString()}`, { scroll: false });\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <Tabs\n        value={activeTab}\n        onValueChange={handleTabChange}\n        className=\"w-full\"\n      >\n        <TabsList>\n          <TabsTrigger value=\"students\">Students</TabsTrigger>\n          <TabsTrigger value=\"staffs\">Staffs</TabsTrigger>\n        </TabsList>\n        <TabsContent value=\"students\">\n          <StudentsTab />\n        </TabsContent>\n        <TabsContent value=\"staffs\">\n          <StaffsTab />\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\nexport default function UsersRolesPage() {\n  return (\n    <Suspense>\n      <UsersRolesContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\forgot-password\\page.tsx",
      "relative_path": "app/forgot-password/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 5293,
      "lines": 156,
      "last_modified": "2025-11-13T21:14:04.081537",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport Link from \"next/link\";\nimport { Mail, ArrowLeft } from \"lucide-react\";\n\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardFooter,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { useForgotPassword } from \"@/hooks/api/useAuth\";\n\n// Validation schema\nconst forgotPasswordSchema = z.object({\n  email: z\n    .string()\n    .min(1, \"Email is required\")\n    .email(\"Invalid email address\")\n    .max(128, \"Email must be at most 128 characters\"),\n});\n\ntype ForgotPasswordFormData = z.infer<typeof forgotPasswordSchema>;\n\nexport default function ForgotPasswordPage() {\n  const [emailSent, setEmailSent] = useState(false);\n  const forgotPasswordMutation = useForgotPassword();\n\n  const form = useForm<ForgotPasswordFormData>({\n    resolver: zodResolver(forgotPasswordSchema),\n    defaultValues: { email: \"\" },\n  });\n\n  const onSubmit = async (values: ForgotPasswordFormData) => {\n    try {\n      // Convert email to lowercase before sending\n      await forgotPasswordMutation.mutateAsync({\n        email: values.email.toLowerCase(),\n      });\n      setEmailSent(true);\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    } catch (error) {\n      // Error handled by mutation hook\n    }\n  };\n\n  if (emailSent) {\n    return (\n      <div className=\"flex min-h-[100dvh] items-center justify-center bg-background px-4\">\n        <Card className=\"w-full max-w-lg border-border/60 shadow-lg\">\n          <CardHeader className=\"space-y-2 text-center\">\n            <div className=\"mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-green-100 ring-8 ring-green-50\">\n              <Mail className=\"h-6 w-6 text-green-600\" />\n            </div>\n            <CardTitle className=\"text-2xl font-semibold tracking-tight\">Check Your Email</CardTitle>\n            <CardDescription>\n              We&apos;ve sent a password reset link to your email address.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4 text-center\">\n            <p className=\"text-sm text-muted-foreground\">\n              If you don&apos;t see the email, check your spam folder or try\n              again.\n            </p>\n          </CardContent>\n          <CardFooter className=\"flex flex-col space-y-3\">\n            <Button asChild className=\"w-full\" variant=\"outline\">\n              <Link href=\"/login\">\n                <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                Back to Login\n              </Link>\n            </Button>\n            <Button\n              className=\"w-full\"\n              variant=\"link\"\n              onClick={() => setEmailSent(false)}\n            >\n              Try another email\n            </Button>\n          </CardFooter>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex min-h-[100dvh] items-center justify-center bg-background px-4\">\n      <Card className=\"w-full max-w-lg border-border/60 shadow-lg\">\n        <CardHeader className=\"space-y-1 text-center\">\n          <CardTitle className=\"text-2xl font-semibold tracking-tight\">Forgot Password</CardTitle>\n          <CardDescription>\n            Enter your email address and we&apos;ll send you a password reset\n            link.\n          </CardDescription>\n        </CardHeader>\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n            <CardContent className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"email\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Email</FormLabel>\n                    <FormControl>\n                      <Input\n                        type=\"email\"\n                        placeholder=\"your-email@example.com\"\n                        autoComplete=\"email\"\n                        {...field}\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n            <CardFooter className=\"flex flex-col space-y-3\">\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={forgotPasswordMutation.isPending}\n              >\n                {forgotPasswordMutation.isPending\n                  ? \"Sending...\"\n                  : \"Send Reset Link\"}\n              </Button>\n              <Button asChild className=\"w-full\" variant=\"outline\">\n                <Link href=\"/login\">\n                  <ArrowLeft className=\"mr-2 h-4 w-4\" />\n                  Back to Login\n                </Link>\n              </Button>\n            </CardFooter>\n          </form>\n        </Form>\n      </Card>\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\layout.tsx",
      "relative_path": "app/layout.tsx",
      "filename": "layout.tsx",
      "size_bytes": 1303,
      "lines": 46,
      "last_modified": "2025-11-09T20:23:57.366515",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "import type { Metadata } from \"next\";\nimport { Geist, Geist_Mono } from \"next/font/google\";\nimport \"./globals.css\";\nimport { AppProviders } from \"@/components/providers/app-providers\";\nimport { Toaster } from \"@/components/ui/sonner\";\nimport { NextIntlClientProvider } from 'next-intl';\nimport { getMessages } from 'next-intl/server';\n\nconst geistSans = Geist({\n  variable: \"--font-geist-sans\",\n  subsets: [\"latin\"],\n});\n\nconst geistMono = Geist_Mono({\n  variable: \"--font-geist-mono\",\n  subsets: [\"latin\"],\n});\n\nexport const metadata: Metadata = {\n  title: \"FUACS - FU Attendance Checking Smart\",\n  description: \"Smart attendance management system for FPT University\",\n};\n\nexport default async function RootLayout({\n  children,\n}: Readonly<{\n  children: React.ReactNode;\n}>) {\n  const messages = await getMessages();\n\n  return (\n    <html lang=\"en\" suppressHydrationWarning>\n      <body\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n        suppressHydrationWarning\n      >\n        <NextIntlClientProvider messages={messages}>\n          <AppProviders>\n            {children}\n            <Toaster richColors position=\"top-right\" />\n          </AppProviders>\n        </NextIntlClientProvider>\n      </body>\n    </html>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\lecturer\\calendar\\page.tsx",
      "relative_path": "app/lecturer/calendar/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 586,
      "lines": 23,
      "last_modified": "2025-11-02T12:38:05.639279",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport { MonthlyCalendar } from \"@/components/lecturer/MonthlyCalendar\";\n\nexport default function LecturerCalendarPage() {\n  const today = new Date();\n  const [year, setYear] = useState(today.getFullYear());\n  const [month, setMonth] = useState(today.getMonth() + 1);\n\n  return (\n    <main className=\"container mx-auto max-w-6xl p-4\">\n      <MonthlyCalendar\n        year={year}\n        month={month}\n        onChange={(y, m) => {\n          setYear(y);\n          setMonth(m);\n        }}\n      />\n    </main>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\lecturer\\dashboard\\page.tsx",
      "relative_path": "app/lecturer/dashboard/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 21812,
      "lines": 504,
      "last_modified": "2025-11-19T16:57:39.747611",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useMemo, useRef } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { useTranslations } from 'next-intl';\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\nimport {\n  BookOpen,\n  Calendar,\n  CheckCircle2,\n  Users,\n  Clock,\n  Loader2,\n} from \"lucide-react\";\nimport { useLecturerDashboard } from \"@/hooks/api/useLecturerDashboard\";\nimport { parseVietnamTime, formatVietnamTime } from \"@/lib/timezone-utils\";\nimport { Badge } from \"@/components/ui/badge\";\n\nexport default function LecturerDashboardPage() {\n  const t = useTranslations('dashboard');\n  const tCommon = useTranslations('common');\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // Get semester from URL or use default\n  const semesterIdParam = searchParams.get(\"semesterId\");\n  const selectedSemesterId = semesterIdParam\n    ? Number(semesterIdParam)\n    : undefined;\n\n  // Fetch dashboard data\n  const { data, isLoading } = useLecturerDashboard(selectedSemesterId);\n\n  // Update URL when semester changes\n  const updateSemester = (semesterId: string) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n    if (semesterId === \"all\") {\n      newParams.delete(\"semesterId\");\n    } else {\n      newParams.set(\"semesterId\", semesterId);\n    }\n    router.push(`${pathname}?${newParams.toString()}`, { scroll: false });\n  };\n\n  useEffect(() => {\n    setPageHeader({\n      title: t('title'),\n      subtitle: t('subtitle'),\n      breadcrumbs: [{ label: t('title') }],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader, t]);\n\n  const stats = (data as any)?.stats;\n\n  // Memoize myClasses to prevent dependency changes\n  const myClasses = useMemo(() => (data as any)?.myClasses || [], [data]);\n\n  // Group classes by semester for All Semester mode\n  const groupedClasses = useMemo(() => {\n    if (!myClasses || myClasses.length === 0) return [];\n\n    const groups = myClasses.reduce((acc: Record<number, { semester: any; classes: any[] }>, classItem: any) => {\n      const semesterId = classItem.semester.id;\n      if (!acc[semesterId]) {\n        acc[semesterId] = {\n          semester: classItem.semester,\n          classes: [],\n        };\n      }\n      acc[semesterId].classes.push(classItem);\n      return acc;\n    }, {});\n\n    return Object.values(groups);\n  }, [myClasses]);\n\n  // Memoize semesters to prevent unnecessary re-renders\n  const semesters = useMemo(() => (data as any)?.semesters || [], [data]);\n\n  // Track if auto-select has been done to prevent re-triggering when user clears filter\n  const hasAutoSelected = useRef(false);\n\n  // Calculate current semester (start_date <= now <= end_date)\n  const currentSemester = useMemo(() => {\n    if (!semesters || semesters.length === 0) return null;\n\n    const now = new Date();\n    return semesters.find((s: any) => {\n      const start = new Date(s.startDate);\n      const end = new Date(s.endDate);\n      return now >= start && now <= end;\n    });\n  }, [semesters]);\n\n  // Auto-select current semester ONLY ONCE on initial load if no semester filter is set\n  useEffect(() => {\n    if (!semesterIdParam && currentSemester && !isLoading && !hasAutoSelected.current) {\n      hasAutoSelected.current = true;\n      updateSemester(currentSemester.id.toString());\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [currentSemester, semesterIdParam, isLoading]);\n\n  // Reset hasAutoSelected on unmount to allow auto-selection on next mount\n  useEffect(() => {\n    return () => {\n      hasAutoSelected.current = false;\n    };\n  }, []);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n        <span className=\"ml-2\">{tCommon('loading')}</span>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Semester Filter */}\n      <div className=\"flex justify-end\">\n        <Select\n          value={selectedSemesterId?.toString() || \"all\"}\n          onValueChange={updateSemester}\n          disabled={isLoading}\n        >\n          <SelectTrigger className=\"w-[200px]\">\n            <SelectValue placeholder={t('select_semester')} />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">{t('all_semesters')}</SelectItem>\n            {semesters.map((semester: any) => (\n              <SelectItem key={semester.id} value={semester.id.toString()}>\n                {semester.code} - {semester.name}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Stats Cards */}\n      {stats && (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-5\">\n          {/* Total Classes */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">\n                {t('total_classes')}\n              </CardTitle>\n              <BookOpen className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.totalClasses}</div>\n              <p className=\"text-xs text-muted-foreground\">{t('active_classes')}</p>\n            </CardContent>\n          </Card>\n\n          {/* Total Slots */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">{t('total_slots')}</CardTitle>\n              <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.totalSlots}</div>\n              <p className=\"text-xs text-muted-foreground\">{t('scheduled_sessions')}</p>\n            </CardContent>\n          </Card>\n\n          {/* Finalized Slots */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">{t('completed')}</CardTitle>\n              <CheckCircle2 className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.finalizedSlots}</div>\n              <p className=\"text-xs text-muted-foreground\">\n                {stats.totalSlots > 0\n                  ? `${Math.round(\n                      (stats.finalizedSlots / stats.totalSlots) * 100\n                    )}% ${tCommon('completed').toLowerCase()}`\n                  : t('no_slots_yet')}\n              </p>\n            </CardContent>\n          </Card>\n\n          {/* Upcoming Slots */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">\n                {t('upcoming_slots')}\n              </CardTitle>\n              <Clock className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.upcomingSlots}</div>\n              <p className=\"text-xs text-muted-foreground\">{t('scheduled_upcoming')}</p>\n            </CardContent>\n          </Card>\n\n          {/* Total Students */}\n          <Card>\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n              <CardTitle className=\"text-sm font-medium\">{t('total_students')}</CardTitle>\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-2xl font-bold\">{stats.totalStudents}</div>\n              <p className=\"text-xs text-muted-foreground\">{t('students_teaching')}</p>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Upcoming Slots - Next Day Slots */}\n      {(data as any)?.nextDaySlots && (data as any).nextDaySlots.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>{t('upcoming_slots')}</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid gap-4\">\n              {(data as any).nextDaySlots.map((slot: any) => (\n                <Card key={slot.id} className=\"bg-muted/30\">\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"space-y-1 flex-1\">\n                        <div className=\"flex items-center gap-2\">\n                          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                          <span className=\"font-medium\">\n                            {formatVietnamTime(parseVietnamTime(slot.startTime), 'dd/MM/yy')}\n                          </span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                          <span className=\"text-sm text-muted-foreground\">\n                            {formatVietnamTime(parseVietnamTime(slot.startTime), 'HH:mm')}\n                            {' - '}\n                            {formatVietnamTime(parseVietnamTime(slot.endTime), 'HH:mm')}\n                          </span>\n                        </div>\n                        {slot.room && (\n                          <div className=\"text-sm text-muted-foreground\">\n                            Room: {slot.room.name}\n                          </div>\n                        )}\n                        {slot.class && (\n                          <div className=\"text-sm text-muted-foreground\">\n                            Class: {slot.class.code}\n                          </div>\n                        )}\n                        {slot.class && slot.class.subject && (\n                          <div className=\"text-sm text-muted-foreground\">\n                            Subject: {slot.class.subject.code}\n                          </div>\n                        )}\n                      </div>\n                      {slot.attendanceStats && (\n                        <div className=\"text-right\">\n                          <div className=\"space-y-2\">\n                            <div className=\"text-lg font-bold\">\n                              {slot.attendanceStats.total} {tCommon('students')}\n                            </div>\n                            <div className=\"flex flex-col gap-1 text-xs\">\n                              <div className=\"flex items-center justify-end gap-1\">\n                                <span className=\"text-green-600 font-medium\">\n                                  {slot.attendanceStats.present} {tCommon('present')}\n                                </span>\n                              </div>\n                              <div className=\"flex items-center justify-end gap-1\">\n                                <span className=\"text-red-600 font-medium\">\n                                  {slot.attendanceStats.absent} {tCommon('absent')}\n                                </span>\n                              </div>\n                              <div className=\"flex items-center justify-end gap-1\">\n                                <span className=\"text-gray-500 font-medium\">\n                                  {slot.attendanceStats.notYet} {tCommon('not_yet')}\n                                </span>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* My Classes */}\n      <Card>\n        <CardHeader>\n          <CardTitle>{t('my_classes')}</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {myClasses.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <BookOpen className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium mb-2\">{t('no_classes_found')}</h3>\n              <p className=\"text-muted-foreground\">\n                {selectedSemesterId\n                  ? t('no_classes_in_semester')\n                  : t('no_classes_yet')}\n              </p>\n            </div>\n          ) : !selectedSemesterId ? (\n            // All Semester mode: Group by semester with Accordion\n            <Accordion type=\"multiple\" className=\"space-y-2\">\n              {groupedClasses.map((group: any) => (\n                <AccordionItem\n                  key={group.semester.id}\n                  value={group.semester.id.toString()}\n                  className=\"border rounded-lg\"\n                >\n                  <AccordionTrigger className=\"px-4 hover:no-underline\">\n                    <div className=\"flex items-center justify-between w-full pr-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <h3 className=\"text-lg font-semibold\">\n                          {group.semester.code} - {group.semester.name}\n                        </h3>\n                        <Badge variant=\"outline\">\n                          {group.classes.length} {group.classes.length === 1 ? 'class' : 'classes'}\n                        </Badge>\n                      </div>\n                    </div>\n                  </AccordionTrigger>\n                  <AccordionContent className=\"space-y-3 px-4 pb-4\">\n                    {group.classes.map((classItem: any) => (\n                      <Card key={classItem.id}>\n                        <CardContent className=\"pt-6\">\n                          <div className=\"mb-4\">\n                            <div className=\"flex items-center gap-2 mb-1\">\n                              <h3 className=\"text-lg font-semibold\">\n                                {classItem.code}\n                              </h3>\n                            </div>\n                            <p className=\"text-sm text-muted-foreground\">\n                              {classItem.subject.code} - {classItem.subject.name}\n                            </p>\n                          </div>\n\n                          {/* Class Stats */}\n                          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4\">\n                            <div>\n                              <div className=\"text-sm text-muted-foreground\">\n                                Total Slots\n                              </div>\n                              <div className=\"text-2xl font-bold\">\n                                {classItem.stats.totalSlots}\n                              </div>\n                            </div>\n                            <div>\n                              <div className=\"text-sm text-muted-foreground\">\n                                Students\n                              </div>\n                              <div className=\"text-2xl font-bold flex items-center gap-1\">\n                                <Users className=\"h-5 w-5\" />\n                                {classItem.stats.totalStudents}\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Next Slot */}\n                          <div className=\"col-span-2 mt-3 pt-3 border-t\">\n                            <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-2\">\n                              <Clock className=\"h-4 w-4\" />\n                              Next Slot\n                            </h4>\n                            {classItem.upcomingSlots && classItem.upcomingSlots.length > 0 ? (\n                              <div\n                                className=\"flex items-center justify-between text-sm border-l-2 border-primary pl-3 py-1 hover:bg-muted/50 transition-colors\"\n                              >\n                                <div className=\"flex-1\">\n                                  <div className=\"font-medium\">\n                                    {formatVietnamTime(parseVietnamTime(classItem.upcomingSlots[0].startTime), 'dd/MM/yy HH:mm')}\n                                    {' - '}\n                                    {formatVietnamTime(parseVietnamTime(classItem.upcomingSlots[0].endTime), 'HH:mm')}\n                                  </div>\n                                  {classItem.upcomingSlots[0].room && (\n                                    <div className=\"text-xs text-muted-foreground mt-0.5\">\n                                      {classItem.upcomingSlots[0].room.name}\n                                    </div>\n                                  )}\n                                </div>\n                              </div>\n                            ) : (\n                              <div className=\"text-sm text-muted-foreground\">\n                                No upcoming slot\n                              </div>\n                            )}\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </AccordionContent>\n                </AccordionItem>\n              ))}\n            </Accordion>\n          ) : (\n            // Specific semester mode: Show cards directly\n            <div className=\"space-y-4\">\n              {myClasses.map((classItem: any) => (\n                <Card key={classItem.id}>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"mb-4\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <h3 className=\"text-lg font-semibold\">\n                          {classItem.code}\n                        </h3>\n                        <Badge variant=\"outline\">\n                          {classItem.semester.code}\n                        </Badge>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\">\n                        {classItem.subject.code} - {classItem.subject.name}\n                      </p>\n                    </div>\n\n                    {/* Class Stats */}\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4\">\n                      <div>\n                        <div className=\"text-sm text-muted-foreground\">\n                          Total Slots\n                        </div>\n                        <div className=\"text-2xl font-bold\">\n                          {classItem.stats.totalSlots}\n                        </div>\n                      </div>\n                      <div>\n                        <div className=\"text-sm text-muted-foreground\">\n                          Students\n                        </div>\n                        <div className=\"text-2xl font-bold flex items-center gap-1\">\n                          <Users className=\"h-5 w-5\" />\n                          {classItem.stats.totalStudents}\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Next Slot */}\n                    <div className=\"col-span-2 mt-3 pt-3 border-t\">\n                      <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-2\">\n                        <Clock className=\"h-4 w-4\" />\n                        Next Slot\n                      </h4>\n                      {classItem.upcomingSlots && classItem.upcomingSlots.length > 0 ? (\n                        <div\n                          className=\"flex items-center justify-between text-sm border-l-2 border-primary pl-3 py-1 hover:bg-muted/50 transition-colors\"\n                        >\n                          <div className=\"flex-1\">\n                            <div className=\"font-medium\">\n                              {formatVietnamTime(parseVietnamTime(classItem.upcomingSlots[0].startTime), 'dd/MM/yy HH:mm')}\n                              {' - '}\n                              {formatVietnamTime(parseVietnamTime(classItem.upcomingSlots[0].endTime), 'HH:mm')}\n                            </div>\n                            {classItem.upcomingSlots[0].room && (\n                              <div className=\"text-xs text-muted-foreground mt-0.5\">\n                                {classItem.upcomingSlots[0].room.name}\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      ) : (\n                        <div className=\"text-sm text-muted-foreground\">\n                          No upcoming slot\n                        </div>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\lecturer\\layout.tsx",
      "relative_path": "app/lecturer/layout.tsx",
      "filename": "layout.tsx",
      "size_bytes": 1829,
      "lines": 51,
      "last_modified": "2025-11-01T15:38:43.270932",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { AppSidebar } from \"@/components/shared/app-sidebar\";\nimport { MobileSidebar } from \"@/components/shared/mobile-sidebar\";\nimport { AppHeader } from \"@/components/shared/app-header\";\nimport { SidebarProvider } from \"@/components/shared/sidebar-context\";\nimport { PageHeaderProvider } from \"@/components/shared/page-header-context\";\nimport { RoleBasedRouteGuard } from \"@/components/auth/role-based-route-guard\";\nimport { lecturerMenu } from \"@/lib/menu-configs/lecturer-menu\";\n\n/**\n * Lecturer Portal Layout\n *\n * Shared layout for all lecturer pages.\n * Uses the lecturerMenu configuration for navigation.\n * Protected by RoleBasedRouteGuard to ensure only LECTURER role can access.\n *\n * Pages under /lecturer/* will use this layout automatically.\n */\nexport default function LecturerLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <RoleBasedRouteGuard allowedRoles={[\"LECTURER\"]}>\n      <SidebarProvider>\n        <PageHeaderProvider>\n          <div className=\"flex h-screen overflow-hidden\">\n            {/* Desktop Sidebar (hidden on mobile) */}\n            <AppSidebar menuConfig={lecturerMenu} className=\"hidden lg:flex\" />\n\n            {/* Mobile Sidebar (Sheet overlay) */}\n            <MobileSidebar menuConfig={lecturerMenu} />\n\n            {/* Main Content Area */}\n            <div className=\"flex flex-1 flex-col overflow-hidden\">\n              {/* Header */}\n              <AppHeader />\n\n              {/* Page Content - Responsive padding */}\n              <main className=\"flex-1 overflow-y-auto overflow-x-hidden bg-muted/10 p-4 md:p-6\">\n                {children}\n              </main>\n            </div>\n          </div>\n        </PageHeaderProvider>\n      </SidebarProvider>\n    </RoleBasedRouteGuard>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\lecturer\\page.tsx",
      "relative_path": "app/lecturer/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 506,
      "lines": 16,
      "last_modified": "2025-11-02T12:38:05.640784",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "import { MonthlyCalendar } from \"@/components/lecturer/monthly-calendar\";\n\nexport default function LecturerDashboard() {\n  return (\n    <div className=\"container mx-auto py-8 px-4\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\">Lecturer Dashboard</h1>\n        <p className=\"text-muted-foreground\">\n          View your teaching schedule and manage attendance\n        </p>\n      </div>\n\n      <MonthlyCalendar className=\"max-w-7xl mx-auto\" />\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\lecturer\\profile\\page.tsx",
      "relative_path": "app/lecturer/profile/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 8954,
      "lines": 264,
      "last_modified": "2025-11-13T21:14:04.082535",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { useTranslations } from 'next-intl';\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  User,\n  Camera,\n  Loader2,\n  Shield,\n} from \"lucide-react\";\nimport { useGetStaffProfile } from \"@/hooks/api/useStaffProfiles\";\nimport { getLecturerId } from \"@/lib/auth\";\nimport { ChangePasswordDialog } from \"@/components/shared/change-password-dialog\";\n\n/**\n * Lecturer Profile Page\n *\n * Displays lecturer profile information from API:\n * - Personal information\n * - Professional information\n * - Security settings\n */\nexport default function LecturerProfilePage() {\n  const t = useTranslations('profile');\n  const tCommon = useTranslations('common');\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const [isEditing] = useState(false);\n  const [selectedTab, setSelectedTab] = useState(\"personal\");\n\n  // Get current lecturer ID\n  const lecturerId = getLecturerId();\n\n  // Fetch lecturer profile data (only if lecturerId exists)\n  const {\n    data: lecturerProfile,\n    isLoading,\n    error,\n  } = useGetStaffProfile(lecturerId || 0);\n\n  useEffect(() => {\n    setPageHeader({\n      title: t('my_profile'),\n      subtitle: t('lecturer_profile_subtitle'),\n      breadcrumbs: [{ label: tCommon('account') }, { label: t('my_profile') }],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader, t, tCommon]);\n\n  // Check if lecturer ID is available\n  if (!lecturerId) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"text-center\">\n          <p className=\"text-destructive mb-2\">Authentication Error</p>\n          <p className=\"text-sm text-muted-foreground\">\n            Unable to identify lecturer. Please log in again.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Loading state\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"flex items-center gap-2\">\n          <Loader2 className=\"h-6 w-6 animate-spin\" />\n          <span>Loading profile...</span>\n        </div>\n      </div>\n    );\n  }\n\n  // Error state\n  if (error || !lecturerProfile) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"text-center\">\n          <p className=\"text-destructive mb-2\">Failed to load profile</p>\n          <p className=\"text-sm text-muted-foreground\">\n            {error?.message || \"Profile not found\"}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Profile Header */}\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-start gap-6\">\n            <div className=\"relative\">\n              <Avatar className=\"h-24 w-24\">\n                <AvatarImage src=\"\" />\n                <AvatarFallback className=\"text-lg\">\n                  {lecturerProfile.fullName\n                    .split(\" \")\n                    .map((n) => n[0])\n                    .join(\"\")}\n                </AvatarFallback>\n              </Avatar>\n              {isEditing && (\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  className=\"absolute -bottom-2 -right-2 h-8 w-8 rounded-full p-0\"\n                  disabled\n                  title=\"Profile picture editing not available\"\n                >\n                  <Camera className=\"h-4 w-4\" />\n                </Button>\n              )}\n            </div>\n\n            <div className=\"flex-1\">\n              <div className=\"flex items-start justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold\">\n                    {lecturerProfile.fullName}\n                  </h2>\n                  <p className=\"text-muted-foreground\">\n                    {lecturerProfile.staffCode}\n                  </p>\n                  <div className=\"flex items-center gap-2 mt-2\">\n                    {lecturerProfile.roles.map((role) => (\n                      <Badge key={role} variant=\"default\">\n                        {role}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mt-3 max-w-2xl\">\n                {t('staff_profile_managed')}\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Profile Details */}\n      <Tabs value={selectedTab} onValueChange={setSelectedTab}>\n        <TabsList className=\"grid w-full grid-cols-2\">\n          <TabsTrigger value=\"personal\">{t('personal_info')}</TabsTrigger>\n          <TabsTrigger value=\"security\">{t('security')}</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"personal\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <User className=\"h-5 w-5\" />\n                {t('personal_information')}\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"fullName\">{t('full_name')}</Label>\n                  <Input\n                    id=\"fullName\"\n                    value={lecturerProfile.fullName}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"staffCode\">{t('staff_code')}</Label>\n                  <Input\n                    id=\"staffCode\"\n                    value={lecturerProfile.staffCode}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"username\">{t('username')}</Label>\n                  <Input\n                    id=\"username\"\n                    value={lecturerProfile.username}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">{t('email_address')}</Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    value={lecturerProfile.email}\n                    disabled\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"createdAt\">{t('account_created')}</Label>\n                  <Input\n                    id=\"createdAt\"\n                    value={new Date(\n                      lecturerProfile.createdAt\n                    ).toLocaleDateString()}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"updatedAt\">{t('last_updated')}</Label>\n                  <Input\n                    id=\"updatedAt\"\n                    value={new Date(\n                      lecturerProfile.updatedAt\n                    ).toLocaleDateString()}\n                    disabled\n                  />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"security\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Shield className=\"h-5 w-5\" />\n                {t('security_settings')}\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"space-y-4\">\n                <div>\n                  <h4 className=\"font-medium mb-2\">{t('password')}</h4>\n                  <p className=\"text-sm text-muted-foreground mb-4\">\n                    {t('change_password')}\n                  </p>\n                  <ChangePasswordDialog userId={lecturerProfile.userId} />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\lecturer\\reports\\classes\\page.tsx",
      "relative_path": "app/lecturer/reports/classes/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 13859,
      "lines": 432,
      "last_modified": "2025-11-14T23:14:22.639024",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useState, useEffect, useMemo, useRef } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useTranslations } from 'next-intl';\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Calendar, Users, Clock, CheckCircle } from \"lucide-react\";\nimport { AttendanceMatrixTable } from \"@/components/lecturer/reports/attendance-matrix-table\";\nimport { RegularSlotDetailModal } from \"@/components/lecturer/reports/regular-slot-detail-modal\";\nimport { StudentAttendanceTable } from \"@/components/lecturer/reports/student-attendance-table\";\nimport api from \"@/lib/api-axios\";\nimport { API_ENDPOINTS } from \"@/lib/constants\";\n\ninterface Semester {\n  id: number;\n  name: string;\n  code: string;\n  startDate: string;\n  endDate: string;\n  isActive: boolean;\n  createdAt: string;\n  updatedAt: string;\n  classes: Class[];\n}\n\ninterface Class {\n  id: number;\n  code: string;\n  subject: {\n    createdAt: string;\n    updatedAt: string;\n    id: number;\n    name: string;\n    code: string;\n    majors: Array<{\n      createdAt: string;\n      updatedAt: string;\n      id: number;\n      name: string;\n      code: string;\n      totalSubject: number;\n      isActive: boolean;\n    }>;\n    totalClass: number;\n    totalActiveClass: number;\n    totalClassInSemester: number;\n    totalActiveClassInSemester: number;\n    role: string;\n    assignedClasses: Array<{\n      createdAt: string;\n      updatedAt: string;\n      id: number;\n      code: string;\n      semesterName: string;\n      subjectName: string;\n      enrollmentStatus: boolean;\n      role: string;\n      semester: {\n        createdAt: string;\n        updatedAt: string;\n        id: number;\n        name: string;\n        code: string;\n        startDate: string;\n        endDate: string;\n        totalClass: number;\n        isActive: boolean;\n      };\n      subject: string;\n      totalStudent: number;\n      totalEnrolledStudent: number;\n      totalSlot: number;\n      totalActiveSlot: number;\n      isActive: boolean;\n    }>;\n    isActive: boolean;\n  };\n  isActive: boolean;\n  createdAt: string;\n  updatedAt: string;\n}\n\n// Unified API types matching backend DTOs\ninterface SlotSummaryDTO {\n  slotId: number;\n  title: string;\n  description?: string;\n  startTime: string;\n  endTime: string;\n  slotCategory: \"LECTURE\" | \"LECTURE_WITH_PT\" | \"FINAL_EXAM\";\n}\n\ninterface ClassSummaryData {\n  classInfo: {\n    id: number;\n    code: string;\n    subject: {\n      id: number;\n      name: string;\n      code: string;\n    };\n    semester: {\n      id: number;\n      name: string;\n    };\n  };\n  enrollmentSummary: {\n    totalStudents: number;\n  };\n  attendanceStatistics: {\n    totalSlots: number;\n    completedSlots: number;\n    upcomingSlots: number;\n  };\n  slots: SlotSummaryDTO[];\n  students: Array<{\n    userId: number;\n    fullName: string;\n    rollNumber: string;\n    email: string;\n    major: {\n      name: string;\n      code: string;\n    };\n    attendanceSummary: {\n      totalSlots: number;\n      presentCount: number;\n      absentCount: number;\n      notYetCount: number;\n    };\n    attendanceRecords: Record<number, \"PRESENT\" | \"ABSENT\" | \"present\" | \"absent\" | null>;\n  }>;\n}\n\nexport default function ClassSummaryPage() {\n  const t = useTranslations('reports');\n  const tCommon = useTranslations('common');\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const [semestersData, setSemestersData] = useState<Semester[]>([]);\n  const [selectedSemester, setSelectedSemester] = useState<string>(\"\");\n  const [selectedClass, setSelectedClass] = useState<string>(\"\");\n  const [classSummary, setClassSummary] = useState<ClassSummaryData | null>(\n    null\n  );\n  const [loading, setLoading] = useState(false);\n  const [selectedSlot, setSelectedSlot] = useState<number | null>(null);\n\n  // Get classes for selected semester\n  const availableClasses = selectedSemester\n    ? semestersData.find((s) => s.id.toString() === selectedSemester)\n        ?.classes || []\n    : [];\n\n  // Track if auto-select has been done to prevent re-triggering when user clears filter\n  const hasAutoSelected = useRef(false);\n\n  // Calculate current semester (start_date <= now <= end_date)\n  const currentSemester = useMemo(() => {\n    if (!semestersData || semestersData.length === 0) return null;\n\n    const now = new Date();\n    return semestersData.find((s) => {\n      const start = new Date(s.startDate);\n      const end = new Date(s.endDate);\n      return now >= start && now <= end;\n    });\n  }, [semestersData]);\n\n  // Fetch semesters and classes on component mount\n  useEffect(() => {\n    fetchSemestersAndClasses();\n  }, []);\n\n  // Auto-select current semester ONLY ONCE on initial load after data is loaded\n  useEffect(() => {\n    if (!selectedSemester && currentSemester && semestersData.length > 0 && !hasAutoSelected.current) {\n      hasAutoSelected.current = true;\n      setSelectedSemester(currentSemester.id.toString());\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [currentSemester, semestersData]);\n\n  // Reset selected class when semester changes\n  useEffect(() => {\n    if (selectedSemester) {\n      setSelectedClass(\"\");\n      setClassSummary(null);\n    }\n  }, [selectedSemester]);\n\n  // Fetch class summary when class changes\n  useEffect(() => {\n    if (selectedClass && selectedSemester) {\n      fetchClassSummary(selectedClass, selectedSemester);\n    }\n  }, [selectedClass, selectedSemester]);\n\n  // Set page header\n  useEffect(() => {\n    setPageHeader({\n      title: t('class_summary_report'),\n      subtitle: t('comprehensive_attendance_analysis'),\n      breadcrumbs: [\n        { label: tCommon('dashboard'), href: \"/lecturer/dashboard\" },\n        { label: t('reports') },\n        { label: t('class_summary') },\n      ],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader, t, tCommon]);\n\n  const fetchSemestersAndClasses = async () => {\n    try {\n      // Our axios interceptor unwraps { status, data } and returns the inner data directly\n      // Expecting an array of semesters with embedded classes\n      const data = await api.get(API_ENDPOINTS.lecturer.semestersClasses);\n\n      if (Array.isArray(data)) {\n        setSemestersData(data as Semester[]);\n      } else {\n        console.warn(\n          \"âš ï¸ Unexpected response shape for semesters-classes, resetting to empty array\"\n        );\n        setSemestersData([]);\n      }\n    } catch (error: any) {\n      console.error(\"âŒ Error fetching semesters:\", error);\n      setSemestersData([]);\n    }\n  };\n\n  const fetchClassSummary = async (classId: string, semesterId: string) => {\n    setLoading(true);\n    try {\n      const response = await api.get(\n        `${API_ENDPOINTS.classes.byId(classId)}/summary`,\n        {\n          params: { semester: semesterId },\n        }\n      );\n\n      // Check if interceptor unwrapped the data or not\n      if (response && typeof response === \"object\" && \"classInfo\" in response) {\n        // Interceptor unwrapped the data\n        setClassSummary(response as unknown as ClassSummaryData);\n      } else if (response && response.data) {\n        // Interceptor didn't unwrap, use response.data\n        setClassSummary(response.data as ClassSummaryData);\n      } else {\n        setClassSummary(null);\n      }\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    } catch (error) {\n      setClassSummary(null);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Calendar className=\"h-5 w-5\" />\n            {t('select_class')}\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">{t('semester')}</label>\n              <Select\n                value={selectedSemester}\n                onValueChange={setSelectedSemester}\n              >\n                <SelectTrigger>\n                  <SelectValue placeholder={t('select_semester')} />\n                </SelectTrigger>\n                <SelectContent>\n                  {semestersData && semestersData.length > 0 ? (\n                    semestersData.map((semester) => (\n                      <SelectItem\n                        key={semester.id}\n                        value={semester.id.toString()}\n                      >\n                        {semester.name} ({semester.code})\n                      </SelectItem>\n                    ))\n                  ) : (\n                    <div className=\"px-2 py-1.5 text-sm text-muted-foreground\">\n                      {t('no_semesters_available')}\n                    </div>\n                  )}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">{t('class')}</label>\n              <Select\n                value={selectedClass}\n                onValueChange={setSelectedClass}\n                disabled={!selectedSemester}\n              >\n                <SelectTrigger>\n                  <SelectValue placeholder={t('select_class')} />\n                </SelectTrigger>\n                <SelectContent>\n                  {availableClasses && availableClasses.length > 0 ? (\n                    availableClasses.map((cls) => (\n                      <SelectItem key={cls.id} value={cls.id.toString()}>\n                        {cls.code} - {cls.subject.name}\n                      </SelectItem>\n                    ))\n                  ) : (\n                    <div className=\"px-2 py-1.5 text-sm text-muted-foreground\">\n                      {selectedSemester\n                        ? t('no_classes_available')\n                        : t('select_semester_first')}\n                    </div>\n                  )}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Loading State */}\n      {loading && (\n        <Card>\n          <CardContent className=\"flex items-center justify-center py-8\">\n            <div className=\"flex items-center gap-2\">\n              <div className=\"animate-spin rounded-full h-6 w-6 border-b-2 border-primary\"></div>\n              <span>{t('loading_class_summary')}</span>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Class Summary Content */}\n      {classSummary && !loading && (\n        <div className=\"space-y-6\">\n          {/* Overview Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <Card>\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">\n                      {t('total_students')}\n                    </p>\n                    <p className=\"text-2xl font-bold\">\n                      {classSummary.enrollmentSummary.totalStudents}\n                    </p>\n                  </div>\n                  <Users className=\"h-8 w-8 text-blue-500\" />\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">\n                      {t('total_slots')}\n                    </p>\n                    <p className=\"text-2xl font-bold\">\n                      {classSummary.attendanceStatistics.totalSlots}\n                    </p>\n                  </div>\n                  <Clock className=\"h-8 w-8 text-orange-500\" />\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">\n                      Completed Slots\n                    </p>\n                    <p className=\"text-2xl font-bold text-green-600\">\n                      {classSummary.attendanceStatistics.completedSlots}\n                    </p>\n                  </div>\n                  <CheckCircle className=\"h-8 w-8 text-green-500\" />\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Attendance Matrix Table */}\n          <AttendanceMatrixTable\n            slots={classSummary.slots}\n            students={classSummary.students}\n          />\n\n          {/* Student Attendance Table */}\n          <StudentAttendanceTable\n            students={classSummary.students as any}\n            classSummary={classSummary as any}\n          />\n        </div>\n      )}\n\n      {/* Slot Detail Modal */}\n      {selectedSlot && (\n        <RegularSlotDetailModal\n          slotId={selectedSlot}\n          isOpen={!!selectedSlot}\n          onClose={() => setSelectedSlot(null)}\n          classSummary={classSummary}\n        />\n      )}\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\lecturer\\roster\\[classId]\\page.tsx",
      "relative_path": "app/lecturer/roster/[classId]/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 15523,
      "lines": 433,
      "last_modified": "2025-11-13T21:14:04.084583",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport { useParams, useRouter } from \"next/navigation\";\nimport { ArrowLeft } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { StudentCard } from \"@/components/lecturer/student-card\";\nimport { AttendanceRadio } from \"@/components/lecturer/attendance-radio\";\nimport { RosterActions } from \"@/components/lecturer/roster-actions\";\nimport { useSlotDetail } from \"@/hooks/api/useSlotDetail\";\nimport { useSubmitAttendance } from \"@/hooks/api/useRoster\";\nimport { Student } from \"@/types\";\nimport { toast } from \"sonner\";\nimport { getAuthToken } from \"@/lib/auth\";\nimport {\n  evidenceToAbsoluteUrl,\n  toAbsoluteMediaOrEvidenceUrl,\n} from \"@/lib/utils\";\n\nexport default function RosterPage() {\n  const params = useParams();\n  const router = useRouter();\n\n  // Treat dynamic segment as slotId\n  const slotIdParam = params.classId as string;\n  const slotId = Number(slotIdParam);\n\n  const { data, isLoading, error } = useSlotDetail(slotId);\n  const submitAttendance = useSubmitAttendance();\n\n  // Keep a ref to EventSource for cleanup\n  const sseRef = useRef<EventSource | null>(null);\n\n  // Derive date string (YYYY-MM-DD) from slot start time\n  const dateStr = useMemo(() => {\n    if (!data) return \"\";\n    const d = new Date(data.startTime);\n    return d.toISOString().slice(0, 10);\n  }, [data]);\n\n  // Map backend students -> Student type for UI cards\n  const students: Student[] = useMemo(() => {\n    if (!data) return [];\n    return data.students.map((s) => ({\n      id: s.rollNumber, // use MSSV as stable id\n      studentId: s.rollNumber,\n      fullName: s.fullName,\n      email: s.email,\n      avatarUrl: undefined,\n    }));\n  }, [data]);\n\n  // Map backend userId -> MSSV (studentId)\n  const studentIdByUserId = useMemo(() => {\n    const map = new Map<number, string>();\n    if (data) {\n      for (const s of data.students) {\n        map.set(s.userId, s.rollNumber);\n      }\n    }\n    return map;\n  }, [data]);\n\n  // Attendance map keyed by MSSV (rollNumber)\n  type AttendanceStatusValue = \"PRESENT\" | \"ABSENT\" | \"LATE\" | \"EXCUSED\";\n  const [attendanceMap, setAttendanceMap] = useState<\n    Record<string, AttendanceStatusValue>\n  >({});\n  const [attendancePhotoMap, setAttendancePhotoMap] = useState<\n    Record<string, string>\n  >({});\n\n  useEffect(() => {\n    if (!data) return;\n    const initial: Record<string, AttendanceStatusValue> = {};\n    const initialPhotos: Record<string, string> = {};\n    for (const s of data.students) {\n      const raw = String(s.status || \"\").toUpperCase();\n      const mapped: AttendanceStatusValue =\n        raw === \"PRESENT\"\n          ? \"PRESENT\"\n          : raw === \"ABSENT\"\n          ? \"ABSENT\"\n          : raw === \"LATE\"\n          ? \"LATE\"\n          : raw === \"EXCUSED\"\n          ? \"EXCUSED\"\n          : \"ABSENT\"; // default for NOT_YET or unknown\n      initial[s.rollNumber] = mapped;\n\n      // Initialize photo from evidenceUrl or photoUrl if provided by initial detail API\n      const pickUrl = s.evidenceUrl || s.photoUrl;\n      const absolute = evidenceToAbsoluteUrl(pickUrl);\n      if (absolute) initialPhotos[s.rollNumber] = absolute;\n    }\n    setAttendanceMap(initial);\n    if (Object.keys(initialPhotos).length)\n      setAttendancePhotoMap((prev) => ({ ...initialPhotos, ...prev }));\n  }, [data]);\n\n  // Open SSE stream for live attendance updates\n  useEffect(() => {\n    if (!data || !slotId) return;\n    const token = getAuthToken();\n    const base = process.env.NEXT_PUBLIC_API_URL;\n    if (!base) return;\n    const url = `${base}/slots/${slotId}/detail/stream${\n      token ? `?access_token=${encodeURIComponent(token)}` : \"\"\n    }`;\n\n    try {\n      const es = new EventSource(url, { withCredentials: false });\n      sseRef.current = es;\n\n      es.addEventListener(\"connected\", () => {\n        // Optional: confirm connection\n        // toast.success(\"Live updates connected\");\n      });\n\n      const updateRoster = (raw: any) => {\n        try {\n          const obj = typeof raw === \"string\" ? JSON.parse(raw) : raw;\n          if (!obj || obj.slotId !== slotId) return;\n          const sid = studentIdByUserId.get(obj.studentUserId);\n          if (!sid) return;\n\n          // Map status (tolerate lowercase not_yet)\n          const rs = String(\n            obj.regularStatus || obj.status || \"\"\n          ).toUpperCase();\n          const mapped: AttendanceStatusValue =\n            rs === \"PRESENT\"\n              ? \"PRESENT\"\n              : rs === \"ABSENT\"\n              ? \"ABSENT\"\n              : \"ABSENT\";\n          setAttendanceMap((prev) => ({ ...prev, [sid]: mapped }));\n\n          // Choose image and append cache buster to force refresh if same filename is reused\n          const img =\n            obj.regularImageUrl ||\n            obj.examImageUrl ||\n            obj?.evidence?.regularImageUrl ||\n            obj?.evidence?.examImageUrl;\n          if (img) {\n            const absolute = toAbsoluteMediaOrEvidenceUrl(img);\n            if (absolute) {\n              const sep = absolute.includes(\"?\") ? \"&\" : \"?\";\n              const busted = `${absolute}${sep}v=${Date.now()}`;\n              setAttendancePhotoMap((prev) => ({ ...prev, [sid]: busted }));\n            }\n          }\n\n          // Optional toast (title mentions PRESENT explicitly)\n          const student = data?.students.find(\n            (s) => s.userId === obj.studentUserId\n          );\n          if (student && rs === \"PRESENT\") {\n            toast.success(`Present: ${student.fullName}`);\n          }\n        } catch {}\n      };\n\n      es.addEventListener(\"attendanceUpdate\", (evt: MessageEvent) =>\n        updateRoster(evt.data)\n      );\n      es.onmessage = (evt) => updateRoster(evt.data);\n\n      es.onerror = () => {\n        // Optional: indicate connectivity issues\n        // toast.error(\"Live updates disconnected, retrying...\");\n      };\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    } catch (e) {\n      // toast.error(\"Failed to open live updates\");\n    }\n\n    return () => {\n      if (sseRef.current) {\n        sseRef.current.close();\n        sseRef.current = null;\n      }\n    };\n  }, [data, slotId, studentIdByUserId]);\n\n  // Listen for external attendance photo events and attach photo by studentId (MSSV)\n  useEffect(() => {\n    const handler = (e: Event) => {\n      const evt = e as CustomEvent<{ studentId: string; url: string }>;\n      const { studentId, url } = evt.detail || ({} as any);\n      if (!studentId || !url) return;\n      setAttendancePhotoMap((prev) => ({ ...prev, [studentId]: url }));\n    };\n    if (typeof window !== \"undefined\") {\n      window.addEventListener(\"attendance:photo\", handler as EventListener);\n    }\n    return () => {\n      if (typeof window !== \"undefined\") {\n        window.removeEventListener(\n          \"attendance:photo\",\n          handler as EventListener\n        );\n      }\n    };\n  }, []);\n\n  const handleAttendanceChange = (\n    studentId: string,\n    status: AttendanceStatusValue\n  ) => {\n    setAttendanceMap((prev) => ({ ...prev, [studentId]: status }));\n  };\n\n  const handleSubmit = () => {\n    if (!data) {\n      toast.error(\"Missing slot detail information\");\n      return;\n    }\n    const records = Object.entries(attendanceMap).map(\n      ([studentId, status]) => ({\n        studentId, // MSSV\n        status,\n        timestamp: new Date().toISOString(),\n      })\n    );\n    const anyData = data as any;\n    submitAttendance.mutate({\n      classId: anyData.classCode, // use classCode as classId for submit payload\n      scheduleId: data.slotId,\n      date: dateStr,\n      records,\n    } as any); // Legacy attendance submission format, needs refactoring\n  };\n\n  const handleStartAttendance = async () => {\n    try {\n      await fetch(\n        `${process.env.NEXT_PUBLIC_API_URL}/slots/${slotId}/start-session`,\n        {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            // Prefer Authorization header; backend accepts regular auth for POST\n            ...(getAuthToken()\n              ? { Authorization: `Bearer ${getAuthToken()}` }\n              : {}),\n          },\n          credentials: \"omit\",\n        }\n      );\n      toast.success(\"Attendance session started\");\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    } catch (e) {\n      toast.error(\"Failed to start session\");\n    }\n  };\n\n  const handleFormRoster = () => toast.info(\"Form roster feature coming soon\");\n  const handleNotifications = () =>\n    toast.info(\"Notifications feature coming soon\");\n\n  if (!Number.isFinite(slotId) || slotId <= 0) {\n    return (\n      <div className=\"container mx-auto py-8 px-4\">\n        <div className=\"text-center text-red-600\">Invalid slot id.</div>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto py-8 px-4\">\n        <div className=\"text-center\">Loading roster...</div>\n      </div>\n    );\n  }\n\n  if (error || !data) {\n    return (\n      <div className=\"container mx-auto py-8 px-4\">\n        <div className=\"text-center text-red-600\">\n          Failed to load roster. Please try again.\n        </div>\n      </div>\n    );\n  }\n\n  const presentCount = Object.values(attendanceMap).filter(\n    (s) => s === \"PRESENT\"\n  ).length;\n  const absentCount = Object.values(attendanceMap).filter(\n    (s) => s === \"ABSENT\"\n  ).length;\n  const lateCount = Object.values(attendanceMap).filter(\n    (s) => s === \"LATE\"\n  ).length;\n  const excusedCount = Object.values(attendanceMap).filter(\n    (s) => s === \"EXCUSED\"\n  ).length;\n\n  // Check if Start Attendance button should be disabled\n  // Only enabled when: startTime <= now <= endTime\n  const now = new Date();\n  const startTime = new Date(data.startTime);\n  const endTime = new Date(data.endTime);\n  const isStartDisabled = now < startTime || now > endTime;\n\n  return (\n    <div className=\"container mx-auto py-8 px-4\">\n      {/* Header */}\n      <div className=\"mb-6\">\n        <Button\n          variant=\"ghost\"\n          onClick={() => router.push(\"/lecturer/calendar\")}\n          className=\"mb-4\"\n        >\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back to Calendar\n        </Button>\n\n        <h1 className=\"text-3xl font-bold mb-2\">Class Roster</h1>\n        <div className=\"text-muted-foreground\">\n          <div>\n            {(data as any).subjectName} ({(data as any).classCode})\n          </div>\n          <div>Date: {new Date(data.startTime).toLocaleDateString()}</div>\n        </div>\n      </div>\n\n      <Separator className=\"mb-6\" />\n\n      {/* Roster Grid - 3 columns (first two merged into paired rows) */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-[2fr_1.5fr_1fr] gap-6\">\n        {/* Columns 1+2 merged: paired Student card + Attendance card per row */}\n        <div className=\"lg:col-span-2\">\n          <div className=\"hidden md:grid grid-cols-[2fr_1.5fr] gap-2 mb-1 text-xs font-semibold text-muted-foreground\">\n            <div>Students</div>\n            <div>Attendance</div>\n          </div>\n          <div className=\"grid grid-cols-1 md:grid-cols-[2fr_1.5fr] gap-2 items-stretch\">\n            {students.map((student) => (\n              <div className=\"contents\" key={student.id}>\n                <StudentCard className=\"h-full\" student={student} compact />\n                <Card className=\"h-full\">\n                  <CardContent className=\"p-3 h-full\">\n                    <div className=\"font-medium mb-2 text-xs\">\n                      {student.fullName}\n                    </div>\n                    <div className=\"flex items-start gap-3\">\n                      <div className=\"flex-1\">\n                        <AttendanceRadio\n                          studentId={student.studentId}\n                          value={(attendanceMap[student.studentId] || \"ABSENT\") as any}\n                          onChange={(status) =>\n                            handleAttendanceChange(student.studentId, status as any)\n                          }\n                          compact\n                        />\n                      </div>\n                      <div className=\"w-20 h-20 border border-border/60 rounded-md overflow-hidden bg-muted/20 flex items-center justify-center\">\n                        {attendancePhotoMap[student.studentId] ? (\n                          // eslint-disable-next-line @next/next/no-img-element\n                          <img\n                            src={attendancePhotoMap[student.studentId]}\n                            alt={`${student.fullName} attendance`}\n                            className=\"w-full h-full object-cover\"\n                            loading=\"lazy\"\n                          />\n                        ) : (\n                          <span className=\"text-[10px] text-muted-foreground\">\n                            No photo\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            ))}\n          </div>\n        </div>\n\n        {/* Column 3: Actions + Summary */}\n        <div>\n          <h2 className=\"text-xl font-semibold mb-4\">Actions</h2>\n          <Card className=\"sticky top-4\">\n            <CardContent className=\"p-4\">\n              <RosterActions\n                onCameraView={handleStartAttendance}\n                onSubmit={handleSubmit}\n                onFormRoster={handleFormRoster}\n                onNotifications={handleNotifications}\n                isSubmitting={submitAttendance.isPending}\n                isStartDisabled={isStartDisabled}\n              />\n            </CardContent>\n          </Card>\n\n          {/* Summary */}\n          <Card className=\"mt-4\">\n            <CardHeader>\n              <CardTitle className=\"text-sm\">Summary</CardTitle>\n            </CardHeader>\n            <CardContent className=\"text-sm space-y-1\">\n              <div className=\"flex justify-between\">\n                <span>Total:</span>\n                <span className=\"font-semibold\">{students.length}</span>\n              </div>\n              <div className=\"flex justify-between text-green-600\">\n                <span>Present:</span>\n                <span className=\"font-semibold\">{presentCount}</span>\n              </div>\n              <div className=\"flex justify-between text-red-600\">\n                <span>Absent:</span>\n                <span className=\"font-semibold\">{absentCount}</span>\n              </div>\n              <div className=\"flex justify-between text-yellow-600\">\n                <span>Late:</span>\n                <span className=\"font-semibold\">{lateCount}</span>\n              </div>\n              <div className=\"flex justify-between text-blue-600\">\n                <span>Excused:</span>\n                <span className=\"font-semibold\">{excusedCount}</span>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\lecturer\\schedule\\page.tsx",
      "relative_path": "app/lecturer/schedule/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 4971,
      "lines": 158,
      "last_modified": "2025-11-16T12:25:26.091482",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useState, useEffect } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { useTranslations } from 'next-intl';\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { Slot } from \"@/types\";\nimport { getWeekRange, getPreviousWeek, getNextWeek } from \"@/lib/calendar-utils\";\nimport { format, parseISO } from \"date-fns\";\nimport { ScheduleHeader } from \"@/components/lecturer/schedule/schedule-header\";\nimport { CalendarWeekContainer } from \"@/components/lecturer/calendar/calendar-week-container\";\nimport { ScheduleSlotDetailDialog } from \"@/components/lecturer/schedule/schedule-slot-detail-dialog\";\nimport { useGetSlots } from \"@/hooks/api/useSlots\";\nimport { getUserId } from \"@/lib/auth\";\nimport { getVietnamNow } from \"@/lib/timezone-utils\";\n\nfunction SchedulePageContent() {\n  const t = useTranslations('schedule');\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // 1. EXTRACT URL STATE\n  const dateParam = searchParams.get(\"date\") || format(getVietnamNow(), \"yyyy-MM-dd\");\n\n  // 2. LOCAL STATE\n  const [referenceDate, setReferenceDate] = useState<Date>(parseISO(dateParam));\n  const [selectedSlot, setSelectedSlot] = useState<Slot | null>(null);\n\n  // Sync reference date with URL param\n  useEffect(() => {\n    try {\n      setReferenceDate(parseISO(dateParam));\n    } catch {\n      setReferenceDate(getVietnamNow());\n    }\n  }, [dateParam]);\n\n  // Set page header\n  useEffect(() => {\n    setPageHeader({\n      breadcrumbs: [\n        { label: t('dashboard'), href: \"/lecturer/dashboard\" },\n        { label: t('my_schedule') },\n      ],\n      title: t('my_schedule'),\n      subtitle: t('lecturer_schedule_subtitle'),\n    });\n\n    return () => clearPageHeader();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  // 3. CALCULATE DATE RANGE (Week only)\n  const weekRange = getWeekRange(referenceDate);\n\n  // 4. URL UPDATE HELPER\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        newParams.set(key, String(value));\n      } else {\n        newParams.delete(key);\n      }\n    });\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  // Get current lecturer ID from auth\n  const currentLecturerId = getUserId();\n\n  // 5. FETCH DATA FROM API\n  // Fetch ALL slots for current lecturer in date range\n  const { data: slotsData, isLoading } = useGetSlots({\n    staffUserId: currentLecturerId || undefined,\n    slotCategories: [\"LECTURE\", \"LECTURE_WITH_PT\"], // Lecturer only sees these categories\n    startTimeFrom: format(weekRange.startDate, \"yyyy-MM-dd\"),\n    startTimeTo: format(weekRange.endDate, \"yyyy-MM-dd\"),\n    isActive: true,\n    page: 1,\n    pageSize: 100,\n  });\n\n  // Extract slots data\n  const slots = slotsData?.items || [];\n\n  // 6. EVENT HANDLERS\n  const handlePrevious = () => {\n    const newDate = getPreviousWeek(referenceDate);\n    updateURL({ date: format(newDate, \"yyyy-MM-dd\") });\n  };\n\n  const handleNext = () => {\n    const newDate = getNextWeek(referenceDate);\n    updateURL({ date: format(newDate, \"yyyy-MM-dd\") });\n  };\n\n  const handleToday = () => {\n    updateURL({ date: format(getVietnamNow(), \"yyyy-MM-dd\") });\n  };\n\n  const handleSlotClick = (slot: Slot) => {\n    setSelectedSlot(slot);\n  };\n\n  // 7. RENDER\n  return (\n    <div className=\"space-y-4 p-6\">\n      {/* Calendar Header */}\n      <ScheduleHeader\n        dateRange={{\n          mondayDate: weekRange.mondayDate,\n          sundayDate: weekRange.sundayDate,\n        }}\n        onPrevious={handlePrevious}\n        onNext={handleNext}\n        onToday={handleToday}\n      />\n\n      {/* Calendar Week View */}\n      <CalendarWeekContainer\n        mondayDate={weekRange.mondayDate}\n        slots={slots}\n        isLoading={isLoading}\n        onSlotClick={handleSlotClick}\n      />\n\n      {/* Slot Detail Dialog */}\n      <ScheduleSlotDetailDialog\n        slot={selectedSlot}\n        open={!!selectedSlot}\n        onOpenChange={(open) => !open && setSelectedSlot(null)}\n      />\n    </div>\n  );\n}\n\n// 8. WRAP WITH SUSPENSE (required for useSearchParams)\nexport default function SchedulePage() {\n  const tCommon = useTranslations('common');\n  \n  return (\n    <Suspense\n      fallback={\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <div className=\"text-muted-foreground\">{tCommon('loading')}</div>\n        </div>\n      }\n    >\n      <SchedulePageContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\lecturer\\slots\\[id]\\roster\\page.tsx",
      "relative_path": "app/lecturer/slots/[id]/roster/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 9430,
      "lines": 271,
      "last_modified": "2025-11-16T12:19:16.027466",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useParams } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  SlotRosterTable,\n  type PendingChange,\n} from \"@/components/admin/slots/slot-roster-table\";\nimport { SessionControls } from \"@/components/admin/slots/session-controls\";\nimport { ExamSessionControls } from \"@/components/admin/slots/exam-session-controls\";\nimport { type StatusFilter } from \"@/components/admin/slots/roster-filters\";\nimport { EvidenceViewerDialog } from \"@/components/admin/slots/evidence-viewer-dialog\";\nimport { useGetSlot } from \"@/hooks/api/useSlots\";\nimport { useGetSlotRoster } from \"@/hooks/api/useSlotRoster\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useSlotRosterSSE } from \"@/hooks/realtime/useSlotRosterSSE\";\nimport type { AttendanceType } from \"@/types\";\n\nexport default function LecturerSlotRosterPage() {\n  const params = useParams();\n  const slotId = Number(params.id);\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  const { data: slot, isLoading: isLoadingSlot } = useGetSlot(slotId);\n  const { data: roster, isLoading: isLoadingRoster } = useGetSlotRoster(slotId);\n\n  // Realtime updates via SSE (patches the roster cache)\n  useSlotRosterSSE(slotId);\n\n  // Pending changes state for inline editing\n  // Use composite key (attendanceType-recordId) to ensure Regular and Exam are independent\n  const [pendingChanges, setPendingChanges] = useState<\n    Map<string, PendingChange>\n  >(new Map());\n\n  // Active tab state for LECTURE_WITH_PT and FINAL_EXAM slots\n  const [activeTab, setActiveTab] = useState<AttendanceType>(\"REGULAR\");\n\n  // Filter state for Regular attendance\n  const [regularStatusFilter, setRegularStatusFilter] =\n    useState<StatusFilter>(\"all\");\n  const [regularSearchQuery, setRegularSearchQuery] = useState(\"\");\n\n  // Filter state for Exam attendance\n  const [examStatusFilter, setExamStatusFilter] = useState<StatusFilter>(\"all\");\n  const [examSearchQuery, setExamSearchQuery] = useState(\"\");\n\n  const [evidenceDialogOpen, setEvidenceDialogOpen] = useState(false);\n  const [avatarImageUrl, setAvatarImageUrl] = useState<string>(\"\");\n  const [evidenceImageUrl, setEvidenceImageUrl] = useState<string | null>(null);\n  const [studentName, setStudentName] = useState<string>(\"\");\n\n  const handleViewEvidence = (\n    avatarUrl: string,\n    evidenceUrl: string | null,\n    name: string\n  ) => {\n    setAvatarImageUrl(avatarUrl);\n    setEvidenceImageUrl(evidenceUrl);\n    setStudentName(name);\n    setEvidenceDialogOpen(true);\n  };\n\n  const handlePendingChange = (\n    recordId: number,\n    attendanceType: AttendanceType,\n    status: \"present\" | \"absent\" | \"not_yet\",\n    remark?: string\n  ) => {\n    const newPendingChanges = new Map(pendingChanges);\n    const key = `${attendanceType}-${recordId}`;\n    newPendingChanges.set(key, { status, remark });\n    setPendingChanges(newPendingChanges);\n  };\n\n  const clearPendingChanges = () => {\n    setPendingChanges(new Map());\n  };\n\n  // Set page header\n  useEffect(() => {\n    if (!slot) {\n      setPageHeader({\n        title: \"Slot Roster\",\n        subtitle: \"Loading slot details...\",\n        breadcrumbs: [\n          { label: \"Dashboard\", href: \"/lecturer/dashboard\" },\n          { label: \"My Slots\", href: \"/lecturer/slots\" },\n          { label: \"Slot Roster\" },\n        ],\n      });\n      return;\n    }\n\n    const getCategoryLabel = (category: string) => {\n      const labels = {\n        LECTURE: \"Lecture\",\n        LECTURE_WITH_PT: \"Lecture with PT\",\n        FINAL_EXAM: \"Final Exam\",\n      };\n      return labels[category as keyof typeof labels] || category;\n    };\n\n    setPageHeader({\n      title: slot.title || \"Untitled Slot\",\n      subtitle: `${slot.class?.code || \"\"} â€¢ ${getCategoryLabel(\n        slot.slotCategory\n      )} â€¢ ${format(new Date(slot.startTime), \"MMM d, yyyy\")} â€¢ ${format(\n        new Date(slot.startTime),\n        \"h:mm a\"\n      )} - ${format(new Date(slot.endTime), \"h:mm a\")} â€¢ ${slot.room.name}`,\n      breadcrumbs: [\n        { label: \"Dashboard\", href: \"/lecturer/dashboard\" },\n        { label: \"My Slots\", href: \"/lecturer/slots\" },\n        { label: slot.title || \"Untitled Slot\" },\n      ],\n    });\n  }, [slot, setPageHeader]);\n\n  // Clear header on unmount\n  useEffect(() => {\n    return () => {\n      clearPageHeader();\n    };\n  }, [clearPageHeader]);\n\n  if (isLoadingSlot || isLoadingRoster) {\n    return (\n      <div className=\"space-y-6\">\n        <Skeleton className=\"h-10 w-full\" />\n        <Skeleton className=\"h-32 w-full\" />\n        <Skeleton className=\"h-96 w-full\" />\n      </div>\n    );\n  }\n\n  if (!slot || !roster) {\n    return (\n      <div className=\"flex flex-col items-center justify-center min-h-[400px] gap-4\">\n        <p className=\"text-muted-foreground\">Slot not found</p>\n      </div>\n    );\n  }\n\n  // Determine if this slot supports exam attendance\n  const hasExamAttendance =\n    slot.slotCategory === \"LECTURE_WITH_PT\" ||\n    slot.slotCategory === \"FINAL_EXAM\";\n\n  // Check mutual exclusion for tab disabling\n  const isRegularRunning = slot.sessionStatus === \"RUNNING\";\n  const isExamRunning = slot.examSessionStatus === \"RUNNING\";\n\n  // Regular LECTURE slots - single view (no tabs)\n  if (!hasExamAttendance) {\n    return (\n      <div className=\"space-y-6\">\n        {/* Session Controls + Roster Table - Merged into one Card */}\n        <SessionControls\n          slot={slot}\n          roster={roster}\n          pendingChanges={pendingChanges}\n          onSubmitSuccess={clearPendingChanges}\n          statusFilter={regularStatusFilter}\n          onStatusFilterChange={setRegularStatusFilter}\n          searchQuery={regularSearchQuery}\n          onSearchQueryChange={setRegularSearchQuery}\n        >\n          <SlotRosterTable\n            data={roster}\n            slot={slot}\n            attendanceType=\"REGULAR\"\n            pendingChanges={pendingChanges}\n            onPendingChange={handlePendingChange}\n            onViewEvidence={handleViewEvidence}\n            isSessionRunning={isRegularRunning}\n          />\n        </SessionControls>\n\n        {/* Evidence Viewer Dialog */}\n        <EvidenceViewerDialog\n          open={evidenceDialogOpen}\n          onOpenChange={setEvidenceDialogOpen}\n          avatarUrl={avatarImageUrl}\n          evidenceUrl={evidenceImageUrl}\n          studentName={studentName}\n        />\n      </div>\n    );\n  }\n\n  // LECTURE_WITH_PT and FINAL_EXAM slots - tabbed view\n  return (\n    <div className=\"space-y-6\">\n      <Tabs\n        value={activeTab}\n        onValueChange={(value) => setActiveTab(value as AttendanceType)}\n        className=\"space-y-4\"\n      >\n        <TabsList className=\"grid w-full max-w-md grid-cols-2\">\n          <TabsTrigger value=\"REGULAR\" disabled={isExamRunning}>\n            Regular Attendance\n          </TabsTrigger>\n          <TabsTrigger value=\"EXAM\" disabled={isRegularRunning}>\n            Exam Attendance\n          </TabsTrigger>\n        </TabsList>\n\n        {/* Regular Attendance Tab */}\n        <TabsContent value=\"REGULAR\" className=\"space-y-6\">\n          <SessionControls\n            slot={slot}\n            roster={roster}\n            pendingChanges={pendingChanges}\n            onSubmitSuccess={clearPendingChanges}\n            statusFilter={regularStatusFilter}\n            onStatusFilterChange={setRegularStatusFilter}\n            searchQuery={regularSearchQuery}\n            onSearchQueryChange={setRegularSearchQuery}\n          >\n            <SlotRosterTable\n              data={roster}\n              slot={slot}\n              attendanceType=\"REGULAR\"\n              pendingChanges={pendingChanges}\n              onPendingChange={handlePendingChange}\n              onViewEvidence={handleViewEvidence}\n              isSessionRunning={isRegularRunning}\n            />\n          </SessionControls>\n        </TabsContent>\n\n        {/* Exam Attendance Tab */}\n        <TabsContent value=\"EXAM\" className=\"space-y-6\">\n          <ExamSessionControls\n            slot={slot}\n            roster={roster}\n            pendingChanges={pendingChanges}\n            onSubmitSuccess={clearPendingChanges}\n            statusFilter={examStatusFilter}\n            onStatusFilterChange={setExamStatusFilter}\n            searchQuery={examSearchQuery}\n            onSearchQueryChange={setExamSearchQuery}\n          >\n            <SlotRosterTable\n              data={roster}\n              slot={slot}\n              attendanceType=\"EXAM\"\n              pendingChanges={pendingChanges}\n              onPendingChange={handlePendingChange}\n              onViewEvidence={handleViewEvidence}\n              isSessionRunning={isExamRunning}\n            />\n          </ExamSessionControls>\n        </TabsContent>\n      </Tabs>\n\n      {/* Evidence Viewer Dialog */}\n      <EvidenceViewerDialog\n        open={evidenceDialogOpen}\n        onOpenChange={setEvidenceDialogOpen}\n        avatarUrl={avatarImageUrl}\n        evidenceUrl={evidenceImageUrl}\n        studentName={studentName}\n      />\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\lecturer\\slots\\page.tsx",
      "relative_path": "app/lecturer/slots/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 30879,
      "lines": 831,
      "last_modified": "2025-11-14T19:27:40.466733",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useState, useMemo, useRef } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { useTranslations } from 'next-intl';\nimport { CalendarIcon, SlidersHorizontal } from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { Button } from \"@/components/ui/button\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { LecturerSlotTable } from \"@/components/lecturer/slots/lecturer-slot-table\";\nimport { createLecturerSlotColumns } from \"@/components/lecturer/slots/lecturer-slot-columns\";\nimport {\n  LecturerSlotFormDialog,\n  LecturerSlotFormData,\n} from \"@/components/lecturer/slots/lecturer-slot-form-dialog\";\nimport { Slot } from \"@/types\";\nimport { useUpdateSlotCategory } from \"@/hooks/api/useSlots\";\nimport {\n  useGetStaffSlots,\n  useGetStaffSubjects,\n  useGetStaffClasses,\n  useGetStaffRooms,\n} from \"@/hooks/api/useStaffProfiles\";\nimport { useGetSemesters } from \"@/hooks/api/useSemesters\";\nimport { format } from \"date-fns\";\nimport { cn } from \"@/lib/utils\";\nimport { saveSlotsPageState } from \"@/lib/navigation-state\";\nimport { getUserId } from \"@/lib/auth\";\nimport { DEFAULT_PAGE_SIZE, FILTER_PAGE_SIZE } from \"@/lib/constants\";\n\n// Helper function to get current week (Monday to Sunday)\nconst getCurrentWeek = () => {\n  const now = new Date();\n  const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ...\n  const monday = new Date(now);\n  monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));\n  monday.setHours(0, 0, 0, 0);\n\n  const sunday = new Date(monday);\n  sunday.setDate(monday.getDate() + 6);\n  sunday.setHours(23, 59, 59, 999);\n\n  return {\n    startDate: format(monday, \"yyyy-MM-dd\"),\n    endDate: format(sunday, \"yyyy-MM-dd\"),\n  };\n};\n\nfunction LecturerSlotsContent() {\n  const t = useTranslations('lecturer');\n  const tCommon = useTranslations('common');\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // Get current lecturer ID from auth\n  const currentLecturerId = getUserId();\n\n  // URL params\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const sortBy = (\n    [\"startTime\", \"endTime\"].includes(searchParams.get(\"sortBy\") || \"\")\n      ? searchParams.get(\"sortBy\")\n      : \"startTime\"\n  ) as \"startTime\" | \"endTime\";\n  const sortOrder = (searchParams.get(\"sort\") === \"asc\" ? \"asc\" : \"desc\") as\n    | \"asc\"\n    | \"desc\";\n\n  // URL param extraction\n  const semesterIdParam = searchParams.get(\"semesterId\");\n  const classIdParam = searchParams.get(\"classId\");\n  const subjectIdParam = searchParams.get(\"subjectId\");\n  const roomIdParam = searchParams.get(\"roomId\");\n  const isActiveParam = searchParams.get(\"isActive\");\n  const startTimeFromParam = searchParams.get(\"startTimeFrom\");\n  const startTimeToParam = searchParams.get(\"startTimeTo\");\n\n  // ========== SEMESTER LOGIC (PRIORITY 1) ==========\n  // Fetch semesters first (required for auto-select logic)\n  const { data: semestersData, isLoading: semestersLoading } = useGetSemesters({\n    pageSize: FILTER_PAGE_SIZE,\n    isActive: true,\n  });\n\n  // Extract semesters array\n  const semesters = useMemo(() => semestersData?.items || [], [semestersData]);\n\n  // Calculate current semester (start_date <= now <= end_date)\n  const currentSemester = useMemo(() => {\n    if (!semesters || semesters.length === 0) return null;\n\n    const now = new Date();\n    return semesters.find((s) => {\n      const start = new Date(s.startDate);\n      const end = new Date(s.endDate);\n      return now >= start && now <= end;\n    });\n  }, [semesters]);\n\n  // Calculate semesterIdFilter - KHÃ”NG auto-fallback, respect user choice\n  // Náº¿u user chá»n \"All Semesters\" (khÃ´ng cÃ³ param) â†’ undefined = show all\n  // Auto-select chá»‰ xáº£y ra trong useEffect initialization (xem dÆ°á»›i)\n  const semesterIdFilter = semesterIdParam && !isNaN(Number(semesterIdParam))\n    ? Number(semesterIdParam)\n    : undefined;\n\n  // ========== OTHER FILTERS ==========\n  const classIdFilter = classIdParam ? Number(classIdParam) : undefined;\n  const subjectIdFilter = subjectIdParam ? Number(subjectIdParam) : undefined;\n  const roomIdFilter = roomIdParam ? Number(roomIdParam) : undefined;\n  const isActiveFilter = isActiveParam === \"false\" ? false : true; // Default to active only\n\n  // Combobox open states\n  const [semesterFilterOpen, setSemesterFilterOpen] = useState(false);\n  const [subjectFilterOpen, setSubjectFilterOpen] = useState(false);\n  const [classFilterOpen, setClassFilterOpen] = useState(false);\n  const [roomFilterOpen, setRoomFilterOpen] = useState(false);\n\n  // Advanced filters popover state\n  const [advancedFiltersOpen, setAdvancedFiltersOpen] = useState(false);\n\n  // Date picker states\n  const [startDateOpen, setStartDateOpen] = useState(false);\n  const [endDateOpen, setEndDateOpen] = useState(false);\n\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [selectedSlot, setSelectedSlot] = useState<Slot | null>(null);\n\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    // Always ensure sortBy and sort are present\n    if (!newParams.has(\"sortBy\")) {\n      newParams.set(\"sortBy\", sortBy);\n    }\n    if (!newParams.has(\"sort\")) {\n      newParams.set(\"sort\", sortOrder);\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  const canFetchSlots = Boolean(currentLecturerId);\n\n  const { data: subjectsData } = useGetStaffSubjects(currentLecturerId || 0, {\n    pageSize: FILTER_PAGE_SIZE,\n    semesterId: semesterIdFilter,\n    isActive: true,\n  });\n\n  const { data: classesData } = useGetStaffClasses(currentLecturerId || 0, {\n    pageSize: FILTER_PAGE_SIZE,\n    semesterId: semesterIdFilter,\n    isActive: true,\n  });\n\n  const { data: roomsData } = useGetStaffRooms(currentLecturerId || 0, {\n    pageSize: FILTER_PAGE_SIZE,\n    semesterId: semesterIdFilter,\n    isActive: true,\n  });\n\n  // Fetch slots for current lecturer (only LECTURE and LECTURE_WITH_PT)\n  const { data, isLoading } = useGetStaffSlots(currentLecturerId || 0, {\n    page,\n    pageSize: DEFAULT_PAGE_SIZE,\n    sort: sortOrder,\n    sortBy: sortBy,\n    slotCategories: [\"LECTURE\", \"LECTURE_WITH_PT\"], // Lecturer only sees these categories\n    semesterId: semesterIdFilter,\n    classId: classIdFilter,\n    subjectId: subjectIdFilter,\n    roomId: roomIdFilter,\n    isActive: isActiveFilter,\n    startTimeFrom: startTimeFromParam || undefined,\n    startTimeTo: startTimeToParam || undefined,\n  });\n\n  const updateCategoryMutation = useUpdateSlotCategory();\n\n  // Extract data directly (already filtered by server)\n  const slots = data?.items || [];\n  const totalItems = data?.totalItems ?? 0;\n  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;\n  const safePageSize = pageSize > 0 ? pageSize : DEFAULT_PAGE_SIZE;\n  const totalPages = Math.max(1, Math.ceil(totalItems / safePageSize));\n  const currentPageRaw = data?.currentPage ?? page;\n  const currentPage = Math.min(Math.max(currentPageRaw, 1), totalPages);\n\n  useEffect(() => {\n    if (!isLoading && canFetchSlots && page > totalPages && totalPages >= 1) {\n      updateURL({ page: totalPages });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isLoading, canFetchSlots, page, totalPages]);\n\n  // Deduplicate subjects by id (temporary workaround for backend duplicate issue)\n  const subjects = Array.from(\n    new Map((subjectsData?.items || []).map((subj) => [subj.id, subj])).values()\n  );\n  // Deduplicate classes by id (temporary workaround for backend duplicate issue)\n  const classes = Array.from(\n    new Map((classesData?.items || []).map((cls) => [cls.id, cls])).values()\n  );\n  const rooms = roomsData?.items || [];\n\n  // ========== UNIFIED URL INITIALIZATION ==========\n  // Track if auto-select has been done to prevent re-triggering when user clears filter\n  const hasAutoSelected = useRef(false);\n\n  // Single unified URL initialization effect\n  useEffect(() => {\n    // Wait for semesters to load\n    if (semestersLoading) return;\n\n    // Only run once on initial load\n    if (hasAutoSelected.current) return;\n\n    // âš ï¸ CRITICAL: Chá»‰ auto-select khi currentSemester Ä‘Ã£ sáºµn sÃ ng\n    // Náº¿u chÆ°a cÃ³ currentSemester, chá» láº§n render sau (useEffect sáº½ cháº¡y láº¡i khi currentSemester thay Ä‘á»•i)\n    if (!currentSemester) return;\n\n    // ÄÃ¡nh dáº¥u Ä‘Ã£ auto-select (chá»‰ set khi ÄÃƒ CÃ“ currentSemester)\n    hasAutoSelected.current = true;\n\n    const updates: Record<string, string | number | undefined> = {};\n    let needsUpdate = false;\n\n    // 1ï¸âƒ£ SEMESTER - Bá»• sung náº¿u thiáº¿u (currentSemester Ä‘Ã£ guaranteed tá»“n táº¡i)\n    if (!semesterIdParam) {\n      updates.semesterId = currentSemester.id;\n      needsUpdate = true;\n    }\n\n    // 2ï¸âƒ£ DATE RANGE - Bá»• sung náº¿u thiáº¿u\n    if (!startTimeFromParam && !startTimeToParam) {\n      const { startDate, endDate } = getCurrentWeek();\n      updates.startTimeFrom = startDate;\n      updates.startTimeTo = endDate;\n      needsUpdate = true;\n    }\n\n    // 3ï¸âƒ£ SORT PARAMS - Bá»• sung náº¿u thiáº¿u\n    if (!searchParams.has(\"sortBy\") || !searchParams.has(\"sort\")) {\n      updates.sortBy = sortBy;\n      updates.sort = sortOrder;\n      needsUpdate = true;\n    }\n\n    // Single atomic URL update - Cáº¢ semester + date Ä‘á»u lÃªn URL cÃ¹ng lÃºc\n    if (needsUpdate) {\n      updates.page = 1;\n      updateURL(updates);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    semestersLoading,\n    currentSemester,\n    semesterIdParam,\n    startTimeFromParam,\n    startTimeToParam,\n    searchParams,\n    sortBy,\n    sortOrder,\n  ]);\n\n  // Find selected items for display\n  const selectedSemester = semesters.find((s) => s.id === semesterIdFilter);\n  const selectedSubject = subjects.find((s) => s.id === subjectIdFilter);\n  const selectedClass = classes.find((c) => c.id === classIdFilter);\n  const selectedRoom = rooms.find((r) => r.id === roomIdFilter);\n\n  const handleEdit = (slot: Slot) => {\n    setSelectedSlot(slot);\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = async (data: LecturerSlotFormData) => {\n    if (!selectedSlot) return;\n\n    // Lecturer can ONLY update slot category (SLOT_UPDATE_CATEGORY permission)\n    // Use dedicated category update endpoint\n    await updateCategoryMutation.mutateAsync({\n      id: selectedSlot.id,\n      slotCategory: data.slotCategory,\n    });\n    setIsEditDialogOpen(false);\n    setSelectedSlot(null);\n  };\n\n  const handleViewRoster = (slot: Slot) => {\n    // Save current filters to sessionStorage for back navigation\n    saveSlotsPageState(searchParams);\n    // Navigate to lecturer roster page\n    router.push(`/lecturer/slots/${slot.id}/roster`);\n  };\n\n\n  const handlePageChange = (newPage: number) => {\n    const targetPage = Math.min(Math.max(newPage, 1), totalPages);\n    if (targetPage === page) return;\n    updateURL({ page: targetPage });\n  };\n\n  const handleSortByChange = (value: \"startTime\" | \"endTime\") => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleSemesterFilterChange = (value: string) => {\n    if (value === \"all\") {\n      // Clear semester and cascade clear dependent filters\n      updateURL({\n        semesterId: undefined,\n        classId: undefined,\n        subjectId: undefined,\n        roomId: undefined,\n        page: 1,\n      });\n    } else {\n      // Set semester and cascade clear dependent filters\n      updateURL({\n        semesterId: value,\n        classId: undefined,\n        subjectId: undefined,\n        roomId: undefined,\n        page: 1,\n      });\n    }\n  };\n\n  const handleClassFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ classId: undefined, page: 1 });\n    } else {\n      updateURL({ classId: value, page: 1 });\n    }\n  };\n\n  const handleSubjectFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ subjectId: undefined, page: 1 });\n    } else {\n      updateURL({ subjectId: value, page: 1 });\n    }\n  };\n\n  const handleRoomFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ roomId: undefined, page: 1 });\n    } else {\n      updateURL({ roomId: value, page: 1 });\n    }\n  };\n\n  const handleStartDateChange = (date: Date | undefined) => {\n    if (date) {\n      updateURL({ startTimeFrom: format(date, \"yyyy-MM-dd\"), page: 1 });\n    } else {\n      updateURL({ startTimeFrom: undefined, page: 1 });\n    }\n    setStartDateOpen(false);\n  };\n\n  const handleEndDateChange = (date: Date | undefined) => {\n    if (date) {\n      updateURL({ startTimeTo: format(date, \"yyyy-MM-dd\"), page: 1 });\n    } else {\n      updateURL({ startTimeTo: undefined, page: 1 });\n    }\n    setEndDateOpen(false);\n  };\n\n  const handleClearDateRange = () => {\n    updateURL({\n      startTimeFrom: undefined,\n      startTimeTo: undefined,\n      page: 1,\n    });\n  };\n\n  const handleClearAdvancedFilters = () => {\n    updateURL({\n      roomId: undefined,\n      page: 1,\n    });\n    setAdvancedFiltersOpen(false);\n  };\n\n  const columns = createLecturerSlotColumns(handleEdit, handleViewRoster);\n\n  // Set page header\n  useEffect(() => {\n    setPageHeader({\n      title: t('my_slots'),\n      subtitle: t('lecturer_subtitle'),\n      breadcrumbs: [\n        { label: tCommon('dashboard'), href: \"/lecturer/dashboard\" },\n        { label: t('my_slots') },\n      ],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader, t, tCommon]);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n        {/* Main Filters */}\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Semester Filter - PRIORITY 1 */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Semester:\n            </span>\n            <Popover\n              open={semesterFilterOpen}\n              onOpenChange={setSemesterFilterOpen}\n            >\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  role=\"combobox\"\n                  aria-expanded={semesterFilterOpen}\n                  className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[120px]\"\n                >\n                  <span className=\"truncate\">\n                    {selectedSemester ? selectedSemester.code : t('all_semesters')}\n                  </span>\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent align=\"start\" className=\"w-[300px] p-0\">\n                <Command>\n                  <CommandInput placeholder=\"Type to search semester...\" />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>No semester found.</CommandEmpty>\n                    <CommandGroup>\n                      <CommandItem\n                        value=\"all-semesters\"\n                        onSelect={() => {\n                          handleSemesterFilterChange(\"all\");\n                          setSemesterFilterOpen(false);\n                        }}\n                      >\n                        All Semesters\n                      </CommandItem>\n                      {semesters.map((semester) => (\n                        <CommandItem\n                          key={semester.id}\n                          value={`${semester.code}-${semester.name}`}\n                          onSelect={() => {\n                            handleSemesterFilterChange(String(semester.id));\n                            setSemesterFilterOpen(false);\n                          }}\n                        >\n                          {semester.code} - {semester.name}\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Date Range Filters - Grouped */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-2 bg-background w-full sm:w-auto\">\n            {/* Start Date */}\n            <Popover open={startDateOpen} onOpenChange={setStartDateOpen}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  className={cn(\n                    \"h-8 justify-start text-left font-normal px-2 w-[100px]\",\n                    !startTimeFromParam && \"text-muted-foreground\"\n                  )}\n                >\n                  <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                  {startTimeFromParam\n                    ? format(new Date(startTimeFromParam), \"MMM d\")\n                    : t('start')}\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                <Calendar\n                  mode=\"single\"\n                  selected={\n                    startTimeFromParam\n                      ? new Date(startTimeFromParam)\n                      : undefined\n                  }\n                  onSelect={handleStartDateChange}\n                  autoFocus\n                />\n              </PopoverContent>\n            </Popover>\n\n            <div className=\"h-6 w-px bg-border\" />\n\n            {/* End Date */}\n            <Popover open={endDateOpen} onOpenChange={setEndDateOpen}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  className={cn(\n                    \"h-8 justify-start text-left font-normal px-2 w-[100px]\",\n                    !startTimeToParam && \"text-muted-foreground\"\n                  )}\n                >\n                  <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                  {startTimeToParam\n                    ? format(new Date(startTimeToParam), \"MMM d\")\n                    : t('end')}\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                <Calendar\n                  mode=\"single\"\n                  selected={\n                    startTimeToParam ? new Date(startTimeToParam) : undefined\n                  }\n                  onSelect={handleEndDateChange}\n                  autoFocus\n                />\n              </PopoverContent>\n            </Popover>\n\n            {/* Clear Date Range Button */}\n            <>\n              <div className=\"h-6 w-px bg-border\" />\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleClearDateRange}\n                className=\"h-8 px-2 text-xs\"\n              >\n                Clear\n              </Button>\n            </>\n          </div>\n\n          {/* Class Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Class:\n            </span>\n            <Popover open={classFilterOpen} onOpenChange={setClassFilterOpen}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  role=\"combobox\"\n                  aria-expanded={classFilterOpen}\n                  className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[80px]\"\n                >\n                  <span className=\"truncate\">\n                    {selectedClass ? selectedClass.code : t('all_classes')}\n                  </span>\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent align=\"start\" className=\"w-[300px] p-0\">\n                <Command>\n                  <CommandInput placeholder=\"Type to search class...\" />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>No class found.</CommandEmpty>\n                    <CommandGroup>\n                      <CommandItem\n                        value=\"all-classes\"\n                        onSelect={() => {\n                          handleClassFilterChange(\"all\");\n                          setClassFilterOpen(false);\n                        }}\n                      >\n                        All Classes\n                      </CommandItem>\n                      {classes.map((cls) => (\n                        <CommandItem\n                          key={cls.id}\n                          value={`${cls.code}`}\n                          onSelect={() => {\n                            handleClassFilterChange(String(cls.id));\n                            setClassFilterOpen(false);\n                          }}\n                        >\n                          {cls.code}\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Subject Filter */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              Subject:\n            </span>\n            <Popover\n              open={subjectFilterOpen}\n              onOpenChange={setSubjectFilterOpen}\n            >\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  role=\"combobox\"\n                  aria-expanded={subjectFilterOpen}\n                  className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[150px]\"\n                >\n                  <span className=\"truncate\">\n                    {selectedSubject\n                      ? `${selectedSubject.code} - ${selectedSubject.name}`\n                      : t('all_subjects')}\n                  </span>\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent align=\"start\" className=\"w-[350px] p-0\">\n                <Command>\n                  <CommandInput placeholder=\"Type to search subject...\" />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>No subject found.</CommandEmpty>\n                    <CommandGroup>\n                      <CommandItem\n                        value=\"all-subjects\"\n                        onSelect={() => {\n                          handleSubjectFilterChange(\"all\");\n                          setSubjectFilterOpen(false);\n                        }}\n                      >\n                        All Subjects\n                      </CommandItem>\n                      {subjects.map((subject) => (\n                        <CommandItem\n                          key={subject.id}\n                          value={`${subject.code}-${subject.name}`}\n                          onSelect={() => {\n                            handleSubjectFilterChange(String(subject.id));\n                            setSubjectFilterOpen(false);\n                          }}\n                        >\n                          {subject.code} - {subject.name}\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Advanced Filters Button */}\n          <Popover\n            open={advancedFiltersOpen}\n            onOpenChange={setAdvancedFiltersOpen}\n          >\n            <PopoverTrigger asChild>\n              <Button variant=\"outline\" className=\"h-10 w-full sm:w-auto\">\n                <SlidersHorizontal className=\"mr-2 h-4 w-4\" />\n                Advanced Filters\n              </Button>\n            </PopoverTrigger>\n            <PopoverContent align=\"start\" className=\"w-[400px] p-4\">\n              <div className=\"space-y-4\">\n                <h4 className=\"font-medium text-sm\">Advanced Filters</h4>\n\n                {/* Room Filter */}\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm text-muted-foreground\">Room</label>\n                  <Popover\n                    open={roomFilterOpen}\n                    onOpenChange={setRoomFilterOpen}\n                  >\n                    <PopoverTrigger asChild>\n                      <Button\n                        variant=\"outline\"\n                        role=\"combobox\"\n                        className=\"w-full justify-between\"\n                      >\n                        {selectedRoom ? selectedRoom.name : t('all_rooms')}\n                      </Button>\n                    </PopoverTrigger>\n                    <PopoverContent className=\"w-[350px] p-0\" align=\"start\">\n                      <Command>\n                        <CommandInput placeholder=\"Search room...\" />\n                        <CommandList className=\"max-h-[200px] overflow-y-auto\">\n                          <CommandEmpty>No room found.</CommandEmpty>\n                          <CommandGroup>\n                            <CommandItem\n                              value=\"all-rooms\"\n                              onSelect={() => {\n                                handleRoomFilterChange(\"all\");\n                                setRoomFilterOpen(false);\n                              }}\n                            >\n                              All Rooms\n                            </CommandItem>\n                            {rooms.map((room) => (\n                              <CommandItem\n                                key={room.id}\n                                value={`${room.name} ${room.location}`}\n                                onSelect={() => {\n                                  handleRoomFilterChange(String(room.id));\n                                  setRoomFilterOpen(false);\n                                }}\n                              >\n                                {room.name} - {room.location}\n                              </CommandItem>\n                            ))}\n                          </CommandGroup>\n                        </CommandList>\n                      </Command>\n                    </PopoverContent>\n                  </Popover>\n                </div>\n\n                {/* Sort Controls */}\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm text-muted-foreground\">Sort</label>\n                  <div className=\"flex gap-2\">\n                    <Select value={sortBy} onValueChange={handleSortByChange}>\n                      <SelectTrigger className=\"flex-1\">\n                        <SelectValue placeholder=\"Sort by...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"startTime\">Start Time</SelectItem>\n                        <SelectItem value=\"endTime\">End Time</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <Select\n                      value={sortOrder}\n                      onValueChange={handleSortOrderChange}\n                    >\n                      <SelectTrigger className=\"flex-1\">\n                        <SelectValue placeholder=\"Order...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"asc\">Ascending</SelectItem>\n                        <SelectItem value=\"desc\">Descending</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n\n                {/* Clear Advanced Filters Button */}\n                <div className=\"pt-2 border-t\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={handleClearAdvancedFilters}\n                    className=\"w-full\"\n                  >\n                    Clear All Advanced Filters\n                  </Button>\n                </div>\n              </div>\n            </PopoverContent>\n          </Popover>\n        </div>\n      </div>\n\n      <LecturerSlotTable\n        columns={columns}\n        data={slots}\n        isLoading={isLoading}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={safePageSize}\n        onPageChange={handlePageChange}\n      />\n\n      <LecturerSlotFormDialog\n        open={isEditDialogOpen}\n        onOpenChange={setIsEditDialogOpen}\n        slot={selectedSlot || undefined}\n        onSubmit={handleUpdate}\n        isSubmitting={updateCategoryMutation.isPending}\n      />\n    </div>\n  );\n}\n\nexport default function LecturerSlotsPage() {\n  return (\n    <Suspense fallback={<div>Loading...</div>}>\n      <LecturerSlotsContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\login\\page.tsx",
      "relative_path": "app/login/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 1352,
      "lines": 44,
      "last_modified": "2025-11-13T21:14:04.087641",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { getAuthToken, getAuthUser, getRoleBasedRedirectPath } from \"@/lib/auth\";\nimport { LoginForm } from \"@/components/auth/login-form\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\n\nexport default function LoginPage(): React.JSX.Element {\n  const router = useRouter();\n\n  useEffect(() => {\n    const token = getAuthToken();\n    const user = getAuthUser();\n\n    if (token && user) {\n      // User already authenticated - redirect to role-based dashboard\n      const dashboardPath = getRoleBasedRedirectPath(user.roles);\n      router.replace(dashboardPath);\n    }\n  }, [router]);\n\n  return (\n    <main className=\"flex min-h-[100dvh] items-center justify-center bg-background px-4\">\n      <Card className=\"w-full max-w-md border-border/60 shadow-lg\">\n        <CardHeader className=\"space-y-1 text-center\">\n          <CardTitle className=\"text-2xl font-semibold tracking-tight\">\n            Sign in\n          </CardTitle>\n          <CardDescription>Use your FUACS account to continue.</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <LoginForm />\n        </CardContent>\n      </Card>\n    </main>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\not-found.tsx",
      "relative_path": "app/not-found.tsx",
      "filename": "not-found.tsx",
      "size_bytes": 317,
      "lines": 9,
      "last_modified": "2025-11-01T15:38:43.273939",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "export default function NotFound() {\n  return (\n    <div className=\"flex flex-col items-center justify-center min-h-screen\">\n      <h2 className=\"text-2xl font-bold mb-4\">404 - Page Not Found</h2>\n      <p className=\"text-muted-foreground\">The page you are looking for does not exist.</p>\n    </div>\n  );\n}\n\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\page.tsx",
      "relative_path": "app/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 1079,
      "lines": 33,
      "last_modified": "2025-11-01T15:38:43.273939",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { getAuthToken, getAuthUser, getRoleBasedRedirectPath } from \"@/lib/auth\";\n\nexport default function Home() {\n  const router = useRouter();\n\n  useEffect(() => {\n    const token = getAuthToken();\n    const user = getAuthUser();\n\n    if (token && user) {\n      // User is authenticated - redirect to role-specific dashboard\n      const dashboardPath = getRoleBasedRedirectPath(user.roles);\n      router.replace(dashboardPath);\n    } else {\n      // User is not authenticated - redirect to login\n      router.replace(\"/login\");\n    }\n  }, [router]);\n\n  // Show a simple loading state while redirecting\n  return (\n    <div className=\"flex min-h-screen items-center justify-center\">\n      <div className=\"flex flex-col items-center gap-2\">\n        <div className=\"h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent\" />\n        <p className=\"text-sm text-muted-foreground\">Redirecting...</p>\n      </div>\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\reset-password\\page.tsx",
      "relative_path": "app/reset-password/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 6882,
      "lines": 204,
      "last_modified": "2025-11-10T23:08:19.295830",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, Suspense } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useSearchParams } from \"next/navigation\";\nimport { toast } from \"sonner\";\nimport { Eye, EyeOff } from \"lucide-react\";\nimport { useState } from \"react\";\n\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardFooter,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { useResetPassword } from \"@/hooks/api/useAuth\";\n\n// Validation schema\nconst resetPasswordSchema = z\n  .object({\n    token: z.string().min(1, \"Token is required\"),\n    newPassword: z\n      .string()\n      .min(8, \"Password must be at least 8 characters\")\n      .max(100, \"Password must be at most 100 characters\"),\n    confirmPassword: z.string().min(1, \"Please confirm your password\"),\n  })\n  .refine((data) => data.newPassword === data.confirmPassword, {\n    message: \"Passwords do not match\",\n    path: [\"confirmPassword\"],\n  });\n\ntype ResetPasswordFormData = z.infer<typeof resetPasswordSchema>;\n\nfunction ResetPasswordForm() {\n  const searchParams = useSearchParams();\n  const token = searchParams.get(\"token\");\n  const resetPasswordMutation = useResetPassword();\n  const [showPassword, setShowPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n\n  const form = useForm<ResetPasswordFormData>({\n    resolver: zodResolver(resetPasswordSchema),\n    defaultValues: {\n      token: token || \"\",\n      newPassword: \"\",\n      confirmPassword: \"\",\n    },\n  });\n\n  useEffect(() => {\n    if (!token) {\n      toast.error(\"Invalid or missing reset token\");\n    } else {\n      form.setValue(\"token\", token);\n    }\n  }, [token, form]);\n\n  const onSubmit = async (values: ResetPasswordFormData) => {\n    try {\n      await resetPasswordMutation.mutateAsync(values);\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    } catch (error) {\n      // Error handled by mutation hook\n    }\n  };\n\n  if (!token) {\n    return (\n      <div className=\"flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12 sm:px-6 lg:px-8\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader>\n            <CardTitle className=\"text-2xl\">Invalid Reset Link</CardTitle>\n            <CardDescription>\n              The password reset link is invalid or has expired.\n            </CardDescription>\n          </CardHeader>\n          <CardFooter>\n            <Button asChild className=\"w-full\">\n              <a href=\"/forgot-password\">Request New Link</a>\n            </Button>\n          </CardFooter>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12 sm:px-6 lg:px-8\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1\">\n          <CardTitle className=\"text-2xl\">Reset Password</CardTitle>\n          <CardDescription>Enter your new password below.</CardDescription>\n        </CardHeader>\n        <Form {...form}>\n          <form onSubmit={form.handleSubmit(onSubmit)}>\n            <CardContent className=\"space-y-4\">\n              <FormField\n                control={form.control}\n                name=\"newPassword\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>New Password</FormLabel>\n                    <FormControl>\n                      <div className=\"relative\">\n                        <Input\n                          type={showPassword ? \"text\" : \"password\"}\n                          placeholder=\"Enter new password\"\n                          {...field}\n                        />\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          className=\"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent\"\n                          onClick={() => setShowPassword(!showPassword)}\n                        >\n                          {showPassword ? (\n                            <EyeOff className=\"h-4 w-4\" />\n                          ) : (\n                            <Eye className=\"h-4 w-4\" />\n                          )}\n                        </Button>\n                      </div>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"confirmPassword\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Confirm Password</FormLabel>\n                    <FormControl>\n                      <div className=\"relative\">\n                        <Input\n                          type={showConfirmPassword ? \"text\" : \"password\"}\n                          placeholder=\"Confirm new password\"\n                          {...field}\n                        />\n                        <Button\n                          type=\"button\"\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          className=\"absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent\"\n                          onClick={() =>\n                            setShowConfirmPassword(!showConfirmPassword)\n                          }\n                        >\n                          {showConfirmPassword ? (\n                            <EyeOff className=\"h-4 w-4\" />\n                          ) : (\n                            <Eye className=\"h-4 w-4\" />\n                          )}\n                        </Button>\n                      </div>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n            <CardFooter>\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={resetPasswordMutation.isPending}\n              >\n                {resetPasswordMutation.isPending\n                  ? \"Resetting...\"\n                  : \"Reset Password\"}\n              </Button>\n            </CardFooter>\n          </form>\n        </Form>\n      </Card>\n    </div>\n  );\n}\n\nexport default function ResetPasswordPage() {\n  return (\n    <Suspense fallback={<div>Loading...</div>}>\n      <ResetPasswordForm />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\student\\attendance\\history\\page.tsx",
      "relative_path": "app/student/attendance/history/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 11118,
      "lines": 313,
      "last_modified": "2025-11-15T22:18:22.552833",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from \"next-intl\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { History, Loader2, BookOpen, Clock, CheckCircle, XCircle } from \"lucide-react\";\nimport { useStudentAttendanceHistory } from \"@/hooks/api/useStudentAttendanceHistory\";\nimport { useStudentSubjects } from \"@/hooks/api/useStudentSubjects\";\nimport { useGetSemesters } from \"@/hooks/api/useSemesters\";\nimport { useGetStudentProfile } from \"@/hooks/api/useStudentProfiles\";\nimport { getStudentId } from \"@/lib/auth\";\nimport { StudentAttendanceMatrix } from \"@/components/student/attendance/student-attendance-matrix\";\n\n/**\n * Student Attendance History Page (Matrix View)\n *\n * Features:\n * - Auto-select current semester\n * - Subject filter (cascade tá»« semester)\n * - Stats cards: Total Slots, Present, Absent (chá»‰ hiá»‡n khi cÃ³ subject)\n * - Attendance matrix: 1 row (student) Ã— N columns (slots)\n */\nexport default function StudentAttendanceHistoryPage() {\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const studentId = getStudentId();\n\n  // State\n  const [selectedSemester, setSelectedSemester] = useState<string>(\"\");\n  const [selectedSubject, setSelectedSubject] = useState<string>(\"\");\n\n  // Auto-select tracking\n  const hasAutoSelected = useRef(false);\n\n  // Fetch semesters\n  const { data: semestersData } = useGetSemesters({\n    isActive: true,\n    page: 1,\n    sort: \"desc\",\n    pageSize: 50,\n  });\n\n  // Calculate current semester\n  const currentSemester = useMemo(() => {\n    if (!semestersData?.items || semestersData.items.length === 0) return null;\n\n    const now = new Date();\n    return semestersData.items.find((s) => {\n      const start = new Date(s.startDate);\n      const end = new Date(s.endDate);\n      return now >= start && now <= end;\n    });\n  }, [semestersData]);\n\n  // Fetch student profile\n  const { data: studentProfile } = useGetStudentProfile(studentId!);\n\n  // Fetch subjects (enabled khi cÃ³ semester)\n  const { data: subjects, isLoading: isLoadingSubjects } = useStudentSubjects(\n    studentId!,\n    selectedSemester ? Number(selectedSemester) : undefined,\n    { enabled: !!studentId && !!selectedSemester }\n  );\n\n  // Fetch attendance history (enabled khi cÃ³ subject)\n  const { data: attendanceData, isLoading: isLoadingAttendance } = useStudentAttendanceHistory(\n    studentId!,\n    {\n      page: 1,\n      pageSize: 1000, // Fetch táº¥t cáº£ slots (no pagination)\n      sort: \"asc\",     // Sort by date ascending\n      semesterId: selectedSemester ? Number(selectedSemester) : undefined,\n      subjectId: selectedSubject ? Number(selectedSubject) : undefined,\n      attendanceType: \"all\",\n    },\n    { enabled: !!studentId && !!selectedSubject }\n  );\n\n  const t = useTranslations(\"student\");\n\n  // Set page header\n  useEffect(() => {\n    setPageHeader({\n      title: t(\"attendance_history\"),\n      subtitle: t(\"view_complete_attendance\"),\n      breadcrumbs: [{ label: t(\"attendance\") }, { label: t(\"attendance_history\") }],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader, t]);\n\n  // Auto-select current semester ONCE\n  useEffect(() => {\n    if (\n      !selectedSemester &&\n      currentSemester &&\n      semestersData?.items &&\n      semestersData.items.length > 0 &&\n      !hasAutoSelected.current\n    ) {\n      hasAutoSelected.current = true;\n      setSelectedSemester(currentSemester.id.toString());\n    }\n  }, [currentSemester, semestersData, selectedSemester]);\n\n  // Reset subject when semester changes\n  useEffect(() => {\n    if (selectedSemester) {\n      setSelectedSubject(\"\");\n    }\n  }, [selectedSemester]);\n\n  // Derived data\n  const semesters = semestersData?.items || [];\n  const summary = attendanceData?.summary;\n\n  // Memoize attendance records to prevent dependency warnings\n  const attendanceRecords = useMemo(() => {\n    return attendanceData?.items || [];\n  }, [attendanceData?.items]);\n\n  // Transform attendance records to matrix format\n  const attendanceRecordsBySlotId = useMemo(() => {\n    const recordsMap: Record<number, \"present\" | \"absent\" | \"not_yet\"> = {};\n    attendanceRecords.forEach((record) => {\n      // Map attendanceStatus to lowercase for consistency\n      const status =\n        record.attendanceStatus === \"present\"\n          ? \"present\"\n          : record.attendanceStatus === \"absent\"\n          ? \"absent\"\n          : \"not_yet\";\n      recordsMap[record.slotId] = status;\n    });\n    return recordsMap;\n  }, [attendanceRecords]);\n\n  // Extract slots DTO for matrix\n  const slotsForMatrix = useMemo(() => {\n    return attendanceRecords.map((record) => ({\n      slotId: record.slotId,\n      slotDate: record.slotDate,\n      slotTime: record.slotTime,\n      slotCategory: record.slotCategory as \"LECTURE\" | \"LECTURE_WITH_PT\" | \"FINAL_EXAM\",\n    }));\n  }, [attendanceRecords]);\n\n  // Student info (tá»« API)\n  const studentInfo = useMemo(() => {\n    if (!studentProfile) {\n      return {\n        rollNumber: \"\",\n        fullName: \"\",\n      };\n    }\n    return {\n      rollNumber: studentProfile.rollNumber,\n      fullName: studentProfile.fullName,\n    };\n  }, [studentProfile]);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Filters */}\n      <div className=\"flex flex-col sm:flex-row gap-2\">\n        {/* Semester Filter */}\n        <Select value={selectedSemester} onValueChange={setSelectedSemester}>\n          <SelectTrigger className=\"w-full sm:w-[200px]\">\n            <SelectValue placeholder={t(\"all_semesters\")} />\n          </SelectTrigger>\n          <SelectContent>\n            {semesters.map((semester) => (\n              <SelectItem key={semester.id} value={semester.id.toString()}>\n                {semester.code} - {semester.name}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n\n        {/* Subject Filter (disabled until semester selected) */}\n        <Select\n          value={selectedSubject}\n          onValueChange={setSelectedSubject}\n          disabled={!selectedSemester || isLoadingSubjects}\n        >\n          <SelectTrigger className=\"w-full sm:w-[250px]\">\n            <SelectValue placeholder={t(\"select_subject\")} />\n          </SelectTrigger>\n          <SelectContent>\n            {subjects && subjects.length > 0 ? (\n              subjects.map((subject) => (\n                <SelectItem key={subject.subjectId} value={subject.subjectId.toString()}>\n                  {subject.subjectCode} - {subject.subjectName} ({subject.classCode})\n                </SelectItem>\n              ))\n            ) : (\n              <SelectItem value=\"no-subjects\" disabled>\n                {isLoadingSubjects ? \"Loading subjects...\" : \"No subjects found\"}\n              </SelectItem>\n            )}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Empty State - No subject selected */}\n      {!selectedSubject && (\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-12\">\n              <History className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium mb-2\">{t(\"select_subject_to_view\")}</h3>\n              <p className=\"text-muted-foreground\">\n                {!selectedSemester\n                  ? t(\"please_select_semester_first\")\n                  : t(\"please_select_subject_to_view_attendance\")}\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Loading State */}\n      {selectedSubject && isLoadingAttendance && (\n        <div className=\"text-center py-12\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground mx-auto mb-4\" />\n          <p className=\"text-muted-foreground\">{t(\"loading_attendance_records\")}</p>\n        </div>\n      )}\n\n      {/* Content - Stats + Matrix */}\n      {selectedSubject && !isLoadingAttendance && summary && (\n        <>\n          {/* Stats Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            {/* Total Slots */}\n            <Card>\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Total Slots</p>\n                    <p className=\"text-2xl font-bold\">{summary.overall.totalSlots}</p>\n                  </div>\n                  <Clock className=\"h-8 w-8 text-blue-500\" />\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Present */}\n            <Card>\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Present</p>\n                    <p className=\"text-2xl font-bold text-green-600\">\n                      {summary.overall.presentCount}\n                    </p>\n                  </div>\n                  <CheckCircle className=\"h-8 w-8 text-green-500\" />\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Absent */}\n            <Card>\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-sm font-medium text-muted-foreground\">Absent</p>\n                    <p className=\"text-2xl font-bold text-red-600\">\n                      {summary.overall.absentCount}\n                    </p>\n                  </div>\n                  <XCircle className=\"h-8 w-8 text-red-500\" />\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Attendance Matrix */}\n          <StudentAttendanceMatrix\n            slots={slotsForMatrix}\n            attendanceRecords={attendanceRecordsBySlotId}\n            studentInfo={studentInfo}\n          />\n        </>\n      )}\n\n      {/* Empty State - No records */}\n      {selectedSubject && !isLoadingAttendance && (!attendanceRecords || attendanceRecords.length === 0) && (\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center py-12\">\n              <BookOpen className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium mb-2\">{t(\"no_records_found\")}</h3>\n              <p className=\"text-muted-foreground\">\n                {t(\"no_attendance_records_for_subject\")}\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\student\\dashboard\\page.tsx",
      "relative_path": "app/student/dashboard/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 20024,
      "lines": 494,
      "last_modified": "2025-11-19T16:57:53.296888",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useMemo, useRef } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from 'next-intl';\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  BookOpen,\n  Calendar,\n  Loader2,\n  GraduationCap,\n  AlertCircle,\n  ClipboardList,\n} from \"lucide-react\";\nimport { useStudentDashboard } from \"@/hooks/api/useStudentDashboard\";\nimport { useStudentRecentAttendance } from \"@/hooks/api/useStudentRecentAttendance\";\nimport { format } from \"date-fns\";\nimport { Separator } from \"@/components/ui/separator\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Accordion,\n  AccordionContent,\n  AccordionItem,\n  AccordionTrigger,\n} from \"@/components/ui/accordion\";\n\nexport default function StudentDashboard() {\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const t = useTranslations('dashboard');\n  const tStudent = useTranslations('student');\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n\n  // Get semester from URL or use default\n  const semesterIdParam = searchParams.get(\"semesterId\");\n  const selectedSemesterId = semesterIdParam\n    ? Number(semesterIdParam)\n    : undefined;\n\n  // Fetch dashboard data\n  const { data, isLoading } = useStudentDashboard(selectedSemesterId);\n  const { data: recentAttendance, isLoading: isLoadingAttendance } = useStudentRecentAttendance(10);\n\n  // Track if auto-select has been done to prevent re-triggering when user clears filter\n  const hasAutoSelected = useRef(false);\n\n  // Update URL when semester changes\n  const updateSemester = (semesterId: string) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n    if (semesterId === \"all\") {\n      newParams.delete(\"semesterId\");\n    } else {\n      newParams.set(\"semesterId\", semesterId);\n    }\n    router.push(`${pathname}?${newParams.toString()}`, { scroll: false });\n  };\n\n  useEffect(() => {\n    setPageHeader({\n      title: t('title'),\n      subtitle: t('welcome'),\n      breadcrumbs: [{ label: t('title') }],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader, t]);\n\n  // Memoize semesters to prevent unnecessary re-renders\n  const semesters = useMemo(() => (data as any)?.semesters || [], [data]);\n\n  // Calculate current semester (start_date <= now <= end_date)\n  const currentSemester = useMemo(() => {\n    if (!semesters || semesters.length === 0) return null;\n\n    const now = new Date();\n    return semesters.find((s: any) => {\n      const start = new Date(s.startDate);\n      const end = new Date(s.endDate);\n      return now >= start && now <= end;\n    });\n  }, [semesters]);\n\n  // Auto-select current semester ONLY ONCE on initial load if no semester filter is set\n  useEffect(() => {\n    if (!semesterIdParam && currentSemester && !isLoading && !hasAutoSelected.current) {\n      hasAutoSelected.current = true;\n      updateSemester(currentSemester.id.toString());\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [currentSemester, semesterIdParam, isLoading]);\n\n  // Reset hasAutoSelected on unmount to allow auto-selection on next mount\n  useEffect(() => {\n    return () => {\n      hasAutoSelected.current = false;\n    };\n  }, []);\n\n  const formatDateTime = (dateString: string) => {\n    try {\n      const date = new Date(dateString);\n      return {\n        date: format(date, \"MMM dd, yyyy\"),\n        dateShort: format(date, \"dd/MM/yy\"),\n        time: format(date, \"HH:mm\"),\n      };\n    } catch {\n      return { date: \"N/A\", dateShort: \"N/A\", time: \"N/A\" };\n    }\n  };\n\n  const getCategoryBadge = (category: string) => {\n    switch (category) {\n      case \"LECTURE\":\n        return <Badge variant=\"outline\">{tStudent('lecture')}</Badge>;\n      case \"LECTURE_WITH_PT\":\n        return <Badge variant=\"outline\">{tStudent('lecture_with_pt')}</Badge>;\n      case \"FINAL_EXAM\":\n        return <Badge variant=\"outline\">{tStudent('final_exam')}</Badge>;\n      default:\n        return <Badge variant=\"outline\">{category}</Badge>;\n    }\n  };\n\n  const getAttendanceStatusBadge = (status: string | null) => {\n    if (!status) return <Badge variant=\"secondary\">Not Yet</Badge>;\n\n    switch (status) {\n      case \"present\":\n        return <Badge variant=\"default\" className=\"bg-green-500\">Present</Badge>;\n      case \"absent\":\n        return <Badge variant=\"destructive\">Absent</Badge>;\n      case \"not_yet\":\n        return <Badge variant=\"secondary\">Not Yet</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  const renderSlotCard = (slot: any, showCategory: boolean = true) => {\n    const startDateTime = formatDateTime(slot.startTime);\n    const endDateTime = formatDateTime(slot.endTime);\n\n    return (\n      <Card key={slot.id}>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex items-start gap-4\">\n            <div className=\"flex-shrink-0\">\n              <div className=\"h-12 w-12 rounded-lg bg-muted flex items-center justify-center\">\n                {slot.slotCategory === \"FINAL_EXAM\" ? (\n                  <GraduationCap className=\"h-6 w-6 text-muted-foreground\" />\n                ) : (\n                  <BookOpen className=\"h-6 w-6 text-muted-foreground\" />\n                )}\n              </div>\n            </div>\n\n            <div className=\"flex-1 min-w-0\">\n              <div className=\"flex items-start justify-between gap-2 mb-3\">\n                <div className=\"flex-1\">\n                  <h4 className=\"font-semibold text-base mb-1\">{slot.title || slot.subjectName}</h4>\n                  {showCategory && getCategoryBadge(slot.slotCategory)}\n                </div>\n              </div>\n\n              <div className=\"space-y-2 text-sm\">\n                {slot.classCode && (\n                  <div className=\"flex items-start gap-2\">\n                    <span className=\"font-medium text-muted-foreground min-w-[60px]\">Class:</span>\n                    <span className=\"text-foreground\">{slot.classCode}</span>\n                  </div>\n                )}\n                <div className=\"flex items-start gap-2\">\n                  <span className=\"font-medium text-muted-foreground min-w-[60px]\">Subject:</span>\n                  <span className=\"text-foreground\">{slot.subjectCode} - {slot.subjectName}</span>\n                </div>\n                <div className=\"flex items-start gap-2\">\n                  <span className=\"font-medium text-muted-foreground min-w-[60px]\">Room:</span>\n                  <span className=\"text-foreground\">{slot.roomName}</span>\n                </div>\n                <div className=\"flex items-start gap-2\">\n                  <span className=\"font-medium text-muted-foreground min-w-[60px]\">Date:</span>\n                  <span className=\"text-foreground\">{startDateTime.dateShort}</span>\n                </div>\n                <div className=\"flex items-start gap-2\">\n                  <span className=\"font-medium text-muted-foreground min-w-[60px]\">Time:</span>\n                  <span className=\"text-foreground\">{startDateTime.time} - {endDateTime.time}</span>\n                </div>\n                {slot.staffName && (\n                  <div className=\"flex items-start gap-2\">\n                    <span className=\"font-medium text-muted-foreground min-w-[60px]\">Lecturer:</span>\n                    <span className=\"text-foreground\">{slot.staffName}</span>\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  // Group subjects by semester for \"All Semesters\" mode\n  const groupedSubjects = useMemo(() => {\n    if (!data || !semesters || selectedSemesterId !== undefined) {\n      return {};\n    }\n\n    const grouped: Record<number, { semester: any; subjects: any[] }> = {};\n\n    const currentSemesterSubjects = (data as any)?.currentSemesterSubjects || [];\n    currentSemesterSubjects.forEach((subject: any) => {\n      const semesterId = subject.semesterId as number;\n      if (!grouped[semesterId]) {\n        const semester = semesters.find((s: any) => s.id === semesterId);\n        grouped[semesterId] = {\n          semester: semester || { id: semesterId, name: 'Unknown', code: 'N/A' },\n          subjects: [],\n        };\n      }\n      grouped[semesterId].subjects.push(subject);\n    });\n\n    return grouped;\n  }, [data, semesters, selectedSemesterId]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (!data) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <AlertCircle className=\"h-8 w-8 text-muted-foreground\" />\n        <p className=\"ml-2 text-muted-foreground\">Failed to load dashboard data</p>\n      </div>\n    );\n  }\n\n  const isAllSemesters = selectedSemesterId === undefined;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Semester Filter */}\n      <div className=\"flex items-center justify-between\">\n        <h3 className=\"text-lg font-semibold\">{t('semester_filter')}</h3>\n        <Select\n          value={selectedSemesterId?.toString() || \"all\"}\n          onValueChange={updateSemester}\n          disabled={isLoading}\n        >\n          <SelectTrigger className=\"w-[250px]\">\n            <SelectValue placeholder={t('select_semester')} />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">{t('all_semesters')}</SelectItem>\n            {semesters.map((semester: any) => (\n              <SelectItem key={semester.id} value={semester.id.toString()}>\n                {semester.name} ({semester.code})\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      <Separator />\n\n      {/* My Subjects */}\n      <div>\n        <h3 className=\"text-lg font-semibold mb-4\">{t('my_subjects')}</h3>\n        {((data as any)?.currentSemesterSubjects || []).length === 0 ? (\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"text-center py-8\">\n                <BookOpen className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                <p className=\"text-muted-foreground\">{t('no_classes_enrolled')}</p>\n                <p className=\"text-sm text-muted-foreground mt-2\">{t('no_subjects_enrolled_desc')}</p>\n              </div>\n            </CardContent>\n          </Card>\n        ) : isAllSemesters ? (\n          Object.keys(groupedSubjects).length === 0 ? (\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"text-center py-8\">\n                  <BookOpen className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                  <p className=\"text-muted-foreground\">{t('no_classes_enrolled')}</p>\n                  <p className=\"text-sm text-muted-foreground mt-2\">{t('no_subjects_enrolled_desc')}</p>\n                </div>\n              </CardContent>\n            </Card>\n          ) : (\n            <Accordion type=\"single\" collapsible className=\"space-y-2\" defaultValue={Object.keys(groupedSubjects)[0]}>\n              {Object.entries(groupedSubjects).map(([semesterIdStr, { semester, subjects }]) => (\n                <AccordionItem\n                  key={semesterIdStr}\n                  value={semesterIdStr}\n                  className=\"border rounded-lg\"\n                >\n                  <AccordionTrigger className=\"px-4 hover:no-underline\">\n                    <div className=\"flex items-center justify-between w-full pr-4\">\n                      <div className=\"flex items-center gap-3\">\n                        <h3 className=\"text-lg font-semibold\">\n                          {semester.code} - {semester.name}\n                        </h3>\n                        <Badge variant=\"outline\">\n                          {subjects.length} {subjects.length === 1 ? 'subject' : 'subjects'}\n                        </Badge>\n                      </div>\n                    </div>\n                  </AccordionTrigger>\n                  <AccordionContent className=\"px-4 pb-6\">\n                    <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3 pt-4\">\n                      {subjects.map((subject: any) => (\n                        <Card key={subject.subjectId}>\n                          <CardHeader className=\"pb-3\">\n                            <div className=\"flex items-start justify-between\">\n                              <div className=\"flex-1\">\n                                <CardTitle className=\"text-base\">{subject.subjectCode}</CardTitle>\n                                <p className=\"text-sm text-muted-foreground mt-1\">\n                                  {subject.subjectName}\n                                </p>\n                              </div>\n                              <BookOpen className=\"h-4 w-4 text-muted-foreground\" />\n                            </div>\n                          </CardHeader>\n                          <CardContent>\n                            <div className=\"text-sm text-muted-foreground\">\n                              {t('class')}: {subject.classCode}\n                            </div>\n                          </CardContent>\n                        </Card>\n                      ))}\n                    </div>\n                  </AccordionContent>\n                </AccordionItem>\n              ))}\n            </Accordion>\n          )\n        ) : (\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n            {((data as any)?.currentSemesterSubjects || []).map((subject: any) => (\n              <Card key={subject.subjectId}>\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <CardTitle className=\"text-base\">{subject.subjectCode}</CardTitle>\n                      <p className=\"text-sm text-muted-foreground mt-1\">\n                        {subject.subjectName}\n                      </p>\n                    </div>\n                    <BookOpen className=\"h-4 w-4 text-muted-foreground\" />\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-sm text-muted-foreground\">\n                    {t('class')}: {subject.classCode}\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n\n      <Separator />\n\n      {/* Next Day Slots (Tomorrow) */}\n      <div>\n        <h3 className=\"text-lg font-semibold mb-4\">{t('next_day_slots')}</h3>\n        {((data as any)?.nextDaySlots || []).length === 0 ? (\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"text-center py-8\">\n                <Calendar className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                <p className=\"text-muted-foreground\">{t('no_next_day_slots')}</p>\n                <p className=\"text-sm text-muted-foreground mt-2\">{t('no_next_day_slots_desc')}</p>\n              </div>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-3\">\n            {((data as any)?.nextDaySlots || []).map((slot: any) => renderSlotCard(slot))}\n          </div>\n        )}\n      </div>\n\n      <Separator />\n\n      {/* Upcoming Exam Slots */}\n      <div>\n        <h3 className=\"text-lg font-semibold mb-4\">{t('upcoming_exams')}</h3>\n        {((data as any)?.upcomingExamSlots || []).length === 0 ? (\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"text-center py-8\">\n                <GraduationCap className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                <p className=\"text-muted-foreground\">{t('no_upcoming_exams')}</p>\n                <p className=\"text-sm text-muted-foreground mt-2\">{t('no_upcoming_exams_desc')}</p>\n              </div>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-3\">\n            {((data as any)?.upcomingExamSlots || []).map((slot: any) => renderSlotCard(slot))}\n          </div>\n        )}\n      </div>\n\n      <Separator />\n\n      {/* Recent Attendance */}\n      <div>\n        <h3 className=\"text-lg font-semibold mb-4\">{t('recent_attendance')}</h3>\n        {isLoadingAttendance ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"h-4 w-4 animate-spin text-muted-foreground mr-2\" />\n            <span className=\"text-sm text-muted-foreground\">Loading recent attendance...</span>\n          </div>\n        ) : !recentAttendance || recentAttendance.length === 0 ? (\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"text-center py-8\">\n                <ClipboardList className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                <p className=\"text-muted-foreground\">{t('no_recent_attendance')}</p>\n                <p className=\"text-sm text-muted-foreground mt-2\">{t('no_recent_attendance_desc')}</p>\n              </div>\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-3\">\n            {recentAttendance.map((record) => {\n              const slotDateTime = formatDateTime(record.slotDate);\n\n              return (\n                <Card key={`${record.recordId}-${record.slotId}-${record.recordType}`}>\n                  <CardContent className=\"py-4\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"flex-shrink-0\">\n                        <div className=\"h-10 w-10 rounded-lg bg-muted flex items-center justify-center\">\n                          <ClipboardList className=\"h-5 w-5 text-muted-foreground\" />\n                        </div>\n                      </div>\n\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"flex items-center justify-between gap-2 mb-1\">\n                          <h4 className=\"font-medium text-sm truncate\">{record.subjectName}</h4>\n                          <div className=\"flex gap-1.5 flex-shrink-0\">\n                            {getCategoryBadge(record.slotCategory)}\n                            {getAttendanceStatusBadge(record.attendanceStatus)}\n                          </div>\n                        </div>\n\n                        <div className=\"flex items-center gap-4 text-xs text-muted-foreground flex-wrap\">\n                          {record.className && (\n                            <span>{record.className}</span>\n                          )}\n                          <span>{slotDateTime.dateShort}</span>\n                          <span>{record.slotTime}</span>\n                          <span>{record.roomName}</span>\n                        </div>\n\n                        {record.remark && (\n                          <div className=\"mt-1.5 text-xs text-muted-foreground italic truncate\">\n                            {record.remark}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              );\n            })}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\student\\layout.tsx",
      "relative_path": "app/student/layout.tsx",
      "filename": "layout.tsx",
      "size_bytes": 1814,
      "lines": 51,
      "last_modified": "2025-11-01T15:38:43.277938",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { AppSidebar } from \"@/components/shared/app-sidebar\";\nimport { MobileSidebar } from \"@/components/shared/mobile-sidebar\";\nimport { AppHeader } from \"@/components/shared/app-header\";\nimport { SidebarProvider } from \"@/components/shared/sidebar-context\";\nimport { PageHeaderProvider } from \"@/components/shared/page-header-context\";\nimport { RoleBasedRouteGuard } from \"@/components/auth/role-based-route-guard\";\nimport { studentMenu } from \"@/lib/menu-configs/student-menu\";\n\n/**\n * Student Portal Layout\n *\n * Shared layout for all student pages.\n * Uses the studentMenu configuration for navigation.\n * Protected by StudentRouteGuard to ensure only STUDENT role can access.\n *\n * Pages under /student/* will use this layout automatically.\n */\nexport default function StudentLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <RoleBasedRouteGuard allowedRoles={[\"STUDENT\"]}>\n      <SidebarProvider>\n        <PageHeaderProvider>\n          <div className=\"flex h-screen overflow-hidden\">\n            {/* Desktop Sidebar (hidden on mobile) */}\n            <AppSidebar menuConfig={studentMenu} className=\"hidden lg:flex\" />\n\n            {/* Mobile Sidebar (Sheet overlay) */}\n            <MobileSidebar menuConfig={studentMenu} />\n\n            {/* Main Content Area */}\n            <div className=\"flex flex-1 flex-col overflow-hidden\">\n              {/* Header */}\n              <AppHeader />\n\n              {/* Page Content - Responsive padding */}\n              <main className=\"flex-1 overflow-y-auto overflow-x-hidden bg-muted/10 p-4 md:p-6\">\n                {children}\n              </main>\n            </div>\n          </div>\n        </PageHeaderProvider>\n      </SidebarProvider>\n    </RoleBasedRouteGuard>\n  );\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\student\\profile\\page.tsx",
      "relative_path": "app/student/profile/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 9034,
      "lines": 266,
      "last_modified": "2025-11-13T21:14:04.090641",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from 'next-intl';\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  User,\n  Camera,\n  Loader2,\n  Shield,\n} from \"lucide-react\";\nimport { useGetStudentProfile } from \"@/hooks/api/useStudentProfiles\";\nimport { getStudentId } from \"@/lib/auth\";\nimport { evidenceToAbsoluteUrl } from \"@/lib/utils\";\nimport { ChangePasswordDialog } from \"@/components/shared/change-password-dialog\";\n\n/**\n * Student Profile Page\n *\n * Displays student profile information from API:\n * - Personal information\n * - Academic information\n * - Contact details\n * - Profile picture\n */\nexport default function StudentProfilePage() {\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n  const [isEditing] = useState(false);\n  const [selectedTab, setSelectedTab] = useState(\"personal\");\n\n  // Get current student ID\n  const studentId = getStudentId();\n\n  // Fetch student profile data (only if studentId exists)\n  const {\n    data: studentProfile,\n    isLoading,\n    error,\n  } = useGetStudentProfile(studentId || 0);\n\n  const t = useTranslations('profile');\n\n  useEffect(() => {\n    setPageHeader({\n      title: t('profile'),\n      subtitle: t('view_personal_academic'),\n      breadcrumbs: [{ label: t('account') }, { label: t('profile') }],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader, t]);\n\n  // Check if student ID is available\n  if (!studentId) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"text-center\">\n          <p className=\"text-destructive mb-2\">{t('auth_error')}</p>\n          <p className=\"text-sm text-muted-foreground\">\n            {t('unable_identify_student')}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Loading state\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"flex items-center gap-2\">\n          <Loader2 className=\"h-6 w-6 animate-spin\" />\n          <span>{t('loading_profile')}</span>\n        </div>\n      </div>\n    );\n  }\n\n  // Error state\n  if (error || !studentProfile) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"text-center\">\n          <p className=\"text-destructive mb-2\">{t('failed_load_profile')}</p>\n          <p className=\"text-sm text-muted-foreground\">\n            {error?.message || t('profile_not_found')}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Profile Header */}\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-start gap-6\">\n            <div className=\"relative\">\n              <Avatar className=\"h-24 w-24\">\n                <AvatarImage\n                  src={evidenceToAbsoluteUrl(studentProfile.photoUrl) ?? undefined}\n                  alt={studentProfile.fullName}\n                />\n                <AvatarFallback className=\"text-lg\">\n                  {studentProfile.fullName\n                    .split(\" \")\n                    .map((n) => n[0])\n                    .join(\"\")}\n                </AvatarFallback>\n              </Avatar>\n              {isEditing && (\n                <Button\n                  size=\"sm\"\n                  variant=\"outline\"\n                  className=\"absolute -bottom-2 -right-2 h-8 w-8 rounded-full p-0\"\n                  disabled\n                  title=\"Profile picture editing not available\"\n                >\n                  <Camera className=\"h-4 w-4\" />\n                </Button>\n              )}\n            </div>\n\n            <div className=\"flex-1\">\n              <div className=\"flex items-start justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold\">\n                    {studentProfile.fullName}\n                  </h2>\n                  <p className=\"text-muted-foreground\">\n                    {studentProfile.rollNumber}\n                  </p>\n                  <div className=\"flex items-center gap-2 mt-2\">\n                    <Badge variant=\"default\">{studentProfile.major.code}</Badge>\n                    <Badge variant=\"outline\">{studentProfile.major.name}</Badge>\n                  </div>\n                </div>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mt-3 max-w-2xl\">\n                {t('profile_managed_by_admin')}\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Profile Details */}\n      <Tabs value={selectedTab} onValueChange={setSelectedTab}>\n        <TabsList className=\"grid w-full grid-cols-2\">\n          <TabsTrigger value=\"personal\">{t('personal_info')}</TabsTrigger>\n          <TabsTrigger value=\"security\">{t('security')}</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"personal\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <User className=\"h-5 w-5\" />\n                {t('personal_information')}\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"fullName\">{t('full_name')}</Label>\n                  <Input\n                    id=\"fullName\"\n                    value={studentProfile.fullName}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"rollNumber\">{t('roll_number')}</Label>\n                  <Input\n                    id=\"rollNumber\"\n                    value={studentProfile.rollNumber}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"username\">{t('username')}</Label>\n                  <Input\n                    id=\"username\"\n                    value={studentProfile.username}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">{t('email_address')}</Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    value={studentProfile.email}\n                    disabled\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"createdAt\">{t('account_created')}</Label>\n                  <Input\n                    id=\"createdAt\"\n                    value={new Date(\n                      studentProfile.createdAt\n                    ).toLocaleDateString()}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"updatedAt\">{t('last_updated')}</Label>\n                  <Input\n                    id=\"updatedAt\"\n                    value={new Date(\n                      studentProfile.updatedAt\n                    ).toLocaleDateString()}\n                    disabled\n                  />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"security\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Shield className=\"h-5 w-5\" />\n                {t('security_settings')}\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"space-y-4\">\n                <div>\n                  <h4 className=\"font-medium mb-2\">{t('password')}</h4>\n                  <p className=\"text-sm text-muted-foreground mb-4\">\n                    {t('change_password')}\n                  </p>\n                  <ChangePasswordDialog userId={studentProfile.userId} />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\student\\schedule\\page.tsx",
      "relative_path": "app/student/schedule/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 5741,
      "lines": 182,
      "last_modified": "2025-11-16T12:25:01.491967",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useState, useEffect } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from 'next-intl';\nimport { getWeekRange, getPreviousWeek, getNextWeek } from \"@/lib/calendar-utils\";\nimport { format, parseISO } from \"date-fns\";\nimport { StudentScheduleHeader } from \"@/components/student/schedule/student-schedule-header\";\nimport { StudentCalendarWeekContainer } from \"@/components/student/schedule/student-calendar-week-container\";\nimport { StudentSlotDetailDialog } from \"@/components/student/schedule/student-slot-detail-dialog\";\nimport { useGetStudentSlots } from \"@/hooks/api/useStudentProfiles\";\nimport { getStudentId } from \"@/lib/auth\";\nimport { Slot } from \"@/types\";\nimport { getVietnamNow } from \"@/lib/timezone-utils\";\n\n\n\nfunction StudentSchedulePageContent() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // 1. EXTRACT URL STATE\n  const dateParam = searchParams.get(\"date\") || format(getVietnamNow(), \"yyyy-MM-dd\");\n\n  // 2. LOCAL STATE\n  const [referenceDate, setReferenceDate] = useState<Date>(parseISO(dateParam));\n  const [selectedSlot, setSelectedSlot] = useState<Slot | null>(null);\n\n  // Sync reference date with URL param\n  useEffect(() => {\n    try {\n      setReferenceDate(parseISO(dateParam));\n    } catch {\n      setReferenceDate(getVietnamNow());\n    }\n  }, [dateParam]);\n\n  const t = useTranslations('student');\n\n  // Set page header\n  useEffect(() => {\n    setPageHeader({\n      breadcrumbs: [\n        { label: t('schedule_classes') },\n        { label: t('class_schedule') },\n      ],\n      title: t('class_schedule'),\n      subtitle: t('view_weekly_schedule'),\n    });\n\n    return () => clearPageHeader();\n  }, [setPageHeader, clearPageHeader, t]);\n\n  // 3. CALCULATE DATE RANGE (Week only)\n  const weekRange = getWeekRange(referenceDate);\n\n  // 4. URL UPDATE HELPER\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        newParams.set(key, String(value));\n      } else {\n        newParams.delete(key);\n      }\n    });\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  // Get current student ID from auth\n  const currentStudentId = getStudentId();\n\n  // 5. FETCH DATA FROM API - MUST BE BEFORE ANY CONDITIONAL RETURNS\n  // Fetch slots (for current student, all slot categories)\n  const apiParams = {\n    page: 1,\n    pageSize: 100,\n    slotCategories: [\"LECTURE\", \"LECTURE_WITH_PT\", \"FINAL_EXAM\"] as const, // Student sees all categories\n    studentUserId: currentStudentId || 0,\n    isActive: true,\n    startTimeFrom: format(weekRange.startDate, \"yyyy-MM-dd\"),\n    startTimeTo: format(weekRange.endDate, \"yyyy-MM-dd\"),\n  };\n\n  const { data: slotsData, isLoading: isSlotsLoading } = useGetStudentSlots(currentStudentId || 0, apiParams);\n\n  // Check if student ID is available AFTER all hooks\n  if (!currentStudentId) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"text-center\">\n          <p className=\"text-destructive mb-2\">Authentication Error</p>\n          <p className=\"text-sm text-muted-foreground\">\n            Unable to identify student. Please log in again.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Extract data with fallbacks\n  const slots = slotsData?.items || [];\n  const isLoading = isSlotsLoading;\n\n  // 6. EVENT HANDLERS\n  const handlePrevious = () => {\n    const newDate = getPreviousWeek(referenceDate);\n    updateURL({ date: format(newDate, \"yyyy-MM-dd\") });\n  };\n\n  const handleNext = () => {\n    const newDate = getNextWeek(referenceDate);\n    updateURL({ date: format(newDate, \"yyyy-MM-dd\") });\n  };\n\n  const handleToday = () => {\n    updateURL({ date: format(getVietnamNow(), \"yyyy-MM-dd\") });\n  };\n\n  const handleSlotClick = (slot: Slot) => {\n    setSelectedSlot(slot);\n  };\n\n  // 7. RENDER\n  return (\n    <div className=\"space-y-4 p-6\">\n      {/* Calendar Header */}\n      <StudentScheduleHeader\n        dateRange={{\n          mondayDate: weekRange.mondayDate,\n          sundayDate: weekRange.sundayDate,\n        }}\n        onPrevious={handlePrevious}\n        onNext={handleNext}\n        onToday={handleToday}\n      />\n\n      {/* Calendar Week View */}\n      <StudentCalendarWeekContainer\n        mondayDate={weekRange.mondayDate}\n        slots={slots}\n        isLoading={isLoading}\n        onSlotClick={handleSlotClick}\n      />\n\n      {/* Slot Detail Dialog */}\n      <StudentSlotDetailDialog\n        slot={selectedSlot}\n        open={!!selectedSlot}\n        onOpenChange={(open: boolean) => !open && setSelectedSlot(null)}\n      />\n    </div>\n  );\n}\n\n/**\n * Student Schedule Page\n *\n * Displays the student's class schedule with:\n * - Weekly calendar view (similar to lecturer)\n * - Class and exam slots\n * - Detailed slot information\n */\nexport default function StudentSchedulePage() {\n  return (\n    <Suspense\n      fallback={\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <div className=\"text-muted-foreground\">Loading schedule...</div>\n        </div>\n      }\n    >\n      <StudentSchedulePageContent />\n    </Suspense>\n  );\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\supervisor\\dashboard\\page.tsx",
      "relative_path": "app/supervisor/dashboard/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 17469,
      "lines": 413,
      "last_modified": "2025-11-19T16:57:23.266326",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useMemo, useRef } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Users,\n  Calendar,\n  CheckCircle2,\n  TrendingUp,\n  Clock,\n  Loader2,\n  AlertCircle,\n  ClipboardCheck,\n} from \"lucide-react\";\nimport { useSupervisorDashboard } from \"@/hooks/api/useSupervisorDashboard\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { useTranslations } from 'next-intl';\nimport { parseVietnamTime, formatVietnamTime } from \"@/lib/timezone-utils\";\n\nexport default function SupervisorDashboardPage() {\n  const t = useTranslations('supervisor');\n  const tCommon = useTranslations('common');\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n\n  // Get semester from URL or use default\n  const semesterIdParam = searchParams.get(\"semesterId\");\n  const selectedSemesterId = semesterIdParam\n    ? Number(semesterIdParam)\n    : undefined;\n\n  // Fetch dashboard data\n  const { data, isLoading, error } = useSupervisorDashboard(selectedSemesterId);\n\n  // Update URL when semester changes\n  const updateSemester = (semesterId: string) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n    if (semesterId === \"all\") {\n      newParams.delete(\"semesterId\");\n    } else {\n      newParams.set(\"semesterId\", semesterId);\n    }\n    router.push(`${pathname}?${newParams.toString()}`, { scroll: false });\n  };\n\n  const stats = data?.stats;\n\n  // Memoize semesters to prevent unnecessary re-renders\n  const semesters = useMemo(() => data?.semesters || [], [data?.semesters]);\n\n  // Track if auto-select has been done to prevent re-triggering when user clears filter\n  const hasAutoSelected = useRef(false);\n\n  // Calculate current semester (start_date <= now <= end_date)\n  const currentSemester = useMemo(() => {\n    if (!semesters || semesters.length === 0) return null;\n\n    const now = new Date();\n    return semesters.find((s: any) => {\n      const start = new Date(s.startDate);\n      const end = new Date(s.endDate);\n      return now >= start && now <= end;\n    });\n  }, [semesters]);\n\n  // Auto-select current semester ONLY ONCE on initial load if no semester filter is set\n  useEffect(() => {\n    if (!semesterIdParam && currentSemester && !isLoading && !hasAutoSelected.current) {\n      hasAutoSelected.current = true;\n      updateSemester(currentSemester.id.toString());\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [currentSemester, semesterIdParam, isLoading]);\n\n  // Reset hasAutoSelected on unmount to allow auto-selection on next mount\n  useEffect(() => {\n    return () => {\n      hasAutoSelected.current = false;\n    };\n  }, []);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <div className=\"text-center\">\n          <AlertCircle className=\"h-12 w-12 text-destructive mx-auto mb-4\" />\n          <p className=\"text-destructive mb-2\">Failed to load dashboard</p>\n          <p className=\"text-sm text-muted-foreground\">{error.message}</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!data) {\n    return (\n      <div className=\"flex items-center justify-center py-12\">\n        <div className=\"text-center\">\n          <AlertCircle className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n          <p className=\"text-muted-foreground\">No data available</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Page Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold tracking-tight\">Dashboard</h2>\n          <p className=\"text-muted-foreground\">\n            Supervisor overview and exam management\n          </p>\n        </div>\n        <Select\n          value={selectedSemesterId?.toString() || \"all\"}\n          onValueChange={updateSemester}\n          disabled={isLoading}\n        >\n          <SelectTrigger className=\"w-[200px]\">\n            <SelectValue placeholder={t('select_semester')} />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"all\">{t('all_semesters')}</SelectItem>\n            {semesters.map((semester) => (\n              <SelectItem key={semester.id} value={semester.id.toString()}>\n                {semester.code} - {semester.name}\n              </SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n\n      {/* Exam Supervision Stats */}\n      {stats && (\n        <>\n          <div>\n            <h3 className=\"text-lg font-semibold mb-4\">{t('my_supervision')}</h3>\n            <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-5\">\n              {/* Total Exam Slots */}\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">\n                    {t('total_exam_slots')}\n                  </CardTitle>\n                  <ClipboardCheck className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{stats.totalExamSlots}</div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {t('exam_slots_supervised')}\n                  </p>\n                </CardContent>\n              </Card>\n\n              {/* Completed Exams */}\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">\n                    {t('completed_exams')}\n                  </CardTitle>\n                  <CheckCircle2 className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">\n                    {stats.completedSlots}\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {stats.totalExamSlots > 0\n                      ? `${Math.round((stats.completedSlots / stats.totalExamSlots) * 100)}% ${tCommon('completed')}`\n                      : t('no_exams_yet')}\n                  </p>\n                </CardContent>\n              </Card>\n\n              {/* Upcoming Exams */}\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">\n                    {t('upcoming_exams')}\n                  </CardTitle>\n                  <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{stats.upcomingSlots}</div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {t('scheduled_exams')}\n                  </p>\n                </CardContent>\n              </Card>\n\n              {/* Exam Attendance Rate */}\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">\n                    {t('exam_attendance_rate')}\n                  </CardTitle>\n                  <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">\n                    {Math.round(stats.examAttendanceRate)}%\n                  </div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {t('average_attendance')}\n                  </p>\n                </CardContent>\n              </Card>\n\n              {/* Total Exam Participants */}\n              <Card>\n                <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n                  <CardTitle className=\"text-sm font-medium\">\n                    {t('exam_participants')}\n                  </CardTitle>\n                  <Users className=\"h-4 w-4 text-muted-foreground\" />\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold\">{stats.totalExamParticipants}</div>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {t('students_supervised')}\n                  </p>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n\n          <Separator />\n        </>\n      )}\n\n      {/* Upcoming Exams */}\n      {data?.upcomingExams && data.upcomingExams.length > 0 && (\n        <>\n          <div>\n            <h3 className=\"text-lg font-semibold mb-4\">{t('upcoming_exams')}</h3>\n            <div className=\"grid gap-4\">\n              {data.upcomingExams.map((slot: any) => (\n                <Card key={slot.id}>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"space-y-1\">\n                        <div className=\"flex items-center gap-2\">\n                          <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                          <span className=\"font-medium\">\n                            {formatVietnamTime(parseVietnamTime(slot.startTime), 'dd/MM/yy')}\n                          </span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                          <span className=\"text-sm text-muted-foreground\">\n                            {formatVietnamTime(parseVietnamTime(slot.startTime), 'HH:mm')}\n                            {' - '}\n                            {formatVietnamTime(parseVietnamTime(slot.endTime), 'HH:mm')}\n                          </span>\n                        </div>\n                        {slot.room && (\n                          <div className=\"text-sm text-muted-foreground\">\n                            {t('room')}: {slot.room.name}\n                          </div>\n                        )}\n                        {slot.subjects && slot.subjects.length > 0 && (\n                          <div className=\"flex flex-wrap gap-1 mt-1\">\n                            <TooltipProvider>\n                              {slot.subjects.map((subject: any) => (\n                                <Tooltip key={subject.id}>\n                                  <TooltipTrigger asChild>\n                                    <Badge variant=\"secondary\" className=\"cursor-default\">\n                                      {subject.code}\n                                    </Badge>\n                                  </TooltipTrigger>\n                                  <TooltipContent>\n                                    <p>{subject.name}</p>\n                                  </TooltipContent>\n                                </Tooltip>\n                              ))}\n                            </TooltipProvider>\n                          </div>\n                        )}\n                      </div>\n                      <div className=\"text-right\">\n                        {slot.attendanceStats && (\n                          <div className=\"space-y-2\">\n                            <div className=\"text-lg font-bold\">\n                              {slot.attendanceStats.total} {t('students')}\n                            </div>\n                            <div className=\"flex flex-col gap-1 text-xs\">\n                              <div className=\"flex items-center justify-end gap-1\">\n                                <span className=\"text-green-600 font-medium\">{slot.attendanceStats.present} {tCommon('present')}</span>\n                              </div>\n                              <div className=\"flex items-center justify-end gap-1\">\n                                <span className=\"text-red-600 font-medium\">{slot.attendanceStats.absent} {tCommon('absent')}</span>\n                              </div>\n                              <div className=\"flex items-center justify-end gap-1\">\n                                <span className=\"text-gray-500 font-medium\">{slot.attendanceStats.notYet} {tCommon('not_yet')}</span>\n                              </div>\n                            </div>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          </div>\n\n          <Separator />\n        </>\n      )}\n\n      {/* Recent Exam Activity */}\n      {data?.recentActivity && data.recentActivity.length > 0 && (\n        <div>\n          <h3 className=\"text-lg font-semibold mb-4\">{t('recent_activity')}</h3>\n          <div className=\"grid gap-4\">\n            {data.recentActivity.map((slot: any) => (\n              <Card key={slot.id}>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"space-y-1\">\n                      <div className=\"flex items-center gap-2\">\n                        <Calendar className=\"h-4 w-4 text-muted-foreground\" />\n                        <span className=\"font-medium\">\n                          {formatVietnamTime(parseVietnamTime(slot.startTime), 'dd/MM/yy')}\n                        </span>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Clock className=\"h-4 w-4 text-muted-foreground\" />\n                        <span className=\"text-sm text-muted-foreground\">\n                          {formatVietnamTime(parseVietnamTime(slot.startTime), 'HH:mm')}\n                          {' - '}\n                          {formatVietnamTime(parseVietnamTime(slot.endTime), 'HH:mm')}\n                        </span>\n                      </div>\n                      {slot.room && (\n                        <div className=\"text-sm text-muted-foreground\">\n                          {t('room')}: {slot.room.name}\n                        </div>\n                      )}\n                      {slot.subjects && slot.subjects.length > 0 && (\n                        <div className=\"flex flex-wrap gap-1 mt-1\">\n                          <TooltipProvider>\n                            {slot.subjects.map((subject: any) => (\n                              <Tooltip key={subject.id}>\n                                <TooltipTrigger asChild>\n                                  <Badge variant=\"secondary\" className=\"cursor-default\">\n                                    {subject.code}\n                                  </Badge>\n                                </TooltipTrigger>\n                                <TooltipContent>\n                                  <p>{subject.name}</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            ))}\n                          </TooltipProvider>\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"text-right\">\n                      {slot.attendanceStats && (\n                        <div className=\"space-y-2\">\n                          <div className=\"text-lg font-bold\">\n                            {slot.attendanceStats.total} {t('students')}\n                          </div>\n                          <div className=\"flex flex-col gap-1 text-xs\">\n                            <div className=\"flex items-center justify-end gap-1\">\n                              <span className=\"text-green-600 font-medium\">{slot.attendanceStats.present} {tCommon('present')}</span>\n                            </div>\n                            <div className=\"flex items-center justify-end gap-1\">\n                              <span className=\"text-red-600 font-medium\">{slot.attendanceStats.absent} {tCommon('absent')}</span>\n                            </div>\n                            <div className=\"flex items-center justify-end gap-1\">\n                              <span className=\"text-gray-500 font-medium\">{slot.attendanceStats.notYet} {tCommon('not_yet')}</span>\n                            </div>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\supervisor\\layout.tsx",
      "relative_path": "app/supervisor/layout.tsx",
      "filename": "layout.tsx",
      "size_bytes": 1856,
      "lines": 51,
      "last_modified": "2025-11-01T15:38:43.282641",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { AppSidebar } from \"@/components/shared/app-sidebar\";\nimport { MobileSidebar } from \"@/components/shared/mobile-sidebar\";\nimport { AppHeader } from \"@/components/shared/app-header\";\nimport { SidebarProvider } from \"@/components/shared/sidebar-context\";\nimport { PageHeaderProvider } from \"@/components/shared/page-header-context\";\nimport { RoleBasedRouteGuard } from \"@/components/auth/role-based-route-guard\";\nimport { supervisorMenu } from \"@/lib/menu-configs/supervisor-menu\";\n\n/**\n * Supervisor Portal Layout\n *\n * Shared layout for all exam supervisor pages.\n * Uses the supervisorMenu configuration for navigation.\n * Protected by RoleBasedRouteGuard to ensure only SUPERVISOR role can access.\n *\n * Pages under /supervisor/* will use this layout automatically.\n */\nexport default function SupervisorLayout({\n  children,\n}: {\n  children: React.ReactNode;\n}) {\n  return (\n    <RoleBasedRouteGuard allowedRoles={[\"SUPERVISOR\"]}>\n      <SidebarProvider>\n        <PageHeaderProvider>\n          <div className=\"flex h-screen overflow-hidden\">\n            {/* Desktop Sidebar (hidden on mobile) */}\n            <AppSidebar menuConfig={supervisorMenu} className=\"hidden lg:flex\" />\n\n            {/* Mobile Sidebar (Sheet overlay) */}\n            <MobileSidebar menuConfig={supervisorMenu} />\n\n            {/* Main Content Area */}\n            <div className=\"flex flex-1 flex-col overflow-hidden\">\n              {/* Header */}\n              <AppHeader />\n\n              {/* Page Content - Responsive padding */}\n              <main className=\"flex-1 overflow-y-auto overflow-x-hidden bg-muted/10 p-4 md:p-6\">\n                {children}\n              </main>\n            </div>\n          </div>\n        </PageHeaderProvider>\n      </SidebarProvider>\n    </RoleBasedRouteGuard>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\supervisor\\profile\\page.tsx",
      "relative_path": "app/supervisor/profile/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 8249,
      "lines": 242,
      "last_modified": "2025-11-10T23:07:39.493375",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  User,\n  Loader2,\n  Shield,\n} from \"lucide-react\";\nimport { useGetStaffProfile } from \"@/hooks/api/useStaffProfiles\";\nimport { getSupervisorId } from \"@/lib/auth\";\nimport { ChangePasswordDialog } from \"@/components/shared/change-password-dialog\";\nimport { useTranslations } from 'next-intl';\n\n/**\n * Supervisor Profile Page\n *\n * Displays supervisor profile information from API:\n * - Personal information\n * - Professional information\n * - Security settings\n */\nexport default function SupervisorProfilePage() {\n  const { setPageHeader } = usePageHeader();\n  const [selectedTab, setSelectedTab] = useState(\"personal\");\n  const t = useTranslations('profile');\n\n  // Get current supervisor ID\n  const supervisorId = getSupervisorId();\n\n  // Fetch supervisor profile data (only if supervisorId exists)\n  const {\n    data: supervisorProfile,\n    isLoading,\n    error,\n  } = useGetStaffProfile(supervisorId || 0);\n\n  useEffect(() => {\n    setPageHeader({\n      title: t('profile'),\n      subtitle: t('manage_profile_subtitle'),\n    });\n  }, [setPageHeader, t]);\n\n  // Check if supervisor ID is available\n  if (!supervisorId) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"text-center\">\n          <p className=\"text-destructive mb-2\">{t('auth_error')}</p>\n          <p className=\"text-sm text-muted-foreground\">\n            {t('unable_identify_student')}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  // Loading state\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"flex items-center gap-2\">\n          <Loader2 className=\"h-6 w-6 animate-spin\" />\n          <span>{t('loading_profile')}</span>\n        </div>\n      </div>\n    );\n  }\n\n  // Error state\n  if (error || !supervisorProfile) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"text-center\">\n          <p className=\"text-destructive mb-2\">{t('failed_load_profile')}</p>\n          <p className=\"text-sm text-muted-foreground\">\n            {error?.message || t('profile_not_found')}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Profile Header */}\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-start gap-6\">\n            <div className=\"relative\">\n              <Avatar className=\"h-24 w-24\">\n                <AvatarImage src=\"\" />\n                <AvatarFallback className=\"text-lg\">\n                  {supervisorProfile.fullName\n                    .split(\" \")\n                    .map((n) => n[0])\n                    .join(\"\")}\n                </AvatarFallback>\n              </Avatar>\n            </div>\n\n            <div className=\"flex-1\">\n              <div className=\"flex items-start justify-between\">\n                <div>\n                  <h2 className=\"text-2xl font-bold\">\n                    {supervisorProfile.fullName}\n                  </h2>\n                  <p className=\"text-muted-foreground\">\n                    {supervisorProfile.staffCode}\n                  </p>\n                  <div className=\"flex items-center gap-2 mt-2\">\n                    {supervisorProfile.roles.map((role) => (\n                      <Badge key={role} variant=\"default\">\n                        {role}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              <p className=\"text-sm text-muted-foreground mt-3 max-w-2xl\">\n                {t('supervisor_profile_managed')}\n              </p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Profile Details */}\n      <Tabs value={selectedTab} onValueChange={setSelectedTab}>\n        <TabsList className=\"grid w-full grid-cols-2\">\n          <TabsTrigger value=\"personal\">{t('personal_info')}</TabsTrigger>\n          <TabsTrigger value=\"security\">{t('security')}</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"personal\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <User className=\"h-5 w-5\" />\n                {t('personal_information')}\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"fullName\">{t('full_name')}</Label>\n                  <Input\n                    id=\"fullName\"\n                    value={supervisorProfile.fullName}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"staffCode\">{t('staff_code')}</Label>\n                  <Input\n                    id=\"staffCode\"\n                    value={supervisorProfile.staffCode}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"username\">{t('username')}</Label>\n                  <Input\n                    id=\"username\"\n                    value={supervisorProfile.username}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">{t('email_address')}</Label>\n                  <Input\n                    id=\"email\"\n                    type=\"email\"\n                    value={supervisorProfile.email}\n                    disabled\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"createdAt\">{t('account_created')}</Label>\n                  <Input\n                    id=\"createdAt\"\n                    value={new Date(\n                      supervisorProfile.createdAt\n                    ).toLocaleDateString()}\n                    disabled\n                  />\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"updatedAt\">{t('last_updated')}</Label>\n                  <Input\n                    id=\"updatedAt\"\n                    value={new Date(\n                      supervisorProfile.updatedAt\n                    ).toLocaleDateString()}\n                    disabled\n                  />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"security\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Shield className=\"h-5 w-5\" />\n                {t('security_settings')}\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"space-y-4\">\n                <div>\n                  <h4 className=\"font-medium mb-2\">{t('password')}</h4>\n                  <p className=\"text-sm text-muted-foreground mb-4\">\n                    {t('change_password')}\n                  </p>\n                  <ChangePasswordDialog userId={supervisorProfile.userId} />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\supervisor\\reports\\page.tsx",
      "relative_path": "app/supervisor/reports/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 5524,
      "lines": 161,
      "last_modified": "2025-11-10T23:07:39.494375",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useEffect } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { \n  Calendar, \n  Users, \n  BookOpen, \n  BarChart3,\n  ArrowRight\n} from \"lucide-react\";\nimport Link from \"next/link\";\nimport { useTranslations } from 'next-intl';\n\n/**\n * Supervisor Reports Main Page\n *\n * Dashboard for supervisor reports with navigation to:\n * - Exam slots reports\n * - Student attendance reports\n * - Statistics and analytics\n */\nexport default function SupervisorReportsPage() {\n  const { setPageHeader } = usePageHeader();\n\n  const t = useTranslations('supervisor');\n  const tCommon = useTranslations('common');\n\n  useEffect(() => {\n    setPageHeader({\n      title: t('supervisor_reports'),\n      subtitle: t('access_exam_reports'),\n      breadcrumbs: [\n        { label: t('reports') },\n      ],\n    });\n  }, [setPageHeader, t]);\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Reports Overview */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {/* Exam Slots Reports */}\n        <Card className=\"hover:shadow-md transition-shadow\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Calendar className=\"h-5 w-5 text-blue-500\" />\n              {t('exam_slots')}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-sm text-muted-foreground mb-4\">\n              {t('view_manage_slot_reports')}\n            </p>\n            <Button asChild className=\"w-full\">\n              <Link href=\"/supervisor/reports/slots\">\n                {t('view_slots')}\n                <ArrowRight className=\"h-4 w-4 ml-2\" />\n              </Link>\n            </Button>\n          </CardContent>\n        </Card>\n\n        {/* Student Reports */}\n        <Card className=\"hover:shadow-md transition-shadow\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Users className=\"h-5 w-5 text-green-500\" />\n              {t('student_reports')}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-sm text-muted-foreground mb-4\">\n              {t('access_student_reports')}\n            </p>\n            <Button asChild variant=\"outline\" className=\"w-full\">\n              <Link href=\"/supervisor/reports/students\">\n                {t('view_students')}\n                <ArrowRight className=\"h-4 w-4 ml-2\" />\n              </Link>\n            </Button>\n          </CardContent>\n        </Card>\n\n        {/* Analytics */}\n        <Card className=\"hover:shadow-md transition-shadow\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <BarChart3 className=\"h-5 w-5 text-purple-500\" />\n              {t('analytics')}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <p className=\"text-sm text-muted-foreground mb-4\">\n              {t('view_comprehensive_analytics')}\n            </p>\n            <Button asChild variant=\"outline\" className=\"w-full\">\n              <Link href=\"/supervisor/reports/analytics\">\n                {t('view_analytics')}\n                <ArrowRight className=\"h-4 w-4 ml-2\" />\n              </Link>\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Quick Stats */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">{t('total_slots')}</p>\n                <p className=\"text-2xl font-bold\">24</p>\n              </div>\n              <Calendar className=\"h-6 w-6 text-blue-500\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">{tCommon('completed')}</p>\n                <p className=\"text-2xl font-bold text-green-600\">18</p>\n              </div>\n              <BookOpen className=\"h-6 w-6 text-green-500\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">{t('students')}</p>\n                <p className=\"text-2xl font-bold\">456</p>\n              </div>\n              <Users className=\"h-6 w-6 text-purple-500\" />\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-sm font-medium text-muted-foreground\">{t('attendance_rate')}</p>\n                <p className=\"text-2xl font-bold text-blue-600\">94.2%</p>\n              </div>\n              <BarChart3 className=\"h-6 w-6 text-blue-500\" />\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\supervisor\\reports\\slots\\page.tsx",
      "relative_path": "app/supervisor/reports/slots/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 981,
      "lines": 33,
      "last_modified": "2025-11-15T12:26:24.325651",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useEffect } from \"react\";\nimport { SupervisorSlotReportsContainer } from \"@/components/supervisor/reports/slot-reports-container\";\nimport { useTranslations } from 'next-intl';\n\n/**\n * Supervisor Slots Reports Page\n *\n * Lists all exam slots for the supervisor with ability to:\n * - View slot details\n * - Navigate to detailed reports\n * - Filter by semester, class, subject\n */\nexport default function SupervisorSlotsReportsPage() {\n  const { setPageHeader } = usePageHeader();\n\n  const t = useTranslations('supervisor');\n\n  useEffect(() => {\n    setPageHeader({\n      title: t('exam_slots_reports'),\n      subtitle: t('view_manage_slot_reports'),\n      breadcrumbs: [\n        { label: t('reports'), href: \"/supervisor/reports\" },\n        { label: t('slots') },\n      ],\n    });\n  }, [setPageHeader, t]);\n\n  return <SupervisorSlotReportsContainer />;\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\supervisor\\schedule\\page.tsx",
      "relative_path": "app/supervisor/schedule/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 835,
      "lines": 29,
      "last_modified": "2025-11-13T21:14:04.092642",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useEffect } from \"react\";\nimport { SupervisorScheduleContainer } from \"@/components/supervisor/schedule/schedule-container\";\nimport { useTranslations } from 'next-intl';\n\n/**\n * Supervisor Schedule Page\n *\n * Displays exam supervision schedule in calendar format with:\n * - Week navigation and filters\n * - Calendar view of exam slots\n * - Slot details and management\n */\nexport default function SupervisorSchedulePage() {\n  const { setPageHeader } = usePageHeader();\n\n  const t = useTranslations('supervisor');\n\n  useEffect(() => {\n    setPageHeader({\n      title: t('my_schedule'),\n      subtitle: t('view_manage_exam_schedule'),\n    });\n  }, [setPageHeader, t]);\n\n  return <SupervisorScheduleContainer />;\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\supervisor\\slots\\[id]\\attendance\\page.tsx",
      "relative_path": "app/supervisor/slots/[id]/attendance/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 7777,
      "lines": 227,
      "last_modified": "2025-11-16T12:19:21.777449",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useParams } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useTranslations } from \"next-intl\";\nimport {\n  SlotRosterTable,\n  type PendingChange,\n} from \"@/components/admin/slots/slot-roster-table\";\nimport { ExamSessionControls } from \"@/components/admin/slots/exam-session-controls\";\nimport { EvidenceViewerDialog } from \"@/components/admin/slots/evidence-viewer-dialog\";\nimport { type StatusFilter } from \"@/components/admin/slots/roster-filters\";\nimport { useGetSlot } from \"@/hooks/api/useSlots\";\nimport { useGetSlotRoster } from \"@/hooks/api/useSlotRoster\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useSlotRosterSSE } from \"@/hooks/realtime/useSlotRosterSSE\";\n\n/**\n * Supervisor Attendance Management Page\n *\n * PURPOSE:\n * - Manage exam attendance for FINAL_EXAM slots\n * - Start/Stop/Rescan exam recognition sessions\n * - View real-time attendance updates via SSE\n * - Edit attendance records inline\n * - Submit attendance with bulk NOT_YET resolution\n *\n * KEY DIFFERENCES from Lecturer:\n * - ONLY EXAM attendance (no REGULAR attendance)\n * - NO TABS (single view)\n * - ONLY ExamSessionControls (no SessionControls)\n * - Breadcrumbs: \"My Exam Slots\" (not \"My Slots\")\n * - userRole=\"SUPERVISOR\" passed to components\n *\n * LOGIC:\n * - NO DOWNGRADE: PRESENT stays PRESENT on rescan\n * - Mutual exclusion: Cannot run regular and exam sessions together\n * - Time-based permissions: Edit until 23:59:59 UTC of slot date\n * - SSE real-time updates: Auto-refresh roster when students recognized\n */\nexport default function SupervisorAttendancePage() {\n  const t = useTranslations(\"supervisor\");\n  const tCommon = useTranslations(\"common\");\n  const params = useParams();\n  const slotId = Number(params.id);\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // Fetch data\n  const { data: slot, isLoading: isLoadingSlot } = useGetSlot(slotId);\n  const { data: roster, isLoading: isLoadingRoster } = useGetSlotRoster(slotId);\n\n  // Real-time updates via SSE (patches the roster cache)\n  useSlotRosterSSE(slotId);\n\n  // Pending changes state for inline editing\n  // Use composite key (attendanceType-recordId) even though we only have EXAM\n  // This maintains consistency with the SlotRosterTable component\n  const [pendingChanges, setPendingChanges] = useState<\n    Map<string, PendingChange>\n  >(new Map());\n\n  // Filter state for Exam attendance\n  const [examStatusFilter, setExamStatusFilter] = useState<StatusFilter>(\"all\");\n  const [examSearchQuery, setExamSearchQuery] = useState(\"\");\n\n  // Evidence viewer dialog state\n  const [evidenceDialogOpen, setEvidenceDialogOpen] = useState(false);\n  const [avatarImageUrl, setAvatarImageUrl] = useState<string>(\"\");\n  const [evidenceImageUrl, setEvidenceImageUrl] = useState<string | null>(null);\n  const [studentName, setStudentName] = useState<string>(\"\");\n\n  /**\n   * Handle evidence viewer - called when user clicks avatar/evidence in table\n   */\n  const handleViewEvidence = (\n    avatarUrl: string,\n    evidenceUrl: string | null,\n    name: string\n  ) => {\n    setAvatarImageUrl(avatarUrl);\n    setEvidenceImageUrl(evidenceUrl);\n    setStudentName(name);\n    setEvidenceDialogOpen(true);\n  };\n\n  /**\n   * Handle pending change - called when user edits attendance inline\n   */\n  const handlePendingChange = (\n    recordId: number,\n    attendanceType: \"REGULAR\" | \"EXAM\",\n    status: \"present\" | \"absent\" | \"not_yet\",\n    remark?: string\n  ) => {\n    const newPendingChanges = new Map(pendingChanges);\n    const key = `${attendanceType}-${recordId}`;\n    newPendingChanges.set(key, { status, remark });\n    setPendingChanges(newPendingChanges);\n  };\n\n  /**\n   * Clear pending changes - called after successful submit\n   */\n  const clearPendingChanges = () => {\n    setPendingChanges(new Map());\n  };\n\n  /**\n   * Set page header with slot details\n   */\n  useEffect(() => {\n    if (!slot) {\n      setPageHeader({\n        title: t(\"exam_attendance\"),\n        subtitle: t(\"loading_exam_slot\"),\n        breadcrumbs: [\n          { label: tCommon(\"dashboard\"), href: \"/supervisor/dashboard\" },\n          { label: t(\"my_exam_slots\"), href: \"/supervisor/slots\" },\n          { label: t(\"exam_attendance\") },\n        ],\n      });\n      return;\n    }\n\n    const getCategoryLabel = (category: string) => {\n      const labels = {\n        LECTURE: t(\"lecture\"),\n        LECTURE_WITH_PT: t(\"lecture_with_pt\"),\n        FINAL_EXAM: t(\"final_exam\"),\n      };\n      return labels[category as keyof typeof labels] || category;\n    };\n\n    setPageHeader({\n      title: slot.title || t(\"final_examination\"),\n      subtitle: `${slot.class?.code || \"\"} ${getCategoryLabel(\n        slot.slotCategory\n      )} â€¢ ${format(new Date(slot.startTime), \"MMM d, yyyy\")} â€¢ ${format(\n        new Date(slot.startTime),\n        \"h:mm a\"\n      )} - ${format(new Date(slot.endTime), \"h:mm a\")} â€¢ ${slot.room.name}`,\n      breadcrumbs: [\n        { label: tCommon(\"dashboard\"), href: \"/supervisor/dashboard\" },\n        { label: t(\"my_exam_slots\"), href: \"/supervisor/slots\" },\n        { label: slot.title || t(\"final_examination\") },\n      ],\n    });\n  }, [slot, setPageHeader, t, tCommon]);\n\n  /**\n   * Clear header on unmount\n   */\n  useEffect(() => {\n    return () => {\n      clearPageHeader();\n    };\n  }, [clearPageHeader]);\n\n  // Loading state\n  if (isLoadingSlot || isLoadingRoster) {\n    return (\n      <div className=\"space-y-6\">\n        <Skeleton className=\"h-10 w-full\" />\n        <Skeleton className=\"h-32 w-full\" />\n        <Skeleton className=\"h-96 w-full\" />\n      </div>\n    );\n  }\n\n  // Not found state\n  if (!slot || !roster) {\n    return (\n      <div className=\"flex flex-col items-center justify-center min-h-[400px] gap-4\">\n        <p className=\"text-muted-foreground\">{t(\"exam_slot_not_found\")}</p>\n      </div>\n    );\n  }\n\n  // Check if exam session is running (to disable editing)\n  const isExamRunning = slot.examSessionStatus === \"RUNNING\";\n\n  /**\n   * Supervisor ONLY handles FINAL_EXAM slots with EXAM attendance\n   * - No tabs (unlike LECTURE_WITH_PT which has both REGULAR and EXAM)\n   * - Only ExamSessionControls (not SessionControls)\n   * - attendanceType=\"EXAM\" fixed (no variable)\n   * - userRole=\"SUPERVISOR\" for permission checks\n   */\n  return (\n    <div className=\"space-y-6\">\n      {/* Exam Session Controls + Roster Table - Merged into one Card */}\n      <ExamSessionControls\n        slot={slot}\n        roster={roster}\n        pendingChanges={pendingChanges}\n        onSubmitSuccess={clearPendingChanges}\n        userRole=\"SUPERVISOR\"\n        statusFilter={examStatusFilter}\n        onStatusFilterChange={setExamStatusFilter}\n        searchQuery={examSearchQuery}\n        onSearchQueryChange={setExamSearchQuery}\n      >\n        <SlotRosterTable\n          data={roster}\n          slot={slot}\n          attendanceType=\"EXAM\"\n          pendingChanges={pendingChanges}\n          onPendingChange={handlePendingChange}\n          onViewEvidence={handleViewEvidence}\n          userRole=\"SUPERVISOR\"\n          isSessionRunning={isExamRunning}\n        />\n      </ExamSessionControls>\n\n      {/* Evidence Viewer Dialog - Compare avatar vs evidence side-by-side */}\n      <EvidenceViewerDialog\n        open={evidenceDialogOpen}\n        onOpenChange={setEvidenceDialogOpen}\n        avatarUrl={avatarImageUrl}\n        evidenceUrl={evidenceImageUrl}\n        studentName={studentName}\n      />\n    </div>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\app\\supervisor\\slots\\page.tsx",
      "relative_path": "app/supervisor/slots/page.tsx",
      "filename": "page.tsx",
      "size_bytes": 24772,
      "lines": 686,
      "last_modified": "2025-11-19T16:25:56.508095",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { Suspense, useEffect, useState, useMemo, useRef } from \"react\";\nimport { useRouter, useSearchParams, usePathname } from \"next/navigation\";\nimport { CalendarIcon, SlidersHorizontal, Loader2 } from \"lucide-react\";\nimport { usePageHeader } from \"@/components/shared/page-header-context\";\nimport { useTranslations } from 'next-intl';\nimport { Button } from \"@/components/ui/button\";\nimport { Calendar } from \"@/components/ui/calendar\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport { SupervisorSlotTable } from \"@/components/supervisor/slots/supervisor-slot-table\";\nimport { createSupervisorSlotColumns } from \"@/components/supervisor/slots/supervisor-slot-columns\";\nimport { SupervisorExamDetailDialog } from \"@/components/supervisor/slots/supervisor-exam-detail-dialog\";\nimport { Slot } from \"@/types\";\nimport {\n  useGetStaffSlots,\n  useGetStaffSubjects,\n  useGetStaffRooms,\n} from \"@/hooks/api/useStaffProfiles\";\nimport { useGetSemesters } from \"@/hooks/api/useSemesters\";\nimport { useGetSubjects } from \"@/hooks/api/useSubjects\";\nimport { format } from \"date-fns\";\nimport { cn } from \"@/lib/utils\";\nimport { getUserId } from \"@/lib/auth\";\nimport { DEFAULT_PAGE_SIZE, FILTER_PAGE_SIZE } from \"@/lib/constants\";\n\nfunction SupervisorSlotsContent() {\n  const t = useTranslations('supervisor');\n  const tCommon = useTranslations('common');\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const pathname = usePathname();\n  const { setPageHeader, clearPageHeader } = usePageHeader();\n\n  // Get current supervisor ID from auth\n  const currentSupervisorId = getUserId();\n\n  // URL params\n  const page = Math.max(1, Math.min(50, Number(searchParams.get(\"page\")) || 1));\n  const sortBy = (\n    [\"startTime\", \"endTime\"].includes(searchParams.get(\"sortBy\") || \"\")\n      ? searchParams.get(\"sortBy\")\n      : \"startTime\"\n  ) as \"startTime\" | \"endTime\";\n  const sortOrder = (searchParams.get(\"sort\") === \"asc\" ? \"asc\" : \"desc\") as\n    | \"asc\"\n    | \"desc\";\n\n  // URL param extraction\n  const semesterIdParam = searchParams.get(\"semesterId\");\n  const roomIdParam = searchParams.get(\"roomId\");\n  const isActiveParam = searchParams.get(\"isActive\");\n  const startTimeFromParam = searchParams.get(\"startTimeFrom\");\n  const startTimeToParam = searchParams.get(\"startTimeTo\");\n\n  // ========== SEMESTER LOGIC (PRIORITY 1) ==========\n  // Fetch semesters first (required for auto-select logic)\n  const { data: semestersData, isLoading: semestersLoading } = useGetSemesters({\n    pageSize: FILTER_PAGE_SIZE,\n    isActive: true,\n  });\n\n  // Extract semesters array\n  const semesters = useMemo(() => semestersData?.items || [], [semestersData]);\n\n  // Calculate current semester (start_date <= now <= end_date)\n  const currentSemester = useMemo(() => {\n    if (!semesters || semesters.length === 0) return null;\n\n    const now = new Date();\n    return semesters.find((s) => {\n      const start = new Date(s.startDate);\n      const end = new Date(s.endDate);\n      return now >= start && now <= end;\n    });\n  }, [semesters]);\n\n  // Calculate semesterIdFilter - KHÃ”NG auto-fallback, respect user choice\n  // Náº¿u user chá»n \"All Semesters\" (khÃ´ng cÃ³ param) â†’ undefined = show all\n  // Auto-select chá»‰ xáº£y ra trong useEffect initialization (xem dÆ°á»›i)\n  const semesterIdFilter = semesterIdParam && !isNaN(Number(semesterIdParam))\n    ? Number(semesterIdParam)\n    : undefined;\n\n  // ========== OTHER FILTERS ==========\n  const roomIdFilter = roomIdParam ? Number(roomIdParam) : undefined;\n  const isActiveFilter = isActiveParam === \"false\" ? false : true; // Default to active only\n\n  // Combobox open states\n  const [semesterFilterOpen, setSemesterFilterOpen] = useState(false);\n  const [roomFilterOpen, setRoomFilterOpen] = useState(false);\n\n  // Advanced filters popover state\n  const [advancedFiltersOpen, setAdvancedFiltersOpen] = useState(false);\n\n  // Date picker states\n  const [startDateOpen, setStartDateOpen] = useState(false);\n  const [endDateOpen, setEndDateOpen] = useState(false);\n\n  const [selectedSlot, setSelectedSlot] = useState<Slot | null>(null);\n  const [isExamDetailOpen, setIsExamDetailOpen] = useState(false);\n\n  // Get slotId from URL params if present\n  const urlSlotId = searchParams.get(\"slotId\");\n\n  const updateURL = (updates: Record<string, string | number | undefined>) => {\n    const newParams = new URLSearchParams(searchParams.toString());\n\n    Object.entries(updates).forEach(([key, value]) => {\n      if (value !== undefined && value !== \"\") {\n        if (key === \"page\" && value === 1) {\n          newParams.delete(key);\n        } else {\n          newParams.set(key, String(value));\n        }\n      } else {\n        if (key !== \"sortBy\" && key !== \"sort\") {\n          newParams.delete(key);\n        }\n      }\n    });\n\n    // Always ensure sortBy and sort are present\n    if (!newParams.has(\"sortBy\")) {\n      newParams.set(\"sortBy\", sortBy);\n    }\n    if (!newParams.has(\"sort\")) {\n      newParams.set(\"sort\", sortOrder);\n    }\n\n    const newURL = `${pathname}?${newParams.toString()}`;\n    router.push(newURL, { scroll: false });\n  };\n\n  const canFetchSlots = Boolean(currentSupervisorId);\n\n  // Try staff-specific first, fallback to general if no data\n  useGetStaffSubjects(currentSupervisorId || 0, {\n    pageSize: FILTER_PAGE_SIZE,\n    semesterId: semesterIdFilter,\n    isActive: true,\n  });\n\n  // Fallback to general APIs if staff-specific returns no data\n  useGetSubjects({\n    pageSize: FILTER_PAGE_SIZE,\n    isActive: true,\n  });\n\n  const { data: roomsData, isLoading: roomsLoading } = useGetStaffRooms(\n    currentSupervisorId || 0,\n    {\n      pageSize: FILTER_PAGE_SIZE,\n      semesterId: semesterIdFilter,\n      isActive: true,\n    }\n  );\n\n  // Fetch slots for current supervisor (only FINAL_EXAM)\n  const { data, isLoading } = useGetStaffSlots(currentSupervisorId || 0, {\n    page,\n    pageSize: DEFAULT_PAGE_SIZE,\n    sort: sortOrder,\n    sortBy: sortBy,\n    slotCategories: [\"FINAL_EXAM\"], // Supervisor only sees exam slots\n    semesterId: semesterIdFilter,\n    roomId: roomIdFilter,\n    isActive: isActiveFilter,\n    startTimeFrom: startTimeFromParam || undefined,\n    startTimeTo: startTimeToParam || undefined,\n  });\n\n  // Extract data directly (already filtered by server)\n  const slots = data?.items || [];\n  const totalItems = data?.totalItems ?? 0;\n  const pageSize = data?.pageSize ?? DEFAULT_PAGE_SIZE;\n  const safePageSize = pageSize > 0 ? pageSize : DEFAULT_PAGE_SIZE;\n  const totalPages = Math.max(1, Math.ceil(totalItems / safePageSize));\n  const currentPageRaw = data?.currentPage ?? page;\n  const currentPage = Math.min(Math.max(currentPageRaw, 1), totalPages);\n\n  // Combine all loading states for page-level loading UI\n  const isAnyLoading = isLoading || semestersLoading || roomsLoading;\n\n  useEffect(() => {\n    if (!isLoading && canFetchSlots && page > totalPages && totalPages >= 1) {\n      updateURL({ page: totalPages });\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isLoading, canFetchSlots, page, totalPages]);\n\n  const rooms = roomsData?.items || [];\n\n  // ========== UNIFIED URL INITIALIZATION ==========\n  // Track if auto-select has been done to prevent re-triggering when user clears filter\n  const hasAutoSelected = useRef(false);\n\n  // Single unified URL initialization effect\n  useEffect(() => {\n    // Wait for semesters to load\n    if (semestersLoading) return;\n\n    // Only run once on initial load\n    if (hasAutoSelected.current) return;\n\n    // âš ï¸ CRITICAL: Chá»‰ auto-select khi currentSemester Ä‘Ã£ sáºµn sÃ ng\n    // Náº¿u chÆ°a cÃ³ currentSemester, chá» láº§n render sau (useEffect sáº½ cháº¡y láº¡i khi currentSemester thay Ä‘á»•i)\n    if (!currentSemester) return;\n\n    // ÄÃ¡nh dáº¥u Ä‘Ã£ auto-select (chá»‰ set khi ÄÃƒ CÃ“ currentSemester)\n    hasAutoSelected.current = true;\n\n    const updates: Record<string, string | number | undefined> = {};\n    let needsUpdate = false;\n\n    // 1ï¸âƒ£ SEMESTER - Bá»• sung náº¿u thiáº¿u (currentSemester Ä‘Ã£ guaranteed tá»“n táº¡i)\n    if (!semesterIdParam) {\n      updates.semesterId = currentSemester.id;\n      needsUpdate = true;\n    }\n\n    // 2ï¸âƒ£ SKIP DATE RANGE - Supervisor khÃ´ng auto-select date range\n\n    // 3ï¸âƒ£ SORT PARAMS - Bá»• sung náº¿u thiáº¿u\n    if (!searchParams.has(\"sortBy\") || !searchParams.has(\"sort\")) {\n      updates.sortBy = sortBy;\n      updates.sort = sortOrder;\n      needsUpdate = true;\n    }\n\n    // Single atomic URL update - Semester + sort params lÃªn URL cÃ¹ng lÃºc\n    if (needsUpdate) {\n      updates.page = 1;\n      updateURL(updates);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    semestersLoading,\n    currentSemester,\n    semesterIdParam,\n    searchParams,\n    sortBy,\n    sortOrder,\n  ]);\n\n  // Auto-open exam detail dialog if slotId in URL\n  useEffect(() => {\n    const currentSlots = data?.items || [];\n    if (urlSlotId && currentSlots.length > 0 && !selectedSlot) {\n      const slot = currentSlots.find((s) => s.id.toString() === urlSlotId);\n      if (slot) {\n        setSelectedSlot(slot);\n        setIsExamDetailOpen(true);\n      }\n    }\n  }, [urlSlotId, data?.items, selectedSlot]);\n\n  // Find selected items for display\n  const selectedSemester = semesters.find((s) => s.id === semesterIdFilter);\n  const selectedRoom = rooms.find((r) => r.id === roomIdFilter);\n\n  const handleViewExam = (slot: Slot) => {\n    setSelectedSlot(slot);\n    setIsExamDetailOpen(true);\n  };\n\n\n  const handlePageChange = (newPage: number) => {\n    const targetPage = Math.min(Math.max(newPage, 1), totalPages);\n    if (targetPage === page) return;\n    updateURL({ page: targetPage });\n  };\n\n  const handleSortByChange = (value: \"startTime\" | \"endTime\") => {\n    updateURL({ sortBy: value });\n  };\n\n  const handleSortOrderChange = (value: \"asc\" | \"desc\") => {\n    updateURL({ sort: value });\n  };\n\n  const handleSemesterFilterChange = (value: string) => {\n    if (value === \"all\") {\n      // Clear semester and cascade clear dependent filters\n      updateURL({\n        semesterId: undefined,\n        roomId: undefined,\n        page: 1,\n      });\n    } else {\n      // Set semester and cascade clear dependent filters\n      updateURL({\n        semesterId: value,\n        roomId: undefined,\n        page: 1,\n      });\n    }\n  };\n\n  const handleRoomFilterChange = (value: string) => {\n    if (value === \"all\") {\n      updateURL({ roomId: undefined, page: 1 });\n    } else {\n      updateURL({ roomId: value, page: 1 });\n    }\n  };\n\n  const handleStartDateChange = (date: Date | undefined) => {\n    if (date) {\n      updateURL({ startTimeFrom: format(date, \"yyyy-MM-dd\"), page: 1 });\n    } else {\n      updateURL({ startTimeFrom: undefined, page: 1 });\n    }\n    setStartDateOpen(false);\n  };\n\n  const handleEndDateChange = (date: Date | undefined) => {\n    if (date) {\n      updateURL({ startTimeTo: format(date, \"yyyy-MM-dd\"), page: 1 });\n    } else {\n      updateURL({ startTimeTo: undefined, page: 1 });\n    }\n    setEndDateOpen(false);\n  };\n\n  const handleClearDateRange = () => {\n    updateURL({\n      startTimeFrom: undefined,\n      startTimeTo: undefined,\n      page: 1,\n    });\n  };\n\n  const handleClearAdvancedFilters = () => {\n    updateURL({\n      roomId: undefined,\n      page: 1,\n    });\n    setAdvancedFiltersOpen(false);\n  };\n\n  const columns = createSupervisorSlotColumns(handleViewExam);\n\n  // Set page header\n  useEffect(() => {\n    setPageHeader({\n      title: t('my_exam_slots'),\n      subtitle: tCommon('manage_supervise_exam_slots'),\n      breadcrumbs: [\n        { label: tCommon('dashboard'), href: \"/supervisor/dashboard\" },\n        { label: t('my_exam_slots') },\n      ],\n    });\n\n    return () => {\n      clearPageHeader();\n    };\n  }, [setPageHeader, clearPageHeader, t, tCommon]);\n\n  // Show loading spinner when any data is being fetched\n  if (isAnyLoading) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-center py-12\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Controls row */}\n      <div className=\"flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between\">\n        {/* Main Filters */}\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:flex-wrap lg:flex-1\">\n          {/* Semester Filter - PRIORITY 1 */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-3 bg-background w-full sm:w-auto\">\n            <span className=\"text-sm text-muted-foreground whitespace-nowrap\">\n              {t('semester')}:\n            </span>\n            <Popover\n              open={semesterFilterOpen}\n              onOpenChange={setSemesterFilterOpen}\n            >\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  role=\"combobox\"\n                  aria-expanded={semesterFilterOpen}\n                  className=\"h-full border-0 shadow-none focus:ring-0 px-0 hover:bg-transparent justify-start w-full sm:w-[120px]\"\n                  disabled={semestersLoading}\n                >\n                  <span className=\"truncate\">\n                    {semestersLoading\n                      ? t('loading')\n                      : selectedSemester\n                      ? selectedSemester.code\n                      : t('all_semesters')}\n                  </span>\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent align=\"start\" className=\"w-[300px] p-0\">\n                <Command>\n                  <CommandInput placeholder={t('type_to_search_semester')} />\n                  <CommandList className=\"max-h-[300px] overflow-y-auto\">\n                    <CommandEmpty>\n                      {semestersLoading\n                        ? t('loading')\n                        : t('no_semester_found')}\n                    </CommandEmpty>\n                    <CommandGroup>\n                      <CommandItem\n                        value=\"all-semesters\"\n                        onSelect={() => {\n                          handleSemesterFilterChange(\"all\");\n                          setSemesterFilterOpen(false);\n                        }}\n                      >\n                        {t('all_semesters')}\n                      </CommandItem>\n                      {semesters.map((semester) => (\n                        <CommandItem\n                          key={semester.id}\n                          value={`${semester.code}-${semester.name}`}\n                          onSelect={() => {\n                            handleSemesterFilterChange(String(semester.id));\n                            setSemesterFilterOpen(false);\n                          }}\n                        >\n                          {semester.code} - {semester.name}\n                        </CommandItem>\n                      ))}\n                    </CommandGroup>\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Date Range Filters - Grouped */}\n          <div className=\"flex items-center gap-2 rounded-md border h-10 px-2 bg-background w-full sm:w-auto\">\n            {/* Start Date */}\n            <Popover open={startDateOpen} onOpenChange={setStartDateOpen}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  className={cn(\n                    \"h-8 justify-start text-left font-normal px-2 w-[100px]\",\n                    !startTimeFromParam && \"text-muted-foreground\"\n                  )}\n                >\n                  <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                  {startTimeFromParam\n                    ? format(new Date(startTimeFromParam), \"MMM d\")\n                    : t('start')}\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                <Calendar\n                  mode=\"single\"\n                  selected={\n                    startTimeFromParam\n                      ? new Date(startTimeFromParam)\n                      : undefined\n                  }\n                  onSelect={handleStartDateChange}\n                  autoFocus\n                />\n              </PopoverContent>\n            </Popover>\n\n            <div className=\"h-6 w-px bg-border\" />\n\n            {/* End Date */}\n            <Popover open={endDateOpen} onOpenChange={setEndDateOpen}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  className={cn(\n                    \"h-8 justify-start text-left font-normal px-2 w-[100px]\",\n                    !startTimeToParam && \"text-muted-foreground\"\n                  )}\n                >\n                  <CalendarIcon className=\"mr-2 h-4 w-4\" />\n                  {startTimeToParam\n                    ? format(new Date(startTimeToParam), \"MMM d\")\n                    : t('end')}\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-auto p-0\" align=\"start\">\n                <Calendar\n                  mode=\"single\"\n                  selected={\n                    startTimeToParam ? new Date(startTimeToParam) : undefined\n                  }\n                  onSelect={handleEndDateChange}\n                  autoFocus\n                />\n              </PopoverContent>\n            </Popover>\n\n            {/* Clear Date Range Button */}\n            <>\n              <div className=\"h-6 w-px bg-border\" />\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleClearDateRange}\n                className=\"h-8 px-2 text-xs\"\n              >\n                {t('clear')}\n              </Button>\n            </>\n          </div>\n\n          {/* Advanced Filters Button */}\n          <Popover\n            open={advancedFiltersOpen}\n            onOpenChange={setAdvancedFiltersOpen}\n          >\n            <PopoverTrigger asChild>\n              <Button variant=\"outline\" className=\"h-10 w-full sm:w-auto\">\n                <SlidersHorizontal className=\"mr-2 h-4 w-4\" />\n                {t('advanced_filters')}\n              </Button>\n            </PopoverTrigger>\n            <PopoverContent align=\"start\" className=\"w-[400px] p-4\">\n              <div className=\"space-y-4\">\n                <h4 className=\"font-medium text-sm\">{t('advanced_filters')}</h4>\n\n                {/* Room Filter */}\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm text-muted-foreground\">{t('room')}</label>\n                  <Popover\n                    open={roomFilterOpen}\n                    onOpenChange={setRoomFilterOpen}\n                  >\n                    <PopoverTrigger asChild>\n                      <Button\n                        variant=\"outline\"\n                        role=\"combobox\"\n                        className=\"w-full justify-between\"\n                        disabled={roomsLoading}\n                      >\n                        {roomsLoading\n                          ? t('loading')\n                          : selectedRoom\n                          ? selectedRoom.name\n                          : t('all_rooms')}\n                      </Button>\n                    </PopoverTrigger>\n                    <PopoverContent className=\"w-[350px] p-0\" align=\"start\">\n                      <Command>\n                        <CommandInput placeholder={t('type_to_search_room')} />\n                        <CommandList className=\"max-h-[200px] overflow-y-auto\">\n                          <CommandEmpty>\n                            {roomsLoading\n                              ? t('loading')\n                              : t('no_room_found')}\n                          </CommandEmpty>\n                          <CommandGroup>\n                            <CommandItem\n                              value=\"all-rooms\"\n                              onSelect={() => {\n                                handleRoomFilterChange(\"all\");\n                                setRoomFilterOpen(false);\n                              }}\n                            >\n                              {t('all_rooms')}\n                            </CommandItem>\n                            {rooms.map((room) => (\n                              <CommandItem\n                                key={room.id}\n                                value={`${room.name} ${room.location}`}\n                                onSelect={() => {\n                                  handleRoomFilterChange(String(room.id));\n                                  setRoomFilterOpen(false);\n                                }}\n                              >\n                                {room.name} - {room.location}\n                              </CommandItem>\n                            ))}\n                          </CommandGroup>\n                        </CommandList>\n                      </Command>\n                    </PopoverContent>\n                  </Popover>\n                </div>\n\n                {/* Sort Controls */}\n                <div className=\"space-y-2\">\n                  <label className=\"text-sm text-muted-foreground\">{tCommon('sort')}</label>\n                  <div className=\"flex gap-2\">\n                    <Select value={sortBy} onValueChange={handleSortByChange}>\n                      <SelectTrigger className=\"flex-1\">\n                        <SelectValue placeholder={tCommon('sort_by')} />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"startTime\">{tCommon('start_time')}</SelectItem>\n                        <SelectItem value=\"endTime\">{tCommon('end_time')}</SelectItem>\n                      </SelectContent>\n                    </Select>\n                    <Select\n                      value={sortOrder}\n                      onValueChange={handleSortOrderChange}\n                    >\n                      <SelectTrigger className=\"flex-1\">\n                        <SelectValue placeholder={tCommon('order')} />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"asc\">{tCommon('ascending')}</SelectItem>\n                        <SelectItem value=\"desc\">{tCommon('descending')}</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n\n                {/* Clear Advanced Filters Button */}\n                <div className=\"pt-2 border-t\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={handleClearAdvancedFilters}\n                    className=\"w-full\"\n                  >\n                    {t('clear_all_advanced_filters')}\n                  </Button>\n                </div>\n              </div>\n            </PopoverContent>\n          </Popover>\n        </div>\n      </div>\n\n      <SupervisorSlotTable\n        columns={columns}\n        data={slots}\n        isLoading={isLoading}\n        currentPage={currentPage}\n        totalPages={totalPages}\n        totalItems={totalItems}\n        pageSize={safePageSize}\n        onPageChange={handlePageChange}\n      />\n\n      {/* Exam Detail Dialog */}\n      {selectedSlot && (\n        <SupervisorExamDetailDialog\n          slot={selectedSlot}\n          open={isExamDetailOpen}\n          onClose={() => {\n            setIsExamDetailOpen(false);\n            setSelectedSlot(null);\n          }}\n        />\n      )}\n    </div>\n  );\n}\n\nexport default function SupervisorSlotsPage() {\n  return (\n    <Suspense fallback={<div>Loading...</div>}>\n      <SupervisorSlotsContent />\n    </Suspense>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\components\\providers\\app-providers.tsx",
      "relative_path": "components/providers/app-providers.tsx",
      "filename": "app-providers.tsx",
      "size_bytes": 931,
      "lines": 34,
      "last_modified": "2025-10-13T21:26:33.898657",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\nimport { QueryProvider } from \"./query-provider\";\nimport { ThemeProvider } from \"./theme-provider\";\nimport { GoogleOAuthProvider } from \"@react-oauth/google\";\n\nexport function AppProviders({ children }: { children: React.ReactNode }) {\n  const googleClientId = process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID;\n\n  const providersTree = (\n    <ThemeProvider\n      attribute=\"class\"\n      defaultTheme=\"system\"\n      enableSystem\n      disableTransitionOnChange\n    >\n      <QueryProvider>{children}</QueryProvider>\n    </ThemeProvider>\n  );\n\n  if (!googleClientId) {\n    if (process.env.NODE_ENV !== \"production\") {\n      console.warn(\n        \"NEXT_PUBLIC_GOOGLE_CLIENT_ID is not set. Google OAuth features will be disabled.\"\n      );\n    }\n    return providersTree;\n  }\n\n  return (\n    <GoogleOAuthProvider clientId={googleClientId}>\n      {providersTree}\n    </GoogleOAuthProvider>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\components\\shared\\app-header.tsx",
      "relative_path": "components/shared/app-header.tsx",
      "filename": "app-header.tsx",
      "size_bytes": 5926,
      "lines": 157,
      "last_modified": "2025-11-10T23:10:09.877573",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport { LogOut, Menu, ChevronRight } from \"lucide-react\";\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { ModeToggle } from \"@/components/mode-toggle\";\nimport { useRouter } from \"next/navigation\";\nimport { getAuthUser, clearAuthSession } from \"@/lib/auth\";\nimport { useState, useEffect } from \"react\";\nimport { useSidebar } from \"./sidebar-context\";\nimport { usePageHeader } from \"./page-header-context\";\nimport Link from \"next/link\";\nimport type { AuthenticatedUser } from \"@/types\";\nimport { LanguageSwitcher } from \"./language-switcher\";\n\nexport function AppHeader() {\n  const router = useRouter();\n  const { toggle } = useSidebar();\n  const { title, subtitle, breadcrumbs, actions } = usePageHeader();\n  const [user, setUser] = useState<AuthenticatedUser | null>(null);\n  const [mounted, setMounted] = useState(false);\n\n  useEffect(() => {\n    // Only access localStorage on client-side\n    setUser(getAuthUser());\n    setMounted(true);\n  }, []);\n\n  const handleLogout = () => {\n    clearAuthSession();\n    router.push(\"/login\");\n  };\n\n  // Get user initials for avatar fallback\n  const getUserInitials = () => {\n    if (!user?.username) return \"U\";\n    const parts = user.username.split(\"@\")[0].split(\".\");\n    if (parts.length >= 2) {\n      return (parts[0][0] + parts[1][0]).toUpperCase();\n    }\n    return user.username.substring(0, 2).toUpperCase();\n  };\n\n  return (\n    <header className=\"sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60\">\n      <div className=\"flex min-h-16 items-center justify-between px-4 md:px-6 py-3\">\n        {/* Left side - Hamburger + Title + Breadcrumbs */}\n        <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n          {/* Hamburger Menu (Mobile only) */}\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"lg:hidden flex-shrink-0\"\n            onClick={toggle}\n            aria-label=\"Toggle sidebar\"\n          >\n            <Menu className=\"h-5 w-5\" />\n          </Button>\n\n          {/* Title and Breadcrumbs */}\n          <div className=\"flex flex-col min-w-0\">\n            {breadcrumbs && breadcrumbs.length > 0 && (\n              <div className=\"flex items-center gap-1 text-xs md:text-sm text-muted-foreground flex-wrap\">\n                {breadcrumbs.map((crumb, index) => (\n                  <div key={index} className=\"flex items-center gap-1\">\n                    {crumb.href ? (\n                      <Link\n                        href={crumb.href}\n                        className=\"hover:text-foreground transition-colors truncate\"\n                      >\n                        {crumb.label}\n                      </Link>\n                    ) : (\n                      <span className=\"truncate\">{crumb.label}</span>\n                    )}\n                    {index < breadcrumbs.length - 1 && (\n                      <ChevronRight className=\"h-3 w-3 flex-shrink-0\" />\n                    )}\n                  </div>\n                ))}\n              </div>\n            )}\n            <h1 className=\"text-base md:text-lg font-semibold truncate\">\n              {title}\n            </h1>\n            {subtitle && (\n              <p className=\"text-xs md:text-sm text-muted-foreground truncate\">\n                {subtitle}\n              </p>\n            )}\n          </div>\n        </div>\n\n        {/* Middle - Page Actions (if any) */}\n        {actions && (\n          <div className=\"flex items-center gap-2 mx-4\">{actions}</div>\n        )}\n\n        {/* Right side - Actions */}\n        <div className=\"flex items-center gap-2 md:gap-3\">\n          {/* Language Switcher */}\n          <LanguageSwitcher />\n\n          {/* Theme Toggle */}\n          <ModeToggle />\n\n          {/* User Menu (render after mount to avoid SSR/client id mismatch) */}\n          {mounted && (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  className=\"relative h-9 md:h-10 gap-2 px-2\"\n                >\n                  <Avatar className=\"h-7 w-7 md:h-8 md:w-8\">\n                    <AvatarImage src=\"\" alt={user?.username || \"User\"} />\n                    <AvatarFallback className=\"text-xs\">\n                      {getUserInitials()}\n                    </AvatarFallback>\n                  </Avatar>\n                  <span className=\"hidden text-sm font-medium md:inline-block\">\n                    {user?.username || \"User\"}\n                  </span>\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent className=\"w-56\" align=\"end\" forceMount>\n                <DropdownMenuLabel className=\"font-normal\">\n                  <div className=\"flex flex-col space-y-1\">\n                    <p className=\"text-sm font-medium leading-none\">\n                      {user?.fullName || user?.username || \"User\"}\n                    </p>\n                    <p className=\"text-xs leading-none text-muted-foreground\">\n                      {user?.username || \"user\"}\n                    </p>\n                  </div>\n                </DropdownMenuLabel>\n                <DropdownMenuSeparator />\n                <DropdownMenuItem onClick={handleLogout}>\n                  <LogOut className=\"mr-2 h-4 w-4\" />\n                  <span>Log out</span>\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          )}\n        </div>\n      </div>\n    </header>\n  );\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\frontend-web\\components\\shared\\app-sidebar.tsx",
      "relative_path": "components/shared/app-sidebar.tsx",
      "filename": "app-sidebar.tsx",
      "size_bytes": 4733,
      "lines": 154,
      "last_modified": "2025-11-19T16:56:54.685369",
      "encoding": "utf-8",
      "language": "typescript-react",
      "content": "\"use client\";\n\nimport Link from \"next/link\";\nimport { usePathname, useSearchParams } from \"next/navigation\";\nimport { useTranslations } from 'next-intl';\nimport { useMemo } from 'react';\nimport { cn } from \"@/lib/utils\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { RoleMenuConfig, MenuSection, MenuItem } from \"@/types/navigation\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { RoleSwitcher } from \"./role-switcher\";\n\ninterface AppSidebarProps {\n  menuConfig: RoleMenuConfig;\n  className?: string;\n}\n\nexport function AppSidebar({ menuConfig, className }: AppSidebarProps) {\n  const pathname = usePathname();\n  const t = useTranslations('menu.roles');\n\n  const getRoleLabel = (role: string) => {\n    switch (role) {\n      case \"data-operator\":\n        return t('data_operator');\n      case \"lecturer\":\n        return t('lecturer');\n      case \"supervisor\":\n        return t('supervisor');\n      default:\n        return t('portal');\n    }\n  };\n\n  return (\n    <aside\n      className={cn(\n        \"flex h-screen w-64 flex-col border-r bg-background\",\n        className\n      )}\n    >\n      {/* Logo/Brand Header */}\n      <div className=\"border-b p-7\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"flex h-8 w-8 items-center justify-center rounded-md bg-primary text-primary-foreground\">\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                strokeWidth=\"2\"\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                className=\"h-4 w-4\"\n              >\n                <rect width=\"7\" height=\"7\" x=\"3\" y=\"3\" rx=\"1\" />\n                <rect width=\"7\" height=\"7\" x=\"14\" y=\"3\" rx=\"1\" />\n                <rect width=\"7\" height=\"7\" x=\"14\" y=\"14\" rx=\"1\" />\n                <rect width=\"7\" height=\"7\" x=\"3\" y=\"14\" rx=\"1\" />\n              </svg>\n            </div>\n            <div className=\"flex flex-col\">\n              <span className=\"text-sm font-semibold\">FUACS</span>\n              <span className=\"text-xs text-muted-foreground\">\n                {getRoleLabel(menuConfig.role)}\n              </span>\n            </div>\n          </div>\n\n          {/* Role Switcher */}\n          <RoleSwitcher />\n        </div>\n      </div>\n\n      {/* Navigation Menu */}\n      <ScrollArea className=\"flex-1 min-h-0 px-3 py-4\">\n        <nav className=\"space-y-6\">\n          {menuConfig.sections.map((section) => (\n            <SidebarSection\n              key={section.id}\n              section={section}\n              pathname={pathname}\n            />\n          ))}\n        </nav>\n      </ScrollArea>\n    </aside>\n  );\n}\n\ninterface SidebarSectionProps {\n  section: MenuSection;\n  pathname: string;\n}\n\nfunction SidebarSection({ section, pathname }: SidebarSectionProps) {\n  const t = useTranslations('menu.sections');\n\n  return (\n    <div className=\"space-y-1\">\n      <h3 className=\"px-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground\">\n        {t(section.id)}\n      </h3>\n      <div className=\"space-y-0.5\">\n        {section.items.map((item) => (\n          <SidebarMenuItem key={item.id} item={item} pathname={pathname} />\n        ))}\n      </div>\n    </div>\n  );\n}\n\ninterface SidebarMenuItemProps {\n  item: MenuItem;\n  pathname: string;\n}\n\nfunction SidebarMenuItem({ item, pathname }: SidebarMenuItemProps) {\n  const isActive = pathname === item.href;\n  const Icon = item.icon;\n  const t = useTranslations('menu.items');\n  const searchParams = useSearchParams();\n\n  // Preserve semesterId query param for dashboard routes to maintain filter state\n  const href = useMemo(() => {\n    if (item.href.includes('/dashboard')) {\n      const semesterId = searchParams.get('semesterId');\n      if (semesterId) {\n        return `${item.href}?semesterId=${semesterId}`;\n      }\n    }\n    return item.href;\n  }, [item.href, searchParams]);\n\n  return (\n    <Link\n      href={href}\n      className={cn(\n        \"flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors\",\n        \"hover:bg-accent hover:text-accent-foreground\",\n        isActive && \"bg-accent text-accent-foreground\"\n      )}\n    >\n      <Icon className=\"h-4 w-4 shrink-0\" />\n      <span className=\"flex-1\">{t(item.id)}</span>\n      {item.badge !== undefined && (\n        <Badge variant=\"destructive\" className=\"h-5 px-1.5 text-xs\">\n          {item.badge}\n        </Badge>\n      )}\n    </Link>\n  );\n}\n"
    }
  ]
}