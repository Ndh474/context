{
  "metadata": {
    "codebase": "backend",
    "category": "controller",
    "generated_at": "2025-11-28T09:26:36.228064",
    "total_files": 26,
    "total_lines": 3124,
    "total_bytes": 142013
  },
  "files": [
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\AdminUserController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/AdminUserController.java",
      "filename": "AdminUserController.java",
      "size_bytes": 2158,
      "lines": 53,
      "last_modified": "2025-11-28T08:56:32.959538",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.response.LecturerSemesterClassesDTO;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.UserRepository;\nimport com.fuacs.backend.service.LecturerService;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.*;\n\nimport java.util.List;\nimport java.util.Set;\n\n/**\n * Controller for admin operations on user data.\n * Allows admin to view lecturer/supervisor reports for any user.\n */\n@RestController\n@RequestMapping(\"/api/v1/admin/users\")\npublic class AdminUserController {\n\n    private final LecturerService lecturerService;\n    private final UserRepository userRepository;\n\n    public AdminUserController(LecturerService lecturerService,\n                               UserRepository userRepository) {\n        this.lecturerService = lecturerService;\n        this.userRepository = userRepository;\n    }\n\n    /**\n     * Get lecturer's semesters with classes by userId (for admin view).\n     * Returns hierarchical structure: semesters -> classes.\n     *\n     * @param userId The user ID of the lecturer\n     * @return List of semesters with nested classes\n     */\n    @GetMapping(\"/{userId}/lecturer-semesters-classes\")\n    @PreAuthorize(\"hasPermission(null, 'USER_READ_LIST')\")\n    public Response<List<LecturerSemesterClassesDTO>> getLecturerSemestersClasses(\n            @PathVariable Integer userId) {\n\n        // Validate user exists and has LECTURER role\n        userRepository.findUserByIdAndRoles(userId, Set.of(\"LECTURER\"))\n                .orElseThrow(() -> new ResourceNotFoundException(\n                        \"User not found or does not have LECTURER role\",\n                        ErrorCode.USER_NOT_FOUND));\n\n        List<LecturerSemesterClassesDTO> result = lecturerService.getLecturerSemestersWithClassesByUserId(userId);\n        return Response.ok(result, \"Lecturer semesters with classes retrieved successfully\");\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\AttendanceRecordController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/AttendanceRecordController.java",
      "filename": "AttendanceRecordController.java",
      "size_bytes": 3044,
      "lines": 65,
      "last_modified": "2025-11-28T08:56:32.959538",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.dto.request.AttendanceRecordSearchRequest;\nimport com.fuacs.backend.dto.request.AttendanceRecordUpdateRequest;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.AttendanceRecordDTO;\nimport com.fuacs.backend.service.AttendanceRecordService;\nimport jakarta.validation.Valid;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/attendance-records\")\npublic class AttendanceRecordController {\n\n    private final AttendanceRecordService attendanceRecordService;\n\n    public AttendanceRecordController(AttendanceRecordService attendanceRecordService) {\n        this.attendanceRecordService = attendanceRecordService;\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'ATTENDANCE_ROSTER_READ')\")\n    public PagingResponse<AttendanceRecordDTO> findAll(@Valid AttendanceRecordSearchRequest request) {\n        List<AttendanceRecordDTO> attendanceRecords = attendanceRecordService.findAll(request);\n        Long total = attendanceRecordService.count(request);\n        return PagingResponse.of(attendanceRecords, total, request);\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'ATTENDANCE_ROSTER_READ')\")\n    public Response<AttendanceRecordDTO> findById(@PathVariable Long id) {\n        return Response.ok(attendanceRecordService.findById(id));\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'ATTENDANCE_STATUS_UPDATE_MANUAL')\")\n    public Response<AttendanceRecordDTO> updateStatus(@PathVariable Long id,\n            @Valid @RequestBody AttendanceRecordUpdateRequest request) {\n        Integer currentUserId = com.fuacs.backend.util.SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        AttendanceRecordDTO updatedRecord = attendanceRecordService.updateStatus(id, request, currentUserId);\n        return Response.ok(updatedRecord);\n    }\n\n\n    // recognition-result endpoint moved to /api/v1/attendance per API docs\n\n    private boolean isValidApiKey(String apiKey) {\n        // TODO: Implement API key validation\n        // This would check against a configured API key in the system\n        return \"valid-api-key\".equals(apiKey);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\AuthenticationController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/AuthenticationController.java",
      "filename": "AuthenticationController.java",
      "size_bytes": 3219,
      "lines": 66,
      "last_modified": "2025-11-28T08:56:32.959538",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.dto.request.PasswordForgotRequest;\nimport com.fuacs.backend.dto.request.LoginGoogleRequest;\nimport com.fuacs.backend.dto.request.LoginRequest;\nimport com.fuacs.backend.dto.request.RefreshTokenRequest;\nimport com.fuacs.backend.dto.request.PasswordResetRequest;\nimport com.fuacs.backend.dto.request.PasswordUpdateRequest;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.TokenResponse;\nimport com.fuacs.backend.service.AuthenticationService;\nimport jakarta.validation.Valid;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RequestMapping(\"/api/v1\")\npublic class AuthenticationController {\n    private final AuthenticationService authenticationService;\n\n    public AuthenticationController(AuthenticationService authenticationService) {\n        this.authenticationService = authenticationService;\n    }\n\n    @PostMapping(\"/auth/login\")\n    public ResponseEntity<TokenResponse> login(@Valid @RequestBody LoginRequest request) {\n        return ResponseEntity.ok(authenticationService.login(request));\n    }\n\n    @PostMapping(\"/auth/google/login\")\n    public ResponseEntity<TokenResponse> googleLogin(@Valid @RequestBody LoginGoogleRequest request) {\n        return ResponseEntity.ok(authenticationService.googleLogin(request));\n    }\n\n    @PostMapping(\"/auth/refresh-token\")\n    public ResponseEntity<TokenResponse> refreshToken(@Valid @RequestBody RefreshTokenRequest request) {\n        return ResponseEntity.ok(authenticationService.refreshToken(request));\n    }\n\n    @PostMapping(\"/auth/forgot-password\")\n    //@RateLimiter(name = \"forgot-password\", fallbackMethod = \"tooManyRequests\")\n    public ResponseEntity<Response<String>> forgotPassword(@Valid @RequestBody PasswordForgotRequest request) {\n        return ResponseEntity.ok(Response.ok(authenticationService.forgotPassword(request)));\n    }\n\n    @PostMapping(\"/auth/reset-password\")\n    public ResponseEntity<Response<String>> resetPassword(@Valid @RequestBody PasswordResetRequest request) {\n        return ResponseEntity.ok(Response.ok(authenticationService.resetPassword(request)));\n    }\n\n    //TODO: Check user logged in\n    @PostMapping(\"/users/{id}/update-password\")\n    public ResponseEntity<Response<String>> updatePassword(@PathVariable Integer id,\n                                                           @Valid @RequestBody PasswordUpdateRequest request) {\n        return ResponseEntity.ok(Response.ok(authenticationService.updatePassword(id,request)));\n    }\n    //\n    //public ResponseEntity<String> tooManyRequests(PasswordForgotRequest request, RequestNotPermitted ex) {\n    //    return ResponseEntity.status(HttpStatus.TOO_MANY_REQUESTS)\n    //            .body(\"Too many reset requests. Please try again later for: \" + request.getEmail());\n    //}\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\CameraController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/CameraController.java",
      "filename": "CameraController.java",
      "size_bytes": 9248,
      "lines": 203,
      "last_modified": "2025-11-28T08:56:32.960543",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.CameraCreateRequest;\nimport com.fuacs.backend.dto.request.CameraSearchBaseRequest;\nimport com.fuacs.backend.dto.request.CameraUpdateRequest;\nimport com.fuacs.backend.dto.response.CameraConnectionTestResponse;\nimport com.fuacs.backend.dto.response.CameraDTO;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.CameraService;\nimport jakarta.validation.Valid;\nimport jakarta.validation.constraints.Max;\nimport jakarta.validation.constraints.Min;\nimport jakarta.validation.constraints.NotBlank;\nimport org.springframework.http.MediaType;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.util.List;\n\n/**\n * REST Controller xử lý các API endpoints cho Camera (camera IP trong phòng).\n * Cung cấp các endpoint sau:\n * - POST /api/v1/cameras - Tạo camera mới\n * - POST /api/v1/cameras/import - Nhập danh sách camera từ file CSV hàng loạt\n * - GET /api/v1/cameras - Tìm kiếm camera với filters (keyword, isActive, roomId, pagination, sorting)\n * - GET /api/v1/cameras/{id} - Lấy thông tin chi tiết của một camera theo ID\n * - PUT /api/v1/cameras/{id} - Cập nhật thông tin camera\n * - DELETE /api/v1/cameras/{id} - Xóa camera (nếu phòng không có active slot)\n *\n * Tất cả endpoints đều trả về Response object với format chuẩn:\n * - status: \"success\" hoặc \"error\"\n * - data: Dữ liệu trả về (CameraDTO, ImportResultDTO, PagingResponse)\n * - errors: Danh sách lỗi (nếu có)\n *\n * Validation được thực hiện tự động qua @Valid annotation trên request objects.\n *\n * @see CameraService\n * @see CameraDTO\n * @see Response\n * @see PagingResponse\n */\n@RestController\n@RequestMapping(\"/api/v1/cameras\")\npublic class CameraController {\n\n    private final CameraService cameraService;\n\n    /**\n     * Constructor injection cho CameraService dependency.\n     * Spring tự động inject service bean khi khởi tạo controller.\n     *\n     * @param cameraService Service xử lý business logic cho Camera\n     */\n    public CameraController(CameraService cameraService) {\n        this.cameraService = cameraService;\n    }\n\n    /**\n     * Tạo camera mới (kiểm tra name và rtspUrl unique, room tồn tại).\n     * POST /api/v1/cameras\n     *\n     * @param request Body: name (unique), rtspUrl (unique), roomId\n     * @return CameraDTO mới, 201 Created\n     * @throws ResourceExistsException nếu name hoặc rtspUrl trùng\n     * @throws ResourceNotFoundException nếu room không tồn tại\n     */\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'CAMERA_CREATE')\")\n    public Response<CameraDTO> create(@Valid @RequestBody CameraCreateRequest request) {\n        // Vd: {\"name\":\"CAM-305-Front\",\"rtspUrl\":\"rtsp://192.168.1.105:554/stream1\",\"roomId\":10} → tạo mới\n        // {\"name\":\"CAM-301-Front\"} đã tồn tại → 409 | rtspUrl trùng → 409 | roomId không tồn tại → 404\n        CameraDTO newCamera = cameraService.create(request);\n        return Response.created(newCamera);\n    }\n\n    /**\n     * Import camera từ CSV (partial success strategy).\n     * POST /api/v1/cameras/import\n     *\n     * @param file CSV file (name, rtspUrl, room_name)\n     * @param mode \"ADD_ONLY\" (skip trùng) hoặc \"ADD_AND_UPDATE\" (upsert)\n     * @return ImportResultDTO với successCount, failureCount, errors\n     * @throws BadRequestException nếu file rỗng hoặc mode invalid\n     */\n    @PostMapping(value = \"/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'CAMERA_IMPORT')\")\n    public Response<ImportResultDTO> importCameras(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        // Validate file - vd: null/rỗng → 400 FILE_REQUIRED\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        // Import CSV - vd: 10 dòng → 7 ok, 3 lỗi → 200 OK với chi tiết lỗi\n        ImportResultDTO result = cameraService.importFromCsv(file, mode);\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n\n    /**\n     * Tìm kiếm camera với filters và pagination.\n     * GET /api/v1/cameras\n     *\n     * @param request Filters: search, isActive, roomId, page, pageSize, sortBy, sort\n     * @return PagingResponse với CameraDTO list, totalItems, totalPages\n     */\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'CAMERA_READ')\")\n    public PagingResponse<CameraDTO> search(@Valid CameraSearchBaseRequest request) {\n        // Vd: ?search=301&isActive=true → tìm camera active có \"301\" (CAM-301-Front,CAM-301-Back)\n        List<CameraDTO> cameras = cameraService.search(request);\n        Long total = cameraService.count(request);\n        return PagingResponse.of(cameras, total, request);\n    }\n\n    /**\n     * Test kết nối camera RTSP (gọi Python recognition service).\n     * GET /api/v1/cameras/test-connection\n     *\n     * @param rtspUrl RTSP URL cần test (bắt buộc)\n     * @param timeout Timeout tính bằng giây (1-30, mặc định 10)\n     * @return Kết quả test: connected, frameRate, resolution, latency, stability\n     */\n    @GetMapping(\"/test-connection\")\n    @PreAuthorize(\"hasPermission(null,'CAMERA_READ')\")\n    public Response<CameraConnectionTestResponse> testConnection(\n            @RequestParam @NotBlank String rtspUrl,\n            @RequestParam(defaultValue = \"10\") @Min(1) @Max(30) Integer timeout) {\n        // Vd: ?rtspUrl=rtsp://192.168.1.100:554/stream1&timeout=10\n        // → {connected:true, frameRate:30.5, resolution:{width:1920,height:1080}, latency:150}\n        CameraConnectionTestResponse result = cameraService.testConnection(rtspUrl, timeout);\n        return Response.ok(result);\n    }\n\n    /**\n     * Lấy thông tin camera theo ID (kèm room info).\n     * GET /api/v1/cameras/{id}\n     *\n     * @param id ID camera\n     * @return CameraDTO với room info\n     * @throws ResourceNotFoundException nếu không tìm thấy\n     */\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'CAMERA_READ')\")\n    public Response<CameraDTO> findById(@PathVariable Short id) {\n        // Vd: GET /1 → {id:1, name:\"CAM-301-Front\", room:{id:5, name:\"301\"}}\n        return Response.ok(cameraService.findById(id));\n    }\n\n    /**\n     * Cập nhật thông tin camera (check name/rtspUrl unique khi đổi, check active slot khi tắt).\n     * PUT /api/v1/cameras/{id}\n     *\n     * @param id ID camera\n     * @param request Body: name, rtspUrl, roomId, isActive\n     * @return CameraDTO đã cập nhật\n     * @throws ResourceNotFoundException nếu camera hoặc room không tìm thấy\n     * @throws ResourceExistsException nếu đổi name/rtspUrl trùng camera khác\n     * @throws OperationNotAllowedException nếu tắt camera có active slot\n     */\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'CAMERA_UPDATE')\")\n    public Response<CameraDTO> update(@PathVariable Short id,\n            @Valid @RequestBody CameraUpdateRequest request) {\n        // Vd: PUT /1, {\"name\":\"CAM-301-Back\"} → ok | {\"name\":\"CAM-302-Front\"} trùng → 409\n        CameraDTO updatedCamera = cameraService.update(id, request);\n        return Response.ok(updatedCamera);\n    }\n\n    /**\n     * Xóa camera (hard delete - phải không có active slot trong phòng).\n     * DELETE /api/v1/cameras/{id}\n     *\n     * @param id ID camera\n     * @return Success message\n     * @throws ResourceNotFoundException nếu không tìm thấy\n     * @throws OperationNotAllowedException nếu phòng có active slot\n     */\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'CAMERA_DELETE_HARD')\")\n    public Response<Void> delete(@PathVariable Short id) {\n        // Vd: DELETE /10 không có active slot → ok | DELETE /1 phòng có slot → 400\n        cameraService.delete(id);\n        return Response.ok(\"Delete camera successfully\");\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\ClassController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/ClassController.java",
      "filename": "ClassController.java",
      "size_bytes": 9183,
      "lines": 198,
      "last_modified": "2025-11-28T08:56:32.960543",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.ClassCreateRequest;\nimport com.fuacs.backend.dto.request.ClassSearchRequest;\nimport com.fuacs.backend.dto.request.ClassUpdateRequest;\nimport com.fuacs.backend.dto.request.EnrollmentSearchRequest;\nimport com.fuacs.backend.dto.request.SlotSearchRequest;\nimport com.fuacs.backend.dto.response.ClassDTO;\nimport com.fuacs.backend.dto.response.ClassRosterDTO;\nimport com.fuacs.backend.dto.response.ClassSummaryDTO;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.SlotDTO;\nimport com.fuacs.backend.dto.response.StudentAttendanceSummaryDTO;\nimport com.fuacs.backend.dto.response.StudentProfileDTO;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.ClassService;\nimport com.fuacs.backend.service.ClassSummaryService;\nimport com.fuacs.backend.service.EnrollmentService;\nimport com.fuacs.backend.service.SlotService;\nimport jakarta.validation.Valid;\nimport org.springframework.data.domain.Page;\nimport org.springframework.data.domain.Pageable;\nimport org.springframework.http.MediaType;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/classes\")\npublic class ClassController {\n\n    private final ClassService classService;\n    private final SlotService slotService;\n    private final EnrollmentService enrollmentService;\n    private final ClassSummaryService classSummaryService;\n\n    public ClassController(ClassService classService,\n            SlotService slotService,\n            EnrollmentService enrollmentService,\n            ClassSummaryService classSummaryService) {\n        this.classService = classService;\n        this.slotService = slotService;\n        this.enrollmentService = enrollmentService;\n        this.classSummaryService = classSummaryService;\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public PagingResponse<ClassDTO> search(@Valid ClassSearchRequest request) {\n        List<ClassDTO> classes = classService.search(request);\n        Long total = classService.count(request);\n        return PagingResponse.of(classes, total, request);\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public Response<ClassDTO> findById(@PathVariable Short id) {\n        return Response.ok(classService.findById(id));\n    }\n\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'CLASS_CREATE')\")\n    public Response<ClassDTO> create(@Valid @RequestBody ClassCreateRequest request) {\n        ClassDTO newClass = classService.create(request);\n        return Response.created(newClass);\n    }\n\n    @PostMapping(value = \"/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'CLASS_IMPORT')\")\n    public Response<ImportResultDTO> importClasses(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        ImportResultDTO result = classService.importFromCsv(file, mode);\n\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_UPDATE')\")\n    public Response<ClassDTO> update(@PathVariable Short id,\n            @Valid @RequestBody ClassUpdateRequest request) {\n        ClassDTO updatedClass = classService.update(id, request);\n        return Response.ok(updatedClass);\n    }\n\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_DELETE_HARD')\")\n    public Response<Void> delete(@PathVariable Short id) {\n        classService.delete(id);\n        return Response.ok(\"Delete class successfully\");\n    }\n\n    @GetMapping(\"/{id}/slots\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public PagingResponse<SlotDTO> findAllSlotsByClass(@PathVariable Short id,\n            @Valid SlotSearchRequest request) {\n        List<SlotDTO> slots = slotService.searchByClassId(id, request);\n        Long total = slotService.countByClassId(id, request);\n        return PagingResponse.of(slots, total, request);\n    }\n\n    /**\n     * Get class roster with enrollment details.\n     * Returns list of enrolled and withdrawn students for this class.\n     * Note: This is separate from GET /classes/{id}/slots which returns class time\n     * slots.\n     */\n    @GetMapping(\"/{id}/enrollments\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public PagingResponse<StudentProfileDTO> getRosterByClassId(@PathVariable Short id,\n            @Valid EnrollmentSearchRequest request) {\n        ClassDTO classDTO = classService.getClassDetailsForRoster(id);\n        List<StudentProfileDTO> items = enrollmentService.findByClassId(id, request);\n        Long total = enrollmentService.countByClassId(id, request);\n        Long totalEnrolled = enrollmentService.countEnrolledByClassId(id);\n        Long totalWithdrawn = enrollmentService.countWithdrawnByClassId(id);\n        return new ClassRosterDTO(request, classDTO, items, total, totalEnrolled, totalWithdrawn);\n    }\n\n    /**\n     * Get comprehensive class summary including student lists, attendance records, and statistics.\n     * Returns detailed information about class enrollment, attendance patterns, and individual student data.\n     * Requires lecturer to be assigned to the class and valid semester parameter.\n     */\n    @GetMapping(\"/{classId}/summary\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public Response<ClassSummaryDTO> getClassSummary(@PathVariable Short classId,\n            @RequestParam Short semester) {\n        \n        // Validate required parameters with detailed error messages\n        if (classId == null || classId <= 0) {\n            throw new BadRequestException(\"Invalid class ID. Class ID is required and must be a positive number.\", ErrorCode.BAD_REQUEST);\n        }\n        \n        if (semester == null || semester <= 0) {\n            throw new BadRequestException(\"Invalid semester parameter. Semester ID is required and must be a positive number.\", ErrorCode.BAD_REQUEST);\n        }\n\n        // Delegate to service layer which handles authorization and business logic\n        ClassSummaryDTO classSummary = classSummaryService.getClassSummary(classId, semester);\n        return Response.ok(classSummary, \"Class summary retrieved successfully\");\n    }\n\n    /**\n     * Get paginated student attendance summaries.\n     * Supports search and sorting.\n     *\n     * @param classId Class identifier\n     * @param semester Semester identifier\n     * @param search Search query for name/roll number/email (optional)\n     * @param filter Reserved parameter (currently unused, kept for API compatibility)\n     * @param pageable Pagination parameters (page, size, sort)\n     * @return Page of StudentAttendanceSummaryDTO\n     */\n    @GetMapping(\"/{classId}/summary/students\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public Response<Page<StudentAttendanceSummaryDTO>> getClassSummaryStudents(\n        @PathVariable Short classId,\n        @RequestParam Short semester,\n        @RequestParam(required = false) String search,\n        @RequestParam(required = false, defaultValue = \"all\") String filter,\n        Pageable pageable) {\n\n        // Validate required parameters\n        if (classId == null || classId <= 0) {\n            throw new BadRequestException(\"Invalid class ID. Class ID is required and must be a positive number.\", ErrorCode.BAD_REQUEST);\n        }\n\n        if (semester == null || semester <= 0) {\n            throw new BadRequestException(\"Invalid semester parameter. Semester ID is required and must be a positive number.\", ErrorCode.BAD_REQUEST);\n        }\n\n        Page<StudentAttendanceSummaryDTO> students = classSummaryService.getClassSummaryStudents(\n            classId, semester, search, filter, pageable);\n        return Response.ok(students, \"Student attendance summaries retrieved successfully\");\n    }\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\DashboardController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/DashboardController.java",
      "filename": "DashboardController.java",
      "size_bytes": 6317,
      "lines": 125,
      "last_modified": "2025-11-28T08:56:32.960543",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.response.DataOperatorDashboardResponse;\nimport com.fuacs.backend.dto.response.LecturerDashboardResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.StudentDashboardResponse;\nimport com.fuacs.backend.dto.response.SupervisorDashboardResponse;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.DataOperatorDashboardService;\nimport com.fuacs.backend.service.LecturerDashboardService;\nimport com.fuacs.backend.service.StudentDashboardService;\nimport com.fuacs.backend.service.SupervisorDashboardService;\nimport com.fuacs.backend.util.SecurityUtil;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RequestMapping(\"/api/v1/dashboard\")\npublic class DashboardController {\n    private final StudentDashboardService studentDashboardService;\n    private final LecturerDashboardService lecturerDashboardService;\n    private final DataOperatorDashboardService dataOperatorDashboardService;\n    private final SupervisorDashboardService supervisorDashboardService;\n\n    public DashboardController(StudentDashboardService studentDashboardService, LecturerDashboardService lecturerDashboardService,\n                               DataOperatorDashboardService dataOperatorDashboardService,\n                               SupervisorDashboardService supervisorDashboardService) {\n        this.studentDashboardService = studentDashboardService;\n        this.lecturerDashboardService = lecturerDashboardService;\n        this.dataOperatorDashboardService = dataOperatorDashboardService;\n        this.supervisorDashboardService = supervisorDashboardService;\n    }\n\n    @GetMapping(\"/student\")\n    @PreAuthorize(\"hasPermission(null, 'DASHBOARD_VIEW_STUDENT')\")\n    public Response<StudentDashboardResponse> getDashboardData(\n            @RequestParam(required = false) Short semesterId) {\n        // Extract authenticated student ID from security context\n        // This ensures students can only access their own dashboard data\n        Integer currentUserId = SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new BadRequestException(\"UN_AUTHENTICATION\", ErrorCode.UN_AUTHENTICATION));\n\n        try {\n            // Call service to retrieve dashboard data for the authenticated student\n            StudentDashboardResponse dashboardData = studentDashboardService.getDashboardData(currentUserId, semesterId);\n\n            // Return properly formatted response using existing Response wrapper\n            return Response.ok(dashboardData, \"Student dashboard data retrieved successfully\");\n\n        } catch (BadRequestException e) {\n            // Re-throw BadRequestException as-is\n            throw e;\n        } catch (Exception e) {\n            // Handle unexpected errors\n            throw new BadRequestException(\"Failed to retrieve student dashboard data: \" + e.getMessage(), ErrorCode.UNKNOWN_ERROR);\n        }\n    }\n\n    @GetMapping(\"/lecturer\")\n    @PreAuthorize(\"hasPermission(null, 'DASHBOARD_VIEW_LECTURER')\")\n    public Response<LecturerDashboardResponse> getLecturerDashboard(\n            @RequestParam(required = false) Short semesterId) {\n        Integer currentUserId = SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new BadRequestException(\"UN_AUTHENTICATION\", ErrorCode.UN_AUTHENTICATION));\n        LecturerDashboardResponse dashboard = lecturerDashboardService.getDashboardData(currentUserId, semesterId);\n        return Response.ok(dashboard);\n    }\n\n    @GetMapping(\"/data-operator\")\n    @PreAuthorize(\"hasPermission(null, 'DASHBOARD_VIEW_DATA_OPERATOR')\")\n    public Response<DataOperatorDashboardResponse> getDataOperatorDashboard(\n            @RequestParam(required = false) Short semesterId) {\n\n        // Validate authentication\n        SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new BadRequestException(\"UN_AUTHENTICATION\", ErrorCode.UN_AUTHENTICATION));\n\n        // Basic parameter validation\n        if (semesterId != null && semesterId <= 0) {\n            throw new BadRequestException(\"Invalid semester ID. Semester ID must be positive\", ErrorCode.BAD_REQUEST);\n        }\n\n        try {\n            DataOperatorDashboardResponse dashboard = dataOperatorDashboardService.getDashboardData(semesterId);\n            return Response.ok(dashboard);\n        } catch (BadRequestException e) {\n            // Re-throw BadRequestException as-is\n            throw e;\n        } catch (Exception e) {\n            // Handle unexpected errors\n            throw new BadRequestException(\"Failed to retrieve dashboard data: \" + e.getMessage(), ErrorCode.UNKNOWN_ERROR);\n        }\n    }\n\n    @GetMapping(\"/supervisor\")\n    @PreAuthorize(\"hasPermission(null, 'DASHBOARD_VIEW_SUPERVISOR')\")\n    public Response<SupervisorDashboardResponse> getSupervisorDashboard(\n            @RequestParam(required = false) Short semesterId) {\n\n        // Validate authentication\n        Integer currentUserId = SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new BadRequestException(\"UN_AUTHENTICATION\", ErrorCode.UN_AUTHENTICATION));\n\n        // Basic parameter validation\n        if (semesterId != null && semesterId <= 0) {\n            throw new BadRequestException(\"Invalid semester ID. Semester ID must be positive\", ErrorCode.BAD_REQUEST);\n        }\n\n        try {\n            SupervisorDashboardResponse dashboard = supervisorDashboardService.getDashboardData(currentUserId, semesterId);\n            return Response.ok(dashboard);\n        } catch (BadRequestException e) {\n            // Re-throw BadRequestException as-is\n            throw e;\n        } catch (Exception e) {\n            // Handle unexpected errors\n            throw new BadRequestException(\"Failed to retrieve supervisor dashboard data: \" + e.getMessage(), ErrorCode.UNKNOWN_ERROR);\n        }\n    }\n}\n\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\EnrollmentController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/EnrollmentController.java",
      "filename": "EnrollmentController.java",
      "size_bytes": 5136,
      "lines": 116,
      "last_modified": "2025-11-28T08:56:32.960543",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.EnrollmentCreateRequest;\nimport com.fuacs.backend.dto.request.EnrollmentSearchRequest;\nimport com.fuacs.backend.dto.request.EnrollmentUpdateRequest;\nimport com.fuacs.backend.dto.response.BulkEnrollmentResponse;\nimport com.fuacs.backend.dto.response.EnrollmentDTO;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.ClassService;\nimport com.fuacs.backend.service.EnrollmentService;\nimport jakarta.validation.Valid;\nimport org.springframework.core.io.InputStreamResource;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.io.ByteArrayInputStream;\nimport java.nio.charset.StandardCharsets;\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/enrollments\")\npublic class EnrollmentController {\n\n    private final EnrollmentService enrollmentService;\n    private final ClassService classService;\n\n    public EnrollmentController(EnrollmentService enrollmentService, ClassService classService) {\n        this.enrollmentService = enrollmentService;\n        this.classService = classService;\n    }\n\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'ENROLLMENT_MANAGE')\")\n    public Response<EnrollmentDTO> create(@Valid @RequestBody EnrollmentCreateRequest request) {\n        EnrollmentDTO enrollment = enrollmentService.create(request);\n        return Response.created(enrollment);\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public PagingResponse<EnrollmentDTO> findAll(@Valid EnrollmentSearchRequest request) {\n        List<EnrollmentDTO> response = enrollmentService.search(request);\n        Long total = enrollmentService.count(request);\n        return PagingResponse.of(response, total, request);\n    }\n\n    @GetMapping(\"/{classId}/{studentUserId}\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public Response<EnrollmentDTO> findById(@PathVariable Short classId,\n            @PathVariable Integer studentUserId) {\n        return Response.ok(enrollmentService.findById(classId, studentUserId));\n    }\n\n    @PutMapping(\"/{classId}/{studentUserId}\")\n    @PreAuthorize(\"hasPermission(null,'ENROLLMENT_MANAGE')\")\n    public Response<EnrollmentDTO> update(@PathVariable Short classId,\n            @PathVariable Integer studentUserId,\n            @Valid @RequestBody EnrollmentUpdateRequest request) {\n        return Response.ok(enrollmentService.update(classId, studentUserId, request));\n    }\n\n    /**\n     * Delete enrollment (hard delete).\n     * Only allowed if class has not started any slots yet.\n     */\n    @DeleteMapping(\"/{classId}/{studentUserId}\")\n    @PreAuthorize(\"hasPermission(null,'ENROLLMENT_MANAGE')\")\n    public Response<Void> delete(@PathVariable Short classId,\n            @PathVariable Integer studentUserId) {\n        enrollmentService.delete(classId, studentUserId);\n        return Response.ok(\"Enrollment deleted successfully\");\n    }\n\n    /**\n     * Import enrollments from CSV file.\n     * Supports AddOnly and AddAndUpdate modes with partial success pattern.\n     * CSV format: student_id,class_code,semester_code\n     *\n     * @param file CSV file to import\n     * @param mode Import mode (\"AddOnly\" or \"AddAndUpdate\")\n     * @return ImportResultDTO with success/failure counts and error details\n     */\n    @PostMapping(value = \"/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'ENROLLMENT_MANAGE')\")\n    public Response<ImportResultDTO> importEnrollments(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        ImportResultDTO result = enrollmentService.importFromCsv(file, mode);\n\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\EvidenceController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/EvidenceController.java",
      "filename": "EvidenceController.java",
      "size_bytes": 5446,
      "lines": 136,
      "last_modified": "2025-11-28T08:56:32.961543",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.core.io.Resource;\nimport org.springframework.core.io.UrlResource;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\n\n/**\n * Controller for serving evidence images\n */\n@RestController\n@RequestMapping(\"/api/v1/evidence\")\npublic class EvidenceController {\n\n    private static final Logger log = LoggerFactory.getLogger(EvidenceController.class);\n    private static final String EVIDENCE_BASE_DIR = \"./uploads/evidence\";\n\n    /**\n     * Serve evidence image (new format)\n     * \n     * GET /api/v1/evidence/{slotId}/{filename}\n     * \n     * Example: GET /api/v1/evidence/9001/9001_SE123456.jpg\n     * \n     * Note: Public access allowed via SecurityConfig for image loading\n     */\n    @GetMapping(\"/{slotId}/{filename:.+}\")\n    public ResponseEntity<Resource> serveEvidenceImage(\n            @PathVariable Integer slotId,\n            @PathVariable String filename) {\n        \n        try {\n            // Construct file path\n            Path filePath = Paths.get(EVIDENCE_BASE_DIR, slotId.toString(), filename).normalize();\n            \n            // Security check: prevent path traversal\n            if (!filePath.startsWith(Paths.get(EVIDENCE_BASE_DIR).normalize())) {\n                return ResponseEntity.status(HttpStatus.FORBIDDEN).build();\n            }\n            \n            // Check if file exists\n            if (!Files.exists(filePath) || !Files.isRegularFile(filePath)) {\n                return ResponseEntity.notFound().build();\n            }\n            \n            return serveImageFile(filePath);\n            \n        } catch (Exception e) {\n            log.error(\"Error serving evidence image {}/{}: {}\", slotId, filename, e.getMessage(), e);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n    }\n\n    /**\n     * Serve evidence image (legacy format - backward compatibility)\n     * \n     * GET /api/v1/evidence/legacy/regular/{filename}\n     * GET /api/v1/evidence/legacy/exam/{filename}\n     * \n     * Example: GET /api/v1/evidence/legacy/regular/attendance_13_20251031_124223.jpg\n     * \n     * Note: Public access allowed via SecurityConfig for image loading\n     * \n     * @deprecated Use /{slotId}/{filename} format instead\n     */\n    @GetMapping(\"/legacy/{type}/{filename:.+}\")\n    public ResponseEntity<Resource> serveEvidenceImageLegacy(\n            @PathVariable String type,\n            @PathVariable String filename) {\n        \n        // Only allow 'regular' or 'exam' as type\n        if (!type.equals(\"regular\") && !type.equals(\"exam\")) {\n            return ResponseEntity.badRequest().build();\n        }\n        \n        try {\n            // Legacy format: ./uploads/evidence/{type}/{filename}\n            Path filePath = Paths.get(EVIDENCE_BASE_DIR, type, filename).normalize();\n            \n            // Security check: prevent path traversal\n            if (!filePath.startsWith(Paths.get(EVIDENCE_BASE_DIR).normalize())) {\n                return ResponseEntity.status(HttpStatus.FORBIDDEN).build();\n            }\n            \n            // Check if file exists\n            if (!Files.exists(filePath) || !Files.isRegularFile(filePath)) {\n                return ResponseEntity.notFound().build();\n            }\n            \n            return serveImageFile(filePath);\n            \n        } catch (Exception e) {\n            log.error(\"Error serving legacy evidence image {}/{}: {}\", type, filename, e.getMessage(), e);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n    }\n\n    /**\n     * Common method to serve image file\n     */\n    private ResponseEntity<Resource> serveImageFile(Path filePath) throws Exception {\n        Resource resource = new UrlResource(filePath.toUri());\n        \n        if (!resource.exists() || !resource.isReadable()) {\n            log.error(\"Evidence file not readable: {}\", filePath);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n        \n        // Determine content type\n        String contentType = Files.probeContentType(filePath);\n        if (contentType == null) {\n            contentType = MediaType.IMAGE_JPEG_VALUE; // Default to JPEG\n        }\n        \n        // Return image with appropriate headers\n        // Reduced cache TTL from 1 hour to 5 minutes for fresher evidence images\n        // Added must-revalidate to ensure browser checks with server when cache expires\n        return ResponseEntity.ok()\n                .contentType(MediaType.parseMediaType(contentType))\n                .header(HttpHeaders.CACHE_CONTROL, \"max-age=300, must-revalidate\") // Cache for 5 minutes + revalidate\n                .body(resource);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\ExamAttendanceController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/ExamAttendanceController.java",
      "filename": "ExamAttendanceController.java",
      "size_bytes": 2660,
      "lines": 57,
      "last_modified": "2025-11-28T08:56:32.961543",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.dto.request.ExamAttendanceUpdateRequest;\nimport com.fuacs.backend.dto.request.ExamAttendanceSearchRequest;\nimport com.fuacs.backend.dto.response.ExamAttendanceDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.service.ExamAttendanceService;\nimport com.fuacs.backend.util.SecurityUtil;\nimport jakarta.validation.Valid;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RequestMapping(\"/api/v1/exam-attendance\")\npublic class ExamAttendanceController {\n\n    private final ExamAttendanceService examAttendanceService;\n\n    public ExamAttendanceController(ExamAttendanceService examAttendanceService) {\n        this.examAttendanceService = examAttendanceService;\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'ATTENDANCE_ROSTER_READ')\")\n    public Response<ExamAttendanceDTO> findById(@PathVariable Long id) {\n        return Response.ok(examAttendanceService.findById(id));\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'ATTENDANCE_STATUS_UPDATE_MANUAL')\")\n    public Response<ExamAttendanceDTO> updateStatus(@PathVariable Long id,\n            @Valid @RequestBody ExamAttendanceUpdateRequest request) {\n        Integer currentUserId = SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        ExamAttendanceDTO updated = examAttendanceService.updateStatus(id, request, currentUserId);\n        return Response.ok(updated);\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'ATTENDANCE_ROSTER_READ')\")\n    public PagingResponse<ExamAttendanceDTO> findAll(@Valid ExamAttendanceSearchRequest request) {\n        java.util.List<ExamAttendanceDTO> items = examAttendanceService.findAll(request);\n        Long total = examAttendanceService.count(request);\n        return PagingResponse.of(items, total, request);\n    }\n\n\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\ExamSlotController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/ExamSlotController.java",
      "filename": "ExamSlotController.java",
      "size_bytes": 6900,
      "lines": 145,
      "last_modified": "2025-11-28T08:56:32.962544",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.dto.request.ExamSlotParticipantAllSearchRequest;\nimport com.fuacs.backend.dto.request.ExamSlotParticipantCreateRequest;\nimport com.fuacs.backend.dto.request.ExamSlotParticipantSearchRequest;\nimport com.fuacs.backend.dto.request.ExamSlotParticipantUpdateRequest;\nimport com.fuacs.backend.dto.request.ExamSlotSubjectAssignRequest;\nimport com.fuacs.backend.dto.request.PagedRequest;\nimport com.fuacs.backend.dto.response.ExamSlotParticipantDTO;\nimport com.fuacs.backend.dto.response.ExamSlotParticipantsAllResponse;\nimport com.fuacs.backend.dto.response.ExamSlotParticipantsResponse;\nimport com.fuacs.backend.dto.response.ExamSlotSubjectsResponse;\nimport com.fuacs.backend.dto.response.ExamAttendanceReportDTO;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.service.ExamSlotService;\nimport com.fuacs.backend.service.ExamAttendanceReportService;\nimport jakarta.validation.Valid;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RequestMapping(\"/api/v1/exam-slots\")\npublic class ExamSlotController {\n\n    private final ExamSlotService examSlotService;\n    private final ExamAttendanceReportService examAttendanceReportService;\n\n    public ExamSlotController(ExamSlotService examSlotService, \n                            ExamAttendanceReportService examAttendanceReportService) {\n        this.examSlotService = examSlotService;\n        this.examAttendanceReportService = examAttendanceReportService;\n    }\n\n    @PostMapping(\"/{slotId}/subjects\")\n    @PreAuthorize(\"hasPermission(null,'ENROLLMENT_MANAGE')\")\n    public Response<ExamSlotSubjectsResponse> assignSubjects(\n            @PathVariable Integer slotId,\n            @Valid @RequestBody ExamSlotSubjectAssignRequest request) {\n        ExamSlotSubjectsResponse response = examSlotService.assignSubjectsToSlot(slotId, request);\n        return Response.created(response);\n    }\n\n    @GetMapping(\"/{slotId}/subjects\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public Response<ExamSlotSubjectsResponse> getSubjects(@PathVariable Integer slotId) {\n        ExamSlotSubjectsResponse response = examSlotService.getSubjectsBySlotId(slotId);\n        return Response.ok(response);\n    }\n\n    @DeleteMapping(\"/{slotId}/subjects/{subjectId}\")\n    @PreAuthorize(\"hasPermission(null,'ENROLLMENT_MANAGE')\")\n    public Response<Void> removeSubject(\n            @PathVariable Integer slotId,\n            @PathVariable Integer subjectId,\n            Authentication authentication) {\n        Integer currentUserId = Integer.valueOf(authentication.getName());\n        examSlotService.removeSubjectFromSlot(slotId, subjectId, currentUserId);\n        return Response.ok(null);\n    }\n\n    @PostMapping(\"/{slotId}/participants\")\n    @PreAuthorize(\"hasPermission(null,'ENROLLMENT_MANAGE')\")\n    public Response<ExamSlotParticipantDTO> addParticipant(\n            @PathVariable Integer slotId,\n            @Valid @RequestBody ExamSlotParticipantCreateRequest request) {\n        ExamSlotParticipantDTO participant = examSlotService.addParticipant(slotId, request);\n\n        // Check if it's a re-enrollment case (status 200) or new enrollment (status\n        // 201)\n        // We can check createdAt vs updatedAt, but simpler to just return 201 for new\n        // The service will handle re-enrollment, we'll return appropriate status\n        return Response.created(participant);\n    }\n\n    @GetMapping(\"/{slotId}/participants\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public ExamSlotParticipantsResponse getParticipants(\n            @PathVariable Integer slotId,\n            @Valid ExamSlotParticipantSearchRequest request) {\n        return examSlotService.getParticipants(slotId, request);\n    }\n\n    /**\n     * Get ALL participants for an exam slot (across all subjects)\n     * @param slotId Exam slot ID\n     * @param request Paged request with optional filters\n     * @return Response with all participants (each item has subject info)\n     */\n    @GetMapping(\"/{slotId}/all-participants\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public ExamSlotParticipantsAllResponse getAllParticipants(\n            @PathVariable Integer slotId,\n            @Valid ExamSlotParticipantAllSearchRequest request) {\n        return examSlotService.getAllParticipants(slotId, request);\n    }\n\n    @GetMapping(\"/{slotId}/participants/{participantId}\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public Response<ExamSlotParticipantDTO> getParticipantById(\n            @PathVariable Integer slotId,\n            @PathVariable Long participantId) {\n        ExamSlotParticipantDTO participant = examSlotService.getParticipantById(slotId, participantId);\n        return Response.ok(participant);\n    }\n\n    @PutMapping(\"/{slotId}/participants/{participantId}\")\n    @PreAuthorize(\"hasPermission(null,'ENROLLMENT_MANAGE')\")\n    public Response<ExamSlotParticipantDTO> updateParticipant(\n            @PathVariable Integer slotId,\n            @PathVariable Long participantId,\n            @Valid @RequestBody ExamSlotParticipantUpdateRequest request) {\n        ExamSlotParticipantDTO participant = examSlotService.updateParticipant(slotId, participantId, request);\n        return Response.ok(participant);\n    }\n\n    /**\n     * Remove a participant from exam slot\n     * @param slotId Exam slot ID\n     * @param participantId Participant ID to remove\n     * @return Success response\n     */\n    @DeleteMapping(\"/{slotId}/participants/{participantId}\")\n    @PreAuthorize(\"hasPermission(null,'ENROLLMENT_MANAGE')\")\n    public Response<Void> removeParticipant(\n            @PathVariable Integer slotId,\n            @PathVariable Long participantId) {\n        examSlotService.removeParticipant(slotId, participantId);\n        return Response.ok(\"Participant removed successfully\");\n    }\n\n    @GetMapping(\"/{slotId}/attendance-report\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public Response<ExamAttendanceReportDTO> getAttendanceReport(@PathVariable Integer slotId) {\n        ExamAttendanceReportDTO report = examAttendanceReportService.getExamAttendanceReport(slotId);\n        return Response.ok(report);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\ExamSlotImportController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/ExamSlotImportController.java",
      "filename": "ExamSlotImportController.java",
      "size_bytes": 2071,
      "lines": 49,
      "last_modified": "2025-11-28T08:56:32.962544",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.ExamSlotImportService;\n// import org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.http.MediaType;\nimport org.springframework.web.bind.annotation.*;\nimport org.springframework.web.multipart.MultipartFile;\n\n@RestController\n@RequestMapping(\"/api/v1\")\npublic class ExamSlotImportController {\n\n    private final ExamSlotImportService examSlotImportService;\n\n    public ExamSlotImportController(ExamSlotImportService examSlotImportService) {\n        this.examSlotImportService = examSlotImportService;\n    }\n\n    /**\n     * Import exam slot participants from CSV file.\n     * Adds students to specific exam slots and subjects identified by natural keys.\n     * CSV format: semester_code,start_time,room_name,subject_code,roll_number\n     *\n     * @param file CSV file to import\n     * @param mode Import mode (\"AddOnly\" or \"AddAndUpdate\")\n     * @return ImportResultDTO with success/failure counts and error details\n     */\n    @PostMapping(value = \"/exam-slot-participants/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    // @PreAuthorize(\"hasPermission(null,'ENROLLMENT_MANAGE')\")\n    public Response<ImportResultDTO> importExamSlotParticipants(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        ImportResultDTO result = examSlotImportService.importParticipantsFromCsv(file, mode);\n\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\ExportController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/ExportController.java",
      "filename": "ExportController.java",
      "size_bytes": 5808,
      "lines": 121,
      "last_modified": "2025-11-28T08:56:32.962544",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.dto.request.ExportClassesRequest;\nimport com.fuacs.backend.dto.request.ExportSlotsRequest;\nimport com.fuacs.backend.service.ExportService;\nimport jakarta.validation.Valid;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.core.io.InputStreamResource;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.*;\n\nimport java.io.ByteArrayInputStream;\nimport java.io.ByteArrayOutputStream;\nimport java.time.LocalDateTime;\nimport java.time.format.DateTimeFormatter;\n\n@RestController\n@RequestMapping(\"/api/v1/export\")\npublic class ExportController {\n\n    private static final Logger logger = LoggerFactory.getLogger(ExportController.class);\n    private static final DateTimeFormatter FILE_DATE_FORMAT = DateTimeFormatter.ofPattern(\"yyyy-MM-dd_HHmm\");\n\n    private final ExportService exportService;\n\n    public ExportController(ExportService exportService) {\n        this.exportService = exportService;\n    }\n\n    /**\n     * Export classes to Excel format\n     * Returns an Excel file containing class overview and attendance matrix for each class\n     */\n    @PostMapping(\"/classes/excel\")\n    @PreAuthorize(\"hasAuthority('REPORT_EXPORT_ACADEMIC_DATA')\")\n    public ResponseEntity<InputStreamResource> exportClassesToExcel(\n            @Valid @RequestBody ExportClassesRequest request) {\n\n        logger.info(\"Export classes to Excel - semesterId: {}, exportAll: {}, ids: {}\",\n                request.getSemesterId(), request.getExportAll(), request.getIds());\n\n        ByteArrayOutputStream out = exportService.exportClassesToExcel(request);\n        String filename = \"Classes_Export_\" + LocalDateTime.now().format(FILE_DATE_FORMAT) + \".xlsx\";\n\n        return ResponseEntity.ok()\n                .header(HttpHeaders.CONTENT_DISPOSITION, \"attachment; filename=\\\"\" + filename + \"\\\"\")\n                .contentType(MediaType.parseMediaType(\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"))\n                .contentLength(out.size())\n                .body(new InputStreamResource(new ByteArrayInputStream(out.toByteArray())));\n    }\n\n    /**\n     * Export classes to CSV format (ZIP file containing multiple CSVs)\n     * Returns a ZIP file with overview CSV and one CSV per class\n     */\n    @PostMapping(\"/classes/csv\")\n    @PreAuthorize(\"hasAuthority('REPORT_EXPORT_ACADEMIC_DATA')\")\n    public ResponseEntity<InputStreamResource> exportClassesToCsv(\n            @Valid @RequestBody ExportClassesRequest request) {\n\n        logger.info(\"Export classes to CSV - semesterId: {}, exportAll: {}, ids: {}\",\n                request.getSemesterId(), request.getExportAll(), request.getIds());\n\n        ByteArrayOutputStream out = exportService.exportClassesToCsvZip(request);\n        String filename = \"Classes_Export_\" + LocalDateTime.now().format(FILE_DATE_FORMAT) + \".zip\";\n\n        return ResponseEntity.ok()\n                .header(HttpHeaders.CONTENT_DISPOSITION, \"attachment; filename=\\\"\" + filename + \"\\\"\")\n                .contentType(MediaType.parseMediaType(\"application/zip\"))\n                .contentLength(out.size())\n                .body(new InputStreamResource(new ByteArrayInputStream(out.toByteArray())));\n    }\n\n    /**\n     * Export exam slots to Excel format\n     * Returns an Excel file containing exam slot overview and attendance details for each slot\n     */\n    @PostMapping(\"/slots/excel\")\n    @PreAuthorize(\"hasAuthority('REPORT_EXPORT_ACADEMIC_DATA')\")\n    public ResponseEntity<InputStreamResource> exportExamSlotsToExcel(\n            @Valid @RequestBody ExportSlotsRequest request) {\n\n        logger.info(\"Export exam slots to Excel - semesterId: {}, exportAll: {}, ids: {}\",\n                request.getSemesterId(), request.getExportAll(), request.getIds());\n\n        ByteArrayOutputStream out = exportService.exportExamSlotsToExcel(request);\n        String filename = \"ExamSlots_Export_\" + LocalDateTime.now().format(FILE_DATE_FORMAT) + \".xlsx\";\n\n        return ResponseEntity.ok()\n                .header(HttpHeaders.CONTENT_DISPOSITION, \"attachment; filename=\\\"\" + filename + \"\\\"\")\n                .contentType(MediaType.parseMediaType(\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"))\n                .contentLength(out.size())\n                .body(new InputStreamResource(new ByteArrayInputStream(out.toByteArray())));\n    }\n\n    /**\n     * Export exam slots to CSV format (ZIP file containing multiple CSVs)\n     * Returns a ZIP file with overview CSV and one CSV per exam slot\n     */\n    @PostMapping(\"/slots/csv\")\n    @PreAuthorize(\"hasAuthority('REPORT_EXPORT_ACADEMIC_DATA')\")\n    public ResponseEntity<InputStreamResource> exportExamSlotsToCsv(\n            @Valid @RequestBody ExportSlotsRequest request) {\n\n        logger.info(\"Export exam slots to CSV - semesterId: {}, exportAll: {}, ids: {}\",\n                request.getSemesterId(), request.getExportAll(), request.getIds());\n\n        ByteArrayOutputStream out = exportService.exportExamSlotsToCsvZip(request);\n        String filename = \"ExamSlots_Export_\" + LocalDateTime.now().format(FILE_DATE_FORMAT) + \".zip\";\n\n        return ResponseEntity.ok()\n                .header(HttpHeaders.CONTENT_DISPOSITION, \"attachment; filename=\\\"\" + filename + \"\\\"\")\n                .contentType(MediaType.parseMediaType(\"application/zip\"))\n                .contentLength(out.size())\n                .body(new InputStreamResource(new ByteArrayInputStream(out.toByteArray())));\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\LecturerController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/LecturerController.java",
      "filename": "LecturerController.java",
      "size_bytes": 3001,
      "lines": 67,
      "last_modified": "2025-11-28T08:56:32.962544",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.response.ClassDTO;\nimport com.fuacs.backend.dto.response.LecturerSemesterClassesDTO;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.SemesterDTO;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.LecturerService;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/lecturer\")\npublic class LecturerController {\n\n    private final LecturerService lecturerService;\n\n    public LecturerController(LecturerService lecturerService) {\n        this.lecturerService = lecturerService;\n    }\n\n    /**\n     * Get all semesters where the authenticated lecturer has assigned classes.\n     * Returns list of semesters that contain classes taught by the current lecturer.\n     */\n    @GetMapping(\"/semesters\")\n    @PreAuthorize(\"hasPermission(null,'LECTURER_READ')\")\n    public Response<List<SemesterDTO>> getLecturerSemesters() {\n        List<SemesterDTO> semesters = lecturerService.getLecturerSemesters();\n        return Response.ok(semesters, \"Lecturer semesters retrieved successfully\");\n    }\n\n    /**\n     * Get all classes assigned to the authenticated lecturer in a specific semester.\n     * Returns list of classes that the lecturer teaches in the given semester.\n     */\n    @GetMapping(\"/classes\")\n    @PreAuthorize(\"hasPermission(null,'LECTURER_READ')\")\n    public Response<List<ClassDTO>> getLecturerClasses(@RequestParam Short semesterId) {\n        \n        // Validate required parameters\n        if (semesterId == null || semesterId <= 0) {\n            throw new BadRequestException(\"Invalid semester ID. Semester ID is required and must be a positive number.\", ErrorCode.BAD_REQUEST);\n        }\n\n        List<ClassDTO> classes = lecturerService.getLecturerClasses(semesterId);\n        return Response.ok(classes, \"Lecturer classes retrieved successfully\");\n    }\n\n    /**\n     * Get all semesters with their associated classes for the authenticated lecturer.\n     * Returns hierarchical structure: semesters -> classes.\n     * Ordered by semester start date (newest first), then by class code.\n     */\n    @GetMapping(\"/semesters-classes\")\n    @PreAuthorize(\"hasPermission(null,'LECTURER_READ')\")\n    public Response<List<LecturerSemesterClassesDTO>> getLecturerSemestersWithClasses() {\n        List<LecturerSemesterClassesDTO> semestersWithClasses = lecturerService.getLecturerSemestersWithClasses();\n        return Response.ok(semestersWithClasses, \"Lecturer semesters with classes retrieved successfully\");\n    }\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\MajorController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/MajorController.java",
      "filename": "MajorController.java",
      "size_bytes": 4940,
      "lines": 117,
      "last_modified": "2025-11-28T08:56:32.962544",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.MajorCreateRequest;\nimport com.fuacs.backend.dto.request.MajorSearchRequest;\nimport com.fuacs.backend.dto.request.MajorUpdateRequest;\nimport com.fuacs.backend.dto.request.SubjectSearchRequest;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.MajorDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.SubjectDTO;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.MajorService;\nimport com.fuacs.backend.service.SubjectService;\nimport jakarta.validation.Valid;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.multipart.MultipartFile;\nimport org.springframework.http.MediaType;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/majors\")\npublic class MajorController {\n\n    private final MajorService majorService;\n    private final SubjectService subjectService;\n\n    public MajorController(MajorService majorService,\n            SubjectService subjectService) {\n        this.majorService = majorService;\n        this.subjectService = subjectService;\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'MAJOR_READ')\")\n    public PagingResponse<MajorDTO> findAll(@Valid MajorSearchRequest request) {\n        List<MajorDTO> majors = majorService.search(request);\n        Long total = majorService.count(request);\n        return PagingResponse.of(majors, total, request);\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'MAJOR_READ')\")\n    public Response<MajorDTO> findById(@PathVariable Short id) {\n        return Response.ok(majorService.findById(id));\n    }\n\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'MAJOR_CREATE')\")\n    public Response<MajorDTO> create(@Valid @RequestBody MajorCreateRequest request) {\n        MajorDTO newMajor = majorService.create(request);\n        return Response.created(newMajor);\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'MAJOR_UPDATE')\")\n    public Response<MajorDTO> update(@PathVariable Short id,\n            @Valid @RequestBody MajorUpdateRequest request) {\n        MajorDTO updatedMajor = majorService.update(id, request);\n        return Response.ok(updatedMajor);\n    }\n\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'MAJOR_DELETE_HARD')\")\n    public Response<Void> delete(@PathVariable Short id) {\n        majorService.delete(id);\n        return Response.ok(\"Delete major successfully\");\n    }\n\n    @GetMapping(\"/{id}/subjects\")\n    @PreAuthorize(\"hasPermission(null,'SUBJECT_READ')\")\n    public PagingResponse<SubjectDTO> findAllByMajor(@PathVariable Short id, @Valid SubjectSearchRequest request) {\n        List<SubjectDTO> subjects = subjectService.searchByMajorId(id, request);\n        Long total = subjectService.countByMajorId(id, request);\n        return PagingResponse.of(subjects, total, request);\n    }\n\n    /**\n     * Import majors from CSV file.\n     * Supports AddOnly and AddAndUpdate modes with partial success pattern.\n     * CSV format: code,name[,status]\n     * - status optional; if provided uses the value, missing/empty defaults to true\n     * on create\n     *\n     * @param file CSV file to import\n     * @param mode Import mode (\"AddOnly\" or \"AddAndUpdate\")\n     * @return ImportResultDTO with success/failure counts and error details\n     */\n    @PostMapping(value = \"/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'MAJOR_IMPORT')\")\n    public Response<ImportResultDTO> importMajors(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        ImportResultDTO result = majorService.importFromCsv(file, mode);\n\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\PermissionController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/PermissionController.java",
      "filename": "PermissionController.java",
      "size_bytes": 2952,
      "lines": 69,
      "last_modified": "2025-11-28T08:56:32.963542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.dto.request.PermissionCreateRequest;\nimport com.fuacs.backend.dto.request.PermissionSearchRequest;\nimport com.fuacs.backend.dto.request.PermissionUpdateRequest;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.PermissionDTO;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.service.PermissionService;\nimport jakarta.validation.Valid;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/permissions\")\npublic class PermissionController {\n\n    private final PermissionService permissionService;\n\n    public PermissionController(PermissionService permissionService) {\n        this.permissionService = permissionService;\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'PERMISSION_READ')\")\n    public PagingResponse<PermissionDTO> findAll(@Valid PermissionSearchRequest request) {\n        List<PermissionDTO> permissions = permissionService.findAll(request);\n        Long total = permissionService.countAll(request.getSearch());\n        return PagingResponse.of(permissions, total, request);\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'PERMISSION_READ')\")\n    public Response<PermissionDTO> findById(@PathVariable Short id) {\n        PermissionDTO permission = permissionService.findById(id);\n        return Response.ok(permission);\n    }\n\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'PERMISSION_CREATE')\")\n    public Response<PermissionDTO> create(@Valid @RequestBody PermissionCreateRequest request) {\n        PermissionDTO newPermission = permissionService.create(request);\n        return Response.created(newPermission);\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'PERMISSION_UPDATE')\")\n    public Response<PermissionDTO> update(@PathVariable Short id,\n            @Valid @RequestBody PermissionUpdateRequest request) {\n        PermissionDTO updatedPermission = permissionService.update(id, request);\n        return Response.ok(updatedPermission);\n    }\n\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'PERMISSION_DELETE')\")\n    public Response<Void> delete(@PathVariable Short id) {\n        permissionService.delete(id);\n        return Response.ok(\"Delete permission successfully\");\n    }\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\RecognitionController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/RecognitionController.java",
      "filename": "RecognitionController.java",
      "size_bytes": 3298,
      "lines": 70,
      "last_modified": "2025-11-28T08:56:32.963542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.config.PythonBackendConfig;\nimport com.fuacs.backend.dto.request.RecognitionResultRequest;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.service.AttendanceRecordService;\nimport com.fuacs.backend.service.ExamAttendanceService;\nimport jakarta.validation.Valid;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestHeader;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.Map;\n\n@RestController\n@RequestMapping(\"/api/v1/attendance\")\npublic class RecognitionController {\n\n    private static final Logger logger = LoggerFactory.getLogger(RecognitionController.class);\n\n    private final AttendanceRecordService attendanceRecordService;\n    private final ExamAttendanceService examAttendanceService;\n    private final PythonBackendConfig pythonBackendConfig;\n\n    public RecognitionController(AttendanceRecordService attendanceRecordService,\n            ExamAttendanceService examAttendanceService,\n            PythonBackendConfig pythonBackendConfig) {\n        this.attendanceRecordService = attendanceRecordService;\n        this.examAttendanceService = examAttendanceService;\n        this.pythonBackendConfig = pythonBackendConfig;\n    }\n\n    @PostMapping(\"/recognition-result\")\n    public Response<Map<String, Object>> processRecognitionResults(@Valid @RequestBody RecognitionResultRequest request,\n            @RequestHeader(value = \"X-API-Key\", required = false) String apiKey) {\n        if (apiKey == null || !isValidApiKey(apiKey)) {\n            return Response.unauthorized(\"Invalid or missing API key\");\n        }\n\n        // Get callback type (default to REGULAR for backward compatibility)\n        String callbackType = request.getCallbackType() != null ? request.getCallbackType() : \"REGULAR\";\n\n        logger.info(\"Received recognition callback: slotId={}, callbackType={}, recognitions={}\",\n                request.getSlotId(), callbackType, request.getRecognitions().size());\n\n        // Route to correct service based on callback type\n        Map<String, Object> result;\n        if (\"EXAM\".equalsIgnoreCase(callbackType)) {\n            // Route to exam_attendance table\n            result = examAttendanceService.processRecognitionResults(request);\n            logger.info(\"Routed to exam_attendance table: slotId={}, processed={} recognitions\",\n                    request.getSlotId(), request.getRecognitions().size());\n        } else {\n            // Default: Route to attendance_records table (backward compatibility)\n            result = attendanceRecordService.processRecognitionResults(request);\n            logger.info(\"Routed to attendance_records table: slotId={}, processed={} recognitions\",\n                    request.getSlotId(), request.getRecognitions().size());\n        }\n\n        return Response.ok(result);\n    }\n\n    private boolean isValidApiKey(String apiKey) {\n        return pythonBackendConfig.getApiKey().equals(apiKey);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\RoleController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/RoleController.java",
      "filename": "RoleController.java",
      "size_bytes": 2685,
      "lines": 69,
      "last_modified": "2025-11-28T08:56:32.963542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.dto.request.RoleCreateRequest;\nimport com.fuacs.backend.dto.request.RoleSearchRequest;\nimport com.fuacs.backend.dto.request.RoleUpdateRequest;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.RoleDTO;\nimport com.fuacs.backend.service.RoleService;\nimport jakarta.validation.Valid;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/roles\")\npublic class RoleController {\n\n    private final RoleService roleService;\n\n    public RoleController(RoleService roleService) {\n        this.roleService = roleService;\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'ROLE_READ')\")\n    public PagingResponse<RoleDTO> findAll(@Valid RoleSearchRequest request) {\n        List<RoleDTO> roles = roleService.findAll(request);\n        Long total = roleService.countAll(request);\n        return PagingResponse.of(roles, total, request);\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'ROLE_READ')\")\n    public Response<RoleDTO> findById(@PathVariable Short id) {\n        RoleDTO role = roleService.findById(id);\n        return Response.ok(role);\n    }\n\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'ROLE_CREATE')\")\n    public Response<RoleDTO> create(@Valid @RequestBody RoleCreateRequest request) {\n        RoleDTO newRole = roleService.create(request);\n        return Response.created(newRole);\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'ROLE_UPDATE')\")\n    public Response<RoleDTO> update(@PathVariable Short id,\n            @Valid @RequestBody RoleUpdateRequest request) {\n        RoleDTO updatedRole = roleService.update(id, request);\n        return Response.ok(updatedRole);\n    }\n\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'ROLE_DELETE_HARD')\")\n    public Response<Void> deactivateRole(@PathVariable Short id) {\n        roleService.delete(id);\n        return Response.ok(\"Delete role successfully\");\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\RoomController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/RoomController.java",
      "filename": "RoomController.java",
      "size_bytes": 10590,
      "lines": 238,
      "last_modified": "2025-11-28T08:56:32.963542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.CameraSearchBaseRequest;\nimport com.fuacs.backend.dto.request.RoomCreateRequest;\nimport com.fuacs.backend.dto.request.RoomSearchRequest;\nimport com.fuacs.backend.dto.request.RoomUpdateRequest;\nimport com.fuacs.backend.dto.request.SlotSearchRequest;\nimport com.fuacs.backend.dto.response.CameraDTO;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.RoomDTO;\nimport com.fuacs.backend.dto.response.RoomCamerasResponse;\nimport com.fuacs.backend.dto.response.RoomSlotsResponse;\nimport com.fuacs.backend.dto.response.SlotDTO;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.CameraService;\nimport com.fuacs.backend.service.RoomService;\nimport com.fuacs.backend.service.SlotService;\nimport jakarta.validation.Valid;\nimport org.springframework.http.MediaType;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.util.List;\n\n/**\n * REST Controller xử lý các API endpoints cho Room (phòng học/thi).\n * Cung cấp các endpoint sau:\n * - POST /api/v1/rooms - Tạo phòng mới\n * - POST /api/v1/rooms/import - Nhập danh sách phòng từ file CSV hàng loạt\n * - GET /api/v1/rooms - Tìm kiếm phòng với filters (keyword, isActive, hasCamera, pagination, sorting)\n * - GET /api/v1/rooms/{id} - Lấy thông tin chi tiết của một phòng theo ID\n * - PUT /api/v1/rooms/{id} - Cập nhật thông tin phòng\n * - DELETE /api/v1/rooms/{id} - Xóa phòng (nếu không có camera hoặc slot liên kết)\n * - GET /api/v1/rooms/{id}/cameras - Lấy danh sách camera của phòng\n * - GET /api/v1/rooms/{id}/slots - Lấy danh sách slot của phòng\n *\n * Tất cả endpoints đều trả về Response object với format chuẩn:\n * - status: \"success\" hoặc \"error\"\n * - data: Dữ liệu trả về (RoomDTO, ImportResultDTO, PagingResponse, v.v.)\n * - errors: Danh sách lỗi (nếu có)\n *\n * Validation được thực hiện tự động qua @Valid annotation trên request objects.\n *\n * @see RoomService\n * @see RoomDTO\n * @see Response\n * @see PagingResponse\n */\n@RestController\n@RequestMapping(\"/api/v1/rooms\")\npublic class RoomController {\n\n    private final RoomService roomService;\n    private final CameraService cameraService;\n    private final SlotService slotService;\n\n    /**\n     * Constructor injection cho các service dependencies.\n     * Spring tự động inject các service beans khi khởi tạo controller.\n     *\n     * @param roomService Service xử lý business logic cho Room\n     * @param cameraService Service xử lý Camera (dùng cho endpoint GET /{id}/cameras)\n     * @param slotService Service xử lý Slot (dùng cho endpoint GET /{id}/slots)\n     */\n    public RoomController(RoomService roomService,\n            CameraService cameraService,\n            SlotService slotService) {\n        this.roomService = roomService;\n        this.cameraService = cameraService;\n        this.slotService = slotService;\n    }\n\n    /**\n     * Tạo phòng mới (kiểm tra tên unique).\n     * POST /api/v1/rooms\n     *\n     * @param request Body: name (unique), location\n     * @return RoomDTO mới, 201 Created\n     * @throws ResourceExistsException nếu tên trùng\n     */\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'ROOM_CREATE')\")\n    public Response<RoomDTO> create(@Valid @RequestBody RoomCreateRequest request) {\n        // Vd: {\"name\":\"305\",\"location\":\"Tầng 3\"} → tạo mới | {\"name\":\"301\"} đã tồn tại → 409\n        RoomDTO newRoom = roomService.create(request);\n        return Response.created(newRoom);\n    }\n\n    /**\n     * Import phòng từ CSV (partial success strategy).\n     * POST /api/v1/rooms/import\n     *\n     * @param file CSV file (name, location)\n     * @param mode \"ADD_ONLY\" (skip trùng) hoặc \"ADD_AND_UPDATE\" (upsert)\n     * @return ImportResultDTO với successCount, failureCount, errors\n     * @throws BadRequestException nếu file rỗng hoặc mode invalid\n     */\n    @PostMapping(value = \"/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'ROOM_IMPORT')\")\n    public Response<ImportResultDTO> importRooms(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        // Validate file - vd: null/rỗng → 400 FILE_REQUIRED\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        // Import CSV - vd: 100 dòng → 80 ok, 20 lỗi → 200 OK với chi tiết lỗi\n        ImportResultDTO result = roomService.importFromCsv(file, mode);\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n\n    /**\n     * Tìm kiếm phòng với filters và pagination.\n     * GET /api/v1/rooms\n     *\n     * @param request Filters: search, isActive, hasCamera, page, pageSize, sortBy, sort\n     * @return PagingResponse với RoomDTO list, totalItems, totalPages\n     */\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'ROOM_READ')\")\n    public PagingResponse<RoomDTO> search(@Valid RoomSearchRequest request) {\n        // Vd: ?search=30&isActive=true → tìm phòng active có \"30\" (301,302,303,305)\n        List<RoomDTO> rooms = roomService.search(request);\n        Long total = roomService.count(request);\n        return PagingResponse.of(rooms, total, request);\n    }\n\n    /**\n     * Lấy thông tin phòng theo ID (kèm camera stats).\n     * GET /api/v1/rooms/{id}\n     *\n     * @param id ID phòng\n     * @return RoomDTO với totalCameras, activeCameras\n     * @throws ResourceNotFoundException nếu không tìm thấy\n     */\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'ROOM_READ')\")\n    public Response<RoomDTO> findById(@PathVariable Short id) {\n        // Vd: GET /5 → {id:5, name:\"301\", totalCameras:2, activeCameras:2}\n        return Response.ok(roomService.findById(id));\n    }\n\n    /**\n     * Cập nhật thông tin phòng (check tên unique khi đổi, check camera/slot khi tắt).\n     * PUT /api/v1/rooms/{id}\n     *\n     * @param id ID phòng\n     * @param request Body: name, location, isActive\n     * @return RoomDTO đã cập nhật\n     * @throws ResourceNotFoundException nếu không tìm thấy\n     * @throws ResourceExistsException nếu đổi tên trùng phòng khác\n     * @throws OperationNotAllowedException nếu tắt phòng có camera/slot active\n     */\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'ROOM_UPDATE')\")\n    public Response<RoomDTO> update(@PathVariable Short id,\n            @Valid @RequestBody RoomUpdateRequest request) {\n        // Vd: PUT /5, {\"location\":\"Tầng 3, Tòa B\"} → ok | {\"name\":\"302\"} trùng → 409\n        RoomDTO updatedRoom = roomService.update(id, request);\n        return Response.ok(updatedRoom);\n    }\n\n    /**\n     * Xóa phòng (hard delete - phải không có camera/slot).\n     * DELETE /api/v1/rooms/{id}\n     *\n     * @param id ID phòng\n     * @return Success message\n     * @throws ResourceNotFoundException nếu không tìm thấy\n     * @throws OperationNotAllowedException nếu có camera/slot\n     */\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'ROOM_DELETE_HARD')\")\n    public Response<Void> delete(@PathVariable Short id) {\n        // Vd: DELETE /25 không có camera/slot → ok | DELETE /5 có 2 camera → 400\n        roomService.delete(id);\n        return Response.ok(\"Delete room successfully\");\n    }\n\n    /**\n     * Lấy danh sách camera của phòng với pagination.\n     * GET /api/v1/rooms/{id}/cameras\n     *\n     * @param id ID phòng\n     * @param request Filters: isActive, page, pageSize, sortBy, sort\n     * @return RoomCamerasResponse với room, cameras list, pagination\n     * @throws ResourceNotFoundException nếu phòng không tồn tại\n     */\n    @GetMapping(\"/{id}/cameras\")\n    @PreAuthorize(\"hasPermission(null,'ROOM_READ')\")\n    public RoomCamerasResponse getCamerasByRoomId(@PathVariable Short id,\n            @Valid CameraSearchBaseRequest request) {\n        // Vd: GET /5/cameras?isActive=true → camera active phòng 301\n        RoomDTO room = roomService.findById(id);\n        request.setRoomId(id);\n        List<CameraDTO> cameras = cameraService.search(request);\n        Long total = cameraService.count(request);\n        return new RoomCamerasResponse(request, room, cameras, total);\n    }\n\n    /**\n     * Lấy danh sách slot của phòng với pagination.\n     * GET /api/v1/rooms/{id}/slots\n     *\n     * @param id ID phòng\n     * @param request Filters: search, semesterId, category, isActive, startDate, endDate, page, pageSize, sortBy, sort\n     * @return RoomSlotsResponse với room, slots list, pagination\n     * @throws ResourceNotFoundException nếu phòng không tồn tại\n     */\n    @GetMapping(\"/{id}/slots\")\n    @PreAuthorize(\"hasPermission(null,'ROOM_READ')\")\n    public RoomSlotsResponse getSlotsByRoomId(@PathVariable Short id,\n            @Valid SlotSearchRequest request) {\n        // Vd: GET /12/slots?category=LECTURE → slot LECTURE phòng Lab-A1\n        RoomDTO room = roomService.findById(id);\n        request.setRoomId(id);\n        List<SlotDTO> slots = slotService.searchByRoomId(id, request);\n        Long total = slotService.countByRoomId(id, request);\n        return new RoomSlotsResponse(request, room, slots, total);\n    }\n}"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\SemesterController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/SemesterController.java",
      "filename": "SemesterController.java",
      "size_bytes": 6746,
      "lines": 148,
      "last_modified": "2025-11-28T08:56:32.963542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.ClassSearchRequest;\nimport com.fuacs.backend.dto.request.SemesterCreateRequest;\nimport com.fuacs.backend.dto.request.SemesterSearchRequest;\nimport com.fuacs.backend.dto.request.SemesterUpdateRequest;\nimport com.fuacs.backend.dto.request.SubjectSearchRequest;\nimport com.fuacs.backend.dto.request.StudentSemesterSearchRequest;\nimport com.fuacs.backend.dto.response.ClassDTO;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.SemesterDTO;\nimport com.fuacs.backend.dto.response.SubjectDTO;\nimport com.fuacs.backend.dto.response.StudentSemesterDTO;\nimport com.fuacs.backend.dto.response.StudentSemesterResponse;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.ClassService;\nimport com.fuacs.backend.service.SemesterService;\nimport com.fuacs.backend.service.SubjectService;\nimport com.fuacs.backend.service.StudentProfileService;\nimport jakarta.validation.Valid;\nimport org.springframework.http.MediaType;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/semesters\")\npublic class SemesterController {\n\n    private final SemesterService semesterService;\n    private final ClassService classService;\n    private final SubjectService subjectService;\n    private final StudentProfileService studentProfileService;\n\n    public SemesterController(SemesterService semesterService,\n            ClassService classService,\n            SubjectService subjectService,\n            StudentProfileService studentProfileService) {\n        this.semesterService = semesterService;\n        this.classService = classService;\n        this.subjectService = subjectService;\n        this.studentProfileService = studentProfileService;\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'SEMESTER_READ')\")\n    public PagingResponse<SemesterDTO> search(@Valid SemesterSearchRequest request) {\n        List<SemesterDTO> semesters = semesterService.search(request);\n        Long total = semesterService.count(request);\n        return PagingResponse.of(semesters, total, request);\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'SEMESTER_READ')\")\n    public Response<SemesterDTO> findById(@PathVariable Short id) {\n        return Response.ok(semesterService.findById(id));\n    }\n\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'SEMESTER_CREATE')\")\n    public Response<SemesterDTO> create(@Valid @RequestBody SemesterCreateRequest request) {\n        SemesterDTO newSemester = semesterService.create(request);\n        return Response.created(newSemester);\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'SEMESTER_UPDATE')\")\n    public Response<SemesterDTO> update(@PathVariable Short id,\n            @Valid @RequestBody SemesterUpdateRequest request) {\n        SemesterDTO updatedSemester = semesterService.update(id, request);\n        return Response.ok(updatedSemester);\n    }\n\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'SEMESTER_DELETE_HARD')\")\n    public Response<Void> delete(@PathVariable Short id) {\n        semesterService.delete(id);\n        return Response.ok(\"Delete semester successfully\");\n    }\n\n    @GetMapping(\"/{id}/classes\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public PagingResponse<ClassDTO> searchClassBySemesterId(@PathVariable Short id,\n            @Valid ClassSearchRequest request) {\n        List<ClassDTO> classes = classService.searchClassBySemesterId(id, request);\n        Long total = classService.countBySemesterId(id, request);\n        return PagingResponse.of(classes, total, request);\n    }\n\n    @GetMapping(\"/{id}/subjects\")\n    @PreAuthorize(\"hasPermission(null,'SUBJECT_READ')\")\n    public PagingResponse<SubjectDTO> searchSubjectsBySemesterId(@PathVariable Short id,\n            @Valid SubjectSearchRequest request) {\n        List<SubjectDTO> subjects = subjectService.searchBySemesterId(id, request);\n        Long total = subjectService.countBySemesterId(id, request);\n        return PagingResponse.of(subjects, total, request);\n    }\n\n    @GetMapping(\"/{id}/students\")\n    @PreAuthorize(\"hasPermission(null,'USER_READ_LIST')\")\n    public StudentSemesterResponse searchStudentsBySemesterId(@PathVariable Short id,\n            @Valid StudentSemesterSearchRequest request) {\n        SemesterDTO semester = semesterService.findById(id);\n        List<StudentSemesterDTO> students = studentProfileService.searchBySemesterId(id, request);\n        Long total = studentProfileService.countBySemesterId(id, request);\n        return new StudentSemesterResponse(request, students, total, semester);\n    }\n\n    /**\n     * Import semesters from CSV file.\n     * Supports AddOnly and AddAndUpdate modes with partial success pattern.\n     * CSV format: code,name,start_date,end_date\n     *\n     * @param file CSV file to import\n     * @param mode Import mode (\"AddOnly\" or \"AddAndUpdate\")\n     * @return ImportResultDTO with success/failure counts and error details\n     */\n    @PostMapping(value = \"/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'SEMESTER_IMPORT')\")\n    public Response<ImportResultDTO> importSemesters(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        ImportResultDTO result = semesterService.importFromCsv(file, mode);\n\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\SlotController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/SlotController.java",
      "filename": "SlotController.java",
      "size_bytes": 13425,
      "lines": 268,
      "last_modified": "2025-11-28T08:56:32.964542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.SlotCreateRequest;\nimport com.fuacs.backend.dto.request.SlotCategoryUpdateRequest;\nimport com.fuacs.backend.dto.request.SlotSearchRequest;\nimport com.fuacs.backend.dto.request.SlotUpdateRequest;\nimport com.fuacs.backend.dto.request.SlotAttendanceSubmissionRequest;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.SlotDTO;\nimport com.fuacs.backend.dto.response.SlotAttendanceSubmissionResponse;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.SlotService;\nimport jakarta.validation.Valid;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.http.MediaType;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/slots\")\npublic class SlotController {\n\n    private final SlotService slotService;\n\n    public SlotController(SlotService slotService) {\n        this.slotService = slotService;\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public PagingResponse<SlotDTO> findAll(@Valid SlotSearchRequest request) {\n        List<SlotDTO> slots = slotService.findAll(request);\n        Long total = slotService.count(request);\n        return PagingResponse.of(slots, total, request);\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public Response<SlotDTO> findById(@PathVariable Integer id) {\n        return Response.ok(slotService.findById(id));\n    }\n\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'SLOT_CREATE') or hasPermission(null,'SLOT_CREATE_FINAL_EXAM')\")\n    public Response<SlotDTO> create(@Valid @RequestBody SlotCreateRequest request) {\n        SlotDTO newSlot = slotService.create(request);\n        return Response.created(newSlot);\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_UPDATE') or hasPermission(null,'SLOT_UPDATE_CATEGORY') or hasPermission(null,'SLOT_UPDATE_FINAL_EXAM')\")\n    public Response<SlotDTO> update(@PathVariable Integer id,\n            @Valid @RequestBody SlotUpdateRequest request) {\n        SlotDTO updatedSlot = slotService.update(id, request);\n        return Response.ok(updatedSlot);\n    }\n\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_DELETE_HARD')\")\n    public Response<Void> delete(@PathVariable Integer id) {\n        slotService.delete(id);\n        return Response.ok(\"Delete slot successfully\");\n    }\n\n    @PutMapping(\"/{id}/category\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_UPDATE') or hasPermission(null,'SLOT_UPDATE_CATEGORY')\")\n    public Response<SlotDTO> updateSlotCategory(@PathVariable Integer id,\n            @Valid @RequestBody SlotCategoryUpdateRequest request) {\n        Integer currentUserId = com.fuacs.backend.util.SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        SlotDTO updatedSlot = slotService.updateSlotCategory(id, request, currentUserId);\n        return Response.ok(updatedSlot);\n    }\n\n    @PostMapping(\"/{id}/start-session\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_SESSION_START')\")\n    public Response<com.fuacs.backend.dto.response.SessionStatusResponse> startAttendanceSession(\n            @PathVariable Integer id) {\n        Integer currentUserId = com.fuacs.backend.util.SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        com.fuacs.backend.dto.response.SessionStatusResponse response = slotService.startAttendanceSession(id,\n                currentUserId);\n        return Response.ok(response);\n    }\n\n    @PostMapping(\"/{id}/stop-session\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_SESSION_FINALIZE')\")\n    public Response<com.fuacs.backend.dto.response.SessionStatusResponse> stopAttendanceSession(\n            @PathVariable Integer id) {\n        Integer currentUserId = com.fuacs.backend.util.SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        com.fuacs.backend.dto.response.SessionStatusResponse response = slotService.stopAttendanceSession(id,\n                currentUserId);\n        return Response.ok(response);\n    }\n\n    @PostMapping(\"/{id}/rescan\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_SESSION_RESCAN')\")\n    public Response<com.fuacs.backend.dto.response.SessionStatusResponse> triggerRescan(@PathVariable Integer id) {\n        Integer currentUserId = com.fuacs.backend.util.SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        com.fuacs.backend.dto.response.SessionStatusResponse response = slotService.triggerRescan(id, currentUserId);\n        return Response.ok(response);\n    }\n\n    // ========== Exam Session Endpoints (LECTURE_WITH_PT & FINAL_EXAM) ==========\n\n    @PostMapping(\"/{id}/start-exam-session\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_SESSION_START')\")\n    public Response<com.fuacs.backend.dto.response.SessionStatusResponse> startExamSession(\n            @PathVariable Integer id) {\n        Integer currentUserId = com.fuacs.backend.util.SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        com.fuacs.backend.dto.response.SessionStatusResponse response = slotService.startExamSession(id, currentUserId);\n        return Response.ok(response);\n    }\n\n    @PostMapping(\"/{id}/stop-exam-session\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_SESSION_FINALIZE')\")\n    public Response<com.fuacs.backend.dto.response.SessionStatusResponse> stopExamSession(\n            @PathVariable Integer id) {\n        Integer currentUserId = com.fuacs.backend.util.SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        com.fuacs.backend.dto.response.SessionStatusResponse response = slotService.stopExamSession(id, currentUserId);\n        return Response.ok(response);\n    }\n\n    @PostMapping(\"/{id}/rescan-exam\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_SESSION_RESCAN')\")\n    public Response<com.fuacs.backend.dto.response.SessionStatusResponse> rescanExam(@PathVariable Integer id) {\n        Integer currentUserId = com.fuacs.backend.util.SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        com.fuacs.backend.dto.response.SessionStatusResponse response = slotService.rescanExam(id, currentUserId);\n        return Response.ok(response);\n    }\n\n    @GetMapping(\"/{id}/roster\")\n    @PreAuthorize(\"hasPermission(null,'ATTENDANCE_ROSTER_READ')\")\n    public Response<java.util.List<com.fuacs.backend.dto.response.SlotRosterItemDTO>> getSlotRoster(\n            @PathVariable Integer id) {\n        Integer currentUserId = com.fuacs.backend.util.SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        java.util.List<com.fuacs.backend.dto.response.SlotRosterItemDTO> roster = slotService.getSlotRoster(id,\n                currentUserId);\n        return Response.ok(roster);\n    }\n\n    @PostMapping(\"/{id}/submit-attendance\")\n    @PreAuthorize(\"hasPermission(null,'ATTENDANCE_STATUS_UPDATE_MANUAL')\")\n    public Response<SlotAttendanceSubmissionResponse> submitAttendance(\n            @PathVariable Integer id,\n            @Valid @RequestBody SlotAttendanceSubmissionRequest request) {\n        Integer currentUserId = com.fuacs.backend.util.SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new com.fuacs.backend.exception.BadRequestException(\"UN_AUTHENTICATION\",\n                        com.fuacs.backend.constant.ErrorCode.UN_AUTHENTICATION));\n        SlotAttendanceSubmissionResponse response = slotService.submitAttendance(id, request, currentUserId);\n        return Response.ok(response);\n    }\n\n    /**\n     * Import LECTURE/LECTURE_WITH_PT slots from CSV file.\n     * Supports AddOnly and AddAndUpdate modes with partial success pattern.\n     *\n     * CSV format (8 columns):\n     * title,start_time,end_time,slot_category,class_code,semester_code,room_name,staff_username\n     *\n     * Example:\n     * Lecture SE1,2024-12-15T14:00:00,2024-12-15T16:30:00,LECTURE,SE1801,FA24,C301,lecturer3\n     *\n     * Notes:\n     * - slot_category: Must be LECTURE or LECTURE_WITH_PT\n     * - class_code: Required (class must exist)\n     * - DateTime format: yyyy-MM-dd'T'HH:mm:ss (Vietnam timezone, no Z suffix)\n     *\n     * @param file CSV file to import\n     * @param mode Import mode (\"AddOnly\" or \"AddAndUpdate\")\n     * @return ImportResultDTO with success/failure counts and error details\n     */\n    @PostMapping(value = \"/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'SLOT_IMPORT')\")\n    public Response<ImportResultDTO> importSlots(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        ImportResultDTO result = slotService.importFromCsv(file, mode);\n\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n\n    /**\n     * Import FINAL_EXAM slots from CSV file.\n     * Supports AddOnly and AddAndUpdate modes with partial success pattern.\n     *\n     * CSV format (8 columns):\n     * title,start_time,end_time,slot_category,semester_code,room_name,staff_username,subject_codes\n     *\n     * Example:\n     * Final Exam,2024-12-31T14:00:00,2024-12-31T16:00:00,FINAL_EXAM,FA24,A101,lecturer1,\"PRF192,PRO192,MAE101\"\n     *\n     * Notes:\n     * - slot_category: Must be FINAL_EXAM\n     * - subject_codes: Comma-separated subject codes (quoted if multiple). Required.\n     * - DateTime format: yyyy-MM-dd'T'HH:mm:ss (Vietnam timezone, no Z suffix)\n     *\n     * @param file CSV file to import\n     * @param mode Import mode (\"AddOnly\" or \"AddAndUpdate\")\n     * @return ImportResultDTO with success/failure counts and error details\n     */\n    @PostMapping(value = \"/import-exams\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'SLOT_IMPORT')\")\n    public Response<ImportResultDTO> importExamSlots(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        ImportResultDTO result = slotService.importExamSlotsFromCsv(file, mode);\n\n        String message = String.format(\"Exam import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n\n    /**\n     * Check if slot has any attendance records (regular or exam).\n     * Used by frontend to determine if slot details should be view-only.\n     *\n     * @param id Slot ID\n     * @return Boolean indicating if slot has attendance records\n     */\n    @GetMapping(\"/{id}/has-attendance-records\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public Response<Boolean> hasAttendanceRecords(@PathVariable Integer id) {\n        boolean hasRecords = slotService.hasAttendanceRecords(id);\n        return Response.ok(hasRecords);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\SlotSseController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/SlotSseController.java",
      "filename": "SlotSseController.java",
      "size_bytes": 2706,
      "lines": 66,
      "last_modified": "2025-11-28T08:56:32.964542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.repository.SlotRepository;\nimport com.fuacs.backend.realtime.SseHub;\nimport jakarta.servlet.http.HttpServletResponse;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.oauth2.jwt.Jwt;\nimport org.springframework.security.oauth2.jwt.JwtDecoder;\nimport org.springframework.web.bind.annotation.*;\nimport org.springframework.web.servlet.mvc.method.annotation.SseEmitter;\n\n@RestController\n@RequestMapping(\"/api/v1/slots\")\npublic class SlotSseController {\n\n    private static final Logger log = LoggerFactory.getLogger(SlotSseController.class);\n\n    private final SseHub sseHub;\n    private final JwtDecoder jwtDecoder;\n    private final SlotRepository slotRepository;\n\n    public SlotSseController(SseHub sseHub, JwtDecoder jwtDecoder, SlotRepository slotRepository) {\n        this.sseHub = sseHub;\n        this.jwtDecoder = jwtDecoder;\n        this.slotRepository = slotRepository;\n    }\n\n    @GetMapping(value = \"/{slotId}/events\", produces = MediaType.TEXT_EVENT_STREAM_VALUE)\n    public ResponseEntity<SseEmitter> subscribe(@PathVariable Integer slotId,\n                                               @RequestParam(\"token\") String token,\n                                               HttpServletResponse response) {\n        try {\n            Jwt jwt = jwtDecoder.decode(token);\n\n            Integer userId = null;\n            Object userIdClaim = jwt.getClaim(\"userId\");\n            if (userIdClaim instanceof Integer i) userId = i;\n            else if (userIdClaim instanceof Long l) userId = l.intValue();\n            else if (userIdClaim instanceof String s) userId = Integer.parseInt(s);\n\n            if (userId == null) {\n                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();\n            }\n\n            // Authorization: must be assigned staff to slot\n            boolean allowed = slotRepository.isSlotAssignedToStaff(slotId, userId);\n            if (!allowed) {\n                return ResponseEntity.status(HttpStatus.FORBIDDEN).build();\n            }\n\n            // No cache for SSE\n            response.setHeader(\"Cache-Control\", \"no-store\");\n\n            SseEmitter emitter = sseHub.subscribe(slotId);\n            return ResponseEntity.ok(emitter);\n        } catch (Exception ex) {\n            log.error(\"Failed to start SSE for slot {}: {}\", slotId, ex.getMessage());\n            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();\n        }\n    }\n}\n\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\StaffProfileController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/StaffProfileController.java",
      "filename": "StaffProfileController.java",
      "size_bytes": 7232,
      "lines": 161,
      "last_modified": "2025-11-28T08:56:32.964542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.ClassSearchRequest;\nimport com.fuacs.backend.dto.request.RoomSearchRequest;\nimport com.fuacs.backend.dto.request.SlotSearchRequest;\nimport com.fuacs.backend.dto.request.StaffProfileCreateRequest;\nimport com.fuacs.backend.dto.request.StaffProfileSearchRequest;\nimport com.fuacs.backend.dto.request.StaffProfileUpdateRequest;\nimport com.fuacs.backend.dto.request.SubjectSearchRequest;\nimport com.fuacs.backend.dto.response.ClassDTO;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.RoomDTO;\nimport com.fuacs.backend.dto.response.SlotDTO;\nimport com.fuacs.backend.dto.response.StaffProfileDTO;\nimport com.fuacs.backend.dto.response.SubjectDTO;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.ClassService;\nimport com.fuacs.backend.service.RoomService;\nimport com.fuacs.backend.service.SlotService;\nimport com.fuacs.backend.service.StaffProfileService;\nimport com.fuacs.backend.service.SubjectService;\nimport jakarta.validation.Valid;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.http.MediaType;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/staff-profiles\")\npublic class StaffProfileController {\n\n    private final StaffProfileService staffProfileService;\n    private final ClassService classService;\n    private final SubjectService subjectService;\n    private final RoomService roomService;\n    private final SlotService slotService;\n\n    public StaffProfileController(StaffProfileService staffProfileService,\n            ClassService classService,\n            SubjectService subjectService,\n            RoomService roomService,\n            SlotService slotService) {\n        this.staffProfileService = staffProfileService;\n        this.classService = classService;\n        this.subjectService = subjectService;\n        this.roomService = roomService;\n        this.slotService = slotService;\n    }\n\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'USER_CREATE')\")\n    public Response<StaffProfileDTO> create(@Valid @RequestBody StaffProfileCreateRequest request) {\n        StaffProfileDTO response = staffProfileService.create(request);\n        return Response.created(response);\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'USER_READ_LIST')\")\n    public PagingResponse<StaffProfileDTO> search(@Valid StaffProfileSearchRequest request) {\n        return staffProfileService.search(request);\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasAnyAuthority('USER_READ_DETAIL', 'OWN_PROFILE_READ')\")\n    public Response<StaffProfileDTO> getById(@PathVariable Integer id) {\n        StaffProfileDTO response = staffProfileService.findById(id);\n        return Response.ok(response);\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasAnyAuthority('USER_UPDATE_INFO', 'USER_UPDATE_STATUS', 'USER_ASSIGN_ROLES')\")\n    public Response<StaffProfileDTO> update(@PathVariable Integer id,\n            @Valid @RequestBody StaffProfileUpdateRequest request) {\n        StaffProfileDTO response = staffProfileService.update(id, request);\n        return Response.ok(response);\n    }\n\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'USER_DELETE_HARD')\")\n    public Response<Void> delete(@PathVariable Integer id) {\n        staffProfileService.delete(id);\n        return Response.ok(\"Delete staff profile successfully\");\n    }\n\n    // TODO: may use in future\n    @GetMapping(\"/{id}/classes\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public PagingResponse<ClassDTO> getClassesByStaffId(@PathVariable Integer id,\n            @Valid ClassSearchRequest request) {\n        List<ClassDTO> classes = classService.searchClassesByStaffId(id, request);\n        Long total = classService.countClassesByStaffId(id, request);\n        return PagingResponse.of(classes, total, request);\n    }\n\n    @GetMapping(\"/{id}/subjects\")\n    @PreAuthorize(\"hasPermission(null,'SUBJECT_READ')\")\n    public PagingResponse<SubjectDTO> getSubjectsByStaffId(@PathVariable Integer id,\n            @Valid SubjectSearchRequest request) {\n        List<SubjectDTO> subjects = subjectService.searchByStaffId(id, request);\n        Long total = subjectService.countByStaffId(id, request);\n        return PagingResponse.of(subjects, total, request);\n    }\n\n    @GetMapping(\"/{id}/rooms\")\n    @PreAuthorize(\"hasPermission(null,'ROOM_READ')\")\n    public PagingResponse<RoomDTO> getRoomsByStaffId(@PathVariable Integer id,\n            @Valid RoomSearchRequest request) {\n        List<RoomDTO> rooms = roomService.searchByStaffId(id, request);\n        Long total = roomService.countByStaffId(id, request);\n        return PagingResponse.of(rooms, total, request);\n    }\n\n    @GetMapping(\"/{id}/slots\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public PagingResponse<SlotDTO> getSlotsByStaffId(@PathVariable Integer id,\n            @Valid SlotSearchRequest request) {\n        List<SlotDTO> slots = slotService.searchByStaffId(id, request);\n        Long total = slotService.countByStaffId(id, request);\n        return PagingResponse.of(slots, total, request);\n    }\n\n    /**\n     * Import staff profiles from CSV file.\n     * Supports AddOnly and AddAndUpdate modes with partial success pattern.\n     * CSV format: full_name,email,staff_code,roles\n     *\n     * @param file CSV file to import\n     * @param mode Import mode (\"AddOnly\" or \"AddAndUpdate\")\n     * @return ImportResultDTO with success/failure counts and error details\n     */\n    @PostMapping(value = \"/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'STAFF_IMPORT')\")\n    public Response<ImportResultDTO> importStaffProfiles(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        ImportResultDTO result = staffProfileService.importFromCsv(file, mode);\n\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\StudentPhotoController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/StudentPhotoController.java",
      "filename": "StudentPhotoController.java",
      "size_bytes": 3405,
      "lines": 89,
      "last_modified": "2025-11-28T08:56:32.964542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.core.io.Resource;\nimport org.springframework.core.io.UrlResource;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.HttpStatus;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.nio.file.Files;\nimport java.nio.file.Path;\nimport java.nio.file.Paths;\n\n/**\n * Controller for serving student profile photos\n */\n@RestController\n@RequestMapping(\"/api/v1/student-photos\")\npublic class StudentPhotoController {\n\n    private static final Logger log = LoggerFactory.getLogger(StudentPhotoController.class);\n    private static final String PHOTO_BASE_DIR = \"./uploads/student-photos\";\n\n    /**\n     * Serve student profile photo\n     * \n     * GET /api/v1/student-photos/{userId}/{filename}\n     * \n     * Example: GET /api/v1/student-photos/123/123_profile.jpg\n     * \n     * Note: Public access allowed via SecurityConfig for image loading\n     */\n    @GetMapping(\"/{userId}/{filename:.+}\")\n    public ResponseEntity<Resource> serveStudentPhoto(\n            @PathVariable Integer userId,\n            @PathVariable String filename) {\n        \n        try {\n            // Construct file path\n            Path filePath = Paths.get(PHOTO_BASE_DIR, userId.toString(), filename).normalize();\n            \n            // Security check: prevent path traversal\n            if (!filePath.startsWith(Paths.get(PHOTO_BASE_DIR).normalize())) {\n                return ResponseEntity.status(HttpStatus.FORBIDDEN).build();\n            }\n            \n            // Check if file exists\n            if (!Files.exists(filePath) || !Files.isRegularFile(filePath)) {\n                return ResponseEntity.notFound().build();\n            }\n            \n            return serveImageFile(filePath);\n            \n        } catch (Exception e) {\n            log.error(\"Error serving student photo {}/{}: {}\", userId, filename, e.getMessage(), e);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n    }\n\n    /**\n     * Common method to serve image file\n     */\n    private ResponseEntity<Resource> serveImageFile(Path filePath) throws Exception {\n        Resource resource = new UrlResource(filePath.toUri());\n        \n        if (!resource.exists() || !resource.isReadable()) {\n            log.error(\"Student photo not readable: {}\", filePath);\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n        \n        // Determine content type\n        String contentType = Files.probeContentType(filePath);\n        if (contentType == null) {\n            contentType = MediaType.IMAGE_JPEG_VALUE; // Default to JPEG\n        }\n        \n        // Return image with appropriate headers\n        return ResponseEntity.ok()\n                .contentType(MediaType.parseMediaType(contentType))\n                .header(HttpHeaders.CACHE_CONTROL, \"max-age=3600\") // Cache for 1 hour\n                .body(resource);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\StudentProfileController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/StudentProfileController.java",
      "filename": "StudentProfileController.java",
      "size_bytes": 11502,
      "lines": 236,
      "last_modified": "2025-11-28T08:56:32.964542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.AttendanceHistorySearchRequest;\nimport com.fuacs.backend.dto.request.ClassSearchRequest;\nimport com.fuacs.backend.dto.request.SlotSearchRequest;\nimport com.fuacs.backend.dto.request.StudentProfileCreateRequest;\nimport com.fuacs.backend.dto.request.StudentProfileSearchRequest;\nimport com.fuacs.backend.dto.request.StudentProfileUpdateRequest;\nimport com.fuacs.backend.dto.response.AttendanceHistoryWithSummaryDTO;\nimport com.fuacs.backend.dto.response.AttendanceSummaryDetailsDTO;\nimport com.fuacs.backend.dto.response.ClassDTO;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.ImportStudentProfileDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.SlotDTO;\nimport com.fuacs.backend.dto.response.StudentAttendanceHistoryResponse;\nimport com.fuacs.backend.dto.response.StudentProfileDTO;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.exception.OperationNotAllowedException;\nimport com.fuacs.backend.exception.ResourceNotFoundException;\nimport com.fuacs.backend.repository.StudentProfileRepository;\nimport com.fuacs.backend.repository.custom.CustomEnrollmentRepository;\nimport com.fuacs.backend.service.AttendanceHistoryService;\nimport com.fuacs.backend.service.BulkPhotoUploadService;\nimport com.fuacs.backend.service.ClassService;\nimport com.fuacs.backend.service.ExcelService;\nimport com.fuacs.backend.service.SlotService;\nimport com.fuacs.backend.service.StudentProfileService;\nimport com.fuacs.backend.util.SecurityUtil;\nimport jakarta.validation.Valid;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.util.List;\nimport java.util.Objects;\n\n@RestController\n@RequestMapping(\"/api/v1/student-profiles\")\npublic class StudentProfileController {\n    private final StudentProfileService studentProfileService;\n    private final ClassService classService;\n    private final ExcelService excelService;\n    private final AttendanceHistoryService attendanceHistoryService;\n    private final SlotService slotService;\n    private final BulkPhotoUploadService bulkPhotoUploadService;\n    private final CustomEnrollmentRepository enrollmentRepository;\n    private final StudentProfileRepository studentProfileRepository;\n\n    public StudentProfileController(StudentProfileService studentProfileService,\n                                    ClassService classService,\n                                    ExcelService excelService,\n                                    AttendanceHistoryService attendanceHistoryService,\n                                    SlotService slotService,\n                                    BulkPhotoUploadService bulkPhotoUploadService,\n                                    CustomEnrollmentRepository enrollmentRepository,\n                                    StudentProfileRepository studentProfileRepository) {\n        this.studentProfileService = studentProfileService;\n        this.classService = classService;\n        this.excelService = excelService;\n        this.attendanceHistoryService = attendanceHistoryService;\n        this.slotService = slotService;\n        this.bulkPhotoUploadService = bulkPhotoUploadService;\n        this.enrollmentRepository = enrollmentRepository;\n        this.studentProfileRepository = studentProfileRepository;\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'USER_READ_LIST')\")\n    public PagingResponse<StudentProfileDTO> search(@Valid StudentProfileSearchRequest request) {\n        List<StudentProfileDTO> profiles = studentProfileService.search(request);\n        Long total = studentProfileService.count(request);\n        return PagingResponse.of(profiles, total, request);\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasAnyAuthority('USER_READ_DETAIL', 'OWN_PROFILE_READ')\")\n    public Response<StudentProfileDTO> findById(@PathVariable Integer id) {\n        StudentProfileDTO profile = studentProfileService.findById(id);\n        return Response.ok(profile);\n    }\n\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'USER_CREATE')\")\n    public Response<StudentProfileDTO> create(@Valid @RequestBody StudentProfileCreateRequest request) {\n        StudentProfileDTO newProfile = studentProfileService.create(request);\n        return Response.created(newProfile);\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'USER_UPDATE_INFO')\")\n    public Response<StudentProfileDTO> update(@PathVariable Integer id,\n                                              @Valid @RequestBody StudentProfileUpdateRequest request) {\n        StudentProfileDTO updatedProfile = studentProfileService.update(id, request);\n        return Response.ok(updatedProfile);\n    }\n\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'USER_DELETE_HARD')\")\n    public Response<Void> delete(@PathVariable Integer id) {\n        studentProfileService.delete(id);\n        return Response.ok(\"Delete student profile successfully\");\n    }\n\n    @GetMapping(\"/{id}/classes\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public PagingResponse<ClassDTO> searchClassesByStudentId(@PathVariable Integer id,\n                                                             @Valid ClassSearchRequest request) {\n        List<ClassDTO> classes = classService.searchClassesByStudentId(id, request);\n        Long total = classService.countClassesByStudentId(id, request);\n        return PagingResponse.of(classes, total, request);\n    }\n\n    @GetMapping(\"/{id}/attendance-history\")\n\n    // TODO: uncomment after update db\n    // @PreAuthorize(\"hasPermission(null,'OWN_ATTENDANCE_HISTORY_READ') \" +\n    // \"or (hasPermission(null,'REPORT_READ_SYSTEM_WIDE') and\n    // hasRole('DATA_OPERATOR'))\")\n    public StudentAttendanceHistoryResponse getAttendanceHistory(@PathVariable Integer id,\n                                                                 @Valid AttendanceHistorySearchRequest request) {\n        AttendanceHistoryWithSummaryDTO data = attendanceHistoryService.getAttendanceHistory(id, request);\n        Long total = attendanceHistoryService.countAttendanceHistory(id, request);\n        AttendanceSummaryDetailsDTO summaryDetails = attendanceHistoryService.getDetailedSummary(id, request);\n        return new StudentAttendanceHistoryResponse(request, data.getItems(), total, summaryDetails);\n    }\n\n    /**\n     * Get subjects của student trong semester.\n     * Used by student attendance history page để filter by subject.\n     *\n     * @param id Student ID\n     * @param semesterId Semester ID (required)\n     * @return List of StudentSubjectDTO\n     */\n    @GetMapping(\"/{id}/subjects\")\n    @PreAuthorize(\"hasPermission(null,'OWN_SUBJECT_READ') or hasPermission(null,'USER_READ_DETAIL')\")\n    public Response<List<com.fuacs.backend.dto.response.StudentSubjectDTO>> getSubjectsByStudentIdAndSemester(\n            @PathVariable Integer id,\n            @RequestParam(required = true) Short semesterId) {\n\n        // Validate student exists\n        if (!studentProfileRepository.existsById(id)) {\n            throw new ResourceNotFoundException(\n                \"Student profile with ID \" + id + \" not found\",\n                ErrorCode.STUDENT_PROFILE_NOT_FOUND\n            );\n        }\n\n        // Call repository method (already exists)\n        List<com.fuacs.backend.dto.response.StudentSubjectDTO> subjects =\n            enrollmentRepository.findCurrentSemesterSubjectsByStudentId(id, semesterId);\n\n        return Response.ok(subjects);\n    }\n\n    /**\n     * Import student profiles from CSV file.\n     * Supports AddOnly and AddAndUpdate modes with partial success pattern.\n     * CSV format: full_name,email,username,roll_number,major_code\n     *\n     * @param file CSV file to import\n     * @param mode Import mode (\"AddOnly\" or \"AddAndUpdate\")\n     * @return ImportResultDTO with success/failure counts and error details\n     */\n    @PostMapping(value = \"/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'STUDENT_IMPORT')\")\n    public Response<ImportResultDTO> importStudentProfiles(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        ImportResultDTO result = studentProfileService.importFromCsv(file, mode);\n\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n\n    /**\n     * Bulk upload student photos and face embeddings\n     * POST /api/v1/student-profiles/bulk-upload-photos-embeddings\n     *\n     * Request:\n     * - csvFile: CSV with columns (roll_number, image_filename)\n     * - zipFile: ZIP containing image files\n     * - mode: \"AddOnly\" or \"AddAndUpdate\"\n     *\n     * Response: ImportResultDTO with success/failure counts\n     */\n    @PostMapping(value = \"/bulk-upload-photos-embeddings\",\n                 consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'STUDENT_IMPORT')\")\n    public Response<ImportResultDTO> bulkUploadPhotosEmbeddings(\n            @RequestParam(\"csvFile\") MultipartFile csvFile,\n            @RequestParam(\"zipFile\") MultipartFile zipFile,\n            @RequestParam(\"mode\") String mode) {\n\n        ImportResultDTO result = bulkPhotoUploadService.processBulkUpload(csvFile, zipFile, mode);\n\n        String message = String.format(\n            \"Upload completed: %d successful, %d failed\",\n            result.getSuccessCount(),\n            result.getFailureCount()\n        );\n\n        return Response.ok(result, message);\n    }\n\n    @GetMapping(\"/{id}/slots\")\n    @PreAuthorize(\"hasPermission(null,'SLOT_READ')\")\n    public PagingResponse<SlotDTO> getSlotsByStudentId(@PathVariable Integer id,\n                                                       @Valid SlotSearchRequest request) {\n        if (!Objects.equals(SecurityUtil.getLoginUserId().orElse(null), id))\n            throw new OperationNotAllowedException(\"You cannot view other student slots\", ErrorCode.FORBIDDEN);\n        List<SlotDTO> slots = slotService.searchByStudentId(id, request);\n        Long total = slotService.countByStudentId(id, request);\n        return PagingResponse.of(slots, total, request);\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\StudentsController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/StudentsController.java",
      "filename": "StudentsController.java",
      "size_bytes": 3751,
      "lines": 86,
      "last_modified": "2025-11-28T08:56:32.965542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.response.AttendanceHistoryDTO;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.SemesterDTO;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.repository.custom.CustomAttendanceHistoryRepository;\nimport com.fuacs.backend.repository.custom.CustomEnrollmentRepository;\nimport com.fuacs.backend.dto.request.AttendanceHistorySearchRequest;\nimport com.fuacs.backend.util.SecurityUtil;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.*;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/students\")\npublic class StudentsController {\n\n    private final CustomAttendanceHistoryRepository attendanceHistoryRepository;\n    private final CustomEnrollmentRepository enrollmentRepository;\n\n    public StudentsController(CustomAttendanceHistoryRepository attendanceHistoryRepository,\n                              CustomEnrollmentRepository enrollmentRepository) {\n        this.attendanceHistoryRepository = attendanceHistoryRepository;\n        this.enrollmentRepository = enrollmentRepository;\n    }\n\n    /**\n     * Get recent attendance records for current student\n     *\n     * @param limit Number of recent records (default 10)\n     * @return List of recent attendance records sorted by date DESC\n     */\n    @GetMapping(\"/me/attendance-recent\")\n    public Response<List<AttendanceHistoryDTO>> getRecentAttendance(\n            @RequestParam(defaultValue = \"10\") int limit) {\n\n        Integer studentId = SecurityUtil.getLoginUserId().orElseThrow(\n                () -> new BadRequestException(\"UN_AUTHENTICATION\", ErrorCode.UN_AUTHENTICATION));\n\n        // Build search request with pagination\n        // Note: PagedRequest uses 1-based indexing, so page=1 for first page\n        AttendanceHistorySearchRequest request = new AttendanceHistorySearchRequest(\n                1,           // page (1-based indexing)\n                limit,       // pageSize\n                \"DESC\",      // sort\n                \"slotDate\",  // sortBy\n                null,        // isActive\n                null,        // search\n                null,        // semesterId\n                null,        // classId\n                null,        // attendanceStatus\n                null,        // subjectId\n                null,        // slotCategory\n                null,        // attendanceType\n                null,        // startDate\n                null         // endDate\n        );\n\n        // Query recent attendance\n        List<AttendanceHistoryDTO> recentAttendance = attendanceHistoryRepository\n                .searchByStudentId(studentId, request);\n\n        return Response.ok(recentAttendance);\n    }\n\n    /**\n     * Get semesters where a specific student has enrolled classes.\n     * Used by admin to filter attendance history by relevant semesters only.\n     *\n     * @param studentId The student user ID\n     * @return List of semesters where student has enrollments\n     */\n    @GetMapping(\"/{studentId}/semesters\")\n    @PreAuthorize(\"hasPermission(null, 'USER_READ_DETAIL')\")\n    public Response<List<SemesterDTO>> getStudentSemesters(@PathVariable Integer studentId) {\n        if (studentId == null || studentId <= 0) {\n            throw new BadRequestException(\"Invalid student ID\", ErrorCode.BAD_REQUEST);\n        }\n\n        List<SemesterDTO> semesters = enrollmentRepository.findDistinctSemestersByStudentId(studentId);\n        return Response.ok(semesters, \"Student semesters retrieved successfully\");\n    }\n}\n"
    },
    {
      "path": "D:\\Work\\do_an_fall25\\fuacs\\backend\\src\\main\\java\\com\\fuacs\\backend\\controller\\SubjectController.java",
      "relative_path": "src/main/java/com/fuacs/backend/controller/SubjectController.java",
      "filename": "SubjectController.java",
      "size_bytes": 4590,
      "lines": 106,
      "last_modified": "2025-11-28T08:56:32.965542",
      "encoding": "utf-8",
      "language": "java",
      "content": "package com.fuacs.backend.controller;\n\nimport com.fuacs.backend.constant.ErrorCode;\nimport com.fuacs.backend.dto.request.ClassSearchRequest;\nimport com.fuacs.backend.dto.request.SubjectCreateRequest;\nimport com.fuacs.backend.dto.request.SubjectSearchRequest;\nimport com.fuacs.backend.dto.request.SubjectUpdateRequest;\nimport com.fuacs.backend.dto.response.ClassDTO;\nimport com.fuacs.backend.dto.response.ImportResultDTO;\nimport com.fuacs.backend.dto.response.PagingResponse;\nimport com.fuacs.backend.dto.response.Response;\nimport com.fuacs.backend.dto.response.SubjectDTO;\nimport com.fuacs.backend.exception.BadRequestException;\nimport com.fuacs.backend.service.ClassService;\nimport com.fuacs.backend.service.SubjectService;\nimport jakarta.validation.Valid;\nimport org.springframework.http.MediaType;\nimport org.springframework.security.access.prepost.PreAuthorize;\nimport org.springframework.web.bind.annotation.DeleteMapping;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.PutMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.multipart.MultipartFile;\n\nimport java.util.List;\n\n@RestController\n@RequestMapping(\"/api/v1/subjects\")\npublic class SubjectController {\n    private final SubjectService subjectService;\n    private final ClassService classService;\n\n    public SubjectController(SubjectService subjectService, ClassService classService) {\n        this.subjectService = subjectService;\n        this.classService = classService;\n    }\n\n    @GetMapping\n    @PreAuthorize(\"hasPermission(null,'SUBJECT_READ')\")\n    public PagingResponse<SubjectDTO> search(@Valid SubjectSearchRequest request) {\n        List<SubjectDTO> subjects = subjectService.search(request);\n        Long total = subjectService.count(request);\n        return PagingResponse.of(subjects, total, request);\n    }\n\n    @GetMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'SUBJECT_READ')\")\n    public Response<SubjectDTO> findById(@PathVariable Short id) {\n        SubjectDTO subject = subjectService.findById(id);\n        return Response.ok(subject);\n    }\n\n    @PostMapping\n    @PreAuthorize(\"hasPermission(null,'SUBJECT_CREATE')\")\n    public Response<SubjectDTO> create(@Valid @RequestBody SubjectCreateRequest request) {\n        SubjectDTO newSubject = subjectService.create(request);\n        return Response.created(newSubject);\n    }\n\n    @PostMapping(value = \"/import\", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)\n    @PreAuthorize(\"hasPermission(null,'SUBJECT_IMPORT')\")\n    public Response<ImportResultDTO> importSubjects(\n            @RequestParam(\"file\") MultipartFile file,\n            @RequestParam(\"mode\") String mode) {\n\n        if (file == null || file.isEmpty()) {\n            throw new BadRequestException(\"CSV file is required\", ErrorCode.FILE_REQUIRED);\n        }\n\n        ImportResultDTO result = subjectService.importFromCsv(file, mode);\n\n        String message = String.format(\"Import completed: %d successful, %d failed\",\n                result.getSuccessCount(), result.getFailureCount());\n\n        return Response.ok(result, message);\n    }\n\n    @PutMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'SUBJECT_UPDATE')\")\n    public Response<SubjectDTO> update(@PathVariable Short id,\n            @Valid @RequestBody SubjectUpdateRequest request) {\n        SubjectDTO updatedSubject = subjectService.update(id, request);\n        return Response.ok(updatedSubject);\n    }\n\n    @DeleteMapping(\"/{id}\")\n    @PreAuthorize(\"hasPermission(null,'SUBJECT_DELETE_HARD')\")\n    public Response<Void> delete(@PathVariable Short id) {\n        subjectService.delete(id);\n        return Response.ok(\"Delete subject successfully\");\n    }\n\n    @GetMapping(\"/{id}/classes\")\n    @PreAuthorize(\"hasPermission(null,'CLASS_READ')\")\n    public PagingResponse<ClassDTO> findAllClassesBySubject(@PathVariable Short id,\n            @Valid ClassSearchRequest request) {\n        List<ClassDTO> classes = classService.searchClassBySubjectId(id, request);\n        Long total = classService.countBySubjectId(id, request);\n        return PagingResponse.of(classes, total, request);\n    }\n}\n"
    }
  ]
}