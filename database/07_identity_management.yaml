# Identity Management Tables
# FUACS Database Schema - Version 1.0

tables:
  face_embeddings:
    primary_key: id
    description: "Vector embeddings generated from approved face videos for recognition"
    columns:
      id:
        type: INT
        constraints: [NOT NULL, PRIMARY KEY, AUTO_INCREMENT]
        description: "Unique embedding identifier"
      created_at:
        type: timestamp
        constraints: [NOT NULL]
        default: now()
        description: "Embedding creation timestamp"
      updated_at:
        type: timestamp
        constraints: [NOT NULL]
        description: "Embedding last update timestamp"
      student_user_id:
        type: int
        constraints: [NOT NULL]
        foreign_key:
          table: users
          column: id
        description: "Student this embedding belongs to"
      version:
        type: int
        constraints: [NOT NULL]
        description: "Embedding version (incremented on updates)"
      is_active:
        type: boolean
        constraints: [NOT NULL]
        default: false
        description: "Whether this embedding is currently used for recognition"
      embedding_vector:
        type: vector(512)
        constraints: [NOT NULL]
        description: "512-dimensional face embedding vector"
    indexes:
      - name: idx_face_embeddings_student_active
        columns: [student_user_id]
        where: "is_active = true"
        unique: true
        description: "Ensure only one active embedding per student"

      - name: idx_face_embeddings_vector
        type: "ivfflat"
        columns: [embedding_vector]
        options: "lists = 100"
        description: "For fast vector similarity search using IVFFlat algorithm. Parameter 'lists' should be adjusted based on data size: lists â‰ˆ sqrt(total_rows). Current value (100) is suitable for ~10,000 students."
    notes:
      - "Requires pgvector extension for vector operations"
      - "Only one embedding per student can be active at a time (enforced by unique index)"
      - "Version is incremented with each identity update (see BR-32)"
      - "Keep last 3 versions for audit and rollback purposes"
      - "Vector similarity search is used for face recognition"
      - "IVFFlat index performance tuning: Adjust 'lists' parameter as data grows. Rule of thumb: lists = sqrt(total_active_embeddings). Monitor query performance and rebuild index if needed."

extensions_required:
  - name: pgvector
    description: "Required for storing and querying face embedding vectors"
    tables: [face_embeddings]
