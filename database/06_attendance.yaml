# Attendance Tables
# FUACS Database Schema - Version 1.0

tables:
  slots:
    primary_key: id
    description: "Lecture or exam sessions"
    columns:
      id:
        type: INT
        constraints: [NOT NULL, PRIMARY KEY, AUTO_INCREMENT]
        description: "Unique slot identifier"
      created_at:
        type: timestamp
        constraints: [NOT NULL]
        default: now()
        description: "Record creation timestamp"
      updated_at:
        type: timestamp
        constraints: [NOT NULL]
        description: "Record last update timestamp"
      start_time:
        type: timestamp
        constraints: [NOT NULL]
        description: "Slot start time"
      end_time:
        type: timestamp
        constraints: [NOT NULL]
        description: "Slot end time"
      finalized_at:
        type: timestamp
        constraints: [NULL]
        description: "Timestamp of the MOST RECENT finalization. NULL if slot has never been finalized. When slot is re-finalized, this value is updated to the new finalization timestamp (overwrites previous value). This field is used for quick queries (e.g., filtering finalized slots, calculating edit window cutoff). For complete audit trail including WHO finalized and all finalization history (first finalize, reopen, re-finalize), query operational_audit_logs table with target_entity='slot' and action_type IN ('FINALIZE', 'REOPEN')."
      class_id:
        type: smallint
        constraints: [NOT NULL]
        foreign_key:
          table: classes
          column: id
        description: "Reference to class"
      room_id:
        type: smallint
        constraints: [NOT NULL]
        foreign_key:
          table: rooms
          column: id
        description: "Room where slot takes place"
      staff_user_id:
        type: int
        constraints: [NOT NULL]
        foreign_key:
          table: users
          column: id
        description: "Lecturer or supervisor responsible for the slot"
      slot_category:
        type: varchar(20)
        constraints: [NOT NULL]
        description: "Category of slot: 'LECTURE' (regular lecture), 'LECTURE_WITH_PT' (lecture with progress test), or 'FINAL_EXAM' (final exam)"
      title:
        type: varchar(255)
        constraints: [NULL]
        description: "The specific name of the slot, especially for an exam (e.g., 'Progress Test 1')."
      description:
        type: text
        constraints: [NULL]
        description: "General notes or instructions for the slot, visible to participants."

      is_active:
        type: boolean
        constraints: [NOT NULL]
        default: true
        description: "Slot status (cancelled slots marked inactive)"
    indexes:
      - name: idx_slots_class_id
        columns: [class_id]
        description: "For queries: get all slots for a class"

      - name: idx_slots_staff_user_id
        columns: [staff_user_id]
        description: "For lecturer schedule queries"

      - name: idx_slots_room_id
        columns: [room_id]
        description: "For room utilization queries"

      - name: idx_slots_start_time
        columns: [start_time]
        description: "For date range queries and schedule display"

      - name: idx_slots_finalized_at
        columns: [finalized_at]
        description: "For filtering finalized vs pending slots"
    notes:
      - "slot_category determines slot behavior and available functions"
      - "LECTURE: Regular lecture session (teaching only)"
      - "LECTURE_WITH_PT: Lecture with progress test (teaching + testing)"
      - "FINAL_EXAM: Final exam session (testing only)"
      - "Lecturers can update slot_category between LECTURE and LECTURE_WITH_PT"
      - "Cannot change to/from FINAL_EXAM (only DOP can manage)"
      - "Cannot change from LECTURE_WITH_PT to LECTURE if exam_attendance records exist"
      - "finalized_at tracks when attendance was completed by staff"

  attendance_records:
    primary_key: id
    description: "Individual student attendance records for slots"
    columns:
      id:
        type: BIGINT
        constraints: [NOT NULL, PRIMARY KEY, AUTO_INCREMENT]
        description: "Unique attendance record identifier"
      created_at:
        type: timestamp
        constraints: [NOT NULL]
        default: now()
        description: "Record creation timestamp"
      updated_at:
        type: timestamp
        constraints: [NOT NULL]
        description: "Record last update timestamp"
      recorded_at:
        type: timestamp
        constraints: [NOT NULL]
        default: now()
        description: "When attendance status was recorded"
      student_user_id:
        type: int
        constraints: [NOT NULL]
        foreign_key:
          table: users
          column: id
        description: "Reference to student"
      slot_id:
        type: int
        constraints: [NOT NULL]
        foreign_key:
          table: slots
          column: id
        description: "Reference to slot"
      status:
        type: varchar(30)
        constraints: [NOT NULL]
        description: "Attendance status: 'not_yet', 'present', 'absent'"
      method:
        type: varchar(20)
        constraints: [NOT NULL]
        description: "How status was determined: 'auto', 'manual', 'system_finalize'"
    indexes:
      - name: idx_attendance_records_student_slot
        columns: [student_user_id, slot_id]
        unique: true
        description: "One attendance record per student per slot (also serves as query index)"

      - name: idx_attendance_records_slot_id
        columns: [slot_id]
        description: "For queries: get all attendance records for a slot"

      - name: idx_attendance_records_status
        columns: [status]
        description: "For filtering by status (e.g., count not_yet students)"
    notes:
      - "Status 'not_yet' is initial state before any attendance check"
      - "Status 'present' indicates student was detected/marked present"
      - "Status 'absent' is final absent status"
      - "Method 'auto' for face recognition results"
      - "Method 'manual' for lecturer/supervisor manual updates"
      - "Method 'system_finalize' for batch status updates during finalization"

  attendance_remarks:
    primary_key: id
    description: "Additional comments/notes on attendance records (regular or exam). Uses polymorphic association."
    columns:
      id:
        type: BIGINT
        constraints: [NOT NULL, PRIMARY KEY, AUTO_INCREMENT]
        description: "Unique remark identifier"
      attendable_id:
        type: bigint
        constraints: [NOT NULL]
        description: "Polymorphic reference to the ID of the attendance record (either from 'attendance_records' or 'exam_attendance')."
      attendable_type:
        type: varchar(50)
        constraints: [NOT NULL]
        description: "The type of the attendance record being referenced. Allowed values: 'regular', 'exam'."
      created_at:
        type: timestamp
        constraints: [NOT NULL]
        default: now()
        description: "Remark creation timestamp"
      updated_at:
        type: timestamp
        constraints: [NOT NULL]
        description: "Remark last update timestamp"
      created_by_user_id:
        type: int
        constraints: [NOT NULL]
        foreign_key:
          table: users
          column: id
        description: "Staff member who created the remark"
      is_active:
        type: boolean
        constraints: [NOT NULL]
        default: true
        description: "Remark status (soft delete)"
      remark:
        type: text
        constraints: [NOT NULL]
        description: "Remark content/explanation"
    notes:
      - "Used for explaining attendance status changes or special circumstances for both regular and exam attendance."
      - "Multiple remarks can be added to the same attendance record."
      - "Remarks are required when manually changing attendance status."
      - "Polymorphic relationship is defined by 'attendable_id' and 'attendable_type' columns."

  regular_attendance_evidences:
    primary_key: id
    description: "Stores temporary evidence images for REGULAR attendance records (from 'attendance_records' table)."
    columns:
      id:
        type: BIGINT
        constraints: [NOT NULL, PRIMARY KEY, AUTO_INCREMENT]
        description: "Unique evidence identifier"
      attendance_record_id:
        type: bigint
        constraints: [NOT NULL, UNIQUE]
        foreign_key:
          table: attendance_records
          column: id
        description: "Reference to the regular attendance record this image provides evidence for."
      image_url:
        type: varchar(255)
        constraints: [NOT NULL]
        description: "URL/path to the stored evidence image file"
      created_at:
        type: timestamp
        constraints: [NOT NULL]
        default: now()
        description: "Timestamp when the evidence was captured"
    notes:
      - "This table stores temporary data for LECTURE and LECTURE_WITH_PT slots."
      - "A scheduled job should periodically clean up old records from this table."

  exam_attendance_evidences:
    primary_key: id
    description: "Stores temporary evidence images for EXAM attendance records (from 'exam_attendance' table)."
    columns:
      id:
        type: BIGINT
        constraints: [NOT NULL, PRIMARY KEY, AUTO_INCREMENT]
        description: "Unique evidence identifier"
      exam_attendance_id:
        type: bigint
        constraints: [NOT NULL, UNIQUE]
        foreign_key:
          table: exam_attendance
          column: id
        description: "Reference to the exam attendance record this image provides evidence for."
      image_url:
        type: varchar(255)
        constraints: [NOT NULL]
        description: "URL/path to the stored evidence image file"
      created_at:
        type: timestamp
        constraints: [NOT NULL]
        default: now()
        description: "Timestamp when the evidence was captured"
    notes:
      - "This table stores temporary data for LECTURE_WITH_PT and FINAL_EXAM slots."
      - "A scheduled job should periodically clean up old records from this table."