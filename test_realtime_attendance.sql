-- ============================================================================
-- TEST DATA FOR REALTIME ATTENDANCE
-- ============================================================================
-- Purpose: Create test data for realtime attendance testing
-- Semester: Fall 2025 (FA25)
-- Student: User ID 37 (hieundhe180314)
-- Date: 2025-11-03 (current date)
-- ============================================================================

-- ============================================================================
-- 1. ENROLLMENT - Add student ID 37 to class SE23 (FA25)
-- ============================================================================
-- Class SE23: PRO192 in Fall 2025

INSERT INTO enrollments (student_user_id, class_id, is_enrolled)
VALUES (
    37,  -- hieundhe180314
    (SELECT id FROM classes WHERE code = 'SE23' AND semester_id = (SELECT id FROM semesters WHERE code = 'FA25')),
    true
)
ON CONFLICT DO NOTHING;

-- ============================================================================
-- 2. FACE EMBEDDING - Insert face embedding for student ID 37
-- ============================================================================
-- This embedding will be used for realtime face recognition
-- Quality: 0.74 (from recognition service response)
-- Processing time: 3.06 seconds

-- Step 1: Deactivate all existing embeddings for this student
UPDATE face_embeddings
SET is_active = false,
    updated_at = CURRENT_TIMESTAMP
WHERE student_user_id = 37;

-- Step 2: Insert new active embedding with auto-incremented version
INSERT INTO face_embeddings (
    student_user_id,
    version,
    is_active,
    embedding_vector
)
VALUES (
    37,  -- hieundhe180314
    COALESCE((SELECT MAX(version) FROM face_embeddings WHERE student_user_id = 37), 0) + 1,
    true,  -- Set as active for face recognition
    '[1.294219732284546,-1.1514641046524048,0.31040751934051514,-0.01505324151366949,-1.0862157344818115,0.8100686073303223,-1.1686955690383911,0.24017156660556793,0.007614111062139273,-0.6214489936828613,1.1606733798980713,-2.339357614517212,1.7281737327575684,0.32955607771873474,1.1872329711914062,-1.1671316623687744,1.1437757015228271,1.6181522607803345,0.6885526180267334,-0.5286368131637573,-1.2582374811172485,0.5604817271232605,-1.4823800325393677,-0.7616777420043945,-1.5252869129180908,-0.635552704334259,-0.4048556685447693,-0.6875422596931458,1.3997156620025635,-1.4042459726333618,-1.7022861242294312,-1.2311890125274658,-0.14822514355182648,-0.1425226479768753,-0.8039615154266357,1.208099126815796,1.0212441682815552,-0.06683533638715744,-2.333207130432129,1.142991304397583,1.2663158178329468,-0.08231871575117111,-0.24868761003017426,0.2874735891819,0.9587859511375427,0.18632414937019348,0.33263835310935974,2.046389102935791,-0.3903266191482544,1.481906771659851,-0.9003963470458984,-0.9023517966270447,0.6671728491783142,-0.22188898921012878,-0.7005544304847717,-1.1959351301193237,-2.424129009246826,1.2294896841049194,1.2478991746902466,-0.8596912622451782,0.7501782178878784,-0.7863454222679138,-1.5218037366867065,1.216622233390808,-0.6331567168235779,1.145231008529663,-0.24290040135383606,-0.5662610530853271,0.828402042388916,-0.18778105080127716,-1.1679582595825195,-1.88161301612854,-0.731764018535614,-0.6724465489387512,0.21802009642124176,0.5072236061096191,-0.52773118019104,-0.588400661945343,-1.315670371055603,0.32435521483421326,0.4557832181453705,-1.213804006576538,1.217483401298523,-1.1260433197021484,-0.1846613734960556,-0.31016018986701965,-1.1306713819503784,-1.0616803169250488,-0.6358696222305298,0.3279726803302765,0.2589220702648163,1.1514067649841309,-0.3999451696872711,-0.8421788215637207,1.2472060918807983,2.7248518466949463,-0.7615541815757751,-1.6424072980880737,0.018226074054837227,-1.334412693977356,-0.3162662386894226,1.5601789951324463,0.20830999314785004,0.5465102791786194,1.3304414749145508,-1.5532662868499756,-1.2172092199325562,2.153778553009033,0.5683524012565613,1.0474933385849,0.5105071067810059,0.522369921207428,-1.5881848335266113,-0.7704039812088013,-0.5559847354888916,-1.0402851104736328,0.8123427033424377,-0.6632893085479736,-0.8291056752204895,-0.7992164492607117,-2.2361927032470703,-0.6401188373565674,0.07174510508775711,0.733405351638794,1.2416114807128906,-0.49257320165634155,-0.10781111568212509,0.5281380414962769,-0.09221246093511581,0.48368045687675476,-0.1828092485666275,1.807231068611145,0.8309582471847534,0.20083433389663696,0.22969263792037964,1.6905235052108765,-0.8514356017112732,0.5551390051841736,-0.19042424857616425,1.267043113708496,-0.20238016545772552,1.4702813625335693,0.4642161428928375,0.06043676659464836,-0.3722691237926483,-0.15118961036205292,-0.10982199013233185,-1.1862949132919312,-2.021632432937622,-0.9991741180419922,-1.3126401901245117,-0.32201510667800903,0.0806891992688179,0.062483951449394226,1.3444539308547974,-1.1701557636260986,1.0007208585739136,0.765150249004364,1.1921738386154175,-0.13584591448307037,0.789781391620636,0.5531503558158875,1.1820435523986816,0.8807302713394165,-2.2596967220306396,0.7256518006324768,0.053889065980911255,0.21276305615901947,-0.4170493185520172,0.8543779253959656,1.0876353979110718,0.834944486618042,0.6311258673667908,1.493078351020813,-2.0105137825012207,-0.07312659174203873,-0.9321912527084351,0.9163781404495239,0.1531083732843399,0.6130223274230957,-1.5787334442138672,-0.057201214134693146,0.09278878569602966,0.7894300818443298,0.23607756197452545,0.5008894205093384,1.45477294921875,-0.3966117203235626,0.8859795331954956,-0.12118776142597198,-0.6168447136878967,3.124018430709839,1.465837001800537,0.15574193000793457,-0.19894607365131378,-0.5683045387268066,0.24951034784317017,-0.00012174485891591758,-0.07248785346746445,0.83138108253479,-1.7896567583084106,-1.6403192281723022,1.1992523670196533,1.190632939338684,0.069419264793396,0.5076209306716919,-2.240407705307007,-1.7240006923675537,0.23434661328792572,-0.7509419918060303,-0.49986332654953003,0.3643352687358856,-1.375616192817688,0.14311230182647705,0.5373031497001648,1.3059381246566772,0.662477433681488,-0.5241331458091736,1.0368798971176147,-1.0573036670684814,0.5388851165771484,1.0839693546295166,-1.1543359756469727,0.5268798470497131,-0.9898144006729126,-0.10111156851053238,1.0347588062286377,0.15383964776992798,0.5376972556114197,1.8111870288848877,-1.013602375984192,-2.7350430488586426,0.34705430269241333,2.4794857501983643,0.12433235347270966,1.5534614324569702,1.4345998764038086,0.7826173305511475,-0.11187154799699783,-0.2943994998931885,1.5059627294540405,-0.5303094387054443,-0.9101797342300415,0.6020927429199219,-0.8112038373947144,-1.9221808910369873,-0.5410088300704956,1.9643311500549316,0.18307417631149292,0.08980212360620499,-2.5452394485473633,0.021527063101530075,2.7149882316589355,0.8524625301361084,2.2875289916992188,1.1279466152191162,0.3015260100364685,0.1647072732448578,-0.07864228636026382,0.522336483001709,-0.6024250984191895,1.41487717628479,-0.8291425704956055,1.8212920427322388,-0.9414002299308777,-0.10730809718370438,0.36498215794563293,0.9414390325546265,1.5247232913970947,-0.1895722597837448,0.7880003452301025,1.2173415422439575,1.0059447288513184,-0.13782279193401337,1.0380189418792725,-2.1028895378112793,-2.217639923095703,-0.07256888598203659,2.141669750213623,0.026592401787638664,-0.7274103164672852,-0.39033836126327515,-0.03547646105289459,0.33005398511886597,0.38825374841690063,0.5002620816230774,-1.1002336740493774,-0.7050723433494568,-0.10224667191505432,0.20576782524585724,-1.1867082118988037,-0.7773393988609314,-0.26136302947998047,0.2339414805173874,0.45229777693748474,-0.22741654515266418,0.7073070406913757,-1.1297591924667358,-0.4699919819831848,1.4612946510314941,-0.16565614938735962,0.623282790184021,-0.013609136454761028,0.4832940697669983,1.257694125175476,-0.16565530002117157,0.2885758876800537,0.4197787046432495,0.8198097348213196,0.14117836952209473,-0.06316902488470078,0.891664445400238,-1.6854499578475952,1.5035465955734253,-0.9867315292358398,1.1601637601852417,-0.32017242908477783,0.08568228781223297,-0.42317068576812744,0.4514276385307312,1.2157913446426392,-0.8697813749313354,0.48026740550994873,1.6139562129974365,-1.231706976890564,2.691241979598999,-1.1237823963165283,-2.9311208724975586,-0.21405431628227234,-0.222284197807312,1.590677261352539,-1.7308133840560913,0.5094621777534485,-0.12969331443309784,-1.1890753507614136,0.46804067492485046,-0.19020216166973114,-1.7950795888900757,-0.7499444484710693,-1.2117469310760498,-0.20834322273731232,1.6561510562896729,1.289565920829773,0.1901746392250061,-1.248944878578186,1.4928257465362549,-0.3587169051170349,0.5130486488342285,1.0203543901443481,0.11133525520563126,1.0495766401290894,0.05632081255316734,1.9676337242126465,-0.3010307550430298,1.027600884437561,-0.4513099789619446,-0.3347039222717285,0.8559187650680542,-0.4828181266784668,0.8950562477111816,0.08658188581466675,-0.41815951466560364,1.5632209777832031,-1.1824171543121338,-0.8194707632064819,0.7893233299255371,-0.004333813674747944,1.2263211011886597,0.3819199800491333,0.33312198519706726,1.7092941999435425,0.7457134127616882,-1.145513892173767,2.0667784214019775,0.06502386182546616,-1.9608590602874756,-2.0912303924560547,-0.5323840379714966,0.14810392260551453,-0.433149516582489,0.30251574516296387,-0.2173088639974594,0.2996642291545868,0.5141785144805908,1.3311097621917725,-1.2887208461761475,1.5667859315872192,-1.1178399324417114,-0.6674253344535828,0.4593586325645447,1.0325608253479004,1.283712387084961,-0.5640429854393005,0.31958284974098206,0.10609477013349533,0.6330550312995911,-1.474476933479309,1.2190309762954712,-0.8729709386825562,1.2665989398956299,-0.1990894377231598,-1.0134681463241577,0.8805314898490906,-0.5622747540473938,-0.9234134554862976,-2.493828535079956,-0.7073550820350647,-1.158481478691101,-0.6140162944793701,-0.4087754487991333,0.16286887228488922,-0.5472941994667053,-0.26703476905822754,-0.8512378334999084,-0.03958398476243019,-1.0845037698745728,0.24359771609306335,-0.5292890667915344,-0.01160846184939146,-0.9018086791038513,-1.4496618509292603,0.9840231537818909,-0.03931484371423721,-0.38210657238960266,-1.3404139280319214,0.5051714777946472,-0.2520596385002136,0.0989873930811882,0.40063339471817017,-1.3788725137710571,1.4507339000701904,-0.16326765716075897,1.152419090270996,-1.2019344568252563,1.0591702461242676,-0.31700751185417175,-0.9456685781478882,0.21723859012126923,0.9523252248764038,1.8052783012390137,1.6382030248641968,0.56946861743927,1.346573829650879,-0.43691542744636536,-1.3435643911361694,1.5026696920394897,-1.5198124647140503,0.25243234634399414,-1.8886131048202515,1.3519582748413086,-0.08168453723192215,0.7540573477745056,-0.45587870478630066,0.02180415578186512,-0.6048935055732727,0.16568414866924286,-0.3861074447631836,-0.5761094689369202,-0.9829515218734741,0.8629842400550842,-0.33871203660964966,-0.24479034543037415,0.19288915395736694,-0.3946284353733063,1.3207651376724243,0.798308253288269,-1.8840206861495972,-0.3050871789455414,0.5929644703865051,-0.759390652179718,-0.8772150278091431,-0.7017017602920532,1.036245346069336,1.138694405555725,-0.2627796232700348,0.5048760771751404,-0.807917058467865,1.393729329109192,2.827376365661621,0.6840518116950989,1.4558273553848267,-0.48417866230010986,1.2793632745742798,-0.6074643135070801,1.1664541959762573,1.4240977764129639,-0.5638139247894287,-0.9943789839744568,0.19558292627334595,1.0386629104614258,-1.3578109741210938,-0.37666213512420654,0.49678629636764526,-0.9531170129776001,-0.9165035486221313,0.11523046344518661,-0.19864366948604584,-0.26609617471694946,1.5301812887191772,-0.2691260278224945,-0.33795857429504395,0.14292879402637482,0.23794932663440704,-0.003661311697214842,0.5602431297302246,2.183353900909424,-1.0302863121032715,-0.19045229256153107,-0.8022192120552063,-0.5878329873085022,-0.9728202819824219,-0.528971791267395]'::vector(512)
);

-- ============================================================================
-- 3. SLOT - Create a lecture slot for 2025-11-03 15:20-17:40 (Vietnam time)
-- ============================================================================
-- This slot is scheduled for TODAY, so you can test realtime attendance
-- Times are stored as Vietnam time (GMT+7)
-- Assigned to lecturer01 (username: lecturer01, password: 123456)
-- Room: Room 101

INSERT INTO slots (
    start_time,
    end_time,
    class_id,
    semester_id,
    room_id,
    staff_user_id,
    slot_category,
    title,
    description,
    is_active,
    session_status,
    scan_count
)
VALUES (
    '2025-11-03 15:20:00',  -- Start time: 15:20 Vietnam time (GMT+7)
    '2025-11-03 17:40:00',  -- End time: 17:40 Vietnam time (GMT+7)
    (SELECT id FROM classes WHERE code = 'SE23' AND semester_id = (SELECT id FROM semesters WHERE code = 'FA25')),
    (SELECT id FROM semesters WHERE code = 'FA25'),
    (SELECT id FROM rooms WHERE name = 'Room 101'),
    (SELECT id FROM users WHERE username = 'lecturer01'),
    'LECTURE',
    'PRO192 - Object Oriented Programming - Realtime Test',
    'Test slot for realtime attendance with face recognition',
    true,
    'NOT_STARTED',  -- Ready to start attendance session
    0
);

-- ============================================================================
-- 4. VERIFICATION QUERIES
-- ============================================================================

-- Check face embedding
SELECT
    id,
    student_user_id,
    version,
    is_active,
    created_at,
    vector_dims(embedding_vector) as dimensions,
    LENGTH(embedding_vector::text) as vector_size_bytes
FROM face_embeddings
WHERE student_user_id = 37
ORDER BY version DESC;

-- Check enrollment
SELECT
    e.class_id,
    e.student_user_id,
    u.username,
    u.full_name,
    c.code as class_code,
    s.code as semester_code,
    e.is_enrolled
FROM enrollments e
JOIN users u ON e.student_user_id = u.id
JOIN classes c ON e.class_id = c.id
JOIN semesters s ON c.semester_id = s.id
WHERE u.username = 'hieundhe180314'
  AND c.code = 'SE23'
  AND s.code = 'FA25';

-- Check slot
SELECT
    sl.id,
    sl.start_time,
    sl.end_time,
    c.code as class_code,
    s.code as semester_code,
    r.name as room_name,
    u.username as lecturer_username,
    u.full_name as lecturer_name,
    sl.slot_category,
    sl.title,
    sl.session_status,
    sl.scan_count
FROM slots sl
JOIN classes c ON sl.class_id = c.id
JOIN semesters s ON sl.semester_id = s.id
JOIN rooms r ON sl.room_id = r.id
JOIN users u ON sl.staff_user_id = u.id
WHERE c.code = 'SE23'
  AND s.code = 'FA25'
  AND DATE(sl.start_time) = '2025-11-03'
ORDER BY sl.start_time DESC;

-- Check student roster for this slot (should include hieundhe180314)
SELECT
    u.id,
    u.username,
    u.full_name,
    sp.roll_number,
    m.name as major
FROM enrollments e
JOIN users u ON e.student_user_id = u.id
JOIN student_profiles sp ON u.id = sp.user_id
JOIN majors m ON sp.major_id = m.id
WHERE e.class_id = (SELECT id FROM classes WHERE code = 'SE23' AND semester_id = (SELECT id FROM semesters WHERE code = 'FA25'))
  AND e.is_enrolled = true
ORDER BY u.username;

-- ============================================================================
-- CREDENTIALS AND TESTING GUIDE
-- ============================================================================

-- LECTURER CREDENTIALS:
-- Username: lecturer01
-- Email: lecturer01@fpt.edu.vn
-- Password: 123456
-- Staff Code: LEC001
-- Full Name: Tran Thi Lecturer 01

-- STUDENT INFO:
-- Username: hieundhe180314
-- Email: hieundhe180314@fpt.edu.vn
-- Password: 123456
-- Roll Number: HE180314
-- Full Name: Nguyen Doan Hieu
-- User ID: 37
-- Has Face Embedding: Yes (Quality: 0.74)

-- HOW TO TEST REALTIME ATTENDANCE:
-- 1. Run this entire SQL script to set up test data:
--    - Enrollment: Student 37 in class SE23 (PRO192)
--    - Face Embedding: 512-dim vector for face recognition
--    - Slot: Lecture session at 2025-11-03 15:20-17:40 Vietnam time in Room 101
--
-- 2. Login to web app as lecturer01 (password: 123456)
--
-- 3. Navigate to the slot scheduled for 2025-11-03 15:20-17:40
--
-- 4. Start the attendance session
--
-- 5. Recognition service will:
--    - Process camera feeds from Room 101
--    - Compare faces against stored embeddings
--    - Automatically mark student 37 as PRESENT when detected
--
-- 6. Monitor realtime updates in the attendance interface
--
-- 7. Verify:
--    - Student hieundhe180314 appears in roster
--    - Status changes to PRESENT when face is recognized
--    - Attendance record is created with timestamp
--
-- NOTES:
-- - Face embedding quality: 0.74 (above threshold 0.50)
-- - Vector dimensions: 512
-- - Can re-run script multiple times (creates new version each time)
-- - Only latest version is active for recognition
-- ============================================================================
